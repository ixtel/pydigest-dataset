<html><body><div><div itemprop="articleBody"><p>I have a problem on one of my projects:</p><blockquote><p>I have a page with a form that depends on what is stored in the database. If your using django formsets or have some form that saves over multiple objects you have this problem too.</p><p>The user saves the form, data gets saved. However, if the user uses the back button he will get a page with the old form (that expects different data in the database). If the form gets resubmitted all kinds of problems may appear.</p><p>I had one case when you could get a <tt class="docutils literal">ValueError: invalid literal for int() with base 10: ''</tt> if you resubmit a formset but instead of a existing object you have a new one. Easy to pull off by a regular user if he has multiple tabs opened.</p></blockquote><p>The best solution, I think, is to reload the page when the users goes back in history. Turns out this is easy to pull off with some http headers:</p><pre class="literal-block">
Cache-Control: no-cache, must-revalidate, no-store
Pragma: no-cache
</pre><p>The "no-store" option actually makes browses re-request when using the back button. Also, I've seen people adding "post-check=0, pre-check=0" to Cache-Control. Do NOT use those. They are Microsoft extensions to the http protocol, and if set they will actually make Internet Explorer request the page two times! see <a class="reference external" href="http://blogs.msdn.com/b/ieinternals/archive/2009/07/20/using-post_2d00_check-and-pre_2d00_check-cache-directives.aspx">this</a>.</p><p>Here's a simple view decorator if you're using django:</p><div class="highlight"><pre><span/><span class="kn">from</span> <span class="nn">django.utils.decorators</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="k">def</span> <span class="nf">must_revalidate</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">response</span><span class="p">[</span><span class="s2">"Cache-Control"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no-cache, must-revalidate, no-store"</span>
        <span class="n">response</span><span class="p">[</span><span class="s2">"Pragma"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no-cache"</span>
        <span class="k">return</span> <span class="n">response</span>
    <span class="k">return</span> <span class="n">wrapper</span>
</pre></div><p>Having no-store creates some additional load on the server and creates other user experience problems:</p><ul class="simple"><li>Users won't have the old form data when they go back</li><li>Page scroll position isn't kept</li><li>If the page has other state it isn't kept - but depending on the browser that state might not be cached anyway (eg: dom changes)</li></ul><p>But I think it's still better than surprising the user with different results for a submission with the same form data or having to deal consistently with missing or extra data in the database on the server-side. What do you think?</p></div></div></body></html>