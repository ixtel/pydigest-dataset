<html><body><div><div id="ordered-turtle-serializer-for-rdflib">
<h2>Ordered Turtle Serializer for rdflib</h2>
<p>An extension to the <a href="https://rdflib.readthedocs.org/" rel="nofollow">rdflib</a> Turtle serializer
that adds order (at the price of speed).
Useful when you need to generate diffs between Turtle files, or just to make it
easier for human beings to inspect the files.</p>
<pre><span class="gp">$</span> pip install otsrdflib
</pre>
<p>Usage:</p>
<pre><span class="kn">from</span> <span class="nn">rdflib</span> <span class="kn">import</span> <span class="n">graph</span>
<span class="kn">from</span> <span class="nn">otsrdflib</span> <span class="kn">import</span> <span class="n">OrderedTurtleSerializer</span>

<span class="n">my_graph</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">()</span>

<span class="n">out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'out.ttl'</span><span class="p">,</span> <span class="s1">'wb'</span><span class="p">)</span>
<span class="n">serializer</span> <span class="o">=</span> <span class="n">OrderedTurtleSerializer</span><span class="p">(</span><span class="n">my_graph</span><span class="p">)</span>
<span class="n">serializer</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</pre>
<p>Class order is imposed by setting <cite>serializer.topClasses</cite>.
The default list is suitable for thesauri and other controlled vocabularies:</p>
<pre><span class="n">serializer</span><span class="o">.</span><span class="n">topClasses</span> <span class="o">=</span> <span class="p">[</span><span class="n">SKOS</span><span class="o">.</span><span class="n">ConceptScheme</span><span class="p">,</span>
                       <span class="n">FOAF</span><span class="o">.</span><span class="n">Organization</span><span class="p">,</span>
                       <span class="n">SD</span><span class="o">.</span><span class="n">Service</span><span class="p">,</span>
                       <span class="n">SD</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
                       <span class="n">SD</span><span class="o">.</span><span class="n">Graph</span><span class="p">,</span>
                       <span class="n">SD</span><span class="o">.</span><span class="n">NamedGraph</span><span class="p">,</span>
                       <span class="n">ISOTHES</span><span class="o">.</span><span class="n">ThesaurusArray</span><span class="p">,</span>
                       <span class="n">SKOS</span><span class="o">.</span><span class="n">Concept</span><span class="p">]</span>
</pre>
<p>Instance order (within a class) is imposed using the Python
<a href="https://docs.python.org/2/library/functions.html#cmp" rel="nofollow">cmp</a> method.
By default, URIs are sorted alphabetically as-is, but with
<cite>serializer.sorters</cite> you can generate your own sort key based on
URI patterns. By default, if a URI ends with a number, that number is
used as a numerical sort key:</p>
<pre><span class="n">serializer</span><span class="o">.</span><span class="n">sorters</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'.*?([0-9]+)$'</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="p">}</span>
</pre>
<p>Here <tt>x</tt> refers to the match object groups. Note that index 0 refers
to the first group, not the entire match!</p>
<p>With this sorter, <cite>http://…/…/99</cite> will be arranged before <cite>http://…/…/100</cite>
since the sort keys are the integers 99 and 100. Note that if you have
number-ending URIs ending with different bases, these will be mangled together.
One simple way to group together URIs with the same base could be to use a
“large” number that represents the base, for instance a 8-digit hash:</p>
<pre><span class="k">def</span> <span class="nf">xhash</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(),</span> <span class="mi">16</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span><span class="o">**</span><span class="mi">8</span>

<span class="n">serializer</span><span class="o">.</span><span class="n">sorters</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'(.*?)([0-9]+)$'</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">xhash</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="p">}</span>
</pre>
<p>For a slightly more complicated example, we have a look at Dewey URIs.
For a typical URI like <cite>http://dewey.info/class/001.433/e23/</cite>, we would
like to use the decimal number <cite>1.433</cite> as the sort key. We can achieve
that by configuring a sorter like so:</p>
<pre><span class="n">serializer</span><span class="o">.</span><span class="n">sorters</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'http://dewey.info/class/([0-9.]+)'</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="p">}</span>
</pre>
<p>But then there’s also table numbers like <cite>http://dewey.info/class/T1–0901/e23/</cite>.
We want to have the tables T1, T2, … follow the main schedules.
Since the main schedules go from 0 to 999.99… we can map the tables T1…T6 to
some larger integers, like 1001…1006.
Noting that the table numbers like <cite>0901</cite> represents a fractional part,
the sort key for <cite>T1–0901</cite> becomes <cite>1001.0901</cite>. Such keys can be generated
by adding another sorter:</p>
<pre><span class="n">serializer</span><span class="o">.</span><span class="n">sorters</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'http://dewey.info/class/([0-9.]+)'</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
  <span class="s1">'http://dewey.info/class/T([0-9])\-\-([0-9]+)'</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">1000.</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="s1">'.'</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="p">}</span>
</pre>
</div>


</div></body></html>