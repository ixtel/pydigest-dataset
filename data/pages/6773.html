<html><body><div><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5c986f22e4795591873-1"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-k ">argparse</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-2"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">redis</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-3"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-k ">sys</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-4"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-k ">time</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-5"> </p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-6"> </p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-7"><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">celery_speed</span><span class="crayon-sy">(</span><span class="crayon-v">redis_connection</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">celery_queue_name</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-8"><span class="crayon-h">    </span><span class="crayon-s">"""Display the speed at which items in the celery queue are being</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-9"><span class="crayon-s">    consumed.</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-10"> </p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-11"><span class="crayon-s">    :param redis_connection: A connection to redis</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-12"><span class="crayon-s">    :type redis_connection: redis.StrictRedis</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-13"><span class="crayon-s">    :param celery_queue_name: Name of celery queue.</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-14"><span class="crayon-s">    :type celery_queue_name: str or unicode</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-15"><span class="crayon-s">    """</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-16"><span class="crayon-h">    </span><span class="crayon-v">last_value</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">last_time</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">None</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">None</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-17"> </p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-18"><span class="crayon-h">    </span><span class="crayon-st">while</span><span class="crayon-h"> </span><span class="crayon-t">True</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-19"><span class="crayon-h">        </span><span class="crayon-st">try</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-20"><span class="crayon-h">            </span><span class="crayon-v">curr_value</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">redis_connection</span><span class="crayon-sy">.</span><span class="crayon-e">llen</span><span class="crayon-sy">(</span><span class="crayon-v">celery_queue_name</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-21"><span class="crayon-h">            </span><span class="crayon-v">curr_time</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">time</span><span class="crayon-sy">.</span><span class="crayon-k ">time</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-22"><span class="crayon-h">            </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">last_value </span><span class="crayon-st">and</span><span class="crayon-h"> </span><span class="crayon-v">last_time</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-23"><span class="crayon-h">                </span><span class="crayon-v">speed</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-24"><span class="crayon-h">                    </span><span class="crayon-sy">(</span><span class="crayon-v">curr_value</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">last_value</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">/</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-25"><span class="crayon-h">                    </span><span class="crayon-k ">float</span><span class="crayon-sy">(</span><span class="crayon-v">curr_time</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">last_time</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-26"><span class="crayon-h">                </span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-27"><span class="crayon-h">                </span><span class="crayon-k ">sys</span><span class="crayon-sy">.</span><span class="crayon-v">stdout</span><span class="crayon-sy">.</span><span class="crayon-e">write</span><span class="crayon-sy">(</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-28"><span class="crayon-h">                    </span><span class="crayon-s">'{} total, {:0.02f} items/sec\r'</span><span class="crayon-sy">.</span><span class="crayon-k ">format</span><span class="crayon-sy">(</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-29"><span class="crayon-h">                        </span><span class="crayon-v">curr_value</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">speed</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-30"><span class="crayon-h">                    </span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-31"><span class="crayon-h">                </span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-32"><span class="crayon-h">                </span><span class="crayon-k ">sys</span><span class="crayon-sy">.</span><span class="crayon-v">stdout</span><span class="crayon-sy">.</span><span class="crayon-e">flush</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-33"><span class="crayon-h">            </span><span class="crayon-v">last_value</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">curr_value</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-34"><span class="crayon-e">            </span><span class="crayon-v">last_time</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">curr_time</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-35"><span class="crayon-e">            </span><span class="crayon-k ">time</span><span class="crayon-sy">.</span><span class="crayon-e">sleep</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-36"><span class="crayon-h">        </span><span class="crayon-st">except</span><span class="crayon-h"> </span><span class="crayon-k ">KeyboardInterrupt</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-37"><span class="crayon-h">            </span><span class="crayon-k ">print</span><span class="crayon-h"> </span><span class="crayon-s">'Shutdown'</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-38"><span class="crayon-h">            </span><span class="crayon-k ">sys</span><span class="crayon-sy">.</span><span class="crayon-e">exit</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-39"> </p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-40"> </p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-41"><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">__name__</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">'__main__'</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-42"><span class="crayon-h">    </span><span class="crayon-k ">parser</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">argparse</span><span class="crayon-sy">.</span><span class="crayon-e">ArgumentParser</span><span class="crayon-sy">(</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-43"><span class="crayon-h">        </span><span class="crayon-v">description</span><span class="crayon-o">=</span><span class="crayon-s">'Show speed at which celery processing queue items.'</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-44"><span class="crayon-h">    </span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-45"><span class="crayon-h">    </span><span class="crayon-k ">parser</span><span class="crayon-sy">.</span><span class="crayon-e">add_argument</span><span class="crayon-sy">(</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-46"><span class="crayon-h">        </span><span class="crayon-s">'--redis-host'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dest</span><span class="crayon-o">=</span><span class="crayon-s">'redis_host'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">default</span><span class="crayon-o">=</span><span class="crayon-s">'localhost'</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-47"><span class="crayon-h">        </span><span class="crayon-k ">help</span><span class="crayon-o">=</span><span class="crayon-s">'(Optional, default is localhost) The redis host'</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-48"><span class="crayon-h">    </span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-49"><span class="crayon-h">    </span><span class="crayon-k ">parser</span><span class="crayon-sy">.</span><span class="crayon-e">add_argument</span><span class="crayon-sy">(</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-50"><span class="crayon-h">        </span><span class="crayon-s">'--queue-name'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dest</span><span class="crayon-o">=</span><span class="crayon-s">'queue_name'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">default</span><span class="crayon-o">=</span><span class="crayon-s">'celery'</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-51"><span class="crayon-h">        </span><span class="crayon-k ">help</span><span class="crayon-o">=</span><span class="crayon-s">'(Optional, default is celery) The name of the celery queue.'</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-52"><span class="crayon-h">    </span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-53"><span class="crayon-h">    </span><span class="crayon-v">args</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">parser</span><span class="crayon-sy">.</span><span class="crayon-e">parse_args</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-54"><span class="crayon-h">    </span><span class="crayon-k ">print</span><span class="crayon-h"> </span><span class="crayon-s">'host: {}, queue: {}'</span><span class="crayon-sy">.</span><span class="crayon-k ">format</span><span class="crayon-sy">(</span><span class="crayon-v">args</span><span class="crayon-sy">.</span><span class="crayon-v">redis_host</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">args</span><span class="crayon-sy">.</span><span class="crayon-v">queue_name</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-55"><span class="crayon-h">    </span><span class="crayon-k ">print</span><span class="crayon-h"> </span><span class="crayon-s">'negative = queue decreasing, positive = queue increasing'</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-56"><span class="crayon-h">    </span><span class="crayon-k ">print</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-57"><span class="crayon-h">    </span><span class="crayon-v">redis_host</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">args</span><span class="crayon-sy">.</span><span class="crayon-e">redis_host </span><span class="crayon-st">or</span><span class="crayon-h"> </span><span class="crayon-s">'localhost'</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-58"><span class="crayon-h">    </span><span class="crayon-v">celery_queue_name</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">args</span><span class="crayon-sy">.</span><span class="crayon-e">queue_name </span><span class="crayon-st">or</span><span class="crayon-h"> </span><span class="crayon-s">'celery'</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-59"><span class="crayon-h">    </span><span class="crayon-v">redis_connection</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">redis</span><span class="crayon-sy">.</span><span class="crayon-e">StrictRedis</span><span class="crayon-sy">(</span><span class="crayon-v">redis_host</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c986f22e4795591873-60"><span class="crayon-h">    </span><span class="crayon-e">celery_speed</span><span class="crayon-sy">(</span><span class="crayon-v">redis_connection</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">celery_queue_name</span><span class="crayon-sy">)</span></p></div></div></body></html>