<html><body><div><div>
    <h3>Prelude</h3>
<p>It's been quite a while since I worked on my projects. But recently I
had some motivation and energy left, which is quite nice considering my
full time university week and a programming job besides.</p>
<p>I have a <a href="https://github.com/NikolaiT/GoogleScraper" title="GoogleScraper">little project on
GitHub</a> that
I worked on every now and again in the last year or so. Recently it got
a little bit bigger (I have 115 github stars now, would've never
imagined that I ever achieve this) and I receive up to 2 mails with job
offers every week (Sorry if I cannot accept any request :( ).</p>
<p>But unfortunately my progress with this project is not as good as I want
it to be (that's probably a quite common feeling under us programmers).
It's not a problem of missing ideas and features that I want to
implement, the hard part is to extend the project without blowing legacy
code up. GoogleScraper has grown evolutionary and I am waisting <strong>a
lot</strong> of time to understand my old code. Mostly it's much better to just
erease whole modules and reimplement things completely anew. This is
essentially what I made with the parsing module.</p>
<h3>Parsing SERP pages with many search engines</h3>
<p>So I rewrote the parsing.py module of GoogleScraper. From now on,
parsing happens much more stable and is more extendable. In fact,
everyone can add their own CSS selectors while subclassing the abstract
<code>Parser</code> class. For now, parsing.py support the following search
engines:</p>
<ul>
<li><a href="https://google.com">Google</a> (as before)</li>
<li><a href="http://yandex.ru/" title="Yandex">Yandex</a> (quite a nice search engine)</li>
<li><a href="http://www.bing.com" title="Bing">Bing</a> (pretty mature by now)</li>
<li><a href="http://https://search.yahoo.com" title="Yahoo">Yahoo</a> (good old google
    competitor)</li>
<li><a href="http://www.baidu.com/" title="Baidu">Baidu</a> (let's dive into the asian
    market ;) )</li>
<li><a href="https://duckduckgo.com" title="Duckduckgo">Duckduckgo</a> (I am very excited
    about duckduck.go, because the results are clean any very easily
    parsable)</li>
</ul>
<p>This means that GoogleScraper now support <strong>6 search engines</strong>. So you
can scale your scraping and compare the results between search engines.
This means much more output and statistical data for your analysis. You
can also divide your scrape jobs on the different search engines. A few
people might still say that Google is the only usable search engine.
Have you actually used an alternative recently or are you just suffering
from the <a href="http://en.wikipedia.org/wiki/Lock-in_%28decision-making%29">locked in
effect</a>?</p>
<h3>Let's play with it</h3>
<p>Well, to give you some first insight in the new functionality, lets dig
some code and see it in action:</p>
<p>To run it download the code below, save it as parsing.py and just
install the modules:</p>
<ul>
<li>lxml</li>
<li>cssselect</li>
<li>beautifulsoup4</li>
</ul>
<p>You can do so with <code>sudo pip3 install modulename</code>.</p>
<p>Now when you are ready, you can easily test the new parsing
functionality with firing such an example command in<br/>
the command line:</p>
<p><code>python3 parsing.py 'http://yandex.ru/yandsearch?text=GoogleScraper&amp;lr=178'</code></p>
<p>This will scrape the results from Yandex with the search query
<strong>GoogleScraper</strong>. You can try it out with the other search engines:
Just search in your browser, than copy and paste the url from the
address bar in the command!</p>
<p>Please note: Using this module directly makes little sense, because
requesting such urls<br/>
directly without imitating a real browser (which is done in my
GoogleScraper module with faking User Agent, using selenium, PhantomJS,
...) makes<br/>
the search engines sometimes return crippled html, which makes it hard
to parse.</p>
<p>But for some engines it nevertheless works quite well (for example:
yandex, google, ...).</p>
<p>Please note, the most actual version of the code can be found here:
<a href="https://github.com/NikolaiT/GoogleScraper/blob/master/GoogleScraper/parsing.py" title="parsing.py">parsing.py at
GoogleScraper</a></p>
<div class="highlight"><pre><span class="c"># -*- coding: utf-8 -*-</span>

<span class="sd">"""</span>
<span class="sd">author: Nikolai Tschacher</span>
<span class="sd">date: 11.11.2014</span>
<span class="sd">home: incolumitas.com</span>
<span class="sd">"""</span>

<span class="c"># TODO: Implement alternatate selectors for different SERP formats (just use a list in the CSS selector datatypes)</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">lxml.html</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">pprint</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">cssselect</span> <span class="kn">import</span> <span class="n">HTMLTranslator</span><span class="p">,</span> <span class="n">SelectorError</span>
    <span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">UnicodeDammit</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">ie</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="s">'name'</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ie</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">'bs4'</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="s">'args'</span><span class="p">)</span> <span class="ow">and</span> <span class="s">'bs4'</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">ie</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">'Install bs4 with the command "sudo pip3 install beautifulsoup4"'</span><span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">'GoogleScraper'</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">InvalidSearchTypeExcpetion</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">Parser</span><span class="p">():</span>
    <span class="sd">"""Parses SERP pages.</span>

<span class="sd">    Each search engine results page (SERP) has a similar layout:</span>

<span class="sd">    The main search results are usually in a html container element (#main, .results, #leftSide).</span>
<span class="sd">    There might be separate columns for other search results (like ads for example). Then each </span>
<span class="sd">    result contains basically a link, a snippet and a description (usually some text on the</span>
<span class="sd">    target site). It's really astonishing how similar other search engines are to Google.</span>

<span class="sd">    Each child class (that can actual parse a concrete search engine results page) needs</span>
<span class="sd">    to specify css selectors for the different search types (Like normal search, news search, video search, ...).</span>

<span class="sd">    Attributes:</span>
<span class="sd">        search_results: The results after parsing.</span>
<span class="sd">    """</span>

    <span class="c"># The supported search types. For instance, Google supports Video Search, Image Search, News search</span>
    <span class="n">search_types</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html</span><span class="p">,</span> <span class="n">searchtype</span><span class="o">=</span><span class="s">'normal'</span><span class="p">):</span>
        <span class="sd">"""Create new Parser instance and parse all information.</span>

<span class="sd">        Args:</span>
<span class="sd">            html: The raw html from the search engine search</span>
<span class="sd">            searchtype: The search type. By default "normal"</span>

<span class="sd">        Raises:</span>
<span class="sd">            Assertion error if the subclassed</span>
<span class="sd">            specific parser cannot handle the the settings.</span>
<span class="sd">        """</span>
        <span class="k">assert</span> <span class="n">searchtype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_types</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">html</span> <span class="o">=</span> <span class="n">html</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">searchtype</span> <span class="o">=</span> <span class="n">searchtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dom</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">search_results</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c"># Try to parse the provided HTML string using lxml</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">UnicodeDammit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="p">,</span> <span class="n">is_html</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">lxml</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">HTMLParser</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">doc</span><span class="o">.</span><span class="n">declared_html_encoding</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dom</span> <span class="o">=</span> <span class="n">lxml</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">document_fromstring</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="n">parser</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dom</span><span class="o">.</span><span class="n">resolve_base_href</span><span class="p">()</span>

        <span class="c"># lets do the actual parsing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parse</span><span class="p">()</span>

        <span class="c"># Apply sublcass specific behaviour after parsing has happened</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">after_parsing</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Parse the dom according to the provided css selectors.</span>

<span class="sd">        Raises: InvalidSearchTypeExcpetion if no css selectors for the searchtype could be found.</span>
<span class="sd">        """</span>
        <span class="c"># try to parse the number of results.</span>
        <span class="n">attr_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchtype</span> <span class="o">+</span> <span class="s">'_search_selectors'</span>
        <span class="n">selector_dict</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="c"># short alias because we use it so extensively</span>
        <span class="n">css_to_xpath</span> <span class="o">=</span> <span class="n">HTMLTranslator</span><span class="p">()</span><span class="o">.</span><span class="n">css_to_xpath</span>

        <span class="c"># get the appropriate css selectors for the num_results for the keyword</span>
        <span class="n">num_results_selector</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">'num_results_search_selectors'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_results_selector</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">search_results</span><span class="p">[</span><span class="s">'num_results'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dom</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="n">css_to_xpath</span><span class="p">(</span><span class="n">num_results_selector</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text_content</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">selector_dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidSearchTypeExcpetion</span><span class="p">(</span><span class="s">'There is no such attribute: {}. No selectors found'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr_name</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">result_type</span><span class="p">,</span> <span class="n">selectors</span> <span class="ow">in</span> <span class="n">selector_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">search_results</span><span class="p">[</span><span class="n">result_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dom</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span>
                <span class="n">css_to_xpath</span><span class="p">(</span><span class="s">'{container} {result_container}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">selectors</span><span class="p">))</span>
            <span class="p">)</span>

            <span class="n">to_extract</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">selectors</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="p">{</span><span class="s">'container'</span><span class="p">,</span> <span class="s">'result_container'</span><span class="p">}</span>                
            <span class="n">selectors_to_use</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(((</span><span class="n">key</span><span class="p">,</span> <span class="n">selectors</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">to_extract</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">selectors</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
                <span class="c"># Let's add primitve support for CSS3 pseudo selectors</span>
                <span class="c"># We just need two of them</span>
                <span class="c"># ::text</span>
                <span class="c"># ::attr(someattribute)</span>

                <span class="c"># You say we should use xpath expresssions instead?</span>
                <span class="c"># Maybe you're right, but they are complicated when it comes to classes,</span>
                <span class="c"># have a look here: http://doc.scrapy.org/en/latest/topics/selectors.html</span>
                <span class="n">serp_result</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">selector</span> <span class="ow">in</span> <span class="n">selectors_to_use</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="k">if</span> <span class="n">selector</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">'::text'</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="n">css_to_xpath</span><span class="p">(</span><span class="n">selector</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'::'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text_content</span><span class="p">()</span>
                        <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">attr</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r'::attr\((?P.*)\)$'</span><span class="p">,</span> <span class="n">selector</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">'attr'</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">attr</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="n">css_to_xpath</span><span class="p">(</span><span class="n">selector</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'::'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="k">pass</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="n">css_to_xpath</span><span class="p">(</span><span class="n">selector</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text_content</span><span class="p">()</span>
                            <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="k">pass</span>
                    <span class="n">serp_result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">if</span> <span class="n">serp_result</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">search_results</span><span class="p">[</span><span class="n">result_type</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">serp_result</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">after_parsing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Sublcass specific behaviour after parsing happened.</span>

<span class="sd">        Override in subclass to add search engine specific behaviour.</span>
<span class="sd">        Commonly used to clean the results.</span>
<span class="sd">        """</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Return a nicely formated overview of the results."""</span>
        <span class="k">return</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">search_results</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Here follow the different classes that provide CSS selectors </span>
<span class="sd">for different types of SERP pages of several common search engines.</span>

<span class="sd">Just look at them and add your own selectors in a new class if you</span>
<span class="sd">want the Scraper to support them.</span>

<span class="sd">You can easily just add new selectors to a search engine. Just follow</span>
<span class="sd">the attribute naming convention and the parser will recognize them:</span>

<span class="sd">If you provide a dict with a name like finance_search_selectors,</span>
<span class="sd">then you're adding a new search type with the name finance.</span>

<span class="sd">Each class needs a attribute called num_results_search_selectors, that</span>
<span class="sd">extracts the number of searches that were found by the keyword.</span>
<span class="sd">"""</span>


<span class="k">class</span> <span class="nc">GoogleParser</span><span class="p">(</span><span class="n">Parser</span><span class="p">):</span>
    <span class="sd">"""Parses SERP pages of the Google search engine."""</span>

    <span class="n">search_types</span> <span class="o">=</span> <span class="p">[</span><span class="s">'normal'</span><span class="p">,</span> <span class="s">'image'</span><span class="p">]</span>

    <span class="n">num_results_search_selectors</span> <span class="o">=</span> <span class="s">'div#resultStats'</span>

    <span class="n">normal_search_selectors</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'results'</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">'container'</span><span class="p">:</span> <span class="s">'#center_col'</span><span class="p">,</span>
            <span class="s">'result_container'</span><span class="p">:</span> <span class="s">'li.g '</span><span class="p">,</span>
            <span class="s">'link'</span><span class="p">:</span> <span class="s">'h3.r &gt; a:first-child::attr(href)'</span><span class="p">,</span>
            <span class="s">'snippet'</span><span class="p">:</span> <span class="s">'div.s span.st::text'</span><span class="p">,</span>
            <span class="s">'title'</span><span class="p">:</span> <span class="s">'h3.r &gt; a:first-child::text'</span><span class="p">,</span>
            <span class="s">'visible_link'</span><span class="p">:</span> <span class="s">'cite::text'</span>
        <span class="p">},</span>
        <span class="s">'ads_main'</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s">'container'</span><span class="p">:</span> <span class="s">'#center_col'</span><span class="p">,</span>
            <span class="s">'result_container'</span><span class="p">:</span> <span class="s">'li.ads-ad'</span><span class="p">,</span>
            <span class="s">'link'</span><span class="p">:</span> <span class="s">'h3.r &gt; a:first-child::attr(href)'</span><span class="p">,</span>
            <span class="s">'snippet'</span><span class="p">:</span> <span class="s">'div.s span.st::text'</span><span class="p">,</span>
            <span class="s">'title'</span><span class="p">:</span> <span class="s">'h3.r &gt; a:first-child::text'</span><span class="p">,</span>
            <span class="s">'visible_link'</span><span class="p">:</span> <span class="s">'.ads-visurl cite::text'</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">image_search_selectors</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'results'</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">'container'</span><span class="p">:</span> <span class="s">'li#isr_mc'</span><span class="p">,</span>
            <span class="s">'result_container'</span><span class="p">:</span> <span class="s">'div.rg_di'</span><span class="p">,</span>
            <span class="s">'imgurl'</span><span class="p">:</span> <span class="s">'a.rg_l::attr(href)'</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">after_parsing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Clean the urls.</span>

<span class="sd">        A typical scraped results looks like the following:</span>

<span class="sd">        '/url?q=http://www.youtube.com/user/Apple&amp;sa=U&amp;ei=lntiVN7JDsTfPZCMgKAO&amp;ved=0CFQQFjAO&amp;usg=AFQjCNGkX65O-hKLmyq1FX9HQqbb9iYn9A'</span>

<span class="sd">        Clean with a short regex.</span>
<span class="sd">        """</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">after_parsing</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="s">'link'</span><span class="p">]:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r'/url\?q=(?P.*?)&amp;sa=U&amp;ei='</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="s">'link'</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">search_results</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s">'link'</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">'url'</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">YandexParser</span><span class="p">(</span><span class="n">Parser</span><span class="p">):</span>
    <span class="sd">"""Parses SERP pages of the Yandex search engine."""</span>

    <span class="n">search_types</span> <span class="o">=</span> <span class="p">[</span><span class="s">'normal'</span><span class="p">]</span>

    <span class="n">num_results_search_selectors</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">normal_search_selectors</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'results'</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">'container'</span><span class="p">:</span> <span class="s">'div.serp-list'</span><span class="p">,</span>
            <span class="s">'result_container'</span><span class="p">:</span> <span class="s">'div.serp-item__wrap '</span><span class="p">,</span>
            <span class="s">'link'</span><span class="p">:</span> <span class="s">'a.serp-item__title-link::attr(href)'</span><span class="p">,</span>
            <span class="s">'snippet'</span><span class="p">:</span> <span class="s">'div.serp-item__text::text'</span><span class="p">,</span>
            <span class="s">'title'</span><span class="p">:</span> <span class="s">'a.serp-item__title-link::text'</span><span class="p">,</span>
            <span class="s">'visible_link'</span><span class="p">:</span> <span class="s">'a.serp-url__link::attr(href)'</span>
        <span class="p">},</span>
    <span class="p">}</span>


<span class="k">class</span> <span class="nc">BingParser</span><span class="p">(</span><span class="n">Parser</span><span class="p">):</span>
    <span class="sd">"""Parses SERP pages of the Bing search engine."""</span>

    <span class="n">search_types</span> <span class="o">=</span> <span class="p">[</span><span class="s">'normal'</span><span class="p">]</span>

    <span class="n">num_results_search_selectors</span> <span class="o">=</span> <span class="s">'.sb_count'</span>

    <span class="n">normal_search_selectors</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'results'</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">'container'</span><span class="p">:</span> <span class="s">'ol#b_results'</span><span class="p">,</span>
            <span class="s">'result_container'</span><span class="p">:</span> <span class="s">'li.b_algo'</span><span class="p">,</span>
            <span class="s">'link'</span><span class="p">:</span> <span class="s">'.b_title &gt; h2 &gt; a::attr(href)'</span><span class="p">,</span>
            <span class="s">'snippet'</span><span class="p">:</span> <span class="s">'.b_snippet &gt; p::text'</span><span class="p">,</span>
            <span class="s">'title'</span><span class="p">:</span> <span class="s">'.b_title &gt; h2 &gt; a::text'</span><span class="p">,</span>
            <span class="s">'visible_link'</span><span class="p">:</span> <span class="s">'cite::text'</span>
        <span class="p">},</span>
        <span class="s">'ads_main'</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s">'container'</span><span class="p">:</span> <span class="s">'ol#b_results'</span><span class="p">,</span>
            <span class="s">'result_container'</span><span class="p">:</span> <span class="s">'li.b_ad'</span><span class="p">,</span>
            <span class="s">'link'</span><span class="p">:</span> <span class="s">'.sb_add &gt; h2 &gt; a::attr(href)'</span><span class="p">,</span>
            <span class="s">'snippet'</span><span class="p">:</span> <span class="s">'.b_caption::text'</span><span class="p">,</span>
            <span class="s">'title'</span><span class="p">:</span> <span class="s">'.sb_add &gt; h2 &gt; a::text'</span><span class="p">,</span>
            <span class="s">'visible_link'</span><span class="p">:</span> <span class="s">'cite::text'</span>
        <span class="p">}</span>
    <span class="p">}</span>


<span class="k">class</span> <span class="nc">YahooParser</span><span class="p">(</span><span class="n">Parser</span><span class="p">):</span>
    <span class="sd">"""Parses SERP pages of the Yahoo search engine."""</span>

    <span class="n">search_types</span> <span class="o">=</span> <span class="p">[</span><span class="s">'normal'</span><span class="p">]</span>

    <span class="n">num_results_search_selectors</span> <span class="o">=</span> <span class="s">'#pg &gt; span:last-child'</span>

    <span class="n">normal_search_selectors</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'results'</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">'container'</span><span class="p">:</span> <span class="s">'#main'</span><span class="p">,</span>
            <span class="s">'result_container'</span><span class="p">:</span> <span class="s">'.res'</span><span class="p">,</span>
            <span class="s">'link'</span><span class="p">:</span> <span class="s">'div &gt; h3 &gt; a::attr(href)'</span><span class="p">,</span>
            <span class="s">'snippet'</span><span class="p">:</span> <span class="s">'div.abstr::text'</span><span class="p">,</span>
            <span class="s">'title'</span><span class="p">:</span> <span class="s">'div &gt; h3 &gt; a::text'</span><span class="p">,</span>
            <span class="s">'visible_link'</span><span class="p">:</span> <span class="s">'span.url::text'</span>
        <span class="p">},</span>
    <span class="p">}</span>


<span class="k">class</span> <span class="nc">BaiduParser</span><span class="p">(</span><span class="n">Parser</span><span class="p">):</span>
    <span class="sd">"""Parses SERP pages of the Baidu search engine."""</span>

    <span class="n">search_types</span> <span class="o">=</span> <span class="p">[</span><span class="s">'normal'</span><span class="p">]</span>

    <span class="n">num_results_search_selectors</span> <span class="o">=</span> <span class="s">'#container .nums'</span>

    <span class="n">normal_search_selectors</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'results'</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">'container'</span><span class="p">:</span> <span class="s">'#content_left'</span><span class="p">,</span>
            <span class="s">'result_container'</span><span class="p">:</span> <span class="s">'.result-op'</span><span class="p">,</span>
            <span class="s">'link'</span><span class="p">:</span> <span class="s">'h3 &gt; a.t::attr(href)'</span><span class="p">,</span>
            <span class="s">'snippet'</span><span class="p">:</span> <span class="s">'.c-abstract::text'</span><span class="p">,</span>
            <span class="s">'title'</span><span class="p">:</span> <span class="s">'h3 &gt; a.t::text'</span><span class="p">,</span>
            <span class="s">'visible_link'</span><span class="p">:</span> <span class="s">'span.c-showurl::text'</span>
        <span class="p">},</span>
    <span class="p">}</span>


<span class="k">class</span> <span class="nc">DuckduckgoParser</span><span class="p">(</span><span class="n">Parser</span><span class="p">):</span>
    <span class="sd">"""Parses SERP pages of the Duckduckgo search engine."""</span>

    <span class="n">search_types</span> <span class="o">=</span> <span class="p">[</span><span class="s">'normal'</span><span class="p">]</span>

    <span class="n">num_results_search_selectors</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">normal_search_selectors</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'results'</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">'container'</span><span class="p">:</span> <span class="s">'#links'</span><span class="p">,</span>
            <span class="s">'result_container'</span><span class="p">:</span> <span class="s">'.result'</span><span class="p">,</span>
            <span class="s">'link'</span><span class="p">:</span> <span class="s">'.result__title &gt; a::attr(href)'</span><span class="p">,</span>
            <span class="s">'snippet'</span><span class="p">:</span> <span class="s">'result__snippet::text'</span><span class="p">,</span>
            <span class="s">'title'</span><span class="p">:</span> <span class="s">'.result__title &gt; a::text'</span><span class="p">,</span>
            <span class="s">'visible_link'</span><span class="p">:</span> <span class="s">'.result__url__domain::text'</span>
        <span class="p">},</span>
    <span class="p">}</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="sd">"""Originally part of https://github.com/NikolaiT/GoogleScraper.</span>

<span class="sd">    Only for testing purposes: May be called directly with an search engine </span>
<span class="sd">    search url. For example:</span>

<span class="sd">    python3 parsing.py 'http://yandex.ru/yandsearch?text=GoogleScraper&amp;lr=178&amp;csg=82%2C4317%2C20%2C20%2C0%2C0%2C0'</span>

<span class="sd">    Please note: Using this module directly makes little sense, because requesting such urls</span>
<span class="sd">    directly without imitating a real browser (which is done in my GoogleScraper module) makes</span>
<span class="sd">    the search engines return crippled html, which makes it impossible to parse.</span>
<span class="sd">    But for some engines it nevertheless works (for example: yandex, google, ...).</span>
<span class="sd">    """</span>
    <span class="kn">import</span> <span class="nn">requests</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s">'Usage: {} url'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">raw_html</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r'^http[s]?://www\.google'</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">GoogleParser</span><span class="p">(</span><span class="n">raw_html</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r'^http://yandex\.ru'</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">YandexParser</span><span class="p">(</span><span class="n">raw_html</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r'^http://www\.bing\.'</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">BingParser</span><span class="p">(</span><span class="n">raw_html</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r'^http[s]?://search\.yahoo.'</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">YahooParser</span><span class="p">(</span><span class="n">raw_html</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r'^http://www\.baidu\.com'</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">BaiduParser</span><span class="p">(</span><span class="n">raw_html</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r'^https://duckduckgo\.com'</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">DuckduckgoParser</span><span class="p">(</span><span class="n">raw_html</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'/tmp/testhtml.html'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
        <span class="n">of</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">raw_html</span><span class="p">)</span>
</pre></div>


<h3>What you can expect in the near future from GoogleScaper?</h3>
<p>I am quite excited to develop some new features for GoogleScraper:</p>
<ol>
<li>Comple documentation and hosting it on
    <a href="https://readthedocs.org/" title="readthedocs">readthedocs</a>.</li>
<li>Asynchroneous support for massive parallel scraping with 1000
    proxies and up. I don't know yet what framework to use. Maybe
    Twisted or something more low level (libevent, epoll, ...)</li>
<li>SqlAlchemy integration. I am really excited about that.</li>
<li>Cleaner API.</li>
<li>Complete configuration for all search engine parameters.</li>
<li>Many examples that show how to use GoogleScraper effectively</li>
</ol>
<p>Many thanks for your patience and time!<br/>
Nikolai</p>
  </div>
  </div></body></html>