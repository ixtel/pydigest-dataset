<html><body><div><div dir="ltr" trbidi="on">
<p>Попытка сборка на ОС Windows заканчивается ошибкой при выполнении программы "Import error: could not load shared library from obspy.signal". Я расскажу как быстро преодолеть эту ошибку.
</p>
<a name="more"/>
<p>Obspy динамически подгружает pyd модули в obspy/signal/headers.py:27-28 и 49-50. Причем происходит формирование относительного пути до них, переходя на 1 уровень вверх в директорию Lib. Проблема в том что cx_freeze об этих pyd файлах заранее не знает, поэтому и не включает их при сборке. Если мы зададим в конфигурационном файле включения этих файлов, то не получим желаемый результат. Потому что headers.py рассчитывает их найти в ../Lib, а файлы копируются в корень сборочной директории build, что на несколько уровней выше ожидаемого. Как правильно разрешить этот конфликт я не знаю, поэтому пошел по пути быстрого, но не элегантного решения.</p>

<p>1. Сделаем себе копию файла headers.py и поместим в директорию проекта.</p>
<p>2. Сделаем две замены </p><p class="python">C.CDLL(os.path.join(os.path.dirname(__file__), os.pardir,
                                         'lib', lib_name + lib_extension))</p><p>
       на </p><p class="python">C.CDLL(os.path.join(os.path.dirname(__file__), os.pardir,os.pardir,os.pardir,
                                         'lib', lib_name + lib_extension))</p>

<p>3. Запишем файл setup.py следующим образом
</p><p class="python">
from cx_Freeze import setup, Executable<br/>
import os,shutil<br/>
#my_hack<br/>
<b>os.rename(r'C:\Python27\Lib\site-packages\obspy\signal\headers.py', r'C:\Python27\Lib\site-packages\obspy\signal\headers.py.backup')<br/>
shutil.copy('headers.py', r'C:\Python27\Lib\site-packages\obspy\signal/')</b><br/>
<br/>
# Dependencies are automatically detected, but it might need <br/>
# fine tuning.<br/>
buildOptions = dict(packages = ['numpy','obspy','obspy.signal','scipy','matplotlib.backends.backend_tkagg'], <b>include_files=[r'C:\Python27\Lib\site-packages\obspy\lib']</b>, excludes = [])<br/>
<br/>
import sys<br/>
base = 'Win32GUI' if sys.platform=='win32' else None<br/>
<br/>
executables = [<br/>
    Executable('calcsi_gui.py', base=base)<br/>
]<br/>
<br/>
setup(name='calcsi_gui',<br/>
      version = '1.0',<br/>
      description = '',<br/>
      options = dict(build_exe = buildOptions),<br/>
      executables = executables)<br/>
<br/>
#release my hack<br/>
<b><br/>
os.remove(r'C:\Python27\Lib\site-packages\obspy\signal\headers.py')<br/>
os.rename(r'C:\Python27\Lib\site-packages\obspy\signal\headers.py.backup', r'C:\Python27\Lib\site-packages\obspy\signal\headers.py')<br/>
</b>
</p>

<b>Жирным</b><p> выделены необходимые правки. Фактически на время сборки будет происходить подмена оригинального headers.py на модифицированный.

</p></div>
</div></body></html>