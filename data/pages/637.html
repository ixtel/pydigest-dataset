<html><body><div><section class="the_post">
    <div class="section" id="motivation">
<h2>Motivation</h2>
<p>It is quite common for modern web sites to include real-time notifications and alerts. Implementing this feature on sites based on Django is difficult due to the limitations on the architecture and underlying technology.</p>
<p>There are several alternatives, like our very own <a class="reference external" href="https://github.com/machinalis/telegraphy">Telegraphy</a> that uses a Twisted server for message delivery to and from the clients. Although this more than enough for our purposes, we wanted to show you how to integrate popular and mature solutions into an existing Django-based site, so we chose Node.js, Socket.io and Redis for message delivery and Django with django-notifications for the notification generation within the site itself.</p>
<p>The solution is based on the one proposed <a class="reference external" href="http://maxburstein.com/blog/realtime-django-using-nodejs-and-socketio/">here</a>, but it is extended for the use case of notifications which can be directed to a specific user that might be logged from several locations.</p>
<p>Another extension to Max Burnstein’s solution, is that we’re going to use <a class="reference external" href="http://nginx.org/">Nginx</a> as reverse proxy for our site. The access to the site itself is straight forward, but the WebSockets require special consideration.</p>
</div>
<div class="section" id="the-application">
<h2>The application</h2>
<p>We’re going to build a Django application on an Ubuntu Server 12.04 LTS, using the following packages, python and node.js modules:</p>
<ul class="simple">
<li>curl, python-software-properties, g++ and make</li>
<li>python</li>
<li>python-virtualenv</li>
<li>redis-server</li>
<li>nginx (from the <a class="reference external" href="http://wiki.nginx.org/Install#Ubuntu_PPA">official Nginx ppa</a>)</li>
<li>nodejs (from <a class="reference external" href="https://launchpad.net/~chris-lea/+archive/node.js/">Chris Leas’s ppa</a>)</li>
<li>npm, socket.io and cookie</li>
<li>django</li>
<li>django-notifications-hq</li>
<li>django-user-sessions</li>
</ul>
</div>
<div class="section" id="the-environment">
<h2>The environment</h2>
<p>Let us start by installing the necessary Ubuntu packages:</p>
<div class="highlight-python">
<pre>$ sudo apt-get install curl python-software-properties g++ make
$ sudo apt-get install python python-virtualenv
$ sudo apt-get install redis-server
$ sudo add-apt-repository ppa:chris-lea/node.js
$ sudo add-apt-repository ppa:nginx/stable
$ sudo apt-get update
$ sudo apt-get install nodejs nginx</pre>
</div>
<p>Next, we are going to install the node.js modules. We chose to set them up as global modules to make things easier, but we could have just installed them locally and then made sure that they are available to our application:</p>
<div class="highlight-python">
<pre>$ curl https://www.npmjs.org/install.sh | sudo sh
$ sudo npm install -g socket.io
$ sudo npm install -g cookie</pre>
</div>
<p>Now we have everything in place but the python-specific dependencies. In order to avoid messing with the system’s python modules, we’re going to create a new virtualenv, and install the dependencies on it:</p>
<div class="highlight-python">
<pre>$ virtualenv venv
$ . venb/bin/activate
$ pip install django
$ pip install django-notifications-hq
$ pip install django-user-sessions
$ pip install redis</pre>
</div>
<p>At this point we have everything we need to start building our Django application. We’ll follow the first steps of the <a class="reference external" href="https://docs.djangoproject.com/en/dev/intro/tutorial01/">Django tutorial</a> so you can have a complete picture of the inner workings of the application.</p>
</div>
<div class="section" id="initial-steps">
<h2>Initial steps</h2>
<p>Unless otherwise indicated, every command listed from now on is supposed to be run from within the virtual environment we created on the previous section. Use:</p>

<p>to activate the virtual environment. We’ll use the <tt class="docutils literal"><span class="pre">django-admin.py</span></tt> script to perform the initial set-up of the application:</p>
<div class="highlight-python">
<pre>$ django-admin.py startproject realtime_notifications</pre>
</div>
<p>This will create a new directory called <tt class="docutils literal"><span class="pre">realtime_notifications</span></tt> and create an empty Django project called <tt class="docutils literal"><span class="pre">realtime_notifications</span></tt>. Change into the <tt class="docutils literal"><span class="pre">realtime_notifications</span></tt> directory and create an empty application called <tt class="docutils literal"><span class="pre">rn</span></tt> with the following command:</p>
<div class="highlight-python">
<pre>$ python manage.py startapp rn</pre>
</div>
<p>The contents of the <tt class="docutils literal"><span class="pre">realtime_notifications</span></tt> directory should look like this:</p>
<div class="highlight-python">
<pre>realtime_notifications/
├── manage.py
├── realtime_notifications
│   ├── __init__.py
│   ├── __init__.pyc
│   ├── settings.py
│   ├── settings.pyc
│   ├── urls.py
│   └── wsgi.py
└── rn
    ├── admin.py
    ├── __init__.py
    ├── models.py
    ├── tests.py
    └── views.py</pre>
</div>
<p>Read the <a class="reference external" href="https://docs.djangoproject.com/en/1.6/">Django documentation</a> for an explanation of the purpose of each file.</p>
<p>We’re going to use the default SQLite database, but the instructions that follow are valid for any of the supported back-ends. Run the following commands to set-up the database:</p>
<div class="highlight-python">
<pre>$ python manage.py syncdb
Creating tables ...
Creating table django_admin_log
Creating table auth_permission
Creating table auth_group_permissions
Creating table auth_group
Creating table auth_user_groups
Creating table auth_user_user_permissions
Creating table auth_user
Creating table django_content_type
Creating table django_session

You just installed Django's auth system, which means you don't have any superusers defined.
Would you like to create one now? (yes/no): yes
Username (leave blank to use 'abarto'): admin
Email address: admin@localhost
Password:
Password (again):
Superuser created successfully.
Installing custom SQL ...
Installing indexes ...
Installed 0 object(s) from 0 fixture(s)</pre>
</div>
<p>Next, we are going to set-up the <tt class="docutils literal"><span class="pre">django-notifications-hq</span></tt> and <tt class="docutils literal"><span class="pre">django-user-sessions</span></tt> modules. Open the <tt class="docutils literal"><span class="pre">settings.py</span></tt> file and change the <tt class="docutils literal"><span class="pre">INSTALLED_APPS</span></tt> ad <tt class="docutils literal"><span class="pre">MIDDLEWARE_CLASSES</span></tt> definitions so they look like the following:</p>
<div class="highlight-python">
<div class="highlight">
<pre><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">'django.contrib.admin'</span><span class="p">,</span>
    <span class="s">'django.contrib.auth'</span><span class="p">,</span>
    <span class="s">'django.contrib.contenttypes'</span><span class="p">,</span>
<span class="c"># 'django.contrib.sessions',</span>
    <span class="s">'user_sessions'</span><span class="p">,</span>
    <span class="s">'django.contrib.messages'</span><span class="p">,</span>
    <span class="s">'django.contrib.staticfiles'</span><span class="p">,</span>
    <span class="s">'notifications'</span><span class="p">,</span>
    <span class="s">'rn'</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">MIDDLEWARE_CLASSES</span> <span class="o">=</span> <span class="p">(</span>
<span class="c"># 'django.contrib.sessions.middleware.SessionMiddleware',</span>
    <span class="s">'user_sessions.middleware.SessionMiddleware'</span><span class="p">,</span>
    <span class="s">'django.middleware.common.CommonMiddleware'</span><span class="p">,</span>
    <span class="s">'django.middleware.csrf.CsrfViewMiddleware'</span><span class="p">,</span>
    <span class="s">'django.contrib.auth.middleware.AuthenticationMiddleware'</span><span class="p">,</span>
    <span class="s">'django.contrib.messages.middleware.MessageMiddleware'</span><span class="p">,</span>
    <span class="s">'django.middleware.clickjacking.XFrameOptionsMiddleware'</span><span class="p">,</span>
<span class="p">)</span>
</pre>
</div>
</div>
<p>and add the following to the file:</p>
<div class="highlight-python">
<div class="highlight">
<pre><span class="n">SESSION_ENGINE</span> <span class="o">=</span> <span class="s">'user_sessions.backends.db'</span>
</pre>
</div>
</div>
<p>What we did is add <tt class="docutils literal"><span class="pre">notifications</span></tt> to the site’s apps, replaced the default session implementation with the one provided by <tt class="docutils literal"><span class="pre">django-user-sessions</span></tt> and set the database back-end for the session engine. Add the django-notifications-hq and django-user-sessions to the <tt class="docutils literal"><span class="pre">urls.py</span></tt> file:</p>
<div class="highlight-python">
<div class="highlight">
<pre><span class="kn">import</span> <span class="nn">notifications</span>

<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">include</span><span class="p">,</span> <span class="n">url</span>

<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="n">admin</span><span class="o">.</span><span class="n">autodiscover</span><span class="p">()</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">''</span><span class="p">,</span>
    <span class="c"># Examples:</span>
    <span class="c"># url(r'^$', 'realtime_notifications.views.home', name='home'),</span>
    <span class="c"># url(r'^blog/', include('blog.urls')),</span>

    <span class="n">url</span><span class="p">(</span><span class="s">r'^admin/'</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">'^inbox/notifications/'</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">notifications</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r''</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s">'user_sessions.urls'</span><span class="p">,</span> <span class="s">'user_sessions'</span><span class="p">))</span>
<span class="p">)</span>
</pre>
</div>
</div>
<p>Run the syncdb command one more time to set-up the necessary tables for the django-notifications-hq and django-user-sessions modules:</p>
<div class="highlight-python">
<pre>$ python manage.py syncdb
Creating tables ...
Creating table user_sessions_session
Creating table notifications_notification
Installing custom SQL ...
Installing indexes ...
Installed 0 object(s) from 0 fixture(s)</pre>
</div>
</div>
<div class="section" id="non-real-time-notifications">
<h2>Non real-time notifications</h2>
<p>At this point we can start working on the application. Our site needs only very basic features to demonstrate the traditional (i.e. non real-time) notifications, as described in the following user stories:</p>
<ul class="simple">
<li>As a User I want to to log into and out of the site</li>
<li>As a User I want to see the unread notifications sent to me</li>
<li>As a User I want to send notifications to other users</li>
<li>As a User I want to mark all received notifications as read</li>
</ul>
<p>We’re going to make use of the existing Django login and logout views. So we only need to cover the rest of the use cases.</p>
<p>This is how our <tt class="docutils literal"><span class="pre">rn/views.py</span></tt> module looks like:</p>
<div class="highlight-python">
<div class="highlight">
<pre><span class="kn">from</span> <span class="nn">notifications.models</span> <span class="kn">import</span> <span class="n">Notification</span>
<span class="kn">from</span> <span class="nn">notifications</span> <span class="kn">import</span> <span class="n">notify</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponseRedirect</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">django.core.urlresolvers</span> <span class="kn">import</span> <span class="n">reverse</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="kn">import</span> <span class="n">login_required</span>


<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">home</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">notifications</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">notifications</span><span class="o">.</span><span class="n">unread</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">'-timestamp'</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'index.html'</span><span class="p">,</span> <span class="p">{</span><span class="s">'notifications'</span><span class="p">:</span> <span class="n">notifications</span><span class="p">})</span>


<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">send_notification</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">recipient_username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'recipient_username'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">recipient_username</span><span class="p">:</span>
        <span class="n">recipients</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">recipient_username</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">recipients</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">recipient</span> <span class="ow">in</span> <span class="n">recipients</span><span class="p">:</span>
        <span class="n">notify</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
            <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
            <span class="n">recipient</span><span class="o">=</span><span class="n">recipient</span><span class="p">,</span>
            <span class="n">verb</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'verb'</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s">'home'</span><span class="p">))</span>


<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">mark_as_read</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">notifications</span><span class="o">.</span><span class="n">unread</span><span class="p">()</span><span class="o">.</span><span class="n">mark_all_as_read</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s">'home'</span><span class="p">))</span>
</pre>
</div>
</div>
<p>We’ve defined a view for the home page that displays the unread notifications for the user, a view to send notifications to one or all the users of the site and a view to mark all unread notifications as read.</p>
<p>These are the contents of the <tt class="docutils literal"><span class="pre">urls.py</span></tt> module:</p>
<div class="highlight-python">
<div class="highlight">
<pre><span class="kn">import</span> <span class="nn">notifications</span>

<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">include</span><span class="p">,</span> <span class="n">url</span>

<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="n">admin</span><span class="o">.</span><span class="n">autodiscover</span><span class="p">()</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">''</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^admin/'</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">'^inbox/notifications/'</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">notifications</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r''</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s">'user_sessions.urls'</span><span class="p">,</span> <span class="s">'user_sessions'</span><span class="p">)),</span>

    <span class="n">url</span><span class="p">(</span><span class="s">r'^$'</span><span class="p">,</span> <span class="s">'rn.views.home'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'home'</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^send_notification/$'</span><span class="p">,</span> <span class="s">'rn.views.send_notification'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'send_notification'</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^mark_as_read/$'</span><span class="p">,</span> <span class="s">'rn.views.mark_as_read'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'mark_as_read'</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^accounts/login/$'</span><span class="p">,</span> <span class="s">'django.contrib.auth.views.login'</span><span class="p">,</span> <span class="p">{</span><span class="s">'template_name'</span><span class="p">:</span> <span class="s">'admin/login.html'</span><span class="p">},</span> <span class="n">name</span><span class="o">=</span><span class="s">'login'</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^accounts/logout/$'</span><span class="p">,</span> <span class="s">'django.contrib.auth.views.logout'</span><span class="p">,</span> <span class="p">{</span><span class="s">'next_page'</span><span class="p">:</span> <span class="s">'/'</span><span class="p">},</span> <span class="n">name</span><span class="o">=</span><span class="s">'logout'</span><span class="p">)</span>
<span class="p">)</span>
</pre>
</div>
</div>
<p>All we need now is a way to present the views. We created a template in <tt class="docutils literal"><span class="pre">rn/templates/index.html</span></tt> with the following content:</p>
<div class="highlight-python">
<pre>&lt;!DOCTYPE html&gt;

{% load static %}
{% load notifications_tags %}

&lt;html&gt;
&lt;head&gt;
    &lt;link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet"&gt;
    &lt;link href="{% static 'css/bootstrap-theme.min.css' %}" rel="stylesheet"&gt;
    &lt;script src="{% static 'js/jquery-2.1.0.min.js' %}"&gt;&lt;/script&gt;
    &lt;script src="{% static 'js/bootstrap.min.js' %}"&gt;&lt;/script&gt;

    &lt;script&gt;
        $(document).ready(function() {
            $("#send-notification-button").popover({
                container: "body",
                html: true,
                placement: "right",
                content: function() {
                    return $("#send-notification-popover").html();
                },
                trigger: "click"
            });
        });
    &lt;/script&gt;

    &lt;title&gt;Real-time notifications in Django {% if user.is_authenticated %}({{ user.username }}){% endif %}&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class="container-fluid"&gt;
        &lt;div class="navbar navbar-default" role="navigation"&gt;
            &lt;div class="container-fluid"&gt;
                &lt;div class="navbar-header"&gt;
                    &lt;a class="navbar-brand" href="#"&gt;Real-time Django notifications&lt;/a&gt;
                &lt;/div&gt;
                &lt;div class="navbar-collapse collapse"&gt;
                    &lt;ul class="nav navbar-nav navbar-right"&gt;
                        {% if user.is_authenticated %}
                        &lt;li&gt;&lt;a href="{% url 'logout' %}"&gt;Logout&lt;/a&gt;&lt;/li&gt;
                        {% else %}
                        &lt;li&gt;&lt;a href="{% url 'login' %}"&gt;Login&lt;/a&gt;&lt;/li&gt;
                        {% endif %}
                    &lt;/ul&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="container-fluid"&gt;
        &lt;div class="panel panel-default"&gt;
            {% notifications_unread as unread_count %}
            &lt;div class="panel-heading"&gt;Unread notifications &lt;span class="badge"&gt;{{ unread_count }}&lt;/span&gt;&lt;/div&gt;
            &lt;div class="panel-body"&gt;
                &lt;div class="row"&gt;
                    &lt;div class="col-md-2"&gt;
                        &lt;button id="send-notification-button" type="button" class="btn btn-default btn-block"&gt;Send Notification&lt;/button&gt;
                        &lt;div id="send-notification-popover" class="hide"&gt;
                            &lt;form id="send-notification-form" role="form" action="{% url 'send_notification' %}" method="post"&gt;
                                {% csrf_token %}
                                &lt;div class="form-group"&gt;
                                    &lt;label for="recipient_username"&gt;Username&lt;/label&gt;
                                    &lt;input type="text" class="form-control" id="recipient_username" name="recipient_username" placeholder="Recipient username"&gt;
                                &lt;/div&gt;
                                &lt;div class="form-group"&gt;
                                    &lt;label for="verb"&gt;Verb&lt;/label&gt;
                                    &lt;input type="text" class="form-control" id="verb" name="verb" placeholder="Verb"&gt;
                                &lt;/div&gt;
                                &lt;button type="submit" class="btn btn-default"&gt;Submit&lt;/button&gt;
                            &lt;/form&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                    &lt;div class="col-md-2"&gt;&lt;a id="clear-button" class="btn btn-default btn-block" href="{% url 'mark_as_read' %}"&gt;Mark as read&lt;/a&gt;&lt;/div&gt;
                &lt;/div&gt;
                &lt;div class="row"&gt;
                    &lt;div class="col-md-12"&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            &lt;table class="table table-bordered"&gt;
                &lt;thead&gt;
                    &lt;tr&gt;
                        &lt;th&gt;Timestamp&lt;/th&gt;
                        &lt;th&gt;Recipient&lt;/th&gt;
                        &lt;th&gt;Actor&lt;/th&gt;
                        &lt;th&gt;Verb&lt;/th&gt;
                        &lt;th&gt;Action Object&lt;/th&gt;
                        &lt;th&gt;Target&lt;/th&gt;
                        &lt;th&gt;Description&lt;/th&gt;
                    &lt;/tr&gt;
                &lt;/thead&gt;
                &lt;tbody&gt;
                    {% for notification in notifications %}
                    &lt;tr&gt;
                        &lt;td&gt;{{ notification.timestamp|date:"c" }}&lt;/td&gt;
                        &lt;td&gt;{{ notification.recipient|default:"" }}&lt;/td&gt;
                        &lt;td&gt;{{ notification.actor|default:"" }}&lt;/td&gt;
                        &lt;td&gt;{{ notification.verb|default:"" }}&lt;/td&gt;
                        &lt;td&gt;{{ notification.action_object|default:"" }}&lt;/td&gt;
                        &lt;td&gt;{{ notification.target|default:"" }}&lt;/td&gt;
                        &lt;td&gt;{{ notification.description|default:"" }}&lt;/td&gt;
                    &lt;/tr&gt;
                    {% endfor %}
                &lt;/tbody&gt;
            &lt;/table&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>
</div>
<p>Notice that we reference files from Bootstrap and jQuery. You can download them from <a class="reference external" href="http://getbootstrap.com/">Bootstrap’s</a> and <a class="reference external" href="http://jquery.com/">jQuery’s</a> home pages and put them in the <tt class="docutils literal"><span class="pre">rn/static/</span></tt> directory. We could have avoided these dependencies, but we wanted to make the example re-usable for real websites.</p>
<p>We now have covered all of the use cases, but there’s a problem: If a notification is generated, the user won’t see it until it reloads the page. We need a way to push those notifications to the user.</p>
</div>
<div class="section" id="real-time-notifications">
<h2>Real-time notifications</h2>
<p>There have been a lot of solutions to the problem of pushing content to the client, but none of them had wide-spread adoption due to the limitations of the HTTP protocol. WebSockets provide a solution to the problem as it allows bi-directional full-duplex communication between the server and the client. Sadly, the WebSockets specification hasn’t been standarized yet and support for it has only recently been included on all the popular web browsers.</p>
<p>In order to have real-time communication with the client on every possible web browser, we need a more general solution. socket.io provides such solution. socket.io is a JavaScript library with components for both the client and the server. It has support for WebSockets, but if they aren’t available it can fallback to other means of real-time communication. The server part of the library runs on top of node.js, which provides a high-performance event-driven framework to manage the message exchange with the clients.</p>
<p>All we need now is a way to connect the socket.io server running on node.js with our Django site. This can be easily done using Redis. Redis is a basically a key-value store, but it also provides a way to subscribe and publish to keys, so it basically becomes a message bus. With this architecture, the socket.io server will subscribe a user specific key, onto which Django is going to write the notifications. Once the message is received, the server will send it to the connected client.</p>
</div>
<div class="section" id="node-js-server">
<h2>node.js server</h2>
<p>There’s not much to our node.js/socket.io server:</p>
<div class="highlight-python">
<pre>var http = require('http');
var server = http.createServer().listen(8002);
var io = require('socket.io').listen(server);
var cookie_reader = require('cookie');
var querystring = require('querystring');
var redis = require('socket.io/node_modules/redis');

//Configure socket.io to store cookie set by Django
io.configure(function(){
    io.set('authorization', function(data, accept){
        if(data.headers.cookie){
            data.cookie = cookie_reader.parse(data.headers.cookie);
            return accept(null, true);
        }
        return accept('error', false);
    });
    io.set('log level', 1);
});

io.sockets.on('connection', function (socket) {
    // Create redis client
    client = redis.createClient();

    // Subscribe to the Redis events channel
    client.subscribe('notifications.' + socket.handshake.cookie['sessionid']);

    // Grab message from Redis and send to client
    client.on('message', function(channel, message){
        console.log('on message', message);
        socket.send(message);
    });

    // Unsubscribe after a disconnect event
    socket.on('disconnect', function () {
        client.unsubscribe('notifications.' + socket.handshake.cookie['sessionid']);
    });
});</pre>
</div>
<p>Once the client connects, the handler function is invoked, which connects to the redis server, subscribes to key unique to that session and configures the event handler for when a message is written to the key. When a message is received, it is sent (in its JSON form) down the client’s channel. This file can be stored anywhere as long as node.js has access to the socket.io and cookie dependencies (that’s why we used the global installation). We put the file in <tt class="docutils literal"><span class="pre">nodejs/notifications.js</span></tt> under the root of the site directory. You can run the server typing:</p>
<div class="highlight-python">
<pre>$ node nodejs/notifications.js
info  - socket.io started</pre>
</div>
</div>
<div class="section" id="real-time-client">
<h2>Real-time client</h2>
<p>Before we make the change that’s responsible for writing the Django notifications onto the Redis key, we’ll change the client code to connect to the socket.io server and avoid reloading the page whenever we create a notification o mark them as read.</p>
<p>First we need to create views to allow AJAX calls to send_notification and mark_as_read and a new view that points to the real-time version of the home template. These are the changes to <tt class="docutils literal"><span class="pre">rn/views.py</span></tt>:</p>
<div class="highlight-python">
<div class="highlight">
<pre><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">redis</span>

<span class="kn">from</span> <span class="nn">notifications</span> <span class="kn">import</span> <span class="n">notify</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="kn">import</span> <span class="n">login_required</span>

<span class="kn">from</span> <span class="nn">django.db.models.signals</span> <span class="kn">import</span> <span class="n">post_save</span>
<span class="kn">from</span> <span class="nn">django.dispatch</span> <span class="kn">import</span> <span class="n">receiver</span>
<span class="kn">from</span> <span class="nn">notifications.models</span> <span class="kn">import</span> <span class="n">Notification</span>

<span class="o">...</span>

<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">home_realtime</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">notifications</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">notifications</span><span class="o">.</span><span class="n">unread</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">'-timestamp'</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'index_realtime.html'</span><span class="p">,</span> <span class="p">{</span><span class="s">'notifications'</span><span class="p">:</span> <span class="n">notifications</span><span class="p">})</span>


<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">ajax_send_notification</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">recipient_username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'recipient_username'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">recipient_username</span><span class="p">:</span>
        <span class="n">recipients</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">recipient_username</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">recipients</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">recipient</span> <span class="ow">in</span> <span class="n">recipients</span><span class="p">:</span>
        <span class="n">notify</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
            <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
            <span class="n">recipient</span><span class="o">=</span><span class="n">recipient</span><span class="p">,</span>
            <span class="n">verb</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'verb'</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">"success"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}),</span> <span class="n">content_type</span><span class="o">=</span><span class="s">"application/json"</span><span class="p">)</span>


<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">ajax_mark_as_read</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">notifications</span><span class="o">.</span><span class="n">unread</span><span class="p">()</span><span class="o">.</span><span class="n">mark_all_as_read</span><span class="p">()</span>

    <span class="n">redis_client</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'localhost'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">6379</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">session_set</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="n">redis_client</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
            <span class="s">'notifications.</span><span class="si">%s</span><span class="s">'</span> <span class="o">%</span> <span class="n">session</span><span class="o">.</span><span class="n">session_key</span><span class="p">,</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">"mark_as_read"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">"unread_count"</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">"success"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}),</span> <span class="n">content_type</span><span class="o">=</span><span class="s">"application/json"</span><span class="p">)</span>

<span class="nd">@receiver</span><span class="p">(</span><span class="n">post_save</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">Notification</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">on_notification_post_save</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">redis_client</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'localhost'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">6379</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">notification</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">'instance'</span><span class="p">]</span>
    <span class="n">recipient</span> <span class="o">=</span> <span class="n">notification</span><span class="o">.</span><span class="n">recipient</span>

    <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">recipient</span><span class="o">.</span><span class="n">session_set</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="n">redis_client</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
            <span class="s">'notifications.</span><span class="si">%s</span><span class="s">'</span> <span class="o">%</span> <span class="n">session</span><span class="o">.</span><span class="n">session_key</span><span class="p">,</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">timestamp</span><span class="o">=</span><span class="n">notification</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                    <span class="n">recipient</span><span class="o">=</span><span class="n">notification</span><span class="o">.</span><span class="n">recipient</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                    <span class="n">actor</span><span class="o">=</span><span class="n">notification</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                    <span class="n">verb</span><span class="o">=</span><span class="n">notification</span><span class="o">.</span><span class="n">verb</span><span class="p">,</span>
                    <span class="n">action_object</span><span class="o">=</span><span class="n">notification</span><span class="o">.</span><span class="n">action_object</span><span class="p">,</span>
                    <span class="n">target</span><span class="o">=</span><span class="n">notification</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="n">notification</span><span class="o">.</span><span class="n">description</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
</pre>
</div>
</div>
<p>We’ve created a new <tt class="docutils literal"><span class="pre">home_realtime</span></tt> view that points to the new template for realtime notifications, and two views similar to the <tt class="docutils literal"><span class="pre">send_notification</span></tt> and <tt class="docutils literal"><span class="pre">mark_as_read</span></tt> but inteded to be used with AJAX calls. The <tt class="docutils literal"><span class="pre">ajax_mark_as_read</span></tt> view also writes to the user’s redis notification key to signal that all the notifications were marked as read, and that the UI should be updated accordingly.</p>
<p>The last method defined is a handler for the ‘post_save’ signal on the Notification model. With this handler, whenever a Notification is saved, it is written (as a JSON object) into the recipient session keys on Redis. Usually signal handlers are defined on a ‘signals.py’ module, but we wanted to keep the example as simple as possible.</p>
<p>Now that we have the views, we need a template (which will be stored in <tt class="docutils literal"><span class="pre">rn/templates/index_realtime.html</span></tt>) to exposed them:</p>
<div class="highlight-python">
<pre>&lt;!DOCTYPE html&gt;

{% load static %}
{% load notifications_tags %}

&lt;html&gt;
&lt;head&gt;
    &lt;link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet"&gt;
    &lt;link href="{% static 'css/bootstrap-theme.min.css' %}" rel="stylesheet"&gt;
    &lt;script src="{% static 'js/jquery-2.1.0.min.js' %}"&gt;&lt;/script&gt;
    &lt;script src="{% static 'js/bootstrap.min.js' %}"&gt;&lt;/script&gt;
    &lt;script src="http://localhost:8002/socket.io/socket.io.js"&gt;&lt;/script&gt;

    &lt;script&gt;
        function getCookie(name) {
            var cookieValue = null;

            if (document.cookie &amp;&amp; document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i &lt; cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }

            return cookieValue;
        }

        $(document).ready(function() {
            $("#mark-as-read-button").on("click", function(event) {
                event.preventDefault();

                $.ajax({
                    url: "{% url 'ajax_mark_as_read' %}",
                    type: "POST",
                    success: function(data) {
                    },
                    beforeSend: function(xhr){
                        var csrftoken = getCookie("csrftoken");
                        xhr.setRequestHeader('X-CSRFToken', csrftoken);
                    }
                });
            });

            $("#send-notification-button").popover({
                container: "body",
                html: true,
                placement: "right",
                content: function() {
                    return $("div.send-notification-popover").html();
                },
                trigger: "click"
            });

            $("body").on("click", "button.send-notification-form-submit", function(event) {
                event.preventDefault();

                var $send_notification_form = $(event.target).parent();

                $.ajax({
                    url: "{% url 'ajax_send_notification' %}",
                    type: "POST",
                    data: $send_notification_form.serialize(),
                    success: function(data) {
                        $("#send-notification-button").popover("hide");
                    },
                    beforeSend: function(xhr){
                        var csrftoken = getCookie("csrftoken");
                        xhr.setRequestHeader('X-CSRFToken', csrftoken);
                    }
                });
            });

            var socket = io.connect("localhost", {port: 8002});

            socket.on('message', function(message) {
                var message_json = jQuery.parseJSON(message);

                $("#unread_count").text(message_json.unread_count);

                if ("mark_as_read" in message_json) {
                    $("#notifications-table tbody").empty();
                } else {
                    var $tr = $("&lt;tr&gt;");
                    $tr.append($("&lt;td&gt;").text(message_json.timestamp));
                    $tr.append($("&lt;td&gt;").text(message_json.recipient));
                    $tr.append($("&lt;td&gt;").text(message_json.actor));
                    $tr.append($("&lt;td&gt;").text(message_json.verb));
                    $tr.append($("&lt;td&gt;").text(message_json.action_object));
                    $tr.append($("&lt;td&gt;").text(message_json.target));
                    $tr.append($("&lt;td&gt;").text(message_json.description));

                    $("#notifications-table tbody").prepend($tr);
                }
            });
        });
    &lt;/script&gt;

    &lt;title&gt;Real-time notifications in Django {% if user.is_authenticated %}({{ user.username }}){% endif %}&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class="container-fluid"&gt;
        &lt;div class="navbar navbar-default" role="navigation"&gt;
            &lt;div class="container-fluid"&gt;
                &lt;div class="navbar-header"&gt;
                    &lt;a class="navbar-brand" href="#"&gt;Real-time Django notifications&lt;/a&gt;
                &lt;/div&gt;
                &lt;div class="navbar-collapse collapse"&gt;
                    &lt;ul class="nav navbar-nav navbar-right"&gt;
                        {% if user.is_authenticated %}
                        &lt;li&gt;&lt;a href="{% url 'logout' %}"&gt;Logout&lt;/a&gt;&lt;/li&gt;
                        {% else %}
                        &lt;li&gt;&lt;a href="{% url 'login' %}"&gt;Login&lt;/a&gt;&lt;/li&gt;
                        {% endif %}
                    &lt;/ul&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="container-fluid"&gt;
        &lt;div class="panel panel-default"&gt;
            {% notifications_unread as unread_count %}
            &lt;div class="panel-heading"&gt;Unread notifications &lt;span id="unread_count" class="badge"&gt;{{ unread_count }}&lt;/span&gt;&lt;/div&gt;
            &lt;div class="panel-body"&gt;
                &lt;div class="row"&gt;
                    &lt;div class="col-md-2"&gt;
                        &lt;a id="send-notification-button" type="button" class="btn btn-default btn-block"&gt;Send Notification&lt;/a&gt;
                        &lt;div class="hide send-notification-popover"&gt;
                            &lt;form id="send-notification-form" role="form"&gt;
                                {% csrf_token %}
                                &lt;div class="form-group"&gt;
                                    &lt;label for="recipient_username"&gt;Username&lt;/label&gt;
                                    &lt;input type="text" class="form-control" id="recipient_username" name="recipient_username" placeholder="Recipient username"&gt;
                                &lt;/div&gt;
                                &lt;div class="form-group"&gt;
                                    &lt;label for="verb"&gt;Verb&lt;/label&gt;
                                    &lt;input type="text" class="form-control" id="verb" name="verb" placeholder="Verb"&gt;
                                &lt;/div&gt;
                                &lt;button class="btn btn-default send-notification-form-submit"&gt;Submit&lt;/button&gt;
                            &lt;/form&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                    &lt;div class="col-md-2"&gt;&lt;a id="mark-as-read-button" class="btn btn-default btn-block"&gt;Mark as read&lt;/a&gt;&lt;/div&gt;
                &lt;/div&gt;
                &lt;div class="row"&gt;
                    &lt;div class="col-md-12"&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            &lt;table id="notifications-table" class="table table-bordered"&gt;
                &lt;thead&gt;
                    &lt;tr&gt;
                        &lt;th&gt;Timestamp&lt;/th&gt;
                        &lt;th&gt;Recipient&lt;/th&gt;
                        &lt;th&gt;Actor&lt;/th&gt;
                        &lt;th&gt;Verb&lt;/th&gt;
                        &lt;th&gt;Action Object&lt;/th&gt;
                        &lt;th&gt;Target&lt;/th&gt;
                        &lt;th&gt;Description&lt;/th&gt;
                    &lt;/tr&gt;
                &lt;/thead&gt;
                &lt;tbody&gt;
                    {% for notification in notifications %}
                    &lt;tr&gt;
                        &lt;td&gt;{{ notification.timestamp|date:"c" }}&lt;/td&gt;
                        &lt;td&gt;{{ notification.recipient|default:"" }}&lt;/td&gt;
                        &lt;td&gt;{{ notification.actor|default:"" }}&lt;/td&gt;
                        &lt;td&gt;{{ notification.verb|default:"" }}&lt;/td&gt;
                        &lt;td&gt;{{ notification.action_object|default:"" }}&lt;/td&gt;
                        &lt;td&gt;{{ notification.target|default:"" }}&lt;/td&gt;
                        &lt;td&gt;{{ notification.description|default:"" }}&lt;/td&gt;
                    &lt;/tr&gt;
                    {% endfor %}
                &lt;/tbody&gt;
            &lt;/table&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>
</div>
<p>The template is very similar to the non real-time notifications version. The most important change is in the fourth script element. Within this script we use the typical <tt class="docutils literal"><span class="pre">$(document).ready(function()</span> <span class="pre">{}</span></tt> jQuery statement to have our event handler run once the document is ready. Let us go statement by statement analyzing what each does:</p>
<div class="highlight-python">
<pre>$("#mark-as-read-button").on("click", function(event) {
    event.preventDefault();

    $.ajax({
        url: "{% url 'ajax_mark_as_read' %}",
        type: "POST",
        success: function(data) {
        },
        beforeSend: function(xhr){
            var csrftoken = getCookie("csrftoken");
            xhr.setRequestHeader('X-CSRFToken', csrftoken);
        }
    });
});</pre>
</div>
<p>Whenever the element with id <tt class="docutils literal"><span class="pre">mark-as-read-button</span></tt> we should make an AJAX call to the <tt class="docutils literal"><span class="pre">ajax_mark_as_read</span></tt> URL. We do nothing if the call succeeds. We haven’t done any error handling since it’s not the purpose of this article to teach the reader how to properly do AJAX calls.:</p>
<div class="highlight-python">
<pre>$("#send-notification-button").popover({
    container: "body",
    html: true,
    placement: "right",
    content: function() {
        return $("div.send-notification-popover").html();
    },
    trigger: "click"
});</pre>
</div>
<p>We hook our Bootrap popover to the click event of the element with id <tt class="docutils literal"><span class="pre">send-notification-button</span></tt>:</p>
<div class="highlight-python">
<pre>$("body").on("click", "button.send-notification-form-submit", function(event) {
    event.preventDefault();

    var $send_notification_form = $(event.target).parent();

    $.ajax({
        url: "{% url 'ajax_send_notification' %}",
        type: "POST",
        data: $send_notification_form.serialize(),
        success: function(data) {
            $("#send-notification-button").popover("hide");
        },
        beforeSend: function(xhr){
            var csrftoken = getCookie("csrftoken");
            xhr.setRequestHeader('X-CSRFToken', csrftoken);
        }
    });
});</pre>
</div>
<p>Whenever a <tt class="docutils literal"><span class="pre">button</span></tt> element with id <tt class="docutils literal"><span class="pre">send-notification-form-submit</span></tt> under the <tt class="docutils literal"><span class="pre">body</span></tt> element (this is defined in the popover content), we make an AJAX call to the <tt class="docutils literal"><span class="pre">ajax_send_notification</span></tt> url, using the existing form as data. When the call succeeds, we hide the popover.:</p>
<div class="highlight-python">
<pre>var socket = io.connect("localhost", {port: 8002});

socket.on('message', function(message) {
    var message_json = jQuery.parseJSON(message);

    $("#unread_count").text(message_json.unread_count);

    if ("mark_as_read" in message_json) {
        $("#notifications-table tbody").empty();
    } else {
        var $tr = $("&lt;tr&gt;");
        $tr.append($("&lt;td&gt;").text(message_json.timestamp));
        $tr.append($("&lt;td&gt;").text(message_json.recipient));
        $tr.append($("&lt;td&gt;").text(message_json.actor));
        $tr.append($("&lt;td&gt;").text(message_json.verb));
        $tr.append($("&lt;td&gt;").text(message_json.action_object));
        $tr.append($("&lt;td&gt;").text(message_json.target));
        $tr.append($("&lt;td&gt;").text(message_json.description));

        $("#notifications-table tbody").prepend($tr);
    }
});</pre>
</div>
<p>This is the most important part of the template. We create a socket.io channel to <tt class="docutils literal"><span class="pre">localhost</span></tt> on port 8002, which was the one we used for our node.js service and hook an event handler to the <tt class="docutils literal"><span class="pre">message</span></tt> event for the channel. On this event handler we do three things:</p>
<ul class="simple">
<li>We parse the payload of the message as JSON.</li>
<li>If <tt class="docutils literal"><span class="pre">mark_as_read</span></tt> is present in the message, we clear the notifications table</li>
<li>If <tt class="docutils literal"><span class="pre">mark_as_read</span></tt> is not present in the message, we create a new row at the top notifications table using the message information for each column.</li>
</ul>
<p>So, whenever something is written to the session’s events key on Redis, that is picked up by the node.js service, which takes the message and sends it to the client through the channel, and when that is received, the UI is updated accordingly without reloading the page.</p>
<p>The last thing we need to do, is add the urls for the views into the <tt class="docutils literal"><span class="pre">urls.py</span></tt> module:</p>
<div class="highlight-python">
<div class="highlight">
<pre><span class="n">url</span><span class="p">(</span><span class="s">r'^realtime/$'</span><span class="p">,</span> <span class="s">'rn.views.home_realtime'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'home_realtime'</span><span class="p">),</span>
<span class="n">url</span><span class="p">(</span><span class="s">r'^ajax_send_notification/$'</span><span class="p">,</span> <span class="s">'rn.views.ajax_send_notification'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'ajax_send_notification'</span><span class="p">),</span>
<span class="n">url</span><span class="p">(</span><span class="s">r'^ajax_mark_as_read/$'</span><span class="p">,</span> <span class="s">'rn.views.ajax_mark_as_read'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'ajax_mark_as_read'</span><span class="p">),</span>
</pre>
</div>
</div>
<p>Run the <tt class="docutils literal"><span class="pre">notifications.js</span></tt> node.js module, and our Django site, and open the URL <tt class="docutils literal"><span class="pre">http://localhost:8000/realtime/</span></tt>. If everything went right, you’ll see that everything is updated without reloading the page. In order to properly test the functionality, we suggest you open a different browser and log in with the same user. Whenever a notification is sent to that user, you’ll see the page update itself. If you click on the “Mark as read” button, you’ll see that both tables are cleared.</p>
</div>
<div class="section" id="nginx-support">
<h2>Nginx support</h2>
<p>It’s not uncommon for Django sites to be behind an Nginx reverse proxy. Starting from version 1.4, Nginx has support for WebSockets, but it needs to be configured to do so. This is a possible configuration for our site:</p>
<div class="highlight-python">
<pre>map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

server {
    listen   80;
    #listen   [::]:80 default_server ipv6only=on; ## listen for ipv6

    # Make site accessible from http://localhost/
    server_name 'localhost';

    location / {
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host 'localhost';
        proxy_pass http://127.0.0.1:8000;
    }

    location /socket.io {
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host ''localhost'';
        proxy_pass http://127.0.0.1:8002;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }
}</pre>
</div>
<p>We also need to modify the <tt class="docutils literal"><span class="pre">rn/templates/index_realtime.html</span></tt> template:</p>
<div class="highlight-python">
<pre>...
&lt;script src="http://localhost/socket.io/socket.io.js"&gt;&lt;/script&gt;
...
var socket = io.connect("localhost");
...</pre>
</div>
<p>You should now be able to access the site at <tt class="docutils literal"><span class="pre">http://localhost/realtime</span></tt>.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>We hope we were able show you how easy it is to have real-time communications with the client, if you leverage the existing functionality of node.js, socket.io, Redis and Django with the django-notifications-hq module. Something we haven’t mentioned yet is that this solution works on pretty much every web browser, as socket.io abstracts the problem of constructing the actual communication channel between the client and the node.js service.</p>
<p>Feel free to send us comments, suggestions of improvements to the solution.</p>
</div>
</section>


</div></body></html>