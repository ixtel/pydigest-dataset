<html><body><div><div class="entry">
				<p>This is an expanded version of <a href="https://twitter.com/drjtwit/status/574537809836535808">an earlier tweet of mine</a>.</p>
<p>Consider the following Python program:</p>
<pre class="brush: python; title: ; notranslate" title="">
    d = {k:k for k in 'bfg'}
    print(d)
</pre>
<p>The output of this program changes from run to run:</p>
<pre class="brush: bash; title: ; notranslate" title="">
    drj$ ./d.py 
    {'g': 'g', 'f': 'f', 'b': 'b'}
    drj$ ./d.py 
    {'b': 'b', 'g': 'g', 'f': 'f'}
</pre>
<p>Dictionaries in Python are implemented using hash tables, so when iterating over a dictionary, the order of the keys is not generally predictable.</p>
<p>You might have known that it wasn’t predictable, but you might not have known that it can change from one Python process to the next. This is a good thing. It avoids a <a href="http://lwn.net/Articles/474912/">denial-of-service attack that is cross language and cross framework</a>. But don’t worry about that, <a href="https://bugs.python.org/issue13703">it’s been fixed since Python 3.3, released over 2 years ago now</a>.</p>
<p>Recently we (at <a href="https://scraperwiki.com/">ScraperWiki</a>) came across this in the context of floating point addition. What if the order of a dictionary determines the order of a summation? This program adds up the values of a dictionary:</p>
<pre class="brush: python; title: ; notranslate" title="">
    d = dict(b=0.2, f=0.6, g=0.7)
    print(sum(d.values()))
</pre>
<p>It doesn’t always produce the same answer:</p>
<pre class="brush: bash; title: ; notranslate" title="">
    drj$ ./e.py 
    1.4999999999999998
    drj$ ./e.py 
    1.5
</pre>
<p>This is obviously a very smaller difference, but as it happened we were dynamically generating a web page that showed rounded results. 1.4999999999999998 rounds to 1, 1.5 rounds to 2. You could reload the web page and the value shown would sometimes flip from 1 to 2, and vice versa (well, these aren’t the real numbers, but you get the idea).</p>
<p>There are a few things worth pointing out here. As a convenience instead of writing “3602879701896397 / 18014398509481984” I’ve written “0.2”, and similarly “5404319552844595 / 9007199254740992” is written “0.6”, and “3152519739159347 / 4503599627370496” is written “0.7”.</p>
<p>The second program is just calling <code>sum()</code>, so in this case I don’t get to pick the order of adding up for two reasons: 1) The order of the list that is input to <code>sum()</code> is not chosen by me; 2) The order in which <code>sum()</code> sums things might be different anyway (this turns out to be a surprisingly subtle subject, but I don’t want to get into <a href="https://docs.python.org/3/library/math.html#math.fsum"><code>math.fsum</code></a>).</p>
<p>Tweets like this: “<a href="https://twitter.com/OvidPerl/status/574627418494779393">I don’t care if float addition is associative or not</a>” miss the point I was making, which is that floating point addition is not associative (meaning that (0.2 ⟡ 0.6) ⟡ 0.7) != 0.2 ⟡ (0.6 ⟡ 0.7) where ⟡ means floating point addition). Floating point arithmetic is an abstraction and sometimes you need to understand the abstraction and what lies beneath in order to debug your webpage.</p>
<p>In this case we fixed the problem by avoiding floating point until the very last step. The numbers we were adding were all of the form <var>p/20</var> (where <var>p</var> is an integer). So doing the adding up in integers and then doing a single division at the end means that we get the exact answer (or the nearest representable floating point number when the exact answer is not representable).</p>
		<div id="jp-post-flair" class="sharedaddy sd-like-enabled"><div class="sharedaddy sd-block sd-like jetpack-likes-widget-wrapper jetpack-likes-widget-unloaded" id="like-post-wrapper-258145-1157-56d5b2eb87603" data-src="//widgets.wp.com/likes/#blog_id=258145&amp;post_id=1157&amp;origin=drj11.wordpress.com&amp;obj_id=258145-1157-56d5b2eb87603" data-name="like-post-frame-258145-1157-56d5b2eb87603"><h3 class="sd-title">Like this:</h3><p class="likes-widget-placeholder post-likes-widget-placeholder"><span class="button"><span>Like</span></span> <span class="loading">Loading...</span></p><span class="sd-text-color"/><a class="sd-link-color"/></div>
<p id="jp-relatedposts" class="jp-relatedposts">
	<h3 class="jp-relatedposts-headline"><em>Related</em></h3>
</p></div>
				
				<p class="postmetadata alt">
					<small>
						This entry was posted on												2015-03-30 at 08:10:36						and is filed under <a href="https://drj11.wordpress.com/category/programming/" rel="category tag">programming</a>.

						
						<br/>
						<br/>Tags: <a href="https://drj11.wordpress.com/tag/associativity/" rel="tag">associativity</a>, <a href="https://drj11.wordpress.com/tag/float/" rel="tag">float</a>
					</small>
				</p>

			</div>
		</div></body></html>