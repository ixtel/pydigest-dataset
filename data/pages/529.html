<html><body><div><div class="pf-content"><p>Python has a number of different concurrency constructs such as threading, queues and multiprocessing. The threading module used to be the primary way of accomplishing concurrency. A few years ago, the multiprocessing module was added to the Python suite of standard libraries. This article will be focused on the threading module though.<span id="more-3832"/></p>
<hr/>
<h3>Getting Started</h3>
<p>
</p><p>We will start with a simple example that just demonstrates how threads work. We will sub-class the <strong>Thread</strong> class and make it print out its name to stdout. Let’s get coding!</p>
<pre class="python"><span>import</span> <span>random</span>
<span>import</span> <span>time</span>
 
<span>from</span> <span>threading</span> <span>import</span> Thread
 
<span>########################################################################</span>
<span>class</span> MyThread<span>(</span>Thread<span>)</span>:
    <span>""</span><span>"
    A threading example
    "</span><span>""</span>
 
    <span>#----------------------------------------------------------------------</span>
    <span>def</span> <span>__init__</span><span>(</span><span>self</span>, name<span>)</span>:
        <span>""</span><span>"Initialize the thread"</span><span>""</span>
        Thread.<span>__init__</span><span>(</span><span>self</span><span>)</span>
        <span>self</span>.<span>name</span> = name
        <span>self</span>.<span>start</span><span>(</span><span>)</span>
 
    <span>#----------------------------------------------------------------------</span>
    <span>def</span> run<span>(</span><span>self</span><span>)</span>:
        <span>""</span><span>"Run the thread"</span><span>""</span>
        amount = <span>random</span>.<span>randint</span><span>(</span><span>3</span>, <span>15</span><span>)</span>
        <span>time</span>.<span>sleep</span><span>(</span>amount<span>)</span>
        msg = <span>"%s has finished!"</span> <span>%</span> <span>self</span>.<span>name</span>
        <span>print</span><span>(</span>msg<span>)</span>
 
<span>#----------------------------------------------------------------------</span>
<span>def</span> create_threads<span>(</span><span>)</span>:
    <span>""</span><span>"
    Create a group of threads
    "</span><span>""</span>
    <span>for</span> i <span>in</span> <span>range</span><span>(</span><span>5</span><span>)</span>:
        name = <span>"Thread #%s"</span> <span>%</span> <span>(</span>i<span>+1</span><span>)</span>
        my_thread = MyThread<span>(</span>name=name<span>)</span>
 
<span>if</span> __name__ == <span>"__main__"</span>:
    create_threads<span>(</span><span>)</span></pre>
<p>In the code above, we import Python’s random module, the time module and we import the Thread class from the threading module. Next we sub-class Thread and make override its <strong>__init__</strong> method to accept an argument we label “name”. To start a thread, you have to call its <strong>start()</strong> method, so we do that at the end of the init. When you start a thread, it will automatically call its <strong>run</strong> method. We have overridden its run method to make it choose a random amount of time to sleep. The <strong>random.randint</strong> example here will cause Python to randomly choose a number from 3-15. Then we make the thread sleep the number of seconds that we just randomly chose to simulate it actually doing something. Finally we print out the name of the thread to let the user know that the thread has finished.</p>
<p>The <strong>create_threads</strong> function will create 5 threads, giving each of them a unique name. If you run this code, you should see something like this:</p>
<p><code><br/>
Thread #2 has finished!<br/>
Thread #1 has finished!<br/>
Thread #3 has finished!<br/>
Thread #4 has finished!<br/>
Thread #5 has finished!<br/>
</code></p>
<p>The order of the output will be different each time. Try running the code a few times to see the order change.</p>
<hr/>
<h3>Writing a Threaded Downloader</h3>
<p>
</p><p>The previous example wasn’t very useful other than as a tool to explain how threads work. So in this example, we will create a Thread class that can download files from the internet. The U.S. Internal Revenue Service has lots of PDF forms that it has its citizens use for taxes. We will use this free resource for our demo. Here’s the code:</p>
<pre class="python"><span># Use this version for Python 2</span>
<span>import</span> <span>os</span>
<span>import</span> <span>urllib2</span>
 
<span>from</span> <span>threading</span> <span>import</span> Thread
 
<span>########################################################################</span>
<span>class</span> DownloadThread<span>(</span>Thread<span>)</span>:
    <span>""</span><span>"
    A threading example that can download a file
    "</span><span>""</span>
 
    <span>#----------------------------------------------------------------------</span>
    <span>def</span> <span>__init__</span><span>(</span><span>self</span>, url, name<span>)</span>:
        <span>""</span><span>"Initialize the thread"</span><span>""</span>
        Thread.<span>__init__</span><span>(</span><span>self</span><span>)</span>
        <span>self</span>.<span>name</span> = name
        <span>self</span>.<span>url</span> = url
 
    <span>#----------------------------------------------------------------------</span>
    <span>def</span> run<span>(</span><span>self</span><span>)</span>:
        <span>""</span><span>"Run the thread"</span><span>""</span>
        handle = <span>urllib2</span>.<span>urlopen</span><span>(</span><span>self</span>.<span>url</span><span>)</span>
        fname = <span>os</span>.<span>path</span>.<span>basename</span><span>(</span><span>self</span>.<span>url</span><span>)</span>
        with <span>open</span><span>(</span>fname, <span>"wb"</span><span>)</span> as f_handler:
            <span>while</span> <span>True</span>:
                <span>chunk</span> = handle.<span>read</span><span>(</span><span>1024</span><span>)</span>
                <span>if</span> <span>not</span> <span>chunk</span>:
                    <span>break</span>
                f_handler.<span>write</span><span>(</span><span>chunk</span><span>)</span>
        msg = <span>"%s has finished downloading %s!"</span> <span>%</span> <span>(</span><span>self</span>.<span>name</span>,
                                                   <span>self</span>.<span>url</span><span>)</span>
        <span>print</span><span>(</span>msg<span>)</span>
 
<span>#----------------------------------------------------------------------</span>
<span>def</span> main<span>(</span>urls<span>)</span>:
    <span>""</span><span>"
    Run the program
    "</span><span>""</span>
    <span>for</span> item, url <span>in</span> <span>enumerate</span><span>(</span>urls<span>)</span>:
        name = <span>"Thread %s"</span> <span>%</span> <span>(</span>item<span>+1</span><span>)</span>
        <span>thread</span> = DownloadThread<span>(</span>url, name<span>)</span>
        <span>thread</span>.<span>start</span><span>(</span><span>)</span>
 
<span>if</span> __name__ == <span>"__main__"</span>:
    urls = <span>[</span><span>"http://www.irs.gov/pub/irs-pdf/f1040.pdf"</span>,
            <span>"http://www.irs.gov/pub/irs-pdf/f1040a.pdf"</span>,
            <span>"http://www.irs.gov/pub/irs-pdf/f1040ez.pdf"</span>,
            <span>"http://www.irs.gov/pub/irs-pdf/f1040es.pdf"</span>,
            <span>"http://www.irs.gov/pub/irs-pdf/f1040sb.pdf"</span><span>]</span>
    main<span>(</span>urls<span>)</span></pre>
<p>This is basically a complete rewrite of the first script. In this one we import the os and urllib2 modules as well as the threading module. We will be using urllib2 to do the actual downloading inside the thread class. The os module is used to extracting the name of the file we’re downloading so we can use it to create a file with the same name on our machine. In the DownloadThread class, we set up the __init__ to accept a url and a name for the thread. In the run method, we open up the url, extract the filename and then use that filename for naming / creating the file on disk. Then we use a <strong>while</strong> loop to download the file a kilobyte at a time and write it to disk. Once the file is finished saving, we print out the name of the thread and which url has finished downloading. </p>
<p><strong>Update:</strong></p>
<p>Python 3’s version of the code is slightly different. You have to import <strong>urllib</strong> instead and use <strong>urllib.request.urlopen</strong> instead of <strong>urllib2.urlopen</strong>. Here’s the Python 3 version:</p>
<pre class="python"><span># Use this version for Python 3</span>
<span>import</span> <span>os</span>
<span>import</span> <span>urllib</span>.<span>request</span>
 
<span>from</span> <span>threading</span> <span>import</span> Thread
 
<span>########################################################################</span>
<span>class</span> DownloadThread<span>(</span>Thread<span>)</span>:
    <span>""</span><span>"
    A threading example that can download a file
    "</span><span>""</span>
 
    <span>#----------------------------------------------------------------------</span>
    <span>def</span> <span>__init__</span><span>(</span><span>self</span>, url, name<span>)</span>:
        <span>""</span><span>"Initialize the thread"</span><span>""</span>
        Thread.<span>__init__</span><span>(</span><span>self</span><span>)</span>
        <span>self</span>.<span>name</span> = name
        <span>self</span>.<span>url</span> = url
 
    <span>#----------------------------------------------------------------------</span>
    <span>def</span> run<span>(</span><span>self</span><span>)</span>:
        <span>""</span><span>"Run the thread"</span><span>""</span>
        handle = <span>urllib</span>.<span>request</span>.<span>urlopen</span><span>(</span><span>self</span>.<span>url</span><span>)</span>
        fname = <span>os</span>.<span>path</span>.<span>basename</span><span>(</span><span>self</span>.<span>url</span><span>)</span>
        with <span>open</span><span>(</span>fname, <span>"wb"</span><span>)</span> as f_handler:
            <span>while</span> <span>True</span>:
                <span>chunk</span> = handle.<span>read</span><span>(</span><span>1024</span><span>)</span>
                <span>if</span> <span>not</span> <span>chunk</span>:
                    <span>break</span>
                f_handler.<span>write</span><span>(</span><span>chunk</span><span>)</span>
        msg = <span>"%s has finished downloading %s!"</span> <span>%</span> <span>(</span><span>self</span>.<span>name</span>,
                                                   <span>self</span>.<span>url</span><span>)</span>
        <span>print</span><span>(</span>msg<span>)</span>
 
<span>#----------------------------------------------------------------------</span>
<span>def</span> main<span>(</span>urls<span>)</span>:
    <span>""</span><span>"
    Run the program
    "</span><span>""</span>
    <span>for</span> item, url <span>in</span> <span>enumerate</span><span>(</span>urls<span>)</span>:
        name = <span>"Thread %s"</span> <span>%</span> <span>(</span>item<span>+1</span><span>)</span>
        <span>thread</span> = DownloadThread<span>(</span>url, name<span>)</span>
        <span>thread</span>.<span>start</span><span>(</span><span>)</span>
 
<span>if</span> __name__ == <span>"__main__"</span>:
    urls = <span>[</span><span>"http://www.irs.gov/pub/irs-pdf/f1040.pdf"</span>,
            <span>"http://www.irs.gov/pub/irs-pdf/f1040a.pdf"</span>,
            <span>"http://www.irs.gov/pub/irs-pdf/f1040ez.pdf"</span>,
            <span>"http://www.irs.gov/pub/irs-pdf/f1040es.pdf"</span>,
            <span>"http://www.irs.gov/pub/irs-pdf/f1040sb.pdf"</span><span>]</span>
    main<span>(</span>urls<span>)</span></pre>
<hr/>
<h3>Wrapping Up</h3>
<p>
</p><p>Now you know how to use threads both in a theory and in a practical way. Threads are especially useful when you are creating a user interface and you want to keep your interface usable. Without threads, the user interface would become unresponsive and would appear to hang while you did a large file download or a big query against a database. To keep that from happening, you do the long running processes in threads and then communicate back to your interface when you are done.</p>
<hr/>
<h3>Related Reading</h3>
<p>
</p>
</div>	</div></body></html>