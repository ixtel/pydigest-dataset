<html><body><div><div class="entry-content">
		<p>One of the less known features introduced in TurboGears 2.3 are <a href="http://turbogears.readthedocs.org/en/latest/turbogears/hooks.html#application-wrappers">application wrappers</a>.<br/>
Application wrappers are much like <a href="http://turbogears.readthedocs.org/en/latest/turbogears/hooks.html#controller-wrappers">controller wrappers</a> (available since 2.2), but instead of wrapping controllers they actually wrap the whole application providing an easier way to implement what in plain WSGI is done through middlewares.</p>
<p>The advantage of application wrappers over middlewares is that they have full access to TurboGears stack, they can access the current request, the database, session and caches as the application itself would do.</p>
<p>The great part is that, as they run between TGApp and TGController, they can also replace the <strong>TurboGears Context</strong> and the <strong>TurboGears Response</strong> providing a great way to hijack requests, responses or even replace entire features of the framework like the cache layer. A very similar concept is available in other frameworks like Pyramid Tweens.</p>
<p>A very simple application wrapper that intercepts exceptions and logs them without messing with the standard TurboGears error handling might look like:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python"><span>class</span> ErrorLoggingWrapper<span>(</span><span>object</span><span>)</span>:
    <span>def</span> <span>__init__</span><span>(</span><span>self</span><span>,</span> handler<span>,</span> config<span>)</span>:
        <span>self</span>.<span>handler</span> <span>=</span> handler
        <span>self</span>.<span>config</span> <span>=</span> config
 
    <span>def</span> <span>__call__</span><span>(</span><span>self</span><span>,</span> controller<span>,</span> environ<span>,</span> context<span>)</span>:
        path <span>=</span> context.<span>request</span>.<span>path</span>
        <span>try</span>:
            <span>return</span> <span>self</span>.<span>handler</span><span>(</span>controller<span>,</span> environ<span>,</span> context<span>)</span>
        <span>except</span>:
            log.<span>exception</span><span>(</span><span>'Error while handling %s'</span><span>,</span> path<span>)</span>
            <span>raise</span></pre></td></tr></table></div>

<p>The wrapper can then be enabled calling</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python">base_config.<span>register_wrapper</span><span>(</span>ErrorLoggingWrapper<span>)</span></pre></td></tr></table></div>

<p> inside <strong>config/app_cfg.py</strong></p>
<p>Now that we have an application wrapper able to log exceptions we can decide for example to add another one that suppresses exceptions and prints “Something went wrong!”, as it is possible to specify the order of execution for application wrappers we can register a SuppressErrorsWrapper that should execute after the <strong>ErrorLoggingWrapper</strong>:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python"><span>from</span> webob <span>import</span> Response
 
<span>class</span> SuppressErrorsWrapper<span>(</span><span>object</span><span>)</span>:
    <span>def</span> <span>__init__</span><span>(</span><span>self</span><span>,</span> handler<span>,</span> config<span>)</span>:
        <span>self</span>.<span>handler</span> <span>=</span> handler
        <span>self</span>.<span>config</span> <span>=</span> config
 
    <span>def</span> <span>__call__</span><span>(</span><span>self</span><span>,</span> controller<span>,</span> environ<span>,</span> context<span>)</span>:
        <span>try</span>:
            <span>return</span> <span>self</span>.<span>handler</span><span>(</span>controller<span>,</span> environ<span>,</span> context<span>)</span>
        <span>except</span>:
            <span>return</span> Response<span>(</span><span>'Oh! Oh! Something went wrong!'</span><span>,</span> status<span>=</span><span>500</span><span>,</span> content_type<span>=</span><span>'text/plain'</span><span>)</span></pre></td></tr></table></div>

<p>Then it can be registered after the ErrorLoggingWrapper using:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python">base_config.<span>register_wrapper</span><span>(</span>SuppressErrorsWrapper<span>,</span> after<span>=</span>ErrorLoggingWrapper<span>)</span></pre></td></tr></table></div>

<p>While applications wrappers are a powerful feature, most of their power comes from the new response management refactoring that makes possible to access the current context and replace the outgoing response while working with high level objects instead of having to manually cope with WSGI.</p>
			</div>

	</div></body></html>