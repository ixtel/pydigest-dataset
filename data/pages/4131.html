<html><body><div><div class="pf-content"><p>I recently took on a project where I needed to graph some data on a webpage using data I had queried from a database. Since I love Python, I decided to use it to accomplish this task. I went with <a href="http://flask.pocoo.org/" target="_blank">Flask</a> for serving the webpage and <a href="http://pygal.org/" target="_blank">pygal</a> for creating the graphs. In this tutorial, I will show you how to do that too, but without the database logic. Instead, we’ll get weather data from the Weather Underground and graph that. Let’s get started!</p>
<p><span id="more-4743"/></p>
<hr/>
<h3>Getting Started</h3>
<p>
</p><p>To follow along with this tutorial, you will need to install Flask and pygal. Here’s how:</p>
<p><code><br/>
pip install Flask, pygal<br/>
</code></p>
<p>If you don’t want to install Flask and all its dependencies onto your system Python, you should create a virtualenv, activate it and install these packages there.</p>
<hr/>
<h3>Creating Simple Graphs in Flask</h3>
<p>
</p><p><a href="http://www.blog.pythonlibrary.org/wp-content/uploads/2015/04/bar_chart.png"><img src="http://www.blog.pythonlibrary.org/wp-content/uploads/2015/04/bar_chart-300x150.png" alt="bar_chart" class="aligncenter size-medium wp-image-4769" srcset="http://www.blog.pythonlibrary.org/wp-content/uploads/2015/04/bar_chart-300x150.png 300w, http://www.blog.pythonlibrary.org/wp-content/uploads/2015/04/bar_chart-1024x512.png 1024w, http://www.blog.pythonlibrary.org/wp-content/uploads/2015/04/bar_chart-150x75.png 150w, http://www.blog.pythonlibrary.org/wp-content/uploads/2015/04/bar_chart.png 1200w" sizes="(max-width: 300px) 100vw, 300px"/></a></p>
<p>Creating graphs with pygal is a breeze. But before we can do that, we need some data! I decided to grab some data from the Weather Underground site. You will need to sign up with them to get an API key so you can query too. Once you have that, you can use the code below:</p>
<pre class="python"><span>import</span> pygal
<span>import</span> json
<span>from</span> <span>urllib2</span> <span>import</span> urlopen  <span># python 2 syntax</span>
<span># from urllib.request import urlopen # python 3 syntax</span>
 
 
<span>from</span> flask <span>import</span> Flask
<span>from</span> pygal.<span>style</span> <span>import</span> DarkSolarizedStyle
 
app = Flask<span>(</span>__name__<span>)</span>
 
<span>#----------------------------------------------------------------------</span>
@app.<span>route</span><span>(</span><span>'/'</span><span>)</span>
<span>def</span> get_weather_data<span>(</span>date=<span>'20140415'</span>, state=<span>'IA'</span>, city=<span>'Ames'</span><span>)</span>:
    <span>""</span><span>"
    Date must be in YYYYMMDD
    "</span><span>""</span>
    api_key = <span>'API_KEY'</span>
    url = <span>'http://api.wunderground.com/api/{key}/history_{date}/q/{state}/{city}.json'</span>
    new_url = url.<span>format</span><span>(</span>key=api_key,
                         date=date,
                         state=state,
                         city=city<span>)</span>
    result = urlopen<span>(</span>new_url<span>)</span>
    js_string = result.<span>read</span><span>(</span><span>)</span>
    parsed = json.<span>loads</span><span>(</span>js_string<span>)</span>
    history = parsed<span>[</span><span>'history'</span><span>]</span><span>[</span><span>'observations'</span><span>]</span>
 
    imp_temps = <span>[</span><span>float</span><span>(</span>i<span>[</span><span>'tempi'</span><span>]</span><span>)</span> <span>for</span> i <span>in</span> history<span>]</span>
    times = <span>[</span><span>'%s:%s'</span> <span>%</span> <span>(</span>i<span>[</span><span>'utcdate'</span><span>]</span><span>[</span><span>'hour'</span><span>]</span>, i<span>[</span><span>'utcdate'</span><span>]</span><span>[</span><span>'min'</span><span>]</span><span>)</span> <span>for</span> i <span>in</span> history<span>]</span>
 
    <span># create a bar chart</span>
    title = <span>'Temps for %s, %s on %s'</span> <span>%</span> <span>(</span>city, state, date<span>)</span>
    bar_chart = pygal.<span>Bar</span><span>(</span>width=<span>1200</span>, height=<span>600</span>,
                          explicit_size=<span>True</span>, title=title, style=DarkSolarizedStyle<span>)</span>
    <span>#bar_chart = pygal.StackedLine(width=1200, height=600,</span>
    <span>#                      explicit_size=True, title=title, fill=True)</span>
 
    bar_chart.<span>x_labels</span> = times
    bar_chart.<span>add</span><span>(</span><span>'Temps in F'</span>, imp_temps<span>)</span>
 
    html = <span>""</span><span>"
        &lt;html&gt;
             &lt;head&gt;
                  &lt;title&gt;%s&lt;/title&gt;
             &lt;/head&gt;
              &lt;body&gt;
                 %s
             &lt;/body&gt;
        &lt;/html&gt;
        "</span><span>""</span> <span>%</span> <span>(</span>title, bar_chart.<span>render</span><span>(</span><span>)</span><span>)</span>
    <span>return</span> html
 
 
<span>#----------------------------------------------------------------------</span>
<span>if</span> __name__ == <span>'__main__'</span>:    
    app.<span>run</span><span>(</span><span>)</span></pre>
<p>Let’s break this down a bit. The main part we want to look at is the <strong>get_weather_data</strong> function. It has a decorator <strong>@app.route(‘/’)</strong> that tells Flask to call this function if we go to the home page of the website. The home page in this case would be <strong>http://localhost:5000/</strong>. Next we have our Weather Underground API key and the URL we want to use. In this case, I am grabbing historical data. You can use a slightly different URL to query for current weather. After that, we open our URL, read it and parse the JSON it returns. Finally we pull out the temperatures in Imperial format along with the hours of the day that they were recorded.</p>
<p>Now that we have our data, we can create our graph! We’ll start by creating a bar chart. Here I set the size of the bar chart as otherwise it will end up being quite large. Then we set its X labels and add the data to the chart. Finally we create the HTML to display and call Pygal’s <strong>render</strong> method, which returns an SVG in XML. You can call other rendering methods that will return other types too. </p>
<p>If you want to try out one of the many other charts that Pygal provides, comment out the call lines that instantiate the bar chart and uncomment out the lines for the StackedLine graph. Then re-run the script. You should end up with a graph that looks like this:</p>
<p><a href="http://www.blog.pythonlibrary.org/wp-content/uploads/2015/04/line_chart.png"><img src="http://www.blog.pythonlibrary.org/wp-content/uploads/2015/04/line_chart-300x150.png" alt="line_chart" class="aligncenter size-medium wp-image-4770" srcset="http://www.blog.pythonlibrary.org/wp-content/uploads/2015/04/line_chart-300x150.png 300w, http://www.blog.pythonlibrary.org/wp-content/uploads/2015/04/line_chart-1024x513.png 1024w, http://www.blog.pythonlibrary.org/wp-content/uploads/2015/04/line_chart-150x75.png 150w, http://www.blog.pythonlibrary.org/wp-content/uploads/2015/04/line_chart.png 1201w" sizes="(max-width: 300px) 100vw, 300px"/></a></p>
<hr/>
<h3>Using a Template to Display the Graph</h3>
<p>
</p><p>Most of the time, you’ll want to use a template when you’re using Flask. The templates that Flask are created using <a href="http://jinja.pocoo.org/docs/dev/" target="_blank">Jinja</a>. You will need to create a <strong>templates</strong> folder in the same directory where you saved the Python code above. In it, you will need to put the following HTML code:</p>
<pre class="html4strict"><span><a href="http://december.com/html/4/element/html.html"><span>&lt;html&gt;</span></a></span>
    <span><a href="http://december.com/html/4/element/head.html"><span>&lt;head&gt;</span></a></span>
        <span><a href="http://december.com/html/4/element/title.html"><span>&lt;title&gt;</span></a></span>{{ title }}<span><span>&lt;/title&gt;</span></span>
    <span><a href="http://december.com/html/4/element/script.html"><span>&lt;script</span></a> <span>type</span><span>=</span><span>"text/javascript"</span> <span>src</span><span>=</span><span>"http://kozea.github.com/pygal.js/javascripts/svg.jquery.js"</span><span>&gt;</span></span><span><span>&lt;/script&gt;</span></span>
    <span><a href="http://december.com/html/4/element/script.html"><span>&lt;script</span></a> <span>type</span><span>=</span><span>"text/javascript"</span> <span>src</span><span>=</span><span>"http://kozea.github.com/pygal.js/javascripts/pygal-tooltips.js"</span><span>&gt;</span></span><span><span>&lt;/script&gt;</span></span>
    <span><span>&lt;/head&gt;</span></span>
    <span><a href="http://december.com/html/4/element/body.html"><span>&lt;body&gt;</span></a></span>
            {{ bar_chart.render()|safe }}
    <span><span>&lt;/body&gt;</span></span>
<span><span>&lt;/html&gt;</span></span></pre>
<p>You will note that we need to tell Jinja that rendered SVG XML is safe. Otherwise it will try to escape the XML and you’ll end up with some really weird looking output. We also need to change our Python code to render the template. Let’s do that now:</p>
<pre class="python"><span>import</span> pygal
<span>import</span> json
<span>from</span> <span>urllib2</span> <span>import</span> urlopen  <span># python 2 syntax</span>
<span># from urllib.request import urlopen # python 3 syntax</span>
 
<span>from</span> flask <span>import</span> Flask, render_template
<span>from</span> pygal.<span>style</span> <span>import</span> DarkSolarizedStyle
 
app = Flask<span>(</span>__name__<span>)</span>
 
<span>#----------------------------------------------------------------------</span>
@app.<span>route</span><span>(</span><span>'/'</span><span>)</span>
<span>def</span> get_weather_data<span>(</span>date=<span>'20140415'</span>, state=<span>'IA'</span>, city=<span>'Ames'</span><span>)</span>:
    <span>""</span><span>"
    Date must be in YYYYMMDD
    "</span><span>""</span>
    api_key = <span>'API_KEY'</span>
    url = <span>'http://api.wunderground.com/api/{key}/history_{date}/q/{state}/{city}.json'</span>
    new_url = url.<span>format</span><span>(</span>key=api_key,
                         date=date,
                         state=state,
                         city=city<span>)</span>
    result = urlopen<span>(</span>new_url<span>)</span>
    js_string = result.<span>read</span><span>(</span><span>)</span>
    parsed = json.<span>loads</span><span>(</span>js_string<span>)</span>
    history = parsed<span>[</span><span>'history'</span><span>]</span><span>[</span><span>'observations'</span><span>]</span>
 
    imp_temps = <span>[</span><span>float</span><span>(</span>i<span>[</span><span>'tempi'</span><span>]</span><span>)</span> <span>for</span> i <span>in</span> history<span>]</span>
    times = <span>[</span><span>'%s:%s'</span> <span>%</span> <span>(</span>i<span>[</span><span>'utcdate'</span><span>]</span><span>[</span><span>'hour'</span><span>]</span>, i<span>[</span><span>'utcdate'</span><span>]</span><span>[</span><span>'min'</span><span>]</span><span>)</span> <span>for</span> i <span>in</span> history<span>]</span>
 
    <span># create a bar chart</span>
    title = <span>'Temps for %s, %s on %s'</span> <span>%</span> <span>(</span>city, state, date<span>)</span>
    bar_chart = pygal.<span>Bar</span><span>(</span>width=<span>1200</span>, height=<span>600</span>,
                          explicit_size=<span>True</span>, title=title,
                          style=DarkSolarizedStyle,
                          disable_xml_declaration=<span>True</span><span>)</span>
    bar_chart.<span>x_labels</span> = times
    bar_chart.<span>add</span><span>(</span><span>'Temps in F'</span>, imp_temps<span>)</span>
 
    <span>return</span> render_template<span>(</span><span>'index.html'</span>, 
                           title=title,
                           bar_chart=bar_chart<span>)</span>
 
 
<span>#----------------------------------------------------------------------</span>
<span>if</span> __name__ == <span>'__main__'</span>:
    app.<span>run</span><span>(</span><span>)</span></pre>
<p>You will note that we imported the <strong>render_template</strong> function and that we use that to load the template. We also need to tell PyGal to disable xml declaration. If we don’t, then we’ll get some unicode decoding errors. Anyway, give this code a try and you should have the same graph as before.</p>
<hr/>
<h3>Wrapping Up</h3>
<p>
</p><p>At this point, you should be able to create your own graphs using Flask and Pygal. I recommend checking out Pygal’s documentation so you can see the many other types of graphs it can do. It also has a lot of fun styles that you can apply to your graphs. You will also want to check out Flask’s documentation to learn how to add CSS and other niceties. Have fun!</p>
<hr/>
<h3>Further Reading</h3>
<p>
</p>
</div>	</div></body></html>