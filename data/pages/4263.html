<html><body><div><div class="span8 article-content">

            
            
<p>Almost 18 months have passed since I <a class="reference external" href="http://www.mos6581.org/introducing-rinohtype">announced RinohType</a>, so it’s about time for a little status update. Inspired by some of the comments on the last blog article, I decided to focus on <a class="reference external" href="http://docutils.sourceforge.net/rst.html">reStructuredText</a> support, as this would make RinohType much more useful to many people. The changes required to fully support reStructuredText also led to may other improvements in RinohType. Additionally, the style sheet system has received some important updates. The changes are summarized below.</p>
<p>Last year, I submitted a talk proposal to EuroPython which was unfortunately rejected. From the reviewers’ comments I understood that the proposal could not be accepted without the availability of a RinohType release. For EuroPython 2015, I submitted a new proposal, now accompanied with a <a class="reference external" href="https://pypi.python.org/pypi/RinohType/0.1.1">first RinohType release</a>. This release includes a command-line to tool to render reStructuredText files and a Sphinx builder. You are welcome to give it a spin and send me feedback. Expect to encounter many bugs, however. Please find more details in the description on PyPI.</p>
<div class="section" id="restructuredtext-and-sphinx">

<p>RinohType now has fairly complete support for <a class="reference external" href="http://docutils.sourceforge.net/rst.html">reStructuredText</a>. Armed with <a class="reference external" href="http://docutils.sourceforge.net/docs/user/rst/demo.txt">demo.txt</a>, I set out to interpret and render all remaining reStructuredText doctree elements: field/option lists, hyperlinks, problematic nodes (text color), compound paragraphs, sidebar, inline images, figures, citations and tables. While all reStructured directives  should now be supported, the various options that can be passed to the them might be not be.</p>
<p>reStructuredText’s ability to nest document elements uncovered the fact that many of my document building blocks were built under much simpler assumptions. For example, a table cell can now contain any other element such as a list or even another table, where before it could only contain text. The document building blocks in general are now much more capable and should be able to handle whatever reStructuredText supports at the least. The RinohType building blocks (so-called <em>flowables</em>) now also form a proper nested document tree, which is very useful when styling the document.</p>
<p>Table rendering code was rewritten completely to:</p>
<ul class="simple">
<li>accept any flowable as cell content instead of only text,</li>
<li>better fit the styling mechanism, and</li>
<li>be able to automatically size columns based on their content.</li>
</ul>
<p>A wonderful corollary of reStructuredText support is that it was fairly easy to create a Sphinx builder. I have already used it to render a small technical report for my freelance work. It does not yet support all custom reStructuredText directives added by Sphinx however, so it cannot yet render Sphinx’s documentation. Locally, I have it parsing the complete document tree, but it still fails rendering at some point, so you can expect this to work very soon. The builder is included in the release mentioned above. Instructions on how to use it can be found in the release’s package description on PyPI.</p>
</div>
<div class="section" id="pdf-backend">

<p>The <span class="caps">PDF</span> backend was extended to support some of the reStructuredText features; it can now output colored text and display interactive hyperlinks (but for some reason, they don’t all work in Apple Preview). Next to <span class="caps">PDF</span> images, bitmap images are now also supported when <a class="reference external" href="https://python-pillow.github.io">Pillow</a> is installed.</p>
<p>It is now also possible to copy selected text from the resulting <span class="caps">PDF</span> and not end up with gibberish when pasting. The problem with certain <span class="caps">PDF</span> readers (Firefox’s pdf.js and Evince) has not yet been resolved, however. I am fairly certain this is due a bug in the readers, but I might try to work around it.</p>
</div>
<div class="section" id="style-system">

<p>I also took some time to make fundamental improvements to the styling system. The new system is heavily inspired by <a class="reference external" href="https://en.wikipedia.org/wiki/Cascading_Style_Sheets"><span class="caps">CSS</span></a>, but adds some extra functionality that <span class="caps">CSS</span> lacks. The style sheets are currently specified in Python code (see examples below). I might provide a plain text alternative (<span class="caps">YAML</span>, <span class="caps">INI</span> or perhaps even <span class="caps">CSS</span>) in the future. The following illustrates the most important features of the style system without going into details.</p>
<div class="section" id="selectors">

<p>Very similar to <a class="reference external" href="https://en.wikipedia.org/wiki/Cascading_Style_Sheets#Selector"><span class="caps">CSS</span> selectors</a>, elements can be matched based on their context. For example, the following matches any paragraph that is a child of a list item.</p>

<p><tt class="docutils literal">ListItem</tt> and <tt class="docutils literal">Paragraph</tt> are both RinohType classes (<tt class="docutils literal">Flowable</tt> subclasses) that make up the document tree.</p>
<p>Similar to <span class="caps">HTML</span>/<span class="caps">CSS</span>’s ‘class’ attribute, a flowable can have a ‘style’ attribute which can be checked when constructing a selector. This selects all paragraphs of style ‘title’:</p>

<p>The <tt class="docutils literal">like</tt> method can also match arbitrary attributes of elements. This can be used to do more advanced things such as selecting the background objects on all odd rows of a table, limited to the cells not spanning multiple rows:</p>
<div class="highlight"><pre><span class="n">TableCell</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="n">row_index</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">TableCellBackground</span>
</pre></div>
<p><a class="reference external" href="https://docs.python.org/3.5/library/constants.html#Ellipsis">Python’s ellipsis</a> can be used to match any number of levels in the document tree. For example, the following matches any paragraph element at any level inside a table cell.</p>
<div class="highlight"><pre><span class="n">TableCell</span> <span class="o">/</span> <span class="o">...</span> <span class="o">/</span> <span class="n">Paragraph</span>
</pre></div>
<p>RinohType borrows <span class="caps">CSS</span>’s concept of <a class="reference external" href="https://en.wikipedia.org/wiki/Cascading_Style_Sheets#Specificity">specificity</a> to determine the "winning" selector when multiple selectors match a given document element.</p>
</div>
<div class="section" id="matchers-and-style-sheets">

<p>In contrast to <span class="caps">CSS</span>, RinohType’s style system has an extra layer of indirection so that the user does not have to redefine the selectors in each style sheet. A <tt class="docutils literal">StyledMatcher</tt> is basically a dictionary that maps descriptions to selectors.</p>
<div class="highlight"><pre><span class="n">matcher</span> <span class="o">=</span> <span class="n">StyledMatcher</span><span class="p">()</span>
<span class="o">...</span>
<span class="n">matcher</span><span class="p">(</span><span class="s">'emphasis'</span><span class="p">,</span> <span class="n">StyledText</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s">'emphasis'</span><span class="p">))</span>
<span class="n">matcher</span><span class="p">(</span><span class="s">'nested line block'</span><span class="p">,</span> <span class="n">GroupedFlowables</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s">'line block'</span><span class="p">)</span>
                             <span class="o">/</span> <span class="n">GroupedFlowables</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s">'line block'</span><span class="p">))</span>
<span class="o">...</span>
</pre></div>
<p>A single <tt class="docutils literal">StyledMatcher</tt> can serve multiple <tt class="docutils literal">StyleSheet</tt>s:</p>
<div class="highlight"><pre><span class="n">styles</span> <span class="o">=</span> <span class="n">StyleSheet</span><span class="p">(</span><span class="s">'IEEE'</span><span class="p">,</span> <span class="n">matcher</span><span class="o">=</span><span class="n">matcher</span><span class="p">)</span>
<span class="o">...</span>
<span class="n">styles</span><span class="p">(</span><span class="s">'emphasis'</span><span class="p">,</span> <span class="n">font_slant</span><span class="o">=</span><span class="n">ITALIC</span><span class="p">)</span>
<span class="n">styles</span><span class="p">(</span><span class="s">'nested line block'</span><span class="p">,</span> <span class="n">margin_left</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">CM</span><span class="p">)</span>
<span class="o">...</span>
</pre></div>
<p>One feature sorely missing from <span class="caps">CSS</span> is variables. Here’s an example of how variables can be specified and used in RinohType style sheets:</p>
<div class="highlight"><pre><span class="n">styles</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s">'ieee_family'</span><span class="p">]</span> <span class="o">=</span> <span class="n">TypeFamily</span><span class="p">(</span><span class="n">serif</span><span class="o">=</span><span class="n">times</span><span class="p">,</span>
                                             <span class="n">sans</span><span class="o">=</span><span class="n">helvetica</span><span class="p">,</span>
                                             <span class="n">mono</span><span class="o">=</span><span class="n">courier</span><span class="p">)</span>
<span class="o">...</span>
<span class="n">styles</span><span class="p">(</span><span class="s">'monospaced'</span><span class="p">,</span>
       <span class="n">typeface</span><span class="o">=</span><span class="n">Var</span><span class="p">(</span><span class="s">'ieee_family'</span><span class="p">)</span><span class="o">.</span><span class="n">mono</span><span class="p">,</span>
       <span class="n">font_size</span><span class="o">=</span><span class="mi">9</span><span class="o">*</span><span class="n">PT</span><span class="p">,</span>
       <span class="n">hyphenate</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
       <span class="n">ligatures</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="o">...</span>
</pre></div>
<p>Another stylesheet can inherit from this one and easily replace all fonts in the document by overriding the <tt class="docutils literal">ieee_family</tt> variable.</p>
<p>I doubt there will be a need to have many different matchers. The end user will likely never have to deal with them as most documents can use the default matcher. When custom flowables are used in a document, the default base matcher can be easily extended to style these.</p>
</div>
<div class="section" id="inheritance">

<p>Similar to <span class="caps">CSS</span>’s <a class="reference external" href="https://en.wikipedia.org/wiki/Cascading_Style_Sheets#Inheritance">inheritance</a>, <strong>text elements</strong> inherit properties from their parent. So for the example style sheet above, text with style <tt class="docutils literal">emphasis</tt> inherits the properties (such as <tt class="docutils literal">typeface</tt>, <tt class="docutils literal">font_weight</tt> and <tt class="docutils literal">font_size</tt>) from the paragraph it is a child of, but overrides the <tt class="docutils literal">font_slant</tt> property.</p>
<p>In addition, RinohType allows specifying a base style for each style. This avoids duplication of style information and the maintenance difficulties resulting from it.</p>
<div class="highlight"><pre><span class="n">styles</span><span class="p">(</span><span class="s">'heading level 1'</span><span class="p">,</span>
       <span class="n">typeface</span><span class="o">=</span><span class="n">Var</span><span class="p">(</span><span class="s">'ieee_family'</span><span class="p">)</span><span class="o">.</span><span class="n">serif</span><span class="p">,</span>
       <span class="n">font_weight</span><span class="o">=</span><span class="n">REGULAR</span><span class="p">,</span>
       <span class="n">font_size</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">PT</span><span class="p">,</span>
       <span class="n">small_caps</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
       <span class="n">justify</span><span class="o">=</span><span class="n">CENTER</span><span class="p">,</span>
       <span class="n">line_spacing</span><span class="o">=</span><span class="n">FixedSpacing</span><span class="p">(</span><span class="mi">12</span><span class="o">*</span><span class="n">PT</span><span class="p">),</span>
       <span class="n">space_above</span><span class="o">=</span><span class="mi">18</span><span class="o">*</span><span class="n">PT</span><span class="p">,</span>
       <span class="n">space_below</span><span class="o">=</span><span class="mi">6</span><span class="o">*</span><span class="n">PT</span><span class="p">,</span>
       <span class="n">number_format</span><span class="o">=</span><span class="n">ROMAN_UC</span><span class="p">,</span>
       <span class="n">label_suffix</span><span class="o">=</span><span class="s">'.'</span> <span class="o">+</span> <span class="n">FixedWidthSpace</span><span class="p">())</span>

<span class="n">styles</span><span class="p">(</span><span class="s">'unnumbered heading level 1'</span><span class="p">,</span>
       <span class="n">base</span><span class="o">=</span><span class="s">'heading level 1'</span><span class="p">,</span>
       <span class="n">number_format</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="performance">

<p>Shortly after posting the first blog article on RinohType, I’ve focused on speeding up document processing. Appareantly I managed to <a class="reference external" href="https://twitter.com/brechtmachiels/status/401322293928161280">almost halve rendering time</a> by refactoring the code and adding more memoization.</p>
<p>The next step was to speed up the slowest code by compiling to a fast C module using <strong>Cython</strong> and static type declarations. Unfortunately, there was no single part of the code where most of the time was spent, as these were repeatedly removed during refactoring for speed earlier. And even when cythonizing some parts, they didn’t result in a significant performance boost. I believe this is due to the fact that there’s not much number crunching going on as in the typical applications benefitting from Cython. In RinohType, I suspect container (dict, list) access operations to be the most common.</p>
<p>Next stop: <strong>PyPy</strong>. Hoping for a no-effort instant speedup, instead both <a class="reference external" href="https://mail.python.org/pipermail/pypy-dev/2014-February/012182.html">PyPy3</a> and <a class="reference external" href="https://mail.python.org/pipermail/pypy-dev/2014-March/012284.html">PyPy2</a> were much <strong>slower</strong> than CPython! As for Cython, I suppose this could be attributed to the fact that RinohType is not the typical use case for PyPy.</p>
<p>But the situation isn’t dramatic. RinohType is plenty fast on modern systems. The rendering time shouldn’t be a problem unless you’re rendering hundreds of pages. Once RinohType is more feature-complete and less buggy, I might revisit performance tuning.</p>
</div>


            <section>
    <p id="post-share-links">
    Share on:
    <a href="http://twitter.com/home?status=RinohType%20update%3A%20reStructuredText%20and%20style%C2%A0sheets%20http%3A//www.mos6581.org/rinohtype_status_update_1" target="_blank" title="Share on Twitter">Twitter</a>
    ❄
    <a href="http://www.facebook.com/sharer/sharer.php?s=100&amp;p%5Burl%5D=http%3A//www.mos6581.org/rinohtype_status_update_1" target="_blank" title="Share on Facebook">Facebook</a>
    ❄
    <a href="https://plus.google.com/share?url=http%3A//www.mos6581.org/rinohtype_status_update_1" target="_blank" title="Share on Google Plus">Google+</a>
    ❄
    <a href="mailto:?subject=RinohType%20update%3A%20reStructuredText%20and%20style%C2%A0sheets&amp;body=http%3A//www.mos6581.org/rinohtype_status_update_1" target="_blank" title="Share via Email">Email</a>
    </p>
</section>

            <section>

</section>

            <hr/>
            <aside>
            <nav>
            
            </nav>
            </aside>
        </div>
        </div></body></html>