<html><body><div><div class="content">
      
        <h1 class="content-title">Encrypted SQLite Databases with Python and SQLCipher</h1>
      
      
      
  
  
  
    <p><a href="http://media.charlesleifer.com/blog/photos/p1414470640.98.png" title="photos/p1414470640.98.png"><img alt="photos/p1414470640.98.png" class="img-responsive" src="http://m.charlesleifer.com/t/800x-/blog/photos/p1414470640.98.png?key=J69k1cMHQMOAPaMflF-Rbw"/></a></p>
<p><a href="https://www.zetetic.net/sqlcipher">SQLCipher</a>, created by Zetetic, is an open-source library that provides transparent 256-bit AES encryption for your SQLite databases. SQLCipher is used by a large number of organizations, including Nasa, SalesForce, Xerox and more. The project is <a href="https://github.com/sqlcipher/sqlcipher">open-source</a> and BSD licensed. Best of all, there are open-source <a href="https://github.com/leapcode/pysqlcipher">python bindings</a>.</p>
<p>In this post, I'll show how to get started writing Python scripts that interact with encrypted SQLite databases. For users of the peewee ORM, I will demonstrate the usage of the <a href="http://docs.peewee-orm.com/en/latest/peewee/playhouse.html#sqlcipher-ext">sqlcipher playhouse module</a>. Finally, I'll show how to convert your existing SQLite databases into encrypted databases suitable for use with SQLCipher.</p>
<h2>Building SQLCipher</h2>
<p>Let's get started by cloning the most recent version of the SQLCipher library and installing it on our system.</p>
<div class="highlight"><pre><span class="gp">$</span> git clone https://github.com/sqlcipher/sqlcipher
<span class="gp">$</span> <span class="nb">cd</span> sqlcipher
</pre></div>
<p>To compile SQLCipher, we will link against OpenSSL's <code>libcrypto</code>, so make sure you have OpenSSL installed before proceeding. I've also specified that we want to enable the full-text search extension. For the adventurous, the SQLite documentation contains a comprehensive list of <a href="http://www.sqlite.org/compile.html">compile options</a>.</p>
<div class="highlight"><pre><span class="gp">$</span> ./configure <span class="se">\</span>
<span class="go">  --enable-tempstore=yes \</span>
<span class="go">  CFLAGS="-DSQLITE_HAS_CODEC -DSQLITE_ENABLE_FTS3 -DSQLITE_ENABLE_FTS3_PARENTHESIS" \</span>
<span class="go">  LDFLAGS="-lcrypto"</span>

<span class="gp">$</span> make
<span class="gp">$</span> sudo make install
</pre></div>
<p>You should now be able to fire up the sqlcipher shell, which by default is connected to an in-memory database:</p>
<div class="highlight"><pre><span class="gp">$</span> sqlcipher
<span class="go">SQLCipher version 3.8.6 2014-08-15 11:46:33</span>
<span class="go">Enter ".help" for instructions</span>
<span class="go">Enter SQL statements terminated with a ";"</span>
<span class="go">Connected to a transient in-memory database.</span>
<span class="go">Use ".open FILENAME" to reopen on a persistent database.</span>
<span class="go">sqlite&gt;</span>
</pre></div>
<h3>Kicking the tires on SQLCipher</h3>
<p>To create an encrypted database, we can use the SQLCipher shell, specifying a key using a special <code>PRAGMA</code> command:</p>
<div class="highlight"><pre><span class="gp">sqlite&gt; </span><span class="p">.</span><span class="k">open</span> <span class="n">testing</span><span class="p">.</span><span class="n">db</span>
<span class="gp">sqlite&gt; </span><span class="n">PRAGMA</span> <span class="k">key</span><span class="o">=</span><span class="s1">'testing'</span><span class="p">;</span>
<span class="gp">sqlite&gt; </span><span class="k">create</span> <span class="k">table</span> <span class="n">people</span> <span class="p">(</span><span class="n">name</span> <span class="nb">text</span> <span class="k">primary</span> <span class="k">key</span><span class="p">);</span>
<span class="gp">sqlite&gt; </span><span class="k">insert</span> <span class="k">into</span> <span class="n">people</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'charlie'</span><span class="p">),</span> <span class="p">(</span><span class="s1">'huey'</span><span class="p">);</span>
<span class="gp">sqlite&gt; </span><span class="p">.</span><span class="n">quit</span>
</pre></div>
<p>If we take a look at the data in <code>testing.db</code>, we'll find that it is completely garbled:</p>
<div class="highlight"><pre><span class="gp">$</span> hexdump -C testing.db
<span class="go">0000  04 37 1e 64 12 fb a2 0b  8d 88 2f 72 fd c6 4b e6  |.7.d....../r..K.|</span>
<span class="go">0010  7f 80 14 ec 74 68 83 00  e9 d2 4f 2e 80 5d 05 da  |....th....O..]..|</span>
<span class="go">0020  f0 44 f3 83 23 5e 29 e4  73 fc 29 1b 2d 6a 1d bc  |.D..#^).s.).-j..|</span>
<span class="go">0030  be 94 e6 12 6e 7a 28 32  15 cd 7b 1e a5 3c f7 52  |....nz(2..{..&lt;.R|</span>
<span class="go">0040  1a 51 37 40 28 70 3e fe  5d d9 0f 06 cc 76 4c 98  |.Q7@(p&gt;.]....vL.|</span>
<span class="go">...</span>
</pre></div>
<p>If we try to open the database using the normal SQLite client, or if we specify the incorrect key, the data will be unreadable:</p>
<div class="highlight"><pre><span class="go">$ sqlite3 testing.db</span>
<span class="go">SQLite version 3.8.7 2014-10-17 11:24:17</span>
<span class="go">Enter ".help" for usage hints.</span>
<span class="gp">sqlite&gt; </span><span class="p">.</span><span class="k">schema</span>
<span class="go">Error: file is encrypted or is not a database</span>
<span class="gp">sqlite&gt; </span><span class="p">.</span><span class="n">quit</span>

<span class="go">$ sqlcipher testing.db</span>
<span class="go">SQLCipher version 3.8.6 2014-08-15 11:46:33</span>
<span class="go">Enter ".help" for instructions</span>
<span class="go">Enter SQL statements terminated with a ";"</span>
<span class="gp">sqlite&gt; </span><span class="n">pragma</span> <span class="k">key</span><span class="o">=</span><span class="s1">'wrong'</span><span class="p">;</span>
<span class="gp">sqlite&gt; </span><span class="p">.</span><span class="k">schema</span>
<span class="go">Error: file is encrypted or is not a database</span>
</pre></div>
<p>SQLCipher supports a number of special commands besides <code>PRAGMA key</code>. For the full list, check out the <a href="https://www.zetetic.net/sqlcipher/sqlcipher-api">API documentation</a>.</p>
<h2>Building pysqlcipher</h2>
<p>Run the following commands to install the latest version of pysqlcipher globally on your system:</p>
<div class="highlight"><pre><span class="gp">$</span> git clone https://github.com/leapcode/pysqlcipher/
<span class="gp">$</span> <span class="nb">cd</span> pysqlcipher
<span class="gp">$</span> python setup.py build_sqlcipher  <span class="c1"># Build against the system libsqlcipher</span>
<span class="gp">$</span> sudo python setup.py install
</pre></div>
<p>If you are installing into a virtualenv, I would not necessarily recommend installing <code>pysqlcipher</code> using <code>pip</code>, simply because it may fetch the SQLCipher source from a <a href="https://github.com/leapcode/pysqlcipher/blob/f48f35dedc5e7e4ac11a3dc2c725f3e06f08f715/setup.py#L120-L121">different remote source</a>. The default installation will not link against your system sqlcipher, but will link against the downloaded amalgamation.</p>
<p>To install in a virtualenv <em>and</em> build against the system <code>libsqlcipher</code>, you can clone the source tree into your virtualenv and build there:</p>
<div class="highlight"><pre><span class="gp">$</span> <span class="nb">cd</span> my_env <span class="o">&amp;&amp;</span> <span class="nb">source</span> bin/activate
<span class="gp">$</span> git clone https://github.com/leapcode/pysqlcipher/
<span class="gp">$</span> <span class="nb">cd</span> pysqlcipher
<span class="gp">$</span> python setup.py build_sqlcipher
<span class="gp">$</span> python setup.py install
</pre></div>
<h3>Connecting to an encrypted database from Python</h3>
<p>Let's see how to use SQLCipher from a Python script. <code>pysqlcipher</code> implements the <a href="http://legacy.python.org/dev/peps/pep-0249/">db-api 2.0 spec</a>, so if you've worked with databases in Python before, you'll feel right at home.</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pysqlcipher</span> <span class="kn">import</span> <span class="n">dbapi2</span> <span class="k">as</span> <span class="n">sqlcipher</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span> <span class="o">=</span> <span class="n">sqlcipher</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">'testing.db'</span><span class="p">)</span>
</pre></div>
<p>In order to actually make queries, we need to specify a passphrase using the <code>PRAGMA key</code> statement. Additionally, we need to specify the key derivation iterations using <code>PRAGMA kdf_iter</code>, which has a default value of 64000.</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">executescript</span><span class="p">(</span><span class="s1">'pragma key="testing"; pragma kdf_iter=64000;'</span><span class="p">)</span>
<span class="go">&lt;pysqlcipher.dbapi2.Cursor object at 0x7f2a77be40a0&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">'select * from people;'</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="go">[(u'charlie',), (u'heuy',)]</span>
</pre></div>
<p>If we attempt to connect with the incorrect passphrase, we will receive a <code>DatabaseError</code>:</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span> <span class="o">=</span> <span class="n">sqlcipher</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">'testing.db'</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">'pragma key="wrong"'</span><span class="p">)</span>
<span class="go">&lt;pysqlcipher.dbapi2.Cursor object at 0x7f167ec2d0a0&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">'select * from people;'</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">"&lt;stdin&gt;"</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
<span class="gr">pysqlcipher.dbapi2.DatabaseError</span>: <span class="n">file is encrypted or is not a database</span>
</pre></div>
<h3>Using SQLCipher with Peewee ORM</h3>
<p>If you do not have <a href="http://docs.peewee-orm.com/">peewee</a> installed, feel free to install it now:</p>

<p>The peewee <a href="http://docs.peewee-orm.com/en/latest/peewee/playhouse.html#sqlcipher-ext">SQLCipher extension</a> allows you to use peewee with encrypted SQLite databases. To create an encrypted diary, we might write the following code:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">from</span> <span class="nn">playhouse.sqlcipher_ext</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">SqlCipherDatabase</span><span class="p">(</span><span class="s1">'diary.db'</span><span class="p">,</span> <span class="n">passphrase</span><span class="o">=</span><span class="s1">'my secret passphrase'</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Note</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">TextField</span><span class="p">()</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">DateTimeField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">db</span>
</pre></div>
<p>If the above code is in a model named <code>diary.py</code>, we can interact with it from the command-line in the following way:</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">diary</span> <span class="kn">import</span> <span class="n">Note</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Note</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">fail_silently</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Note</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s1">'Dear diary, today I had a good day!'</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Note</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s1">'Dear diary, huey threw up on the floor.'</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">note</span> <span class="ow">in</span> <span class="n">Note</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="n">note</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">note</span><span class="o">.</span><span class="n">content</span>
<span class="gp">...</span>
<span class="go">2014-10-27 21:05:58.488291 Dear diary, today I had a good day!</span>
<span class="go">2014-10-27 21:06:16.663230 Dear diary, huey threw up on the floor.</span>
</pre></div>
<p>Hard-coding the passphrase in your database might not be a good idea. To retrieve the passphrase at run-time, we can use the standard library <code>getpass</code> module to prompt the user:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">getpass</span>

<span class="kn">from</span> <span class="nn">playhouse.sqlcipher_ext</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">SqlCipherDatabase</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>  <span class="c1"># Defer initialization of the database.</span>

<span class="k">class</span> <span class="nc">Note</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">TextField</span><span class="p">()</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">DateTimeField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">db</span>

<span class="n">passphrase</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getpass</span><span class="p">(</span><span class="s1">'Enter the diary password: '</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="s1">'cipher.db'</span><span class="p">,</span> <span class="n">passphrase</span><span class="o">=</span><span class="n">passphrase</span><span class="p">)</span>
</pre></div>
<p>Alternatively you can use environment variables or look into a library like <a href="https://bitbucket.org/kang/python-keyring-lib/">python-keyring</a>.</p>
<h2>Encrypting an existing SQLite Database</h2>
<p>If, like me, you have some existing SQLite databases you wish to convert over to SQLCipher, the following commands should get you started. These commands, and other examples, can be found <a href="https://www.zetetic.net/sqlcipher/sqlcipher-api/#sqlcipher_export">in the SQLCipher documentation</a>:</p>
<div class="highlight"><pre><span class="go">$ sqlcipher plaintext.db</span>
<span class="gp">sqlite&gt; </span><span class="n">ATTACH</span> <span class="k">DATABASE</span> <span class="s1">'encrypted.db'</span> <span class="k">AS</span> <span class="k">encrypted</span> <span class="k">KEY</span> <span class="s1">'my password'</span><span class="p">;</span>
<span class="gp">sqlite&gt; </span><span class="k">SELECT</span> <span class="n">sqlcipher_export</span><span class="p">(</span><span class="s1">'encrypted'</span><span class="p">);</span>
<span class="gp">sqlite&gt; </span><span class="n">DETACH</span> <span class="k">DATABASE</span> <span class="k">encrypted</span><span class="p">;</span>
</pre></div>
<p>That's it! Now <code>encrypted.db</code> will contain an encrypted copy of the data in <code>plaintext.db</code>.</p>
<h3>Links</h3>
<p>Thanks for taking the time to read this post, I hope you found it interesting. If you'd like to read more, here are some links which you may find useful:</p>

  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  


<hr/>

  <p>Commenting has been closed, but please feel free to <a href="/contact/">contact me</a></p>


    </div>

    </div></body></html>