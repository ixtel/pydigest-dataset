<html><body><div><div class="entry clear">
								<p><a href="http://scrapy.org">Scrapy</a> is at the heart of <a href="http://scrapinghub.com">Scrapinghub</a>. We use this framework extensively and have accumulated a wide range of shortcuts to get around common problems. We’re launching a series to share these Scrapy tips with you so that you can get the most out of your daily workflow. Each post will feature two to three tips, so stay tuned.</p>
<p><img class=" size-full wp-image-1987 aligncenter" src="https://scrapinghub.files.wordpress.com/2016/01/scrapylogo.png?w=648" alt="scrapylogo"/></p>
<h2>Use Extruct to Extract Microdata from Websites</h2>
<p>I am sure each and every developer of web crawlers has had a reason to curse web developers who use messy layouts for their websites. Websites with no semantic markups and especially those based on HTML tables are the absolute worst. These types of websites make scraping much harder because there are little-to-no clues about what each element means. Sometimes you even have to trust that the order of the elements on each page will remain the same to grab the data you need.</p>
<p>Which is why we are so grateful for <a href="https://schema.org/" target="_blank">Schema.org</a>, a collaborative effort to bring semantic markup to the web. This project provides web developers with schemas to represent a range of different objects in their websites, including Person, Product, and Review, using any metadata format like <a href="http://www.w3.org/TR/microdata/" target="_blank">Microdata</a>, <a href="https://rdfa.info/" target="_blank">RDFa</a>, <a href="http://json-ld.org/" target="_blank">JSON-LD</a>, etc. It makes the job of search engines easier because they can extract useful information from websites without having to dig into the HTML structure of all the websites they crawl.</p>
<p>For example, <a href="https://schema.org/AggregateRating" target="_blank">AggregateRating</a> is a schema used by online retailers to represent user ratings for their products. Here’s the markup that describes user ratings for a product in an online store using the <a href="http://www.w3.org/TR/microdata/" target="_blank">Microdata format</a>:</p>
<pre><span>&lt;</span><span>div</span> <span>itemprop</span><span>=</span><span>"aggregateRating"</span><span> itemscope</span><span>=</span><span>""</span><span> itemtype</span><span>=</span><span>"http://schema.org/AggregateRating"</span><span>&gt;</span>
    <span>&lt;</span><span>meta</span><span> itemprop</span><span>=</span><span>"worstRating"</span> <span>content</span><span>=</span><span>"1"</span><span>&gt;</span>
    <span>&lt;</span><span>meta</span><span> itemprop</span><span>=</span><span>"bestRating"</span> <span>content</span><span>=</span><span>"5"</span><span>&gt;</span>
    <span>&lt;</span><span>div</span> <span>class</span><span>=</span><span>"bbystars-small-yellow"</span><span>&gt;</span>
        <span>&lt;</span><span>div</span> <span>class</span><span>=</span><span>"fill"</span> <span>style</span><span>=</span><span>"</span><span>width</span><span>:</span> <span>88</span><span>%</span><span>"</span><span>&gt;</span><span>&lt;/</span><span>div</span><span>&gt;</span>
    <span>&lt;/</span><span>div</span><span>&gt;</span>
    <span>&lt;</span><span>span</span> <span>itemprop</span><span>=</span><span>"ratingValue"</span><span> aria-</span><span>label</span><span>=</span><span>"4.4 out of 5 stars"</span><span>&gt;</span><span>4.4</span><span>&lt;/</span><span>span</span><span>&gt;</span>
    <span>&lt;</span><span>meta</span><span> itemprop</span><span>=</span><span>"reviewCount"</span> <span>content</span><span>=</span><span>"305733"</span><span>&gt;</span>
<span>&lt;/</span><span>div</span><span>&gt;</span>
</pre>
<p>This way, search engines can show the ratings for a product alongside the URL in the search results, with no need to write specific spiders for each website:</p>
<p><img class="size-full wp-image-1910 aligncenter" src="https://scrapinghub.files.wordpress.com/2016/01/selection_096.png?w=648" alt="Example of a google search showing ratings for a product"/></p>
<p>You can also benefit from the semantic markup that some websites use. We recommend you to use <a href="https://github.com/scrapinghub/extruct" target="_blank">Extruct</a>, a library to extract <a href="https://blog.scrapinghub.com/2014/06/18/extracting-schema-org-microdata-using-scrapy-selectors-and-xpath/" target="_blank">embedded metadata</a> from HTML documents. It parses the whole HTML and returns the microdata items in a python dictionary. Take a look at how we used it to extract microdata showing user ratings:</p>
<pre><span>&gt;&gt;</span><span>&gt;</span> <span>from</span> extruct<span>.</span>w3cmicrodata <span>import</span> MicrodataExtractor
<span>&gt;&gt;</span><span>&gt;</span> mde <span>=</span> MicrodataExtractor<span>(</span><span>)</span>
<span>&gt;&gt;</span><span>&gt;</span> data <span>=</span> mde<span>.</span>extract<span>(</span>html_content<span>)</span>
<span>&gt;&gt;</span><span>&gt;</span> data
<span>{</span>
  <span>'items'</span><span>:</span> <span>[</span>
    <span>{</span>
      <span>'type'</span><span>:</span> <span>'http://schema.org/AggregateRating'</span><span>,</span>
      <span>'properties'</span><span>:</span> <span>{</span>
        <span>'reviewCount'</span><span>:</span> <span>'305733'</span><span>,</span>
        <span>'bestRating'</span><span>:</span> <span>'5'</span><span>,</span>
        <span>'ratingValue'</span><span>:</span> <span>u'4.4'</span><span>,</span>
        <span>'worstRating'</span><span>:</span> <span>'1'</span>
      <span>}</span>
    <span>}</span>
  <span>]</span>
<span>}</span>
<span>&gt;&gt;</span><span>&gt;</span> data<span>[</span><span>'items'</span><span>]</span><span>[</span><span>0</span><span>]</span><span>[</span><span>'properties'</span><span>]</span><span>[</span><span>'ratingValue'</span><span>]</span>
<span>u'4.4'</span></pre>
<p>Now, let’s build a spider using Extruct to extract prices and ratings from the <a href="http://www.apple.com/shop/mac/mac-accessories" target="_blank">Apple products website</a>. This website uses microdata to store information about the products listed. It uses this structure for each of the products:</p>
<pre><span>&lt;</span><span>div</span><span> itemtype</span><span>=</span><span>"http://schema.org/Product"</span><span> itemscope</span><span>=</span><span>"itemscope"</span><span>&gt;</span>
  <span>&lt;</span><span>img</span> <span>src</span><span>=</span><span>"/images/MLA02.jpg"</span><span> itemprop</span><span>=</span><span>"image"</span> <span>/&gt;</span>
  <span>&lt;</span><span>a</span> <span>href</span><span>=</span><span>"/shop/product/MLA02/magic-mouse-2?"</span><span> itemprop</span><span>=</span><span>"url"</span><span>&gt;</span>
    <span>&lt;</span><span>span</span><span> itemprop</span><span>=</span><span>"name"</span><span>&gt;</span>Magic Mouse <span>2</span><span>&lt;/</span><span>span</span><span>&gt;</span>
  <span>&lt;/</span><span>a</span><span>&gt;</span>
  <span>&lt;</span><span>div</span> <span>class</span><span>=</span><span>"as-pinwheel-info"</span><span>&gt;</span>
    <span>&lt;</span><span>div</span><span> itemprop</span><span>=</span><span>"offers"</span><span> itemtype</span><span>=</span><span>"http://schema.org/Offer"</span><span> itemscope</span><span>=</span><span>"itemscope"</span><span>&gt;</span>
      <span>&lt;</span><span>meta</span><span> itemprop</span><span>=</span><span>"priceCurrency"</span> <span>content</span><span>=</span><span>"USD"</span><span>&gt;</span>
      <span>&lt;</span><span>span</span> <span>class</span><span>=</span><span>"as-pinwheel-pricecurrent"</span><span> itemprop</span><span>=</span><span>"price"</span><span>&gt;</span>
        $<span>79.00</span>
      <span>&lt;/</span><span>span</span><span>&gt;</span>
    <span>&lt;/</span><span>div</span><span>&gt;</span>
  <span>&lt;/</span><span>div</span><span>&gt;</span>
<span>&lt;/</span><span>div</span><span>&gt;</span>
</pre>
<p>With this setup, you don’t need to use XPath or CSS selectors to extract the data that you need. It is just a matter of using Extruct’s MicrodataExtractor in your spider:</p>
<pre><span>import</span> scrapy
<span>from</span> extruct<span>.</span>w3cmicrodata <span>import</span> MicrodataExtractor

<span>class</span> AppleSpider<span>(</span>scrapy<span>.</span>Spider<span>)</span><span>:</span>
    name <span>=</span> <span>"apple"</span>
    allowed_domains <span>=</span> <span>[</span><span>"apple.com"</span><span>]</span>
    start_urls <span>=</span> <span>(</span>
        <span>'http://www.apple.com/shop/mac/mac-accessories'</span><span>,</span>
    <span>)</span>

    <span>def</span> parse<span>(</span>self<span>,</span> response<span>)</span><span>:</span>
        extractor <span>=</span> MicrodataExtractor<span>(</span><span>)</span>
        items <span>=</span> extractor<span>.</span>extract<span>(</span>response<span>.</span>body_as_unicode<span>(</span><span>)</span><span>,</span> response<span>.</span>url<span>)</span><span>[</span><span>'items'</span><span>]</span>
        <span>for</span> item <span>in</span> items<span>:</span>
            <span>if</span> item<span>.</span>get<span>(</span><span>'properties'</span><span>,</span> <span>{</span><span>}</span><span>)</span><span>.</span>get<span>(</span><span>'name'</span><span>)</span><span>:</span>
                properties <span>=</span> item<span>[</span><span>'properties'</span><span>]</span>
                <span>yield</span> <span>{</span>
                    <span>'name'</span><span>:</span> properties<span>[</span><span>'name'</span><span>]</span><span>,</span>
                    <span>'price'</span><span>:</span> properties<span>[</span><span>'offers'</span><span>]</span><span>[</span><span>'properties'</span><span>]</span><span>[</span><span>'price'</span><span>]</span><span>,</span>
                    <span>'url'</span><span>:</span> properties<span>[</span><span>'url'</span><span>]</span>
                <span>}</span>
</pre>
<p>This spider generates items like this:</p>
<pre><span>{</span>
    <span>"url"</span><span>:</span> <span>"http://www.apple.com/shop/product/MJ2R2/magic-trackpad-2?fnode=4c"</span><span>,</span> 
    <span>"price"</span><span>:</span> <span>u"$129.00"</span><span>,</span>
    <span>"name"</span><span>:</span> <span>u"Magic Trackpad 2"</span>
<span>}</span>
</pre>
<p>So, when the site you’re scraping uses microdata to add semantic information to its contents, use <a href="https://github.com/scrapinghub/extruct" target="_blank">Extruct</a>. It is a much more robust solution than relying on a uniform page layout or wasting time investigating the HTML source.</p>
<h2>Use js2xml to Scrape Data Embedded in JavaScript Code Snippets</h2>
<p>Have you ever been frustrated by the differences between the web page rendered by your browser and the web page that Scrapy downloads? This is probably because some of the contents from that web page are not in the response that the server sends to you. Instead, they are generated in your browser through JavaScript code.</p>
<p>You can solve this issue by passing the requests to a JavaScript rendering service like <a href="http://scrapinghub.com/splash/" target="_blank">Splash</a>. Splash runs the JavaScript on the page and returns the final page structure for your spider to consume.</p>
<p>Splash was designed specifically for this purpose and <a href="https://blog.scrapinghub.com/2015/03/02/handling-javascript-in-scrapy-with-splash/" target="_blank">integrates well with Scrapy</a>. However, in some cases, all you need is something simple like the value of a variable from a JavaScript snippet, so using such a powerful tool would be overkill. This is where <a href="https://github.com/redapple/js2xml" target="_blank">js2xml</a> comes in. It is a library that converts JavaScript code into XML data.</p>
<p>For example, say an online retailer website loads the ratings of a product via JavaScript. Mixed in with the HTML lies a piece of JavaScript code like this:</p>
<pre><span>&lt;</span>script type<span>=</span><span>"</span><span>text/javascript</span><span>"</span><span>&gt;</span>
    <span>var</span> totalReviewsValue <span>=</span> <span>32</span><span>;</span>
    <span>var</span> averageRating <span>=</span> <span>4.5</span><span>;</span>
    <span>if</span><span>(</span>totalReviewsValue <span>!=</span> <span>0</span><span>)</span><span>{</span>
        events <span>=</span> <span>"</span><span>...</span><span>"</span><span>;</span>
    <span>}</span>
    <span>.</span><span>.</span><span>.</span>
<span>&lt;</span><span>/</span>script<span>&gt;</span>
</pre>
<p>To extract the value of <code>averageRating</code> using js2xml, we first have to extract the <code>&lt;script&gt;</code> block and then use js2xml to convert the code into XML:</p>
<pre><span>&gt;&gt;</span><span>&gt;</span> js_code <span>=</span> response<span>.</span>xpath<span>(</span><span>"//script[contains(., 'averageRating')]/text()"</span><span>)</span><span>.</span>extract_first<span>(</span><span>)</span>
<span>&gt;&gt;</span><span>&gt;</span> <span>import</span> js2xml
<span>&gt;&gt;</span><span>&gt;</span> parsed_js <span>=</span> js2xml<span>.</span>parse<span>(</span>js_code<span>)</span>
<span>&gt;&gt;</span><span>&gt;</span> <span>print</span> js2xml<span>.</span>pretty_print<span>(</span>parsed_js<span>)</span>
&lt;program&gt;
  &lt;var name="totalReviewsValue"&gt;
    &lt;number value="32"/&gt;
  &lt;/var&gt;
  &lt;var name="averageRating"&gt;
    &lt;number value="4.5"/&gt;
  &lt;/var&gt;
  &lt;if&gt;
    &lt;predicate&gt;
      &lt;binaryoperation operation="!="&gt;
        &lt;left&gt;&lt;identifier name="totalReviewsValue"/&gt;&lt;/left&gt;
        &lt;right&gt;&lt;number value="0"/&gt;&lt;/right&gt;
      &lt;/binaryoperation&gt;
    &lt;/predicate&gt;
    &lt;then&gt;
      &lt;block&gt;
        &lt;assign operator="="&gt;
          &lt;left&gt;&lt;identifier name="events"/&gt;&lt;/left&gt;
          &lt;right&gt;&lt;string&gt;...&lt;/string&gt;&lt;/right&gt;
        &lt;/assign&gt;
      &lt;/block&gt;
    &lt;/then&gt;
  &lt;/if&gt;
&lt;/program&gt;
</pre>
<p>Now, it is just a matter of building a Scrapy Selector and then using XPath to get the value that we want:</p>
<pre><span>&gt;&gt;</span><span>&gt;</span> js_sel <span>=</span> scrapy<span>.</span>Selector<span>(</span>_root<span>=</span>parsed_js<span>)</span>
<span>&gt;&gt;</span><span>&gt;</span> js_sel<span>.</span>xpath<span>(</span><span>"//program/var[@name='averageRating']/number/@value"</span><span>)</span><span>.</span>extract_first<span>(</span><span>)</span>
<span>u'4.5'</span>
</pre>
<p>While you could probably write a regular expression with the speed of thought to solve this problem, a JavaScript parser is more reliable. The example we used here is pretty simple, but in more complex cases regular expressions can be a lot harder to maintain.</p>
<h2>Use Functions from w3lib.url to Scrape Data from URLs</h2>
<p>Sometimes the piece of data that you are interested in is not alone inside an HTML tag. Usually you need to get the values of some parameters from URLs listed in the page. For example, you might be interested in getting the values of ‘username’ parameters from URLs listed in the HTML:</p>
<pre><span>&lt;</span><span>div</span> <span>class</span><span>=</span><span>"users"</span><span>&gt;</span>
  <span>&lt;</span><span>ul</span><span>&gt;</span>
    <span>&lt;</span><span>li</span><span>&gt;</span><span>&lt;</span><span>a</span> <span>href</span><span>=</span><span>"/users?username=johndoe23"</span><span>&gt;</span>John Doe<span>&lt;/</span><span>li</span><span>&gt;</span>
    <span>&lt;</span><span>li</span><span>&gt;</span><span>&lt;</span><span>a</span> <span>href</span><span>=</span><span>"/users?active=0&amp;username=the_jan"</span><span>&gt;</span>Jan Roe<span>&lt;/</span><span>li</span><span>&gt;</span>
     …
    <span>&lt;</span><span>li</span><span>&gt;</span><span>&lt;</span><span>a</span> <span>href</span><span>=</span><span>"/users?active=1&amp;username=janie&amp;ref=b1946ac9249&amp;gas=_ga=1.234.567"</span><span>&gt;</span>Janie Doe<span>&lt;/</span><span>li</span><span>&gt;</span>
  <span>&lt;/</span><span>ul</span><span>&gt;</span>
<span>&lt;/</span><span>div</span><span>&gt;</span>
</pre>
<p>You might be tempted to use <a href="https://xkcd.com/208/" target="_blank">your regex superpowers</a>, but calm down, <a href="https://github.com/scrapy/w3lib" target="_blank">w3lib</a> is here to save the day with a more dependable solution:</p>
<pre><span>&gt;&gt;</span><span>&gt;</span> <span>from</span> w3lib<span>.</span>url <span>import</span> url_query_parameter
<span>&gt;&gt;</span><span>&gt;</span> url_query_parameter<span>(</span><span>'/users?active=0&amp;username=the_jan'</span><span>,</span> <span>'username'</span><span>)</span>
    <span>'the_jan'</span>
</pre>
<p>If <a href="https://github.com/scrapy/w3lib" target="_blank">w3lib</a> is new to you, take a look at the <a href="http://w3lib.readthedocs.org/en/latest/w3lib.html" target="_blank">documentation</a>. We’ll be covering some of the other features of this Python library later in our Scrapy Tips From the Pros series.</p>
<h2>Wrap Up</h2>
<p>Share how you used our tips in the comments below. If you have any suggestions on scenarios that you’d like covered or tips you’d like to see, let us know!</p>
<p>Make sure to follow us on <a href="https://twitter.com/ScrapingHub" target="_blank">Twitter</a>, <a href="https://www.facebook.com/ScrapingHub/" target="_blank">Facebook</a>, and <a href="https://www.instagram.com/scrapinghub/" target="_blank">Instagram</a> and don’t forget to subscribe to our <a href="https://blog.scrapinghub.com/feed/" target="_blank">RSS Feed</a>. More tips are coming your way, so buckle up!</p>
<div id="jp-post-flair" class="sharedaddy sd-like-enabled sd-sharing-enabled"><div class="sharedaddy sd-block sd-like jetpack-likes-widget-wrapper jetpack-likes-widget-unloaded" id="like-post-wrapper-28801091-1894-56d5c7d85937e" data-src="//widgets.wp.com/likes/#blog_id=28801091&amp;post_id=1894&amp;origin=scrapinghub.wordpress.com&amp;obj_id=28801091-1894-56d5c7d85937e" data-name="like-post-frame-28801091-1894-56d5c7d85937e"><h3 class="sd-title">Like this:</h3><p class="likes-widget-placeholder post-likes-widget-placeholder"><span class="button"><span>Like</span></span> <span class="loading">Loading...</span></p><span class="sd-text-color"/><a class="sd-link-color"/></div>
<p id="jp-relatedposts" class="jp-relatedposts">
	<h3 class="jp-relatedposts-headline"><em>Related</em></h3>
</p></div>											</div>
			</div></body></html>