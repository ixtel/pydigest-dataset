<html><body><div><article class="markdown-body entry-content" itemprop="text"><h1><a id="user-content-farthing-generate-type-annotations-for-python-source-code-by-running-it" class="anchor" href="#farthing-generate-type-annotations-for-python-source-code-by-running-it" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Farthing: generate type annotations for Python source code by running it</h1>
<p>Farthing will run arbitrary Python code while tracing the argument and return
types of all functions within a given file or directory. Farthing can then
automatically add type annotations based on the types of the values it saw
during the execution run. This might be useful if you want to add static types
to existing Python code, or for exploring codebases where you're not sure what
type a value has.</p>
<p>For instance, the following code:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">def</span> <span class="pl-en">factorial</span>(<span class="pl-smi">n</span>):
    result <span class="pl-k">=</span> <span class="pl-c1">1</span>

    <span class="pl-k">for</span> i <span class="pl-k">in</span> <span class="pl-c1">range</span>(<span class="pl-c1">2</span>, n <span class="pl-k">+</span> <span class="pl-c1">1</span>):
        result <span class="pl-k">*=</span> i

    <span class="pl-k">return</span> result</pre></div>
<p>can be automatically transformed into:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">def</span> <span class="pl-en">factorial</span>(<span class="pl-smi">n</span>: <span class="pl-c1">int</span>) -&gt; <span class="pl-c1">int</span>:
    result <span class="pl-k">=</span> <span class="pl-c1">1</span>

    <span class="pl-k">for</span> i <span class="pl-k">in</span> <span class="pl-c1">range</span>(<span class="pl-c1">2</span>, n <span class="pl-k">+</span> <span class="pl-c1">1</span>):
        result <span class="pl-k">*=</span> i

    <span class="pl-k">return</span> result</pre></div>
<p>by running Farthing against the following test file:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> nose.tools <span class="pl-k">import</span> assert_equal

<span class="pl-k">import</span> fact


<span class="pl-k">def</span> <span class="pl-en">test_fib</span>():
    test_cases <span class="pl-k">=</span> [
        (<span class="pl-c1">0</span>, <span class="pl-c1">1</span>),
        (<span class="pl-c1">1</span>, <span class="pl-c1">1</span>),
        (<span class="pl-c1">2</span>, <span class="pl-c1">2</span>),
        (<span class="pl-c1">3</span>, <span class="pl-c1">6</span>),
        (<span class="pl-c1">4</span>, <span class="pl-c1">24</span>),
        (<span class="pl-c1">5</span>, <span class="pl-c1">120</span>),
    ]

    <span class="pl-k">for</span> index, value <span class="pl-k">in</span> test_cases:
        <span class="pl-k">yield</span> _check_fact, index, value


<span class="pl-k">def</span> <span class="pl-en">_check_fact</span>(<span class="pl-smi">index</span>, <span class="pl-smi">value</span>):
    assert_equal(value, fact.factorial(index))</pre></div>
<a name="user-content-usage"/>
<h2><a id="user-content-usage" class="anchor" href="#usage" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Usage</h2>
<p>Farthing can be called from the command line. The first argument should be the
file or directory that should have type annotations added to it. The other
arguments should be the Python script to run with any arguments. For instance:</p>
<div class="highlight highlight-source-shell"><pre>farthing demo/fact.py _virtualenv/bin/nosetests demo/tests.py</pre></div>
<a name="user-content-demo"/>
<h2><a id="user-content-demo" class="anchor" href="#demo" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Demo</h2>
<p>To run the demo, you can just run <code>demo.sh</code>. To explain what it actually does:</p>
<ol>
<li>Run <code>make bootstrap</code> to set up the virtualenv with dependencies.</li>
<li>Run <code>. _virtualenv/bin/activate</code> to enter the virtualenv.</li>
<li>Run <code>farthing demo/fact.py _virtualenv/bin/nosetests demo/tests.py</code> to
run <code>_virtualenv/bin/nosetests demo/tests.py</code> and add annotations to
<code>demo/fact.py</code> based on the types of actual values used in the execution run.</li>
</ol>
<a name="user-content-limitations"/>
<h2><a id="user-content-limitations" class="anchor" href="#limitations" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Limitations</h2>
<p>At the moment, Farthing is just a quick prototype, so currently has the
following limitations:</p>
<ul>
<li>Annotations are added just using the name of the type, which may not be
available in the current scope.</li>
<li>Type annotations cannot be added to the Python script being run.</li>
</ul>
<p>I'd be interested to see any projects along similar lines, so if you know of any,
I'd be grateful if you let me know.</p>
<a name="user-content-todo"/>
<h2><a id="user-content-todo" class="anchor" href="#todo" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>TODO</h2>
<ul>
<li>Type various iterables (e.g. the return value from <code>map</code> or <code>dict.keys()</code>) as iterables.</li>
<li>Check typing of methods.</li>
<li>Support user-defined generics (with markup).</li>
<li>Allow additional directories and files to be traced without being annotated.</li>
</ul>

</article>
  </div></body></html>