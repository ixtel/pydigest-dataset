<html><body><div><div class="content">
      
        <h1 class="content-title">Saturday morning hacks: DataSet for Peewee</h1>
      
      
      
  <div class="post-info"><p>
    
    
      October 17, 2014 17:39
      </p><span class="separator">/</span>
      <a href="#comments">0 comments</a>
      <span class="separator">/</span>
      
        <a href="/blog/tags/peewee/">peewee</a>
      
        <a href="/blog/tags/python/">python</a>
      
    
  </div>
  
  
    <p><a href="http://media.charlesleifer.com/blog/photos/coffee-cup-scaled.jpg" title="Saturday morning hacks"><img alt="Saturday morning hacks" class="img-responsive" src="http://m.charlesleifer.com/t/800x-/blog/photos/coffee-cup-scaled.jpg?key=xFJansgcRXa5MCBauZSUhQ"/></a></p>
<p>I recently became acquainted with the <a href="https://dataset.readthedocs.org/en/latest/index.html">dataset</a> project while browsing a curated list of <a href="https://github.com/dahlia/awesome-sqlalchemy">awesome SQLAlchemy resources</a>. I was intrigued by the project's simplicity, and apparently I'm not the only one as the project has quite a few followers on GitHub. Since peewee has the ingredients required to provide a similar API (reflection, schema migrations), I decided it might be a fun project to add a <em>DataSet</em>-like module to the <a href="docs.peewee-orm.com/en/latest/peewee/playhouse.html">playhouse extension collection</a>.</p>
<h3>Taking a look at DataSet</h3>
<p>I feel like the best way to explain DataSet is to show it in action, so let's take a look at what it can do.</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">playhouse.dataset</span> <span class="kn">import</span> <span class="n">DataSet</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span> <span class="o">=</span> <span class="n">DataSet</span><span class="p">(</span><span class="s1">'sqlite:///:memory:'</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">people</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s1">'people'</span><span class="p">]</span>  <span class="c1"># This will create the people table.</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">people</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">'charlie'</span><span class="p">,</span> <span class="n">gender</span><span class="o">=</span><span class="s1">'M'</span><span class="p">)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">people</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">'huey'</span><span class="p">,</span> <span class="n">gender</span><span class="o">=</span><span class="s1">'M'</span><span class="p">,</span> <span class="n">favorite_color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">)</span>
<span class="go">2</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nb">list</span><span class="p">(</span><span class="n">people</span><span class="p">)</span>
<span class="go">[{'favorite_color': None, 'gender': u'M', 'id': 1, 'name': u'charlie'},</span>
<span class="go"> {'favorite_color': u'blue', 'gender': u'M', 'id': 2, 'name': u'huey'}]</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">people</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">favorite_color</span><span class="o">=</span><span class="s1">'green'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'charlie'</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">'name'</span><span class="p">])</span>
<span class="go">1</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">people</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">'charlie'</span><span class="p">)[</span><span class="s1">'favorite_color'</span><span class="p">]</span>
<span class="go">u'green'</span>
</pre></div>
<p>There are a couple novel things going on here that I think are worth pointing out. First of all, DataSet plays very fast and loose with the schema, creating tables and adding columns on-the-fly as they are referenced. Second, instead of the usual <em>Model</em> classes, DataSet uses simple lists and dictionaries, much like JSON.</p>
<p>In the above code sample we used an in-memory SQLite database, but DataSet works on pre-existing databases as well. Additionally, if you want to dump your data, DataSet supports CSV and JSON exports:</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">sys</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">freeze</span><span class="p">(</span><span class="n">people</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="n">format</span><span class="o">=</span><span class="s1">'json'</span><span class="p">,</span> <span class="n">file_obj</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="go">[</span>
<span class="go">  {</span>
<span class="go">    "gender": "M",</span>
<span class="go">    "favorite_color": "green",</span>
<span class="go">    "id": 1,</span>
<span class="go">    "name": "charlie"</span>
<span class="go">  },</span>
<span class="go">  {</span>
<span class="go">    "gender": "M",</span>
<span class="go">    "favorite_color": "blue",</span>
<span class="go">    "id": 2,</span>
<span class="go">    "name": "huey"</span>
<span class="go">  }</span>
<span class="go">]</span>
</pre></div>
<p>Finally, DataSet allows nesting transactions using a simple context manager.</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">db</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
<span class="gp">... </span>    <span class="n">people</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">favorite_orm</span><span class="o">=</span><span class="s1">'peewee'</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">with</span> <span class="n">db</span><span class="o">.</span><span class="n">transaction</span><span class="p">()</span> <span class="k">as</span> <span class="n">txn2</span><span class="p">:</span>
<span class="gp">... </span>        <span class="n">people</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">favorite_orm</span><span class="o">=</span><span class="s1">'django'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'charlie'</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">'name'</span><span class="p">])</span>
<span class="gp">... </span>        <span class="n">txn2</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>  <span class="c1"># JK/LOL</span>
<span class="gp">...</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">people</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">'charlie'</span><span class="p">)[</span><span class="s1">'favorite_orm'</span><span class="p">]</span>
<span class="go">u'peewee'</span>
</pre></div>
<p>Paraphrasing the <a href="https://dataset.readthedocs.org/en/latest/">dataset documentation</a>, the project aims to simplify working with SQL databases in Python and exporting to various formats.</p>
<h3>Feature list</h3>
<p>The peewee edition of dataset has the following features:</p>
<ul>
<li>Automatic, on-the-fly schema migrations. Tables are created as needed, and columns are added as soon as they are referenced (by calls to <code>insert()</code> or <code>update()</code>).</li>
<li>Support for inserting new rows or updating based on simple equality conditions.</li>
<li>Simple ways to read lists of data or find individual rows.</li>
<li>Compatible with any database engine supported by Peewee (currently SQLite, MySQL, and Postgres).</li>
<li>Context manager for working with transactions.</li>
<li>Easy export to multiple formats.</li>
</ul>
<h3>Learning more</h3>
<p>If you're interested in learning more about the peewee dataset library, <a href="http://docs.peewee-orm.com/en/latest/peewee/playhouse.html#dataset">check out the documentation</a>. The module is currently only available in master, but I plan on rolling out a new release in the next week or two, which will have <code>dataset</code> as well as some other goodies.</p>
<p>Hope you find this new library useful!</p>
<p>If you're interested in more projects like this, check out <a href="/blog/tags/saturday-morning-hacks/">the list of saturday-morning hack posts</a>.</p>
  
  


<hr/>

  <p>Commenting has been closed, but please feel free to <a href="/contact/">contact me</a></p>


    </div>

    </div></body></html>