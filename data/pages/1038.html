<html><body><div><div class="e2-note-text e2-text e2-published">
<p>Однажды, понадобилось мне получить список событий одной из групп, и чтобы не изобретать велосипед, я пошёл курить API ВКонтакте. Из того многообразия методов которые он предлагает, не нашлось ни одного который решал бы мою задачу. В то время я ещё не был знаком с таким понятием как web scraping, и поэтому задачу отложил в сторону.</p>
<p>Как-то раз, читая блог Мигеля, я наткнулся на <a href="http://blog.miguelgrinberg.com/post/easy-web-scraping-with-python">статью</a>, где он на наглядном примере показывал, что такое web scraping и с чем его едят. Для лучшего закрепления материала, я решил организовать webcast для пары знакомых девушек, на котором шаг за шагом мы разобрали пример и инструменты из статьи.</p>
<p>После всего этого я был почти готов расправиться с первоначальной задачей, но тут выяснилось что для просмотра полного списка событий группы, ВКонтакте использует ajax. На этот раз мне помог <a href="http://stackoverflow.com/questions/22183899/simulating-ajax-request-with-python-using-requests-lib">stackoverflow</a>. В результате получился такой код:</p>
<pre class="e2-text-code"><code class="python">import bs4
from requests import Session

vk_url = 'http://vk.com'

def get_events_urls(group_id, oid):
    group_url = ''.join([vk_url, '/', group_id])
    session = Session()
    session.head(group_url)
    response = session.post(
        url='http://vk.com/al_groups.php',
        data={
            'act': 'show_events',
            'al': '1',
            'oid': oid
        },
        headers={
            'Referer': group_url
        }
    )
    soup = bs4.BeautifulSoup(response.text[59:-46])
    urls = [a.attrs.get('href') for a in soup.select('.name a[href]')]
    return urls

def ltrim_event_url(event_url):
    if event_url.startswith('/event'):
        return event_url[6:]
    return event_url[1:]

def get_events_ids(events_urls):
    return [ltrim_event_url(event_url) for event_url in events_urls]

events_urls = get_events_urls('illuminatedfaces', '-618259')
events_ids = get_events_ids(events_urls)
</code></pre><p>Как не трудно заметить, для получения списка адресов событий нужно вызвать функцию get_events_urls, в которую передаются имя группы и её уникальный номер начинающийся с дефиса. Затем отправляем POST запрос по адресу <a href="http://vk.com/al_groups.php">http://vk.com/al_groups.php</a> и получаем пока ещё сырой кусок HTML. Немного режем его справа и слева, и начинаем «готовить суп», т. е. парсим на предмет полезных ссылок.</p>
<p>Как известно событиям ВКонтакте можно присваивать ЧПУ, а можно оставить как есть. В последнем случае имя будет начинаться на event. Чтобы получить чистые идентификаторы (а мне они понадобились для дальнейшей работы) обрезаем каждый адрес до нужного состояния, и создаём новый список.</p>
<p>На сегодня у меня всё. Не стесняйтесь оставлять ваши комментарии и задавать вопросы.</p>
</div>



 
 

</div></body></html>