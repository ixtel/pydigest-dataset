<html><body><div><div itemprop="articleBody"><p><a class="reference external" href="http://docs.python.org/2/library/functions.html#eval">eval</a> and <a class="reference external" href="http://docs.python.org/2/reference/simple_stmts.html#the-exec-statement">exec</a> are usually frowned upon, for good reason. The main issues people complain about are:</p><ul class="simple"><li>Security: cause user input might end up in the eval'd string. And users are not to be trusted.</li><li>Slow: cause of the code parsing that <a class="reference external" href="http://docs.python.org/2/library/functions.html#eval">eval</a>/<a class="reference external" href="http://docs.python.org/2/reference/simple_stmts.html#the-exec-statement">exec</a> may need to do.</li><li>Hard to debug: tracebacks can get <em>weird</em>.</li></ul><p>What about those tracebacks? Let's take this naive example:</p><div class="highlight"><pre><span/><span class="n">func</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s1">'lambda a, b: a + b'</span><span class="p">)</span>
</pre></div><p>Not if we try <tt class="docutils literal">func(1, "a")</tt> we'll get:</p><div class="highlight"><pre><span/><span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">"test.py"</span>, line <span class="m">17</span>, in <span class="n">&lt;module&gt;</span>
    <span class="n">func</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"a"</span><span class="p">)</span>
  File <span class="nb">"&lt;string&gt;"</span>, line <span class="m">1</span>, in <span class="n">&lt;lambda&gt;</span>
<span class="gr">TypeError</span>: <span class="n">unsupported operand type(s) for +: 'int' and 'str'</span>
</pre></div><p>Notice that the traceback does not show the executed code from the lambda function. That's because there's no such file <tt class="docutils literal">&lt;string&gt;</tt>. Of-course this is trivial and it's obvious what's wrong but what if you have more code there and seeing it would be really helpful?</p><p>The traceback module will use the <a class="reference external" href="http://docs.python.org/2/library/linecache.html">linecache</a> module to load the file. If we prefill the cache then we could get the line shown in the traceback. Something like this would work:</p><div class="highlight"><pre><span/><span class="kn">import</span> <span class="nn">linecache</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="n">code</span> <span class="o">=</span> <span class="s1">'lambda a, b: a + b'</span>
<span class="n">name</span> <span class="o">=</span> <span class="s1">'&lt;string-1&gt;'</span>
<span class="n">func</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s1">'eval'</span><span class="p">))</span>
<span class="n">linecache</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">),</span> <span class="bp">None</span><span class="p">,</span> <span class="p">[</span><span class="n">code</span><span class="p">],</span> <span class="n">name</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">func</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"a"</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
</pre></div><p>Now we get:</p><div class="highlight"><pre><span/><span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">"test.py"</span>, line <span class="m">25</span>, in <span class="n">&lt;module&gt;</span>
    <span class="n">func</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"a"</span><span class="p">)</span>
  File <span class="nb">"&lt;string-1&gt;"</span>, line <span class="m">1</span>, in <span class="n">&lt;lambda&gt;</span>
    <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
<span class="gr">TypeError</span>: <span class="n">unsupported operand type(s) for +: 'int' and 'str'</span>
</pre></div><p>This seems fine. But what if we have many of these functions? <tt class="docutils literal">linecache.cache</tt> would just leak. We can fix this with a <a class="reference external" href="http://docs.python.org/2/library/weakref.html#weakref.ref">weakref</a> callback:</p><div class="highlight"><pre><span/><span class="kn">import</span> <span class="nn">weakref</span>
<span class="n">func</span><span class="o">.</span><span class="n">_cleanup</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">linecache</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
</pre></div><p>Ok, but some tracebacks aren't displayed with the <a class="reference external" href="http://docs.python.org/2/library/traceback.html">traceback</a> module. If that exception would make the interpreter exit then it would be shown with <a class="reference external" href="http://docs.python.org/2/library/sys.html#sys.excepthook">sys.excepthook</a>. The default <a class="reference external" href="http://docs.python.org/2/library/sys.html#sys.excepthook">sys.excepthook</a> will use a function <a class="reference external" href="http://hg.python.org/cpython/file/2.7/Python/traceback.c#l117">_Py_DisplaySourceLine</a> that just tries to open the file. What now?</p><p>You could patch <a class="reference external" href="http://docs.python.org/2/library/sys.html#sys.excepthook">sys.excepthook</a> function. This is the only solution on Python 2:</p><div class="highlight"><pre><span/><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">excepthook</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">print_exception</span>
</pre></div><p>But that will disable <a class="reference external" href="https://wiki.ubuntu.com/Apport">python-apport</a> (it insists on overriding <a class="reference external" href="http://docs.python.org/2/library/sys.html#sys.excepthook">sys.excepthook</a> for some reason, even if disabled). You probably don't care about that anyway.</p><p>Python 3 seems to use <a class="reference external" href="http://docs.python.org/3/library/io.html#io.open">io.open</a> to load the file. Since we've been naughty and played with <tt class="docutils literal">eval</tt>, how about we patch <a class="reference external" href="http://docs.python.org/3/library/io.html#io.open">io.open</a>?</p><div class="highlight"><pre><span/><span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="n">filecache</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">filecache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>

<span class="k">def</span> <span class="nf">_patched_open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filecache</span><span class="p">:</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryFile</span><span class="p">()</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filecache</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'utf8'</span><span class="p">))</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fh</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_old_open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="n">_old_open</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">,</span> <span class="n">_patched_open</span>
<span class="c1"># this is horrible compared to patching sys.excepthook</span>
</pre></div><p>Why use <a class="reference external" href="http://docs.python.org/3/library/tempfile.html#tempfile.TemporaryFile">tempfile</a> when we could have used a <a class="reference external" href="http://docs.python.org/3/library/io.html#io.StringIO">io.StringIO</a> object instead? Turns out that <a class="reference external" href="http://hg.python.org/cpython/file/3.3/Python/traceback.c#l219">_Py_DisplaySourceLine from 3.3</a> will open the file with <a class="reference external" href="http://docs.python.org/3/library/io.html#io.open">io.open</a> and strangely enough will work with the file descriptor directly, instead of calling the right methods on the file object.</p><p>I think patching <a class="reference external" href="http://docs.python.org/3/library/io.html#io.open">io.open</a> is a bad idea in general. It will create some overhead for opening files and it might violate some expectation in 3rd party code like introspection tools (by having different function signature, module and file).</p><p>Here's the complete code:</p><div class="highlight"><pre><span/><span class="kn">import</span> <span class="nn">linecache</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">weakref</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">excepthook</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">print_exception</span> <span class="c1"># poor apport, no longer works now ...</span>

<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">def</span> <span class="nf">get_function</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">count</span>
    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">'&lt;string-</span><span class="si">%s</span><span class="s1">&gt;'</span> <span class="o">%</span> <span class="n">count</span>
    <span class="n">func</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s1">'eval'</span><span class="p">))</span>
    <span class="n">linecache</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">),</span> <span class="bp">None</span><span class="p">,</span> <span class="p">[</span><span class="n">code</span><span class="p">],</span> <span class="n">name</span>
    <span class="k">return</span> <span class="n">func</span>

<span class="n">func</span> <span class="o">=</span> <span class="n">get_function</span><span class="p">(</span><span class="s1">'lambda a, b: a + b'</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">func</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"a"</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

<span class="n">func</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"a"</span><span class="p">)</span>
</pre></div><p>You could apply the same tricks for something using <a class="reference external" href="http://docs.python.org/2/reference/simple_stmts.html#the-exec-statement">exec</a>, but what's this useful for? How about if you want to <a class="reference external" href="https://gist.github.com/ionelmc/6166411">compile something like a mongo query to a python function</a> (so you can run it on a list instead of a mongo collection without having the overhead of processing the query for each row)?</p><p>You will notice that there's a similar issue with <a class="reference external" href="http://docs.python.org/2/library/zipimport.html">zipimport</a>: you won't see the sourcecode when displaying the traceback with the default <a class="reference external" href="http://docs.python.org/2/library/sys.html#sys.excepthook">sys.excepthook</a>. However, it will show up when displaying with the <a class="reference external" href="http://docs.python.org/2/library/traceback.html">traceback</a> module because the <a class="reference external" href="http://docs.python.org/2/library/linecache.html">linecache</a> module will use the <a class="reference external" href="http://www.python.org/dev/peps/pep-0302/">PEP302</a> imports hook that <a class="reference external" href="http://docs.python.org/2/library/zipimport.html#zipimport.zipimporter.get_source">zipimport implements</a>.</p></div></div></body></html>