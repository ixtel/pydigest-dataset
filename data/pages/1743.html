<html><body><div><article>
    <header>
        
    </header>




    <p>I was recently reminded of the super cool <a class="reference external" href="http://hy.readthedocs.org/en/latest/">Hy</a> project. Hy is a lisp that
compiles to python’s own abstract syntax tree, so it works perfectly
with existing Python code (including with Cython etc.) but also
exposes all the power of lisp.</p>
<p>For instance, here’s a simple Kivy application that simply displays a
Label with the obligatory Hy pun, but written in Hy. I’ve included the
normal Python code as comments so you can see exactly what the code is
doing. If you’re new to Kivy and want to understand what the code
actually does, check out my <a class="reference external" href="http://inclem.net/pages/kivy-crash-course/">Kivy crash course</a>:</p>
<div class="highlight"><pre><span class="p">(</span><span class="nb">import</span> <span class="nv">[kivy.app</span> <span class="nv">[App]]</span>
        <span class="nv">[kivy.uix.label</span> <span class="nv">[Label]]</span><span class="p">)</span>
<span class="c1">;; from kivy.app import App</span>
<span class="c1">;; from kivy.uix.label import Label</span>


<span class="p">(</span><span class="nb">defclass</span> <span class="nv">HyApp</span> <span class="nv">[App]</span>
  <span class="nv">[[build</span>
    <span class="p">(</span><span class="nv">fn</span> <span class="nv">[self]</span>
      <span class="p">(</span><span class="nb">apply</span> <span class="nv">Label</span> <span class="nv">[]</span> <span class="nv">{</span><span class="s">"text"</span> <span class="s">"Hy world!"</span>
                       <span class="s">"font_size"</span> <span class="mi">100</span>
                       <span class="s">"color"</span> <span class="p">(</span><span class="o">,</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mi">1</span><span class="p">)</span><span class="nv">}</span><span class="p">))</span><span class="nv">]]</span><span class="p">)</span>

<span class="c1">;; class HyApp(App):</span>
<span class="c1">;;     def build(self):</span>
<span class="c1">;;         return Label(text="Hy world!",</span>
<span class="c1">;;                      font_size=100,</span>
<span class="c1">;;                      color=(0, 1, 0, 1))</span>

<span class="p">(</span><span class="o">.</span><span class="nv">run</span> <span class="p">(</span><span class="nv">HyApp</span><span class="p">))</span>

<span class="c1">;; HyApp().run()</span>
</pre></div>
<p>This works great, though only with python3 due to a small bug in
Kivy - the kwargs of Label are eventually read in cython with a
variable typed as <tt class="docutils literal">str</tt>, which in python2 excludes the unicode Hy
passes. Still, that’s not surprising even if it’s cool - part of the
point of Hy is to interoperate perfectly with Python.</p>
<p>A tougher problem is how to use Kivy’s kv language with Hy. kv is a
simple domain-specific language for declaring widget trees, making it
easy to define event-driven interactions between the different
properties of widgets. It’s really useful and we tend to recommend
using it as much as possible, so it’d be great to have it work with Hy.
I won’t explain the language here (you can see the <a class="reference external" href="http://kivy.org/docs/guide/lang.html">Kivy doc</a> or my own tutorials), but
the key point is that much of it consists of interpreting normal
python code, which I’d like to replace with Hy code.</p>
<p>It turns out making this work is actually really easy. Here’s the
relevant part of <tt class="docutils literal">lang.py</tt> in Kivy’s source, the file containing the
code for the kv parser:</p>
<div class="highlight"><pre><span class="bp">self</span><span class="o">.</span><span class="n">co_value</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">value</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">filename</span> <span class="ow">or</span> <span class="s">'&lt;string&gt;'</span><span class="p">,</span>
                        <span class="n">mode</span><span class="p">)</span>
</pre></div>
<p><tt class="docutils literal">value</tt> is the string of Python code whose output will set a
property of a widget or be run when an event is registered. For
instance, a line of kv code might be <tt class="docutils literal">color: (1, 0, 0,
some_function_of(self.alpha))</tt>, in which case <tt class="docutils literal">value</tt> would be
<tt class="docutils literal">"(1, 0, 0, <span class="pre">some_function_of(self.alpha))"</span></tt>.</p>
<p>To make a line of Hy code work instead of Python, we can do an awful
hack, replacing the above line with:</p>
<div class="highlight"><pre><span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s">'#hy'</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">hy.importer</span> <span class="kn">import</span> <span class="p">(</span><span class="n">ast_compile</span><span class="p">,</span>
                             <span class="n">import_buffer_to_ast</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">hy.compiler</span> <span class="kn">import</span> <span class="n">hy_compile</span>
    <span class="kn">import</span> <span class="nn">ast</span>
    <span class="n">ast_part</span> <span class="o">=</span> <span class="n">import_buffer_to_ast</span><span class="p">(</span><span class="n">value</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="s">'&lt;stdin&gt;'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">'eval'</span><span class="p">:</span>
        <span class="n">ast_part</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">ast_part</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">co_value</span> <span class="o">=</span> <span class="n">ast_compile</span><span class="p">(</span><span class="n">ast_part</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">filename</span> <span class="ow">or</span> <span class="s">'&lt;string&gt;'</span><span class="p">,</span>
                                <span class="n">mode</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">co_value</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">value</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">filename</span> <span class="ow">or</span> <span class="s">'&lt;string&gt;'</span><span class="p">,</span>
                            <span class="n">mode</span><span class="p">)</span>
</pre></div>
<p>This new code checks if the line of Python ends with <tt class="docutils literal">#hy</tt>, and if
so runs the code through Hy’s own equivalent of <tt class="docutils literal">compile</tt>
(effectively parsing the Hy code to ast before doing the same thing as
the normal Python code). I also have the extra muckiness of taking
apart this ast if the compilation is in <tt class="docutils literal">eval</tt> mode, because I
couldn’t get Hy to return an <tt class="docutils literal">ast.Expression</tt> in the first place.
This is probably very easily and neatly fixed, but I’ve left it like
this because a silly hack is good enough for a proof of concept. All
credit for this part goes to the friendly Hy people on their irc
channel, #hy on Freenode.</p>
<p>With this in place, we can write a new Python program, but this time
use our Hy+kv language to define the widget tree. Here’s the new
code on the Python (now Hy) side:</p>
<div class="highlight"><pre><span class="p">(</span><span class="nb">import</span> <span class="nv">[kivy.app</span> <span class="nv">[App]]</span>
        <span class="nv">[kivy.lang</span> <span class="nv">[Builder]]</span><span class="p">)</span>

<span class="c1">;; from kivy.app import App</span>
<span class="c1">;; from kivy.lang import Builder</span>

<span class="p">(</span><span class="nv">setv</span> <span class="nv">root</span> <span class="p">(</span><span class="nv">Builder.load_file</span> <span class="s">"hy.kv"</span><span class="p">))</span>

<span class="c1">;; root = Builder.load_file("hy.kv")</span>

<span class="p">(</span><span class="nb">defclass</span> <span class="nv">HyApp</span> <span class="nv">[App]</span>
  <span class="nv">[[build</span>
    <span class="p">(</span><span class="nv">fn</span> <span class="nv">[self]</span>
      <span class="nv">root</span><span class="p">)</span><span class="nv">]]</span><span class="p">)</span>

<span class="c1">;; class HyApp(App):</span>
<span class="c1">;;     def build(self):</span>
<span class="c1">;;         return root</span>

<span class="p">(</span><span class="o">.</span><span class="nv">run</span> <span class="p">(</span><span class="nv">HyApp</span><span class="p">))</span>

<span class="c1">;; HyApp().run()</span>
</pre></div>
<p>This obviously depends on our new kv file, "hy.kv", whose contents are
as below. Kivy users will notice this file would normally be loaded
automatically because the app name starts with <tt class="docutils literal">Hy</tt>, but something
about Hy seems to have broken this so I manually loaded it with the Builder.</p>
<div class="highlight"><pre><span class="n">BoxLayout</span><span class="p">:</span>
    <span class="n">orientation</span><span class="p">:</span> <span class="s">"vertical"</span>
    <span class="n">Label</span><span class="p">:</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">label</span>
        <span class="n">text</span><span class="p">:</span> <span class="s">"What is your name?"</span>
    <span class="n">TextInput</span><span class="p">:</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">ti</span>
        <span class="n">text</span><span class="p">:</span> <span class="s">""</span>
    <span class="n">Button</span><span class="p">:</span>
        <span class="n">text</span><span class="p">:</span> <span class="p">(</span><span class="o">.</span><span class="n">format</span> <span class="s">"Greet me as {}"</span> <span class="n">ti</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="c">#hy</span>
        <span class="n">on_press</span><span class="p">:</span> <span class="p">(</span><span class="n">setv</span> <span class="n">label</span><span class="o">.</span><span class="n">text</span> <span class="p">(</span><span class="o">.</span><span class="n">format</span> <span class="s">"Hy there {}"</span> <span class="n">ti</span><span class="o">.</span><span class="n">text</span><span class="p">))</span> <span class="c">#hy</span>

<span class="c"># as normal kv, except the final 2 rules would normally be:</span>
<span class="c"># text: "Greet me as {}".format(ti.text)</span>
<span class="c"># on_press: label.text = "Hy there {}".format(ti.text)</span>
</pre></div>
<p>Running the code…it works perfectly! Here’s a picture after typing
my name and clicking the button:</p>
<img alt="Image of Kivy program after running Hy code" src="http://inclem.net/media/hy_example.png"/>
<p>For those not familiar with kv, one of its features is that it
automatically detects property changes and updates dependent
properties - in this case, the text of the button should change every
time <tt class="docutils literal">ti.text</tt> changes (i.e. every time a letter is typed in the
TextInput). This works too with the new Hy interface, because the
parser detects the dependency by searching the string for substrings
like <tt class="docutils literal">ti.text</tt>, and these have been unmodified by the move to Hy. Hy
does support syntax that would break this relationship, but it’s quite
convenient as it is.</p>
<p>So…there we go, Hy support in Kivy! The hack to make kv language
work is pretty terrible, but it looks like a proper solution with this
basis would work fine - we could subclass the kv parsing Builder
to support a Hy loading option, removing the need for the <tt class="docutils literal">#hy</tt> at
the end of each Hy line.</p>






</article>
    </div></body></html>