<html><body><div><div class="content-body" itemprop="text articleBody">
	<div class="section" id="introduction">
<h2>Introduction</h2>
<p>Pandas includes multiple built in functions such as <code class="code">
sum</code>
, <code class="code">
mean</code>
,
<code class="code">
max</code>
, <code class="code">
min</code>
, etc. that you can apply to a DataFrame or grouped data.
However, building and using your own function is a good way to learn more about
how pandas works and can increase your productivity with data wrangling and analysis.</p>
<p>The weighted average is a good example use case because it is easy to understand but useful formula
that is not included in pandas. I find that it can be more intuitive than a simple average
when looking at certain collections of data. Building a weighted average function
in pandas is relatively simple but can be incredibly useful when combined with
other pandas functions such as <code class="code">
groupby</code>
.</p>
<p>This article will discuss the basics of why you might choose to use a weighted
average to look at your data then walk through how to build and use this function
in pandas. The basic principles shown in this article will be helpful for building
more complex analysis in pandas and should also be helpful in understanding
how to work with grouped data in pandas.</p>
</div>
<div class="section" id="why-use-a-weighted-average">
<h2>Why Use A Weighted Average?</h2>
<p>A simple example shows why the weighted average can be a helpful statistic. The table below
shows the prices and quantities that 3 different customers pay for the same product.</p>
<table border="1" class="docutils">
<colgroup>
<col/>
<col/>
<col/>
</colgroup>
<thead valign="bottom">
<tr><th class="head">Customer</th>
<th class="head">Shoe Price</th>
<th class="head">Shoe Quantity</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>Small Customer</td>
<td>300</td>
<td>20</td>
</tr>
<tr><td>Medium Customer</td>
<td>200</td>
<td>100</td>
</tr>
<tr><td>Big Customer</td>
<td>150</td>
<td>225</td>
</tr>
</tbody>
</table>
<p>If someone were to ask, what is the average price of our shoes? The simple average
of the shoe prices would be:</p>
<p class="math">
\begin{equation*}
\frac{300+200+150}{3} = \$216.67
\end{equation*}
</p>
<p>While this is an accurate average, this does not intuitively make sense for understanding our
average selling price. This is especially challenging if we want to use an average for
revenue projections.</p>
<p>If you look at the numbers, you can see we are selling far more shoes for &lt; $200
than we are above $200. Therefore an average of $216.67 does not accurately reflect
the real average selling price in the market.</p>
<p>What would be more useful is to weight those prices based on the quantity purchased.
Let’s build a weighted average such that the average shoe price will be more
representative of all customers’ purchase patterns.</p>
<p>A weighted average can be calculated like this:</p>
<p class="math">
\begin{equation*}
\frac{(300*20 + 200*100 + 150*225)}{(20 + 100 + 225)} = \$173.19
\end{equation*}
</p>
<p>Since we are selling the vast majority of our shoes between $200 and $150, this number
represents the overall average price of our products more accurately than the simple average.</p>
<p>This concept is simple but can be a little bit more difficult to calculate in pandas
because you need two values: the value to average (shoe price) and the weight
(shoe quantity). Let’s walk through how to build and use this in pandas.</p>
</div>
<div class="section" id="calculating-weighted-average-in-pandas">
<h2>Calculating Weighted Average in Pandas</h2>
<p>As shown above, the mathematical concept for a weighted average is straightforward.
Because we need values and weights, it can be a little less intuitive to implement in pandas when
you are doing complex groupings of data. However, once you figure it out, it can be incredibly easy
to use the weighted average in a bunch of different scenarios.</p>
<p>Additionally, the process of building out this functionality and using it in various
situations should be useful for building your day to day pandas data manipulation skills.
Before I go any further, I wanted to call out that the basic code for this function is
based on this Stack Overflow <a class="reference external" href="http://stackoverflow.com/questions/10951341/pandas-dataframe-aggregate-function-using-multiple-columns">question</a>.</p>
<p>We are going to use a simple DataFrame that contains fictious sales data as the
basis for our analysis. Let’s start by importing all the modules we need and read
in our Excel file:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="n">sales</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s">"https://github.com/chris1610/pbpython/blob/master/data/sales-estimate.xlsx?raw=True"</span><span class="p">,</span> <span class="n">sheetname</span><span class="o">=</span><span class="s">"projections"</span><span class="p">)</span>
<span class="n">sales</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
<div>
<table border="1" class="table table-condensed">
<thead>
<tr>
<th/>
<th>Account</th>
<th>Name</th>
<th>State</th>
<th>Rep</th>
<th>Manager</th>
<th>Current_Price</th>
<th>Quantity</th>
<th>New_Product_Price</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>714466</td>
<td>Trantow-Barrows</td>
<td><span class="caps">MN</span></td>
<td>Craig Booker</td>
<td>Debra Henley</td>
<td>500</td>
<td>100</td>
<td>550</td>
</tr>
<tr>
<th>1</th>
<td>737550</td>
<td>Fritsch, Russel and Anderson</td>
<td><span class="caps">MN</span></td>
<td>Craig Booker</td>
<td>Debra Henley</td>
<td>600</td>
<td>90</td>
<td>725</td>
</tr>
<tr>
<th>2</th>
<td>146832</td>
<td>Kiehn-Spinka</td>
<td><span class="caps">TX</span></td>
<td>Daniel Hilton</td>
<td>Debra Henley</td>
<td>225</td>
<td>475</td>
<td>255</td>
</tr>
<tr>
<th>3</th>
<td>218895</td>
<td>Kulas Inc</td>
<td><span class="caps">TX</span></td>
<td>Daniel Hilton</td>
<td>Debra Henley</td>
<td>290</td>
<td>375</td>
<td>300</td>
</tr>
<tr>
<th>4</th>
<td>412290</td>
<td>Jerde-Hilpert</td>
<td><span class="caps">WI</span></td>
<td>John Smith</td>
<td>Debra Henley</td>
<td>375</td>
<td>400</td>
<td>400</td>
</tr>
</tbody>
</table>
</div><p>In our example data, we have a bunch of account information that includes a current price and
quantity as well as a projected <strong>New_Product_Price</strong>.</p>
<p>If we want to determine a simple mean, we can use the built in functions to easily
calculate it:</p>
<div class="highlight"><pre><span class="n">sales</span><span class="p">[</span><span class="s">"Current_Price"</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">sales</span><span class="p">[</span><span class="s">"New_Product_Price"</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
<pre class="literal-block">
405.41666
447.08333
</pre>
<p>In order to calculate a weighted average using the long approach:</p>
<div class="highlight"><pre><span class="p">(</span><span class="n">sales</span><span class="p">[</span><span class="s">"Current_Price"</span><span class="p">]</span> <span class="o">*</span> <span class="n">sales</span><span class="p">[</span><span class="s">"Quantity"</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">sales</span><span class="p">[</span><span class="s">"Quantity"</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="p">(</span><span class="n">sales</span><span class="p">[</span><span class="s">"New_Product_Price"</span><span class="p">]</span> <span class="o">*</span> <span class="n">sales</span><span class="p">[</span><span class="s">"Quantity"</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">sales</span><span class="p">[</span><span class="s">"Quantity"</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
<pre class="literal-block">
374.6383
342.5406
</pre>
<div class="panel panel-info">
<p class="panel-heading">
What about Numpy?</p>
<p class="panel-body">
Some of the more experienced readers may be wondering why we do not use Numpy’s
average function? We absolutely could but I wanted to show how to create a formula.
At the end of the article, I will show how to use <code class="code">
np.average</code>
</p>
</div>
<p>The weighted average formula is not complicated but it is verbose. It also is going
to be difficult to use when we group data. Life will be much easier if we build
a function for calculating the data.</p>
</div>
<div class="section" id="grouping-data-with-the-weighted-average">
<h2>Grouping Data with the Weighted Average</h2>
<p>Panda’s <code class="code">
groupby</code>
 is commonly used to summarize data. For instance, if we want
to look at the mean of the <strong>Current_Price</strong> by manager, it is simple with <code class="code">
groupby</code>
:</p>
<div class="highlight"><pre><span class="n">sales</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">"Manager"</span><span class="p">)[</span><span class="s">"Current_Price"</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
<pre class="literal-block">
Manager
Debra Henley     423.333333
Fred Anderson    387.500000
Name: Current_Price, dtype: float64
</pre>
<p>Ideally we would like to do the same thing with the weighted average, but how do
we pass in the weights we want to use? Hmmm.</p>
<p>The answer is to define a custom function that takes the names of the columns of
our data and calculates the weighted average. Then, use <code class="code">
apply</code>
 to execute it
against our grouped data.</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">wavg</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">avg_name</span><span class="p">,</span> <span class="n">weight_name</span><span class="p">):</span>
    <span class="sd">""" http://stackoverflow.com/questions/10951341/pandas-dataframe-aggregate-function-using-multiple-columns</span>
<span class="sd">    In rare instance, we may not have weights, so just return the mean. Customize this if your business case</span>
<span class="sd">    should return otherwise.</span>
<span class="sd">    """</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">avg_name</span><span class="p">]</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">weight_name</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
<div class="panel panel-info">
<p class="panel-heading">
Handling Division by Zero</p>
<p class="panel-body">
In this code, I made the decision that if there is a 0 quantity in the total weight,
I want to return the simple mean. In your case you might want to return a
<code class="code">
NaN</code>
 or some other value. This is one example of the power you have by
building your own function.</p>
</div>
<p>In order to get our weighted average:</p>
<div class="highlight"><pre><span class="n">wavg</span><span class="p">(</span><span class="n">sales</span><span class="p">,</span> <span class="s">"Current_Price"</span><span class="p">,</span> <span class="s">"Quantity"</span><span class="p">)</span>
</pre></div>
<pre class="literal-block">
342.54068716094031
</pre>
<p>The nice thing is that this will also work on grouped data. The key is that we
need to use <code class="code">
apply</code>
 in order for pandas to pass the various groupings
to the function.</p>
<div class="highlight"><pre><span class="n">sales</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">"Manager"</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">wavg</span><span class="p">,</span> <span class="s">"Current_Price"</span><span class="p">,</span> <span class="s">"Quantity"</span><span class="p">)</span>
</pre></div>
<pre class="literal-block">
Manager
Debra Henley     340.665584
Fred Anderson    344.897959
dtype: float64
</pre>
<p>Using this on our projected price is easy because you just need to pass in a
new column name:</p>
<div class="highlight"><pre><span class="n">sales</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">"Manager"</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">wavg</span><span class="p">,</span> <span class="s">"New_Product_Price"</span><span class="p">,</span> <span class="s">"Quantity"</span><span class="p">)</span>
</pre></div>
<pre class="literal-block">
Manager
Debra Henley     372.646104
Fred Anderson    377.142857
dtype: float64
</pre>
<p>It is also possible to group by multiple criteria and the function will make sure
that the correct data is used in each grouping:</p>
<div class="highlight"><pre><span class="n">sales</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">"Manager"</span><span class="p">,</span> <span class="s">"State"</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">wavg</span><span class="p">,</span> <span class="s">"New_Product_Price"</span><span class="p">,</span> <span class="s">"Quantity"</span><span class="p">)</span>
</pre></div>
<pre class="literal-block">
Manager        State
Debra Henley   MN       632.894737
               TX       274.852941
               WI       440.000000
Fred Anderson  CA       446.428571
               NV       325.000000
               WA       610.000000
dtype: float64
</pre>
<p>This is a simple but really useful approach to understanding your data better.</p>
</div>
<div class="section" id="multiple-aggregations">
<h2>Multiple Aggregations</h2>
<p>One final item I wanted to cover is the ability to perform multiple aggregations on data.
For instance, if we want to get the mean for some columns, median for one and sum for another,
we can do this by defining a dictionary with the column names and aggregation functions to call.
Then, we call it on the grouped data with <code class="code">
agg</code>
</p>
<div class="highlight"><pre><span class="n">f</span> <span class="o">=</span> <span class="p">{</span><span class="s">'New_Product_Price'</span><span class="p">:</span> <span class="p">[</span><span class="s">'mean'</span><span class="p">],</span><span class="s">'Current_Price'</span><span class="p">:</span> <span class="p">[</span><span class="s">'median'</span><span class="p">],</span> <span class="s">'Quantity'</span><span class="p">:</span> <span class="p">[</span><span class="s">'sum'</span><span class="p">,</span> <span class="s">'mean'</span><span class="p">]}</span>
<span class="n">sales</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">"Manager"</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
<div>
<table border="1" class="table table-condensed">
<thead>
<tr>
<th/>
<th>New_Product_Price</th>
<th>Current_Price</th>
<th colspan="2" halign="left">Quantity</th>
</tr>
<tr>
<th/>
<th>mean</th>
<th>median</th>
<th>sum</th>
<th>mean</th>
</tr>
<tr>
<th>Manager</th>
<th/>
<th/>
<th/>
<th/>
</tr>
</thead>
<tbody>
<tr>
<th>Debra Henley</th>
<td>471.666667</td>
<td>437.5</td>
<td>1540</td>
<td>256.666667</td>
</tr>
<tr>
<th>Fred Anderson</th>
<td>422.500000</td>
<td>375.0</td>
<td>1225</td>
<td>204.166667</td>
</tr>
</tbody>
</table>
</div><div class="panel panel-info">
<p class="panel-heading">
Call for input</p>
<p class="panel-body">
If you do know how to do this with a custom (non-lambda) function, please let
me know in the comments.</p>
</div>
<p>Unfortunately, I could not figure out how to do something similar with a custom function that
takes arguments. I’m hoping that I am missing something and that a reader will point it out.
In the meantime, here is the approach I use to combine multiple custom functions into a single DataFrame.</p>
<p>First create two datasets of the various weighted averages:</p>
<div class="highlight"><pre><span class="n">data_1</span> <span class="o">=</span> <span class="n">sales</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">"Manager"</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">wavg</span><span class="p">,</span> <span class="s">"New_Product_Price"</span><span class="p">,</span> <span class="s">"Quantity"</span><span class="p">)</span>
<span class="n">data_2</span> <span class="o">=</span> <span class="n">sales</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">"Manager"</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">wavg</span><span class="p">,</span> <span class="s">"Current_Price"</span><span class="p">,</span> <span class="s">"Quantity"</span><span class="p">)</span>
</pre></div>
<p>Then combine them into a single DataFrame and give it a meaningful label:</p>
<div class="highlight"><pre><span class="n">summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">s1</span><span class="o">=</span><span class="n">data_1</span><span class="p">,</span> <span class="n">s2</span><span class="o">=</span><span class="n">data_2</span><span class="p">))</span>
<span class="n">summary</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s">"New Product Price"</span><span class="p">,</span><span class="s">"Current Product Price"</span><span class="p">]</span>
<span class="n">summary</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
<div>
<table border="1" class="table table-condensed">
<thead>
<tr>
<th/>
<th>New Product Price</th>
<th>Current Product Price</th>
</tr>
<tr>
<th>Manager</th>
<th/>
<th/>
</tr>
</thead>
<tbody>
<tr>
<th>Debra Henley</th>
<td>372.646104</td>
<td>340.665584</td>
</tr>
<tr>
<th>Fred Anderson</th>
<td>377.142857</td>
<td>344.897959</td>
</tr>
</tbody>
</table>
</div><p>I have actually found myself using this pattern in several different scenarios
so I’m hoping it is useful to others as well.</p>
</div>
<div class="section" id="using-numpy">
<h2>Using Numpy</h2>
<p>As I mentioned above, Numpy has an <a class="reference external" href="http://docs.scipy.org/doc/numpy-1.10.1/reference/generated/numpy.average.html">average function</a> which can take a list of weights
and calculate a weighted average.</p>
<p>Here is how to use it to get the weighted average for all the ungrouped data:</p>
<div class="highlight"><pre><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">sales</span><span class="p">[</span><span class="s">"Current_Price"</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">sales</span><span class="p">[</span><span class="s">"Quantity"</span><span class="p">])</span>
</pre></div>
<pre class="literal-block">
342.54068716094031
</pre>
<p>If you want to call this on grouped data, you would need to build a <code class="code">
lambda</code>
 function:</p>
<div class="highlight"><pre><span class="n">sales</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">"Manager"</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s">'New_Product_Price'</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="s">'Quantity'</span><span class="p">]))</span>
</pre></div>
<pre class="literal-block">
Manager
Debra Henley     372.646104
Fred Anderson    377.142857
dtype: float64
</pre>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>Sometimes when I’m working with pandas, I know something is possible but get stuck
on a minor implementation detail that trips me up. The process I describe above
shows one example of how I worked through a relatively simple math problem and
built a robust solution in pandas that can work on grouped or ungrouped data.
The principals shown here can be used to build your own complex formulas for
your own needs. If you would prefer looking at this in a notebook, you can find
it on <a class="reference external" href="https://github.com/chris1610/pbpython/blob/master/notebooks/Learn_Pandas-Weighted_Average.ipynb">github</a>.</p>
<p>Thanks for reading and if you have any input or suggestions, feel free to comment below.</p>
</div>

  </div>
  
</div></body></html>