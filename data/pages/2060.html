<html><body><div><div class="entry-content"><p>I have a love/hate relationship with live updates on web applications, partly because they’re usually a hassle to get right and partly due to their often needing major re-plumbing to work at all.</p>
<blockquote>
<p>If you’re just tuning in, this is the second post <a href="/space/blog/2013/08/11/2300" class="wiki" title="blog/2013/08/11/2300 was updated 2 years, 5 months ago">in a somewhat erratic series</a> that I’ve been meaning to write.</p>
</blockquote>
<p>Most people reach for <code>socket.io</code> or WebSockets for various reasons, but the truth is that unless you’re trying to do something like collaborative editing or real-time multi-player gaming, they’re overkill and a royal pain to get working properly with both your target audience <em>and</em> your current web server and back-end stack. Furthermore, 95% of the time these things are used for _uni_directional communication.</p>
<p>Which is why I much prefer <a href="http://caniuse.com/#feat=eventsource" title="external link to http://caniuse.com/#feat=eventsource" class="http" rel="http://caniuse.com/#feat=eventsource">Server-Sent Events</a> — it works fabulously for sending continuous updates to most browsers, and with <a href="https://github.com/remy/polyfills/commit/2eca9ca3149dbe03efde2f7d8a07d7c292b80829" title="secure link to https://github.com/remy/polyfills/commit/2eca9ca3149dbe03efde2f7d8a07d7c292b80829" class="https" rel="https://github.com/remy/polyfills/commit/2eca9ca3149dbe03efde2f7d8a07d7c292b80829">the right polyfill</a> it will fall back to polling even on extreme conditions like the server (or network) going away and returning.</p>
<p>Of course you still need to maintain a live connection for each client, etc., but at least it’s standard HTTP and you don’t have to fiddle with a separate server<sup id="fnref:1"><a class="anchor" href="/space/blog/2014/11/16/1940#fn:1" rel="/space/blog/2014/11/16/1940#fn:1" title="link to fn:1 in this page">1</a></sup>.</p>
<p>I’ve had a lot of fun playing around with <a href="https://github.com/rcarmo/raspi-cluster/tree/master/dashboard" title="secure link to https://github.com/rcarmo/raspi-cluster/tree/master/dashboard" class="https" rel="https://github.com/rcarmo/raspi-cluster/tree/master/dashboard">live updating dashboards</a> for kicks in <a href="/space/dev/Golang" class="wiki" title="dev/Golang was updated 1 month, 1 week ago">Go</a> and <a href="/space/dev/Java" class="wiki" title="dev/Java was updated 1 month, 3 weeks ago">Java</a>, but of late I’ve wanted a simple, straightforward <a href="/space/dev/Python" class="wiki" title="dev/Python was updated 7 months, 1 week ago">Python</a>-based solution I could integrate with on my <a href="/space/blog/2013/08/11/2300" class="wiki" title="blog/2013/08/11/2300 was updated 2 years, 5 months ago">standard project template</a> (which, incidentally, I’ve been <a href="https://github.com/rcarmo/ink-bottle" title="secure link to https://github.com/rcarmo/ink-bottle" class="https" rel="https://github.com/rcarmo/ink-bottle">tweaking on Github</a>).</p>
<p>And this week I’ve been toying with the notion of building a front-end to our room reservation system using <a href="/space/com/Google/Android" class="wiki" title="com/Google/Android was updated 1 year, 6 months ago">Android</a> devices, so I decided to jot down a few notes on how I managed to provide live updates to those.</p>
<h2 id="making-the-bottle-last">Making The Bottle Last</h2>
<p>First off, how do we cope with persistent connections? Well, that’s easy enough: I use <a href="http://projects.unbit.it/uwsgi/" title="external link to http://projects.unbit.it/uwsgi/" class="http" rel="http://projects.unbit.it/uwsgi/">uWSGI</a> with <a href="http://www.gevent.org/" title="external link to http://www.gevent.org/" class="http" rel="http://www.gevent.org/">gevent</a> workers (or <a href="http://gunicorn.org/" title="external link to http://gunicorn.org/" class="http" rel="http://gunicorn.org/">gunicorn</a> on older setups), but getting a standalone <a href="http://bottlepy.org/" title="external link to http://bottlepy.org/" class="http" rel="http://bottlepy.org/">Bottle</a> server going for development is as easy as: </p>
<div class="syntax"><pre><span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">run</span>
<span class="kn">from</span> <span class="nn">gevent</span> <span class="kn">import</span> <span class="n">monkey</span><span class="p">;</span> <span class="n">monkey</span><span class="o">.</span><span class="n">patch_all</span><span class="p">()</span>

<span class="c"># ... your code here</span>

<span class="n">run</span><span class="p">(</span><span class="n">server</span><span class="o">=</span><span class="s">"gevent"</span><span class="p">)</span>
</pre></div>
<h2 id="pushing-events">Pushing Events</h2>
<p>Now for the clever bits. First off, we need to pack replies in <code>header: value</code> format, with events separated by an extra newline:</p>
<div class="syntax"><pre><span class="k">def</span> <span class="nf">sse_pack</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="sd">"""Pack data in SSE format"""</span>
    <span class="nb">buffer</span> <span class="o">=</span> <span class="s">''</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'retry'</span><span class="p">,</span><span class="s">'id'</span><span class="p">,</span><span class="s">'event'</span><span class="p">,</span><span class="s">'data'</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="nb">buffer</span> <span class="o">+=</span> <span class="s">'</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="se">\n</span><span class="s">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
    <span class="k">return</span> <span class="nb">buffer</span> <span class="o">+</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span>
</pre></div>
<p>Next we need a way to keep sending events while the connection is open. </p>
<p>Fortunately, <a href="http://bottlepy.org/" title="external link to http://bottlepy.org/" class="http" rel="http://bottlepy.org/">Bottle</a> running under <a href="http://www.gevent.org/" title="external link to http://www.gevent.org/" class="http" rel="http://www.gevent.org/">gevent</a> will gleefully take a <a href="/space/dev/Python" class="wiki" title="dev/Python was updated 7 months, 1 week ago">Python</a> generator and keep piping whatever you <code>yield</code> into the open socket, so the rest is merely a matter of incrementing event IDs and keeping state consistent:</p>
<div class="syntax"><pre><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">get</span><span class="p">,</span> <span class="n">route</span>

<span class="nd">@get</span><span class="p">(</span><span class="s">"/stream"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">stream_generator</span><span class="p">():</span>
    <span class="c"># Keep event IDs consistent</span>
    <span class="n">event_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="s">'Last-Event-Id'</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
        <span class="n">event_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">'Last-Event-Id'</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c"># Set up our message payload with a retry value in case of connection failure</span>
    <span class="c"># (that's also the polling interval to be used as fallback by our polyfill)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'retry'</span><span class="p">:</span> <span class="s">'2000'</span>
    <span class="p">}</span>

    <span class="c"># Provide an initial data dump to each new client</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">'content-type'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'text/event-stream'</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">'Access-Control-Allow-Origin'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'*'</span>
    <span class="n">msg</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
         <span class="s">'event'</span><span class="p">:</span> <span class="s">'init'</span><span class="p">,</span>
         <span class="s">'data'</span> <span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">get_current_shared_state</span><span class="p">()),</span>
         <span class="s">'id'</span>   <span class="p">:</span> <span class="n">event_id</span>
    <span class="p">})</span>
    <span class="k">yield</span> <span class="n">sse_pack</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c"># Now give them deltas as they arrive (say, from a message broker)</span>
    <span class="n">event_id</span> <span class="o">+=</span> <span class="mi">1</span>    
    <span class="n">msg</span><span class="p">[</span><span class="s">'event'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'delta'</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="c"># block until you get new data (from a queue, pub/sub, zmq, etc.)</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
             <span class="s">'event'</span><span class="p">:</span> <span class="s">'delta'</span><span class="p">,</span>
             <span class="s">'data'</span> <span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">queue</span><span class="o">.</span><span class="n">recv</span><span class="p">()),</span>
             <span class="s">'id'</span>   <span class="p">:</span> <span class="n">event_id</span>
        <span class="p">})</span>
        <span class="k">yield</span> <span class="n">sse_pack</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">event_id</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
<p>I’ve done this kind of thing so far with <a href="http://redis.io" title="external link to http://redis.io" class="http" rel="http://redis.io">Redis</a> pubsub, <a href="http://mqtt.org" title="external link to http://mqtt.org" class="http" rel="http://mqtt.org">MQTT</a> brokers, <a href="http://zeromq.org" title="external link to http://zeromq.org" class="http" rel="http://zeromq.org">0MQ</a> sockets, you name it — you might need to do a little more work if you’re not getting your client updates from a blocking mechanism, but this is the gist of things.</p>
<h2 id="dealing-with-cors">Dealing With CORS</h2>
<p>But what if you’re providing this stream to a statically-hosted single-page app? </p>
<p>(As I was, yesterday afternoon, live editing the HTML on <a href="http://meocloud.pt" title="external link to http://meocloud.pt" class="http" rel="http://meocloud.pt">MEO Cloud</a> and gathering events from my laptop.)</p>
<p>Well, that’s easy enough: <a href="http://enable-cors.org" title="external link to http://enable-cors.org" class="http" rel="http://enable-cors.org">CORS</a>-compliant browsers will issue an <code>OPTIONS</code> request to your server before actually requesting the event stream, so we can tell them it’s OK to have requests come in from pages hosted in other domains and specify which headers they are allowed to use:</p>
<div class="syntax"><pre><span class="nd">@route</span><span class="p">(</span><span class="s">"/stream"</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">"OPTIONS"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">options</span><span class="p">():</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s">'Access-Control-Allow-Origin'</span><span class="p">:</span> <span class="s">'*'</span><span class="p">,</span>
        <span class="s">'Access-Control-Allow-Methods'</span><span class="p">:</span> <span class="s">'GET, OPTIONS'</span><span class="p">,</span>
        <span class="s">'Access-Control-Allow-Headers'</span><span class="p">:</span> <span class="s">'X-REQUESTED-WITH, CACHE-CONTROL, LAST-EVENT-ID'</span><span class="p">,</span>
        <span class="s">'Content-Type'</span><span class="p">:</span> <span class="s">'text/plain'</span>
    <span class="p">})</span>
    <span class="k">return</span> <span class="s">''</span>
</pre></div>
<p>In case you’re curious, those are the headers the <a href="/space/com/Google/Android" class="wiki" title="com/Google/Android was updated 1 year, 6 months ago">Android</a> 4.2 stock <code>WebView</code> requires for <code>EventSource</code> to work in this scenario.</p>

<p>That’s a bit out of scope here, but here’s the gist of things: </p>
<div class="syntax"><pre><span class="kd">function</span> <span class="nx">init</span><span class="p">(</span><span class="nx">conf</span><span class="p">,</span> <span class="nx">app</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">source</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventSource</span><span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">debug</span><span class="p">)</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Binding event source"</span><span class="p">);</span>

    <span class="nx">source</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'init'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"model:init"</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
    <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>

    <span class="nx">source</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'delta'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"view:update"</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
    <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>

    <span class="nx">source</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'error'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="nx">EventSource</span><span class="p">.</span><span class="nx">CLOSED</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"view:networkError"</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="nx">e</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="nx">EventSource</span><span class="p">.</span><span class="nx">OPEN</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"feedback:connecting"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>As you can see, it’s mostly a matter of matching server-sent events to my single-page app triggers. </p>
<p>The above is using <a href="https://muut.com/riotjs/" title="secure link to https://muut.com/riotjs/" class="https" rel="https://muut.com/riotjs/">RiotJS</a>, which I’m rather partial to these days because I can build a simple single-page app using it and <a href="http://zeptojs.com" title="external link to http://zeptojs.com" class="http" rel="http://zeptojs.com">Zepto</a> with templating, a sane MVC approach and observables that fits <em>completely</em> under 50KB of code<sup id="fnref:2"><a class="anchor" href="/space/blog/2014/11/16/1940#fn:2" rel="/space/blog/2014/11/16/1940#fn:2" title="link to fn:2 in this page">2</a></sup>, so I’m sticking to it for simple, elegant stuff.</p>
<p>And that’s it for tonight. Next up, functional patterns or sane approaches to threading, depending on what I have on my plate.</p>
</div>
</div></body></html>