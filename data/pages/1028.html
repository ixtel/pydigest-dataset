<html><body><div><div class="content">
      
        <h1 class="content-title">Playing with Python Magic Methods to make a nicer Regex API</h1>
      
      
      
  <div class="post-info"><p>
    
    
      July 19, 2014 11:24
      </p><span class="separator">/</span>
      <a href="#comments">5 comments</a>
      <span class="separator">/</span>
      
        <a href="/blog/tags/python/">python</a>
      
        <a href="/blog/tags/regex/">regex</a>
      
    
  </div>
  
  
    <p><a href="http://media.charlesleifer.com/blog/photos/p1405787444.31.png" title="p1405787444.31.png"><img alt="p1405787444.31.png" class="img-responsive" src="http://m.charlesleifer.com/t/800x-/blog/photos/p1405787444.31.png?key=s405q5nWm-fCVDQIY3T3rw"/></a></p>
<p>A co-worker of mine mentioned that he missed Ruby's syntactic sugar for
regular expressions. I haven't used Ruby's regular expressions, but I'm
familiar enough with Python's to know that the API is a bit wanting in
syntactic sweetness.</p>
<p>First, retrieving capture groups from a regular expression requires two
steps. In the first step you need to call either <code>match()</code> or <code>search()</code>
and assign the result to a variable. Then, you need to check whether the
result is not <code>None</code> (indicating no match was found). Finally, if a match
exists, you can safely extract the captured groups. Here is an example:</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">re</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">match_obj</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">'([0-9]+)'</span><span class="p">,</span> <span class="s1">'123foo'</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">match_obj</span>  <span class="c1"># What is `match_obj`?</span>
<span class="go">&lt;_sre.SRE_Match object at 0x7fd1bb000828&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">match_obj</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
<span class="go">('123',)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">match_obj</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">'([0-9]+)'</span><span class="p">,</span> <span class="s1">'abc'</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">match_obj</span>
<span class="go">None</span>
</pre></div>
<p>It would be nicer, in my opinion, to have something like:</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">re</span><span class="o">.</span><span class="n">get_matches</span><span class="p">(</span><span class="s1">'([0-9]+)'</span><span class="p">,</span> <span class="s1">'123foo'</span><span class="p">)</span>
<span class="go">('123',)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">re</span><span class="o">.</span><span class="n">get_matches</span><span class="p">(</span><span class="s1">'([0-9]+)'</span><span class="p">,</span> <span class="s1">'abc'</span><span class="p">)</span>
<span class="go">None</span>
</pre></div>
<p>The other thing I frequently run into is mixing up the parameters for <code>re.sub</code>,
which performs find-and-replace. The required parameters, in order, are <code>pattern</code>,
<code>replacement</code>, <code>search_string</code>. For whatever reason, it seems more intuitive to me to
have <code>search_string</code> come before replacement.</p>
<p>Unfortunately, mangling these parameters can lead to "correct-looking" results.
Here is an example. The goal here will be to replace the word <code>foo</code> with the
word <code>bar</code>.</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">,</span> <span class="s1">'replace foo with bar'</span><span class="p">,</span> <span class="s1">'bar'</span><span class="p">)</span>
<span class="go">'bar'</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">,</span> <span class="s1">'bar'</span><span class="p">,</span> <span class="s1">'replace foo with bar'</span><span class="p">)</span>
<span class="go">'replace bar with bar'</span>
</pre></div>
<p>In the first example, we might presume that the input string was just <code>"foo"</code>.</p>
<h3>Sugar</h3>
<p>For fun, I put together a little helper class that adds some syntactic sweetness
to python's regular expression library. I don't really suggest that anyone should
use this, but it was fun to make and maybe it will give you some ideas on how you
might improve the syntax of other libraries.</p>
<p>Before I show you the implementation, here are some examples of the API I
devised.</p>
<p>Searching for matches is a single-step operation:</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">has_lower</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">R</span><span class="o">/</span><span class="s1">'[a-z]+'</span><span class="o">/</span><span class="n">s</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">has_lower</span><span class="p">(</span><span class="s1">'This contains lower-case'</span><span class="p">)</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">has_lower</span><span class="p">(</span><span class="s1">'NO LOWER-CASE HERE!'</span><span class="p">)</span>
<span class="go">False</span>
</pre></div>
<p>Retrieving capture-groups is also easy:</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="nb">list</span><span class="p">(</span><span class="n">R</span><span class="o">/</span><span class="s1">'([0-9]+)'</span><span class="o">/</span><span class="s1">'extract 12 the 456 numbers'</span><span class="p">)</span>
<span class="go">['12', '456']</span>
</pre></div>
<p>Finally, you can use the division operator one more time to perform replacements:</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">R</span><span class="o">/</span><span class="s1">'(foo|bar)'</span><span class="o">/</span><span class="s1">'replace foo and bar'</span><span class="o">/</span><span class="s1">'Huey!'</span>
<span class="go">'replace Huey! and Huey!'</span>
</pre></div>
<p>What do you think? More fun?</p>
<h3>Implementation</h3>
<p>The implementation is pretty straightforward and relies on Python's magic methods
to provide the API. If there's a neat trick, it is the use of metaclasses to
implement what is essentially a <em>classmethod</em> operator overload.</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">re</span>

<span class="k">class</span> <span class="nc">_R</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__div__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regex</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">R</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">R</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">_R</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regex</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__div__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">RegexOperation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_regex</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">RegexOperation</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regex</span><span class="p">,</span> <span class="n">search</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_regex</span> <span class="o">=</span> <span class="n">regex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_search</span> <span class="o">=</span> <span class="n">search</span>

    <span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">match</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_search</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_search</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__div__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">replacement</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_regex</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">replacement</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_regex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_search</span><span class="p">))</span>
</pre></div>
<p>Stepping through the operations one-by-one, hopefully it will clarify what is
going on behind-the-scenes.</p>
<p>Calling <code>R / &lt;something&gt;</code> will invoke the <code>__div__</code> method on the <code>_R</code> class,
which is basically a factory method for creating <code>R</code> instances:</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">R</span><span class="o">/</span><span class="s1">'foo'</span>
<span class="go">&lt;rx.R at 0x7f77c00831d0&gt;</span>
</pre></div>
<p>Then, invoking <code>__div__</code> on the newly-created <code>R</code> object, we get a <code>RegexOperation</code>
instance, so <code>R.__div__</code> is <em>another</em> factory method.</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">r_obj</span> <span class="o">=</span> <span class="n">R</span><span class="o">/</span><span class="s1">'foo'</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">r_obj</span> <span class="o">/</span> <span class="s1">'bar'</span>
<span class="go">&lt;rx.RegexOperation at 0x7f77c00837d0&gt;</span>
</pre></div>
<p>The final object, <code>RegexOperation</code>, implements several magic methods which allow
us to retrieve matches, perform substitions, and test for the existence of a match.</p>
<h3>Thanks for reading</h3>
<p>Thanks for taking the time to read this post, I hope you found this interesting! Feel free to <a href="#comments">leave a comment</a> below.</p>
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  


<hr/>

  <p>Commenting has been closed, but please feel free to <a href="/contact/">contact me</a></p>


    </div>

    </div></body></html>