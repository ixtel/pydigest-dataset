<html><body><div><div class="post-body entry-content" id="post-body-78783341073607978">
<b>The case</b>

<p>
You have a server application which needs to upload some files to a specific folder in Google Drive which is owned by someone (e.g., by you).
</p>

<b>Preface</b>

<p>
I have spent lot of time, trying to figure out how to do it. It was a really big quest, besause:

</p><ol>
<li>Google has tons of docs on their API.</li>
<li>Those docs are really useless: lots of words without specifics.</li>
<li>Docs have many cross-references which might point to nowhere or to some place which is out of date.</li>
<li>It's hard to get links to some important places, e.g. to the list of available API scopes.</li>
<li>Auth for non-humans is poorly documented and can be a pain.</li>
<li>Your "Google account" and your "Service account" are quite different things, so they might seem to have different file storages, hence, this requires some work with permissions.</li>
</ol>


<p>
For example, docs for GitHub API are not big, but they clear and loud.
</p>

<b>The real part</b>

<p>
So, to start you will need to:

</p><ol>
<li>Sign in to your Google account.</li>
<li>Go to <a href="https://console.developers.google.com/">Google API Console</a>.</li>
<li>Create new project.</li>
<li>Click to "APIs &amp; auth" of the left side panel.</li>
<li>Click "APIs", search for "Drive API" and enable it.</li>
<li>ClicK "Credentials" and "Create new Client ID".</li>
<li>Select "Service account" and create new Client ID.</li>
<li>You will be automatically prompted to download your private key in 'PKCS12' format.</li>
<li>Password for accessing it will be shown in pop-up. You may never need it, but it's better to put it to some secret place.</li>
<li>Download that key and keep it private on your system.</li>
<li>After that you will see "Client ID" and "Email address" for your application.</li>
<li>Go to you Google Drive. Create some folder, and open "Sharing settings" for it.</li>
<li>Add your service email to the list of allowed users and allow it to edit the contents of that folder.</li>
<li>Remember folder ID somewhere.</li>
</ol>


<div class="info_snippet">
<p><b>NOTE:</b> Sharing your folder with service account is just a special case. I'm not sure if it's fully secure to use service email, as it contains a significant part of Client ID. I think, it's ok, if you and only you can see the list of permissions.</p>

<p>You can store your files in the storage of your service account. You will need to read API docs for sharing and changing permissions to make files accessible even by you (I gave up at this point).</p>
</div>


<div class="info_snippet">
<p>
Be attentive while copying service email. Don't grab some extra whitespaces or new lines.
</p>
</div>


<b>Enter the code</b>

<p>
Now, you can write some code. Let's start from imports:
</p>

<code data-gist-id="6eb98d0944c41bcb5fcc" data-gist-file="google_drive_api.py" data-gist-line="4-10"/>

<p>Here you can see 2 non-standard packages are used: 'apiclient' and 'oauth2client'. They are a part of '<a href="https://pypi.python.org/pypi/google-api-python-client">google-api-python-client</a>'. You can install it by running:</p>

<code data-gist-id="6eb98d0944c41bcb5fcc" data-gist-file="misc.sh" data-gist-line="1"/>

<p>
However, to make 'SignedJwtAssertionCredentials' work you will need to use <a href="http://google-api-python-client.googlecode.com/hg/docs/epy/oauth2client.client.SignedJwtAssertionCredentials-class.html">PyOpenSSL, or PyCrypto 2.6 or later</a>. You can choose any of them, but read notes below.
</p>

<p>
PyOpenSSL is might be already present in your system. If you need to use it inside your virtualenv (I hope, you need), then create a link:
</p>

<code data-gist-id="6eb98d0944c41bcb5fcc" data-gist-file="misc.sh" data-gist-line="3"/>

<p>
You may use 'PyCrypto' directly, but it does not work with 'PKCS12' format. So, you will need to convert your private key to something understandable for 'PyCrypto':
</p>

<code data-gist-id="6eb98d0944c41bcb5fcc" data-gist-file="misc.sh" data-gist-line="5-6"/>

<p>
This will convert 'PKCS12' to 'PEM', but that's not all: you will need to <a href="http://stackoverflow.com/a/24618630/1159558">manually strip</a> "Bag Attributes" and "Key Attributes" from it.
</p>

<p>
Let's define some constants for our example:
</p>

<code data-gist-id="6eb98d0944c41bcb5fcc" data-gist-file="google_drive_api.py" data-gist-line="13-34"/>

<div class="warning_snippet">
<p>
This is just an example. Never ever hardcode your API keys and secrets. Load them from environment, or from JSON file with secrets or wheresoever.
</p>
</div>

<p>
To use API for Google services you will need to get a 'service' object. This is
done in same manner for all services:
</p>

<code data-gist-id="6eb98d0944c41bcb5fcc" data-gist-file="google_drive_api.py" data-gist-line="37-55"/>

<p>
File uploading consists of defining body, media body and invoking 'insert' method:
</p>

<code data-gist-id="6eb98d0944c41bcb5fcc" data-gist-file="google_drive_api.py" data-gist-line="58-67"/>

<p>
Let's try this out and upload some text file:
</p>

<code data-gist-id="6eb98d0944c41bcb5fcc" data-gist-file="google_drive_api.py" data-gist-line="70-81"/>

<p>
This will print an URL which can be used by humans for sharing. You may use 'pprint' to see all response:
</p>

<code data-gist-id="6eb98d0944c41bcb5fcc" data-gist-file="misc.py"/>

<div class="info_snippet">
<p>
Upset with having no full example? Don't worry, of course I'll share it with you: <a href="https://gist.github.com/oblalex/6eb98d0944c41bcb5fcc#file-google_drive_api-py">see full example</a>.
</p>
</div>
<p/>
</div>
</div></body></html>