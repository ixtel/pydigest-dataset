<html><body><div><div class="entry-content padding-bottom">
            <p>A few months ago, I wrote
<a href="https://julien.danjou.info/blog/2013/guide-python-static-class-abstract-methods">the definitive guide about Python method declaration</a>,
which had quite a good success. I still fight every day in
<a href="http://openstack.org">OpenStack</a> to have the developers declare their methods
correctly in the patches they submit.</p>
<h1>Automation plan</h1>
<p>The thing is, I really dislike doing the same things over and over again.
Furthermore, I'm not perfect either, and I miss a lot of these kind of problems
in the reviews I made. So I decided to replace me by a program â a more
scalable and less error-prone version of my brain.</p>
<p>In OpenStack, we rely on <em><a href="http://flake8.readthedocs.org/en/2.2.3/">flake8</a></em> to
do static analysis of our Python code in order to spot common programming
mistakes.</p>
<p>But we are really pedantic, so we wrote some extra hacking rules that we
enforce on our code. To that end, we wrote a <em>flake8</em> extension called
<em><a href="https://pypi.python.org/pypi/hacking">hacking</a></em>. I really like these rules, I
even recommend to apply them in your own project. Though I might be biased or
victim of Stockholm syndrome. Your call.</p>
<p>Anyway, it's pretty clear that I need to add a check for method declaration in
<em>hacking</em>. Let's write a <em>flake8</em> extension!</p>
<h1>Typical error</h1>
<p>The typical error I spot is the following:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span><br/>    <span class="c"># self is not used, the method does not need</span><br/>    <span class="c"># to be bound, it should be declared static</span><br/>    <span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span><br/>        <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">-</span> <span class="n">c</span><br/></pre></div>

<p><br/>
That would be the correct version:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span><br/>    <span class="nd">@staticmethod</span><br/>    <span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span><br/>        <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">-</span> <span class="n">c</span><br/></pre></div>

<p><br/>
This kind of mistake is not a show-stopper. It's just not optimized. Why you
have to manually declare static or class methods might be a language issue, but
I don't want to debate about Python misfeatures or design flaws.</p>
<h1>Strategy</h1>
<p>We could probably use some big magical regular expression to catch this
problem. <em>flake8</em> is based on the <em><a href="https://pypi.python.org/pypi/pep8">pep8</a></em>
tool, which can do a line by line analysis of the code. But this method would
make it very hard and error prone to detect this pattern.</p>
<p>Though it's also possible to do an <acronym title="Abstract Syntax&#10;Tree">AST</acronym> based analysis on on a per-file basis with <em>pep8</em>. So
that's the method I pick as it's the most solid.</p>
<h1>AST analysis</h1>
<p>I won't dive deeply into Python AST and how it works. You can find plenty of
sources on the Internet, and I even talk about it a bit in my book
<em><a href="https://julien.danjou.info/books/the-hacker-guide-to-python">The Hacker's Guide to Python</a></em>.</p>
<p><img src="/media/images/blog/2015/python-ast.png" class="illustration"/></p>
<p>To check correctly if all the methods in a Python file are correctly declared,
we need to do the following:</p>
<ul>
<li>Iterate over all the statement node of the AST</li>
<li>Check that the statement is a class definition (<code>ast.ClassDef</code>)</li>
<li>Iterate over all the function definitions (<code>ast.FunctionDef</code>) of that class
  statement to check if it is already declared with <code>@staticmethod</code> or not</li>
<li>If the method is not declared static, we need to check if the first argument
  (<code>self</code>) is used somewhere in the method</li>
</ul>
<h1><em>Flake8</em> plugin</h1>
<p>In order to register a new plugin in <em>flake8</em> via <em>hacking</em>, we just need to
add an entry in <code>setup.cfg</code>:</p>
<div class="highlight"><pre><span class="k">[entry_points]</span><br/><span class="na">flake8.extension</span> <span class="o">=</span><span class="s"/><br/><span class="s">    [âŚ]</span><br/><span class="s">    H904 = hacking.checks.other:StaticmethodChecker</span><br/><span class="s">    H905 = hacking.checks.other:StaticmethodChecker</span><br/></pre></div>

<p><br/>
We register 2 <em>hacking</em> codes here. As you will notice later, we are actually
going to add an extra check in our code for the same price. Stay tuned.</p>
<p>The next step is to write the actual plugin. Since we are using an AST based
check, the plugin needs to be a class following a certain signature:</p>
<div class="highlight"><pre><span class="nd">@core.flake8ext</span><br/><span class="k">class</span> <span class="nc">StaticmethodChecker</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span><br/>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span><br/>        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="n">tree</span><br/> <br/>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><br/>        <span class="k">pass</span><br/></pre></div>

<p><br/>
So far, so good and pretty easy. We store the tree locally, then we just need
to use it in <code>run()</code> and <code>yield</code> the problem we discover following <code>pep8</code>
expected signature, which is a tuple of <code>(lineno, col_offset, error_string,
code)</code>.</p>
<h1>This AST is made for walking âŞ âŹ âŠ</h1>
<p>The <code>ast</code> module provides the <code>walk</code> function, that allow to iterate easily on
a tree. We'll use that to run through the AST. First, let's write a loop that
ignores the statement that are not class definition.</p>
<div class="highlight"><pre><span class="nd">@core.flake8ext</span><br/><span class="k">class</span> <span class="nc">StaticmethodChecker</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span><br/>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span><br/>        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="n">tree</span><br/> <br/>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><br/>        <span class="k">for</span> <span class="n">stmt</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="p">):</span><br/>            <span class="c"># Ignore non-class</span><br/>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">ClassDef</span><span class="p">):</span><br/>                <span class="k">continue</span><br/></pre></div>

<p><br/>
We still don't check for anything, but we know how to ignore statement that are
not class definitions. The next step need to be to ignore what is not function
definition. We just iterate over the attributes of the class definition.</p>
<div class="highlight"><pre><span class="k">for</span> <span class="n">stmt</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="p">):</span><br/>    <span class="c"># Ignore non-class</span><br/>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">ClassDef</span><span class="p">):</span><br/>        <span class="k">continue</span><br/>    <span class="c"># If it's a class, iterate over its body member to find methods</span><br/>    <span class="k">for</span> <span class="n">body_item</span> <span class="ow">in</span> <span class="n">stmt</span><span class="o">.</span><span class="n">body</span><span class="p">:</span><br/>        <span class="c"># Not a method, skip</span><br/>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body_item</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">):</span><br/>            <span class="k">continue</span><br/></pre></div>

<p><br/>
We're all set for checking the method, which is <code>body_item</code>. First, we need to
check if it's already declared as static. If so, we don't have to do any
further check and we can bail out.</p>
<div class="highlight"><pre><span class="k">for</span> <span class="n">stmt</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="p">):</span><br/>    <span class="c"># Ignore non-class</span><br/>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">ClassDef</span><span class="p">):</span><br/>        <span class="k">continue</span><br/>    <span class="c"># If it's a class, iterate over its body member to find methods</span><br/>    <span class="k">for</span> <span class="n">body_item</span> <span class="ow">in</span> <span class="n">stmt</span><span class="o">.</span><span class="n">body</span><span class="p">:</span><br/>        <span class="c"># Not a method, skip</span><br/>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body_item</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">):</span><br/>            <span class="k">continue</span><br/>        <span class="c"># Check that it has a decorator</span><br/>        <span class="k">for</span> <span class="n">decorator</span> <span class="ow">in</span> <span class="n">body_item</span><span class="o">.</span><span class="n">decorator_list</span><span class="p">:</span><br/>            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">decorator</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span><br/>               <span class="ow">and</span> <span class="n">decorator</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s">'staticmethod'</span><span class="p">):</span><br/>                <span class="c"># It's a static function, it's OK</span><br/>                <span class="k">break</span><br/>        <span class="k">else</span><span class="p">:</span><br/>            <span class="c"># Function is not static, we do nothing for now</span><br/>            <span class="k">pass</span><br/></pre></div>

<p><br/>
Note that we use the special <code>for/else</code> form of Python, where the <code>else</code> is
evaluated unless we used <code>break</code> to exit the <code>for</code> loop.</p>
<div class="highlight"><pre><span class="k">for</span> <span class="n">stmt</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="p">):</span><br/>    <span class="c"># Ignore non-class</span><br/>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">ClassDef</span><span class="p">):</span><br/>        <span class="k">continue</span><br/>    <span class="c"># If it's a class, iterate over its body member to find methods</span><br/>    <span class="k">for</span> <span class="n">body_item</span> <span class="ow">in</span> <span class="n">stmt</span><span class="o">.</span><span class="n">body</span><span class="p">:</span><br/>        <span class="c"># Not a method, skip</span><br/>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body_item</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">):</span><br/>            <span class="k">continue</span><br/>        <span class="c"># Check that it has a decorator</span><br/>        <span class="k">for</span> <span class="n">decorator</span> <span class="ow">in</span> <span class="n">body_item</span><span class="o">.</span><span class="n">decorator_list</span><span class="p">:</span><br/>            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">decorator</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span><br/>               <span class="ow">and</span> <span class="n">decorator</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s">'staticmethod'</span><span class="p">):</span><br/>                <span class="c"># It's a static function, it's OK</span><br/>                <span class="k">break</span><br/>        <span class="k">else</span><span class="p">:</span><br/>            <span class="k">try</span><span class="p">:</span><br/>                <span class="n">first_arg</span> <span class="o">=</span> <span class="n">body_item</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><br/>            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span><br/>                <span class="k">yield</span> <span class="p">(</span><br/>                    <span class="n">body_item</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span><br/>                    <span class="n">body_item</span><span class="o">.</span><span class="n">col_offset</span><span class="p">,</span><br/>                    <span class="s">"H905: method misses first argument"</span><span class="p">,</span><br/>                    <span class="s">"H905"</span><span class="p">,</span><br/>                <span class="p">)</span><br/>                <span class="c"># Check next method</span><br/>                <span class="k">continue</span><br/></pre></div>

<p><br/>
We finally added some check! We grab the first argument from the method
signature. Unless it fails, and in that case, we know there's a problem: you
can't have a bound method without the <code>self</code> argument, therefore we raise the
<code>H905</code> code to signal a method that misses its first argument.</p>
<p>Now you know why we registered this second <code>pep8</code> code along with <code>H904</code> in
<code>setup.cfg</code>. We have here a good opportunity to kill two birds with one stone.</p>
<p>The next step is to check if that first argument is used in the code of the
method.</p>
<div class="highlight"><pre><span class="k">for</span> <span class="n">stmt</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="p">):</span><br/>    <span class="c"># Ignore non-class</span><br/>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">ClassDef</span><span class="p">):</span><br/>        <span class="k">continue</span><br/>    <span class="c"># If it's a class, iterate over its body member to find methods</span><br/>    <span class="k">for</span> <span class="n">body_item</span> <span class="ow">in</span> <span class="n">stmt</span><span class="o">.</span><span class="n">body</span><span class="p">:</span><br/>        <span class="c"># Not a method, skip</span><br/>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body_item</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">):</span><br/>            <span class="k">continue</span><br/>        <span class="c"># Check that it has a decorator</span><br/>        <span class="k">for</span> <span class="n">decorator</span> <span class="ow">in</span> <span class="n">body_item</span><span class="o">.</span><span class="n">decorator_list</span><span class="p">:</span><br/>            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">decorator</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span><br/>               <span class="ow">and</span> <span class="n">decorator</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s">'staticmethod'</span><span class="p">):</span><br/>                <span class="c"># It's a static function, it's OK</span><br/>                <span class="k">break</span><br/>        <span class="k">else</span><span class="p">:</span><br/>            <span class="k">try</span><span class="p">:</span><br/>                <span class="n">first_arg</span> <span class="o">=</span> <span class="n">body_item</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><br/>            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span><br/>                <span class="k">yield</span> <span class="p">(</span><br/>                    <span class="n">body_item</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span><br/>                    <span class="n">body_item</span><span class="o">.</span><span class="n">col_offset</span><span class="p">,</span><br/>                    <span class="s">"H905: method misses first argument"</span><span class="p">,</span><br/>                    <span class="s">"H905"</span><span class="p">,</span><br/>                <span class="p">)</span><br/>                <span class="c"># Check next method</span><br/>                <span class="k">continue</span><br/>            <span class="k">for</span> <span class="n">func_stmt</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">body_item</span><span class="p">):</span><br/>                <span class="k">if</span> <span class="n">six</span><span class="o">.</span><span class="n">PY3</span><span class="p">:</span><br/>                    <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">func_stmt</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span><br/>                       <span class="ow">and</span> <span class="n">first_arg</span><span class="o">.</span><span class="n">arg</span> <span class="o">==</span> <span class="n">func_stmt</span><span class="o">.</span><span class="n">id</span><span class="p">):</span><br/>                        <span class="c"># The first argument is used, it's OK</span><br/>                        <span class="k">break</span><br/>                <span class="k">else</span><span class="p">:</span><br/>                    <span class="k">if</span> <span class="p">(</span><span class="n">func_stmt</span> <span class="o">!=</span> <span class="n">first_arg</span><br/>                       <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func_stmt</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span><br/>                       <span class="ow">and</span> <span class="n">func_stmt</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">first_arg</span><span class="o">.</span><span class="n">id</span><span class="p">):</span><br/>                        <span class="c"># The first argument is used, it's OK</span><br/>                        <span class="k">break</span><br/>            <span class="k">else</span><span class="p">:</span><br/>                <span class="k">yield</span> <span class="p">(</span><br/>                    <span class="n">body_item</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span><br/>                    <span class="n">body_item</span><span class="o">.</span><span class="n">col_offset</span><span class="p">,</span><br/>                    <span class="s">"H904: method should be declared static"</span><span class="p">,</span><br/>                    <span class="s">"H904"</span><span class="p">,</span><br/>                <span class="p">)</span><br/></pre></div>

<p><br/>
To that end, we iterate using <code>ast.walk</code> again and we look for the use of the
same variable named (usually <code>self</code>, but if could be anything, like <code>cls</code> for
<code>@classmethod</code>) in the body of the function. If not found, we finally yield the
<code>H904</code> error code. Otherwise, we're good.</p>
<h1>Conclusion</h1>
<p>I've
<a href="https://review.openstack.org/#/c/151952/">submitted this patch to <em>hacking</em></a>,
and, finger crossed, it might be merged one day. If it's not I'll create a new
Python package with that check for flake8. The actual submitted code is a bit
more complex to take into account the use of
<a href="https://docs.python.org/2/library/abc.html"><code>abc</code></a> module and include some
tests.</p>
<p>As you may have notice, the code walks over the module AST definition several
times. There might be a couple of optimization to browse the AST in only one
pass, but I'm not sure it's worth it considering the actual usage of the tool.
I'll let that as an exercise for the reader interested in contributing to
OpenStack. đ</p>
<p>Happy hacking!</p>          </div>

          </div></body></html>