<html><body><div><div class="post-body entry-content" id="post-body-6250490712144819404" itemprop="description articleBody"><p>
On my other blog, prooffreader.com, I </p><a href="http://www.prooffreader.com/2014/11/projections-of-white-christmases-until.html" target="_blank">posted an animated GIF</a><p> of projected White Christmases between now and the year 2100, based on NetCDF files from the Canadian Centre for Climate Modeling and Analysis. There are plenty of examples of NetCDF with Basemap out there, but the CCCma's format was a little different, so I thought I'd post this here in case it's helpful to anyone.
</p><p>
Links:
</p><ul>
<li><a href="https://github.com/Prooffreader/Misc_ipynb/tree/master/CCCma" target="_blank">Github repo</a> with this script and the one I used to make the animated GIF with the nice background</li>
<li><a href="http://nbviewer.ipython.org/github/Prooffreader/Misc_ipynb/blob/master/CCCma/CCCma_Basemap.ipynb" target="_blank">nbviewer version</a> of this script in nice IPython format.</li>
</ul>
<p>
<br/></p>

<div class="inner_cell">
<p class="text_cell_render border-box-sizing rendered_html">
<h1 id="mapping-canadian-center-for-climate-modeling-and-analysis-cccma-netcdf-files-with-basemap">
Mapping Canadian Centre for Climate Modeling and Analysis (CCCma) NetCDF files with Basemap</h1>
<br/>
<h5 id="by-david-taylor-www-prooffreader-com">
By David Taylor, www.prooffreader.com</h5>
<br/>
There are plenty of tutorials about Basemap using NetCDF (.nc) files, but CCCma files are in a special format. It took me a while to get everything working, so I thought I'd share my code in case anyone else is in the same situation.<br/>
<br/>
Note that the only datasets I've tried this on are from the <code>Fourth Generation Canadian Regional Climate Model (CanRCM4) &gt; Second Generation Earth System Model (CanESM2) &gt; RCP 8.5</code> category. I do not know if other models have their NetCDF files and data within organized the same way; tweaking may be necessary.<br/>
<br/>
Note that although this data is from Environment Canada, climate models from around the world can be found.<br/></p>
</div>
<div class="cell border-box-sizing text_cell rendered">
<p class="prompt input_prompt">
</p>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="1.-Download-NetCDF-(.nc)-files-from-Environment-Canada">
 <br/>1. Download NetCDF (.nc) files from Environment Canada<a class="anchor-link" href="https://www.blogger.com/blogger.g?blogID=5173881455069640622#1.-Download-NetCDF-(.nc)-files-from-Environment-Canada">¶</a></h3>
</div>
</div>
</div>

<div class="cell border-box-sizing text_cell rendered">
<p class="prompt input_prompt">
</p>
<div class="inner_cell">
<p class="text_cell_render border-box-sizing rendered_html">
<h3 id="2-choose-what-file-and-day-you-wish-to-use">
 <br/>2. Choose what file and day you wish to use</h3>
This will be the only cell you need to enter values into. All the other cells can just be run, they will reference these values.<br/><br/>
</p>
</div>
</div>

<div>
<pre>my_filename <span>=</span> (<span>'snc_NAM-44_CCCma-CanESM2_rcp85_r1i1p1_'</span>
    <span>'CCCma-CanRCM4_r2_day_20410101-20451231.nc'</span>)
<span># for this demo, we will see where it will be a white christmas in 2041.</span>
my_year, my_month, my_day <span>=</span> (<span>2041</span>, <span>12</span>, <span>25</span>)
</pre>
</div>


<div>
<pre><span># calculations based on the above values:</span>

<span># to increase compatibility with Python 3.x:</span>
<span>from</span> <span>__future__</span> <span>import</span> print_function
<span>import</span> <span>re</span>

<span># extracts variable name from beginning of filename:</span>
my_variable <span>=</span> my_filename[:my_filename<span>.</span>find(<span>'_'</span>)]

<span>print</span>(<span>"my_variable = {}"</span><span>.</span>format(my_variable))

first_year <span>=</span> <span>int</span>(re<span>.</span>search((<span>'([12][90][0-9]{2})[01][0-9]'</span>
    <span>'[0-3][0-9]\-[12][90][0-9]{2}[01][0-9][0-3][0-9]\.nc'</span>), 
    my_filename)<span>.</span>group(<span>1</span>))
<span>print</span>(<span>"first year in .nc file = {}"</span><span>.</span>format(first_year))

month_lengths <span>=</span> (<span>0</span>,<span>31</span>,<span>28</span>,<span>31</span>,<span>30</span>,<span>31</span>,<span>30</span>,<span>31</span>,<span>31</span>,<span>30</span>,<span>31</span>,<span>30</span>)
month_cumulative <span>=</span> []
counter <span>=</span> <span>0</span>
<span>for</span> length <span>in</span> month_lengths:
    counter <span>+=</span> length
    month_cumulative<span>.</span>append(counter)
<span>print</span>(<span>"month_cumulative = {}"</span><span>.</span>format(month_cumulative))
      
days_elapsed <span>=</span> (<span>365</span> <span>*</span> (my_year <span>-</span> first_year) <span>+</span> 
                month_cumulative[my_month <span>-</span> <span>1</span>] <span>+</span> my_day)
<span>print</span>((<span>"{} days elapsed between Jan. 1, {} and specified date "</span>
       <span>"of {}-{}-{}"</span>)<span>.</span>format(days_elapsed, first_year, 
                           my_year, my_month, my_day))
<span>print</span>(<span>"(leap days are not counted)"</span>)
</pre>
</div>
<p>
Output:
</p><pre><b>
&gt; my_variable = snc
&gt; first year in .nc file = 2041
&gt; month_cumulative = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334]
&gt; 359 days elapsed between Jan. 1, 2041 and specified date of 2041-12-25
(leap days are not counted)
</b>
</pre>
<h3 id="3.-Extract-data-from-.nc-file">
3. Extract data from .nc file<a class="anchor-link" href="https://www.blogger.com/blogger.g?blogID=5173881455069640622#3.-Extract-data-from-.nc-file">¶</a></h3>

<div>
<pre><span>import</span> <span>netCDF4</span>
<span># netCDF4 is not part of standard Python,</span>
<span># you may have to download and install it</span>
<span>import</span> <span>numpy</span> <span>as</span> <span>np</span>

ncfile <span>=</span> netCDF4<span>.</span>Dataset(my_filename, <span>'r'</span>)
<span># note that you'll have to download the file yourself</span>

<span># Let's have a look at this file.</span>
<span>print</span>(<span>"Attributes:"</span>)
<span>print</span>(ncfile<span>.</span>ncattrs())
<span>print</span>(<span>"</span><span>\n</span><span>Variables:"</span>)
<span>print</span>(ncfile<span>.</span>variables)
</pre>
</div>
<p>
Output:
</p><pre><b>
&gt; Attributes:
[u'title', u'institution', u'institute_id', u'contact', u'Conventions', u'experiment', u'experiment_id', u'driving_experiment', u'driving_model_id', u'driving_model_ensemble_member', u'driving_experiment_name', u'forcing', u'model_id', u'creation_date', u'rcm_version_id', u'project_id', u'CORDEX_domain', u'frequency', u'product', u'CCCma_runid', u'references', u'history', u'data_licence']

&gt; Variables:
OrderedDict([(u'time', &lt;netCDF4.Variable object at 0x0000000003B986A8&gt;), (u'rlon', &lt;netCDF4.Variable object at 0x0000000003B98730&gt;), (u'rlat', &lt;netCDF4.Variable object at 0x0000000003B987B8&gt;), (u'lon', &lt;netCDF4.Variable object at 0x0000000003B98840&gt;), (u'lat', &lt;netCDF4.Variable object at 0x0000000003B988C8&gt;), (u'rotated_pole', &lt;netCDF4.Variable object at 0x0000000003B98950&gt;), (u'snc', &lt;netCDF4.Variable object at 0x0000000003B989D8&gt;)])

</b></pre>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>
We are interested in the following variables:</p>
<ul>
<li>lon: an array of longitudes for a 130 x 155 grid</li>
<li>lat: an array of latitudes for a 130 x 155 grid</li>
</ul><p>
Note: the grid is made up of cells approximately 0.44 degrees on a side, but the grid is not exactly aligned north-south or east-west; that is why there are 130x155 each of longitude and latitude
</p><p>
snc: a 1825x130x155 grid of snow cover from 0 to 100 percent.
</p><p>
The first dimension is time, measured in days since December 1, 1949 NOT INCLUDING LEAP DAYS. In other words, there are exactly 36500 days between December 1, 1949 and December 1, 2049.
</p><p>
In the 'time' variable, which we do not need to use, the first value is 33246.5 days (half a day is added to make the time noon, which is unambiguously in the middle of the day instead of at the cusp between two days). We will verify this in the next cell.</p></div>
</div>

<div>
<pre><span>import</span> <span>netCDF4</span>
<span># netCDF4 is not part of standard Python,</span>
<span># you may have to download and install it</span>
<span>import</span> <span>numpy</span> <span>as</span> <span>np</span>

ncfile <span>=</span> netCDF4<span>.</span>Dataset(my_filename, <span>'r'</span>)
<span># note that you'll have to download the file yourself</span>

<span># Let's have a look at this file.</span>
<span>print</span>(<span>"Attributes:"</span>)
<span>print</span>(ncfile<span>.</span>ncattrs())
<span>print</span>(<span>"</span><span>\n</span><span>Variables:"</span>)
<span>print</span>(ncfile<span>.</span>variables)
</pre>
</div>
<p>
Output:
</p><pre><b>
&gt; Shape of nc_lons: (130L, 155L)
&gt; Shape of nc_lons: (130L, 155L)
&gt; Shape of nc_vars before specifying day: (1825L, 130L, 155L)
&gt; Shape of nc_vars after specifying day: (130L, 155L)
&gt; Starting day of file: 33246.5

</b></pre>
<h3>
4. Plot map with Basemap</h3>

<div>
<pre><span>from</span> <span>mpl_toolkits.basemap</span> <span>import</span> Basemap
<span>import</span> <span>matplotlib.pyplot</span> <span>as</span> <span>plt</span>
<span>%</span>matplotlib inline

fig <span>=</span> plt<span>.</span>figure(figsize<span>=</span>(<span>8</span>,<span>8</span>))
ax <span>=</span> fig<span>.</span>add_axes([<span>0.1</span>,<span>0.1</span>,<span>0.8</span>,<span>0.8</span>])
m <span>=</span> Basemap(width<span>=</span><span>6000000</span>,height<span>=</span><span>4000000</span>,
            resolution<span>=</span><span>'l'</span>,projection<span>=</span><span>'stere'</span>,\
            lon_0<span>=-</span><span>93</span>,lat_0<span>=</span><span>41</span>, area_thresh<span>=</span><span>1000</span>)
m<span>.</span>drawlsmask(land_color<span>=</span><span>'#00441b'</span>,ocean_color<span>=</span><span>'#8be5e5'</span>,
             lakes<span>=</span><span>True</span>)
m<span>.</span>drawcoastlines()
m<span>.</span>drawstates()
m<span>.</span>drawcountries()
parallels <span>=</span> np<span>.</span>arange(<span>0.</span>, <span>90</span>, <span>10.</span>)
m<span>.</span>drawparallels(parallels,labels<span>=</span>[<span>1</span>,<span>0</span>,<span>0</span>,<span>0</span>],fontsize<span>=</span><span>10</span>)
meridians <span>=</span> np<span>.</span>arange(<span>180.</span>,<span>360.</span>,<span>10.</span>)
m<span>.</span>drawmeridians(meridians,labels<span>=</span>[<span>0</span>,<span>0</span>,<span>0</span>,<span>1</span>],fontsize<span>=</span><span>10</span>)
x, y <span>=</span> m(nc_lons, nc_lats)
clevs <span>=</span> <span>range</span>(<span>1</span>,<span>101</span>)
cs <span>=</span> m<span>.</span>contourf(x,y,nc_vars,clevs,cmap<span>=</span>plt<span>.</span>cm<span>.</span>Greens_r)
cbar <span>=</span> m<span>.</span>colorbar(cs,location<span>=</span><span>'bottom'</span>,pad<span>=</span><span>"5%"</span>)
cbar<span>.</span>set_label(<span>'</span><span>% s</span><span>now cover'</span>)
plt<span>.</span>title(<span>'Snow cover projected on Dec. 25, 2041'</span>)
plt<span>.</span>show()
</pre>
</div>
<p>
Output:
</p>
<p/>
</div>
</div></body></html>