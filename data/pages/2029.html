<html><body><div><div class="section" id="scenario">
<h3>Scenario</h3>
<p>Here's the scenario we are going to implement.</p>
<p>Say you're implementing a REST API (also known as a hypermedia API).</p>
<p>You want to support the URL (hostname info omitted):</p>
<pre class="literal-block">
/customers/{id}
</pre>
<p>When you access it with a <tt class="docutils literal">GET</tt> request, you get JSON describing the
customer with the given id, or if it doesn't exist, 404 Not Found.</p>
<p>There's also the URL:</p>
<pre class="literal-block">
/customers
</pre>
<p>This represents a collection of customers. You want to be able to
<tt class="docutils literal">GET</tt> it and get some JSON information about the customers back.</p>
<p>Moreover, you want to <tt class="docutils literal">POST</tt> JSON to it that represents a new
customer, to add it a customer to the collection.</p>
<p>The customer JSON at <tt class="docutils literal"><span class="pre">/customers/{id}</span></tt> looks like this:</p>
<pre class="literal-block">
{
  "@id": "/customers/0",
  "@type": "Customer",
  "name": "Joe Shopper"
}
</pre>
<p>What's this <tt class="docutils literal">@id</tt> and <tt class="docutils literal">@type</tt> business? They're just conventions
(though I took them took from the <a class="reference external" href="http://json-ld.org/">JSON-LD</a> standard). <tt class="docutils literal">@id</tt> is a
link to the customer itself, which also uniquely identifies this
customer. <tt class="docutils literal">@type</tt> describes the type of this object.</p>
<p>The customer collection JSON at <tt class="docutils literal">/customers</tt> looks like this:</p>
<pre class="literal-block">
{
  "@id": "/customers",
  "@type": "CustomerCollection"
  "customers": ['/customers/0', '/customers/1'],
  "add": "/customers",
}
</pre>
<p>When you POST a new customer <tt class="docutils literal">@id</tt> is not needed, but it gets added
after <tt class="docutils literal">POST</tt>. The response to a POST should be JSON representing the
new customer we just POSTed, but now with the <tt class="docutils literal">@id</tt> added.</p>
</div>
<div class="section" id="implementing-this-scenario-with-morepath">
<h3>Implementing this scenario with Morepath</h3>
<p>First we define a class <tt class="docutils literal">Customer</tt> that defines the customer. In a
real-world application this is backed by some database, perhaps using
an ORM like SQLAlchemy, but we'll keep it simple here:</p>
<pre class="code python literal-block">
<span class="k">class</span> <span class="nc">Customer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># we will set it after creation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
</pre>
<p><tt class="docutils literal">Customer</tt> doesn't know anything about the web at all; it shouldn't
have to.</p>
<p>Then there's a <tt class="docutils literal">CustomerCollection</tt> that represents a collection of
<tt class="docutils literal">Customer</tt> objects. Again in the real world it would be backed by
some database, and implemented in terms of database operations to
query and add customers, but here we show a simple in-memory
implementation:</p>
<pre class="code python literal-block">
<span class="k">class</span> <span class="nc">CustomerCollection</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">customers</span> <span class="o">=</span> <span class="p">{}</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">id_counter</span> <span class="o">=</span> <span class="mi">0</span>

     <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">customers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

     <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer</span><span class="p">):</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">customers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">id_counter</span><span class="p">]</span> <span class="o">=</span> <span class="n">customer</span>
         <span class="c"># here we set the id</span>
         <span class="n">customer</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_counter</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">id_counter</span> <span class="o">+=</span> <span class="mi">1</span>
         <span class="k">return</span> <span class="n">customer</span>

<span class="n">customer_collection</span> <span class="o">=</span> <span class="n">CustomerCollection</span><span class="p">()</span>
</pre>
<p>We register this collection at the path <tt class="docutils literal">/customers</tt>:</p>
<pre class="code python literal-block">
<span class="nd">@App.path</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">CustomerCollection</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s">'/customers'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_customer_collection</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">customer_collection</span>
</pre>
<p>We register <tt class="docutils literal">Customer</tt> at the path <tt class="docutils literal"><span class="pre">/customers/{id}</span></tt>:</p>
<pre class="code python literal-block">
<span class="nd">@App.path</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">Customer</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s">'/customers/{id}'</span>
          <span class="n">converters</span><span class="o">=</span><span class="p">{</span><span class="s">'id'</span><span class="p">:</span> <span class="nb">int</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">get_customer</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">customer_collection</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</pre>
<p>See the <tt class="docutils literal">converters</tt> bit we did there? This makes sure that the
<tt class="docutils literal">{id}</tt> variable is converted from a string into an integer for you
automatically, as internally we use integer ids.</p>
<p>We now register a <tt class="docutils literal">dump_json</tt> that can transform the <tt class="docutils literal">Customer</tt>
object into <tt class="docutils literal">JSON</tt>:</p>
<pre class="code python literal-block">
<span class="nd">@App.dump_json</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">Customer</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
   <span class="k">return</span> <span class="p">{</span>
      <span class="s">'@type'</span><span class="p">:</span> <span class="s">'Customer'</span><span class="p">,</span>
      <span class="s">'@id'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
      <span class="s">'name'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
   <span class="p">}</span>
</pre>
<p>Now we are ready to implement a <tt class="docutils literal">GET</tt> (the default) view for
<tt class="docutils literal">Customer</tt>, so that <tt class="docutils literal"><span class="pre">/customer/{id}</span></tt> works:</p>
<pre class="code python literal-block">
<span class="nd">@App.json</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">Customer</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">customer_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span>
</pre>
<p>That's easy! It can just return <tt class="docutils literal">self</tt> and let <tt class="docutils literal">dump_json</tt> take
care of making it be JSON.</p>
<p>Now let's work on the <tt class="docutils literal">POST</tt> of new customers on <tt class="docutils literal">/customers</tt>.</p>
<p>We register a <tt class="docutils literal">load_json</tt> directive that can transform JSON into a
<tt class="docutils literal">Customer</tt> instance:</p>
<pre class="code python literal-block">
<span class="nd">@App.load_json</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">json</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">json</span><span class="p">[</span><span class="s">'@type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'Customer'</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Customer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">json</span><span class="p">[</span><span class="s">'name'</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">json</span>
</pre>
<p>We now can register a view that handles the <tt class="docutils literal">POST</tt> of a new
<tt class="docutils literal">Customer</tt> to the <tt class="docutils literal">CustomerCollection</tt>:</p>
<pre class="code python literal-block">
<span class="nd">@App.json</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">CustomerCollection</span><span class="p">,</span>
          <span class="n">request_method</span><span class="o">=</span><span class="s">'POST'</span><span class="p">,</span>
          <span class="n">body_model</span><span class="o">=</span><span class="n">Customer</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">customer_collection_post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">body_obj</span><span class="p">)</span>
</pre>
<p>This calls the <tt class="docutils literal">add</tt> method we defined on <tt class="docutils literal">CustomerCollection</tt>
before. <tt class="docutils literal">body_obj</tt> is a <tt class="docutils literal">Customer</tt> instance, converted from the
incoming JSON. It returns the resulting <tt class="docutils literal">Customer</tt> instance which is
automatically transformed to JSON.</p>
<p>For good measure let's also define a way to transform the
<tt class="docutils literal">CustomerCollection</tt> into JSON:</p>
<pre class="code python literal-block">
<span class="nd">@App.dump_json</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">CustomerCollection</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">dump_customer_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s">'@id'</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
        <span class="s">'@type'</span><span class="p">:</span> <span class="s">'CustomerCollection'</span><span class="p">,</span>
        <span class="s">'customers'</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">request</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span> <span class="k">for</span> <span class="n">customer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">customers</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="p">],</span>
        <span class="s">'add'</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
    <span class="p">}</span>
</pre>
<p><tt class="docutils literal">request.link</tt> automatically creates the correct links to
<tt class="docutils literal">Customer</tt> instances and the <tt class="docutils literal">CustomerCollection</tt> itself.</p>
<p>We now need to add a <tt class="docutils literal">GET</tt> view for <tt class="docutils literal">CustomerCollection</tt>:</p>
<pre class="code python literal-block">
<span class="nd">@App.json</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">CustomerCollection</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">customer_collection_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span>
</pre>
<p>We done with our implementation. Check out a <a class="reference external" href="https://github.com/morepath/morepath_rest/tree/master/morepath_rest">working example</a> on
Github. To try it out you could use a commandline tool like <tt class="docutils literal">wget</tt>
or <tt class="docutils literal">curl</tt>, or Chrome's Postman extension, for instance.</p>
</div>
<div class="section" id="under-the-hood">
<h3>Under the hood</h3>
<p>Here's the part of the Morepath codebase that implements much of this
behavior:</p>
<pre class="code python literal-block">
<span class="nd">@App.predicate</span><span class="p">(</span><span class="n">generic</span><span class="o">.</span><span class="n">view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'model'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">ClassIndex</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">model_predicate</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">__class__</span>


<span class="nd">@App.predicate_fallback</span><span class="p">(</span><span class="n">generic</span><span class="o">.</span><span class="n">view</span><span class="p">,</span> <span class="n">model_predicate</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">model_not_found</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">HTTPNotFound</span><span class="p">()</span>


<span class="nd">@App.predicate</span><span class="p">(</span><span class="n">generic</span><span class="o">.</span><span class="n">view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'name'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">''</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">KeyIndex</span><span class="p">,</span>
               <span class="n">after</span><span class="o">=</span><span class="n">model_predicate</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">name_predicate</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">view_name</span>


<span class="nd">@App.predicate_fallback</span><span class="p">(</span><span class="n">generic</span><span class="o">.</span><span class="n">view</span><span class="p">,</span> <span class="n">name_predicate</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">name_not_found</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">HTTPNotFound</span><span class="p">()</span>


<span class="nd">@App.predicate</span><span class="p">(</span><span class="n">generic</span><span class="o">.</span><span class="n">view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'request_method'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">'GET'</span><span class="p">,</span>
               <span class="n">index</span><span class="o">=</span><span class="n">KeyIndex</span><span class="p">,</span> <span class="n">after</span><span class="o">=</span><span class="n">name_predicate</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">request_method_predicate</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span>


<span class="nd">@App.predicate_fallback</span><span class="p">(</span><span class="n">generic</span><span class="o">.</span><span class="n">view</span><span class="p">,</span> <span class="n">request_method_predicate</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">method_not_allowed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">HTTPMethodNotAllowed</span><span class="p">()</span>


<span class="nd">@App.predicate</span><span class="p">(</span><span class="n">generic</span><span class="o">.</span><span class="n">view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'body_model'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">object</span><span class="p">,</span>
               <span class="n">index</span><span class="o">=</span><span class="n">ClassIndex</span><span class="p">,</span> <span class="n">after</span><span class="o">=</span><span class="n">request_method_predicate</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">body_model_predicate</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">body_obj</span><span class="o">.</span><span class="n">__class__</span>


<span class="nd">@App.predicate_fallback</span><span class="p">(</span><span class="n">generic</span><span class="o">.</span><span class="n">view</span><span class="p">,</span> <span class="n">body_model_predicate</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">body_model_unprocessable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">HTTPUnprocessableEntity</span><span class="p">()</span>
</pre>
<p>Don't like <tt class="docutils literal">422 Unprocessable Entity</tt> when <tt class="docutils literal">body_model</tt> doesn't
match?  Want <tt class="docutils literal">400 Bad Request</tt> instead? Just override the
<tt class="docutils literal">predicate_fallback</tt> for this in your own application:</p>
<pre class="code python literal-block">
<span class="k">class</span> <span class="nc">MyApp</span><span class="p">(</span><span class="n">morepath</span><span class="o">.</span><span class="n">App</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="nd">@MyApp.predicate_fallback</span><span class="p">(</span><span class="n">generic</span><span class="o">.</span><span class="n">view</span><span class="p">,</span> <span class="n">body_model_predicate</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">body_model_unprocessable_overridden</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">()</span>
</pre>
<p>Want to have views respond to the HTTP <tt class="docutils literal">Accept</tt> header? Add a new
predicate that handles this to your app.</p>
<p>Now what are you waiting for? Try out <a class="reference external" href="http://morepath.readthedocs.org">Morepath</a>!</p>
</div>
</div></body></html>