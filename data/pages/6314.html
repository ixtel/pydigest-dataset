<html><body><div><div class="post-text" itemprop="text">

<p>I'm trying to change the DNS servers on my Mac (10.10.4) using PyObjC (3.0.4).</p>

<p>Everything <em>seems</em> to work: I get an authentication dialog prompting that my program is trying to change network settings, and the commit/apply commands return <code>True</code>, which would indicate they were successful.</p>

<p>However, the system settings aren't actually changed: they remain the same as before. Any idea why they don't "stick"?</p>

<p>The code (standalone, should work if you have a recent version of PyObjC installed):</p>

<pre class="lang-py prettyprint-override"><code>#!/usr/bin/env python

import  objc
from    SystemConfiguration import *

# Open dynamic store and get primary interface
store = SCDynamicStoreCreate(None, 'MyApp', None, None)
primaryif = SCDynamicStoreCopyValue(store, 'State:/Network/Global/IPv4')['PrimaryInterface']
if primaryif:
    print "Using %s as primary interface" % primaryif
else:
    raise "Can't find primary interface"

# Load SecurityInterface framework to provide SFAuthorization
objc.initFrameworkWrapper(
    frameworkName       = "SecurityInterface",
    frameworkIdentifier = "com.apple.securityinterface",
    frameworkPath       = objc.pathForFramework("/System/Library/Frameworks/SecurityInterface.framework"),
    globals             = globals()
)

# Access system preferences
preferences = SCPreferencesCreateWithAuthorization(None, 'MyApp', None, SFAuthorization.authorization().authorizationRef())

# Lock preferences
SCPreferencesLock(preferences, True)

# Get list of network services
networkSet = SCNetworkSetCopyCurrent(preferences)
networkSetServices = SCNetworkSetCopyServices(networkSet)

# Find the network service that belongs to the primary interface
for networkService in networkSetServices:
    interface = SCNetworkServiceGetInterface(networkService)
    if primaryif != SCNetworkInterfaceGetBSDName(interface):
        continue

    # Load currently configured DNS servers
    networkProtocol = SCNetworkServiceCopyProtocol(networkService, kSCNetworkProtocolTypeDNS)
    DNSDict = SCNetworkProtocolGetConfiguration(networkProtocol) or {}

    # Set new DNS servers
    DNSDict[kSCPropNetDNSServerAddresses] = [ '192.168.23.12', '8.8.4.4' ]
    SCNetworkProtocolSetConfiguration(networkService, DNSDict)

    # Unlock, commit and apply preferences
    print "UL", SCPreferencesUnlock(preferences)
    print "CO", SCPreferencesCommitChanges(preferences)
    print "AP", SCPreferencesApplyChanges(preferences)
</code></pre>

<p><strong>EDIT</strong>: most of the above code is based on <a href="https://00f.net/2011/08/14/programmatically-changing-network-configuration-on-osx/">this page</a>, which also suggests "touching" the dynamic store to make the settings stick (the code to do this is commented out right at the end). However, it doesn't seem to do anything.</p>

<p><strong>EDIT #2</strong>: by disassembling <code>/usr/sbin/networksetup</code> I'm getting the idea that I need a set of specific rights (<code>system.services.systemconfiguration.network</code>) before any changes are accepted.</p>
    </div>
    </div></body></html>