<html><body><div><div class="content html_format">
      <p>
Цены на жильё формируются из многочисленных факторов, основные из которых — это близость к центру города и наличие рядом различной инфраструктуры. Но реальные цены только в бумажных газетах и риэлторских сайтах. Мы будем строить свою карту с ценами на недвижимость в Москве при помощи python, яндекс API и matplotlib, специальный репортаж с места событий под катом.
</p><a name="habracut"/>
<h3>Гипотеза</h3><p>
Как человек, не проживающий в москве, характер цен в москве оцениваю следующим образом:
</p><ul>
<li><b>очень дорого</b> — в пределах садового кольца</li>
<li><b>дорого </b> — от садового кольца до ТТК </li>
<li><b>не очень дорого</b> — между ТТК и МКАД, а цена линейно убывает в сторону МКАДа</li>
<li><b>дешево </b> — за МКАДом</li>
</ul><p>
На карте будут присутствовать локальные максимумы и минимумы в связи с близостью важных объектов или промышленных зон. А также будет разрыв в ценах до МКАДа и после, т.к. это кольцо в основном совпадает с административной границей города.
</p><p>
Сотни строчек великолепного и не очень python-кода будут доступны в конце статьи по ссылке.
</p><p>
Для исследований я взял два сайта о недвижимости с данными за лето этого года. Всего в выборке участвовали 24,000 записей о новостройках и вторичном жилье, причём разные объявления с одним адресом усреднялись по цене.
</p><p>
Объявления парсились скриптом и хранились в sqlite базе данных в формате:
</p><code>широта, долгота, цена за кв.м.<br/>
</code>

<div class="spoiler"><b class="spoiler_title">О веб пауках</b><div class="spoiler_text"><p>Да, из-за недостатка знаний, никаких сторонних библиотек не было использовано и это повлекло за собой создание двух отдельных скриптов по одному на каждый сайт, дёргающих адреса, метраж и стоимость квартир. Адреса волшебным образом превращались в координаты посредством Google Geocoder API. Но из-за довольно низкой планки </p><a href="https://developers.google.com/maps/documentation/geocoding/intro">квоты </a><p>на использование был вынужден запускать скрипт каждый день в течении недели. Геокодер яндекса в 10 раз </p><a href="https://tech.yandex.ru/maps/geocoder/">бесплатнее </a><p>.
</p></div></div>

<h3>Строим функцию</h3><p>
Для обобщения функции на всю плоскость её необходимо проинтерполировать по имеющимся точкам. Для этого подойдёт функция </p><code>LinearNDInterpolator</code><p> из модуля scipy. Для этого только необходимо установить python с наобором научных библиотек, известный как scipy. В случае, когда данные очень разнородны, практически невозможно подобрать правдоподобную функцию на плоскости. Метод </p><code>LinearNDInterpolator</code><p> использует триангуляцию </p><a href="https://ru.wikipedia.org/wiki/%D0%A2%D1%80%D0%B8%D0%B0%D0%BD%D0%B3%D1%83%D0%BB%D1%8F%D1%86%D0%B8%D1%8F_%D0%94%D0%B5%D0%BB%D0%BE%D0%BD%D0%B5">Делоне</a><p>, разбивая всю плоскость на множество треугольников.
</p><p>
Важный фактор, который нужно учитывать при построении функций — разброс значений функции. Среди объявлений попадаются настоящие монстры с ценой за квадратный метр больше 10 млн. рублей </p><s>внутри кремля</s><p>, они испортят график и вы увидите лишь однородное поле с яркой точкой. Для того, чтобы на графике можно было различить практически все данные, такие значения нужно отфильтровывать границей, подбираемой эмпирическим путём. Для статистической модели эти значения не несут полезной информации.
</p><p>
А тем временем, результат интерполяции выглядит как градиентный ад (кликабельно):

</p><a href="https://habrastorage.org/files/409/250/352/409250352b374770b2f58b198fba51fa.png"/>
<p>
Чтобы получить удобную для восприятия карту, нужно распределить полученные значения на дискретные уровни. После чего карта становится похожей на страничку из атласа за 7й класс (кликабельно):

</p><a href="https://habrastorage.org/files/023/fc2/8e1/023fc28e1ecc4f32a7b1354740bf0aa1.png"/>

<div class="spoiler"><b class="spoiler_title">О дискретизации на карте</b><div class="spoiler_text"><p>В зависимости от того, хотим мы видеть общую картину цен или флуктуации вблизи среднего значения, необходимо применить </p><a href="https://ru.wikipedia.org/wiki/%D0%9A%D0%BE%D0%BC%D0%BF%D0%B0%D0%BD%D0%B4%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5">компадирование</a><p> данных, т.е. распределение данных равномернее на шкалу значений, уменьшая больше значения и увеличивая маленькие. В коде это выглядит так:
</p><pre><code class="python">    zz = np.array(map(lambda x: map(lambda y: int(2*(0.956657*math.log(y) - 10.6288)) , x), zz)) #HARD    
    zz = np.array(map(lambda x: map(lambda y: int(2*(0.708516*math.log(y) - 7.12526)) , x), zz)) #MEDIUM  
    zz = np.array(map(lambda x: map(lambda y: int(2*(0.568065*math.log(y) - 5.10212)) , x), zz)) #LOW  
</code></pre><p>
Функции подбирались эмпирическим путём при помощи аппроксимации по 3м-4м точкам на </p><a href="http://www.wolframalpha.com/input/?i=fit+%7B200000%2C1.8%7D%2C%7B500000%2C2.4%7D%2C%7B1500000%2C3%7D%2C+%7B2000000%2C+3.1%7D">wolframalpha</a><p>.
</p></div></div>
<p>
Стоит заметить, что метод линейной интерполяции не может делать расчёт значений за пределами граничных точек. Тем самым на графике с достаточном большим масштабом мы увидим оченьмногоугольник. Масштаб необходимо выбрать таким образом, чтобы график был полностью вписан в получившуюся фигуру.
</p><p>
Другим взглядом на статистику может послужить карта с областями низких и высоких цен. Динамически варьируя границу разбиения на низкие и высокие цены мы сможем увидеть положение цен в динамике. Значение цены в каждой точке уже не будет играть роли, вклад вносит только кучность точек той или иной группы (кликабельно).

</p><a href="https://habrastorage.org/files/3c9/c91/4c2/3c9c914c28164751b300be2be506b40f.png"/>
<p>
Расчёты похожи на расчёт гравитационного поля в точке. Для оптимизации будем брать в расчёт только те точки, которые действительно вносят вклад в конечное значение поля. После расчётов, результат напоминает брызги (кликабельно).

</p><a href="https://habrastorage.org/files/415/deb/05d/415deb05dd4f40f4b650b9d0c38bbcbd.png"/>

<div class="spoiler"><b class="spoiler_title">Какое ещё преобразование?</b><p class="spoiler_text">При строгом построении графика поля, на нём видно россыпь точек, соответствующих локальному преобладанию “дорогого” поля над “недорогим” и наоборот. Эти точки похожи на шум и портят график. Убрать их можно, например, медианным фильтром над изображением с достаточном большим значением. Для этого я использовал командный интерфейс программы IrfanView.<br/>
</p></div>

<h3>Визуализация</h3><p>
Совмести полученные изображения со схематичной картой Москвы. Яндекс API позволяет взять карту по координатам и указать для неё угловые размеры по долготе и широте, а так же желаемый размер изображения.
</p><p>
Пример запроса:
</p><code><a href="http://static-maps.yandex.ru/1.x/?ll=37.5946002"/>static-maps.yandex.ru/1.x/?ll=37.5946002,55.7622764&amp;spn=0.25,0.25&amp;size=400,400&amp;l=map<br/>
</code>
<p>
Проблема заключается только в том, что указанные угловые размеры определяют не границы видимой области, а её гарантируемый размер. Это значит, что мы получим картинку с угловыми размерами &gt;= 0.25. Способа совладать с границами видимых координат обнаружено не было, и они искались вручную.

</p><div class="spoiler"><b class="spoiler_title">О подгониане</b><p class="spoiler_text">Выровнять карты друг относительно друга можно при помощи яндекс меток, рисуя точки на карте с заданными координатами и получая карту с метками.<br/>
</p></div><p>
За пару вызовов из библиотеки PIL изображения совмещаются с комфортными для наблюдения уровнями прозрачности.

</p><pre><code class="python">map_img = Image.open(map_img_name, 'r').convert('RGBA')
price_img = Image.open(prices_img_name, 'r').convert('RGBA')
if price_img.size == map_img.size:
    result_img = Image.blend(map_img, price_img, 0.5)
</code></pre>

<h3>Результаты</h3><p>
Три изображения с разными уровнями компандирования и анимация варианта с полем.

</p><img src="https://habrastorage.org/files/162/bff/c77/162bffc77f6945158ae22e2fd87b7f88.png"/> <img src="https://habrastorage.org/files/26b/45f/351/26b45f3514254b14837f72f8ebaa12b5.png"/> <img src="https://habrastorage.org/files/3ac/b5f/415/3acb5f4153ba4caeb38f2675f51b9ee1.png"/> <img src="https://habrastorage.org/files/490/88e/44a/49088e44ad6547e59fc1357adeb88c33.gif"/>

<h5>Немного аналитики:</h5><p>
В целом, как и предсказывала гипотеза, внутри садового кольца и кольца ТТК цены на жильё максимальны и убывают по мере удаления от центра. Однако в пределах МКАД, средняя цена сохраняется в западной и юго-западной частях. За пределами МКАД, а так же в восточной части за ТТК цена ниже средней.
</p><p>
В деталях всё намного интересней, отметим основные области:
</p><ul>
<li><s>В лужниках и воробьёвых горах жить довольно дорого</s> жилой недвижимости в области воробьёвых гор нет, скорее все область была построена по граничным значениям сверху и снизу</li>
<li>Жилые массивы вблизи фундаментальной библиотеки МГУ, строящиеся и построенные высотки у мосфильмовского пруда стоят дороже предположительно из-за активной стройки и обширных лесопарковых участков. Высокая цена на территории от мемориальной синагоги и сквером им. Анны Герман так же обусловлена окружающими ценами и своим местоположением среди парков и заказника.</li>
<li>В районе между станцией метро “Крылатское” и проспектом Маршала Жукова жильё так же считается дорогим</li>
<li>Несмотря на положение за МКАДом и близостью к кладбищу, дома вдоль улицы Генерала Белобородова отличаются высокой ценой.</li>
</ul><p>
Как видно на картах, теория вполне подтверждается практикой и удачное сочетание инфраструктуры, расстояния до центра и близости к известным московским сооружениям будет выявлено функцией линейной интерполяции над координатами.
</p><p>
К сожалению, проделанная работа во многом не автоматизируется, но если статья будет интересной хабровчанам, я построю подобные карты остальных больших городов нашей страны.
</p><p>
Код веб пауков, самой программы, а так же использованные базы данных доступны через </p><a href="https://github.com/ajaxtpm/FlatPrices">GitHub</a><p>.
      </p><p class="clear"/>
    </div>

    
  </div></body></html>