<html><body><div><section class="entry">
							                                                        <p><strong>Title :</strong> Python module UrlParse – Improper input validation leads to Open Redirect<br/>
<strong>Credit :</strong> Yassine ABOUKIR<br/>
<strong>CVE :</strong><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-2104"> CVE-2015-2104 </a>(Reserved)<br/>
<strong>Disclosure Date :</strong> 02/24/2015<br/>
<strong>Vendor :</strong> Python Software Foundation (http://www.python.org)<br/>
<strong>Affected versions :</strong> Python 2.7/3.2/3.3/3.4/3.5/3.6<br/>
<strong>CVSS Score :</strong> 4.3 (Medium)</p>
<p><strong>Urlparse module Overview :</strong><br/>
URLparse defines a standard interface to break URL strings up in components (addressing scheme, network location, path etc.).</p>
<blockquote><p><strong><em>&gt;&gt;&gt; from urlparse import urlparse, urlunparse</em></strong><br/>
<strong> <em>&gt;&gt;&gt; urlparse(« http://www.example.com/connect/login »)</em></strong><br/>
<strong> <em>ParseResult(scheme=’http’, netloc=’www.example.com’, path=’/connect/login’, params= », query= », fragment= »)</em></strong></p></blockquote>
<p>urlparse.urlunparse() : this function combines the components of a URL returned by the urlparse() function back to form the original URL.</p>
<p><strong>Vulnerability description and Impact :</strong><br/>
The module urlparse lacks proper validation of the input leading to open redirect vulnerability.<br/>
URLs do not survive the round-trip through  <strong><code>urlunparse(urlparse(url))</code></strong>. Python sees <strong><code>////foo.com</code></strong> as a URL with no hostname or scheme and a path of <strong><code>//foo.com</code></strong>, but when it reconstructs the URL after parsing, it becomes <strong><code>//foo.com</code></strong>.</p>
<p>Consequently, this bug can be practically exploited this way : <a href="http://example.com/login?next=////evil.com">http://www.example.com/login?next=////evil.com</a></p>
<dl class="function">
<dt>
<div>
<p>The user may be subjected to phishing attacks by being redirected to an untrusted and attacker controlled web page that appears to be a trusted web site. The phishers may then steal the user’s credentials and then use these credentials to access the legitimate web site. Because the server name in the modified link is identical to the original site, phishing attempts have a more trustworthy appearance.</p>
<p><strong>Proof Of Concept :</strong></p>
<p><strong><em>&gt;&gt;&gt; x = urlparse(« ////evil.com »)</em></strong></p>
<p>///evil.com will be parsed as relative-path URL which is the correct expected behaviour</p>
<p><strong><em>&gt;&gt;&gt; print x</em></strong><br/>
<strong> <em>&gt;&gt;&gt; ParseResult(scheme= », netloc= », path=’//evil.com’, params= », query= », fragment= »)</em></strong></p>
<p>As you see two slashes are removed and it is marked as a relative-path URL but when we reconstruct the URL using urlunparse() function, the URL is treated as an absolute path.</p>
<p><strong><em>&gt;&gt;&gt; x = urlunparse(urlparse(« ////evil.com »))</em></strong><br/>
<strong> <em>&gt;&gt;&gt; urlparse(x)</em></strong><br/>
<strong> <em>ParseResult(scheme= », netloc=’evil.com’, path= », params= », query= », fragment= »)</em></strong></p>
<p>This vulnerability can be practically exploited this way : https://www.example.com/login<strong>?next=////evil.com</strong></p>
<p/><center><iframe src="https://www.youtube.com/embed/l0uDAqpRPpo" frameborder="0" allowfullscreen="allowfullscreen">VIDEO</iframe></center></div>
<p><strong>Mitigation :</strong></p>
<p> This can be mitigated by checking if the path starts with double slashes and the URL encoding the two leading double slashes. Otherwise, it is recommanded to not use urlunparse(urlparse(url)) to validate a url.</p>
<p/>
<p><strong>References:</strong></p>
<p>https://docs.python.org/2/library/urlparse.html</p>
<p>http://bugs.python.org/issue23505</p>
<p>https://github.com/reddit/reddit/commit/689a9554e60c6e403528b5d62a072ac4a072a20e</p>
<p/>
<p><strong>Greetz :</strong> Thanks to Reddit.com security team for their precious collaboration and help.</p>
</dt>
</dl>

                        </section>
                    </div></body></html>