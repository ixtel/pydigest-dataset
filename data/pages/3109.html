<html><body><div><div class="body"><div itemscope="" itemtype="http://schema.org/Article"><h1 class="title" itemprop="name">Mysql too slow in tests? ramdisk it!</h1><p class="date"> Thu 30 May 2013</p><div itemprop="articleBody"><p>Suppose you're doing it wrong: you're using MySQL and your test suite is slow very slow. MySQL is very slow at DDL statements so creating/clearing/loading that test database all the time is going to be very slow.</p><p>People have worked out some solutions like:</p><ul class="simple"><li>Using TRUNCATE instead of DROP/CREATE and/or other tricks <a class="footnote-reference" href="#id8" id="id1">[1]</a>.</li><li>Fine tunning mysql ... just for development?!? <a class="footnote-reference" href="#id9" id="id2">[2]</a>, <a class="footnote-reference" href="#id10" id="id3">[3]</a>.</li><li>Use <a class="reference external" href="https://docs.djangoproject.com/en/dev/topics/testing/overview/#django.test.TransactionTestCase">TransactionTestCase</a></li><li>Use sqlite in <tt class="docutils literal">:memory:</tt> - very bad idea, lots of subtle bugs won't be catched in the test suite.</li></ul><p>And finally there's one solution that doesn't have the code trade-offs but it's a pain to get it set up: MySQL running on ramdisk (known as tmpfs). I've seen some solutions <a class="footnote-reference" href="#id11" id="id4">[4]</a>, <a class="footnote-reference" href="#id12" id="id5">[5]</a>, <a class="footnote-reference" href="#id13" id="id6">[6]</a>, none worked on Ubuntu (12.04) very well for me thus I've cooked up my own version.</p><p>It's largely based on <a class="footnote-reference" href="#id13" id="id7">[6]</a> but with cleanup code in case you already ran it and added the missing database setup part (you might want to edit the passwords and database names).</p><div class="highlight"><pre><span/><span class="ch">#!/bin/bash -xEe</span>
<span class="nv">i</span><span class="o">=</span><span class="nv">$1</span>

<span class="k">if</span> <span class="o">[</span> -z <span class="s2">"</span>$<span class="s2">i"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="nb">echo</span> <span class="s2">"Missing argument: instance number."</span>
  <span class="nb">exit</span> 1
<span class="k">fi</span>

<span class="nv">port</span><span class="o">=</span>$<span class="o">[</span>3306+$i<span class="o">]</span>
<span class="nv">pid</span><span class="o">=</span><span class="sb">`</span>cat <span class="s2">"/var/run/mysqld/mysqld</span>$<span class="s2">i.pid"</span> <span class="o">||</span> <span class="nb">true</span><span class="sb">`</span>
<span class="k">if</span> <span class="o">[</span> -n <span class="s2">"</span>$<span class="s2">pid"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">kill</span> -9 $pid
    <span class="k">while</span> <span class="nb">kill</span> -0 $pid<span class="p">;</span> <span class="k">do</span>
        sleep 0.5
    <span class="k">done</span>
<span class="k">fi</span>
umount -l <span class="s2">"/var/lib/mysql</span>$<span class="s2">i"</span> <span class="o">||</span> <span class="nb">true</span>
rm -rf <span class="s2">"/var/lib/mysql</span>$<span class="s2">i"</span>
mkdir <span class="s2">"/var/lib/mysql</span>$<span class="s2">i"</span>
mount -t tmpfs -o <span class="nv">size</span><span class="o">=</span>400M tmpfs <span class="s2">"/var/lib/mysql</span>$<span class="s2">i"</span>
chown -R mysql.mysql <span class="s2">"/var/lib/mysql</span>$<span class="s2">i"</span>
mkdir -p <span class="s2">"/var/log/mysql</span>$<span class="s2">i"</span>
chown -R mysql.mysql <span class="s2">"/var/log/mysql</span>$<span class="s2">i"</span>
rm -rf <span class="s2">"/etc/mysql</span>$<span class="s2">i"</span>
cp -R /etc/mysql/ <span class="s2">"/etc/mysql</span>$<span class="s2">i"</span>

<span class="nb">cd</span> <span class="s2">"/etc/mysql</span>$<span class="s2">i/"</span>
sed -i <span class="s2">"s/3306/</span>$<span class="s2">port/g"</span> my.cnf
sed -i <span class="s2">"s/mysqld.sock/mysqld</span>$<span class="s2">i.sock/g"</span> my.cnf
sed -i <span class="s2">"s/mysqld.pid/mysqld</span>$<span class="s2">i.pid/g"</span> my.cnf
sed -i <span class="s2">"s/var\/lib\/mysql/var\/lib\/mysql</span>$<span class="s2">i/g"</span> my.cnf
sed -i <span class="s2">"s/var\/log\/mysql/var\/log\/mysql</span>$<span class="s2">i/g"</span> my.cnf

<span class="k">if</span> <span class="o">[</span> ! -f /etc/apparmor.d/disable/usr.sbin.mysqld <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    touch /etc/apparmor.d/disable/usr.sbin.mysqld
    service apparmor reload
<span class="k">fi</span>

mysql_install_db --user<span class="o">=</span>mysql --datadir<span class="o">=</span><span class="s2">"/var/lib/mysql</span>$<span class="s2">i"</span>
<span class="nv">pass</span><span class="o">=</span><span class="sb">`</span>perl -e <span class="s1">'print map{("a".."z","A".."Z",0..9)[int(rand(62))]}(1..16)'</span><span class="sb">`</span><span class="p">;</span>
mysqld_safe --defaults-file<span class="o">=</span>/etc/mysql$i/my.cnf<span class="p">&amp;</span>
sleep 3
mysqladmin -S /var/run/mysqld/mysqld$i.sock password $pass
cat <span class="s">&lt;&lt;EOF | mysql -uroot -h127.0.0.1 -P$port -p$pass</span>
<span class="s">    USE mysql;</span>
<span class="s">    CREATE DATABASE IF NOT EXISTS app CHARACTER SET utf8 COLLATE utf8_bin;</span>
<span class="s">    CREATE DATABASE IF NOT EXISTS app_tests CHARACTER SET utf8 COLLATE utf8_bin;</span>
<span class="s">    GRANT ALL ON app.* TO 'app'@'localhost' IDENTIFIED BY 'app';</span>
<span class="s">    GRANT ALL ON app_tests.* TO 'app'@'localhost' IDENTIFIED BY 'app';</span>
<span class="s">    GRANT ALL ON *.* TO 'root'@'%' IDENTIFIED BY '$pass';</span>
<span class="s">    FLUSH PRIVILEGES;</span>
<span class="s">EOF</span>
</pre></div><p>It will run on port <tt class="docutils literal">3306 + <span class="pre">instance-number</span></tt>. Also, you need to run it with <tt class="docutils literal">sudo</tt>.</p></div><p class="tags">This entry was tagged as <a href="https://blog.ionelmc.ro/tag/mysql/"><span itemprop="keywords">mysql</span></a><a href="https://blog.ionelmc.ro/tag/python/"><span itemprop="keywords">python</span></a><a href="https://blog.ionelmc.ro/tag/django/"><span itemprop="keywords">django</span></a><a href="https://blog.ionelmc.ro/tag/testing/"><span itemprop="keywords">testing</span></a></p></div><p id="disqus_thread"/><noscript> Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </div></div></body></html>