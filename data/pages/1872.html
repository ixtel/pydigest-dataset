<html><body><div><article class="markdown-body entry-content" itemprop="text"><h1><a id="user-content-pyrsistent" class="anchor" href="#pyrsistent" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Pyrsistent</h1>
<a href="https://travis-ci.org/tobgu/pyrsistent"><img alt="https://travis-ci.org/tobgu/pyrsistent.png?branch=master" src="https://camo.githubusercontent.com/69ab9cd54aa83528f9510e5dfdf5dd668a69a3e1/68747470733a2f2f7472617669732d63692e6f72672f746f6267752f70797273697374656e742e706e673f6272616e63683d6d6173746572" data-canonical-src="https://travis-ci.org/tobgu/pyrsistent.png?branch=master"/></a>
<a href="https://badge.fury.io/py/pyrsistent"><img src="https://camo.githubusercontent.com/2bbdd1bac32e28de5993509f7e142f870e91dbe4/68747470733a2f2f62616467652e667572792e696f2f70792f70797273697374656e742e737667" data-canonical-src="https://badge.fury.io/py/pyrsistent.svg"/>
</a>
<a href="https://coveralls.io/github/tobgu/pyrsistent?branch=master"><img alt="https://coveralls.io/repos/tobgu/pyrsistent/badge.svg?branch=master&amp;service=github" src="https://camo.githubusercontent.com/76baae7283ca2b02cbf5ddd3b8a4092977886fb2/68747470733a2f2f636f766572616c6c732e696f2f7265706f732f746f6267752f70797273697374656e742f62616467652e7376673f6272616e63683d6d617374657226736572766963653d676974687562" data-canonical-src="https://coveralls.io/repos/tobgu/pyrsistent/badge.svg?branch=master&amp;service=github"/></a>
<p>Pyrsistent is a number of persistent collections (by some referred to as functional data structures). Persistent in
the sense that they are immutable.</p>
<p>All methods on a data structure that would normally mutate it instead return a new copy of the structure containing the
requested updates. The original structure is left untouched.</p>
<p>This will simplify the reasoning about what a program does since no hidden side effects ever can take place to these
data structures. You can rest assured that the object you hold a reference to will remain the same throughout its
lifetime and need not worry that somewhere five stack levels below you in the darkest corner of your application
someone has decided to remove that element that you expected to be there.</p>
<p>Pyrsistent is influenced by persistent data structures such as those found in the standard library of Clojure. The
data structures are designed to share common elements through path copying.
It aims at taking these concepts and make them as pythonic as possible so that they can be easily integrated into any python
program without hassle.</p>
<p>If you want to go all in on persistent data structures and use literal syntax to define them in your code rather
than function calls check out <a href="https://www.github.com/tobgu/pyrthon/">Pyrthon</a>.</p>
<a name="user-content-examples"/>
<h2><a id="user-content-examples" class="anchor" href="#examples" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Examples</h2>
<p>The collection types and key features currently implemented are:</p>
<ul>
<li><a href="#pvector">PVector</a>, similar to a python list</li>
<li><a href="#pmap">PMap</a>, similar to dict</li>
<li><a href="#pset">PSet</a>, similar to set</li>
<li><a href="#precord">PRecord</a>, a PMap on steroids with fixed fields, optional type and invariant checking and much more</li>
<li><a href="#pclass">PClass</a>, a Python class fixed fields, optional type and invariant checking and much more</li>
<li><a href="#checked-collections">Checked collections</a>, PVector, PMap and PSet with optional type and invariance checks and more</li>
<li>PBag, similar to collections.Counter</li>
<li>PList, a classic singly linked list</li>
<li>PDeque, similar to collections.deque</li>
<li>Immutable object type (immutable) built on the named tuple</li>
<li><a href="#freeze">freeze</a> and <a href="#thaw">thaw</a> functions to convert between pythons standard collections and pyrsistent collections.</li>
<li>Flexible <a href="#transformations">transformations</a> of arbitrarily complex structures built from PMaps and PVectors.</li>
</ul>
<p>Below are examples of common usage patterns for some of the structures and features. More information and
full documentation for all data structures is available in the <a href="http://pyrsistent.readthedocs.org/">documentation</a>.</p>
<a name="user-content-id1"/>
<h3><a id="user-content-pvector" class="anchor" href="#pvector" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>PVector</h3>
<p>With full support for the <a href="https://docs.python.org/3/library/collections.abc.html">Sequence</a> protocol PVector is meant as a drop in replacement to the built in list from a readers
point of view. Write operations of course differ since no in place mutation is done but naming should be in line
with corresponding operations on the built in list.</p>
<p>Support for the <a href="https://docs.python.org/3/library/collections.abc.html">Hashable</a> protocol also means that it can be used as key in <a href="https://docs.python.org/3/library/collections.abc.html">Mappings</a>.</p>
<p>Appends are amortized O(1). Random access and insert is log32(n) where n is the size of the vector.</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">from</span> pyrsistent <span class="pl-k">import</span> v, pvector

<span class="pl-c"># No mutation of vectors once created, instead they</span>
<span class="pl-c"># are "evolved" leaving the original untouched</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> v1 <span class="pl-k">=</span> v(<span class="pl-c1">1</span>, <span class="pl-c1">2</span>, <span class="pl-c1">3</span>)
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> v2 <span class="pl-k">=</span> v1.append(<span class="pl-c1">4</span>)
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> v3 <span class="pl-k">=</span> v2.set(<span class="pl-c1">1</span>, <span class="pl-c1">5</span>)
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> v1
pvector([<span class="pl-c1">1</span>, <span class="pl-c1">2</span>, <span class="pl-c1">3</span>])
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> v2
pvector([<span class="pl-c1">1</span>, <span class="pl-c1">2</span>, <span class="pl-c1">3</span>, <span class="pl-c1">4</span>])
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> v3
pvector([<span class="pl-c1">1</span>, <span class="pl-c1">5</span>, <span class="pl-c1">3</span>, <span class="pl-c1">4</span>])

<span class="pl-c"># Random access and slicing</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> v3[<span class="pl-c1">1</span>]
<span class="pl-c1">5</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> v3[<span class="pl-c1">1</span>:<span class="pl-c1">3</span>]
pvector([<span class="pl-c1">5</span>, <span class="pl-c1">3</span>])

<span class="pl-c"># Iteration</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-c1">list</span>(x <span class="pl-k">+</span> <span class="pl-c1">1</span> <span class="pl-k">for</span> x <span class="pl-k">in</span> v3)
[<span class="pl-c1">2</span>, <span class="pl-c1">6</span>, <span class="pl-c1">4</span>, <span class="pl-c1">5</span>]
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> pvector(<span class="pl-c1">2</span> <span class="pl-k">*</span> x <span class="pl-k">for</span> x <span class="pl-k">in</span> <span class="pl-c1">range</span>(<span class="pl-c1">3</span>))
pvector([<span class="pl-c1">0</span>, <span class="pl-c1">2</span>, <span class="pl-c1">4</span>])</pre></div>
<a name="user-content-id2"/>
<h3><a id="user-content-pmap" class="anchor" href="#pmap" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>PMap</h3>
<p>With full support for the <a href="https://docs.python.org/3/library/collections.abc.html">Mapping</a> protocol PMap is meant as a drop in replacement to the built in dict from a readers point
of view. Support for the <a href="https://docs.python.org/3/library/collections.abc.html">Hashable</a> protocol also means that it can be used as key in other <a href="https://docs.python.org/3/library/collections.abc.html">Mappings</a>.</p>
<p>Random access and insert is log32(n) where n is the size of the map.</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">from</span> pyrsistent <span class="pl-k">import</span> m, pmap, v

<span class="pl-c"># No mutation of maps once created, instead they are</span>
<span class="pl-c"># "evolved" leaving the original untouched</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> m1 <span class="pl-k">=</span> m(<span class="pl-v">a</span><span class="pl-k">=</span><span class="pl-c1">1</span>, <span class="pl-v">b</span><span class="pl-k">=</span><span class="pl-c1">2</span>)
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> m2 <span class="pl-k">=</span> m1.set(<span class="pl-s"><span class="pl-pds">'</span>c<span class="pl-pds">'</span></span>, <span class="pl-c1">3</span>)
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> m3 <span class="pl-k">=</span> m2.set(<span class="pl-s"><span class="pl-pds">'</span>a<span class="pl-pds">'</span></span>, <span class="pl-c1">5</span>)
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> m1
pmap({<span class="pl-s"><span class="pl-pds">'</span>a<span class="pl-pds">'</span></span>: <span class="pl-c1">1</span>, <span class="pl-s"><span class="pl-pds">'</span>b<span class="pl-pds">'</span></span>: <span class="pl-c1">2</span>})
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> m2
pmap({<span class="pl-s"><span class="pl-pds">'</span>a<span class="pl-pds">'</span></span>: <span class="pl-c1">1</span>, <span class="pl-s"><span class="pl-pds">'</span>c<span class="pl-pds">'</span></span>: <span class="pl-c1">3</span>, <span class="pl-s"><span class="pl-pds">'</span>b<span class="pl-pds">'</span></span>: <span class="pl-c1">2</span>})
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> m3
pmap({<span class="pl-s"><span class="pl-pds">'</span>a<span class="pl-pds">'</span></span>: <span class="pl-c1">5</span>, <span class="pl-s"><span class="pl-pds">'</span>c<span class="pl-pds">'</span></span>: <span class="pl-c1">3</span>, <span class="pl-s"><span class="pl-pds">'</span>b<span class="pl-pds">'</span></span>: <span class="pl-c1">2</span>})
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> m3[<span class="pl-s"><span class="pl-pds">'</span>a<span class="pl-pds">'</span></span>]
<span class="pl-c1">5</span>

<span class="pl-c"># Evolution of nested persistent structures</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> m4 <span class="pl-k">=</span> m(<span class="pl-v">a</span><span class="pl-k">=</span><span class="pl-c1">5</span>, <span class="pl-v">b</span><span class="pl-k">=</span><span class="pl-c1">6</span>, <span class="pl-v">c</span><span class="pl-k">=</span>v(<span class="pl-c1">1</span>, <span class="pl-c1">2</span>))
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> m4.transform((<span class="pl-s"><span class="pl-pds">'</span>c<span class="pl-pds">'</span></span>, <span class="pl-c1">1</span>), <span class="pl-c1">17</span>)
pmap({<span class="pl-s"><span class="pl-pds">'</span>a<span class="pl-pds">'</span></span>: <span class="pl-c1">5</span>, <span class="pl-s"><span class="pl-pds">'</span>c<span class="pl-pds">'</span></span>: pvector([<span class="pl-c1">1</span>, <span class="pl-c1">17</span>]), <span class="pl-s"><span class="pl-pds">'</span>b<span class="pl-pds">'</span></span>: <span class="pl-c1">6</span>})
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> m5 <span class="pl-k">=</span> m(<span class="pl-v">a</span><span class="pl-k">=</span><span class="pl-c1">1</span>, <span class="pl-v">b</span><span class="pl-k">=</span><span class="pl-c1">2</span>)

<span class="pl-c"># Evolve by merging with other mappings</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> m5.update(m(<span class="pl-v">a</span><span class="pl-k">=</span><span class="pl-c1">2</span>, <span class="pl-v">c</span><span class="pl-k">=</span><span class="pl-c1">3</span>), {<span class="pl-s"><span class="pl-pds">'</span>a<span class="pl-pds">'</span></span>: <span class="pl-c1">17</span>, <span class="pl-s"><span class="pl-pds">'</span>d<span class="pl-pds">'</span></span>: <span class="pl-c1">35</span>})
pmap({<span class="pl-s"><span class="pl-pds">'</span>a<span class="pl-pds">'</span></span>: <span class="pl-c1">17</span>, <span class="pl-s"><span class="pl-pds">'</span>c<span class="pl-pds">'</span></span>: <span class="pl-c1">3</span>, <span class="pl-s"><span class="pl-pds">'</span>b<span class="pl-pds">'</span></span>: <span class="pl-c1">2</span>, <span class="pl-s"><span class="pl-pds">'</span>d<span class="pl-pds">'</span></span>: <span class="pl-c1">35</span>})
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> pmap({<span class="pl-s"><span class="pl-pds">'</span>x<span class="pl-pds">'</span></span>: <span class="pl-c1">1</span>, <span class="pl-s"><span class="pl-pds">'</span>y<span class="pl-pds">'</span></span>: <span class="pl-c1">2</span>}) <span class="pl-k">+</span> pmap({<span class="pl-s"><span class="pl-pds">'</span>y<span class="pl-pds">'</span></span>: <span class="pl-c1">3</span>, <span class="pl-s"><span class="pl-pds">'</span>z<span class="pl-pds">'</span></span>: <span class="pl-c1">4</span>})
pmap({<span class="pl-s"><span class="pl-pds">'</span>y<span class="pl-pds">'</span></span>: <span class="pl-c1">3</span>, <span class="pl-s"><span class="pl-pds">'</span>x<span class="pl-pds">'</span></span>: <span class="pl-c1">1</span>, <span class="pl-s"><span class="pl-pds">'</span>z<span class="pl-pds">'</span></span>: <span class="pl-c1">4</span>})

<span class="pl-c"># Dict-like methods to convert to list and iterate</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> m3.items()
pvector([(<span class="pl-s"><span class="pl-pds">'</span>a<span class="pl-pds">'</span></span>, <span class="pl-c1">5</span>), (<span class="pl-s"><span class="pl-pds">'</span>c<span class="pl-pds">'</span></span>, <span class="pl-c1">3</span>), (<span class="pl-s"><span class="pl-pds">'</span>b<span class="pl-pds">'</span></span>, <span class="pl-c1">2</span>)])
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-c1">list</span>(m3)
[<span class="pl-s"><span class="pl-pds">'</span>a<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>c<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>b<span class="pl-pds">'</span></span>]</pre></div>
<a name="user-content-id3"/>
<h3><a id="user-content-pset" class="anchor" href="#pset" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>PSet</h3>
<p>With full support for the <a href="https://docs.python.org/3/library/collections.abc.html">Set</a> protocol PSet is meant as a drop in replacement to the built in set from a readers point
of view. Support for the <a href="https://docs.python.org/3/library/collections.abc.html">Hashable</a> protocol also means that it can be used as key in <a href="https://docs.python.org/3/library/collections.abc.html">Mappings</a>.</p>
<p>Random access and insert is log32(n) where n is the size of the set.</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">from</span> pyrsistent <span class="pl-k">import</span> s

<span class="pl-c"># No mutation of sets once created, you know the story...</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> s1 <span class="pl-k">=</span> s(<span class="pl-c1">1</span>, <span class="pl-c1">2</span>, <span class="pl-c1">3</span>, <span class="pl-c1">2</span>)
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> s2 <span class="pl-k">=</span> s1.add(<span class="pl-c1">4</span>)
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> s3 <span class="pl-k">=</span> s1.remove(<span class="pl-c1">1</span>)
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> s1
pset([<span class="pl-c1">1</span>, <span class="pl-c1">2</span>, <span class="pl-c1">3</span>])
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> s2
pset([<span class="pl-c1">1</span>, <span class="pl-c1">2</span>, <span class="pl-c1">3</span>, <span class="pl-c1">4</span>])
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> s3
pset([<span class="pl-c1">2</span>, <span class="pl-c1">3</span>])

<span class="pl-c"># Full support for set operations</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> s1 <span class="pl-k">|</span> s(<span class="pl-c1">3</span>, <span class="pl-c1">4</span>, <span class="pl-c1">5</span>)
pset([<span class="pl-c1">1</span>, <span class="pl-c1">2</span>, <span class="pl-c1">3</span>, <span class="pl-c1">4</span>, <span class="pl-c1">5</span>])
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> s1 <span class="pl-k">&amp;</span> s(<span class="pl-c1">3</span>, <span class="pl-c1">4</span>, <span class="pl-c1">5</span>)
pset([<span class="pl-c1">3</span>])
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> s1 <span class="pl-k">&lt;</span> s2
<span class="pl-c1">True</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> s1 <span class="pl-k">&lt;</span> s(<span class="pl-c1">3</span>, <span class="pl-c1">4</span>, <span class="pl-c1">5</span>)
<span class="pl-c1">False</span></pre></div>
<a name="user-content-id4"/>
<h3><a id="user-content-precord" class="anchor" href="#precord" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>PRecord</h3>
<p>A PRecord is a PMap with a fixed set of specified fields. Records are declared as python classes inheriting
from PRecord. Because it is a PMap it has full support for all Mapping methods such as iteration and element
access using subscript notation.</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">from</span> pyrsistent <span class="pl-k">import</span> PRecord, field
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">class</span> <span class="pl-en">ARecord</span>(<span class="pl-e">PRecord</span>):
<span class="pl-c1">...</span>     x <span class="pl-k">=</span> field()
<span class="pl-c1">...</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> r <span class="pl-k">=</span> ARecord(<span class="pl-v">x</span><span class="pl-k">=</span><span class="pl-c1">3</span>)
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> r
ARecord(<span class="pl-v">x</span><span class="pl-k">=</span><span class="pl-c1">3</span>)
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> r.x
<span class="pl-c1">3</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> r.set(<span class="pl-v">x</span><span class="pl-k">=</span><span class="pl-c1">2</span>)
ARecord(<span class="pl-v">x</span><span class="pl-k">=</span><span class="pl-c1">2</span>)
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> r.set(<span class="pl-v">y</span><span class="pl-k">=</span><span class="pl-c1">2</span>)
Traceback (most recent call last):
<span class="pl-c1">AttributeError</span>: <span class="pl-s"><span class="pl-pds">'</span>y<span class="pl-pds">'</span></span> <span class="pl-k">is</span> <span class="pl-k">not</span> among the specified fields <span class="pl-k">for</span> ARecord</pre></div>
<a name="user-content-type-information"/>
<h4><a id="user-content-type-information" class="anchor" href="#type-information" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Type information</h4>
<p>It is possible to add type information to the record to enforce type checks. Multiple allowed types can be specified
by providing an iterable of types.</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">class</span> <span class="pl-en">BRecord</span>(<span class="pl-e">PRecord</span>):
<span class="pl-c1">...</span>     x <span class="pl-k">=</span> field(<span class="pl-v">type</span><span class="pl-k">=</span><span class="pl-c1">int</span>)
<span class="pl-c1">...</span>     y <span class="pl-k">=</span> field(<span class="pl-v">type</span><span class="pl-k">=</span>(<span class="pl-c1">int</span>, <span class="pl-c1">type</span>(<span class="pl-c1">None</span>)))
<span class="pl-c1">...</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> BRecord(<span class="pl-v">x</span><span class="pl-k">=</span><span class="pl-c1">3</span>, <span class="pl-v">y</span><span class="pl-k">=</span><span class="pl-c1">None</span>)
BRecord(<span class="pl-v">y</span><span class="pl-k">=</span><span class="pl-c1">None</span>, <span class="pl-v">x</span><span class="pl-k">=</span><span class="pl-c1">3</span>)
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> BRecord(<span class="pl-v">x</span><span class="pl-k">=</span><span class="pl-c1">3.0</span>)
Traceback (most recent call last):
PTypeError: Invalid <span class="pl-c1">type</span> <span class="pl-k">for</span> field BRecord.x, was <span class="pl-c1">float</span></pre></div>
<a name="user-content-mandatory-fields"/>
<h4><a id="user-content-mandatory-fields" class="anchor" href="#mandatory-fields" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Mandatory fields</h4>
<p>Fields are not mandatory by default but can be specified as such. If fields are missing an
<em>InvariantException</em> will be thrown which contains information about the missing fields.</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">from</span> pyrsistent <span class="pl-k">import</span> InvariantException
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">class</span> <span class="pl-en">CRecord</span>(<span class="pl-e">PRecord</span>):
<span class="pl-c1">...</span>     x <span class="pl-k">=</span> field(<span class="pl-v">mandatory</span><span class="pl-k">=</span><span class="pl-c1">True</span>)
<span class="pl-c1">...</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> r <span class="pl-k">=</span> CRecord(<span class="pl-v">x</span><span class="pl-k">=</span><span class="pl-c1">3</span>)
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">try</span>:
<span class="pl-c1">...</span>    r.discard(<span class="pl-s"><span class="pl-pds">'</span>x<span class="pl-pds">'</span></span>)
<span class="pl-c1">...</span> <span class="pl-k">except</span> InvariantException <span class="pl-k">as</span> e:
<span class="pl-c1">...</span>    <span class="pl-c1">print</span>(e.missing_fields)
<span class="pl-c1">...</span>
(<span class="pl-s"><span class="pl-pds">'</span>CRecord.x<span class="pl-pds">'</span></span>,)</pre></div>
<a name="user-content-invariants"/>
<h4><a id="user-content-invariants" class="anchor" href="#invariants" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Invariants</h4>
<p>It is possible to add invariants that must hold when evolving the record. Invariants can be
specified on both field and record level. If invariants fail an <em>InvariantException</em> will be
thrown which contains information about the failing invariants. An invariant function should
return a tuple consisting of a boolean that tells if the invariant holds or not and an object
describing the invariant. This object can later be used to identify which invariant that failed.</p>
<p>The global invariant function is only executed if all field invariants hold.</p>
<p>Global invariants are inherited to subclasses.</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">class</span> <span class="pl-en">RestrictedVector</span>(<span class="pl-e">PRecord</span>):
<span class="pl-c1">...</span>     __invariant__ <span class="pl-k">=</span> <span class="pl-k">lambda</span> <span class="pl-smi">r</span>: (r.y <span class="pl-k">&gt;=</span> r.x, <span class="pl-s"><span class="pl-pds">'</span>x larger than y<span class="pl-pds">'</span></span>)
<span class="pl-c1">...</span>     x <span class="pl-k">=</span> field(<span class="pl-v">invariant</span><span class="pl-k">=</span><span class="pl-k">lambda</span> <span class="pl-smi">x</span>: (x <span class="pl-k">&gt;</span> <span class="pl-c1">0</span>, <span class="pl-s"><span class="pl-pds">'</span>x negative<span class="pl-pds">'</span></span>))
<span class="pl-c1">...</span>     y <span class="pl-k">=</span> field(<span class="pl-v">invariant</span><span class="pl-k">=</span><span class="pl-k">lambda</span> <span class="pl-smi">y</span>: (y <span class="pl-k">&gt;</span> <span class="pl-c1">0</span>, <span class="pl-s"><span class="pl-pds">'</span>y negative<span class="pl-pds">'</span></span>))
<span class="pl-c1">...</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> r <span class="pl-k">=</span> RestrictedVector(<span class="pl-v">y</span><span class="pl-k">=</span><span class="pl-c1">3</span>, <span class="pl-v">x</span><span class="pl-k">=</span><span class="pl-c1">2</span>)
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">try</span>:
<span class="pl-c1">...</span>    r.set(<span class="pl-v">x</span><span class="pl-k">=</span><span class="pl-k">-</span><span class="pl-c1">1</span>, <span class="pl-v">y</span><span class="pl-k">=</span><span class="pl-k">-</span><span class="pl-c1">2</span>)
<span class="pl-c1">...</span> <span class="pl-k">except</span> InvariantException <span class="pl-k">as</span> e:
<span class="pl-c1">...</span>    <span class="pl-c1">print</span>(e.invariant_errors)
<span class="pl-c1">...</span>
(<span class="pl-s"><span class="pl-pds">'</span>y negative<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>x negative<span class="pl-pds">'</span></span>)
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">try</span>:
<span class="pl-c1">...</span>    r.set(<span class="pl-v">x</span><span class="pl-k">=</span><span class="pl-c1">2</span>, <span class="pl-v">y</span><span class="pl-k">=</span><span class="pl-c1">1</span>)
<span class="pl-c1">...</span> <span class="pl-k">except</span> InvariantException <span class="pl-k">as</span> e:
<span class="pl-c1">...</span>    <span class="pl-c1">print</span>(e.invariant_errors)
<span class="pl-c1">...</span>
(<span class="pl-s"><span class="pl-pds">'</span>x larger than y<span class="pl-pds">'</span></span>,)</pre></div>
<p>Invariants may also contain multiple assertions. For those cases the invariant function should
return a tuple of invariant tuples as described above. This structure is reflected in the
invariant_errors attribute of the exception which will contain tuples with data from all failed
invariants. Eg:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">class</span> <span class="pl-en">EvenX</span>(<span class="pl-e">PRecord</span>):
<span class="pl-c1">...</span>     x <span class="pl-k">=</span> field(<span class="pl-v">invariant</span><span class="pl-k">=</span><span class="pl-k">lambda</span> <span class="pl-smi">x</span>: ((x <span class="pl-k">&gt;</span> <span class="pl-c1">0</span>, <span class="pl-s"><span class="pl-pds">'</span>x negative<span class="pl-pds">'</span></span>), (x <span class="pl-k">%</span> <span class="pl-c1">2</span> <span class="pl-k">==</span> <span class="pl-c1">0</span>, <span class="pl-s"><span class="pl-pds">'</span>x odd<span class="pl-pds">'</span></span>)))
<span class="pl-c1">...</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">try</span>:
<span class="pl-c1">...</span>    EvenX(<span class="pl-v">x</span><span class="pl-k">=</span><span class="pl-k">-</span><span class="pl-c1">1</span>)
<span class="pl-c1">...</span> <span class="pl-k">except</span> InvariantException <span class="pl-k">as</span> e:
<span class="pl-c1">...</span>    <span class="pl-c1">print</span>(e.invariant_errors)
<span class="pl-c1">...</span>
((<span class="pl-s"><span class="pl-pds">'</span>x negative<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>x odd<span class="pl-pds">'</span></span>),)</pre></div>
<a name="user-content-factories"/>
<h4><a id="user-content-factories" class="anchor" href="#factories" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Factories</h4>
<p>It's possible to specify factory functions for fields. The factory function receives whatever
is supplied as field value and the actual returned by the factory is assigned to the field
given that any type and invariant checks hold.
PRecords have a default factory specified as a static function on the class, create(). It takes
a <em>Mapping</em> as argument and returns an instance of the specific record.
If a record has fields of type PRecord the create() method of that record will
be called to create the "sub record" if no factory has explicitly been specified to override
this behaviour.</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">class</span> <span class="pl-en">DRecord</span>(<span class="pl-e">PRecord</span>):
<span class="pl-c1">...</span>     x <span class="pl-k">=</span> field(<span class="pl-v">factory</span><span class="pl-k">=</span><span class="pl-c1">int</span>)
<span class="pl-c1">...</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">class</span> <span class="pl-en">ERecord</span>(<span class="pl-e">PRecord</span>):
<span class="pl-c1">...</span>     d <span class="pl-k">=</span> field(<span class="pl-v">type</span><span class="pl-k">=</span>DRecord)
<span class="pl-c1">...</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> ERecord.create({<span class="pl-s"><span class="pl-pds">'</span>d<span class="pl-pds">'</span></span>: {<span class="pl-s"><span class="pl-pds">'</span>x<span class="pl-pds">'</span></span>: <span class="pl-s"><span class="pl-pds">'</span>1<span class="pl-pds">'</span></span>}})
ERecord(<span class="pl-v">d</span><span class="pl-k">=</span>DRecord(<span class="pl-v">x</span><span class="pl-k">=</span><span class="pl-c1">1</span>))</pre></div>
<a name="user-content-collection-fields"/>
<h4><a id="user-content-collection-fields" class="anchor" href="#collection-fields" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Collection fields</h4>
<p>It is also possible to have fields with <code>pyrsistent</code> collections.</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">from</span> pyrsistent <span class="pl-k">import</span> pset_field, pmap_field, pvector_field
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">class</span> <span class="pl-en">MultiRecord</span>(<span class="pl-e">PRecord</span>):
<span class="pl-c1">...</span>     set_of_ints <span class="pl-k">=</span> pset_field(<span class="pl-c1">int</span>)
<span class="pl-c1">...</span>     map_int_to_str <span class="pl-k">=</span> pmap_field(<span class="pl-c1">int</span>, <span class="pl-c1">str</span>)
<span class="pl-c1">...</span>     vector_of_strs <span class="pl-k">=</span> pvector_field(<span class="pl-c1">str</span>)
<span class="pl-c1">...</span></pre></div>
<a name="user-content-serialization"/>
<h4><a id="user-content-serialization" class="anchor" href="#serialization" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Serialization</h4>
<p>PRecords support serialization back to dicts. Default serialization will take keys and values
"as is" and output them into a dict. It is possible to specify custom serialization functions
to take care of fields that require special treatment.</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">from</span> datetime <span class="pl-k">import</span> date
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">class</span> <span class="pl-en">Person</span>(<span class="pl-e">PRecord</span>):
<span class="pl-c1">...</span>     name <span class="pl-k">=</span> field(<span class="pl-v">type</span><span class="pl-k">=</span><span class="pl-v">unicode</span>)
<span class="pl-c1">...</span>     birth_date <span class="pl-k">=</span> field(<span class="pl-v">type</span><span class="pl-k">=</span>date,
<span class="pl-c1">...</span>                        <span class="pl-v">serializer</span><span class="pl-k">=</span><span class="pl-k">lambda</span> <span class="pl-smi">format</span>, <span class="pl-smi">d</span>: d.strftime(<span class="pl-c1">format</span>[<span class="pl-s"><span class="pl-pds">'</span>date<span class="pl-pds">'</span></span>]))
<span class="pl-c1">...</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> john <span class="pl-k">=</span> Person(<span class="pl-v">name</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-k">u</span><span class="pl-pds">'</span>John<span class="pl-pds">'</span></span>, <span class="pl-v">birth_date</span><span class="pl-k">=</span>date(<span class="pl-c1">1985</span>, <span class="pl-c1">10</span>, <span class="pl-c1">21</span>))
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> john.serialize({<span class="pl-s"><span class="pl-pds">'</span>date<span class="pl-pds">'</span></span>: <span class="pl-s"><span class="pl-pds">'</span>%Y-%m-<span class="pl-c1">%d</span><span class="pl-pds">'</span></span>})
{<span class="pl-s"><span class="pl-pds">'</span>birth_date<span class="pl-pds">'</span></span>: <span class="pl-s"><span class="pl-pds">'</span>1985-10-21<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>: <span class="pl-s"><span class="pl-k">u</span><span class="pl-pds">'</span>John<span class="pl-pds">'</span></span>}</pre></div>
<a name="user-content-id5"/>
<h3><a id="user-content-pclass" class="anchor" href="#pclass" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>PClass</h3>
<p>A PClass is a python class with a fixed set of specified fields. PClasses are declared as python classes inheriting
from PClass. It is defined the same way that PRecords are and behaves like a PRecord in all aspects except that it
is not a PMap and hence not a collection but rather a plain Python object.</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">from</span> pyrsistent <span class="pl-k">import</span> PClass, field
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">class</span> <span class="pl-en">AClass</span>(<span class="pl-e">PClass</span>):
<span class="pl-c1">...</span>     x <span class="pl-k">=</span> field()
<span class="pl-c1">...</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> a <span class="pl-k">=</span> AClass(<span class="pl-v">x</span><span class="pl-k">=</span><span class="pl-c1">3</span>)
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> a
AClass(<span class="pl-v">x</span><span class="pl-k">=</span><span class="pl-c1">3</span>)
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> a.x
<span class="pl-c1">3</span></pre></div>
<a name="user-content-checked-collections"/>
<h3><a id="user-content-checked-collections" class="anchor" href="#checked-collections" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Checked collections</h3>
<p>Checked collections currently come in three flavors: CheckedPVector, CheckedPMap and CheckedPSet.</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">from</span> pyrsistent <span class="pl-k">import</span> CheckedPVector, CheckedPMap, CheckedPSet, thaw
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">class</span> <span class="pl-en">Positives</span>(<span class="pl-e">CheckedPSet</span>):
<span class="pl-c1">...</span>     __type__ <span class="pl-k">=</span> (<span class="pl-v">long</span>, <span class="pl-c1">int</span>)
<span class="pl-c1">...</span>     __invariant__ <span class="pl-k">=</span> <span class="pl-k">lambda</span> <span class="pl-smi">n</span>: (n <span class="pl-k">&gt;=</span> <span class="pl-c1">0</span>, <span class="pl-s"><span class="pl-pds">'</span>Negative<span class="pl-pds">'</span></span>)
<span class="pl-c1">...</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">class</span> <span class="pl-en">Lottery</span>(<span class="pl-e">PRecord</span>):
<span class="pl-c1">...</span>     name <span class="pl-k">=</span> field(<span class="pl-v">type</span><span class="pl-k">=</span><span class="pl-c1">str</span>)
<span class="pl-c1">...</span>     numbers <span class="pl-k">=</span> field(<span class="pl-v">type</span><span class="pl-k">=</span>Positives, <span class="pl-v">invariant</span><span class="pl-k">=</span><span class="pl-k">lambda</span> <span class="pl-smi">p</span>: (<span class="pl-c1">len</span>(p) <span class="pl-k">&gt;</span> <span class="pl-c1">0</span>, <span class="pl-s"><span class="pl-pds">'</span>No numbers<span class="pl-pds">'</span></span>))
<span class="pl-c1">...</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">class</span> <span class="pl-en">Lotteries</span>(<span class="pl-e">CheckedPVector</span>):
<span class="pl-c1">...</span>     __type__ <span class="pl-k">=</span> Lottery
<span class="pl-c1">...</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">class</span> <span class="pl-en">LotteriesByDate</span>(<span class="pl-e">CheckedPMap</span>):
<span class="pl-c1">...</span>     __key_type__ <span class="pl-k">=</span> date
<span class="pl-c1">...</span>     __value_type__ <span class="pl-k">=</span> Lotteries
<span class="pl-c1">...</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> lotteries <span class="pl-k">=</span> LotteriesByDate.create({date(<span class="pl-c1">2015</span>, <span class="pl-c1">0<span class="pl-ii">2</span></span>, <span class="pl-c1">15</span>): [{<span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>: <span class="pl-s"><span class="pl-pds">'</span>SuperLotto<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>numbers<span class="pl-pds">'</span></span>: {<span class="pl-c1">1</span>, <span class="pl-c1">2</span>, <span class="pl-c1">3</span>}},
<span class="pl-c1">...</span>                                                          {<span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>: <span class="pl-s"><span class="pl-pds">'</span>MegaLotto<span class="pl-pds">'</span></span>,  <span class="pl-s"><span class="pl-pds">'</span>numbers<span class="pl-pds">'</span></span>: {<span class="pl-c1">4</span>, <span class="pl-c1">5</span>, <span class="pl-c1">6</span>}}],
<span class="pl-c1">...</span>                                     date(<span class="pl-c1">2015</span>, <span class="pl-c1">0<span class="pl-ii">2</span></span>, <span class="pl-c1">16</span>): [{<span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>: <span class="pl-s"><span class="pl-pds">'</span>SuperLotto<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>numbers<span class="pl-pds">'</span></span>: {<span class="pl-c1">3</span>, <span class="pl-c1">2</span>, <span class="pl-c1">1</span>}},
<span class="pl-c1">...</span>                                                          {<span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>: <span class="pl-s"><span class="pl-pds">'</span>MegaLotto<span class="pl-pds">'</span></span>,  <span class="pl-s"><span class="pl-pds">'</span>numbers<span class="pl-pds">'</span></span>: {<span class="pl-c1">6</span>, <span class="pl-c1">5</span>, <span class="pl-c1">4</span>}}]})
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> lotteries
LotteriesByDate({datetime.date(<span class="pl-c1">2015</span>, <span class="pl-c1">2</span>, <span class="pl-c1">15</span>): Lotteries([Lottery(<span class="pl-v">numbers</span><span class="pl-k">=</span>Positives([<span class="pl-c1">1</span>, <span class="pl-c1">2</span>, <span class="pl-c1">3</span>]), <span class="pl-v">name</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>SuperLotto<span class="pl-pds">'</span></span>), Lottery(<span class="pl-v">numbers</span><span class="pl-k">=</span>Positives([<span class="pl-c1">4</span>, <span class="pl-c1">5</span>, <span class="pl-c1">6</span>]), <span class="pl-v">name</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>MegaLotto<span class="pl-pds">'</span></span>)]), datetime.date(<span class="pl-c1">2015</span>, <span class="pl-c1">2</span>, <span class="pl-c1">16</span>): Lotteries([Lottery(<span class="pl-v">numbers</span><span class="pl-k">=</span>Positives([<span class="pl-c1">1</span>, <span class="pl-c1">2</span>, <span class="pl-c1">3</span>]), <span class="pl-v">name</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>SuperLotto<span class="pl-pds">'</span></span>), Lottery(<span class="pl-v">numbers</span><span class="pl-k">=</span>Positives([<span class="pl-c1">4</span>, <span class="pl-c1">5</span>, <span class="pl-c1">6</span>]), <span class="pl-v">name</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>MegaLotto<span class="pl-pds">'</span></span>)])})

<span class="pl-c"># The checked versions support all operations that the corresponding</span>
<span class="pl-c"># unchecked types do</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> lottery_0215 <span class="pl-k">=</span> lotteries[date(<span class="pl-c1">2015</span>, <span class="pl-c1">0<span class="pl-ii">2</span></span>, <span class="pl-c1">15</span>)]
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> lottery_0215.transform([<span class="pl-c1">0</span>, <span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>], <span class="pl-s"><span class="pl-pds">'</span>SuperDuperLotto<span class="pl-pds">'</span></span>)
Lotteries([Lottery(<span class="pl-v">numbers</span><span class="pl-k">=</span>Positives([<span class="pl-c1">1</span>, <span class="pl-c1">2</span>, <span class="pl-c1">3</span>]), <span class="pl-v">name</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>SuperDuperLotto<span class="pl-pds">'</span></span>), Lottery(<span class="pl-v">numbers</span><span class="pl-k">=</span>Positives([<span class="pl-c1">4</span>, <span class="pl-c1">5</span>, <span class="pl-c1">6</span>]), <span class="pl-v">name</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>MegaLotto<span class="pl-pds">'</span></span>)])

<span class="pl-c"># But also makes asserts that types and invariants hold</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> lottery_0215.transform([<span class="pl-c1">0</span>, <span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>], <span class="pl-c1">999</span>)
Traceback (most recent call last):
PTypeError: Invalid <span class="pl-c1">type</span> <span class="pl-k">for</span> field Lottery.name, was <span class="pl-c1">int</span>

<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> lottery_0215.transform([<span class="pl-c1">0</span>, <span class="pl-s"><span class="pl-pds">'</span>numbers<span class="pl-pds">'</span></span>], <span class="pl-c1">set</span>())
Traceback (most recent call last):
InvariantException: Field invariant failed

<span class="pl-c"># They can be converted back to python built ins with either thaw()</span>
<span class="pl-c"># or serialize() (which provides possibilities to customize serialization)</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> thaw(lottery_0215)
[{<span class="pl-s"><span class="pl-pds">'</span>numbers<span class="pl-pds">'</span></span>: <span class="pl-c1">set</span>([<span class="pl-c1">1</span>, <span class="pl-c1">2</span>, <span class="pl-c1">3</span>]), <span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>: <span class="pl-s"><span class="pl-pds">'</span>SuperLotto<span class="pl-pds">'</span></span>}, {<span class="pl-s"><span class="pl-pds">'</span>numbers<span class="pl-pds">'</span></span>: <span class="pl-c1">set</span>([<span class="pl-c1">4</span>, <span class="pl-c1">5</span>, <span class="pl-c1">6</span>]), <span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>: <span class="pl-s"><span class="pl-pds">'</span>MegaLotto<span class="pl-pds">'</span></span>}]
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> lottery_0215.serialize()
[{<span class="pl-s"><span class="pl-pds">'</span>numbers<span class="pl-pds">'</span></span>: <span class="pl-c1">set</span>([<span class="pl-c1">1</span>, <span class="pl-c1">2</span>, <span class="pl-c1">3</span>]), <span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>: <span class="pl-s"><span class="pl-pds">'</span>SuperLotto<span class="pl-pds">'</span></span>}, {<span class="pl-s"><span class="pl-pds">'</span>numbers<span class="pl-pds">'</span></span>: <span class="pl-c1">set</span>([<span class="pl-c1">4</span>, <span class="pl-c1">5</span>, <span class="pl-c1">6</span>]), <span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>: <span class="pl-s"><span class="pl-pds">'</span>MegaLotto<span class="pl-pds">'</span></span>}]</pre></div>
<a name="user-content-id6"/>
<h3><a id="user-content-transformations" class="anchor" href="#transformations" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Transformations</h3>
<p>Transformations are inspired by the cool library <a href="https://github.com/boxed/instar/">instar</a> for Clojure. They let you evolve PMaps and PVectors
with arbitrarily deep/complex nesting using simple syntax and flexible matching syntax.</p>
<p>The first argument to transformation is the path that points out the value to transform. The
second is the transformation to perform. If the transformation is callable it will be applied
to the value(s) matching the path. The path may also contain callables. In that case they are
treated as matchers. If the matcher returns True for a specific key it is considered for transformation.</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"># Basic examples</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">from</span> pyrsistent <span class="pl-k">import</span> inc, freeze, thaw, rex, ny, discard
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> v1 <span class="pl-k">=</span> freeze([<span class="pl-c1">1</span>, <span class="pl-c1">2</span>, <span class="pl-c1">3</span>, <span class="pl-c1">4</span>, <span class="pl-c1">5</span>])
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> v1.transform([<span class="pl-c1">2</span>], inc)
pvector([<span class="pl-c1">1</span>, <span class="pl-c1">2</span>, <span class="pl-c1">4</span>, <span class="pl-c1">4</span>, <span class="pl-c1">5</span>])
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> v1.transform([<span class="pl-k">lambda</span> <span class="pl-smi">ix</span>: <span class="pl-c1">0</span> <span class="pl-k">&lt;</span> ix <span class="pl-k">&lt;</span> <span class="pl-c1">4</span>], <span class="pl-c1">8</span>)
pvector([<span class="pl-c1">1</span>, <span class="pl-c1">8</span>, <span class="pl-c1">8</span>, <span class="pl-c1">8</span>, <span class="pl-c1">5</span>])

<span class="pl-c"># The (a)ny matcher can be used to match anything</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> v1.transform([ny], <span class="pl-c1">8</span>)
pvector([<span class="pl-c1">8</span>, <span class="pl-c1">8</span>, <span class="pl-c1">8</span>, <span class="pl-c1">8</span>, <span class="pl-c1">8</span>])

<span class="pl-c"># Regular expressions can be used for matching</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> scores <span class="pl-k">=</span> freeze({<span class="pl-s"><span class="pl-pds">'</span>John<span class="pl-pds">'</span></span>: <span class="pl-c1">12</span>, <span class="pl-s"><span class="pl-pds">'</span>Joseph<span class="pl-pds">'</span></span>: <span class="pl-c1">34</span>, <span class="pl-s"><span class="pl-pds">'</span>Sara<span class="pl-pds">'</span></span>: <span class="pl-c1">23</span>})
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> scores.transform([rex(<span class="pl-s"><span class="pl-pds">'</span>^Jo<span class="pl-pds">'</span></span>)], <span class="pl-c1">0</span>)
pmap({<span class="pl-s"><span class="pl-pds">'</span>Joseph<span class="pl-pds">'</span></span>: <span class="pl-c1">0</span>, <span class="pl-s"><span class="pl-pds">'</span>Sara<span class="pl-pds">'</span></span>: <span class="pl-c1">23</span>, <span class="pl-s"><span class="pl-pds">'</span>John<span class="pl-pds">'</span></span>: <span class="pl-c1">0</span>})

<span class="pl-c"># Transformations can be done on arbitrarily deep structures</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> news_paper <span class="pl-k">=</span> freeze({<span class="pl-s"><span class="pl-pds">'</span>articles<span class="pl-pds">'</span></span>: [{<span class="pl-s"><span class="pl-pds">'</span>author<span class="pl-pds">'</span></span>: <span class="pl-s"><span class="pl-pds">'</span>Sara<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>content<span class="pl-pds">'</span></span>: <span class="pl-s"><span class="pl-pds">'</span>A short article<span class="pl-pds">'</span></span>},
<span class="pl-c1">...</span>                                   {<span class="pl-s"><span class="pl-pds">'</span>author<span class="pl-pds">'</span></span>: <span class="pl-s"><span class="pl-pds">'</span>Steve<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>content<span class="pl-pds">'</span></span>: <span class="pl-s"><span class="pl-pds">'</span>A slightly longer article<span class="pl-pds">'</span></span>}],
<span class="pl-c1">...</span>                      <span class="pl-s"><span class="pl-pds">'</span>weather<span class="pl-pds">'</span></span>: {<span class="pl-s"><span class="pl-pds">'</span>temperature<span class="pl-pds">'</span></span>: <span class="pl-s"><span class="pl-pds">'</span>11C<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>wind<span class="pl-pds">'</span></span>: <span class="pl-s"><span class="pl-pds">'</span>5m/s<span class="pl-pds">'</span></span>}})
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> short_news <span class="pl-k">=</span> news_paper.transform([<span class="pl-s"><span class="pl-pds">'</span>articles<span class="pl-pds">'</span></span>, ny, <span class="pl-s"><span class="pl-pds">'</span>content<span class="pl-pds">'</span></span>], <span class="pl-k">lambda</span> <span class="pl-smi">c</span>: c[:<span class="pl-c1">25</span>] <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">'</span>...<span class="pl-pds">'</span></span> <span class="pl-k">if</span> <span class="pl-c1">len</span>(c) <span class="pl-k">&gt;</span> <span class="pl-c1">25</span> <span class="pl-k">else</span> c)
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> very_short_news <span class="pl-k">=</span> news_paper.transform([<span class="pl-s"><span class="pl-pds">'</span>articles<span class="pl-pds">'</span></span>, ny, <span class="pl-s"><span class="pl-pds">'</span>content<span class="pl-pds">'</span></span>], <span class="pl-k">lambda</span> <span class="pl-smi">c</span>: c[:<span class="pl-c1">15</span>] <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">'</span>...<span class="pl-pds">'</span></span> <span class="pl-k">if</span> <span class="pl-c1">len</span>(c) <span class="pl-k">&gt;</span> <span class="pl-c1">15</span> <span class="pl-k">else</span> c)
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> very_short_news.articles[<span class="pl-c1">0</span>].content
<span class="pl-s"><span class="pl-pds">'</span>A short article<span class="pl-pds">'</span></span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> very_short_news.articles[<span class="pl-c1">1</span>].content
<span class="pl-s"><span class="pl-pds">'</span>A slightly long...<span class="pl-pds">'</span></span>

<span class="pl-c"># When nothing has been transformed the original data structure is kept</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> short_news <span class="pl-k">is</span> news_paper
<span class="pl-c1">True</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> very_short_news <span class="pl-k">is</span> news_paper
<span class="pl-c1">False</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> very_short_news.articles[<span class="pl-c1">0</span>] <span class="pl-k">is</span> news_paper.articles[<span class="pl-c1">0</span>]
<span class="pl-c1">True</span>

<span class="pl-c"># There is a special transformation that can be used to discard elements. Also</span>
<span class="pl-c"># multiple transformations can be applied in one call</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> thaw(news_paper.transform([<span class="pl-s"><span class="pl-pds">'</span>weather<span class="pl-pds">'</span></span>], discard, [<span class="pl-s"><span class="pl-pds">'</span>articles<span class="pl-pds">'</span></span>, ny, <span class="pl-s"><span class="pl-pds">'</span>content<span class="pl-pds">'</span></span>], discard))
{<span class="pl-s"><span class="pl-pds">'</span>articles<span class="pl-pds">'</span></span>: [{<span class="pl-s"><span class="pl-pds">'</span>author<span class="pl-pds">'</span></span>: <span class="pl-s"><span class="pl-pds">'</span>Sara<span class="pl-pds">'</span></span>}, {<span class="pl-s"><span class="pl-pds">'</span>author<span class="pl-pds">'</span></span>: <span class="pl-s"><span class="pl-pds">'</span>Steve<span class="pl-pds">'</span></span>}]}</pre></div>
<a name="user-content-evolvers"/>
<h3><a id="user-content-evolvers" class="anchor" href="#evolvers" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Evolvers</h3>
<p>PVector, PMap and PSet all have support for a concept dubbed <em>evolvers</em>. An evolver acts like a mutable
view of the underlying persistent data structure with "transaction like" semantics. No updates of the original
data structure is ever performed, it is still fully immutable.</p>
<p>The evolvers have a very limited API by design to discourage excessive, and inappropriate, usage as that would
take us down the mutable road. In principle only basic mutation and element access functions are supported.
Check out the <a href="http://pyrsistent.readthedocs.org/">documentation</a> of each data structure for specific examples.</p>
<p>Examples of when you may want to use an evolver instead of working directly with the data structure include:</p>
<ul>
<li>Multiple updates are done to the same data structure and the intermediate results are of no
interest. In this case using an evolver may be a more efficient and easier to work with.</li>
<li>You need to pass a vector into a legacy function or a function that you have no control
over which performs in place mutations. In this case pass an evolver instance
instead and then create a new pvector from the evolver once the function returns.</li>
</ul>
<div class="highlight highlight-source-python"><pre><span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">from</span> pyrsistent <span class="pl-k">import</span> v

<span class="pl-c"># In place mutation as when working with the built in counterpart</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> v1 <span class="pl-k">=</span> v(<span class="pl-c1">1</span>, <span class="pl-c1">2</span>, <span class="pl-c1">3</span>)
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> e <span class="pl-k">=</span> v1.evolver()
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> e[<span class="pl-c1">1</span>] <span class="pl-k">=</span> <span class="pl-c1">22</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> e <span class="pl-k">=</span> e.append(<span class="pl-c1">4</span>)
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> e <span class="pl-k">=</span> e.extend([<span class="pl-c1">5</span>, <span class="pl-c1">6</span>])
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> e[<span class="pl-c1">5</span>] <span class="pl-k">+=</span> <span class="pl-c1">1</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-c1">len</span>(e)
<span class="pl-c1">6</span>

<span class="pl-c"># The evolver is considered *dirty* when it contains changes compared to the underlying vector</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> e.is_dirty()
<span class="pl-c1">True</span>

<span class="pl-c"># But the underlying pvector still remains untouched</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> v1
pvector([<span class="pl-c1">1</span>, <span class="pl-c1">2</span>, <span class="pl-c1">3</span>])

<span class="pl-c"># Once satisfied with the updates you can produce a new pvector containing the updates.</span>
<span class="pl-c"># The new pvector will share data with the original pvector in the same way that would have</span>
<span class="pl-c"># been done if only using operations on the pvector.</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> v2 <span class="pl-k">=</span> e.persistent()
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> v2
pvector([<span class="pl-c1">1</span>, <span class="pl-c1">22</span>, <span class="pl-c1">3</span>, <span class="pl-c1">4</span>, <span class="pl-c1">5</span>, <span class="pl-c1">7</span>])

<span class="pl-c"># The evolver is now no longer considered *dirty* as it contains no differences compared to the</span>
<span class="pl-c"># pvector just produced.</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> e.is_dirty()
<span class="pl-c1">False</span>

<span class="pl-c"># You may continue to work with the same evolver without affecting the content of v2</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> e[<span class="pl-c1">0</span>] <span class="pl-k">=</span> <span class="pl-c1">11</span>

<span class="pl-c"># Or create a new evolver from v2. The two evolvers can be updated independently but will both</span>
<span class="pl-c"># share data with v2 where possible.</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> e2 <span class="pl-k">=</span> v2.evolver()
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> e2[<span class="pl-c1">0</span>] <span class="pl-k">=</span> <span class="pl-c1">1111</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> e.persistent()
pvector([<span class="pl-c1">11</span>, <span class="pl-c1">22</span>, <span class="pl-c1">3</span>, <span class="pl-c1">4</span>, <span class="pl-c1">5</span>, <span class="pl-c1">7</span>])
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> e2.persistent()
pvector([<span class="pl-c1">1111</span>, <span class="pl-c1">22</span>, <span class="pl-c1">3</span>, <span class="pl-c1">4</span>, <span class="pl-c1">5</span>, <span class="pl-c1">7</span>])</pre></div>
<a name="user-content-freeze-and-thaw"/>
<h3><a id="user-content-freeze-and-thaw" class="anchor" href="#freeze-and-thaw" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>freeze and thaw</h3>
<p>These functions are great when your cozy immutable world has to interact with the evil mutable world outside.</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">from</span> pyrsistent <span class="pl-k">import</span> freeze, thaw, v, m
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> freeze([<span class="pl-c1">1</span>, {<span class="pl-s"><span class="pl-pds">'</span>a<span class="pl-pds">'</span></span>: <span class="pl-c1">3</span>}])
pvector([<span class="pl-c1">1</span>, pmap({<span class="pl-s"><span class="pl-pds">'</span>a<span class="pl-pds">'</span></span>: <span class="pl-c1">3</span>})])
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> thaw(v(<span class="pl-c1">1</span>, m(<span class="pl-v">a</span><span class="pl-k">=</span><span class="pl-c1">3</span>)))
[<span class="pl-c1">1</span>, {<span class="pl-s"><span class="pl-pds">'</span>a<span class="pl-pds">'</span></span>: <span class="pl-c1">3</span>}]</pre></div>
<a name="user-content-compatibility"/>
<h2><a id="user-content-compatibility" class="anchor" href="#compatibility" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Compatibility</h2>
<p>Pyrsistent is developed and tested on Python 2.6, 2.7, 3.4, 3.5 and PyPy (Python 2.7 compatible). It will most likely work
on all other versions &gt;= 3.4 but no guarantees are given. :)</p>
<a name="user-content-compatibility-issues"/>
<h3><a id="user-content-compatibility-issues" class="anchor" href="#compatibility-issues" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Compatibility issues</h3>
<p>There is currently one known compatibility issue when comparing built in sets and frozensets to PSets as discussed in <a href="https://github.com/tobgu/pyrsistent/issues/27">27</a>.
It affects python 2 versions &lt; 2.7.8 and python 3 versions &lt; 3.4.0 and is due to a bug described in
<a href="http://bugs.python.org/issue8743">http://bugs.python.org/issue8743</a>.</p>
<p>Comparisons will fail or be incorrect when using the set/frozenset as left hand side of the comparison. As a workaround
you need to either upgrade Python to a more recent version, avoid comparing sets/frozensets with PSets or always make
sure to convert both sides of the comparison to the same type before performing the comparison.</p>
<a name="user-content-performance"/>
<h2><a id="user-content-performance" class="anchor" href="#performance" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Performance</h2>
<p>Pyrsistent is developed with performance in mind. Still, while some operations are nearly on par with their built in,
mutable, counterparts in terms of speed, other operations are slower. In the cases where attempts at
optimizations have been done, speed has generally been valued over space.</p>
<p>Pyrsistent comes with two API compatible flavors of PVector (on which PMap and PSet are based), one pure Python
implementation and one implemented as a C extension. The latter generally being 2 - 20 times faster than the former.
The C extension will be used automatically when possible.</p>
<p>The pure python implementation is fully PyPy compatible. Running it under PyPy speeds operations up considerably if
the structures are used heavily (if JITed), for some cases the performance is almost on par with the built in counterparts.</p>
<a name="user-content-installation"/>
<h2><a id="user-content-installation" class="anchor" href="#installation" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Installation</h2>
<p>pip install pyrsistent</p>
<a name="user-content-id8"/>
<h2><a id="user-content-documentation" class="anchor" href="#documentation" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Documentation</h2>
<p>Available at <a href="http://pyrsistent.readthedocs.org/">http://pyrsistent.readthedocs.org/</a></p>
<p>Brief presentation available at <a href="http://slides.com/tobiasgustafsson/immutability-and-python/">http://slides.com/tobiasgustafsson/immutability-and-python/</a></p>
<a name="user-content-contributors"/>
<h2><a id="user-content-contributors" class="anchor" href="#contributors" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Contributors</h2>
<p>Tobias Gustafsson <a href="https://github.com/tobgu">https://github.com/tobgu</a></p>
<p>Christopher Armstrong <a href="https://github.com/radix">https://github.com/radix</a></p>
<p>Anders Hovmller <a href="https://github.com/boxed">https://github.com/boxed</a></p>
<p>Itamar Turner-Trauring <a href="https://github.com/itamarst">https://github.com/itamarst</a></p>
<p>Jonathan Lange <a href="https://github.com/jml">https://github.com/jml</a></p>
<p>Richard Futrell <a href="https://github.com/Futrell">https://github.com/Futrell</a></p>
<p>Jakob Hollenstein <a href="https://github.com/jkbjh">https://github.com/jkbjh</a></p>
<p>David Honour <a href="https://github.com/foolswood">https://github.com/foolswood</a></p>
<p>David R. MacIver <a href="https://github.com/DRMacIver">https://github.com/DRMacIver</a></p>
<a name="user-content-contributing"/>
<h2><a id="user-content-contributing" class="anchor" href="#contributing" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Contributing</h2>
<p>If you experience problems please log them on GitHub. If you want to contribute code, please fork the code and submit a pull request.</p>

</article>
  </div></body></html>