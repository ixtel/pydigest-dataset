<html><body><div><div class="postcontents">
                    <p>Eloquent 0.4 is now out. This version introduces the schema builder, soft deletes, mixins and scopes.</p>

<h2 id="schema-builder">Schema Builder</h2>

<p>The new schema builder is here to help manipulate your databases structure
in an intuitive manner.</p>

<p>For that purpose you can use the <code>Schema</code> class which provides a database
agnostic way of manipulating tables.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">eloquent</span> <span class="kn">import</span> <span class="n">DatabaseManager</span><span class="p">,</span> <span class="n">Schema</span>

<span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'mysql'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'driver'</span><span class="p">:</span> <span class="s">'mysql'</span><span class="p">,</span>
        <span class="s">'host'</span><span class="p">:</span> <span class="s">'localhost'</span><span class="p">,</span>
        <span class="s">'database'</span><span class="p">:</span> <span class="s">'database'</span><span class="p">,</span>
        <span class="s">'username'</span><span class="p">:</span> <span class="s">'root'</span><span class="p">,</span>
        <span class="s">'password'</span><span class="p">:</span> <span class="s">''</span><span class="p">,</span>
        <span class="s">'prefix'</span><span class="p">:</span> <span class="s">''</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">DatabaseManager</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="n">schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">(</span><span class="n">db</span><span class="p">)</span></code></pre></div>

<h3 id="creating-and-dropping-tables">Creating and dropping tables</h3>

<p>To create a new database table, the <code>create</code> method is used:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">with</span> <span class="n">schema</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s">'users'</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
    <span class="n">table</span><span class="o">.</span><span class="n">increments</span><span class="p">(</span><span class="s">'id'</span><span class="p">)</span></code></pre></div>

<p>To rename an existing database table, the <code>rename</code> method can be used:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">schema</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s">'from'</span><span class="p">,</span> <span class="s">'to'</span><span class="p">)</span></code></pre></div>

<p>To specify which connection the schema operation should take place on, use the <code>connection</code> method:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">with</span> <span class="n">schema</span><span class="o">.</span><span class="n">connection</span><span class="p">(</span><span class="s">'foo'</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s">'users'</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
    <span class="n">table</span><span class="o">.</span><span class="n">increments</span><span class="p">(</span><span class="s">'id'</span><span class="p">)</span></code></pre></div>

<p>To drop a table, you can use the <code>drop</code> or <code>drop_if_exists</code> methods:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">schema</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s">'users'</span><span class="p">)</span>

<span class="n">schema</span><span class="o">.</span><span class="n">drop_if_exists</span><span class="p">(</span><span class="s">'users'</span><span class="p">)</span></code></pre></div>

<h3 id="adding-columns">Adding columns</h3>

<p>To update an existing table, you can use the <code>table</code> method:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">with</span> <span class="n">schema</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s">'users'</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
    <span class="n">table</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="s">'email'</span><span class="p">)</span>
    <span class="n">table</span><span class="o">.</span><span class="n">integer</span><span class="p">(</span><span class="s">'votes'</span><span class="p">)</span></code></pre></div>

<p>The table builder contains a variety of column types that you can use.
See the <a href="http://eloquent.readthedocs.org/en/latest/schema_builder.html#adding-columns">official documentation</a> for the full list.</p>

<h3 id="changing-columns">Changing columns</h3>

<p>Sometimes you may need to modify an existing column.
For example, you may wish to increase the size of a string column.
To do so, you can use the <code>change</code> method:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">with</span> <span class="n">schema</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s">'user'</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
    <span class="n">table</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="s">'name'</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">nullable</span><span class="p">()</span><span class="o">.</span><span class="n">change</span><span class="p">()</span></code></pre></div>

<div class="warning">
<p>The change column feature, while tested, is still considered in <strong>beta</strong> stage. Please report any encountered issue or bug on the <a href="https://github.com/sdispater/eloquent" title="Github Project">Github Project</a></p>
</div>

<h3 id="renaming-columns">Renaming columns</h3>

<p>To rename a column, you can use use the <code>rename_column</code> method on the Schema builder:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">with</span> <span class="n">schema</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s">'users'</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
    <span class="n">table</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s">'from'</span><span class="p">,</span> <span class="s">'to'</span><span class="p">)</span></code></pre></div>

<div class="warning">
<p>Prior to <strong>MySQL 5.6.6</strong>, foreign keys are <strong>NOT</strong> automatically updated when renaming columns. Therefore, you will need to <strong>drop</strong> the foreign key constraint, <strong>rename</strong> the column and <strong>recreate</strong> the constraint to avoid an error.</p>
<pre>
<code class="python">with schema.table('posts') as table:
    table.drop_foreign('posts_user_id_foreign')
    table.rename('user_id', 'author_id')
    table.foreign('author_id').references('id').on('users')
</code>
</pre>
<p>In future versions, Eloquent <strong>might</strong> handle this automatically.</p>
</div>

<div class="warning">
<p>The rename column feature, while tested, is still considered in <strong>beta</strong> stage (especially for SQLite). Please report any encountered issue or bug on the <a href="https://github.com/sdispater/eloquent" title="Github Project">Github Project</a></p>
</div>

<h3 id="dropping-columns">Dropping columns</h3>

<p>To drop a column, you can use use the <code>drop_column</code> method on the <code>Schema</code> builder:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># Dropping a single column</span>
<span class="k">with</span> <span class="n">schema</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s">'users'</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
    <span class="n">table</span><span class="o">.</span><span class="n">drop_column</span><span class="p">(</span><span class="s">'votes'</span><span class="p">)</span>

<span class="c"># Dropping multiple columns</span>
<span class="k">with</span> <span class="n">schema</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s">'users'</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
    <span class="n">table</span><span class="o">.</span><span class="n">drop_column</span><span class="p">(</span><span class="s">'votes'</span><span class="p">,</span> <span class="s">'avatar'</span><span class="p">,</span> <span class="s">'location'</span><span class="p">)</span></code></pre></div>

<h3 id="foreign-keys">Foreign keys</h3>

<p>Eloquent also provides support for adding foreign key constraints to your tables:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">table</span><span class="o">.</span><span class="n">integer</span><span class="p">(</span><span class="s">'user_id'</span><span class="p">)</span><span class="o">.</span><span class="n">unsigned</span><span class="p">()</span>
<span class="n">table</span><span class="o">.</span><span class="n">foreign</span><span class="p">(</span><span class="s">'user_id'</span><span class="p">)</span><span class="o">.</span><span class="n">references</span><span class="p">(</span><span class="s">'id'</span><span class="p">)</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s">'users'</span><span class="p">)</span></code></pre></div>

<p>In this example, we are stating that the <code>user_id</code>
column references the <code>id</code> column on the <code>users</code> table.
Make sure to create the foreign key column first!</p>

<p>You may also specify options for the “on delete” and “on update” actions of the constraint:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">table</span><span class="o">.</span><span class="n">foreign</span><span class="p">(</span><span class="s">'user_id'</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">references</span><span class="p">(</span><span class="s">'id'</span><span class="p">)</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s">'users'</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">on_delete</span><span class="p">(</span><span class="s">'cascade'</span><span class="p">)</span></code></pre></div>

<p>To drop a foreign key, you may use the <code>drop_foreign</code> method.
A similar naming convention is used for foreign keys as is used for other indexes:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">table</span><span class="o">.</span><span class="n">drop_foreign</span><span class="p">(</span><span class="s">'posts_user_id_foreign'</span><span class="p">)</span></code></pre></div>

<p>There is more you can do with the schema builder, like handling indexes. Referer to the
<a href="http://eloquent.readthedocs.org/en/latest/schema_builder.html">documentation</a> to see all the available features.</p>

<h2 id="soft-deleting">Soft deleting</h2>

<p>When soft deleting a model, it is not actually removed from your database.
Instead, a <code>deleted_at</code> timestamp is set on the record.
To enable soft deletes for a model, make it inherit from the <code>SoftDeletes</code> mixin:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">eloquent</span> <span class="kn">import</span> <span class="n">Model</span><span class="p">,</span> <span class="n">SoftDeletes</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="n">SoftDeletes</span><span class="p">):</span>

    <span class="n">__dates__</span> <span class="o">=</span> <span class="p">[</span><span class="s">'deleted_at'</span><span class="p">]</span></code></pre></div>

<p>Now, when you call the <code>delete</code> method on the model, the <code>deleted_at</code> column will be
set to the current timestamp. When querying a model that uses soft deletes,
the “deleted” models will not be included in query results.</p>

<h3 id="forcing-soft-deleted-models-into-results">Forcing soft deleted models into results</h3>

<p>To force soft deleted models to appear in a result set, use the <code>with_trashed</code> method on the query:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">with_trashed</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s">'account_id'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span></code></pre></div>

<p>The <code>with_trashed</code> method may be used on a defined relationship:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">user</span><span class="o">.</span><span class="n">posts</span><span class="p">()</span><span class="o">.</span><span class="n">with_trashed</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span></code></pre></div>

<h2 id="query-scopes">Query Scopes</h2>

<h3 id="defining-a-query-scope">Defining a query scope</h3>

<p>Scopes allow you to easily re-use query logic in your models.
To define a scope, simply prefix a model method with <code>scope</code>:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">eloquent</span> <span class="nn">Model</span><span class="p">,</span> <span class="n">scope</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>


    <span class="k">def</span> <span class="nf">scope_popular</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s">'votes'</span><span class="p">,</span> <span class="s">'&gt;'</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">scope_women</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">where_gender</span><span class="p">(</span><span class="s">'W'</span><span class="p">)</span></code></pre></div>

<h3 id="using-a-query-scope">Using a query scope</h3>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">popular</span><span class="p">()</span><span class="o">.</span><span class="n">women</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">'created_at'</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span></code></pre></div>

<h3 id="dynamic-scopes">Dynamic scopes</h3>

<p>Sometimes you may wish to define a scope that accepts parameters.
Just add your parameters to your scope function:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">scope_of_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">where_type</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span></code></pre></div>

<p>Then pass the parameter into the scope call:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">of_type</span><span class="p">(</span><span class="s">'member'</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span></code></pre></div>

<h2 id="global-scopes">Global Scopes</h2>

<p>Sometimes you may wish to define a scope that applies to all queries performed on a model.
In essence, this is how Eloquent’s own “soft delete” feature works.
Global scopes are defined using a combination of mixins and an implementation of the <code>Scope</code> class.</p>

<p>First, let’s define a mixin. For this example, we’ll use the <code>SoftDeletes</code> that ships with Eloquent:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">eloquent</span> <span class="kn">import</span> <span class="n">SoftDeletingScope</span>


<span class="k">class</span> <span class="nc">SoftDeletes</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">boot_soft_deletes</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">model_class</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Boot the soft deleting mixin for a model.</span>
<span class="sd">        """</span>
        <span class="n">model_class</span><span class="o">.</span><span class="n">add_global_scope</span><span class="p">(</span><span class="n">SoftDeletingScope</span><span class="p">())</span></code></pre></div>

<p>If an Eloquent model inherits from a mixin that has a method matching the <code>boot_name_of_trait</code>
naming convention, that mixin method will be called when the Eloquent model is booted,
giving you an opportunity to register a global scope, or do anything else you want.
A scope must be an instance of the <code>Scope</code> class, which specifies two methods: <code>apply</code> and <code>remove</code>.</p>

<p>The apply method receives an <code>Builder</code> query builder object and the <code>Model</code> it’s applied to,
and is responsible for adding any additional <code>where</code> clauses that the scope wishes to add.
The <code>remove</code> method also receives a <code>Builder</code> object and <code>Model</code> and is responsible
for reversing the action taken by <code>apply</code>.
In other words, <code>remove</code> should remove the <code>where</code> clause (or any other clause) that was added.
So, for our <code>SoftDeletingScope</code>, it would look something like this:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">eloquent</span> <span class="kn">import</span> <span class="n">Scope</span>


<span class="k">class</span> <span class="nc">SoftDeletingScope</span><span class="p">(</span><span class="n">Scope</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Apply the scope to a given query builder.</span>

<span class="sd">        :param builder: The query builder</span>
<span class="sd">        :type builder: eloquent.orm.builder.Builder</span>

<span class="sd">        :param model: The model</span>
<span class="sd">        :type model: eloquent.orm.Model</span>
<span class="sd">        """</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">where_null</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">get_qualified_deleted_at_column</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Remove the scope from a given query builder.</span>

<span class="sd">        :param builder: The query builder</span>
<span class="sd">        :type builder: eloquent.orm.builder.Builder</span>

<span class="sd">        :param model: The model</span>
<span class="sd">        :type model: eloquent.orm.Model</span>
<span class="sd">        """</span>
        <span class="n">column</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_qualified_deleted_at_column</span><span class="p">()</span>

        <span class="n">query</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">get_query</span><span class="p">()</span>

        <span class="n">wheres</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">where</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">wheres</span><span class="p">:</span>
            <span class="c"># If the where clause is a soft delete date constraint,</span>
            <span class="c"># we will remove it from the query and reset the keys</span>
            <span class="c"># on the wheres. This allows the developer to include</span>
            <span class="c"># deleted model in a relationship result set that is lazy loaded.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_soft_delete_constraint</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">column</span><span class="p">):</span>
                <span class="n">wheres</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">where</span><span class="p">)</span>

        <span class="n">query</span><span class="o">.</span><span class="n">wheres</span> <span class="o">=</span> <span class="n">wheres</span></code></pre></div>

<h2 id="whats-next">What’s next?</h2>

<p>Finally, here are some features targeted for the 0.5 version:</p>

<ul>
  <li>Database migrations based on the schema builder:</li>
</ul>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">eloquent</span> <span class="kn">import</span> <span class="n">Migration</span>


<span class="k">class</span> <span class="nc">UserMigration</span><span class="p">(</span><span class="n">Migration</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">up</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Run the migrations</span>
<span class="sd">        """</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s">'users'</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
            <span class="c"># ...</span>

    <span class="k">def</span> <span class="nf">down</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Revert the migrations</span>
<span class="sd">        """</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s">'users'</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
            <span class="c"># ...</span></code></pre></div>

<ul>
  <li>Support for model accessors and mutators.</li>
</ul>

<p>You can check the advancement on <a href="https://github.com/sdispater/eloquent/issues?q=is%3Aissue+milestone%3A0.5">the Github project</a></p>

                </div>
                </div></body></html>