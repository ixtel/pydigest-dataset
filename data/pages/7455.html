<html><body><div><div id="content">

            

            
        


            <div class="section">
              <h1>kinto-attachment 0.3.0</h1>

              


<p>Attach files to Kinto records</p>








<a href="https://travis-ci.org/Kinto/kinto-attachment" rel="nofollow"><img src="https://img.shields.io/travis/Kinto/kinto-attachment.svg"/>
</a>
<a href="https://pypi.python.org/pypi/kinto-attachment" rel="nofollow"><img src="https://img.shields.io/pypi/v/kinto-attachment.svg"/>
</a>
<a href="https://coveralls.io/r/Kinto/kinto-attachment" rel="nofollow"><img src="https://coveralls.io/repos/Kinto/kinto-attachment/badge.svg?branch=master"/></a>
<p><strong>proof-of-concept</strong>: Attach files to <a href="http://kinto.readthedocs.org" rel="nofollow">Kinto records</a>.</p>
<div id="install">
<h2>Install</h2>
<pre>pip install kinto-attachment
</pre>
</div>
<div id="setup">
<h2>Setup</h2>
<p>In the Kinto project settings</p>
<pre>kinto.includes = kinto_attachment
kinto.attachment.base_url = http://cdn.service.org/files/
kinto.attachment.folder = {bucket_id}/{collection_id}
</pre>
<p>Store files locally:</p>
<pre>kinto.attachment.base_path = /tmp
</pre>
<p>Store on Amazon S3:</p>
<pre>kinto.attachment.aws.access_key = &lt;AWS access key&gt;
kinto.attachment.aws.secret_key = &lt;AWS secret key&gt;
kinto.attachment.aws.bucket = &lt;bucket name&gt;
kinto.attachment.aws.acl = &lt;AWS ACL permissions|public-read&gt;
</pre>
<p>See <a href="https://pythonhosted.org/pyramid_storage/" rel="nofollow">Pyramid Storage</a>.</p>
<div id="production">
<h3>Production</h3>
<ul>
<li>Make sure the <tt>base_url</tt> can be reached (and points to <tt>base_path</tt> if
files are stored locally)</li>
<li>Adjust the max size for uploaded files (e.g. <tt>client_max_body_size 10m;</tt> for NGinx)</li>
</ul>
<p>For example, with NGinx</p>
<pre>server {
    listen 80;

    location /v1 {
        ...
    }

    location /files {
        root /var/www/kinto;
    }
}
</pre>
</div>
</div>
<div id="api">
<h2>API</h2>
<p><strong>POST /{record-url}/attachment</strong></p>
<p>It will create the underlying record if it does not exist.</p>
<p>Required</p>
<ul>
<li><tt>attachment</tt>: a single multipart-encoded file</li>
</ul>
<p>Optional</p>
<ul>
<li><tt>data</tt>: attributes to set on record (serialized JSON)</li>
<li><tt>permissions</tt>: permissions to set on record (serialized JSON)</li>
</ul>
<p><strong>DELETE /{record-url}/attachment</strong></p>
<p>Deletes the attachement from the record.</p>
<div id="attributes">
<h3>Attributes</h3>
<p>When a file is attached, the related record is given an <tt>attachment</tt> attribute
with the following fields:</p>
<ul>
<li><tt>filename</tt>: the original filename</li>
<li><tt>hash</tt>: a SHA-256 digest</li>
<li><tt>location</tt>: the URL of the attachment</li>
<li><tt>mimetype</tt>: the <a href="https://en.wikipedia.org/wiki/Media_type" rel="nofollow">media type</a> of
the file</li>
<li><tt>size</tt>: size in bytes</li>
</ul>
<pre>{
    "data": {
        "attachment": {
            "filename": "IMG_20150219_174559.jpg",
            "hash": "hPME6i9avCf/LFaznYr+sHtwQEX7mXYHSu+vgtygpM8=",
            "location": "http://cdn.service.org/files/ffa9c7b9-7561-406b-b7f9-e00ac94644ff.jpg",
            "mimetype": "text/plain",
            "size": 1481798
        },
        "id": "c2ce1975-0e52-4b2f-a5db-80166aeca688",
        "last_modified": 1447834938251,
        "theme": "orange",
        "type": "wallpaper"
    },
    "permissions": {
        "write": ["basicauth:6de355038fd943a2dc91405063b91018bb5dd97a08d1beb95713d23c2909748f"]
    }
}
</pre>
</div>
</div>
<div id="usage">
<h2>Usage</h2>
<div id="using-httpie">
<h3>Using HTTPie</h3>
<pre>http --auth alice:passwd --form POST http://localhost:8888/v1/buckets/website/collections/assets/records/c2ce1975-0e52-4b2f-a5db-80166aeca689/attachment data='{"type": "wallpaper", "theme": "orange"}' "attachment@~/Pictures/background.jpg"

HTTP/1.1 201 Created
Access-Control-Expose-Headers: Retry-After, Content-Length, Alert, Backoff
Content-Length: 209
Content-Type: application/json; charset=UTF-8
Date: Wed, 18 Nov 2015 08:22:18 GMT
Etag: "1447834938251"
Last-Modified: Wed, 18 Nov 2015 08:22:18 GMT
Location: http://localhost:8888/v1/buckets/website/collections/font/assets/c2ce1975-0e52-4b2f-a5db-80166aeca689
Server: waitress

{
    "filename": "IMG_20150219_174559.jpg",
    "hash": "hPME6i9avCf/LFaznYr+sHtwQEX7mXYHSu+vgtygpM8=",
    "location": "http://cdn.service.org/files/ffa9c7b9-7561-406b-b7f9-e00ac94644ff.jpg",
    "mimetype": "text/plain",
    "size": 1481798
}
</pre>
</div>
<div id="using-python-requests">
<h3>Using Python requests</h3>
<pre>auth = ("alice", "passwd")
attributes = {"type": "wallpaper", "theme": "orange"}
perms = {"read": ["system.Everyone"]}

files = [("attachment", ("background.jpg", open("Pictures/background.jpg", "rb"), "image/jpeg"))]

payload = {"data": json.dumps(attributes), "permissions": json.dumps(perms)}
response = requests.post(SERVER_URL + endpoint, data=payload, files=files, auth=auth)

response.raise_for_status()
</pre>
</div>
<div id="using-javascript">
<h3>Using JavaScript</h3>
<pre>var headers = {Authorization: "Basic " + btoa("alice:passwd")};
var attributes = {"type": "wallpaper", "theme": "orange"};
var perms = {"read": ["system.Everyone"]};

// File object from input field
var file = form.elements.attachment.files[0];

// Build form data
var payload = new FormData();
// Multipart attachment
payload.append('attachment', file, "background.jpg");
// Record attributes and permissions JSON encoded
payload.append('data', JSON.stringify(attributes));
payload.append('permissions', JSON.stringify(perms));

// Post form using GlobalFetch API
var url = `${server}/buckets/${bucket}/collections/${collection}/records/${record}/attachment`;
fetch(url, {method: "POST", body: payload, headers: headers})
  .then(function (result) {
    console.log(result);
  });
</pre>
</div>
</div>
<div id="known-limitations">
<h2>Known limitations</h2>
<ul>
<li>Because <a href="https://github.com/boto/boto" rel="nofollow">boto</a> is used for Amazon S3, this plugin is only compatible with
Python 2</li>
<li>Currently only Python 2.7 is tested/supported (#27)</li>
<li>No support for chunk upload (#10)</li>
<li>Fails when uploading files to <tt>default</tt> bucket (see Kinto/kinto#277)</li>
<li>Files are not removed when server is purged with <tt>POST /v1/__purge__</tt></li>
<li>Absolute URL is stored in record metadata (#24)</li>
</ul>
</div>
<div id="run-tests">
<h2>Run tests</h2>
<p>Run a fake Amazon S3 server in a separate terminal:</p>
<pre>make moto
</pre>
<p>Run the tests suite:</p>
<pre>make tests
</pre>
</div>

<div id="changelog">
<h2>Changelog</h2>
<div id="id1">
<h3>0.3.0 (2016-02-05)</h3>
<p><strong>New feature</strong></p>
<ul>
<li>Expose the API capability <tt>attachments</tt> in the root URL (#35)</li>
</ul>
<p><strong>Internal changes</strong></p>
<ul>
<li>Upgrade tests for Kinto 1.11.0 (#36)</li>
</ul>
</div>
<div id="id2">
<h3>0.2.0 (2015-12-21)</h3>
<p><strong>New feature</strong></p>
<ul>
<li>Setting to store files into folders by bucket or collection (fixes #22)</li>
</ul>
<p><strong>Bug fixes</strong></p>
<ul>
<li>Remove existing file when attachment is replaced (fixes #28)</li>
</ul>
<p><strong>Documentation</strong></p>
<ul>
<li>The demo is now fully online, since the Mozilla demo server has this plugin
installed.</li>
<li>Add some minimal information for production</li>
</ul>
</div>
<div id="id3">
<h3>0.1.0 (2015-12-02)</h3>
<ul>
<li>Initial working proof-of-concept.</li>
</ul>
</div>
</div>


<a name="downloads">Â </a>


<ul class="nodot">
  <li><strong>Downloads (All Versions):</strong></li>
  <li>
    <span>0</span> downloads in the last day
  </li>
  <li>
    <span>64</span> downloads in the last week
  </li>
  <li>
    <span>589</span> downloads in the last month
  </li>
</ul>









            </div>


          </div>
          </div></body></html>