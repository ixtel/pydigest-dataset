<html><body><div><div class="entry-content">
		<p><a href="https://impythonist.files.wordpress.com/2015/08/art_hipster-wallpaper-960x540.jpg"><img class="aligncenter size-full wp-image-1146" src="https://impythonist.files.wordpress.com/2015/08/art_hipster-wallpaper-960x540.jpg?w=1000" alt="art_hipster-wallpaper-960x540"/></a></p>
<p>Namaste everyone.Today we are going to talk about building real time data push engines.How to design models for the modern realtime web will be the lime light point in this article. We are going to build a cool push enigne that notifies “Super Heroes” real time in the Justice League(DC). We can also develop real time chat applications very easily with same principles.</p>
<h2 id="toc_0">What actually is a Data Push Engine?</h2>
<p>Push engine is nothing but a software piece that pushes notifications from the server to all the clients who subscribed to recieve these events.When your app polls for data, it becomes slow, unscalable, and cumbersome to maintain.In order to overcome this burden two proposals were made.</p>
<ol>
<li>Web Sockets</li>
<li>Server Sent Events(SSE)</li>
</ol>
<p>But using any one of the above technologies is not sufficient for modern real time web. Think it in this way. The query-response database access model works well on the web because it maps directly to HTTP’s request-response. However, modern marketplaces, streaming analytics apps, multiplayer games, and collaborative web and mobile apps require sending data directly to the client in realtime. For example, when a user changes the position of a button in a collaborative design app, the server has to notify other users that are simultaneously working on the same project. Web browsers support these use cases via WebSockets and long-lived HTTP connections, but relying on database to notify updates is cool.</p>
<h2 id="toc_0">Seeing is believing</h2>
<p>I am going to run my project first to make you confident with it. Project is nothing but a website which does following. Code for this project is available at <a href="https://github.com/narenaryan/thinktor" target="_blank"> https://github.com/narenaryan/thinktor</a></p>
<ul>
<li>I am going to start a Justice League website (like the one superman runs).</li>
<li>Website collects nickname and email of a SuperHero.</li>
<li>Notify all existing heroes about new joinees in real time.</li>
</ul>
<p>So I am going to tell you a small story. Just click the first image and navigate to last one by one. Don’t forget to read description below in each  image!. Press Esc to exit from slide show.</p>
<div data-carousel-extra="{&quot;blog_id&quot;:62549587,&quot;permalink&quot;:&quot;https:\/\/impythonist.wordpress.com\/2015\/08\/02\/build-a-real-time-data-push-engine-using-python-and-rethinkdb\/&quot;,&quot;likes_blog_id&quot;:62549587}" id="gallery-1145-6" class="gallery galleryid-1145 gallery-columns-3 gallery-size-thumbnail"><figure class="gallery-item">
			
				<figcaption class="wp-caption-text gallery-caption" id="gallery-1145-6-1158">
				This is our landing page.It asks for information from a Superhero and takes him to dashboard
				</figcaption></figure><figure class="gallery-item">
			
				<figcaption class="wp-caption-text gallery-caption" id="gallery-1145-6-1157">
				Now Ironman came first and entered his details
				</figcaption></figure><figure class="gallery-item">
			
				<figcaption class="wp-caption-text gallery-caption" id="gallery-1145-6-1159">
				Now Ironman should sit idle because he do not have any companion on his board
				</figcaption></figure><figure class="gallery-item">
			
				<figcaption class="wp-caption-text gallery-caption" id="gallery-1145-6-1152">
				Then Thor came from space , opens browser in his laptop , entered details and hits go.
				</figcaption></figure><figure class="gallery-item">
			
				<figcaption class="wp-caption-text gallery-caption" id="gallery-1145-6-1156">
				Suddenly when Thor  joins the league , our Push engine notifies Ironman about Thor
				</figcaption></figure><figure class="gallery-item">
			
				<figcaption class="wp-caption-text gallery-caption" id="gallery-1145-6-1153">
				Then suddenly hulk came aggresively and joined the league with blasting the keyboard
				</figcaption></figure><figure class="gallery-item">
			
				<figcaption class="wp-caption-text gallery-caption" id="gallery-1145-6-1155">
				Iron man is now glad to see another powerful hero joining his team
				</figcaption></figure><figure class="gallery-item">
			
				<figcaption class="wp-caption-text gallery-caption" id="gallery-1145-6-1154">
				Thor saw a live notification pushed to his dashboard about Hulk.He is thinking how he came to know about Hulk without refreshing web page
				</figcaption></figure><figure class="gallery-item">
			
				<figcaption class="wp-caption-text gallery-caption" id="gallery-1145-6-1165">
				In this way the team is formed and fought with Aliens finally
				</figcaption></figure>
		</div>

<p>I think you got something with above story.If you don’t let me explain. Here we are asking information from clients and navigating them to their dashboard. From then all clients who are on dashboard will be notified about newly joined people instantly. No refresh,No ajax polling. Thanks to our push engine.</p>
<h2 id="toc_0">Are you kidding ,I can implement that using web sockets?</h2>
<p>Yes are right. You can purely implement the above notification system using websockets. But why I used few more things to do that. Here is the answer.</p>
<p>“Using websockets code for designing push logic  is cumbersome. Websocket code must do a push from server and recieve that in client . Traditional databases do not know about the websockets or Server Sent Events. There we need to poll the database changes and then push them to intermediate queue and from there to clients. I say remove that headache from our server. Just exploit database capability of pushing changes in realtime whenever a change occurs to it’s data. <strong>That is why I chose RethinkDB plus Websockets</strong>“.</p>
<h2 id="toc_0">How I build that Push engine</h2>
<p>I used two main ingredients to create data push engine shown above.</p>
<ol>
<li>Python Tornado web server ( for handling websocket requests and responses)</li>
<li>RethinkDB ( for storing data and also to push real time changes to the server)</li>
</ol>
<h2 id="toc_0">What is RethinkDB?</h2>
<p>According to RethinkDB official website</p>
<blockquote><p>RethinkDB is the first open-source, scalable JSON database built from the ground up for the realtime web. It inverts the traditional database architecture by exposing an exciting new access model – instead of polling for changes, the developer can tell RethinkDB to continuously push updated query results to applications in realtime. RethinkDB’s realtime push architecture dramatically reduces the time and effort necessary to build scalable realtime apps.</p></blockquote>
<h2 id="when-is-rethinkdb-a-good-choice">When is RethinkDB a good choice?</h2>
<blockquote><p>RethinkDB is a great choice when your applications could benefit from realtime feeds to your data.</p>
<p>The query-response database access model works well on the web because it maps directly to HTTP’s request-response. However, modern applications require sending data directly to the client in realtime. Use cases where companies benefited from RethinkDB’s realtime push architecture include:</p>
<ul>
<li>Collaborative web and mobile apps</li>
<li>Streaming analytics apps</li>
<li>Multiplayer games</li>
<li>Realtime marketplaces</li>
<li>Connected devices</li>
</ul>
</blockquote>
<p>We know that modern web demands falls in one of the above catagories.So RethinkDB is extremely useful for the people want to exploit it’s real power for building real time apps.</p>
<p>RethinkDB has a dedicated python driver.In our project we are just inserting our dicument and reading the changes on users table.For getting familiar with RethinkDB python client visit these links.</p>
<p><a href="http://rethinkdb.com/docs/guide/python/" target="_blank">http://rethinkdb.com/docs/guide/python/</a></p>
<p><a href="http://rethinkdb.com/docs/introduction-to-reql/" target="_blank">http://rethinkdb.com/docs/introduction-to-reql/</a></p>
<h2 id="toc_0">Setup for our data push engine</h2>
<p>Install RethinkDB on Ubuntu14.04 in this way.</p>
<pre class="code-pre ">$ source /etc/lsb-release &amp;&amp; echo "deb http://download.rethinkdb.com/apt $DISTRIB_CODENAME main" | sudo tee /etc/apt/sources.list.d/rethinkdb.list
$ wget -qO- http://download.rethinkdb.com/apt/pubkey.gpg | sudo apt-key add -
$ sudo apt-get update &amp;&amp; sudo apt-get install rethinkdb
$ sudo cp /etc/rethinkdb/default.conf.sample /etc/rethinkdb/instances.d/instance1.conf
$ sudo /etc/init.d/rethinkdb restart</pre>
<p class="de1"/>
<p>Create virtualenv for the project and install required libraries</p>
<pre class="code-pre ">$ virtualenv rethink
$ source rethink/bin/activate
$ pip install tornado rethinkdb jinja2</pre>
<p>Now everything is fine.My main applciation will be app.py and there are templates and staticfiles in my project.The project structure looks like this.</p>
<pre class="code-pre ">.
|-- app.py
|-- conf.py
|-- requirements.txt
|-- static
|  `-- js
|      `-- sockhand.js
`-- templates
|   `--detail.html
    `--home.html</pre>
<p>Now letus write our app.py file.</p>
<pre class="code-pre ">#For tornado server stuff 

import tornado.ioloop
import tornado.web
import tornado.gen
import tornado.websocket
import tornado.httpserver
from tornado.concurrent import Future


from jinja2 import Environment, FileSystemLoader #For templating stuff

import rethinkdb as r #For db stuff

from rethinkdb.errors import RqlRuntimeError, RqlDriverError

from conf import * #Fetching db and table details here


#Load the template environment

template_env = Environment(loader=FileSystemLoader("templates"))

db_connection = r.connect(RDB_HOST,RDB_PORT) #Connecting to RethinkDB server

#Our superheroes who connects to server
subscribers = set() 

#This is just for cross-checking database and table exists 
def dbSetup():
    print PROJECT_DB,db_connection
    try:
        r.db_create(PROJECT_DB).run(db_connection)
        print 'Database setup completed.'
    except RqlRuntimeError:
        try:
            r.db(PROJECT_DB).table_create(PROJECT_TABLE).run(connection)
            print 'Table creation completed'
        except:
            print 'Table already exists.Nothing to do'
        print 'App database already exists.Nothing to do'
    db_connection.close()

#There is a loop type in python rethinkDB client.set it to tornado
r.set_loop_type("tornado")


class MainHandler(tornado.web.RequestHandler): #Class that renders details page and Dashbaord
    @tornado.gen.coroutine
    def get(self):
        detail_template = template_env.get_template("detail.html") #Loads tenplate
        self.write(detail_template.render())
 
    @tornado.gen.coroutine
    def post(self):
        home_template = template_env.get_template("home.html")
        email = self.get_argument("email")
        name = self.get_argument("nickname")
        connection = r.connect(RDB_HOST, RDB_PORT, PROJECT_DB)
        #Thread the connection
        threaded_conn = yield connection
        result = r.table(PROJECT_TABLE).insert({ "name": name , "email" : email}, conflict="error").run(threaded_conn)
        print 'log: %s inserted successfully'%result
        self.write(home_template.render({"name":name}))


#Sends the new user joined alerts to all subscribers who subscribed
@tornado.gen.coroutine
def send_user_alert():
    while True:
        try:
            temp_conn = yield r.connect(RDB_HOST,RDB_PORT,PROJECT_DB)
            feed = yield r.table("users").changes().run(temp_conn)
            while (yield feed.fetch_next()):
                new_user_alert = yield feed.next()
                for subscriber in subscribers:
                    subscriber.write_message(new_user_alert)
        except:
            pass


class WSocketHandler(tornado.websocket.WebSocketHandler): #Tornado Websocket Handler
    def check_origin(self, origin):
        return True

    def open(self):
        self.stream.set_nodelay(True)
        subscribers.add(self) #Join client to our league

    def on_close(self):
        if self in subscribers:
            subscribers.remove(self) #Remove client


if __name__ == "__main__":
    dbSetup() #Check DB and Tables were pre created
 
    #Define tornado application
    current_dir = os.path.dirname(os.path.abspath(__file__))
    static_folder = os.path.join(current_dir, 'static')
    tornado_app = tornado.web.Application([('/', MainHandler), #For Landing Page (r'/ws', WSocketHandler), #For Sockets
(r'/static/(.*)', tornado.web.StaticFileHandler, { 'path': static_folder }) #Define static folder 
 ])

    #Start the server
    server = tornado.httpserver.HTTPServer(tornado_app)
    server.listen(8000) #Bind port 8888 to server
    tornado.ioloop.IOLoop.current().add_callback(send_user_alert)
    tornado.ioloop.IOLoop.instance().start()</pre>
<p>I am going to define database configuration parameters like db_name, table_name etc in seperate conf.py file.</p>
<pre class="code-pre ">import os

RDB_HOST = os.environ.get('RDB_HOST') or 'localhost'
RDB_PORT = os.environ.get('RDB_PORT') or 28015
PROJECT_DB = 'userfeed'
PROJECT_TABLE = 'users'</pre>
<p>That’s it. We had our app.py and conf.py ready. I will explain what I did above in app.py point-wise below.</p>
<ul>
<li>importing tornado tools and rethinkDB client drivers</li>
<li>writing a function called <strong>db_setup</strong> that checks whether required database and table were created or not</li>
<li>using <strong>MainHandler</strong> class to handle http requests. For GET request displaying enter details page and for POST showing the dashboard.</li>
<li><strong>WSocketHandler</strong> is the tornado websocket handler that adds or removes subscribers.</li>
<li>We have one method called <strong>send_user_alert</strong> . It is the actual pusher of changes to the client.It does only two things. “subscribing to database table change” . “sending those changes to client “</li>
</ul>
<p>In rethinkdb we have a concept called change feeds. It is similar to Redis PUBSUB.We can subscibe to a particular change-feed and rethindb returns us a cursor which is of infinite length.Whenever db recieves a change in particular table it triggers event to that subscribed cursor with new and old values of data.For example.</p>
<pre class="code-pre ">#cursor is returned when we subscribe to changes on authors table
cursor = r.table("users").changes().run(connection)

#just loop through it infinitely to grab changes that RethinkDB push to cursor
for document in cursor:
     print(document)</pre>
<p>I think you got the thing by now. The other files in our project are templates and static files</p>
<ul>
<li>detail.html</li>
<li>home.html</li>
<li>sockhand.js</li>
</ul>
<p>The code for templates is quite obvious. You can find templates here  <a href="https://github.com/narenaryan/thinktor" target="_blank">https://github.com/narenaryan/thinktor</a></p>
<p>But we need to look into js file<code class="highlight"/></p>
<p/>
<pre class="code-pre "> 
//function that listens to Socket and do something when notification comes
function listen() {
    var source = new WebSocket('ws://' + window.location.host + '/ws');
    var parent = document.getElementById("mycol")
    source.onmessage = function(msg) {
              var message = JSON.parse(msg.data);
              console.log(message);
              //Return random color for superhero
 
              var child = document.createElement("DIV");
              child.className = 'ui red message';
 
              var text = message['new_val']['name'].toUpperCase() + ' joined the league on '+ Date(); 
              var content = document.createTextNode(text);
              child.appendChild(content);
              parent.appendChild(child);
              return false;
       }
}

$(document).ready(function(){
    console.log('I am ready'); 
    listen();
});

</pre>
<p>Here we are defining a listen function when webpage is loaded. That listen function initializes a variable called source which is of type WebSocket and links it to the /ws url that we defined in the Tornado application. It also sets a callback when a message is recieved and that callback code updates the DOM structure and adds information about new user.</p>
<p>If you are still confused ,then run  application yourselves and see the things. The app we wrote above is a data push engine that routes directly from database to client.  Go to this project link <a href="https://github.com/narenaryan/thinktor" target="_blank">https://github.com/narenaryan/thinktor</a> . clone it. Install requirements.txt .Then run app.py.Just visit localhost:8000. If you still have any queries on how it works then feel free to comment below or approach <strong>narenarya@live.com</strong></p>
<p>I thought to introduce rethinkDB for absolute beginners but article becomes very lengthy then.Sure I will come up with an article dedicated for RethinkDB in near future.</p>
<p>In this way we can build a real time data push engine using python and Rethinkdb.</p>
<h2 id="toc_0">Points to ponder</h2>
<ul>
<li>Use rethinkDB for building real time applications.It is scalable too.</li>
<li>Use Tornado because it can easily handle concurrent connections without any fuss.</li>
<li>Remove queuing from your architecturaal design</li>
<li>Use websockets for bidirectional communication</li>
<li>Try out new things frequently</li>
</ul>
<h2 id="toc_0">References</h2>

		<p id="geo-post-1145" class="geo geo-post">
			<span class="latitude">12.971599</span>
			<span class="longitude">77.594563</span>
		</p>		<div id="jp-post-flair" class="sharedaddy sd-like-enabled sd-sharing-enabled"><p class="geolocation-chip"><span class="noticon noticon-location"/>Bengaluru, Karnataka, India</p>
<div class="sharedaddy sd-block sd-like jetpack-likes-widget-wrapper jetpack-likes-widget-unloaded" id="like-post-wrapper-62549587-1145-56d5b714b0f8e" data-src="//widgets.wp.com/likes/#blog_id=62549587&amp;post_id=1145&amp;origin=impythonist.wordpress.com&amp;obj_id=62549587-1145-56d5b714b0f8e" data-name="like-post-frame-62549587-1145-56d5b714b0f8e"><h3 class="sd-title">Like this:</h3><p class="likes-widget-placeholder post-likes-widget-placeholder"><span class="button"><span>Like</span></span> <span class="loading">Loading...</span></p><span class="sd-text-color"/><a class="sd-link-color"/></div>
<p id="jp-relatedposts" class="jp-relatedposts">
	<h3 class="jp-relatedposts-headline"><em>Related</em></h3>
</p></div>					</div>

	</div></body></html>