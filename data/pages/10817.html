<html><body><div><article class="markdown-body entry-content" itemprop="text"><h1><a id="user-content-api-gateway" class="anchor" href="#api-gateway" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>API Gateway</h1>

<p>This project is still in development, api may change anytime. If you want to use it, fix what you need.</p>

<p>API 是连接 App 和服务器数据库的桥梁，在 App 和各种 API 多了之后，对这些 API 的管理和保护就带来了一系列的问题。比如：</p>

<ol>
<li>如何保护 API 不被非法访问，只能由 App 正常发起请求？</li>
<li>如何控制不同 App 对多种多样 API 的访问权限？</li>
<li>API 的访问情况怎样，日志如何查看？</li>
</ol>

<p>于是，就有了 API Gateway 这个项目。</p>

<h2><a id="user-content-类似项目" class="anchor" href="#类似项目" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>类似项目</h2>



<h2><a id="user-content-环境及依赖" class="anchor" href="#环境及依赖" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>环境及依赖</h2>

<p>需要安装 redis, 当前只在 Python 2.7 环境下测试过</p>

<pre><code>cerberus&gt;=0.9
requests
six
tornado&gt;=4.0
redis
pycrypto
ConcurrentLogHandler
</code></pre>

<h2><a id="user-content-运行" class="anchor" href="#运行" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>运行</h2>

<p>配置 settings.py </p>

<div class="highlight highlight-source-python"><pre><span class="pl-c"># 访问签名的有效时间, 秒</span>
<span class="pl-c1">SIGNATURE_EXPIRE_SECONDS</span> <span class="pl-k">=</span> <span class="pl-c1">3600</span>

<span class="pl-c1">HOST</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>127.0.0.1<span class="pl-pds">'</span></span>
<span class="pl-c1">PORT</span> <span class="pl-k">=</span> <span class="pl-c1">6500</span>

<span class="pl-c"># 是否调试模式</span>
<span class="pl-c1">DEBUG</span> <span class="pl-k">=</span> <span class="pl-c1">False</span>

<span class="pl-c"># Redis 配置</span>
<span class="pl-c1">REDIS_HOST</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>127.0.0.1<span class="pl-pds">'</span></span>
<span class="pl-c1">REDIS_PORT</span> <span class="pl-k">=</span> <span class="pl-c1">6379</span>
<span class="pl-c1">REDIS_DB</span> <span class="pl-k">=</span> <span class="pl-c1">0</span>
<span class="pl-c1">REDIS_PASSWORD</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>your_password<span class="pl-pds">'</span></span>
<span class="pl-c1">REDIS_MAX_CONNECTIONS</span> <span class="pl-k">=</span> <span class="pl-c1">100</span>

<span class="pl-c"># MongoDB 配置</span>
<span class="pl-c1">MONGO_HOST</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>127.0.0.1<span class="pl-pds">'</span></span>
<span class="pl-c1">MONGO_PORT</span> <span class="pl-k">=</span> <span class="pl-c1">27017</span>
<span class="pl-c1">MONGO_USERNAME</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>api_gateway_user<span class="pl-pds">'</span></span>
<span class="pl-c1">MONGO_PASSWORD</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>api_gateway_password<span class="pl-pds">'</span></span>
<span class="pl-c1">MONGO_DBNAME</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>api_gateway<span class="pl-pds">'</span></span></pre></div>

<p>运行</p>

<pre><code>python runserver.py
</code></pre>

<h2><a id="user-content-相关项目" class="anchor" href="#相关项目" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>相关项目</h2>

<ol>
<li><a href="https://github.com/restran/api-gateway-dashboard">api-gateway-dashbaord</a> API Gateway 的 Web 控制台</li>
<li><a href="https://github.com/restran/api-python-client">api-python-client</a> Python 版本的 API Clinet</li>
</ol>

<h2><a id="user-content-设计说明" class="anchor" href="#设计说明" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>设计说明</h2>

<p>这是一个 JSON API 的网关，实际上不管背后受保护的 API 传输的是什么，都能正常传输，只是网关会在出错时，以 JSON 数据返回错误信息。在设计上借鉴了 <a href="https://github.com/mqingyn/torngas">torngas</a> 的中间件模式。当前仅支持 <code>GET</code> 和 <code>POST</code> 方法。</p>

<p><a href="/restran/api-gateway/blob/master/doc/design.png" target="_blank"><img src="/restran/api-gateway/raw/master/doc/design.png" alt="img.png"/></a></p>

<h2><a id="user-content-hmac-签名" class="anchor" href="#hmac-签名" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>HMAC 签名</h2>

<p>和大多数的云应用一样，每个 Client 将会分配一对 <code>access_key</code> 和 <code>sercret_key</code>。<code>access_key</code> 用来唯一标识这个 Client，<code>sercret_key</code> 则用来执行 HMAC 签名和 AES 加密。API 请求的 URL 和 Body 数据都会被 <code>secret_key</code> 签名，并且会双向验证数据的签名，保证请求和返回的数据没有被篡改。签名方法采用了 HMAC-SHA256。</p>

<h3><a id="user-content-特殊状态码" class="anchor" href="#特殊状态码" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>特殊状态码</h3>

<p>为了区分是网关层面执行时就出现错误返回数据，还是背后真正提供服务的 API 返回的数据，定义一个特殊的<code>状态码 600</code>，如果状态码为 600，则表示网关返回的。</p>

<h3><a id="user-content-aes-加密" class="anchor" href="#aes-加密" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>AES 加密</h3>

<p>虽然 HTTPS 正在大多数网站中普及，但是如果仍然只能使用 HTTP，或者存在中间人攻击，数据内容就存在泄漏的风险，因此提供了 AES 加密的功能，可以对传输数据的 URL、Headers、Body 都进行加密，AES 加密是可选的。</p>

<h3><a id="user-content-登录校验" class="anchor" href="#登录校验" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>登录校验</h3>

<p>存在这样的情况，有些 API 需要登录后才能访问，有些则无需登录。api-gateway 内置了 Auth Endpoint (endpoint_name: auth, version: v1), 包含了三个 API:</p>

<ol>
<li><code>/login/</code> 登录</li>
<li><code>/logout/</code> 注销</li>
<li><code>/token/</code> 用 <code>refresh_token</code> 获取新的 <code>access_token</code></li>
</ol>

<p>对于需要登录的 API，则需要先访问 <code>/login/</code> 获取 <code>access_token</code>, 返回的数据如下:</p>

<div class="highlight highlight-source-json"><pre>{
    <span class="pl-s"><span class="pl-pds">"</span>code<span class="pl-pds">"</span></span>: <span class="pl-c1">200</span>,
    <span class="pl-s"><span class="pl-pds">"</span>msg<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>,
    <span class="pl-s"><span class="pl-pds">"</span>data<span class="pl-pds">"</span></span>: {
        <span class="pl-s"><span class="pl-pds">"</span>access_token<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>abcd<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>refersh_token<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>efgh<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>expires_in<span class="pl-pds">"</span></span>: <span class="pl-c1">1456512810</span>,
        <span class="pl-s"><span class="pl-pds">"</span>user_info<span class="pl-pds">"</span></span>: {

        }
    }
}</pre></div>

<ul>
<li><code>expires_in</code>：<code>access_token</code> 的过期时间</li>
<li><code>refersh_token</code>：当 <code>access_token</code> 过期时，用来获取新的 <code>access_token</code></li>
<li><code>user_info</code>：Auth API 返回的用户信息</li>
</ul>

<p><code>/login/</code> API 会根据配置的 Auth API 去校验提交的登录信息是否正确，如果登录正确 Auth API 返回用户信息。</p>

<p><code>/token/</code> API 用来获取新的 <code>access_token</code>，提交的数据：</p>

<div class="highlight highlight-source-json"><pre>{
    <span class="pl-s"><span class="pl-pds">"</span>refersh_token<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>efgh<span class="pl-pds">"</span></span>
}</pre></div>

<p>以后访问需要登录保才能访问的 API 在 url 带上 access_token, 例如:</p>

<pre><code>http://example.com/api/v1/?access_token=abcd
</code></pre>

<p>API Gateway 在遇到访问需要登录的 API 时，就会根据这个 <code>access_token</code> 去 redis 中验证这个 <code>access_token</code> 是否有效，并获取该用户的信息。然后将用户信息存储在 Headers 中，以 <code>X-Api-User-Json</code> 传递给后端的 API。该 Header 存储的数据是 user_info 的 json 字符串的 base64 编码数据。</p>

<h2><a id="user-content-todo" class="anchor" href="#todo" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>TODO</h2>


</article>
  </div></body></html>