<html><body><div><article class="markdown-body entry-content" itemprop="text"><h1><a id="user-content-patchy" class="anchor" href="#patchy" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Patchy</h1>
<a href="https://travis-ci.org/adamchainz/patchy"><img src="https://camo.githubusercontent.com/517edb8b8f3d2436818c935263df3eaf3b371568/68747470733a2f2f696d672e736869656c64732e696f2f7472617669732f6164616d636861696e7a2f7061746368792f6d61737465722e737667" data-canonical-src="https://img.shields.io/travis/adamchainz/patchy/master.svg"/>
</a>
<a href="https://pypi.python.org/pypi/patchy"><img src="https://camo.githubusercontent.com/229b2ec6be0e965ce3bcadb1fe3f581ec79a33e7/68747470733a2f2f696d672e736869656c64732e696f2f707970692f762f7061746368792e737667" data-canonical-src="https://img.shields.io/pypi/v/patchy.svg"/>
</a>

<p>Patch the source of python functions at runtime (not monkey-patching - actual
patch-patching).</p>
<p>A quick example:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">def</span> <span class="pl-en">sample</span>():
<span class="pl-c1">...</span>    <span class="pl-k">return</span> <span class="pl-c1">1</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> patchy.patch(sample, <span class="pl-s"><span class="pl-pds">"""</span><span class="pl-c1">\</span></span>
<span class="pl-s">...     @@ -1,2 +1,2 @@</span>
<span class="pl-s">...      def sample():</span>
<span class="pl-s">...     -    return 1</span>
<span class="pl-s">...     +    return 9001</span>
<span class="pl-s">...     <span class="pl-pds">"""</span></span>)
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> sample()
<span class="pl-c1">9001</span></pre></div>
<a name="user-content-installation"/>
<h2><a id="user-content-installation" class="anchor" href="#installation" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Installation</h2>
<p>Use <strong>pip</strong>:</p>

<p>Tested on Python 2.7, 3.4, and 3.5.</p>
<a name="user-content-why"/>
<h2><a id="user-content-why" class="anchor" href="#why" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Why?</h2>
<p>If you’re monkey-patching an external library to add or fix some functionality,
you will probably forget to check the monkey patch when you upgrade it. By
using a patch against its source code, you can specify some context that you
expect to remain the same in the function that will be checked before the
source is applied.</p>
<p>I found this with some small but important patches to Django for a project.
Since it takes a lot of energy to maintain a fork, writing monkey patches was
the chosen quick solution, but then writing actual patches would be better.</p>
<p>The patches are applied with the standard <code>patch</code> commandline utility.</p>
<a name="user-content-why-not"/>
<h2><a id="user-content-why-not" class="anchor" href="#why-not" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Why not?</h2>
<p>There are of course a lot of reasons against:</p>
<ul>
<li>It’s (relatively) slow (since it writes the source to disk and calls the
<code>patch</code> command)</li>
<li>If you have a patch file, why not just fork the library and apply it?</li>
<li>At least with monkey-patching you know you what end up with, rather than
having the changes being done at runtime to source that may have changed.</li>
</ul>
<p>All are valid arguments. However once in a while this might be the right
solution.</p>
<a name="user-content-how"/>
<h2><a id="user-content-how" class="anchor" href="#how" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>How?</h2>
<p>The standard library function <code>inspect.getsource()</code> is used to retrieve the
source code of the function, the patch is applied with the commandline utility
<code>patch</code>, the code is recompiled, and the function’s code object is replaced
the new one. Because nothing tends to poke around at code objects apart from
dodgy hacks like this, you don’t need to worry about chasing any references
that may exist to the function, unlike <code>mock.patch</code>.</p>
<p>A little special treatment is given to <code>instancemethod</code>, <code>classmethod</code>, and
<code>staticmethod</code> objects to make sure the underlying function is what gets
patched and that you don't have to worry about the details.</p>
<a name="user-content-api"/>
<h2><a id="user-content-api" class="anchor" href="#api" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>API</h2>
<a name="user-content-patch-func-patch-text"/>
<h3><a id="user-content-patchfunc-patch_text" class="anchor" href="#patchfunc-patch_text" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a><code>patch(func, patch_text)</code></h3>
<p>Apply the patch <code>patch_text</code> to the source of function <code>func</code>.</p>
<p>If the patch is invalid, for example the context lines don’t match,
<code>ValueError</code> will be raised, with a message that includes all the output from
the <code>patch</code> utility.</p>
<p>Note that <code>patch_text</code> will be <code>textwrap.dedent()</code>’ed, but leading
whitespace will not be removed. Therefore the correct way to include the patch
is with a triple-quoted string with a backslash - <code>"""\</code> - which starts the
string and avoids including the first newline. A final newline is not required
and will be automatically added if not present.</p>
<p>Example:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">import</span> patchy

<span class="pl-k">def</span> <span class="pl-en">sample</span>():
    <span class="pl-k">return</span> <span class="pl-c1">1</span>

patchy.patch(sample, <span class="pl-s"><span class="pl-pds">"""</span><span class="pl-c1">\</span></span>
<span class="pl-s">    @@ -2,2 +2,2 @@</span>
<span class="pl-s">    -    return 1</span>
<span class="pl-s">    +    return 2<span class="pl-pds">"""</span></span>)

<span class="pl-c1">print</span>(sample())  <span class="pl-c"># prints 2</span></pre></div>
<a name="user-content-unpatch-func-patch-text"/>
<h3><a id="user-content-unpatchfunc-patch_text" class="anchor" href="#unpatchfunc-patch_text" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a><code>unpatch(func, patch_text)</code></h3>
<p>Unapply the patch <code>patch_text</code> from the source of function <code>func</code>. This is
the reverse of <code>patch()</code>ing it, and calls <code>patch --reverse</code>.</p>
<p>The same error and formatting rules apply as in <code>patch()</code>.</p>
<p>Example:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">import</span> patchy

<span class="pl-k">def</span> <span class="pl-en">sample</span>():
    <span class="pl-k">return</span> <span class="pl-c1">2</span>

patchy.unpatch(sample, <span class="pl-s"><span class="pl-pds">"""</span><span class="pl-c1">\</span></span>
<span class="pl-s">    @@ -2,2 +2,2 @@</span>
<span class="pl-s">    -    return 1</span>
<span class="pl-s">    +    return 2<span class="pl-pds">"""</span></span>)

<span class="pl-c1">print</span>(sample())  <span class="pl-c"># prints 1</span></pre></div>
<a name="user-content-temp-patch-func-patch-text"/>
<h3><a id="user-content-temp_patchfunc-patch_text" class="anchor" href="#temp_patchfunc-patch_text" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a><code>temp_patch(func, patch_text)</code></h3>
<p>Usable as a context manager or function decorator to wrap code with a call to
<code>patch</code> before and <code>unpatch</code> after.</p>
<p>Context manager example:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">def</span> <span class="pl-en">sample</span>():
    <span class="pl-k">return</span> <span class="pl-c1">1234</span>

patch_text <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"""</span><span class="pl-c1">\</span></span>
<span class="pl-s">    @@ -1,2 +1,2 @@</span>
<span class="pl-s">     def sample():</span>
<span class="pl-s">    -    return 1234</span>
<span class="pl-s">    +    return 5678</span>
<span class="pl-s">    <span class="pl-pds">"""</span></span>

<span class="pl-k">with</span> patchy.temp_patch(sample, patch_text):
    <span class="pl-c1">print</span>(sample())  <span class="pl-c"># prints 5678</span></pre></div>
<p>Decorator example, using the same <code>sample</code> and <code>patch_text</code>:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-en">@patchy.temp_patch</span>(sample, patch_text)
<span class="pl-k">def</span> <span class="pl-en">my_func</span>():
    <span class="pl-k">return</span> sample() <span class="pl-k">==</span> <span class="pl-c1">5678</span>

<span class="pl-c1">print</span>(my_func())  <span class="pl-c"># prints True</span></pre></div>
<a name="user-content-how-to-create-a-patch"/>
<h2><a id="user-content-how-to-create-a-patch" class="anchor" href="#how-to-create-a-patch" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>How to Create a Patch</h2>
<ol>
<li><p>Save the source of the function of interest in a <code>.py</code> file, e.g.
<code>before.py</code>. Make sure you dedent it so there is no whitespace before the
<code>def</code>:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">def</span> <span class="pl-en">foo</span>():
    <span class="pl-c1">print</span>(<span class="pl-s"><span class="pl-pds">"</span>Change me<span class="pl-pds">"</span></span>)</pre></div>
</li>
<li><p>Copy that <code>.py</code> file, to e.g. <code>after.py</code>, and make the changes you
want:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">def</span> <span class="pl-en">foo</span>():
    <span class="pl-c1">print</span>(<span class="pl-s"><span class="pl-pds">"</span>Changed<span class="pl-pds">"</span></span>)</pre></div>
</li>
<li><p>Run <code>diff</code>, e.g. <code>diff before.py after.py</code>. You will get output like:</p>
<div class="highlight highlight-source-diff"><pre><span class="pl-c1">diff --git a/Users/chainz/tmp/before.py b/Users/chainz/tmp/after.py</span>
index e6b32c6..31fe8d9 100644
<span class="pl-md">--- a/Users/chainz/tmp/before.py</span>
<span class="pl-mi1">+++ b/Users/chainz/tmp/after.py</span>
<span class="pl-mdr">@@ -1,2 +1,2 @@</span>
 def foo():
<span class="pl-md">-    print("Change me")</span>
<span class="pl-mi1">+    print("Changed")</span></pre></div>
</li>
<li><p>The filenames are not necessary for <code>patchy</code> to work. Take only from the
first <code>@@</code> line onwards into the multiline string you pass to
<code>patchy.patch()</code>:</p>
<div class="highlight highlight-source-python"><pre>patchy.patch(foo, <span class="pl-s"><span class="pl-pds">"""</span><span class="pl-c1">\</span></span>
<span class="pl-s">    @@ -1,2 +1,2 @@</span>
<span class="pl-s">     def foo():</span>
<span class="pl-s">    -    print("Change me")</span>
<span class="pl-s">    +    print("Changed")</span>
<span class="pl-s">    <span class="pl-pds">"""</span></span>)</pre></div>
</li>
</ol>

</article>
  </div></body></html>