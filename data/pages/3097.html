<html><body><div><div class="body"><div itemscope="" itemtype="http://schema.org/Article"><h1 class="title" itemprop="name">Dumping logs on test failures</h1><p class="date"> Sat 21 December 2013</p><div itemprop="articleBody"><p>In some situations it would be very nice to have some extra (external) logging output when <a class="reference external" href="http://docs.python.org/2/library/unittest.html">unittest</a> failures happen. Suppose these logs can be potentially big - you would only want them outputted if something actually failed.</p><p>The <a class="reference external" href="http://docs.python.org/2/library/unittest.html#unittest.TestCase.tearDown">tearDown</a> can't help you much here - you don't have access to the result. Ideally we would have a custom TestCase class that provides this functionality and subclass it whenever we need this behavior. We could override the <a class="reference external" href="http://docs.python.org/2/library/unittest.html#unittest.TestCase.run">run</a> method like described <a class="reference external" href="http://www.piware.de/2012/10/python-unittest-show-log-on-test-failure/">here</a> but unfortunately that's not very robust - for example <a class="reference external" href="https://nose.readthedocs.org/en/latest/">nose</a> will not call it (nose <a class="reference external" href="https://github.com/nose-devs/nose/blob/release_1.3.0/nose/suite.py#L537">rewrapps</a> all your test methods in <a class="reference external" href="https://github.com/nose-devs/nose/blob/release_1.3.0/nose/case.py#L19">different</a> TestCase instances).</p><p>We could write a <a class="reference external" href="https://nose.readthedocs.org/en/latest/">nose</a> plugin but that's a bad idea ... we would have to tag all our tests with a flag that activates this special behavior and, well, we're getting locked in.</p><p>Here's a base TestCase that provides said behavior:</p><div class="highlight"><pre><span/><span class="kn">from</span> <span class="nn">logging</span> <span class="kn">import</span> <span class="n">getLogger</span>
<span class="kn">from</span> <span class="nn">unittest.case</span> <span class="kn">import</span> <span class="n">TestCase</span><span class="p">,</span> <span class="n">SkipTest</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">LogfileRecordingTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="n">_log_offset</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">log_limit</span> <span class="o">=</span> <span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span> <span class="c1"># no more than 1mb</span>
    <span class="n">log_name</span> <span class="o">=</span> <span class="s1">'foobar.log'</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="o">=</span><span class="s1">'runTest'</span><span class="p">):</span>
        <span class="n">meth</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="p">)</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">meth</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">meth</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">SkipTest</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_logs</span><span class="p">()</span>
                <span class="k">raise</span>
        <span class="n">wrapper</span><span class="o">.</span><span class="n">__name__</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">methodName</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="p">,</span> <span class="n">wrapper</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">LogfileRecordingTestCase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">methodName</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_print_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_name</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_name</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_offset</span><span class="p">)</span>
                    <span class="n">output</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
                        <span class="k">print</span><span class="p">((</span><span class="s2">" "</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_name</span> <span class="o">+</span> <span class="s2">" "</span><span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">80</span><span class="p">))</span>
                        <span class="k">print</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">log_limit</span><span class="p">:])</span>
                        <span class="k">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">"Failed to extract logfile data."</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LogfileRecordingTestCase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_name</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_name</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">SEEK_END</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_offset</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
</pre></div><p>Notes:</p><ul class="simple"><li>If you're running some external service that generates this logs (you probably are if you really need this) you can have buffering issues. Worth taking a look at <a class="reference external" href="http://docs.python.org/2/using/cmdline.html#envvar-PYTHONUNBUFFERED">PYTHONUNBUFFERED</a> and <a class="reference external" href="http://linux.die.net/man/1/unbuffer">unbuffer</a> if you're doing some shell pipe redirects.</li><li>You might want to <tt class="docutils literal">from unittest2.case import SkipTest</tt> if you're using unittest2 - the classes will differ, and nose prefers the unittest2 import.</li></ul></div><p class="tags">This entry was tagged as <a href="https://blog.ionelmc.ro/tag/python/"><span itemprop="keywords">python</span></a><a href="https://blog.ionelmc.ro/tag/nose/"><span itemprop="keywords">nose</span></a><a href="https://blog.ionelmc.ro/tag/testing/"><span itemprop="keywords">testing</span></a><a href="https://blog.ionelmc.ro/tag/debugging/"><span itemprop="keywords">debugging</span></a><a href="https://blog.ionelmc.ro/tag/logging/"><span itemprop="keywords">logging</span></a></p></div><p id="disqus_thread"/><noscript> Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </div></div></body></html>