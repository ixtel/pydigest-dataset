<html><body><div><div class="post-text" itemprop="text">
<p><strong>This answer is most likely not the cause, check <a href="http://stackoverflow.com/a/28829162/1589147">http://stackoverflow.com/a/28829162/1589147</a> for information on a related supervisord bug instead.</strong></p>

<p>I can reproduce your error partially. I do not see the error when celery runs within supervisor. I see the error when I try to run the task from an environment outside supervisor where I did not set the <code>BROKER</code> environment variable. <code>celeryconfig.py</code> is executed both by celery and by anything which tries to execute a task.</p>

<p>I am not certain if this issue is exactly what you have come across, if you could share how you are executing the tasks and when that exception is raised it may help.</p>

<p>For example, if I try to run the task from <code>ipython</code> an error is generated which matches your error.</p>

<pre><code>In [1]: from tasks import add
In [2]: add.delay(2,3)
...
     21         if hasattr(self.__class__, "__missing__"):
     22             return self.__class__.__missing__(self, key)
---&gt; 23         raise KeyError(key)
     24     def __setitem__(self, key, item): self.data[key] = item
     25     def __delitem__(self, key): del self.data[key]

KeyError: 'BROKER'
</code></pre>

<p>The <code>celeryconfig.py</code> is loaded locally in order to establish a connection to the celery broker and backend. I am unable to execute the task without setting the <code>BROKER</code> environment variable.</p>

<p>If I set the environment variable before executing my task the same code works for me.</p>

<pre><code>In [3]: import os
In [4]: os.environ["BROKER"] = "broker is set"
In [5]: add.delay(2,3)
Out[5]: &lt;AsyncResult: 0f3xxxx-87fa-48d7-9258-173bdd2052ca&gt;
</code></pre>

<p>Here are the files I used in case it helps.</p>

<p><code>supervisor.conf</code>: <code>supervisord -c supervisor.conf</code></p>

<pre><code>[unix_http_server]
file=/tmp/supervisor.sock

[supervisord]
loglevel = info
nodaemon = true
identifier = supervisor

[supervisorctl]
serverurl=unix:///tmp/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[program:worker]
command=/app/srv/main-env/bin/celery -A tasks worker -Q default -l info -n default_worker.%%h
environment=BROKER="amqp://admin:password@xxxxx:5672//"
directory=/app/srv/
numprocs=1
stdout_logfile=/app/srv/worker.log
stderr_logfile=/app/srv/worker.log
autostart=true
autorestart=true
startsecs=10
stopwaitsecs = 600
killasgroup=true
priority=998
</code></pre>

<p><code>celeryconfig.py</code>:</p>

<pre><code>import os


BROKER = os.environ['BROKER']
</code></pre>

<p><code>tasks.py</code>:</p>

<pre><code>from celery import Celery

app = Celery(
    'tasks',
    backend='amqp',
    broker='amqp://admin:password@xxxxx:5672//')
app.config_from_object('celeryconfig')


@app.task
def add(x, y):
        return x + y
</code></pre>
    </div>
    </div></body></html>