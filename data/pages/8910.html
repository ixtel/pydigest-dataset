<html><body><div><li class="post text">
                        
                            <p>For some reason, photoshopping people’s faces onto other people’s heads is funny.</p>

<p><img src="http://i.imgur.com/0H7Lt.jpg" alt="Inception head replacement" title=""/></p>

<p>I don’t know why, it just is.</p>

<p>I was thinking about this, and it occurred to me that it should be possible to do it completely automatically, with face detection. So, instead of searching the literature to find the inevitable <a href="http://t.umblr.com/redirect?z=https%3A%2F%2Fdl.acm.org%2Fcitation.cfm%3Fid%3D1360612.1360638&amp;t=ZTVmNGE0NmI5Yzk3ZmM1YWJkMjU1ZDMwZGQyMjZiNmI5ZmJiZWFmMCx4WkZhZThTTA%3D%3D">excellent team of researchers who had done it years ago far better than I ever could</a>, I did what I used to do. I jumped in and started writing code.</p>

<p>A basic solution turns out to be pretty easy; I had a working prototype within an hour.</p>



<h1>How it Works</h1>

<p>The program is only 90 lines long, and its operation is very simple. It identifies the faces in the image, picks one at random, and pastes that face onto all the other face locations, adjusting the colour and blending a little at the edges.</p>

<h2>Finding Faces</h2>

<p>To automatically detect faces in the image, I used <a href="http://t.umblr.com/redirect?z=http%3A%2F%2Fopencv.org%2F&amp;t=ODI0NGNlOWM1MmJkYjA3Y2RhMGRkNTM1MTg1OTRiYTY0YTM3MWM2Yix4WkZhZThTTA%3D%3D">OpenCV</a>, which has handy python bindings and includes a nice face detection system using a <a href="http://t.umblr.com/redirect?z=http%3A%2F%2Fopencv.willowgarage.com%2Fwiki%2FFaceDetection&amp;t=MzY4NmI2MzE4ZmI1NWUyYWRmNTJhOTI1MGEyZWMzZjhjOTIyNTk2Myx4WkZhZThTTA%3D%3D">Haar Feature-based Cascade Classifier</a>.</p>

<p>I don’t fully understand how a Haar Feature-based Cascade Classifier works, but for the purposes of this application, that’s not really required. The important thing is that it scans over the image in increasingly large windows, looking for things that look like faces. When it’s done, it returns a list of boxes which it thinks have faces in them.</p>

<h2>Blending</h2>

<p>Once you know where the faces are, swapping them is just a matter of copying the contents of one face box into the location of another. But that of course that looks terrible, because you can easily see the boundary. I did two things to deal with this:</p>

<p>Before pasting, the colour of the image is adjusted so there’s no sharp colour change at the boundary. This is done very simply, by taking the average colour of both faces, and adjusting the brightness levels of the channels in the new face such that it has the same average colour as the place it’s about to be pasted. (Later I wrote a more complex version that used <a href="http://t.umblr.com/redirect?z=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FK_means&amp;t=ODAyMTZjNWM0YjdhMmNhNmY5NjQ1NTk1OThjZmNlOWNkNGE2YTIwNSx4WkZhZThTTA%3D%3D">K-Means Clustering</a> to find the skin tone and adjust based on that, but it didn’t work noticeably better than the mean-colour method, so I reverted to the simpler system).</p>

<p>The other thing I did to hide the boundary is use an <a href="http://t.umblr.com/redirect?z=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FMask_%2528computing%2529%23Image_masks&amp;t=ZWZlMTdhNzY2NzhiMzQyNDk3YzRjOWQ3NjQ0ZDQxNTMxNGQwNjAyZCx4WkZhZThTTA%3D%3D">alpha mask</a> when pasting, so the face isn’t just pasted in a square. <a href="http://t.umblr.com/redirect?z=http%3A%2F%2Fi.imgur.com%2FBFLTf.png&amp;t=OWEyNmIwY2I2MWU0NzFiZmJkMzMzZmI2ZThmMDE5NDRiMTNiNTI1NSx4WkZhZThTTA%3D%3D">The mask I used</a> is very simple, just a circle with smoothly fading edges.</p>

<p>Considering the program’s simplicity, I was surprised at the quality of the results:</p>

<p><a href="http://t.umblr.com/redirect?z=http%3A%2F%2Fi.imgur.com%2FOEwmU.jpg&amp;t=YmM3MmQ3YTFhMGI4MzA0OTRiYTQ2ZDkxNWJiNmZiMWNhZmFiNTdiYyx4WkZhZThTTA%3D%3D"><img src="http://i.imgur.com/OEwmU.jpg" alt="Crew of Serenity, with Zoe's face" title="Click for larger monstrosity"/></a></p>

<p>Simon and River don’t have their heads pointed straight at the camera, so the system pretty much fails completely for them. I think Mal is my favourite here though; to me he kind of looks like <a href="http://t.umblr.com/redirect?z=https%3A%2F%2Fencrypted.google.com%2Fsearch%3Fq%3Dtealc%26tbm%3Disch&amp;t=YTBkNzBmOGQ0NDNjNmJmY2VmMDEzMTlmMzk5NmY5NzlkYjI5ZGU4Yix4WkZhZThTTA%3D%3D">Teal'c from SG-1</a>.</p>

<p>Here’s the result of attempting a more challenging image, a group photo of my research group, <a href="http://t.umblr.com/redirect?z=http%3A%2F%2Fima.ac.uk%2F&amp;t=MGZkMDFkMjg0Zjk4MjUwMmNiY2Q5MzVhMzYwMGY2NDQ3OWJiMGNiMyx4WkZhZThTTA%3D%3D">The Intelligent Modelling and Analysis Group</a> at <a href="http://t.umblr.com/redirect?z=https%3A%2F%2Fwww.nottingham.ac.uk%2Fcomputerscience%2Findex.aspx&amp;t=ZWI4Y2U0NzNhNDliZDNhNzMxZDFhY2ViNjYzZjYwM2I3ODE4NjExNCx4WkZhZThTTA%3D%3D">UoN CS</a>:</p>

<p><a href="http://t.umblr.com/redirect?z=http%3A%2F%2Fi.imgur.com%2Fd9kEM.jpg&amp;t=NjMxMzg3ZTJjYzNmYThhNTVlNDAzMDI5YjhiZmY2MDNkZTJjYTRkZCx4WkZhZThTTA%3D%3D"><img src="http://i.imgur.com/d9kEMh.jpg" alt="IMA with Uve's face" title="Click for larger image"/></a></p>

<p>You can click on the picture for the full size version.</p>

<p>So, some are better than others here. One face isn’t recognised, and there are a few false positives on people’s clothing. But all in all, for a quick hack and zero human input, I think it’s not bad.</p>

<h1>Code</h1>

<p>Here’s the full code listing. It’s written for Python 2.6. To get the dependencies, run something like:</p>

<pre><code>sudo apt-get install python-opencv libcv-dev opencv-doc
</code></pre>

<p>You’ll also need to download <a href="http://t.umblr.com/redirect?z=http%3A%2F%2Fi.imgur.com%2FBFLTf.png&amp;t=OWEyNmIwY2I2MWU0NzFiZmJkMzMzZmI2ZThmMDE5NDRiMTNiNTI1NSx4WkZhZThTTA%3D%3D">the alpha mask image</a> and put it in the same directory, renamed as <code>circlemask.png</code>.</p>



<p>I want to give credit and thanks to the various StackOverflow users and blogs whose code snippets and inspiration I used, but I sadly didn’t keep track of them, because I never thought this program would work well enough to share. So, here’s to you, unnamed internet heroes.</p>
                    </li>
                    </div></body></html>