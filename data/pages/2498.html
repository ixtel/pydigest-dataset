<html><body><div><div class="post-31 post type-post status-publish format-standard hentry category-clustering category-map-reduce category-python tag-clustring tag-jaccard-coefficient tag-jaccard-index tag-locality-sensitive-hashing tag-lsh tag-minhash tag-python-2 tag-similarity" id="post-31">
			<h1>Locality sensitive hashing (LSH) – Map-Reduce in Python</h1>
			<small class="post-meta"><span class="post-date"><b>Posted:</b> December 22, 2014</span> <span class="author-link">| <b>Author:</b> <a href="https://rajmak.wordpress.com/author/rajmak/" title="Posts by rajmak" rel="author">rajmak</a></span> <span class="meta-sep">|</span> <span class="cat-links"><b>Filed under:</b> <a href="https://rajmak.wordpress.com/category/clustering/" rel="category tag">Clustering</a>, <a href="https://rajmak.wordpress.com/category/map-reduce/" rel="category tag">Map Reduce</a>, <a href="https://rajmak.wordpress.com/category/python/" rel="category tag">Python</a></span> <span class="tag-links"> | <b>Tags:</b> <a href="https://rajmak.wordpress.com/tag/clustring/" rel="tag">clustring</a>, <a href="https://rajmak.wordpress.com/tag/jaccard-coefficient/" rel="tag">jaccard coefficient</a>, <a href="https://rajmak.wordpress.com/tag/jaccard-index/" rel="tag">Jaccard Index</a>, <a href="https://rajmak.wordpress.com/tag/locality-sensitive-hashing/" rel="tag">locality sensitive hashing</a>, <a href="https://rajmak.wordpress.com/tag/lsh/" rel="tag">LSH</a>, <a href="https://rajmak.wordpress.com/tag/minhash/" rel="tag">minhash</a>, <a href="https://rajmak.wordpress.com/tag/python-2/" rel="tag">python</a>, <a href="https://rajmak.wordpress.com/tag/similarity/" rel="tag">similarity</a></span> <span class="edit-link"/> <span class="meta-sep">|</span><span class="comments-link"><a href="https://rajmak.wordpress.com/2014/12/22/locality-sensitive-hashing-lsh-map-reduce-in-python/#respond">Leave a comment</a></span></small>
			<p>I’d try to explain LSH with help of python code and map-reduce technique.</p>
<p>It is said that There is a remarkable connection between minhashing and Jaccard similarity of the sets that are minhashed. <a href="http://infolab.stanford.edu/~ullman/mmds/book.pdf">[Chapter 3, 3.3.3 Mining of massive datasets]</a></p>
<h3>Jaccard similarity</h3>
<p><img src="https://i1.wp.com/upload.wikimedia.org/math/1/8/6/186c7f4e83da32e889d606140fae25a0.png" alt="jaccard-index j = a intersection b / a union b"/></p>
<p>Where <strong>a</strong> and <strong>b</strong> are sets.<br/>
J = 0 if <strong>A</strong> and <strong>B</strong> are disjoint<br/>
J = 1 if <strong>A</strong> and <strong>B</strong> are identical</p>
<p>example,</p>
<pre class="brush: python; title: ; notranslate" title="">
&gt;&gt;&gt; a = {'nike', 'running', 'shoe'}
&gt;&gt;&gt; b = {'nike', 'black', 'running', 'shoe'}
&gt;&gt;&gt; c = {'nike', 'blue', 'jacket'}
&gt;&gt;&gt; float(len(a.intersection(b))) / len(a.union(b))
0.75 			# a and b are similar.				
&gt;&gt;&gt; float(len(a.intersection(c))) / len(a.union(c))
0.2				# a and c are... meh..
</pre>
<h3>Minhashing</h3>
<p>Probability of collision is higher for similar sets.</p>
<p><strong>Table 1: Matrix representation of sets</strong></p>
<table>
<thead>
<tr>
<th>keyword</th>
<th>x</th>
<th>a</th>
<th>b</th>
<th>c</th>
</tr>
</thead>
<tbody>
<tr>
<td>nike</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>running</td>
<td>2</td>
<td>1</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>shoe</td>
<td>3</td>
<td>1</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>black</td>
<td>4</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>blue</td>
<td>5</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
<tr>
<td>jacket</td>
<td>6</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
</tbody>
</table>
<p><strong>Table 2: Signature Matrix with hash values</strong></p>
<table>
<thead>
<tr>
<th>Hash Function</th>
<th>a</th>
<th>b</th>
<th>c</th>
</tr>
</thead>
<tbody>
<tr>
<td>h1(x) = x + 1 mod 6</td>
<td>min(2,3,4)</td>
<td>min(2,3,4,5)</td>
<td>min(2,0,1)</td>
</tr>
<tr>
<td>h2(x) = 3x + 1 mod 6</td>
<td>min(4,1,4)</td>
<td>min(4,1,4,1)</td>
<td>min(4,4,1)</td>
</tr>
</tbody>
</table>
<p>which becomes,</p>
<p><strong>Table 3: Signature matrix with minhash values</strong></p>
<table>
<thead>
<tr>
<th>Hash Function</th>
<th>a</th>
<th>b</th>
<th>c</th>
</tr>
</thead>
<tbody>
<tr>
<td>h1(x) = x + 1 mod 6</td>
<td>2</td>
<td>2</td>
<td>0</td>
</tr>
<tr>
<td>h2(x) = 3x + 1 mod 6</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
</tbody>
</table>
<p>From <strong>Table 3</strong> We can infer that set <strong>a</strong> and <strong>b</strong> are similar.<br/>
Similarity of <strong>a</strong> and <strong>b</strong> from <strong>Table 1</strong> is 3/4 = 0.75<br/>
From signature matrix <strong>Table 3</strong> similarity of <strong>a</strong> and <strong>b</strong> is 2/2 = 1</p>
<p>The fraction from signature matrix <strong>Table 3</strong> is just an estimate of the true jaccard similarity. on a larger set the estimates will be close.</p>
<h3>Map-Reduce</h3>
<h4>Mapper</h4>
<p><strong>sample_dict.txt </strong> will have word to id mapping.</p>
<ul>
<li>for every line in input file
<ul>
<li>split text and convert to array of ids using the word to id mapping file.</li>
<li>for every id compute minimum hash value</li>
<li>split the array of min hash values into multiple equally sized chunks a.k.a, bands.</li>
<li> assign id to bands and emit hash of band, band-id and doc-id</li>
</ul>
</li>
</ul>
<h4>Reducer</h4>
<ul>
<li>group by band-hash and band-id to get list of similar doc-ids.</li>
</ul>
<h4>Mapper Code</h4>
<pre class="brush: python; title: ; notranslate" title="">
# lsh_mapper.py
__author__ = 'raj'
import sys
from random import randrange

word_ids = dict()
num_hashes = 10
num_per_band = 2

# a_hash and b_hash cannot be generated on the fly if running in a distributed env. they should be same across all nodes 
a_hash = [randrange(sys.maxint) for _ in xrange(0, num_hashes)]
b_hash = [randrange(sys.maxint) for _ in xrange(0, num_hashes)]


def min_hash_fn(a, b, sig):
    hashes = [((a * x) + b) % len(word_ids) for x in sig]
    return min(hashes)


def get_min_hash_row(sig):
    hashes = [min_hash_fn(a, b, sig) for a, b in zip(a_hash, b_hash)]
    return hashes


def get_band(l, n):
    for i in xrange(0, len(l), n):
        yield frozenset(l[i:i+n])


for word, wid in map(lambda x: x.split(), open(&amp;quot;sample_dict.txt&amp;quot;).readlines()):
    word_ids[word] = int(wid)

for doc_id, doc in enumerate(sys.stdin):
    words = doc.strip().lower().split()

    signature = map(lambda x: word_ids.get(x), words)
    signature = filter(lambda x: x is not None, signature)

    min_hash_row = get_min_hash_row(signature)

    banded = get_band(min_hash_row, num_per_band)

    for band_id, band in enumerate(banded):
        print &amp;quot;%d\t%d\t%d&amp;quot; % (band_id, hash(band), doc_id)
</pre>
<h4>Reducer Code</h4>
<pre class="brush: python; title: ; notranslate" title="">
#lsh_reducre.py
__author__ = 'raj'

import sys

prev_band_id, prev_band_hash = None, None
cluster = []
cid = 0

for line in sys.stdin:
    band_id, band_hash, doc_id = line.strip().split(&amp;quot;\t&amp;quot;, 3)

    if prev_band_id is None and prev_band_hash is None:
        prev_band_id, prev_band_hash = band_id, band_hash

    if prev_band_id is band_id:
        if prev_band_hash == band_hash:
            cluster.append(doc_id)
        else:
            print cid, cluster
            cluster = [doc_id]
    else:
        print cid, cluster
        cluster = [doc_id]
        cid += 1
    prev_band_id, prev_band_hash = band_id, band_hash
</pre>
<h3>In action</h3>
<p><strong>sample_input.txt</strong></p>
<pre class="brush: plain; title: ; notranslate" title="">
You &amp; Me 1-14 inch Doll Piece Outfit - Teal Corduroys with Top white
You &amp; Me 12- 14 inch 2-Piece Doll Fashion Outfit - Polka Dot Denim Dress Jumper with White Shirt
You &amp; Me 1-14 inch Doll Piece Fashion Outfit - Flower Dress and Leggings pink
Corduroy Shorts - Flat Front (For Men) SLATE BLUE
Nike Airmax Running SHoe
Corduroy Shorts - Flat Front (For Men) BEIGE
Nokia Lumia 721
Corduroy Shorts - Flat Front (For Men) BROWN
</pre>
<p><strong>sample_dict.txt</strong></p>
<pre class="brush: plain; title: ; notranslate" title="">
&amp;	1
(for	2
-0	3
1-14	4
12-	5
14	6
2-piece	7
721	8
airmax	9
and	10
beige	11
blue	12
brown	13
corduroy	14
corduroys	15
denim	16
doll	17
dot	18
dress	19
fashion	20
flat	21
flower	22
front	23
inch	24
jumper	25
leggings	26
lumia	27
me	28
men)	29
nike	30
nokia	31
outfit	32
piece	33
pink	34
polka	35
running	36
shirt	37
shoe	38
shorts	39
slate	40
teal	41
top	42
white	43
with	44
you	45
-	46
</pre>
<h4>Command</h4>
<pre class="brush: bash; title: ; notranslate" title="">
$ cat sample_input.txt | python lsh_mapper.py | sort | python lsh_reducer.py
</pre>
<h4>Output</h4>
<pre class="brush: bash; title: ; notranslate" title="">
0 ['1', '2']
0 ['0']
0 ['5', '7']
0 ['6']
0 ['3']
0 ['4']
1 ['4']
1 ['6']
1 ['0']
1 ['2']
1 ['3', '5', '7']
1 ['1']
2 ['6']
2 ['4']
2 ['0', '1', '2']
2 ['3', '5', '7']
3 ['6']
3 ['3', '5', '7']
3 ['0', '1', '2']
3 ['4']
4 ['0', '1']
4 ['3']
4 ['5']
4 ['4']
4 ['2']
4 ['7']
</pre>
<h4>resolved output</h4>
<pre class="brush: plain; title: ; notranslate" title="">
band 0
------
You &amp; Me 12- 14 inch 2-Piece Doll Fashion Outfit - Polka Dot Denim Dress Jumper with White Shirt
You &amp; Me 1-14 inch Doll Piece Fashion Outfit - Flower Dress and Leggings pink

Corduroy Shorts - Flat Front (For Men) BEIGE
Corduroy Shorts - Flat Front (For Men) BROWN

band 1
------
Corduroy Shorts - Flat Front (For Men) SLATE BLUE
Corduroy Shorts - Flat Front (For Men) BEIGE
Corduroy Shorts - Flat Front (For Men) BROWN

band 2
------
You &amp; Me 1-14 inch Doll Piece Outfit - Teal Corduroys with Top white
You &amp; Me 12- 14 inch 2-Piece Doll Fashion Outfit - Polka Dot Denim Dress Jumper with White Shirt
You &amp; Me 1-14 inch Doll Piece Fashion Outfit - Flower Dress and Leggings pink

Corduroy Shorts - Flat Front (For Men) SLATE BLUE
Corduroy Shorts - Flat Front (For Men) BEIGE
Corduroy Shorts - Flat Front (For Men) BROWN

band 3
------
Corduroy Shorts - Flat Front (For Men) SLATE BLUE
Corduroy Shorts - Flat Front (For Men) BEIGE
Corduroy Shorts - Flat Front (For Men) BROWN

You &amp; Me 1-14 inch Doll Piece Outfit - Teal Corduroys with Top white
You &amp; Me 12- 14 inch 2-Piece Doll Fashion Outfit - Polka Dot Denim Dress Jumper with White Shirt
You &amp; Me 1-14 inch Doll Piece Fashion Outfit - Flower Dress and Leggings pink

band 4
------
You &amp; Me 1-14 inch Doll Piece Outfit - Teal Corduroys with Top white
You &amp; Me 12- 14 inch 2-Piece Doll Fashion Outfit - Polka Dot Denim Dress Jumper with White Shirt
</pre>
<p>code <a href="https://github.com/rajeshmr/rajmak.wordpress.com/tree/master/clustering-text-lsh">here</a></p>
		<p id="geo-post-31" class="geo geo-post">
			<span class="latitude">13.081604</span>
			<span class="longitude">80.275183</span>
		</p>		<div id="jp-post-flair" class="sharedaddy sd-like-enabled sd-sharing-enabled"><p class="geolocation-chip"><span class="noticon noticon-location"/>Chennai, Tamil Nadu, India</p>
<div class="sharedaddy sd-block sd-like jetpack-likes-widget-wrapper jetpack-likes-widget-unloaded" id="like-post-wrapper-49519113-31-56d5b3fc2f9f8" data-src="//widgets.wp.com/likes/#blog_id=49519113&amp;post_id=31&amp;origin=rajmak.wordpress.com&amp;obj_id=49519113-31-56d5b3fc2f9f8" data-name="like-post-frame-49519113-31-56d5b3fc2f9f8"><h3 class="sd-title">Like this:</h3><p class="likes-widget-placeholder post-likes-widget-placeholder"><span class="button"><span>Like</span></span> <span class="loading">Loading...</span></p><span class="sd-text-color"/><a class="sd-link-color"/></div></div>						<hr/>
		</div>

		
</div></body></html>