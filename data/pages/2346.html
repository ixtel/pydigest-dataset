<html><body><div><div class="entry-content" itemprop="articleBody">
                    <p>A lot of websites display notifications in one form or another these
days. Facebook shows the new message notification, Gmail have the new
mail notifications (with the support of browser notifications).</p>

<p>I was asked today how hard it would be to implement a real-time
notification system. The answer, as it turns out, is: not very hard at
all.</p>

<p>It was in fact so easy that I decided to write up this blog post on the
subject to show how to implement a simple notification system in a
Django app.</p>

<p><strong>This has been tested with Django 1.6.8 and 1.7.1, and python 2.7.4 and
python 3.4, with the following browsers:</strong></p>

<ul>
<li>Chrome 39.0.2171.71 (64-bit)</li>
<li>Safari 8.0 (10600.1.25.1)</li>
<li>Firefox developer edition 36.0a2 (2014-12-07)</li>
</ul>

<p><strong>Note</strong>: you need redis-server running. If you don't have Redis
installed see <a href="http://redis.io/download">redis.io</a>, or use your
default package manager to install it.</p>

<p>You can download the full source code <a href="https://github.com/wildfish/swampdragon-django-notifications-demo/">here</a>.</p>

<h3>Setup</h3>

<p>This could easily be implemented in an existing application but since
I'm doing this from scratch I'll go through the steps of setting
everything up.</p>

<p>First step is to install <code>SwampDragon</code>.</p>



<p>The next thing is to create a new project.</p>

<div class="codehilite"><pre><code>    dragon-admin startproject notifications
    <span class="nb">cd </span>notifications
    django-admin.py startapp demo
</code></pre></div>

<p>That's our project files and directories setup. Now we add paths to
<code>settings.py</code> for the static files and html templates. Open
<code>notifications/settings.py</code> in a text editor and add the following
lines</p>

<div class="codehilite"><pre><code>    <span class="n">STATIC_ROOT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s">'static_root'</span><span class="p">)</span>

    <span class="n">MEDIA_URL</span> <span class="o">=</span> <span class="s">'/media/'</span>
    <span class="n">MEDIA_ROOT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s">'media'</span><span class="p">)</span>

    <span class="c"># Additional locations of static files</span>
    <span class="n">STATICFILES_DIRS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s">'static'</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">TEMPLATE_DIRS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s">'templates'</span><span class="p">)</span>
    <span class="p">]</span>
</code></pre></div>

<p>Make sure you add <code>demo</code> to <code>INSTALLED_APPS</code> as well.</p>

<p>This tells Django where to find our static resources and templates.</p>

<p>That's all we need to do for our setup step.</p>

<h3>Models</h3>

<p>We store the notification as a model. This way we can load existing
notification when the user loads the page the first time.</p>

<p>Open <code>demo/models.py</code> in a text editor and add the following code</p>

<div class="codehilite"><pre><code>    <span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
    <span class="kn">from</span> <span class="nn">swampdragon.models</span> <span class="kn">import</span> <span class="n">SelfPublishModel</span>
    <span class="kn">from</span> <span class="nn">.serializers</span> <span class="kn">import</span> <span class="n">NotificationSerializer</span>


    <span class="k">class</span> <span class="nc">Notification</span><span class="p">(</span><span class="n">SelfPublishModel</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
        <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">NotificationSerializer</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
</code></pre></div>

<p>We have yet to create the <code>NotificationSerializer</code> so we will do that
in the next step.</p>

<p>We add the <code>SelfPublishModel</code> mixin, so we don't have to worry about
actually publishing the model, as that will happen as soon as it's
created (<strong>note</strong>: for this post I have omitted handling updates to
notifications).</p>

<p>The only field on this model is a message field, but you could easily
add a title to the notification.</p>

<p>The notifications we are creating here are global, so everyone on the
site will receive them. You could tailor the notifications to be on a
per-user basis by adding a foreign key to the <code>User</code> model, and using
<a href="https://github.com/jonashagstedt/swampdragon-auth">swampdragon-auth</a>
to subscribe each user to their own notification channels (based on
their username or some other unique identifier).</p>

<p>I will add some notes about this at the end of this post, but for now I
will keep it simple.</p>

<h3>Serializers</h3>

<p>Add a new file: <code>demo/serializers.py</code> and open it in a text editor and
add the following code</p>

<div class="codehilite"><pre><code>    <span class="kn">from</span> <span class="nn">swampdragon.serializers.model_serializer</span> <span class="kn">import</span> <span class="n">ModelSerializer</span>


    <span class="k">class</span> <span class="nc">NotificationSerializer</span><span class="p">(</span><span class="n">ModelSerializer</span><span class="p">):</span>
        <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="s">'demo.Notification'</span>
            <span class="n">publish_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">'message'</span><span class="p">]</span>
</code></pre></div>

<p>We only want to publish the <code>message</code> field, so we specify this in the
<code>publish_fields</code> property.</p>

<h3>Routers</h3>

<p>Without routers SwampDragon won't know how to deal with the incoming
data.</p>

<p>Create a new file: <code>demo/routers.py</code> and add the following code</p>

<div class="codehilite"><pre><code>    <span class="kn">from</span> <span class="nn">swampdragon</span> <span class="kn">import</span> <span class="n">route_handler</span>
    <span class="kn">from</span> <span class="nn">swampdragon.route_handler</span> <span class="kn">import</span> <span class="n">ModelPubRouter</span>
    <span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Notification</span>
    <span class="kn">from</span> <span class="nn">.serializers</span> <span class="kn">import</span> <span class="n">NotificationSerializer</span>


    <span class="k">class</span> <span class="nc">NotificationRouter</span><span class="p">(</span><span class="n">ModelPubRouter</span><span class="p">):</span>
        <span class="n">valid_verbs</span> <span class="o">=</span> <span class="p">[</span><span class="s">'subscribe'</span><span class="p">]</span>
        <span class="n">route_name</span> <span class="o">=</span> <span class="s">'notifications'</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Notification</span>
        <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">NotificationSerializer</span>


    <span class="n">route_handler</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">NotificationRouter</span><span class="p">)</span>
</code></pre></div>

<h3>Admin</h3>

<p>Since we don't have anything generating notifications, we'll add the
<code>Notification</code> model to django admin so we can create them from there.</p>

<p>Open <code>demo/admin.py</code> in a text editor and replace the content with the
following:</p>

<div class="codehilite"><pre><code>    <span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
    <span class="kn">from</span> <span class="nn">demo.models</span> <span class="kn">import</span> <span class="n">Notification</span>


    <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Notification</span><span class="p">)</span>
</code></pre></div>

<h3>Views</h3>

<p>We want to load existing notifications, and be able to show these
notifications even if the SwampDragon server is not responding.</p>

<p>Open <code>demo/views.py</code> in a text editor and add the following code</p>

<div class="codehilite"><pre><code>    <span class="kn">from</span> <span class="nn">django.views.generic</span> <span class="kn">import</span> <span class="n">ListView</span>
    <span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Notification</span>


    <span class="k">class</span> <span class="nc">Notifications</span><span class="p">(</span><span class="n">ListView</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Notification</span>
        <span class="n">template_name</span> <span class="o">=</span> <span class="s">'home.html'</span>

        <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">'-pk'</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>
</code></pre></div>

<p>We use a standard Django CBV (class based view) to load the five last
notifications. We set the model to <code>Notification</code> and specify the
template to be <code>home.html</code>.</p>

<p>Open <code>notifications/urls.py</code> in a text editor and change it to the
following code</p>

<div class="codehilite"><pre><code>    <span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">include</span><span class="p">,</span> <span class="n">url</span>
    <span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
    <span class="kn">from</span> <span class="nn">demo.views</span> <span class="kn">import</span> <span class="n">Notifications</span>

    <span class="n">admin</span><span class="o">.</span><span class="n">autodiscover</span><span class="p">()</span>

    <span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">''</span><span class="p">,</span>
        <span class="n">url</span><span class="p">(</span><span class="s">r'^$'</span><span class="p">,</span> <span class="n">Notifications</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">'home'</span><span class="p">),</span>
        <span class="n">url</span><span class="p">(</span><span class="s">r'^admin/'</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span>
    <span class="p">)</span>
</code></pre></div>

<p>That's all the python code we have to write for this. Now we need to add
the template and a bit of JavaScript.</p>

<h3>HTML</h3>

<p>Create two new directories:</p>

<div class="codehilite"><pre><code>    mkdir templates
    mkdir static
</code></pre></div>

<p>Create a new html template: <code>templates/home.html</code> and add the
following</p>

<div class="codehilite"><pre><code>    <span class="cp">&lt;!DOCTYPE html&gt;</span>
    <span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;title&gt;&lt;/title&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>

    <span class="nt">&lt;h1&gt;</span>Notifications demo<span class="nt">&lt;/h1&gt;</span>

    <span class="c">&lt;!-- This is our list of notifications --&gt;</span>
    <span class="nt">&lt;ul</span> <span class="na">id=</span><span class="s">"notifications"</span><span class="nt">&gt;</span>
        {% for notification in object_list %}
        <span class="nt">&lt;li&gt;</span>{{ notification.message }}<span class="nt">&lt;/li&gt;</span>
        {% endfor %}
    <span class="nt">&lt;/ul&gt;</span>


    <span class="c">&lt;!-- SwampDragon --&gt;</span>
    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">src=</span><span class="s">"{{ STATIC_URL }}swampdragon/js/vendor/sockjs-0.3.4.min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">src=</span><span class="s">"{{ STATIC_URL }}swampdragon/js/swampdragon.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">src=</span><span class="s">"{{ STATIC_URL }}swampdragon/js/datamapper.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">src=</span><span class="s">"{{ STATIC_URL }}swampdragon/js/swampdragon-vanilla.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">src=</span><span class="s">"http://localhost:9999/settings.js"</span><span class="nt">&gt;&lt;/script&gt;</span>

    <span class="c">&lt;!-- notifications --&gt;</span>
    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">src=</span><span class="s">"{{ STATIC_URL }}notifications.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
    <span class="nt">&lt;/html&gt;</span>
</code></pre></div>

<p>If you want to run this on anything but the local dev server, see <a href="http://swampdragon.net/blog/context-processor-for-dragon_url/">this
post</a>
on adding a context processor for the <code>DRAGON_URL</code>.</p>

<h3>Javascript</h3>

<p>The last piece of the puzzle is the JavaScript.</p>

<p>Create a new JavaScript file: <code>static/notifications.js</code> and add the
following:</p>

<div class="codehilite"><pre><code>    <span class="c1">// Ask the browser for permission to show notifications</span>
    <span class="c1">// Taken from https://developer.mozilla.org/en-US/docs/Web/API/Notification/Using_Web_Notifications</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'load'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">Notification</span><span class="p">.</span><span class="nx">requestPermission</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// This allows to use Notification.permission with Chrome/Safari</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">Notification</span><span class="p">.</span><span class="nx">permission</span> <span class="o">!==</span> <span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">Notification</span><span class="p">.</span><span class="nx">permission</span> <span class="o">=</span> <span class="nx">status</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">});</span>


    <span class="c1">// Create an instance of vanilla dragon</span>
    <span class="kd">var</span> <span class="nx">dragon</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">VanillaDragon</span><span class="p">({</span><span class="nx">onopen</span><span class="o">:</span> <span class="nx">onOpen</span><span class="p">,</span> <span class="nx">onchannelmessage</span><span class="o">:</span> <span class="nx">onChannelMessage</span><span class="p">});</span>

    <span class="c1">// This is the list of notifications</span>
    <span class="kd">var</span> <span class="nx">notificationsList</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"notifications"</span><span class="p">);</span>


    <span class="c1">// New channel message received</span>
    <span class="kd">function</span> <span class="nx">onChannelMessage</span><span class="p">(</span><span class="nx">channels</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Add the notification</span>
        <span class="nx">addNotification</span><span class="p">((</span><span class="nx">message</span><span class="p">.</span><span class="nx">data</span><span class="p">));</span>
    <span class="p">}</span>


    <span class="c1">// SwampDragon connection open</span>
    <span class="kd">function</span> <span class="nx">onOpen</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Once the connection is open, subscribe to notifications</span>
        <span class="nx">dragon</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'notifications'</span><span class="p">,</span> <span class="s1">'notifications'</span><span class="p">);</span>
    <span class="p">}</span>


    <span class="c1">// Add new notifications</span>
    <span class="kd">function</span> <span class="nx">addNotification</span><span class="p">(</span><span class="nx">notification</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// If we have permission to show browser notifications</span>
        <span class="c1">// we can show the notifiaction</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">Notification</span> <span class="o">&amp;&amp;</span> <span class="nx">Notification</span><span class="p">.</span><span class="nx">permission</span> <span class="o">===</span> <span class="s2">"granted"</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">new</span> <span class="nx">Notification</span><span class="p">(</span><span class="nx">notification</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// Add the new notification</span>
        <span class="kd">var</span> <span class="nx">li</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">"li"</span><span class="p">);</span>
        <span class="nx">notificationsList</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">li</span><span class="p">,</span> <span class="nx">notificationsList</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">);</span>
        <span class="nx">li</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">notification</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span>

        <span class="c1">// Remove excess notifications</span>
        <span class="k">while</span> <span class="p">(</span><span class="nx">notificationsList</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s2">"li"</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">notificationsList</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s2">"li"</span><span class="p">)[</span><span class="mi">5</span><span class="p">].</span><span class="nx">remove</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>

<h3>Finally</h3>

<p>Create a database</p>

<p>If you are using Django 1.7+</p>

<div class="codehilite"><pre><code>    python manage.py makemigrations
    python manage.py migrate
</code></pre></div>

<p>Otherwise</p>



<p>Create a super user. This is done by either answering "yes" to the
question when you run <code>syncdb</code> or <code>migrate</code>. You can do it manually
by running <code>python manage.py createsuperuser</code>.</p>

<p>Open a new terminal and type:</p>

<div class="codehilite"><pre><code>    python manage.py runserver 
</code></pre></div>

<p>and another terminal and type</p>



<p>To test this out, open a web browser to http://localhost:8000. The
browser will ask if localhost can have permission to show notifications.
If you answer no, you will only see the notifications on the page.</p>

<p>Open another browser window to http://localhost:8000/admin/. Log in and
add a new notification instance and you should be able to see the new
notification.</p>

<h3>Additional Notes</h3>

<p>As mentioned above, you can have user specific notifications if you use
something like
<a href="https://github.com/jonashagstedt/swampdragon-auth">swampdragon-auth</a>.</p>

<p>Update the model to the following:</p>

<div class="codehilite"><pre><code>    <span class="k">class</span> <span class="nc">Notification</span><span class="p">(</span><span class="n">SelfPublishModel</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
        <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">NotificationSerializer</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
</code></pre></div>

<p>You only have to make a small change to the router by adding
<code>get_subscription_contexts</code> and setting the <code>@login_required</code>
decorator on the <code>subscribe</code> verb.</p>

<div class="codehilite"><pre><code>    <span class="nd">@login_required</span>
    <span class="k">def</span> <span class="nf">subscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_subscription_contexts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">'user_id'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span><span class="p">}</span>
</code></pre></div>

<p>Now notifications are user specific (and users who are not signed in can
simply not subscribe).</p>

<p>The example code for this post is available at <a href="https://github.com/wildfish/swampdragon-django-notifications-demo">https://github.com/wildfish/swampdragon-django-notifications-demo</a></p>

                </div>
            

            
                
            
        </div></body></html>