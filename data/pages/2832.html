<html><body><div><header class="entry-header">
<h1 class="entry-title">Data analysis with pandas: enjoy the awesome</h1>
<p class="bylinemod"><time class="entry-date updated" datetime="2013-09-08T14:46:25+00:00" pubdate="">July 26, 2013</time> — by Jan-Philip Gehrcke</p> </header> 
<div class="entry-content">
<p>Within the past months I frequently got my hands on <a href="http://pandas.pydata.org">pandas</a>. Pandas is a data analysis framework for Python initiated by <a href="http://blog.wesmckinney.com/">Wes McKinney</a>. Unfortunately, I wasn’t aware of this powerful package earlier, that would have saved a lot of time. Pandas is tightly integrated with numpy and matplotlib, so if you are familiar with those, you can smoothly jump into the pandas world. In the short time of working with pandas, I have frequently been amazed by its power and simplicity. In fact, pandas has been <a href="http://lwn.net/Articles/544290/">named to be a “Python killer app” during the PyCon 2013 keynote</a>, being at eye level with Zope and Django. In this post, I will present a short example giving a feeling for why pandas is so neat.</p>
<p>Consider <code>N</code> independent repetitions of the same experiment. Let each experiment yield various metrics for a set of system components. The goal usually is to statistically evaluate the data obtained by repeating the experiment. A simple example: Each experiment consists of measuring <code>velocity</code> and <code>weight</code> for three different cars: <code>opel</code>, <code>benz</code>, <code>audi</code>. This experiment is repeated three times. From each repetition, we got one data set:</p>
<p><strong>data1.txt</strong>:</p>
<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="text"><pre class="de1">car,weight,velocity
audi,2.1,100.3
opel,1.5,55.2
benz,3.2,80.9</pre></div></div></div></div></div></div></div>
<p><strong>data2.txt</strong>:</p>
<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="text"><pre class="de1">car,weight,velocity
audi,2.3,107.1
opel,1.2,50.1
benz,3.3,82.4</pre></div></div></div></div></div></div></div>
<p><strong>data3.txt</strong>:</p>
<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="text"><pre class="de1">car,weight,velocity
audi,2.6,110.7
opel,1.4,51.2
benz,3.2,89.1</pre></div></div></div></div></div></div></div>
<p>For each system component (<code>car</code>), there are <code>N</code> (three) values for each metric (<code>velocity</code>, <code>weight</code>). Let us build the mean value as well as the standard deviation for each metric and car, sort the data set by the mean velocity, and print the result.</p>
<h2>Short version first</h2>
<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="python"><pre class="de1"><span class="kw1">import</span> pandas <span class="kw1">as</span> pd
<span class="kw1">import</span> numpy <span class="kw1">as</span> np
 
<span class="kw1">print</span> pd.<span class="me1">concat</span><span class="br0">(</span><span class="br0">[</span>pd.<span class="me1">read_csv</span><span class="br0">(</span><span class="st0">"data%s.txt"</span> % i<span class="br0">)</span> <span class="kw1">for</span> i <span class="kw1">in</span> <span class="kw2">xrange</span><span class="br0">(</span><span class="nu0">1</span><span class="sy0">,</span><span class="nu0">4</span><span class="br0">)</span><span class="br0">]</span><span class="br0">)</span>.<span class="me1">groupby</span><span class="br0">(</span>
    <span class="st0">"car"</span><span class="br0">)</span>.<span class="me1">agg</span><span class="br0">(</span><span class="br0">[</span>np.<span class="me1">mean</span><span class="sy0">,</span> np.<span class="me1">std</span><span class="br0">]</span><span class="br0">)</span>.<span class="me1">sort</span><span class="br0">(</span><span class="br0">[</span><span class="br0">(</span><span class="st0">'velocity'</span><span class="sy0">,</span> <span class="st0">'mean'</span><span class="br0">)</span><span class="br0">]</span><span class="br0">)</span></pre></div></div></div></div></div></div></div>
<p>Output:</p>
<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="text"><pre class="de1">        weight              velocity          
          mean       std        mean       std
car                                           
opel  1.366667  0.152753   52.166667  2.683903
benz  3.233333  0.057735   84.133333  4.366158
audi  2.333333  0.251661  106.033333  5.281414</pre></div></div></div></div></div></div></div>
<p>It’s as simple as this. Looks like pure magic, but actually is not. The one-liner above is quite straight-forward to develop and simple to understand. What follows now is a slow step-by-step explanation.</p>
<h2>Long version</h2>
<p>First of all, a Python list comprehension is used together with panda’s <code>read_csv</code> method for reading the three data files. Each data file ends up in one of the most important of pandas data types: a <code>DataFrame</code> which is actually based on a numpy array.</p>
<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="python"><pre class="de1"><span class="sy0">&gt;&gt;&gt;</span> dataframes <span class="sy0">=</span> <span class="br0">[</span>pd.<span class="me1">read_csv</span><span class="br0">(</span><span class="st0">"data%s.txt"</span> % i<span class="br0">)</span> <span class="kw1">for</span> i <span class="kw1">in</span> <span class="kw2">xrange</span><span class="br0">(</span><span class="nu0">1</span><span class="sy0">,</span><span class="nu0">4</span><span class="br0">)</span><span class="br0">]</span>
<span class="sy0">&gt;&gt;&gt;</span> <span class="kw2">type</span><span class="br0">(</span>dataframes<span class="br0">[</span><span class="nu0">0</span><span class="br0">]</span><span class="br0">)</span>
<span class="sy0">&lt;</span><span class="kw1">class</span> <span class="st0">'pandas.core.frame.DataFrame'</span><span class="sy0">&gt;</span></pre></div></div></div></div></div></div></div>
<p>One of the nice things about pandas is that each of the payload-containing data types has a convenient text representation for the console (but there also are HTML representations for usage of pandas in the context of an <a href="http://ipython.org/notebook.html">IPython notebook</a>!):</p>
<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="python"><pre class="de1"><span class="sy0">&gt;&gt;&gt;</span> dataframes<span class="br0">[</span><span class="nu0">0</span><span class="br0">]</span>
    car  weight  velocity
<span class="nu0">0</span>  audi     <span class="nu0">2.1</span>     <span class="nu0">100.3</span>
<span class="nu0">1</span>  opel     <span class="nu0">1.5</span>      <span class="nu0">55.2</span>
<span class="nu0">2</span>  benz     <span class="nu0">3.2</span>      <span class="nu0">80.9</span></pre></div></div></div></div></div></div></div>
<p>As you can see above in the first column, pandas has assigned a numeric index to each of the rows. The indexing concept is extremely important in general, but not of interest in this article.</p>
<p>Now, let’s just vertically concatenate the three data sets:</p>
<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="python"><pre class="de1"><span class="sy0">&gt;&gt;&gt;</span> concatenated <span class="sy0">=</span> pd.<span class="me1">concat</span><span class="br0">(</span>dataframes<span class="br0">)</span>
<span class="sy0">&gt;&gt;&gt;</span> concatenated
    car  weight  velocity
<span class="nu0">0</span>  audi     <span class="nu0">2.1</span>     <span class="nu0">100.3</span>
<span class="nu0">1</span>  opel     <span class="nu0">1.5</span>      <span class="nu0">55.2</span>
<span class="nu0">2</span>  benz     <span class="nu0">3.2</span>      <span class="nu0">80.9</span>
<span class="nu0">0</span>  audi     <span class="nu0">2.3</span>     <span class="nu0">107.1</span>
<span class="nu0">1</span>  opel     <span class="nu0">1.2</span>      <span class="nu0">50.1</span>
<span class="nu0">2</span>  benz     <span class="nu0">3.3</span>      <span class="nu0">82.4</span>
<span class="nu0">0</span>  audi     <span class="nu0">2.6</span>     <span class="nu0">110.7</span>
<span class="nu0">1</span>  opel     <span class="nu0">1.4</span>      <span class="nu0">51.2</span>
<span class="nu0">2</span>  benz     <span class="nu0">3.2</span>      <span class="nu0">89.1</span></pre></div></div></div></div></div></div></div>
<p>I think the concept is clear. We have just merged three <code>DataFrame</code>s into one. Next, we make use of pandas’ <code>groupby</code> method and group the data by car type:</p>
<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="python"><pre class="de1"><span class="sy0">&gt;&gt;&gt;</span> grouping <span class="sy0">=</span> concatenated.<span class="me1">groupby</span><span class="br0">(</span><span class="st0">"car"</span><span class="br0">)</span></pre></div></div></div></div></div></div></div>
<p>The resulting grouping is an abstract representation of the groups in the data set. Let’s have a look at their text representation:</p>
<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="python"><pre class="de1"><span class="sy0">&gt;&gt;&gt;</span> grouping.<span class="me1">groups</span>
<span class="br0">{</span><span class="st0">'benz'</span>: <span class="br0">[</span><span class="nu0">2</span><span class="sy0">,</span> <span class="nu0">2</span><span class="sy0">,</span> <span class="nu0">2</span><span class="br0">]</span><span class="sy0">,</span> <span class="st0">'opel'</span>: <span class="br0">[</span><span class="nu0">1</span><span class="sy0">,</span> <span class="nu0">1</span><span class="sy0">,</span> <span class="nu0">1</span><span class="br0">]</span><span class="sy0">,</span> <span class="st0">'audi'</span>: <span class="br0">[</span><span class="nu0">0</span><span class="sy0">,</span> <span class="nu0">0</span><span class="sy0">,</span> <span class="nu0">0</span><span class="br0">]</span><span class="br0">}</span></pre></div></div></div></div></div></div></div>
<p>The concatenated data set was divided into three groups, one for each car type. The numbers above are the ‘indices’ from the concatenated data set, we do not use them here (otherwise we should have made sure that there are no duplicates). <code>grouping</code> still contains the raw data, it’s just not contained within the default text representation.</p>
<p>The goal now is to merge the data within each of the groups in a controlled fashion. Remember, for each car we want to calculate mean and standard deviation for each metric. This is where the awesome <code>aggregate</code> — or short <code>agg</code> — method of a grouping comes into play. Via this method, the user can define any function to be used for aggregating group-internal data. Even better, one can define a list of functions. The aggregation then is performed with each of the functions and the resulting data set has one column for each combination of metric and aggregation function. So this is what we get when we apply numpy’s <code>mean</code> as well as <code>std</code> functions:</p>
<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="python"><pre class="de1"><span class="sy0">&gt;&gt;&gt;</span> merged <span class="sy0">=</span> grouping.<span class="me1">agg</span><span class="br0">(</span><span class="br0">[</span>np.<span class="me1">mean</span><span class="sy0">,</span> np.<span class="me1">std</span><span class="br0">]</span><span class="br0">)</span>
<span class="sy0">&gt;&gt;&gt;</span> merged
        weight              velocity          
          mean       std        mean       std
car                                           
audi  <span class="nu0">2.333333</span>  <span class="nu0">0.251661</span>  <span class="nu0">106.033333</span>  <span class="nu0">5.281414</span>
benz  <span class="nu0">3.233333</span>  <span class="nu0">0.057735</span>   <span class="nu0">84.133333</span>  <span class="nu0">4.366158</span>
opel  <span class="nu0">1.366667</span>  <span class="nu0">0.152753</span>   <span class="nu0">52.166667</span>  <span class="nu0">2.683903</span></pre></div></div></div></div></div></div></div>
<p>The result is a <code>DataFrame</code> again, which can be sorted by any column. The column indices now are assembled in a two-level hierarchy (Each original column now has a sub-level containing the <code>mean</code> and <code>std</code> columns). Let’s sort by the mean value of the velocity:</p>
<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="python"><pre class="de1"><span class="sy0">&gt;&gt;&gt;</span> merged_sorted <span class="sy0">=</span> merged.<span class="me1">sort</span><span class="br0">(</span><span class="br0">[</span><span class="br0">(</span><span class="st0">'velocity'</span><span class="sy0">,</span> <span class="st0">'mean'</span><span class="br0">)</span><span class="br0">]</span><span class="br0">)</span>
<span class="sy0">&gt;&gt;&gt;</span> merged_sorted
        weight              velocity          
          mean       std        mean       std
car                                           
opel  <span class="nu0">1.366667</span>  <span class="nu0">0.152753</span>   <span class="nu0">52.166667</span>  <span class="nu0">2.683903</span>
benz  <span class="nu0">3.233333</span>  <span class="nu0">0.057735</span>   <span class="nu0">84.133333</span>  <span class="nu0">4.366158</span>
audi  <span class="nu0">2.333333</span>  <span class="nu0">0.251661</span>  <span class="nu0">106.033333</span>  <span class="nu0">5.281414</span></pre></div></div></div></div></div></div></div>
<p>So, what is the slowest car?</p>
<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="python"><pre class="de1"><span class="sy0">&gt;&gt;&gt;</span> merged_sorted.<span class="me1">iloc</span><span class="br0">[</span><span class="nu0">0</span><span class="br0">]</span>
weight    mean     <span class="nu0">1.366667</span>
          std      <span class="nu0">0.152753</span>
velocity  mean    <span class="nu0">52.166667</span>
          std      <span class="nu0">2.683903</span>
Name: opel<span class="sy0">,</span> dtype: float64</pre></div></div></div></div></div></div></div>
<p>An Opel, and we love pandas for telling us.</p>
<p>This simple example could have been solved with the standard library. However, before you end up writing a tabular data type (like I once did), you seriously should consider using pandas instead. pandas’ <code>DataFrame</code> supports plenty of convenient selection/indexing schemes as well as data conversion methods that you don’t want to re-implement. The one-liner above does not care how many rows and columns your data has. All this can be done with extreme amounts of data. pandas is using efficient numpy operations where it can, makes heavy use of Cython in other places and is generally designed for efficient large-scale data analysis. Have a look at <a href="http://pandas.pydata.org/pandas-docs/stable/">the documentation</a> to see how powerful pandas is.</p>
 </div> 
</div></body></html>