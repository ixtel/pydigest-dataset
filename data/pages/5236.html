<html><body><div><article class="markdown-body entry-content" itemprop="text"><h1><a id="user-content-ffi-with-capn-proto" class="anchor" href="#ffi-with-capn-proto" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>FFI With Cap'n Proto</h1>

<p>This project provides helpers for using Cap'n Proto to call Rust functions from Python 3. It may expand to other calling directions and languages but that is what it is limited to for now.</p>

<h2><a id="user-content-why-bother" class="anchor" href="#why-bother" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Why bother?</h2>

<blockquote>
<p>Capâ€™n Proto is an insanely fast data interchange format and capability-based RPC system.</p>
</blockquote>

<p>Currently defining a common c-style interface between Rust and Python can be arduous especially for complex types. Cap'n Proto seemed like the perfect way to bridge the gap between languages (and others, javascript, ruby, etc) and provide interfaces on top that hide the serialization/deserialization that is going on. While I have not yet figured out a convenient way to do this with rust (help appreciated) the Python interface is quite clean. Also, this does not even use the interface feature
of capnproto which I believe could be even more useful.</p>

<h2><a id="user-content-setup" class="anchor" href="#setup" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Setup</h2>

<p>This has been tested on Ubuntu, it may work with Python 2.x but I have not tested it. The instructions below will setup the directory and run the test to make sure it is working correctly.</p>

<div class="highlight highlight-source-shell"><pre>git clone --depth=1 https://github.com/waynenilsen/capnp-ffi
<span class="pl-c1">cd</span> capnp-ffi
sudo apt-get install -y capnproto python3 pip
sudo pip3 install -r ./python-capnp-ffi/requirements.txt
<span class="pl-c1">cd</span> rust-capnp-ffi
cargo build --release
<span class="pl-c1">cd</span> ../python-capnp-ffi/
python3 <span class="pl-c1">test</span>.py</pre></div>

<h2><a id="user-content-a-simple-proof-of-concept-and-walkhtrough" class="anchor" href="#a-simple-proof-of-concept-and-walkhtrough" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>A simple proof of concept and walkhtrough</h2>

<h3><a id="user-content-capn-proto-setup" class="anchor" href="#capn-proto-setup" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Cap'N Proto setup</h3>

<p>Create the <code>.capnp</code> schema file that defines the common object(s) see <a href="https://capnproto.org/language.html">the capnproto documentation</a> for more information on how to do this. </p>

<p>Generate the rust file that corresponds to the schema that we just created by using the <a href="https://github.com/dwrensha/capnpc-rust">capnpc-rust</a> capnpc extension. </p>

<div class="highlight highlight-source-shell"><pre>git clone https://github.com/dwrensha/capnpc-rust --depth=1
<span class="pl-c1">cd</span> capnpc-rust
multirust override stable
cargo build --release
chmod u+x ./target/release/canpc-rust
sudo cp ./target/release/capnpc-rust /usr/bin</pre></div>

<p>Now, you can compile the schema into rust code and python code by using <code>capnpc -orust &lt;lb&gt;.capnpc</code> and <code>capnpc -opython &lt;lb&gt;.capnpc</code>.</p>

<h3><a id="user-content-the-rust-implementation" class="anchor" href="#the-rust-implementation" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>The Rust Implementation</h3>

<p>Setup the rust side by creating a new <code>dylib</code> rust project by using <code>cargo new &lt;lb&gt;</code> then modifying the <code>Cargo.toml</code> file as follows</p>

<pre><code>[dependencies]
libc="*"
capnp="*"

[lib]
crate-type = ["dylib"]
name="&lt;lb&gt;"
</code></pre>

<p>Now in <code>src/lib.rs</code> define a function that we are going to use, below is an example for a date function. </p>

<div class="highlight highlight-source-rust"><pre><span class="pl-c">#![feature(libc)]</span>
<span class="pl-k">extern</span> <span class="pl-k">crate</span> libc<span class="pl-k">;</span>
<span class="pl-k">extern</span> <span class="pl-k">crate</span> capnp<span class="pl-k">;</span>

<span class="pl-k">mod</span> date<span class="pl-k">;</span>

<span class="pl-k">use</span> std<span class="pl-k">::</span>slice<span class="pl-k">;</span>
<span class="pl-k">use</span> libc<span class="pl-k">::</span><span class="pl-k">size_t</span><span class="pl-k">;</span> 
<span class="pl-k">use</span> capnp<span class="pl-k">::</span><span class="pl-k">MessageReader</span><span class="pl-k">;</span>
<span class="pl-k">use</span> capnp<span class="pl-k">::</span><span class="pl-k">MallocMessageBuilder</span><span class="pl-k">;</span> 
<span class="pl-k">use</span> capnp<span class="pl-k">::</span>message<span class="pl-k">::</span><span class="pl-k">MessageBuilder</span><span class="pl-k">;</span>

<span class="pl-c">#![feature(libc)]</span>
<span class="pl-k">extern</span> <span class="pl-k">crate</span> libc<span class="pl-k">;</span>
<span class="pl-k">extern</span> <span class="pl-k">crate</span> capnp<span class="pl-k">;</span>

<span class="pl-k">mod</span> date<span class="pl-k">;</span> 

<span class="pl-k">use</span> std<span class="pl-k">::</span>slice<span class="pl-k">;</span>
<span class="pl-k">use</span> libc<span class="pl-k">::</span><span class="pl-k">size_t</span><span class="pl-k">;</span> 
<span class="pl-k">use</span> capnp<span class="pl-k">::</span><span class="pl-k">MessageReader</span><span class="pl-k">;</span>
<span class="pl-k">use</span> capnp<span class="pl-k">::</span><span class="pl-k">MallocMessageBuilder</span><span class="pl-k">;</span> 
<span class="pl-k">use</span> capnp<span class="pl-k">::</span>message<span class="pl-k">::</span><span class="pl-k">MessageBuilder</span><span class="pl-k">;</span>

<span class="pl-c">#[repr(C)]</span>
<span class="pl-k">pub</span> <span class="pl-k">struct</span> <span class="pl-k">BytesOutput</span> {
    values <span class="pl-k">:</span> <span class="pl-k">*</span><span class="pl-k">const</span> <span class="pl-k">u8</span><span class="pl-k">,</span>
    len <span class="pl-k">:</span> <span class="pl-k">usize</span><span class="pl-k">,</span>
}


<span class="pl-c">#[no_mangle]</span>
<span class="pl-k">pub</span> <span class="pl-k">extern</span> <span class="pl-k">fn</span> <span class="pl-en">change_date</span>(external_data<span class="pl-k">:</span> <span class="pl-k">*</span><span class="pl-k">const</span> <span class="pl-k">u8</span><span class="pl-k">,</span> data_len <span class="pl-k">:</span> <span class="pl-k">size_t</span>) <span class="pl-k">-&gt;</span> <span class="pl-k">BytesOutput</span> {
    <span class="pl-c">// --- BEGIN can anyone help me get this into a function? --- </span>
    <span class="pl-k">let</span> <span class="pl-k">mut</span> buf <span class="pl-k">:</span> <span class="pl-k">&amp;</span>[<span class="pl-k">u8</span>] <span class="pl-k">=</span> <span class="pl-k">unsafe</span>{ slice<span class="pl-k">::</span><span class="pl-c1">from_raw_parts</span>(external_data<span class="pl-k">,</span> data_len <span class="pl-k">as</span> <span class="pl-k">usize</span>) }<span class="pl-k">;</span> 
    <span class="pl-k">let</span> imessage <span class="pl-k">=</span> <span class="pl-k">::</span>capnp<span class="pl-k">::</span>serialize<span class="pl-k">::</span><span class="pl-c1">read_message</span>(<span class="pl-k">&amp;</span><span class="pl-k">mut</span> buf<span class="pl-k">,</span> <span class="pl-k">::</span>capnp<span class="pl-k">::</span><span class="pl-k">ReaderOptions</span><span class="pl-k">::</span><span class="pl-c1">new</span>())<span class="pl-k">.</span><span class="pl-c1">unwrap</span>()<span class="pl-k">;</span>
    <span class="pl-k">let</span> input_date <span class="pl-k">:</span> date<span class="pl-k">::</span>date<span class="pl-k">::</span><span class="pl-k">Reader</span> <span class="pl-k">=</span> imessage<span class="pl-k">.</span><span class="pl-c1">get_root</span>()<span class="pl-k">.</span><span class="pl-c1">unwrap</span>()<span class="pl-k">;</span> 
    <span class="pl-c">// --- END can anyone help me get this into a function? --- </span>

    <span class="pl-k">let</span> <span class="pl-k">mut</span> omessage <span class="pl-k">=</span> <span class="pl-k">MallocMessageBuilder</span><span class="pl-k">::</span><span class="pl-c1">new_default</span>()<span class="pl-k">;</span>
    {
        <span class="pl-k">let</span> <span class="pl-k">mut</span> out_dt <span class="pl-k">=</span> omessage<span class="pl-k">.</span>init_root<span class="pl-k">::&lt;</span>date<span class="pl-k">::</span>date<span class="pl-k">::</span><span class="pl-k">Builder</span><span class="pl-k">&gt;</span>()<span class="pl-k">;</span>
        out_dt<span class="pl-k">.</span><span class="pl-c1">set_year</span>(input_date<span class="pl-k">.</span><span class="pl-c1">get_year</span>() <span class="pl-k">+</span> <span class="pl-c1">1</span>)<span class="pl-k">;</span>
        out_dt<span class="pl-k">.</span><span class="pl-c1">set_month</span>(input_date<span class="pl-k">.</span><span class="pl-c1">get_month</span>())<span class="pl-k">;</span>
        out_dt<span class="pl-k">.</span><span class="pl-c1">set_day</span>(<span class="pl-c1">1</span>)<span class="pl-k">;</span>
    }

    <span class="pl-c">// --- BEGIN can anyone help me get this into a function? --- </span>
    <span class="pl-k">let</span> <span class="pl-k">mut</span> out_buf <span class="pl-k">:</span> <span class="pl-k">Vec</span><span class="pl-k">&lt;</span><span class="pl-k">u8</span><span class="pl-k">&gt;</span> <span class="pl-k">=</span> <span class="pl-k">Vec</span><span class="pl-k">::</span><span class="pl-c1">new</span>()<span class="pl-k">;</span>
    capnp<span class="pl-k">::</span>serialize<span class="pl-k">::</span><span class="pl-c1">write_message</span>( <span class="pl-k">&amp;</span><span class="pl-k">mut</span> out_buf<span class="pl-k">,</span> <span class="pl-k">&amp;</span>omessage )<span class="pl-k">;</span>
    <span class="pl-k">BytesOutput</span> {
        values<span class="pl-k">:</span> out_buf<span class="pl-k">.</span><span class="pl-c1">as_ptr</span>()<span class="pl-k">,</span>
        len <span class="pl-k">:</span> out_buf<span class="pl-k">.</span><span class="pl-c1">len</span>()<span class="pl-k">,</span> 
    }
    <span class="pl-c">// --- END can anyone help me get this into a function? --- </span>
}
</pre></div>

<p>There should be some better abstraction on the rust side but I haven't quite figured out how to deal with it.</p>

<h3><a id="user-content-the-python-interface" class="anchor" href="#the-python-interface" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>The Python Interface</h3>

<p>Install the <code>capnp_ffi</code> package from this repository by cloning the git repo (it's not in pip) and define the external interface. Here is the same example corresponding to the rust code above. In this way, you can add the documentation here. Eventually this file could be compiled from the rust file above. </p>

<div class="highlight highlight-source-python"><pre><span class="pl-c">#date_example.py</span>

<span class="pl-k">import</span> capnp_ffi

<span class="pl-k">class</span> <span class="pl-en">DateLibInterface</span>(<span class="pl-e">capnp_ffi</span>.<span class="pl-e">CapnpInterface</span>):
    <span class="pl-s"><span class="pl-pds">'''</span></span>
<span class="pl-s">    adding documentation to the interface is possible by extending the </span>
<span class="pl-s">    interface base class with docstrings </span>
<span class="pl-s">    <span class="pl-pds">'''</span></span>

    capnp_file <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>../schemas/date.capnp<span class="pl-pds">'</span></span>
    lib_file <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>../rust-capnp-ffi/target/release/libcapnp_ffi.so<span class="pl-pds">'</span></span>

    <span class="pl-k">def</span> <span class="pl-c1">__init__</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>, <span class="pl-k">*</span><span class="pl-smi">args</span>, <span class="pl-k">**</span><span class="pl-smi">kwargs</span>):
        <span class="pl-s"><span class="pl-pds">'''</span></span>
<span class="pl-s">        this is required</span>
<span class="pl-s">        <span class="pl-pds">'''</span></span>
        <span class="pl-c1">super</span>(DateLibInterface, <span class="pl-v">self</span>).<span class="pl-c1">__init__</span>(<span class="pl-k">*</span>args, <span class="pl-k">**</span>kwargs)

    <span class="pl-en">@capnp_ffi.external</span>(<span class="pl-v">rtype</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>Date<span class="pl-pds">'</span></span>)
    <span class="pl-k">def</span> <span class="pl-en">change_date</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>, <span class="pl-smi">idate</span>):
        <span class="pl-s"><span class="pl-pds">'''</span></span>
<span class="pl-s">        this changes the date by adding one to the year, using the same</span>
<span class="pl-s">        month and setting the day to 1.</span>
<span class="pl-s">        <span class="pl-pds">'''</span></span>
        <span class="pl-k">pass</span></pre></div>

<p>That's it! Now, this external library can be imported and used as follows:</p>

<div class="highlight highlight-source-python"><pre><span class="pl-k">import</span> date_example
date_example <span class="pl-k">=</span> date_example.DateLibInterface()
d <span class="pl-k">=</span> date_example.Date(<span class="pl-v">year</span><span class="pl-k">=</span><span class="pl-c1">2015</span>, <span class="pl-v">month</span><span class="pl-k">=</span><span class="pl-c1">2</span>, <span class="pl-v">day</span><span class="pl-k">=</span><span class="pl-c1">5</span>)
<span class="pl-c"># call to rust function!</span>
result <span class="pl-k">=</span> date_example.change_date(d)</pre></div>
</article>
  </div></body></html>