<html><body><div><article class="markdown-body entry-content" itemprop="text"><h1><a id="user-content-dnsgate" class="anchor" href="#dnsgate" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>dnsgate</h1>

<p><strong>dnsgate</strong> merges 3rd party [1] DNS blocking lists into <code>/etc/dnsmasq.conf</code> or <code>/etc/hosts</code> format.</p>

<p>While not required, <a href="https://wiki.gentoo.org/wiki/Dnsmasq">dnsmasq</a> improves on conventional <a href="http://winhelp2002.mvps.org/hosts.htm">/etc/hosts domain blocking</a> by enabling * blocking of domains.</p>

<p>For example *.google.com:</p>

<pre><code>echo 'address=/.google.com/127.0.0.1' &gt;&gt; /etc/dnsmasq.conf
</code></pre>

<p>Returnins 127.0.0.1 for all google.com domains. Rather than return 127.0.0.1 and make the application chack if port 80/443/whatever is open, dnsmasq has another advantage; it can return NXDOMAIN:</p>

<pre><code>echo 'server=/.google.com/' &gt;&gt; /etc/dnsmasq.conf
</code></pre>

<p>This instead returns NXDOMAIN on *.google.com. Returning NXDOMAIN instead of localhost is default in dnsmasq output mode.</p>

<p>Said another way, conventional <code>/etc/hosts</code> blocking can not use wildcards * and therefore someone must keep track of each subdomain / domain combination that should be blocked. This is not necessarily a problem. Even if you don't use dnsmasq, other people [1] keep track of the subdomains for you and dnsgate automatically pulls from them. If you want to block a specific domain completely, you must use dnsmasq.</p>

<p>With <code>--mode dnsmasq</code> (which is default) <code>--block-at-psl</code> strips domains to their "Public Second Level Domain" which is the top public domain with any subdomain stripped, removing the need to manually specify/track specific subdomains. <code>--block-at-psl</code> may block domain's you want to use, so use it with <code>whitelist</code>.</p>

<p><strong>Features:</strong></p>

<ul>
<li><strong>Persistent Configuration.</strong> see <code>dnsgate configure --help</code>.</li>
<li><strong>Wildcard Blocking.</strong> <code>--block-at-psl</code> will block TLD's instead of individual subdomains (dnsmasq mode only).</li>
<li><strong>System-wide.</strong> All programs that use the local DNS resolver benefit.</li>
<li><strong>Blacklist Caching.</strong> Optionally cache and re-use remote blacklists (see <code>--no-cache</code> and <code>--cache-expire</code>).</li>
<li><strong>Non-interactive.</strong> Can be run as a periodic cron job.</li>
<li><strong>Custom Lists.</strong> See <code>dnsgate whitelist --help</code> and <code>dnsgate blacklist --help</code>.</li>
<li><strong>Return NXDOMAIN.</strong> Rather than redirect the request to 127.0.0.1, NXDOMAIN is returned. (dnsmasq mode only).</li>
<li><strong>Return Custom IP.</strong> <code>--dest-ip</code> allows redirection to specified IP (disables returning NXDOMAIN in dnsmasq mode).</li>
<li><strong>Installation Support.</strong> see install-help</li>
<li><strong>Verbose Output.</strong> see <code>dnsgate --verbose generate</code></li>
<li><strong>IDN Support.</strong> What to block snowman? <code>dnsgate blacklist â˜ƒ.net</code></li>
<li><strong>TLD Blocking.</strong> Want to block Saudi Arabia? <code>dnsgate blacklist sa</code></li>
<li><strong>Enable/Disable Support.</strong> <code>dnsgate enable</code> and <code>dnsgate disable</code> (dnsmasq mode only)</li>
</ul>

<p><strong>TODO:</strong></p>

<ul>
<li><strong>Test on distros other than gentoo w/ <a href="https://wiki.gentoo.org/wiki/Comparison_of_init_systems">OpenRC</a> &amp;&amp; dnsmasq</strong></li>
<li><strong>Pip install support</strong></li>
<li><strong>Add tox tests</strong></li>
<li><strong>Add optional DNS filtering proxy to allow hierarchical rules.</strong></li>
<li><strong>Add optional bind rpz output.</strong></li>
<li><strong>Make enable/disable work in <code>--mode hosts</code>.</strong></li>
</ul>

<p><strong>Dependencies:</strong></p>



<p><strong>Install:</strong></p>

<pre><code>$ git clone https://github.com/jakeogh/dnsgate.git
$ cd dnsgate
# python3 setup.py install
$ dnsgate configure --help
</code></pre>

<pre><code>
$ ./dnsgate --help
Usage: dnsgate [OPTIONS] COMMAND [ARGS]...

  dnsgate combines, deduplicates, and optionally modifies local and remote DNS blacklists. Use "dnsgate
  (command) --help" for more information.

Options:
  --no-restart-dnsmasq  do not restart the dnsmasq service
  --backup              backup output file before overwriting
  --verbose             print debug information to stderr
  --help                Show this message and exit.

Commands:
  blacklist     Add domain(s) to /etc/dnsgate/blacklist
  configure     Write /etc/dnsgate/config [SOURCES] are the...
  disable       Disable /etc/dnsgate/generated_blacklist
  enable        Enable /etc/dnsgate/generated_blacklist
  generate      Create /etc/dnsgate/generated_blacklist
  install_help  Help configure dnsmasq or /etc/hosts
  whitelist     Add domain(s) to /etc/dnsgate/whitelist
</code></pre>

<pre><code>
$ ./dnsgate configure --help
Usage: dnsgate configure [OPTIONS] [SOURCES]...

  Write /etc/dnsgate/config

  [SOURCES] are the remote blacklist(s) to get rules from. Defaults to:

  http://winhelp2002.mvps.org/hosts.txt http://someonewhocares.org/hosts/hosts
  https://adaway.org/hosts.txt

Options:
  --mode [dnsmasq|hosts]          [required]
  --block-at-psl                  strips subdomains, for example: analytics.google.com -&gt; google.com (must
                                  manually whitelist inadvertently blocked domains)
  --dest-ip TEXT                  IP to redirect blocked connections to (defaults to 127.0.0.1 in hosts
                                  mode, specifying this in dnsmasq mode causes lookups to resolve rather
                                  than return NXDOMAIN)
  --dnsmasq-config-file FILENAME  dnsmasq config file (defaults to /etc/dnsmasq.conf)
  --help                          Show this message and exit.
</code></pre>

<p><strong>create dnsgate configuration file for --mode dnsmasq:</strong></p>

<pre><code>$ ./dnsgate configure --mode dnsmasq
</code></pre>

<p><strong>dnsmasq examples that do the same thing:</strong></p>

<pre><code>$ ./dnsgate generate
 * Stopping dnsmasq ... [ ok ]
 * Starting dnsmasq ... [ ok ]

$ ./dnsgate --verbose generate
Using output file: /etc/dnsgate/generated_blacklist
122 validated whitelist domains.
Reading remote blacklist(s):
['http://winhelp2002.mvps.org/hosts.txt', 'http://someonewhocares.org/hosts/hosts', 'https://adaway.org/hosts.txt']
23985 domains from remote blacklist(s).
23985 validated remote blacklisted domains.
23983 blacklisted domains after subtracting the 122 whitelisted domains
Re-adding 68 domains in the local blacklist /etc/dnsgate/blacklist to override the whitelist.
24044 blacklisted domains after re-adding the custom blacklist.
23434 blacklisted domains after removing redundant rules.
Sorting domains by their subdomain and grouping by TLD.
Final blacklisted domain count: 23434
Writing output file: /etc/dnsgate/generated_blacklist in dnsmasq format
 * Stopping dnsmasq ... [ ok ]
 * Starting dnsmasq ... [ ok ]
</code></pre>

<p><strong>create dnsgate configuration file for --mode hosts:</strong></p>

<pre><code>$ ./dnsgate configure --mode hosts
</code></pre>

<p><strong>hosts examples that do the same thing:</strong></p>

<pre><code>$ ./dnsgate generate

$ ./dnsgate --verbose generate
Using output file: /etc/dnsgate/generated_blacklist
122 validated whitelist domains.
Reading remote blacklist(s):
['http://winhelp2002.mvps.org/hosts.txt', 'http://someonewhocares.org/hosts/hosts', 'https://adaway.org/hosts.txt']
23985 domains from remote blacklist(s).
23985 validated remote blacklisted domains.
23983 blacklisted domains after subtracting the 122 whitelisted domains
Re-adding 68 domains in the local blacklist /etc/dnsgate/blacklist to override the whitelist.
24044 blacklisted domains after re-adding the custom blacklist.
23434 blacklisted domains after removing redundant rules.
Sorting domains by their subdomain and grouping by TLD.
Final blacklisted domain count: 23434
Writing output file: /etc/dnsgate/generated_blacklist in hosts format
</code></pre>

<p><strong>/etc/hosts install help:</strong></p>

<pre><code>$ ./dnsgate install_help
    $ mv -vi /etc/hosts /etc/hosts.default
    $ cat /etc/hosts.default /etc/dnsgate/generated_blacklist &gt; /etc/hosts
</code></pre>

<p><strong>More Information:</strong></p>



<p><strong>Related Software:</strong></p>



<p><strong>Simple Software:</strong></p>

<p>If you find this useful you may appreciate:</p>



<p>[1]: <a href="http://winhelp2002.mvps.org/hosts.txt">http://winhelp2002.mvps.org/hosts.txt</a> <a href="http://someonewhocares.org/hosts/hosts">http://someonewhocares.org/hosts/hosts</a></p>
</article>
  </div></body></html>