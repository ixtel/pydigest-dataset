<html><body><div><div class="post-body entry-content" id="post-body-7265030289082479334" itemprop="description articleBody">
<div dir="ltr" trbidi="on"><p>
If you make use of context managers you'll eventually run into a situation where you're nesting a number of them in a single </p><code>with</code><p> statement.  It can be somewhat unwieldy from a readability point of view to put everything on one line:

</p><pre class="brush: python">with contextmanager1, contextmanager2, contextmanager3, contextmanager4:
    pass

</pre>
<p>
and while you can break it up on multiple lines:

</p><pre class="brush: python">with contextmanager1, \
           contextmanager2, \
           contextmanager3, \
           contextmanager4:
    pass

</pre>
<p>
sometimes that still isn't very readable.  This is more of a problem if you're using the same set of context managers in a number of places.  Ideally you should be able to put the context managers in a variable and use that with however many </p><code>with</code><p> statements need them:


</p><pre class="brush: python">handlers = (contextmanager1, contextmanager2, contextmanager3, contextmanager4)
with handlers:
    pass

</pre>
<p>
Of course this doesn't work because </p><code>handlers</code><p> is a tuple, not a context manager.  This will cause </p><code>with</code><p> to throw a exception.  What you can do is create a context manager that aggregates other context managers:

</p><pre class="brush: python">from contextlib import contextmanager
import sys

@contextmanager
def aggregate(handlers):
    for handler in handlers:
        handler.__enter__()
 
    err = None
    exc_info = (None, None, None)
    try:
        yield
    except Exception as err:
        exc_info = sys.exc_info()

    # exc_info get's passed to each subsequent handler.__exit__
    # unless one of them suppresses the exception by returning True
    for handler in reversed(handlers):
        if handler.__exit__(*exc_info):
            err = False
            exc_info = (None, None, None)
    if err:
        raise err
</pre>
<p>
So now you can aggregate all the context managers into one and use that one in the </p><code>with</code><p> statement:

</p><pre class="brush: python">handlers = (contextmanager1, contextmanager2, contextmanager3, contextmanager4)
with aggregate(handlers):
    pass

</pre>
<p>
You can build up the list of context managers however you want and use </p><code>aggregate</code><p> when using them in a </p><code>with</code><p> statement.

</p><p>
<b>§ 
</b></p>
</div>
<p/>
</div>
</div></body></html>