<html><body><div><div class="blog-post-content">
    <p>Our topic for this month's <a href="http://www.meetup.com/TrackMaven-Monthly-Challenge/">Monthly Challenge meetup</a> is NLP! In this post, we'll get you started with one possibility: using <a href="http://pandas.pydata.org/">pandas</a> and Python's <a href="http://www.nltk.org/">Natural Language Toolkit</a> to analyze the contents your own Gmail inbox. For those of you who are continuing projects from our last <a href="www.meetup.com/TrackMaven-Monthly-Challenge/events/213296342/">monthly challenge on Elasticsearch</a>, we'll also include some code to make use of <a href="http://www.elasticsearch.org/guide/en/elasticsearch/client/python-api/master/">Elasticsearch</a> as well at the end of the post.</p>
<p>There are endless possibilities for an NLP-inspired project:</p>
<ul>
<li><a href="http://en.wikipedia.org/wiki/Sentiment_analysis">Sentiment analysis</a> to put a measure to the emotional content of online reviews, social media, etc. For instance, are tweets about a topic trending to positive or negative opinions? Does a news site cover certain topics using more positive/negative terms or frequently use words correlated with certain emotions? Is this "positive" Yelp review sarcastic? (Good luck with that last one!)</li>
<li>Analyze the use of language in literature to measure trends in vocabulary or writing style over time/regions/authors.</li>
<li>Flag content as spam by identifying key characteristics of the language used.</li>
<li>Use <a href="http://en.wikipedia.org/wiki/Topic_model">topic extraction</a> to group reviews into similar categories based on what main topics they cover.</li>
<li>Create a better real-time Twitter search by combining Elasticsearch with <a href="http://wordnet.princeton.edu/">WordNet</a> via <a href="http://www.nltk.org/howto/wordnet.html">NLTK's corpus</a> to measure term similarity on Twitter's streaming API</li>
<li>Join <a href="https://github.com/dariusk/NaNoGenMo-2014">NaNoGenMo</a> and write some code that generates its own novel! There are plenty of ideas and resources <a href="https://github.com/dariusk/NaNoGenMo-2014/issues/1">here</a> to get started.</li>
</ul>
<h2>Load a Gmail inbox into pandas</h2>
<p>Let's get started with the example project! First off, we'll need some data. Prepare an archive of <em>only</em> your Gmail data (this will include what's currently in your spam and trash folders) here:</p>
<p><a href="https://www.google.com/settings/takeout">https://www.google.com/settings/takeout</a></p>
<p>Now go take a walk. With a 5.1G inbox, my 2.8G archive took a little over an hour to send.</p>
<p>Once you've got the file and a local environment set up for the project, use the script below to read the data into pandas (I highly recommend using <a href="http://ipython.org/">IPython</a> for data analysis):</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">mailbox</span> <span class="kn">import</span> <span class="n">mbox</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>

<span class="k">def</span> <span class="nf">store_content</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">body</span><span class="p">:</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(</span><span class="n">decode</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"subject"</span><span class="p">:</span> <span class="n">message</span><span class="p">[</span><span class="s">'subject'</span><span class="p">]</span> <span class="ow">or</span> <span class="s">""</span><span class="p">,</span>
            <span class="s">"body"</span><span class="p">:</span> <span class="n">body</span><span class="p">,</span>
            <span class="s">"from"</span><span class="p">:</span> <span class="n">message</span><span class="p">[</span><span class="s">'from'</span><span class="p">],</span>
            <span class="s">"to"</span><span class="p">:</span> <span class="n">message</span><span class="p">[</span><span class="s">'to'</span><span class="p">],</span>
            <span class="s">"date"</span><span class="p">:</span> <span class="n">message</span><span class="p">[</span><span class="s">'date'</span><span class="p">],</span>
            <span class="s">"labels"</span><span class="p">:</span> <span class="n">message</span><span class="p">[</span><span class="s">'X-Gmail-Labels'</span><span class="p">],</span>
            <span class="s">"epilogue"</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">epilogue</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c"># Create an empty DataFrame with the relevant columns</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">(</span><span class="s">"subject"</span><span class="p">,</span> <span class="s">"body"</span><span class="p">,</span> <span class="s">"from"</span><span class="p">,</span> <span class="s">"to"</span><span class="p">,</span> <span class="s">"date"</span><span class="p">,</span> <span class="s">"labels"</span><span class="p">,</span> <span class="s">"epilogue"</span><span class="p">))</span>

<span class="c"># Import your downloaded mbox file</span>
<span class="n">box</span> <span class="o">=</span> <span class="n">mbox</span><span class="p">(</span><span class="s">'All mail Including Spam and Trash.mbox'</span><span class="p">)</span>

<span class="n">fails</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">box</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s">'text/plain'</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">store_content</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">message</span><span class="o">.</span><span class="n">is_multipart</span><span class="p">():</span>
            <span class="c"># Grab any plaintext from multipart messages</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">get_payload</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s">'text/plain'</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">store_content</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">part</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(</span><span class="n">decode</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
                    <span class="k">break</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">fails</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</pre></div>


<p>Above, we used Python's <a href="https://docs.python.org/2/library/mailbox.html">mailbox</a> module to read and parse "mbox"-formatted messages. This could certainly be done more elegantly (for instance, the messages include a lot of extraneous, duplicated data such as inlineÂ messages with "&gt;&gt;&gt;" in replies). Another issue is the inability to handle some special characters, which for simplicity we discard for now; check that you're not ignoring a significant proportion of your inbox here!</p>
<p>Note that we're not actually going to make use of anything but the subject lines, but you could perform all sorts of interesting analysis on timestamps, message bodies, classify by tags, etc. Given that this is just a post to get you started (and happens to show results from my own inbox), I don't want to go into <em>too</em> much detail :)</p>
<h2>Finding common terms</h2>
<p>Now that we've got some data, let's get the ten most common terms out of all subject lines:</p>
<div class="highlight"><pre><span class="c"># Top 10 most common subject words</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>

<span class="n">subject_word_bag</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s">" "</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="n">Counter</span><span class="p">(</span><span class="n">subject_word_bag</span><span class="o">.</span><span class="n">split</span><span class="p">())</span><span class="o">.</span><span class="n">most_common</span><span class="p">()[:</span><span class="mi">10</span><span class="p">]</span>

<span class="p">[(</span><span class="s">'re:'</span><span class="p">,</span> <span class="mi">8508</span><span class="p">),</span> <span class="p">(</span><span class="s">'-'</span><span class="p">,</span> <span class="mi">1188</span><span class="p">),</span> <span class="p">(</span><span class="s">'the'</span><span class="p">,</span> <span class="mi">819</span><span class="p">),</span> <span class="p">(</span><span class="s">'fwd:'</span><span class="p">,</span> <span class="mi">666</span><span class="p">),</span> <span class="p">(</span><span class="s">'to'</span><span class="p">,</span> <span class="mi">572</span><span class="p">),</span> <span class="p">(</span><span class="s">'new'</span><span class="p">,</span> <span class="mi">530</span><span class="p">),</span> <span class="p">(</span><span class="s">'your'</span><span class="p">,</span> <span class="mi">528</span><span class="p">),</span> <span class="p">(</span><span class="s">'for'</span><span class="p">,</span> <span class="mi">498</span><span class="p">),</span> <span class="p">(</span><span class="s">'a'</span><span class="p">,</span> <span class="mi">463</span><span class="p">),</span> <span class="p">(</span><span class="s">'course'</span><span class="p">,</span> <span class="mi">452</span><span class="p">)]</span>
</pre></div>


<p>Well, that was underwhelming. Let's try limiting out some common terms:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">nltk.corpus</span> <span class="kn">import</span> <span class="n">stopwords</span>
<span class="n">stops</span> <span class="o">=</span> <span class="p">[</span><span class="nb">unicode</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">stopwords</span><span class="o">.</span><span class="n">words</span><span class="p">(</span><span class="s">'english'</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="s">'re:'</span><span class="p">,</span> <span class="s">'fwd:'</span><span class="p">,</span> <span class="s">'-'</span><span class="p">]</span>
<span class="n">subject_words</span> <span class="o">=</span> <span class="p">[</span><span class="n">word</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">subject_word_bag</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">if</span> <span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stops</span><span class="p">]</span>
<span class="n">Counter</span><span class="p">(</span><span class="n">subject_words</span><span class="p">)</span><span class="o">.</span><span class="n">most_common</span><span class="p">()[:</span><span class="mi">10</span><span class="p">]</span>

<span class="p">[(</span><span class="s">'new'</span><span class="p">,</span> <span class="mi">530</span><span class="p">),</span> <span class="p">(</span><span class="s">'course'</span><span class="p">,</span> <span class="mi">452</span><span class="p">),</span> <span class="p">(</span><span class="s">'trackmaven'</span><span class="p">,</span> <span class="mi">334</span><span class="p">),</span> <span class="p">(</span><span class="s">'question'</span><span class="p">,</span> <span class="mi">334</span><span class="p">),</span> <span class="p">(</span><span class="s">'post'</span><span class="p">,</span> <span class="mi">286</span><span class="p">),</span> <span class="p">(</span><span class="s">'content'</span><span class="p">,</span> <span class="mi">245</span><span class="p">),</span> <span class="p">(</span><span class="s">'payment'</span><span class="p">,</span> <span class="mi">244</span><span class="p">),</span> <span class="p">(</span><span class="s">'blog'</span><span class="p">,</span> <span class="mi">241</span><span class="p">),</span> <span class="p">(</span><span class="s">'forum'</span><span class="p">,</span> <span class="mi">236</span><span class="p">),</span> <span class="p">(</span><span class="s">'update'</span><span class="p">,</span> <span class="mi">220</span><span class="p">)]</span>
</pre></div>


<p>Besides removing a couple of the least useful terms on our own, we used NLTK's stopwords corpus, which first needs to be install in a <a href="http://www.nltk.org/data.html">rather goofy way</a>. Now we can see some words that are typical to my inbox but not necessarily as typical to find in English text in general!</p>
<h2>Bigrams and collocations</h2>
<p>Another interesting measurement allowed by NLTK is the concept of <a href="http://en.wikipedia.org/wiki/Collocation">collocations</a>. First, let's take a look at common "bigrams" - i.e, which sets of two words frequently appear together in pairs:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">nltk</span> <span class="kn">import</span> <span class="n">collocations</span>
<span class="n">bigram_measures</span> <span class="o">=</span> <span class="n">collocations</span><span class="o">.</span><span class="n">BigramAssocMeasures</span><span class="p">()</span>
<span class="n">bigram_finder</span> <span class="o">=</span> <span class="n">collocations</span><span class="o">.</span><span class="n">BigramCollocationFinder</span><span class="o">.</span><span class="n">from_words</span><span class="p">(</span><span class="n">subject_words</span><span class="p">)</span>

<span class="c"># Filter to top 20 results; otherwise this will take a LONG time to analyze</span>
<span class="n">bigram_finder</span><span class="o">.</span><span class="n">apply_freq_filter</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="k">for</span> <span class="n">bigram</span> <span class="ow">in</span> <span class="n">bigram_finder</span><span class="o">.</span><span class="n">score_ngrams</span><span class="p">(</span><span class="n">bigram_measures</span><span class="o">.</span><span class="n">raw_freq</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]:</span>
    <span class="k">print</span> <span class="n">bigram</span>

<span class="p">((</span><span class="s">'forum'</span><span class="p">,</span> <span class="s">'content'</span><span class="p">),</span> <span class="mf">0.005839453284373725</span><span class="p">)</span>
<span class="p">((</span><span class="s">'new'</span><span class="p">,</span> <span class="s">'forum'</span><span class="p">),</span> <span class="mf">0.005839453284373725</span><span class="p">)</span>
<span class="p">((</span><span class="s">'blog'</span><span class="p">,</span> <span class="s">'post'</span><span class="p">),</span> <span class="mf">0.00538045695634435</span><span class="p">)</span>
<span class="p">((</span><span class="s">'domain'</span><span class="p">,</span> <span class="s">'names'</span><span class="p">),</span> <span class="mf">0.004870461036311709</span><span class="p">)</span>
<span class="p">((</span><span class="s">'alpha'</span><span class="p">,</span> <span class="s">'release'</span><span class="p">),</span> <span class="mf">0.0028304773561811506</span><span class="p">)</span>
<span class="p">((</span><span class="s">'default'</span><span class="p">,</span> <span class="s">'widget.'</span><span class="p">),</span> <span class="mf">0.0026519787841697267</span><span class="p">)</span>
<span class="p">((</span><span class="s">'purechat:'</span><span class="p">,</span> <span class="s">'question'</span><span class="p">),</span> <span class="mf">0.0026519787841697267</span><span class="p">)</span>
<span class="p">((</span><span class="s">'using'</span><span class="p">,</span> <span class="s">'default'</span><span class="p">),</span> <span class="mf">0.0026519787841697267</span><span class="p">)</span>
<span class="p">((</span><span class="s">'release'</span><span class="p">,</span> <span class="s">'third'</span><span class="p">),</span> <span class="mf">0.002575479396164831</span><span class="p">)</span>
<span class="p">((</span><span class="s">'trackmaven'</span><span class="p">,</span> <span class="s">'application'</span><span class="p">),</span> <span class="mf">0.002524479804161567</span><span class="p">)</span>
</pre></div>


<p>We could repeat the same process for trigrams (or other ngrams) to find longer phrases; in this case, "new forum content" would appear as a top trigram, but in the case of the above list it ended up getting split into two pieces at the top of the bigram list.</p>
<p>Another slightly different type of collocation measurement is based on <a href="http://en.wikipedia.org/wiki/Pointwise_mutual_information">pointwise mutual information</a>; essentially, this measures how likely one word is to appear given that we've seen the other word in a specific document <em>relative to</em> their general individual frequencies throughout all documents. For instance, if my email subjects use the word "blog" and/or the word "post" a lot in general, then the bigram "blog post" is not as interesting of a signal since it's still likely that one word might appear <em>not</em> paired with the other. Using this measure, we get a different set of bigrams:</p>
<div class="highlight"><pre><span class="k">for</span> <span class="n">bigram</span> <span class="ow">in</span> <span class="n">bigram_finder</span><span class="o">.</span><span class="n">nbest</span><span class="p">(</span><span class="n">bigram_measures</span><span class="o">.</span><span class="n">pmi</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
    <span class="k">print</span> <span class="n">bigram</span>

<span class="p">(</span><span class="s">'4:30pm'</span><span class="p">,</span> <span class="s">'5pm'</span><span class="p">)</span>
<span class="p">(</span><span class="s">'motley'</span><span class="p">,</span> <span class="s">'fool'</span><span class="p">)</span>
<span class="p">(</span><span class="s">'60,'</span><span class="p">,</span> <span class="s">'900,'</span><span class="p">)</span>
<span class="p">(</span><span class="s">'population'</span><span class="p">,</span> <span class="s">'cap'</span><span class="p">)</span>
<span class="p">(</span><span class="s">'simple'</span><span class="p">,</span> <span class="s">'goods'</span><span class="p">)</span>
</pre></div>


<p>So, I don't get a lot of email subjects mentioning the words "motley" or "fool" - but when I see either one, it's probably something "Motley Fool"-related!</p>
<h2>Sentiment analysis</h2>
<p>Finally, let's try out some sentiment analysis. For a quick start, we can use the <a href="http://textblob.readthedocs.org/en/dev/index.html">TextBlob</a> library, which sits on top of NLTK to provide simple access to lots of common NLP tasks. We can use its built-in <a href="http://textblob.readthedocs.org/en/dev/quickstart.html#sentiment-analysis">sentiment analysis</a> (which relies on <a href="http://www.clips.ua.ac.be/pages/pattern-en#sentiment">pattern</a>) to calculate the "polarity" of subject lines, from -1.0 for highly negative sentiment up to 1.0 for positive, with 0 being neutral (lack of a clear signal):</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">textblob</span> <span class="kn">import</span> <span class="n">TextBlob</span>
<span class="n">df</span><span class="p">[</span><span class="s">'feels'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">TextBlob</span><span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">'ignore'</span><span class="p">))</span><span class="o">.</span><span class="n">sentiment</span><span class="o">.</span><span class="n">polarity</span><span class="p">)</span>

<span class="c"># Output a few subject lines with their calculated sentiment scores</span>
<span class="n">df</span><span class="p">[[</span><span class="s">'subject'</span><span class="p">,</span> <span class="s">'feels'</span><span class="p">]]</span>

<span class="mi">0</span>                                      <span class="n">Fw</span><span class="p">:</span> <span class="n">this</span> <span class="ow">and</span> <span class="n">that</span>    <span class="mf">0.00000</span>
<span class="mi">1</span>                                             <span class="n">Fw</span><span class="p">:</span> <span class="n">Review</span>    <span class="mf">0.00000</span>
<span class="mi">2</span>                          <span class="n">Re</span><span class="p">:</span> <span class="n">Thanks</span> <span class="k">for</span> <span class="n">your</span> <span class="n">purchase</span><span class="err">!</span>       <span class="mf">0.25</span>
<span class="mi">3</span>            <span class="n">Re</span><span class="p">:</span> <span class="n">Monte</span> <span class="n">Carlo</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">little</span> <span class="n">bit</span> <span class="n">confusing</span> <span class="err">!</span>   <span class="o">-</span><span class="mf">0.28125</span>
<span class="o">...</span>
<span class="mi">19481</span>                              <span class="n">Re</span><span class="p">:</span> <span class="n">Great</span> <span class="n">to</span> <span class="n">see</span> <span class="n">you</span><span class="err">!</span>     <span class="mf">1.0000</span>
<span class="mi">19482</span>                                            <span class="n">Re</span><span class="p">:</span> <span class="n">API</span>       <span class="mf">0.00</span>
<span class="mi">19483</span>                                           <span class="n">Question</span>       <span class="mf">0.00</span>
<span class="mi">19484</span>                              <span class="n">Re</span><span class="p">:</span> <span class="n">HAPPY</span> <span class="n">BIRTHDAY</span><span class="err">!!!</span>    <span class="mf">1.00000</span>
</pre></div>


<h2>Using Elasticsearch</h2>
<p>If you need a primer on using Elasticsearch in Python, check out our previous <a href="http://engineroom.trackmaven.com/blog/first-monthly-challenge-elasticsearch/">monthly challenge blog post</a> to get started. If you've already got a similar project going or want to try analyzing your mail in Elasticsearch, you can run the following (while your ES instance is running) to index your inbox:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">mailbox</span> <span class="kn">import</span> <span class="n">mbox</span>
<span class="kn">from</span> <span class="nn">elasticsearch</span> <span class="kn">import</span> <span class="n">Elasticsearch</span>

<span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"message"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">"_timestamp"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">"enabled"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="s">"path"</span><span class="p">:</span> <span class="s">"date"</span><span class="p">,</span>
            <span class="s">"format"</span><span class="p">:</span> <span class="s">"E, d MMM yyyy HH:mm:ss Z"</span>
        <span class="p">},</span>
        <span class="s">"properties"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">"subject"</span><span class="p">:</span> <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="s">"string"</span><span class="p">},</span>
            <span class="s">"body"</span><span class="p">:</span> <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="s">"string"</span><span class="p">},</span>
            <span class="s">"from"</span><span class="p">:</span> <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="s">"string"</span><span class="p">},</span>
            <span class="s">"to"</span><span class="p">:</span> <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="s">"string"</span><span class="p">},</span>
            <span class="s">"date"</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">"type"</span><span class="p">:</span> <span class="s">"date"</span><span class="p">,</span>
                <span class="s">"format"</span><span class="p">:</span> <span class="s">"E, d MMM yyyy HH:mm:ss Z"</span>
            <span class="p">},</span>
            <span class="s">"labels"</span><span class="p">:</span> <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="s">"string"</span><span class="p">},</span>
            <span class="s">"epilogue"</span><span class="p">:</span> <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="s">"string"</span><span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">es</span> <span class="o">=</span> <span class="n">Elasticsearch</span><span class="p">()</span>
<span class="n">es</span><span class="o">.</span><span class="n">indices</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s">"gmail"</span><span class="p">)</span>

<span class="c"># When re-running with modifications, you'll need to remove the current index:</span>
<span class="c"># es.indices.delete_mapping(index="gmail", doc_type="message")</span>
<span class="n">es</span><span class="o">.</span><span class="n">indices</span><span class="o">.</span><span class="n">put_mapping</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s">"gmail"</span><span class="p">,</span> <span class="n">doc_type</span><span class="o">=</span><span class="s">"message"</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">mapping</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">store_content</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">body</span><span class="p">:</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(</span><span class="n">decode</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"subject"</span><span class="p">:</span> <span class="n">message</span><span class="p">[</span><span class="s">'subject'</span><span class="p">],</span>
            <span class="s">"body"</span><span class="p">:</span> <span class="n">body</span><span class="p">,</span>
            <span class="s">"from"</span><span class="p">:</span> <span class="n">message</span><span class="p">[</span><span class="s">'from'</span><span class="p">],</span>
            <span class="s">"to"</span><span class="p">:</span> <span class="n">message</span><span class="p">[</span><span class="s">'to'</span><span class="p">],</span>
            <span class="s">"date"</span><span class="p">:</span> <span class="n">message</span><span class="p">[</span><span class="s">'date'</span><span class="p">],</span>
            <span class="s">"labels"</span><span class="p">:</span> <span class="n">message</span><span class="p">[</span><span class="s">'X-Gmail-Labels'</span><span class="p">],</span>
            <span class="s">"epilogue"</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">epilogue</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">es</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s">"gmail"</span><span class="p">,</span> <span class="n">doc_type</span><span class="o">=</span><span class="s">'message'</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">contents</span><span class="p">)</span>

<span class="n">fails</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">box</span> <span class="o">=</span> <span class="n">mbox</span><span class="p">(</span><span class="s">'All mail Including Spam and Trash.mbox'</span><span class="p">)</span>
<span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">box</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s">'text/plain'</span><span class="p">:</span>
            <span class="n">store_content</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">message</span><span class="o">.</span><span class="n">is_multipart</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">get_payload</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s">'text/plain'</span><span class="p">:</span>
                    <span class="n">store_content</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">part</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(</span><span class="n">decode</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
                    <span class="k">break</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">fails</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</pre></div>


<p>We can then quickly repeat a few of our pandas analyses in an Elasticsearch-friendly way. For instance, let's get the most common terms out of all subject lines:</p>
<div class="highlight"><pre>curl -XPOST 'http://localhost:9200/gmail/_search?pretty=true&amp;search_type=count' -d'
{
    "aggregations": {
        "most_popular_term": {
            "terms": {
                "field": "body", 
                "size": 15,
                "stopwords": ["the", "and"]
            }
        }
    }
}'
</pre></div>


<p>As before, the results are less than stunning by default:</p>
<div class="highlight"><pre>{
  "took" : 54,
  "timed_out" : false,
  "_shards" : {
    "total" : 5,
    "successful" : 5,
    "failed" : 0
  },
  "hits" : {
    "total" : 17466,
    "max_score" : 0.0,
    "hits" : [ ]
  },
  "aggregations" : {
    "most_popular_term" : {
      "buckets" : [ {
        "key" : "the",
        "doc_count" : 15330
      }, {
        "key" : "to",
        "doc_count" : 15310
      }, {
        "key" : "and",
        "doc_count" : 14303
      }, {
        "key" : "you",
        "doc_count" : 14254
      }, {
        "key" : "for",
        "doc_count" : 14081
      }, {
        "key" : "a",
        "doc_count" : 13751
      }, {
        "key" : "of",
        "doc_count" : 12552
      }, {
        "key" : "is",
        "doc_count" : 11864
      }, {
        "key" : "on",
        "doc_count" : 11091
      }, {
        "key" : "i",
        "doc_count" : 10766
      }, {
        "key" : "at",
        "doc_count" : 10653
      }, {
        "key" : "fletcher",
        "doc_count" : 10571
      }, {
        "key" : "your",
        "doc_count" : 10468
      }, {
        "key" : "in",
        "doc_count" : 10343
      }, {
        "key" : "if",
        "doc_count" : 10293
      } ]
    }
  }
}
</pre></div>


<p>We could in this case configure a <a href="http://www.elasticsearch.org/guide/en/elasticsearch/guide/current/custom-analyzers.html">custom analyzer</a> that uses the <a href="http://www.elasticsearch.org/guide/en/elasticsearch/guide/current/using-stopwords.html">stopwords token filter</a>. Of course, the same TextBlob/NLTK analyses could be used directly on Elasticsearch-indexed content just as well.</p>
<p>Next steps: analyze your inbox over time; see if you can classify messages to determine sender/label/spam based attributes of the body text; use <a href="http://en.wikipedia.org/wiki/Latent_semantic_indexing">latent semantic indexing</a> to uncover the most common general topics covered; feed your sent folder into a Markov model combined with some part-of-speech tagging to generate seemingly coherent auto-replies...</p>
<p>Please <a href="mailto:engineroom@trackmaven.com">let us know</a> if you try out any interesting side projects using NLP - bonus points if you include an open-source repo. You can see previous presentations at <a href="http://challenge.hackpad.com">challenge.hackpad.com</a> for more inspiration!</p>


    <p class="addthis_sharing_toolbox"/>
  </div>
  </div></body></html>