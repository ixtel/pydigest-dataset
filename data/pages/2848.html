<html><body><div><div class="entry-content">
		<p>Не знаю как вы, а я чаще стал сталкиваться с ситуацией, когда мне нужно программно загрузить файл из локальной файловой системы или с помощью удаленного URL в модель Django. Это может понадобиться в контексте работы в оболочке Python, исполнения отдельного скрипта или команды управления Django.</p>
<p>В типичном веб-приложении такая задача встречается нечасто. Я заметил, что мы это делаем, когда переносим сайт с какой-то другой технологии на Django, и привязываем изображение к некой контентной сущности.</p>
<p>Если вы поищете ответ как сделать это в Google, то обнаружите документацию Django <a href="https://docs.djangoproject.com/en/dev/topics/http/file-uploads/">File Uploads</a>, <a href="https://docs.djangoproject.com/en/dev/ref/files/file/">File objects</a> и <a href="https://docs.djangoproject.com/en/dev/topics/files/">Managing Files</a>, которые сами по себе отличные. Тем не менее они не содержат последовательного руководства для решения нашей задачи.</p>
<p>Первый порыв — присвоить полю модели путь к файлу, но это ведет к потере информации об относительном пути к файлу, в которой нуждается Django.</p>
<p>Я выделил время, чтобы написать этот пост в основном для собственного блага, чтобы не искать заново решение в будущем. Но, надеюсь, вы также получите некоторую пользу.</p>
<h2>Этапы загрузки локального файла в Django ImageField</h2>
<p>Действия, которые необходимо выполнить:</p>
<ol>
<li>Получить файл (если он удаленный) и сохранить его локально </li>
<li>Открыть файл как обычный объект файла Python </li>
<li>Конвертировать открытый файл в Django <a href="https://docs.djangoproject.com/en/dev/ref/files/file/">FIle</a> </li>
<li>Привязать его к полю вашей модели</li>
</ol>
<h2>Пример модели</h2>
<p>Предположим, у нас есть модель вроде этой:</p>
<pre><code>from django.db import models

class Company(models.Model):
    name = models.CharField(max_length=100) 
    logo = models.ImageField()
</code></pre>
<p>Давайте создадим запись для RevSys, скачав логотип с помощью библиотеки <a href="https://github.com/kennethreitz/requests">requests</a>:</p>
<pre><code>import requests
from django.core.files import File

from .models import Company

r = requests.get(“http://media.revsys.com/img/revsys-logo.png”)

with open(“/tmp/revsys-logo.png”, “wb”) as f:
    f.write(r.content)

reopen = open(“/tmp/revsys-logo.png”, “rb”)
django_file = File(reopen)

revsys = Company()
revsys.name = “Revolution Systems”
revsys.logo.save(“revsys-logo.png”, django_file, save=True)
</code></pre>
<p>Последняя строка здесь самая важная. Методу save передается три аргумента:</p>
<ol>
<li>Относительный путь и имя файла внутри MEDIA_ROOT. </li>
<li>Файл, открытый с помощью File объекта Django.</li>
<li>Логическое значение, показывающее хотим ли мы сохранить экземпляр revsys модели Company после того, как изображение сохранено.</li>
</ol>
<p>Иногда, если вы работаете с набором изображений, вам требуется распарсить URL или пути к файлам для извлечения имен файлов. Нижеследующий код послужит отправной точкой. Обратите внимание, что тут используется Python 3:</p>
<pre><code>import os 
from urllib.parse import urlparse

# from urlparse import urlparse for Python 2.7

url = “http://media.revsys.com/img/revsys-logo.png” 
filename = os.path.basename(urlparse(url).path)

# This returns ‘revsys-logo.png’ from the URL

…

revsys.logo.save(filename, django_file, save=True)`
</code></pre>
<p>Надеюсь, это вам поможет!</p>
<p>Эта статья перевод. Оригинал: <a href="http://www.revsys.com/blog/2014/dec/03/loading-django-files-from-code/">Loading Django FileField and ImageFields from the file system</a></p>

	</div>

	
	</div></body></html>