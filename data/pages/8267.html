<html><body><div><div class="section">
              <h1>mikkoo 0.4.4</h1>

              


<p>Mikkoo is a PgQ to RabbitMQ Relay</p>








<p>A <a href="https://wiki.postgresql.org/wiki/SkyTools#PgQ" rel="nofollow">PgQ</a> to
<a href="https://www.rabbitmq.com" rel="nofollow">RabbitMQ</a> relay. Mikkoo is a PgQ consumer that
that publishes to RabbitMQ. In addition, it includes a built in auditing
system that can be used to confirm that all PgQ events are received by
RabbitMQ.</p>
<p>Mikkoo is named for the rabbit in the “Clever Rabbit and the Elephant” fable.</p>
<p><a href="http://badge.fury.io/py/mikkoo" rel="nofollow"><img src="https://img.shields.io/pypi/v/mikkoo.svg?"/></a> <a href="https://pypi.python.org/pypi/mikkoo" rel="nofollow"><img src="https://img.shields.io/pypi/dm/mikkoo.svg?"/></a> <a href="https://travis-ci.org/gmr/mikkoo" rel="nofollow"><img src="https://img.shields.io/travis/gmr/mikkoo.svg?"/></a></p>
<div id="installation">
<h2>Installation</h2>
<p>Mikkoo is available on the <a href="https://pypi.python.org/pypi/mikkoo" rel="nofollow">Python Package Index</a>
and can be installed via <cite>pip</cite>:</p>
<pre>pip install mikkoo
</pre>
<p>Once you’ve setup <a href="https://wiki.postgresql.org/wiki/SkyTools" rel="nofollow">Skytools</a> you may want to
install the optional included utility functions in <a href="mikkoo.sql" rel="nofollow">mikkoo.sql</a> to make usage
easier.</p>
<p>You can do this with a combination of <tt>curl</tt> and <tt>psql</tt>:</p>
<pre>curl -L https://github.com/gmr/mikkoo/blob/master/mikkoo.sql <span class="p">|</span> psql
</pre>
<p>This will install multiple stored procedures and an audit table in a mikkoo schema.
Take a look at the DDL to get a good idea of what each funciton is and how it can
be used.</p>
</div>
<div id="pgq-setup">
<h2>PgQ Setup</h2>
<ol>
<li><p>Install <tt>pgq</tt> into your database and create the queue:</p>
<blockquote>
<pre><span class="o">#</span> <span class="k">CREATE</span> <span class="n">EXTENSION</span> <span class="n">pgq</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="n">EXTENSION</span>
<span class="o">#</span> <span class="k">SELECT</span> <span class="n">pgq</span><span class="p">.</span><span class="n">create_queue</span><span class="p">(</span><span class="s1">'test'</span><span class="p">);</span>
<span class="n">create_queue</span>
<span class="c1">--------------
</span>            <span class="mi">1</span>
<span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
</pre>
</blockquote>
</li>
<li><p>Ensure that <a href="http://skytools.projects.pgfoundry.org/skytools-3.0/doc/pgqd.html" rel="nofollow">pgqd</a>
is running.</p>
</li>
</ol>
</div>
<div id="pgq-event-to-amqp-mapping">
<h2>PgQ Event to AMQP Mapping</h2>
<p>When inserting events into a PgQ queue, the <tt>pgq.insert_event/7</tt> function
should be used with the following field mappings:</p>
<table>
<colgroup>
<col/>
<col/>
</colgroup>
<thead>
<tr><th>PgQ Event</th>
<th>AMQP</th>
</tr>
</thead>
<tbody>
<tr><td><tt>ev_type</tt></td>
<td>Routing Key</td>
</tr>
<tr><td><tt>ev_data</tt></td>
<td>Message body</td>
</tr>
<tr><td><tt>ev_extra1</tt></td>
<td>Exchange</td>
</tr>
<tr><td><tt>ev_extra2</tt></td>
<td>Content-Type Property</td>
</tr>
<tr><td><tt>ev_extra3</tt></td>
<td>AMQP Properties <a href="#id3" id="id1" rel="nofollow">[1]</a></td>
</tr>
<tr><td><tt>ev_extra4</tt></td>
<td>Headers <a href="#id4" id="id2" rel="nofollow">[2]</a></td>
</tr>
</tbody>
</table>
<table id="id3">
<colgroup><col/><col/></colgroup>
<tbody>
<tr><td><a href="#id1" rel="nofollow">[1]</a></td><td>AMQP properties should be set as a JSON blob. Values set in the <tt>ev_extra3</tt>
field will overwrite the automatically created properties <tt>app_id</tt>,
<tt>content_type</tt>, <tt>correlation_id</tt>, <tt>headers</tt>, and <tt>timestamp</tt>.</td></tr>
</tbody>
</table>
<table id="id4">
<colgroup><col/><col/></colgroup>
<tbody>
<tr><td><a href="#id2" rel="nofollow">[2]</a></td><td>If <tt>ev_extra4</tt> is specified and is a JSON key/value dictionary, it will
be assigned to the <tt>headers</tt> AMQP property.</td></tr>
</tbody>
</table>
<p>There is a convenience schema in the <a href="mikkoo.sql" rel="nofollow">mikkoo.sql</a> file that adds
stored procedures for creating properly formatted mikkoo events in PgQ. In
addition, there is are auditing functions that allow for the creation of an
audit-log of events that were sent to PgQ.</p>
<div id="amqp-message-properties">
<h3>AMQP Message Properties</h3>
<p>The following table defines the available fields that can be set in a JSON blob
in the <tt>ev_extra3</tt> field when inserting an event.</p>
<table>
<colgroup>
<col/>
<col/>
</colgroup>
<thead>
<tr><th>Property</th>
<th>PgSQL Type</th>
</tr>
</thead>
<tbody>
<tr><td><tt>app_id</tt></td>
<td>text</td>
</tr>
<tr><td><tt>content_encoding</tt></td>
<td>text</td>
</tr>
<tr><td><tt>content_type</tt></td>
<td>text</td>
</tr>
<tr><td><tt>correlation_id</tt></td>
<td>text</td>
</tr>
<tr><td><tt>delivery_mode</tt></td>
<td>int2</td>
</tr>
<tr><td><tt>expiration</tt></td>
<td>text</td>
</tr>
<tr><td><tt>message_id</tt></td>
<td>text</td>
</tr>
<tr><td><tt>headers</tt></td>
<td>text/json <a href="#id7" id="id6" rel="nofollow">[3]</a></td>
</tr>
<tr><td><tt>timestamp</tt></td>
<td>int4</td>
</tr>
<tr><td><tt>type</tt></td>
<td>text</td>
</tr>
<tr><td><tt>priority</tt></td>
<td>int4</td>
</tr>
<tr><td><tt>user_id</tt></td>
<td>text</td>
</tr>
</tbody>
</table>
<table id="id7">
<colgroup><col/><col/></colgroup>
<tbody>
<tr><td><a href="#id6" rel="nofollow">[3]</a></td><td><tt>headers</tt> should be sent to a key/value JSON blob if specified</td></tr>
</tbody>
</table>
<p>Values assigned in the JSON blob provided to <tt>ev_extra3</tt> take precedence over
the automatically assigned <tt>app_id</tt>, <tt>content_type</tt>, <tt>correlation_id</tt>,
<tt>headers</tt>, and <tt>timestamp</tt> values created by Mikkoo at processing time.</p>
</div>
</div>
<div id="event-insertion-example">
<h2>Event Insertion Example</h2>
<p>The following example inserts a JSON blob message body of <tt>{"foo": "bar"}</tt> that
will be published to the <tt>postgres</tt> exchange in RabbitMQ using the <tt><span class="pre">test.routing-key</span></tt>
routing key. The content type is specified in <tt>ev_extra2</tt> and the AMQP <tt>type</tt>
message property is specified in <tt>ev_extra3</tt>.</p>
<pre><span class="o">#</span> <span class="k">SELECT</span> <span class="n">pgq</span><span class="p">.</span><span class="n">insert_event</span><span class="p">(</span><span class="s1">'test'</span><span class="p">,</span> <span class="s1">'test.routing-key'</span><span class="p">,</span> <span class="s1">'{"foo": "bar"}'</span><span class="p">,</span> <span class="s1">'postgres'</span><span class="p">,</span> <span class="s1">'application/json'</span><span class="p">,</span> <span class="s1">'{"type": "example"}'</span><span class="p">,</span> <span class="s1">''</span><span class="p">);</span>
 <span class="n">insert_event</span>
<span class="c1">--------------
</span>            <span class="mi">4</span>
<span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
</pre>
<p>When this message is received by RabbitMQ it will have a message body of:</p>
<pre><span class="p">{</span><span class="nt">"foo"</span><span class="p">:</span> <span class="s2">"bar"</span><span class="p">}</span>
</pre>
<p>And it will have message properties similar to the following:</p>
<table>
<colgroup>
<col/>
<col/>
</colgroup>
<thead>
<tr><th>Property</th>
<th>Example Value</th>
</tr>
</thead>
<tbody>
<tr><td><tt>app_id</tt></td>
<td><tt>mikkoo</tt></td>
</tr>
<tr><td><tt>content_type</tt></td>
<td><tt>application/json</tt></td>
</tr>
<tr><td><tt>correlation_id</tt></td>
<td><tt><span class="pre">0ad6b212-4c84-4eb0-8782-9a44bdfe949f</span></tt></td>
</tr>
<tr><td><tt>timestamp</tt></td>
<td><tt>1449600290</tt></td>
</tr>
<tr><td><tt>type</tt></td>
<td><tt>example</tt></td>
</tr>
</tbody>
</table>
</div>
<div id="configuration">
<h2>Configuration</h2>
<p>The Mikkoo configuration file uses <a href="http://yaml.org" rel="nofollow">YAML</a> for markup and allows
for one or more PgQ queue to be processed.</p>
<p>If you have a Sentry or a Sentry account, the <tt>Application/sentry_dsn</tt> setting
will turn on sentry exception logging, if the
<a href="https://pypi.python.org/pypi/raven" rel="nofollow">raven</a> client library is installed.</p>
<p>Queues are configured by name under the <tt>Application/workers</tt> stanza. The
following example configures two workers for the processing of a queue named
<tt>invoices</tt>. Each worker process connects to a local PostgreSQL and RabbitMQ
instance using default credentials.</p>
<pre><span class="l-Scalar-Plain">Application</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">workers</span><span class="p-Indicator">:</span>
     <span class="l-Scalar-Plain">invoices</span><span class="p-Indicator">:</span>
       <span class="l-Scalar-Plain">postgres_url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">postgresql://localhost:5432/postgres</span>
       <span class="l-Scalar-Plain">rabbitmq_url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">amqp://localhost:5672/%2f</span>
       <span class="l-Scalar-Plain">confirm</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">False</span>
</pre>
<div id="queue-configuration-options">
<h3>Queue Configuration Options</h3>
<p>The following table details the configuration options available per queue:</p>
<table>
<colgroup>
<col/>
<col/>
</colgroup>
<thead>
<tr><th>Key</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr><td><tt>confirm</tt></td>
<td>Enable/Disable RabbitMQ Publisher Confirmations. Default: <tt>True</tt></td>
</tr>
<tr><td><tt>consumer_name</tt></td>
<td>Overwrite the default PgQ consumer name. Default: <tt>mikkoo</tt></td>
</tr>
<tr><td><tt>max_failures</tt></td>
<td>Maximum failures before discarding an event. Default: <tt>10</tt></td>
</tr>
<tr><td><tt>postgresql_url</tt></td>
<td>The url for connecting to PostgreSQL</td>
</tr>
<tr><td><tt>rabbitmq_url</tt></td>
<td>The AMQP url for connecting to RabbitMQ</td>
</tr>
<tr><td><tt>retry_delay</tt></td>
<td>How long in seconds until PgQ emits failed events. Default: <tt>10</tt></td>
</tr>
<tr><td><tt>unregister</tt></td>
<td>Unregister a consumer with PgQ on shutdown. Default: <tt>True</tt></td>
</tr>
<tr><td><tt>wait_duration</tt></td>
<td>How long to wait before checking the queue after the last empty
result. Default: <tt>1</tt></td>
</tr>
</tbody>
</table>
</div>
<div id="example-configuration">
<h3>Example Configuration</h3>
<p>The following is an example of a full configuration file:</p>
<pre><span class="l-Scalar-Plain">Application</span><span class="p-Indicator">:</span>

  <span class="l-Scalar-Plain">poll_interval</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10</span>
  <span class="l-Scalar-Plain">sentry_dsn</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">YOUR SENTRY DSN</span><span class="p-Indicator">]</span>

  <span class="l-Scalar-Plain">statsd</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">enabled</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
    <span class="l-Scalar-Plain">host</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
    <span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">8125</span>

  <span class="l-Scalar-Plain">workers</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">test</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">confirm</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">False</span>
      <span class="l-Scalar-Plain">consumer_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">my_consumer</span>
      <span class="l-Scalar-Plain">max_failures</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>
      <span class="l-Scalar-Plain">postgres_url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">postgresql://localhost:5432/postgres</span>
      <span class="l-Scalar-Plain">rabbitmq_url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">amqp://localhost:5672/%2f</span>
      <span class="l-Scalar-Plain">retry_delay</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>
      <span class="l-Scalar-Plain">unregister</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">False</span>
      <span class="l-Scalar-Plain">wait_duration</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>

<span class="l-Scalar-Plain">Daemon</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mikkoo</span>
  <span class="l-Scalar-Plain">pidfile</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/var/run/mikkoo</span>

<span class="l-Scalar-Plain">Logging</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
  <span class="l-Scalar-Plain">formatters</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">verbose</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">format</span><span class="p-Indicator">:</span> <span class="s">'%(levelname)</span><span class="nv"> </span><span class="s">-10s</span><span class="nv"> </span><span class="s">%(asctime)s</span><span class="nv">  </span><span class="s">%(process)-6d</span><span class="nv"> </span><span class="s">%(processName)</span><span class="nv"> </span><span class="s">-20s</span><span class="nv"> </span><span class="s">%(name)</span><span class="nv"> </span><span class="s">-18s:</span><span class="nv"> </span><span class="s">%(message)s'</span>
      <span class="l-Scalar-Plain">datefmt</span><span class="p-Indicator">:</span> <span class="s">'%Y-%m-%d</span><span class="nv"> </span><span class="s">%H:%M:%S'</span>
  <span class="l-Scalar-Plain">handlers</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">console</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">class</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">logging.StreamHandler</span>
      <span class="l-Scalar-Plain">formatter</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">verbose</span>
      <span class="l-Scalar-Plain">debug_only</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">True</span>
  <span class="l-Scalar-Plain">loggers</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">helper</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">handlers</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">console</span><span class="p-Indicator">]</span>
      <span class="l-Scalar-Plain">level</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">INFO</span>
      <span class="l-Scalar-Plain">propagate</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
    <span class="l-Scalar-Plain">mikkoo</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">handlers</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">console</span><span class="p-Indicator">]</span>
      <span class="l-Scalar-Plain">level</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">INFO</span>
      <span class="l-Scalar-Plain">propagate</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
    <span class="l-Scalar-Plain">pika</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">handlers</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">console</span><span class="p-Indicator">]</span>
      <span class="l-Scalar-Plain">level</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ERROR</span>
      <span class="l-Scalar-Plain">propagate</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
    <span class="l-Scalar-Plain">queries</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">handlers</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">console</span><span class="p-Indicator">]</span>
      <span class="l-Scalar-Plain">level</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ERROR</span>
      <span class="l-Scalar-Plain">propagate</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
    <span class="l-Scalar-Plain">tornado</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">handlers</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">console</span><span class="p-Indicator">]</span>
      <span class="l-Scalar-Plain">level</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ERROR</span>
      <span class="l-Scalar-Plain">propagate</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
  <span class="l-Scalar-Plain">root</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">handlers</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">console</span><span class="p-Indicator">]</span>
    <span class="l-Scalar-Plain">level</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">CRITICAL</span>
    <span class="l-Scalar-Plain">propagate</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
  <span class="l-Scalar-Plain">disable_existing_loggers</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
  <span class="l-Scalar-Plain">incremental</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
</pre>
</div>
</div>
<div id="running-mikkoo">
<h2>Running Mikkoo</h2>
<p>After creating a configuration file for Mikkoo like the one above, simply run the mikkoo application providing the path to the configuration file:</p>
<pre>mikkoo -c mikkoo.yml
</pre>
<p>The application will attempt to daemonize unless you use the <tt><span class="pre">-f</span></tt> foreground CLI switch.</p>
<p>Mikkoo’s CLI help can be invoked with <tt><span class="pre">--help</span></tt> and yields the following output:</p>
<pre>$ mikkoo -h
usage: mikkoo <span class="o">[</span>-h<span class="o">]</span> <span class="o">[</span>-c CONFIG<span class="o">]</span> <span class="o">[</span>-f<span class="o">]</span>

Mikkoo is a PgQ to RabbitMQ Relay

optional arguments:
  -h, --help            show this <span class="nb">help</span> message and <span class="nb">exit</span>
  -c CONFIG, --config CONFIG
                        Path to the configuration file
  -f, --foreground      Run the application interactively
</pre>
</div>


<a name="downloads"> </a>


<ul class="nodot">
  <li><strong>Downloads (All Versions):</strong></li>
  <li>
    <span>0</span> downloads in the last day
  </li>
  <li>
    <span>73</span> downloads in the last week
  </li>
  <li>
    <span>582</span> downloads in the last month
  </li>
</ul>









            </div>


          </div></body></html>