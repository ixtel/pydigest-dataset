<html><body><div><article>
  <header>
    <h1 class="article-title">Writing a Lektor publisher plugin</h1>
    <time pubdate="" datetime="2015-12-24">2015-12-24</time>
  </header>
  <p><a href="https://github.com/lektor/lektor">Lektor</a> is a new static site generator which
was developed by <a href="http://lucumr.pocoo.org/">Armin Ronacher</a>. Armin has written
a lot of Python software I really love, particularly
<a href="http://flask.pocoo.org/">Flask</a>. I've always been impressed with his careful
eye for API design and the excellent quality of his code, so when he released
Lektor a few days ago, I was really interested.</p>
<p>I wanted to use Lektor for the website you're reading right now, but I host it
on S3, which isn't natively supported by Lektor as a deployment target.</p>
<p>Fortunately, there was a clear way forward: Lektor comes with a plugin system
which is intended to help developers add functionality to Lektor without
requiring the core codebase to sprawl too much. It's a good model and it's
worked well with Flask; I think it'll serve Lektor quite well too.</p>
<p>I wrote <a href="https://github.com/spenczar/lektor-s3">lektor-s3</a>, which to my
knowledge is the first published third-party plugin for Lektor. To help others
do this sort of thing, I've written down a brief guide on how you add a new
publisher to Lektor.</p>
<h2>How publishers work</h2>
<p>Publishers are really pretty simple. All you need to do is implement the
<a href="https://github.com/lektor/lektor/blob/69b6f9a4bace7f231b616ce9ad50acd3d258b014/lektor/publisher.py#L156-L167"><code>lektor.publisher.Publisher</code> class</a>:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Publisher</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">output_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">PublishError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">publish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_url</span><span class="p">,</span> <span class="n">credentials</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>
<p>To write a plugin, you make a subclass of <code>Publisher</code>. The main thing you need
to do is write an implementation of the <code>publish</code> method, whose most important
argument is <code>target_url</code>. This will be the full URL that the user is trying to
deploy to, like <code>"ftp://somehost.com"</code>. You'll get the URL as a
<a href="http://werkzeug.pocoo.org/docs/0.11/urls/#werkzeug.urls.URL"><code>werkzeug.url.URL</code></a>,
so you're able to do fancy stuff like <code>target_url.host</code> to extract parts of the
URL.</p>
<p>In addition, your publisher has access to the
<a href="https://www.getlektor.com/docs/api/environment/">environment</a> (which is sort
of a grab-bag of configuration and facts) through <code>self.env</code>, and it has a
string which is the absolute path to the latest build in <code>self.output_path</code>.</p>
<p>So, to write a working Publisher, all you need to do is write a <code>publish</code>
method which will scoop up the build artifact in <code>self.output_path</code> and send it
to the <code>target_url</code>.</p>
<h3>An example publisher</h3>
<p>Let's make an example! We'll write a publisher which does the silliest little
thing: it will copy the build directory to another local directory. This is
probably not very useful, but it's very simple, so it'll be easy to demonstrate
how things work.</p>
<p>To be more explicit, we'll write a publisher which works on targets that look
like <code>cp://localhost/path/to/dir</code>, and copies the build output to
<code>/path/to/dir</code>.</p>
<p>To do this, we'll use the
<a href="https://docs.python.org/2/library/shutil.html"><code>shutil</code></a> module from the
standard library to actually do the copying.</p>
<p>So, here we go - let's make a file called <code>lektor_copy_publisher.py</code>:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">lektor.publisher</span> <span class="kn">import</span> <span class="n">Publisher</span>

<span class="k">class</span> <span class="nc">CopyPublisher</span><span class="p">(</span><span class="n">Publisher</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">publish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_url</span><span class="p">,</span> <span class="n">credentials</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
        <span class="n">target_dir</span> <span class="o">=</span> <span class="n">target_url</span><span class="o">.</span><span class="n">path</span>
        <span class="k">yield</span> <span class="s">"copying to local directory </span><span class="si">%s</span><span class="s">"</span> <span class="o">%</span> <span class="n">target_dir</span>

        <span class="c"># Clear the target directory if it exists</span>
        <span class="k">yield</span> <span class="s">"clearing target directory"</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">target_dir</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># Copy the build output to the target directory</span>
        <span class="k">yield</span> <span class="s">"copying tree"</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">)</span>
</pre></div>
<p>And that's all it takes! A more useful publisher might have quite a bit more
logic here; for example, <code>lektor-s3</code>
<a href="https://github.com/spenczar/lektor-s3/blob/c04069c458827a2c4e3aec3f89c037866c42b328/lektor_s3.py#L120-L138">computes the difference</a>
between the local and remote state to make sure it doesn't do any wasted
work.</p>
<p>One unusual bit is the way logging is handled, which is through <code>yield</code>. The
<code>lektor deploy</code> command will handle these yields by immediately printing a
colored, well-indented message.</p>
<p>Now that we've written a publisher, let's write a plugin to hook it into Lektor.</p>
<h2>How plugins work</h2>
<p>Lektor's plugins are based on a pubsub model. The core library emits events,
which have string IDs; when an event is emitted that a plugin is subscribed to,
the plugin will fire it's handler for that method.</p>
<p>For example, when the Environment sets up it's template filters, it
<a href="https://github.com/lektor/lektor/blob/69b6f9a4bace7f231b616ce9ad50acd3d258b014/lektor/environment.py#L498-L499">emits a <code>'process-template-context'</code></a>
event. If your plugin had a method named <code>on_process_template_context</code>, then it
would be invoked when that event is emitted. To hook into that magic, all you
need to do is write a subclass of
<a href="https://github.com/lektor/lektor/blob/69b6f9a4bace7f231b616ce9ad50acd3d258b014/lektor/pluginsystem.py#L27"><code>lektor.pluginsystem.Plugin</code></a>.</p>
<h3>Continuing our example with a plugin</h3>
<p>We're writing a plugin which will configure the environment to accept a new
publisher class. To do that, we'll want to hook into the
<a href="https://github.com/lektor/lektor/blob/69b6f9a4bace7f231b616ce9ad50acd3d258b014/lektor/pluginsystem.py#L124"><code>setup-env</code> event</a>,
because we want to adjust the environment right as it gets set up. All we'll do
is add our publisher to the environment.</p>
<p>So, let's write a <code>CopyPublisherPlugin</code> and add it to <code>lektor_copy_publisher.py</code>:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">lektor.pluginsystem</span> <span class="kn">import</span> <span class="n">Plugin</span>
<span class="kn">from</span> <span class="nn">lektor.publisher</span> <span class="kn">import</span> <span class="n">Publisher</span>

<span class="k">class</span> <span class="nc">CopyPublisher</span><span class="p">(</span><span class="n">Publisher</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">publish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_url</span><span class="p">,</span> <span class="n">credentials</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
        <span class="n">target_dir</span> <span class="o">=</span> <span class="n">target_url</span><span class="o">.</span><span class="n">path</span>
        <span class="k">yield</span> <span class="s">"copying to local directory </span><span class="si">%s</span><span class="s">"</span> <span class="o">%</span> <span class="n">target_dir</span>

        <span class="c"># Clear the target directory if it exists</span>
        <span class="k">yield</span> <span class="s">"clearing target directory"</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">target_dir</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># Copy the build output to the target directory</span>
        <span class="k">yield</span> <span class="s">"copying tree"</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CopyPublisherPlugin</span><span class="p">(</span><span class="n">Plugin</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">u'copy-publisher'</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s">u'A demo plugin.'</span>

    <span class="k">def</span> <span class="nf">on_setup_env</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">add_publisher</span><span class="p">(</span><span class="s">'cp'</span><span class="p">,</span> <span class="n">CopyPublisher</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">lektor.publisher</span> <span class="kn">import</span> <span class="n">publishers</span>
            <span class="n">publishers</span><span class="p">[</span><span class="s">'cp'</span><span class="p">]</span> <span class="o">=</span> <span class="n">CopyPublisher</span>
</pre></div>
<p>This is all our plugin needs to do to add our <code>CopyPublisher</code>. The
<code>try... except</code> block is ugly, but it's required for backwards compatibility
with Lektor v1.0, which didn't provide the clean <code>add_publisher</code> interface.</p>
<p>Finally, there's one more thing we need to make our plugin. We should add a
<code>setup.py</code> file, which will let us publish the plugin to PyPi and make it easy
to install with pip.</p>
<p><code>setup.py</code>'s format is idiosyncratic, but if we focus on a narrow subset, we'll
do just fine:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">setuptools</span> <span class="kn">import</span> <span class="n">setup</span>

<span class="n">setup</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s">'lektor-copy-publisher'</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="s">'0.1'</span><span class="p">,</span>
    <span class="n">author</span><span class="o">=</span><span class="s">u'Spencer Nelson'</span><span class="p">,</span>
    <span class="n">author_email</span><span class="o">=</span><span class="s">'s@spenczar.com'</span><span class="p">,</span>
    <span class="n">url</span><span class="o">=</span><span class="s">'https://github.com/spenczar/lektor-copy-publisher'</span><span class="p">,</span>
    <span class="n">license</span><span class="o">=</span><span class="s">'MIT'</span><span class="p">,</span>
    <span class="n">py_modules</span><span class="o">=</span><span class="p">[</span><span class="s">'lektor_copy_publisher'</span><span class="p">],</span>
    <span class="n">entry_points</span><span class="o">=</span><span class="p">{</span>
        <span class="s">'lektor.plugins'</span><span class="p">:</span> <span class="p">[</span>
            <span class="s">'copy-publisher = lektor_copy_publisher:CopyPublisherPlugin'</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
<p>There are a few things to point out:</p>
<ul>
<li>The name of your package should start with <code>lektor-</code> to help it integrate
cleanly with Lektor's plugin tooling.</li>
<li><code>py_modules</code> should be a list of the modules in the same directory to bring
along. If your plugin spans multiple files - say, <code>utils.py</code>,
<code>publisher.py</code>, and <code>plugin.py</code> - then you'd need to name each and every
file: <code>['file', 'publisher', 'plugin']</code>.</li>
<li>If your plugin has dependencies outside the standard library, you should
mark those dependencies by setting the <code>install_requires</code> keyword, like
<code>install_requires=['boto3', 'Pygments']</code>.</li>
<li>The URL field <em>must</em> be set to be able to publish your plugin. You'll want
to do this, so it's worthwhile to push your plugin to github (or wherever)
so you have a URL to provide early on.</li>
</ul>
<h2>Installing and using your plugin</h2>
<p>Let's see whether our plugin works.</p>
<p>To work on the plugin locally, add a <code>packages</code> directory to your Lektor
project, and put in a symlink to your plugin's directory:</p>
<div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> &lt;...some lektor project...&gt;
<span class="nv">$ </span>mkdir packages
<span class="nv">$ </span>ln -s /home/users/spencer/src/github.com/spenczar/lektor-copy-publisher <span class="se">\</span>
    ./packages/lektor-copy-publisher
</pre></div>
<p>To confirm your plugin is installed, run <code>lektor plugins list</code>, and you should see your plugin:</p>
<div class="highlight"><pre><span class="nv">$ </span>lektor plugins list
copy-publisher <span class="o">(</span>version 0.1<span class="o">)</span>
</pre></div>
<p>Next, add a server using your new plugin's scheme to your Lektor project file:</p>
<div class="highlight"><pre><span class="k">[servers.copy]</span>
<span class="na">name</span> <span class="o">=</span> <span class="s">copy</span>
<span class="na">enabled</span> <span class="o">=</span> <span class="s">yes</span>
<span class="na">target</span> <span class="o">=</span> <span class="s">cp://localhost/tmp/build</span>
</pre></div>
<p>And now give it a shot:</p>
<div class="highlight"><pre><span class="nv">$ </span>lektor deploy copy
Deploying to copy
  Build cache: /Users/spencer/Library/Caches/Lektor/builds/6911a2f21250a1a79a0fd65f930bfd9a
  Target: cp://localhost/tmp/build
  copying to <span class="nb">local </span>directory /tmp/build
  clearing target directory
  copying tree
Done!
</pre></div>
<p>You've got a working plugin!</p>
<h2>Publishing your plugin</h2>
<p>To make your plugin available to other users, you should add it to PyPi. This
can be a bit of a hassle, but lektor gives a command-line tool that should make
it pretty painless: Run <code>lektor dev publish-plugin</code> and a proper distributable
version of your package will be built.</p>
<p>You'll get asked to authenticate with PyPI, which means you need to set up an
account if you don't have one, but it's pretty easy.</p>
<h2>Publicize</h2>
<p>The final step is to let people know about your plugin! The simplest way to do
this is to add it to
<a href="https://www.getlektor.com/docs/plugins/list/">the official list of plugins</a> on
the Lektor website. You can do this by making a pull request to the
<a href="https://github.com/lektor/lektor-website/blob/master/content/docs/plugins/list/contents.lr">lektor-website</a>
project - please, share your creation!</p>
<p>I hope this convinced you that writing a Lektor publisher plugin is really
quite simple. Lektor is cleanly designed and a delight to use, so I think it's
going to succeed. The more publishers it has available, the quicker and
stronger it will grow, so don't hesitate to jump in and contribute while the
project is young and there's plenty of low-hanging fruit.</p>

</article>

    </div></body></html>