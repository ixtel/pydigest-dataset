<html><body><div><div class="content-body" itemprop="text articleBody">
      <img class="article-image img-responsive" alt="article header image" itemprop="image" src="http://pbpython.com/images/MN-budget2.png"/>
	<div class="section" id="introduction">
<h2>Introduction</h2>
<p>More and more information from local, state and federal governments is being placed
on the web. However, a lot of the data is not presented in a way that is easy
to download and manipulate. I think it is an important civic duty for us all to be aware
of how government money is spent. Having the data in a more accessible format is
a first step in that process.</p>
<p>In this article, I’ll use <a class="reference external" href="http://www.crummy.com/software/BeautifulSoup/">BeautifulSoup</a> to scrape some data from the Minnesota 2014 Capital Budget.
Then I’ll load the data into a pandas <a class="reference external" href="http://pandas.pydata.org/pandas-docs/dev/generated/pandas.DataFrame.html">DataFrame</a> and create a simple plot showing where the money is going.</p>
<p>My purpose in writing this is not to make any specific political statements about this data set.
I chose this data because:</p>
<ul class="simple">
<li>I personally found it interesting</li>
<li>I think it translates well across other states and across the world</li>
<li>It highlights several useful python tools both in and outside of the stdlib</li>
<li>The process is applicable to other domains outside of government data</li>
<li>It is a manageable size so you can understand it using basic tools</li>
</ul>
</div>
<div class="section" id="the-data">
<h2>The Data</h2>
<p>I live in <span class="caps">MN</span> so thought I would take a look at what sort of budget information
is available to us via the various state websites. To be honest, there is a lot of
information but it seems like the vast majority is stored in a <span class="caps">PDF</span> or on an <span class="caps">HTML</span> page.</p>
<p>I applaud the state for making the data available but it is not easy to analyze the
data in the way it is currently presented. As I looked through the Minnesota government
website, I found this <a class="reference external" href="https://www.revisor.mn.gov/laws/?year=2014&amp;type=0&amp;doctype=Chapter&amp;id=294">2014 Capital Budget page</a>  which is actually pretty straightforward to understand.</p>
<p>The first part of the document contains a high level summary of all the projects receiving capital dollars as
well as how the capital budget will be funded.</p>
<p>The second part of the document has a lot of detail on each of the summary items. For the purpose
of this exercise, I am only going to scrape the summary section but the same basic principle can be applied
to the detailed line items.</p>
<p>One final note, I realize that this data set is not that large and that you could easily type it
all into Excel. However, if we were to scale this to pull in more data, you quickly get to the point
where hand typing the data just does not make sense. The principles I walk through will scale to much larger sets.
I hope it has the added bonus that you will learn something as well. I know I enjoyed working on this little project.</p>
</div>

<div class="section" id="start-the-process">
<h2>Start the Process</h2>
<p>Import all the modules we need:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
</pre></div>
<p>Now we need to initialize the variables. I’m going to use two dictionaries. One will store
all of the expense items and the other will include the funding source. Note, I am not
going to store the total. We can calculate it so we’ll skip that piece of data. I am using the
<code class="code">
defaultdict</code>
 to make it easy to append the values I scrape:</p>
<div class="highlight"><pre><span class="n">url</span> <span class="o">=</span> <span class="s">"https://www.revisor.mn.gov/laws/?year=2014&amp;type=0&amp;doctype=Chapter&amp;id=294"</span>
<span class="c"># Init the variables</span>
<span class="c"># Use a defaultdict with an empty list because it eases the DataFrame creation</span>
<span class="n">expense_lines</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="n">funding_lines</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="n">funding</span> <span class="o">=</span> <span class="bp">False</span>
</pre></div>
<p>Use requests to get the data and pass it to BeautifulSoup.
In my final script, I’m going to store the <span class="caps">HTML</span> to disk so that I don’t need to hit the
website every time I run it. I won’t show it in this section in order to keep
the code short.</p>
<div class="highlight"><pre><span class="n">result</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">content</span>
<span class="c"># Now that we have the data, let's process it</span>
<span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="understand-your-html">
<h2>Understand Your <span class="caps">HTML</span></h2>
<p>The key to understanding any scraping is looking at the <span class="caps">HTML</span> and understanding
how you want to pull your data out.</p>
<p>In this case, I downloaded the <span class="caps">HTML</span> into an editor and collapsed some of the data.
It is very helpful that there is a div that wraps the data I need:</p>
<div class="highlight"><pre><span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"enacting_clause"</span><span class="nt">&gt;</span>BE IT ENACTED BY THE LEGISLATURE OF THE STATE OF MINNESOTA:<span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"article"</span> <span class="na">id=</span><span class="s">"laws.1.0.0"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">"article_no"</span><span class="nt">&gt;</span>ARTICLE 1<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">"article_header"</span><span class="nt">&gt;</span>APPROPRIATIONS<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"bill_section"</span> <span class="na">id=</span><span class="s">"laws.1.1.0"</span><span class="nt">&gt;</span>
</pre></div>
<p>Within that div, there are mutliple tables which ultimately contain the info we need:</p>
<div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"bill_section"</span> <span class="na">id=</span><span class="s">"laws.1.1.0"</span><span class="nt">&gt;</span>
     <span class="nt">&lt;table&gt;</span>
       <span class="nt">&lt;col</span> <span class="na">style=</span><span class="s">"width:100%"</span><span class="nt">/&gt;</span>
       <span class="nt">&lt;tr&gt;</span>
         <span class="nt">&lt;td</span> <span class="na">style=</span><span class="s">"border-bottom: 1px solid transparent; border-right: 1px solid transparent;"</span> <span class="na">valign=</span><span class="s">"bottom"</span><span class="nt">&gt;</span>
           <span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">"bill_sec_no"</span><span class="nt">&gt;</span>Section 1. <span class="nt">&lt;/h1&gt;</span>
           <span class="nt">&lt;h3</span> <span class="na">class=</span><span class="s">"headnote"</span><span class="nt">&gt;</span>
             <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"new"</span> <span class="na">style=</span><span class="s">"text-decoration: underline"</span><span class="nt">&gt;</span>CAPITAL IMPROVEMENT APPROPRIATIONS.<span class="nt">&lt;/span&gt;</span>
           <span class="nt">&lt;/h3&gt;</span>
         <span class="nt">&lt;/td&gt;</span>
       <span class="nt">&lt;/tr&gt;</span>
     <span class="nt">&lt;/table&gt;</span>
     <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"first"</span><span class="nt">&gt;</span>
     <span class="nt">&lt;/p&gt;</span>
     <span class="nt">&lt;table&gt;</span>
</pre></div>
<p>Finally, here is a row of data:</p>
<div class="highlight"><pre><span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;td</span> <span class="na">style=</span><span class="s">"border-bottom: 1px solid transparent; border-right: 1px solid transparent;"</span> <span class="na">valign=</span><span class="s">"bottom"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"new"</span> <span class="na">style=</span><span class="s">"text-decoration: underline"</span><span class="nt">&gt;</span>University of Minnesota<span class="nt">&lt;/span&gt;</span>
          <span class="nt">&lt;/td&gt;</span>
          <span class="nt">&lt;td</span> <span class="na">style=</span><span class="s">"border-bottom: 1px solid transparent; border-right: 1px solid transparent;"</span> <span class="na">valign=</span><span class="s">"bottom"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"new"</span> <span class="na">style=</span><span class="s">"text-decoration: underline"</span><span class="nt">&gt;</span>$<span class="nt">&lt;/span&gt;</span>
          <span class="nt">&lt;/td&gt;</span>
          <span class="nt">&lt;td</span> <span class="na">style=</span><span class="s">"border-bottom: 1px solid transparent; border-right: 1px solid transparent;"</span> <span class="na">valign=</span><span class="s">"bottom"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"new"</span> <span class="na">style=</span><span class="s">"text-decoration: underline"</span><span class="nt">&gt;</span>119,367,000<span class="nt">&lt;/span&gt;</span>
          <span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
</pre></div>
<p>In the example above, we want to parse out two pieces of data - the description (Universty of Minnesota) and the amount (119,367,000).
Another item to note is that the number comes through with commas as well as parenthesis for negative values so we are going to need to clean it up a little. I also found that I pulled in a lot of extra white space in the process, so using <code class="code">
string.strip</code>
 is a good idea.</p>
<p>Here is the clean up function we’ll use:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">convert_num</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Convert the string number value to a float</span>
<span class="sd">     - Remove all extra whitespace</span>
<span class="sd">     - Remove commas</span>
<span class="sd">     - If wrapped in (), then it is negative number</span>
<span class="sd">    """</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">","</span><span class="p">,</span><span class="s">""</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"("</span><span class="p">,</span><span class="s">"-"</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">")"</span><span class="p">,</span><span class="s">""</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="parse-the-html">
<h2>Parse the <span class="caps">HTML</span></h2>
<p>Now that we know how to get to our tables, use BeautifulSoup’s powerful <span class="caps">API</span> to get at our data.</p>
<div class="highlight"><pre><span class="c"># After looking at the data, we can see that the summary has a div id we can use</span>
<span class="n">summary</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">"div"</span><span class="p">,</span> <span class="p">{</span><span class="s">"class"</span><span class="p">:</span><span class="s">"bill_section"</span><span class="p">,</span><span class="s">"id"</span><span class="p">:</span> <span class="s">"laws.1.1.0"</span><span class="p">})</span>

<span class="c"># Get all the tables in the summary</span>
<span class="n">tables</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s">'table'</span><span class="p">)</span>

<span class="c"># The first table is not useful header info</span>
<span class="c"># The second table contains all the we need (the list is 0 indexed)</span>
<span class="n">data_table</span> <span class="o">=</span> <span class="n">tables</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
<p>Parse each row in the table and add to the appropriate dictionary depending on whether it is
a funding line or expense line:</p>
<div class="highlight"><pre><span class="c">#Go through each row of the table and pull out our data</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data_table</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s">"tr"</span><span class="p">):</span>
    <span class="n">cells</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s">"td"</span><span class="p">)</span>
    <span class="c"># Ignore lines that don't have 3 cells of data because it is just spacing</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">cells</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">),</span> <span class="n">convert_num</span><span class="p">(</span><span class="n">cells</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>
        <span class="c"># Once we get to the total line we start getting the funding lines</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">"TOTAL"</span><span class="p">:</span>
            <span class="n">funding</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="c"># We don't want to capture the total because we can calc it</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">funding</span><span class="p">:</span>
            <span class="n">funding_lines</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expense_lines</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<div class="section" id="convert-the-data">
<h2>Convert the Data</h2>
<p>Our dictionaries contain the data we need, let’s add them to a pandas DataFrame using <code class="code">
DataFrame.from_dict()</code>
:</p>
<div class="highlight"><pre><span class="c"># Create the DataFrame using from_dict</span>
<span class="n">expense_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">expense_lines</span><span class="p">,</span><span class="n">orient</span><span class="o">=</span><span class="s">'index'</span><span class="p">)</span>
<span class="n">funding_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">funding_lines</span><span class="p">,</span><span class="n">orient</span><span class="o">=</span><span class="s">'index'</span><span class="p">)</span>
<span class="c"># Label our column</span>
<span class="n">expense_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s">'Amount'</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">funding_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s">'Amount'</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
<p>First, we look at a small subset of the spending lines:</p>

<div>
<table border="1" class="dataframe">
<thead>
<tr>
<th/>
<th>Amount</th>
</tr>
</thead>
<tbody>
<tr>
<th>Administration</th>
<td> 127000000</td>
</tr>
<tr>
<th>Bond Sale Expenses</th>
<td>    900000</td>
</tr>
<tr>
<th>Minnesota State Academies</th>
<td>  11354000</td>
</tr>
<tr>
<th>Public Facilities Authority</th>
<td>  45993000</td>
</tr>
<tr>
<th>Housing Finance Agency</th>
<td>  20000000</td>
</tr>
</tbody>
</table>
</div><p>Then look at how it is funded.</p>

<div>
<table border="1" class="dataframe">
<thead>
<tr>
<th/>
<th>Amount</th>
</tr>
</thead>
<tbody>
<tr>
<th>State Transportation Fund</th>
<td>  36613000</td>
</tr>
<tr>
<th>Trunk Highway Fund</th>
<td>   7950000</td>
</tr>
<tr>
<th>Bond Proceeds Fund (User Financed Debt Service)</th>
<td>  39104000</td>
</tr>
<tr>
<th>Bond Proceeds Cancellations</th>
<td> -10849000</td>
</tr>
<tr>
<th>Maximum Effort School Loan Fund</th>
<td>   5491000</td>
</tr>
<tr>
<th>Bond Proceeds Fund (General Fund Debt Service)</th>
<td> 814745000</td>
</tr>
</tbody>
</table>
</div><p>We can check our totals too to make sure we processed the data correctly.</p>
<div class="highlight"><pre><span class="n">expense_df</span><span class="p">[</span><span class="s">"Amount"</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
<pre class="literal-block">
893054000.0
</pre>
<div class="highlight"><pre><span class="n">funding_df</span><span class="p">[</span><span class="s">"Amount"</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
<pre class="literal-block">
893054000.0
</pre>
<p>It looks like everything was processed correctly. Now, we can analyze the data
any way we want.</p>
</div>
<div class="section" id="plot-the-data">
<h2>Plot The Data</h2>
<p>In this specific case, I am going to generate a simple horizontal bar graph
so that it is easy to see where the biggest expenditures are.</p>
<p>First, I’ll sort both sets of data:</p>
<div class="highlight"><pre><span class="n">expense_df</span> <span class="o">=</span> <span class="n">expense_df</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s">'Amount'</span><span class="p">)</span>
<span class="n">funding_df</span> <span class="o">=</span> <span class="n">funding_df</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s">'Amount'</span><span class="p">)</span>
</pre></div>
<div class="panel panel-info">
<p class="panel-heading">
Making Nice Plots</p>
<p class="panel-body">
If you don’t learn anything else from this article, don’t forget that you can make
your default plots look a lot nicer by using a simple pandas settings -
<code class="code">
pd.options.display.mpl_style = 'default'</code>
</p>
</div>
<p>Set our default plot style so it looks nicer:</p>
<div class="highlight"><pre><span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">mpl_style</span> <span class="o">=</span> <span class="s">'default'</span>
</pre></div>
<p>Plot horizontal bar chart</p>
<div class="highlight"><pre><span class="n">expense_df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">'barh'</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span><span class="n">title</span><span class="o">=</span><span class="s">"2014 MN Capital Budget Spending"</span><span class="p">)</span>
</pre></div>

<p>For comparison, here is what the image looks like if you don’t set <code class="code">
pd.options.display.mpl_style</code>
</p>

<p>Regardless of the format, I think you’ll agree that viewing the capital budget in this plot yields a lot more
insight than the raw <span class="caps">HTML</span> data.</p>
</div>
<div class="section" id="final-thoughts">
<h2>Final Thoughts</h2>
<p>This little project has been useful for me and I hope it provides a starting point for you
to understand how to use various python tools to scrape the web. In this case, I learned a little
bit that I think could be applicable to lots of other projects. I also am curious about this little
slice of data and intend to look into it some more and see what insight I can glean.</p>
<p>For reference, here is the complete code for this example. This version will download
the data to a file and use that locally instead of hitting the site each time.</p>
<div class="highlight"><pre><span class="c">#Parse 2014 MN Capital budget - https://www.revisor.mn.gov/laws/?year=2014&amp;type=0&amp;doctype=Chapter&amp;id=294</span>
<span class="c">#Store the summary in a DataFrame for eventual manipulation</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="n">filename</span> <span class="o">=</span> <span class="s">"MNBudget-2014.html"</span>
<span class="n">url</span> <span class="o">=</span> <span class="s">"https://www.revisor.mn.gov/laws/?year=2014&amp;type=0&amp;doctype=Chapter&amp;id=294"</span>

<span class="k">def</span> <span class="nf">convert_num</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Convert the string number value to a float</span>
<span class="sd">     - Remove all extra whitespace</span>
<span class="sd">     - Remove commas</span>
<span class="sd">     - If wrapped in (), then it is negative number</span>
<span class="sd">    """</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">","</span><span class="p">,</span><span class="s">""</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"("</span><span class="p">,</span><span class="s">"-"</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">")"</span><span class="p">,</span><span class="s">""</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

<span class="c"># As we work through the process, it is easier to</span>
<span class="c"># download it once and work with the saved copy instead of</span>
<span class="c"># trying to hit the server each time</span>
<span class="c"># Just delete the output file to force a new download</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Loading the data via the file."</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Fetching the data via the URL."</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">content</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">'w'</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c"># Init the variables</span>
<span class="c"># Use a defaultdict with an empty list because it eases the DataFrame creation</span>
<span class="n">expense_lines</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="n">funding_lines</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="n">funding</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c"># Now that we have the data, let's process it</span>
<span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

<span class="c"># After looking at the data, we can see that the summary has a div id we can use</span>
<span class="n">summary</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">"div"</span><span class="p">,</span> <span class="p">{</span><span class="s">"class"</span><span class="p">:</span><span class="s">"bill_section"</span><span class="p">,</span><span class="s">"id"</span><span class="p">:</span> <span class="s">"laws.1.1.0"</span><span class="p">})</span>

<span class="c"># Get all the tables in the summary</span>
<span class="n">tables</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s">'table'</span><span class="p">)</span>

<span class="c"># The first table is not useful header info</span>
<span class="c"># The second table contains all the we need (the list is 0 indexed)</span>
<span class="n">data_table</span> <span class="o">=</span> <span class="n">tables</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="c">#Go through each row of the table and pull out our data</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data_table</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s">"tr"</span><span class="p">):</span>
    <span class="n">cells</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s">"td"</span><span class="p">)</span>
    <span class="c"># Ignore lines that don't have 3 cells of data because it is just spacing</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">cells</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">),</span> <span class="n">convert_num</span><span class="p">(</span><span class="n">cells</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>
        <span class="c"># Once we get to the total line we start getting the funding lines</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">"TOTAL"</span><span class="p">:</span>
            <span class="n">funding</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="c"># We don't want to capture the total because we can calc it</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">funding</span><span class="p">:</span>
            <span class="n">funding_lines</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expense_lines</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="c"># Create the DataFrame using from_dict</span>
<span class="n">expense_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">expense_lines</span><span class="p">,</span><span class="n">orient</span><span class="o">=</span><span class="s">'index'</span><span class="p">)</span>
<span class="n">funding_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">funding_lines</span><span class="p">,</span><span class="n">orient</span><span class="o">=</span><span class="s">'index'</span><span class="p">)</span>
<span class="c"># Label our column</span>
<span class="n">expense_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s">'Amount'</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">funding_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s">'Amount'</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">expense_df</span> <span class="o">=</span> <span class="n">expense_df</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s">'Amount'</span><span class="p">)</span>
<span class="n">funding_df</span> <span class="o">=</span> <span class="n">funding_df</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s">'Amount'</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">expense_df</span><span class="p">[</span><span class="s">"Amount"</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="n">funding_df</span><span class="p">[</span><span class="s">"Amount"</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

<span class="c">#Set some nicer defaults for plots</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">mpl_style</span> <span class="o">=</span> <span class="s">'default'</span>

<span class="n">expense_bar</span> <span class="o">=</span> <span class="n">expense_df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">'barh'</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">13</span><span class="p">],</span><span class="n">title</span><span class="o">=</span><span class="s">"2014 MN Capital Budget Spending"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">"MN-2014-Expense.png"</span><span class="p">)</span>

<span class="n">funding_bar</span> <span class="o">=</span> <span class="n">funding_df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">'barh'</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="s">"2014 MN Capital Budget Funding"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">"MN-2014-Funding.png"</span><span class="p">)</span>
</pre></div>
</div>

  </div>
  
</div></body></html>