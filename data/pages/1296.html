<html><body><div><div class="entry-content">
        <p>Django’s Admin is amazing. A built-in and fully functional interface that quickly gets in and allows data entry is priceless. Developers can focus on building additional functionality instead of creating dummy interfaces to interact with the database. Not to say <a href="https://docs.djangoproject.com/en/dev/topics/class-based-views/">class-based views</a> aren’t magical on their own; the Admin is simply quicker to configure.</p>
<p>All the good stuff aside, sometimes the Admin can be a bit dumb. Specifically, it tends to handle relationships poorly. There are two common ways that the Admin views can grind to a halt and several things that can be done to fix it.</p>
<h3>Massive <code>ForeignKey</code> Relationships</h3>
<p>By default Django will display <em>all</em> the options when editing a model that contains a <a href="https://docs.djangoproject.com/en/dev/ref/models/fields/#foreignkey"><code>ForeignKey</code></a> relationship. Take the following Model structure for this example.</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="k">class</span> <span class="nc">Foo</span> <span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Bar</span> <span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">foo_parent</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">"Foo"</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>


<p>Suppose there are 1,000,000 <code>Foo</code> objects and you are editing a <code>Bar</code> object. Django will attempt to fetch all the <code>Foo</code> objects to render the select field. Not only is this incredibly cumbersome in terms of editing but it grinds to a halt at a certain point. This is an easy trap to fall into, especially when you have a Model specifically for data points, such as page view analytics.</p>
<p>This problem is further exposed when you do something silly, such as adding a <code>ForeignKey</code> field to the <a href="https://docs.djangoproject.com/en/dev/ref/contrib/admin/#django.contrib.admin.ModelAdmin.list_editable"><code>list_editable</code></a> list. Now with only 100 <code>Foo</code> objects and 100 <code>Bar</code> objects you would generate a $O(n)$ queries to render a list view of $n$ <code>Foo</code> objects. Django won’t cache the queryset and reuse it across all the objects.</p>
<h4>Recommendations</h4>
<ol>
<li>Override the <a href="https://docs.djangoproject.com/en/dev/ref/contrib/admin/#django.contrib.admin.ModelAdmin.get_queryset"><code>get_queryset</code></a> method for the <code>ModelAdmin</code> class and use <a href="https://docs.djangoproject.com/en/dev/ref/models/querysets/#django.db.models.query.QuerySet.select_related"><code>select_related</code></a> or <a href="https://docs.djangoproject.com/en/dev/ref/models/querysets/#django.db.models.query.QuerySet.prefetch_related"><code>prefetch_related</code></a> to avoid repeated queries.<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup></li>
<li>Add the field to <a href="https://docs.djangoproject.com/en/dev/ref/contrib/admin/#django.contrib.admin.ModelAdmin.raw_id_fields"><code>raw_id_fields</code></a> to render a normal input with the <code>id</code> of the object instead of a select widget.</li>
<li>If the upper bound of a <code>ForeignKey</code> field is not small enough to manage, add it to <a href="https://docs.djangoproject.com/en/dev/ref/contrib/admin/#django.contrib.admin.ModelAdmin.readonly_fields"><code>readonly_fields</code></a> in the admin configuration and devise another method for editing it.</li>
<li><strong>Never</strong> add a <code>ForeignKey</code> field to <a href="https://docs.djangoproject.com/en/dev/ref/contrib/admin/#django.contrib.admin.ModelAdmin.list_editable"><code>list_editable</code></a> without a very good reason and a <em>very</em> small related object set.</li>
<li>Keep close attention to the number of queries it takes to render the list, add, and change views for the admin using something like <a href="http://django-debug-toolbar.readthedocs.org/en/1.2/">Django Debug Toolbar</a>.</li>
<li>Use an alternative admin theme such as <a href="http://grappelliproject.com">Grappelli</a> that includes extra widgets such as <a href="http://django-grappelli.readthedocs.org/en/latest/customization.html#autocomplete-lookups">autocomplete lookups</a> to remove the requirement to query all related models before rendering the view.</li>
</ol>
<h3>Related Lookups</h3>
<p>Django by default uses the <code>__str__</code> (or <code>__unicode__</code> if you’re using Python &lt;3) method to display what a ForeignKey’s “value” is. Expanding on the example above:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>

<span class="k">class</span> <span class="nc">Foo</span> <span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__str__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

<span class="k">class</span> <span class="nc">Bar</span> <span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">foo</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Foo</span><span class="p">)</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__str__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">"{} - {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subject</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Caz</span> <span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">bar</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">bar</span><span class="p">)</span>
    <span class="n">classifier</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__str__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">"{}: {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="p">)</span>
</pre></div>


<p>See anything obviously wrong yet? The recursive <code>__str__</code> calling should be a big hint. What happens when the Admin tries to render a list of <code>Caz</code> objects that are listed as a ForeignKey from some other model? After grabbing a list of all <code>Caz</code>s, it starts iterating through them, which triggers a lookup on <code>Bar</code>, which triggers a lookup on <code>Foo</code>, for every single <code>Caz</code> object. This makes the number of queries required to render a simple select option take $O(2n)$ queries where $n$ is the number of <code>Caz</code> objects. This can easily cripple an edit view in production where some model count is exploding out of control.</p>
<p><img alt="Django's chained querying" src="http://www.joshuakehn.com/assets/images/misc/django_str.jpg"/></p>
<h3>Recommendations</h3>
<ol>
<li>Avoid including <code>ForeignKey</code> fields in <code>__str__</code> or <code>__unicode__</code> methods for other Models.</li>
<li>Use <code>__repr__</code> instead for dumping helpful information out when prowling around in the shell.</li>
<li>Define a custom property for outputting full object information in templates where the query count is manageable.</li>
<li>Cache the related names on the object itself and have it update on save. This is non-normal form but will help control the number of queries generated automatically.</li>
<li>Use raw <span class="caps">SQL</span> code to generate the information you need. The above for a list view could easily be replaced by some <code>JOIN</code>s in a query.</li>
</ol>
<p><a href="http://www.reddit.com/r/django/comments/2euqwm/djangos_admin_in_production/">Comment on reddit’s /r/django</a>.</p>

    </div>
    </div></body></html>