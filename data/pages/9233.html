<html><body><div><section class="entry">
<p class="fsb-clear"/><p><a href="http://www.pyimagesearch.com/wp-content/uploads/2016/01/bryce_result_02.jpg"><img class="aligncenter wp-image-3553" src="http://www.pyimagesearch.com/wp-content/uploads/2016/01/bryce_result_02.jpg" alt="bryce_result_02" srcset="http://www.pyimagesearch.com/wp-content/uploads/2016/01/bryce_result_02-300x238.jpg 300w, http://www.pyimagesearch.com/wp-content/uploads/2016/01/bryce_result_02-1024x811.jpg 1024w, http://www.pyimagesearch.com/wp-content/uploads/2016/01/bryce_result_02.jpg 1250w" sizes="(max-width: 600px) 100vw, 600px"/></a></p>
<p>In today’s blog post, I’ll demonstrate how to perform <em><strong>image stitching and panorama construction</strong></em> using Python and OpenCV. Given two images, we’ll “stitch” them together to create a simple panorama, as seen in the example above.</p>
<p>To construct our image panorama, we’ll utilize computer vision and image processing techniques such as: keypoint detection and local invariant descriptors; keypoint matching; RANSAC; and perspective warping.</p>
<p>Since there are <a href="http://www.pyimagesearch.com/2015/07/16/where-did-sift-and-surf-go-in-opencv-3/" target="_blank"><em><strong>major differences</strong></em> in how OpenCV 2.4.X and OpenCV 3.X handle keypoint detection and local invariant descriptors</a> (such as SIFT and SURF), I’ve taken special care to provide code that is compatible with <em><strong>both</strong></em> versions (provided that you compiled OpenCV 3 with 
			<span id="crayon-56d5b2480faa2669748341" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">opencv_contrib</span></span></span>  support, of course).</p>
<p>In future blog posts we’ll extend our panorama stitching code to work with multiple images rather than just two.</p>
<p><strong>Read on to find out how panorama stitching with OpenCV is done.</strong></p>

<h2>OpenCV panorama stitching</h2>
<p>Our panorama stitching algorithm consists of four steps:</p>
<ul>
<li><strong>Step #1:</strong> Detect keypoints (DoG, Harris, etc.) and extract local invariant descriptors (SIFT, SURF, etc.) from the two input images.</li>
<li><strong>Step #2:</strong> Match the descriptors between the two images.</li>
<li><strong>Step #3:</strong> Use the <a href="https://en.wikipedia.org/wiki/RANSAC" target="_blank">RANSAC algorithm</a> to estimate a <a href="https://en.wikipedia.org/wiki/Homography_(computer_vision)" target="_blank">homography matrix</a> using our matched feature vectors.</li>
<li><strong>Step #4:</strong> Apply a warping transformation using the homography matrix obtained from <strong>Step #3</strong>.</li>
</ul>
<p>We’ll encapsulate all four of these steps inside 
			<span id="crayon-56d5b2480faaf176011993" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">panorama</span><span class="crayon-sy">.</span><span class="crayon-v">py</span></span></span> , where we’ll define a 
			<span id="crayon-56d5b2480fab3560477345" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">Stitcher</span></span></span>  class used to construct our panoramas.</p>
<p>The 
			<span id="crayon-56d5b2480fab7255209453" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">Stitcher</span></span></span>  class will rely on the <a href="https://github.com/jrosebr1/imutils" target="_blank">imutils</a> Python package, so if you don’t already have it installed on your system, you’ll want to go ahead and do that now:</p>

		

<p>Let’s go ahead and get started by reviewing 
			<span id="crayon-56d5b2480fabf226821687" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">panorama</span><span class="crayon-sy">.</span><span class="crayon-v">py</span></span></span> :</p>

		<div id="crayon-56d5b2480fac2777817155" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b2480fac2777817155-1"><span class="crayon-c"># import the necessary packages</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fac2777817155-2"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">numpy </span><span class="crayon-st">as</span><span class="crayon-h"> </span><span class="crayon-e">np</span></p><p class="crayon-line" id="crayon-56d5b2480fac2777817155-3"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">imutils</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fac2777817155-4"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">cv2</span></p><p class="crayon-line" id="crayon-56d5b2480fac2777817155-5"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fac2777817155-6"><span class="crayon-t">class</span><span class="crayon-h"> </span><span class="crayon-v">Stitcher</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2480fac2777817155-7"><span class="crayon-h">	</span><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">__init__</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fac2777817155-8"><span class="crayon-h">		</span><span class="crayon-c"># determine if we are using OpenCV v3.X</span></p><p class="crayon-line" id="crayon-56d5b2480fac2777817155-9"><span class="crayon-h">		</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">isv3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">imutils</span><span class="crayon-sy">.</span><span class="crayon-e">is_cv3</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>We start off on <strong>Lines 2-4</strong> by importing our necessary packages. We’ll be using NumPy for matrix/array operations, 
			<span id="crayon-56d5b2480fac6702576455" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">imutils</span></span></span>  for a set of OpenCV convenience methods, and finally 
			<span id="crayon-56d5b2480faca785929569" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">cv2</span></span></span>  for our OpenCV bindings.</p>
<p>From there, we define the 
			<span id="crayon-56d5b2480face252024991" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">Stitcher</span></span></span>  class on <strong>Line 6</strong>. The constructor to 
			<span id="crayon-56d5b2480fad1477455795" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">Stitcher</span></span></span>  simply checks which version of OpenCV we are using by making a call to the 
			<span id="crayon-56d5b2480fad5158487977" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">is_cv3</span></span></span>  method. Since there are <a href="http://www.pyimagesearch.com/2015/07/16/where-did-sift-and-surf-go-in-opencv-3/" target="_blank">major differences in how OpenCV 2.4 and OpenCV 3 handle keypoint detection and local invariant descriptors</a>, it’s important that we determine the version of OpenCV that we are using.</p>
<p>Next up, let’s start working on the 
			<span id="crayon-56d5b2480fad9872572708" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">stitch</span></span></span>  method:</p>

		<div id="crayon-56d5b2480fadc173681383" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-56d5b2480fadc173681383-11">11</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fadc173681383-12">12</p><p class="crayon-num" data-line="crayon-56d5b2480fadc173681383-13">13</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fadc173681383-14">14</p><p class="crayon-num" data-line="crayon-56d5b2480fadc173681383-15">15</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fadc173681383-16">16</p><p class="crayon-num" data-line="crayon-56d5b2480fadc173681383-17">17</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fadc173681383-18">18</p><p class="crayon-num" data-line="crayon-56d5b2480fadc173681383-19">19</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fadc173681383-20">20</p><p class="crayon-num" data-line="crayon-56d5b2480fadc173681383-21">21</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fadc173681383-22">22</p><p class="crayon-num" data-line="crayon-56d5b2480fadc173681383-23">23</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fadc173681383-24">24</p><p class="crayon-num" data-line="crayon-56d5b2480fadc173681383-25">25</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fadc173681383-26">26</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b2480fadc173681383-11"><span class="crayon-h">	</span><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">stitch</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">images</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ratio</span><span class="crayon-o">=</span><span class="crayon-cn">0.75</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">reprojThresh</span><span class="crayon-o">=</span><span class="crayon-cn">4.0</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fadc173681383-12"><span class="crayon-h">		</span><span class="crayon-v">showMatches</span><span class="crayon-o">=</span><span class="crayon-t">False</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2480fadc173681383-13"><span class="crayon-h">		</span><span class="crayon-c"># unpack the images, then detect keypoints and extract</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fadc173681383-14"><span class="crayon-h">		</span><span class="crayon-c"># local invariant descriptors from them</span></p><p class="crayon-line" id="crayon-56d5b2480fadc173681383-15"><span class="crayon-h">		</span><span class="crayon-sy">(</span><span class="crayon-v">imageB</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">imageA</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">images</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fadc173681383-16"><span class="crayon-h">		</span><span class="crayon-sy">(</span><span class="crayon-v">kpsA</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">featuresA</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">detectAndDescribe</span><span class="crayon-sy">(</span><span class="crayon-v">imageA</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2480fadc173681383-17"><span class="crayon-h">		</span><span class="crayon-sy">(</span><span class="crayon-v">kpsB</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">featuresB</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">detectAndDescribe</span><span class="crayon-sy">(</span><span class="crayon-v">imageB</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fadc173681383-18"> </p><p class="crayon-line" id="crayon-56d5b2480fadc173681383-19"><span class="crayon-h">		</span><span class="crayon-c"># match features between the two images</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fadc173681383-20"><span class="crayon-h">		</span><span class="crayon-v">M</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">matchKeypoints</span><span class="crayon-sy">(</span><span class="crayon-v">kpsA</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">kpsB</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d5b2480fadc173681383-21"><span class="crayon-h">			</span><span class="crayon-v">featuresA</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">featuresB</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ratio</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">reprojThresh</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fadc173681383-22"> </p><p class="crayon-line" id="crayon-56d5b2480fadc173681383-23"><span class="crayon-h">		</span><span class="crayon-c"># if the match is None, then there aren't enough matched</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fadc173681383-24"><span class="crayon-h">		</span><span class="crayon-c"># keypoints to create a panorama</span></p><p class="crayon-line" id="crayon-56d5b2480fadc173681383-25"><span class="crayon-h">		</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-i">M</span><span class="crayon-h"> </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-t">None</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fadc173681383-26"><span class="crayon-h">			</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">None</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>The 
			<span id="crayon-56d5b2480fae0302975046" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">stitch</span></span></span>  method requires only a single parameter, 
			<span id="crayon-56d5b2480fae4416104620" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">images</span></span></span> , which is the list of (two) images that we are going to stitch together to form the panorama.</p>
<p>We can also optionally supply 
			<span id="crayon-56d5b2480fae8947343971" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">ratio</span></span></span> , used for David Lowe’s ratio test when matching features (more on this ratio test later in the tutorial), 
			<span id="crayon-56d5b2480faeb929367185" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">reprojThresh</span></span></span>  which is the maximum pixel “wiggle room” allowed by the RANSAC algorithm, and finally 
			<span id="crayon-56d5b2480faef731456620" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">showMatches</span></span></span> , a boolean used to indicate if the keypoint matches should be visualized or not.</p>
<p><strong>Line 15</strong> unpacks the 
			<span id="crayon-56d5b2480faf2506918301" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">images</span></span></span>  list (which again, we presume to contain only two images). The ordering to the 
			<span id="crayon-56d5b2480faf6867892648" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">images</span></span></span>  list is important: <strong>we expect images to be supplied in <em>left-to-right</em> order.</strong> If images are <em>not</em> supplied in this order, then our code will still run — but our output panorama will only contain one image, not both.</p>
<p>Once we have unpacked the 
			<span id="crayon-56d5b2480fafa685676157" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">images</span></span></span>  list, we make a call to the 
			<span id="crayon-56d5b2480fafd959846153" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">detectAndDescribe</span></span></span>  method on <strong>Lines 16 and 17</strong>. This method simply detects keypoints and extracts local invariant descriptors (i.e., SIFT) from the two images.</p>
<p>Given the keypoints and features, we use 
			<span id="crayon-56d5b2480fb01511343042" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">matchKeypoints</span></span></span>  (<strong>Lines 20 and 21</strong>) to match the features in the two images. We’ll define this method later in the lesson.</p>
<p>If the returned matches 
			<span id="crayon-56d5b2480fb05801820751" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">M</span></span></span>  are 
			<span id="crayon-56d5b2480fb08341418616" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">None</span></span></span> , then not enough keypoints were matched to create a panorama, so we simply return to the calling function (<strong>Lines 25 and 26</strong>).</p>
<p>Otherwise, we are now ready to apply the perspective transform:</p>

		<div id="crayon-56d5b2480fb0c874879640" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb0c874879640-28">28</p><p class="crayon-num" data-line="crayon-56d5b2480fb0c874879640-29">29</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb0c874879640-30">30</p><p class="crayon-num" data-line="crayon-56d5b2480fb0c874879640-31">31</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb0c874879640-32">32</p><p class="crayon-num" data-line="crayon-56d5b2480fb0c874879640-33">33</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb0c874879640-34">34</p><p class="crayon-num" data-line="crayon-56d5b2480fb0c874879640-35">35</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb0c874879640-36">36</p><p class="crayon-num" data-line="crayon-56d5b2480fb0c874879640-37">37</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb0c874879640-38">38</p><p class="crayon-num" data-line="crayon-56d5b2480fb0c874879640-39">39</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb0c874879640-40">40</p><p class="crayon-num" data-line="crayon-56d5b2480fb0c874879640-41">41</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb0c874879640-42">42</p><p class="crayon-num" data-line="crayon-56d5b2480fb0c874879640-43">43</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb0c874879640-44">44</p><p class="crayon-num" data-line="crayon-56d5b2480fb0c874879640-45">45</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb0c874879640-28"><span class="crayon-h">		</span><span class="crayon-c"># otherwise, apply a perspective warp to stitch the images</span></p><p class="crayon-line" id="crayon-56d5b2480fb0c874879640-29"><span class="crayon-h">		</span><span class="crayon-c"># together</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb0c874879640-30"><span class="crayon-h">		</span><span class="crayon-sy">(</span><span class="crayon-v">matches</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">H</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">status</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-i">M</span></p><p class="crayon-line" id="crayon-56d5b2480fb0c874879640-31"><span class="crayon-h">		</span><span class="crayon-v">result</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">warpPerspective</span><span class="crayon-sy">(</span><span class="crayon-v">imageA</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">H</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb0c874879640-32"><span class="crayon-h">			</span><span class="crayon-sy">(</span><span class="crayon-v">imageA</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">imageB</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">imageA</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2480fb0c874879640-33"><span class="crayon-h">		</span><span class="crayon-v">result</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-v">imageB</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-v">imageB</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">imageB</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb0c874879640-34"> </p><p class="crayon-line" id="crayon-56d5b2480fb0c874879640-35"><span class="crayon-h">		</span><span class="crayon-c"># check to see if the keypoint matches should be visualized</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb0c874879640-36"><span class="crayon-h">		</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">showMatches</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2480fb0c874879640-37"><span class="crayon-h">			</span><span class="crayon-v">vis</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">drawMatches</span><span class="crayon-sy">(</span><span class="crayon-v">imageA</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">imageB</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">kpsA</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">kpsB</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">matches</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb0c874879640-38"><span class="crayon-h">				</span><span class="crayon-v">status</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2480fb0c874879640-39"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb0c874879640-40"><span class="crayon-h">			</span><span class="crayon-c"># return a tuple of the stitched image and the</span></p><p class="crayon-line" id="crayon-56d5b2480fb0c874879640-41"><span class="crayon-h">			</span><span class="crayon-c"># visualization</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb0c874879640-42"><span class="crayon-h">			</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">result</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">vis</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2480fb0c874879640-43"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb0c874879640-44"><span class="crayon-h">		</span><span class="crayon-c"># return the stitched image</span></p><p class="crayon-line" id="crayon-56d5b2480fb0c874879640-45"><span class="crayon-h">		</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">result</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>Provided that 
			<span id="crayon-56d5b2480fb11513311628" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">M</span></span></span>  is not 
			<span id="crayon-56d5b2480fb15575013037" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">None</span></span></span> , we unpack the tuple on <strong>Line 30</strong>, giving us a list of keypoint 
			<span id="crayon-56d5b2480fb18295055743" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">matches</span></span></span> , the homography matrix 
			<span id="crayon-56d5b2480fb1c159667962" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">H</span></span></span>  derived from the RANSAC algorithm, and finally 
			<span id="crayon-56d5b2480fb1f676403843" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">status</span></span></span> , a list of indexes to indicate which keypoints in 
			<span id="crayon-56d5b2480fb23959883543" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">matches</span></span></span>  were successfully spatially verified using RANSAC.</p>
<p>Given our homography matrix 
			<span id="crayon-56d5b2480fb27550617610" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">H</span></span></span> , we are now ready to stitch the two images together. First, we make a call to 
			<span id="crayon-56d5b2480fb2a849785594" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">warpPerspective</span></span></span>  which requires three arguments: the image we want to warp (in this case, the <em>right</em> image), the <em>3 x 3</em> transformation matrix (
			<span id="crayon-56d5b2480fb2e552938504" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">H</span></span></span> ), and finally the shape out of the output image. We derive the shape out of the output image by taking the sum of the widths of both images and then using the height of the second image.</p>
<p><strong>Line 30</strong> makes a check to see if we should visualize the keypoint matches, and if so, we make a call to 
			<span id="crayon-56d5b2480fb32386437511" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">drawMatches</span></span></span>  and return a tuple of both the panorama and visualization to the calling method (<strong>Lines 37-42</strong>).</p>
<p>Otherwise, we simply returned the stitched image (<strong>Line 45</strong>).</p>
<p>Now that the 
			<span id="crayon-56d5b2480fb35709470738" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">stitch</span></span></span>  method has been defined, let’s look into some of the helper methods that it calls. We’ll start with 
			<span id="crayon-56d5b2480fb39290148499" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">detectAndDescribe</span></span></span> :</p>

		<div id="crayon-56d5b2480fb3d341797861" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-56d5b2480fb3d341797861-47">47</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb3d341797861-48">48</p><p class="crayon-num" data-line="crayon-56d5b2480fb3d341797861-49">49</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb3d341797861-50">50</p><p class="crayon-num" data-line="crayon-56d5b2480fb3d341797861-51">51</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb3d341797861-52">52</p><p class="crayon-num" data-line="crayon-56d5b2480fb3d341797861-53">53</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb3d341797861-54">54</p><p class="crayon-num" data-line="crayon-56d5b2480fb3d341797861-55">55</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb3d341797861-56">56</p><p class="crayon-num" data-line="crayon-56d5b2480fb3d341797861-57">57</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb3d341797861-58">58</p><p class="crayon-num" data-line="crayon-56d5b2480fb3d341797861-59">59</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb3d341797861-60">60</p><p class="crayon-num" data-line="crayon-56d5b2480fb3d341797861-61">61</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb3d341797861-62">62</p><p class="crayon-num" data-line="crayon-56d5b2480fb3d341797861-63">63</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb3d341797861-64">64</p><p class="crayon-num" data-line="crayon-56d5b2480fb3d341797861-65">65</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb3d341797861-66">66</p><p class="crayon-num" data-line="crayon-56d5b2480fb3d341797861-67">67</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb3d341797861-68">68</p><p class="crayon-num" data-line="crayon-56d5b2480fb3d341797861-69">69</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb3d341797861-70">70</p><p class="crayon-num" data-line="crayon-56d5b2480fb3d341797861-71">71</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb3d341797861-72">72</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b2480fb3d341797861-47"><span class="crayon-e">	</span><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">detectAndDescribe</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb3d341797861-48"><span class="crayon-h">		</span><span class="crayon-c"># convert the image to grayscale</span></p><p class="crayon-line" id="crayon-56d5b2480fb3d341797861-49"><span class="crayon-h">		</span><span class="crayon-v">gray</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">cvtColor</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">COLOR_BGR2GRAY</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb3d341797861-50"> </p><p class="crayon-line" id="crayon-56d5b2480fb3d341797861-51"><span class="crayon-h">		</span><span class="crayon-c"># check to see if we are using OpenCV 3.X</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb3d341797861-52"><span class="crayon-h">		</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">isv3</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2480fb3d341797861-53"><span class="crayon-h">			</span><span class="crayon-c"># detect and extract features from the image</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb3d341797861-54"><span class="crayon-h">			</span><span class="crayon-v">descriptor</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">xfeatures2d</span><span class="crayon-sy">.</span><span class="crayon-e">SIFT_create</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2480fb3d341797861-55"><span class="crayon-h">			</span><span class="crayon-sy">(</span><span class="crayon-v">kps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">features</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">descriptor</span><span class="crayon-sy">.</span><span class="crayon-e">detectAndCompute</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">None</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb3d341797861-56"> </p><p class="crayon-line" id="crayon-56d5b2480fb3d341797861-57"><span class="crayon-h">		</span><span class="crayon-c"># otherwise, we are using OpenCV 2.4.X</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb3d341797861-58"><span class="crayon-h">		</span><span class="crayon-st">else</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2480fb3d341797861-59"><span class="crayon-h">			</span><span class="crayon-c"># detect keypoints in the image</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb3d341797861-60"><span class="crayon-h">			</span><span class="crayon-v">detector</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">FeatureDetector_create</span><span class="crayon-sy">(</span><span class="crayon-s">"SIFT"</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2480fb3d341797861-61"><span class="crayon-h">			</span><span class="crayon-v">kps</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">detector</span><span class="crayon-sy">.</span><span class="crayon-e">detect</span><span class="crayon-sy">(</span><span class="crayon-v">gray</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb3d341797861-62"> </p><p class="crayon-line" id="crayon-56d5b2480fb3d341797861-63"><span class="crayon-h">			</span><span class="crayon-c"># extract features from the image</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb3d341797861-64"><span class="crayon-h">			</span><span class="crayon-v">extractor</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">DescriptorExtractor_create</span><span class="crayon-sy">(</span><span class="crayon-s">"SIFT"</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2480fb3d341797861-65"><span class="crayon-h">			</span><span class="crayon-sy">(</span><span class="crayon-v">kps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">features</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">extractor</span><span class="crayon-sy">.</span><span class="crayon-e">compute</span><span class="crayon-sy">(</span><span class="crayon-v">gray</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">kps</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb3d341797861-66"> </p><p class="crayon-line" id="crayon-56d5b2480fb3d341797861-67"><span class="crayon-h">		</span><span class="crayon-c"># convert the keypoints from KeyPoint objects to NumPy</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb3d341797861-68"><span class="crayon-h">		</span><span class="crayon-c"># arrays</span></p><p class="crayon-line" id="crayon-56d5b2480fb3d341797861-69"><span class="crayon-h">		</span><span class="crayon-v">kps</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">np</span><span class="crayon-sy">.</span><span class="crayon-e">float32</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">kp</span><span class="crayon-sy">.</span><span class="crayon-e">pt </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">kp </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">kps</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb3d341797861-70"> </p><p class="crayon-line" id="crayon-56d5b2480fb3d341797861-71"><span class="crayon-h">		</span><span class="crayon-c"># return a tuple of keypoints and features</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb3d341797861-72"><span class="crayon-h">		</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">kps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">features</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>As the name suggests, the 
			<span id="crayon-56d5b2480fb42395137678" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">detectAndDescribe</span></span></span>  method accepts an image, then detects keypoints and extracts local invariant descriptors. In our implementation we use the <a href="http://www.cs.utexas.edu/~grauman/courses/fall2009/papers/local_features_synthesis_draft.pdf" target="_blank">Difference of Gaussian</a> (DoG) keypoint detector and the <a href="https://en.wikipedia.org/wiki/Scale-invariant_feature_transform" target="_blank">SIFT feature extractor</a>.</p>
<p>On <strong>Line 52</strong> we check to see if we are using OpenCV 3.X. If we are, then we use the 
			<span id="crayon-56d5b2480fb46682429219" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">xfeatures2d</span><span class="crayon-sy">.</span><span class="crayon-v">SIFT_create</span></span></span>  function to instantiate both our DoG keypoint detector and SIFT feature extractor. A call to 
			<span id="crayon-56d5b2480fb4b633260856" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">detectAndCompute</span></span></span>  handles extracting the keypoints and features (<strong>Lines 54 and 55</strong>).</p>
<p>It’s important to note that you <em><strong>must</strong></em> have compiled OpenCV 3.X with <a href="https://github.com/itseez/opencv_contrib" target="_blank">opencv_contrib</a> support enabled. If you did not, you’ll get an error such as 
			<span id="crayon-56d5b2480fb52513432444" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">AttributeError</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">'module'</span><span class="crayon-h"> </span><span class="crayon-t">object</span><span class="crayon-h"> </span><span class="crayon-e">has </span><span class="crayon-e">no </span><span class="crayon-i">attribute</span><span class="crayon-h"> </span><span class="crayon-s">'xfeatures2d'</span></span></span> . If that’s the case, head over to my <a href="http://www.pyimagesearch.com/opencv-tutorials-resources-guides/" target="_blank">OpenCV 3 tutorials page</a> where I detail how to install OpenCV 3 with 
			<span id="crayon-56d5b2480fb58108079024" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">opencv_contrib</span></span></span>  support enabled for a variety of operating systems and Python versions.</p>
<p><strong>Lines 58-65</strong> handle if we are using OpenCV 2.4. The 
			<span id="crayon-56d5b2480fb5c516724007" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">FeatureDetector_create</span></span></span>  function instantiates our keypoint detector (DoG). A call to 
			<span id="crayon-56d5b2480fb60889256039" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">detect</span></span></span>  returns our set of keypoints.</p>
<p>From there, we need to initialize 
			<span id="crayon-56d5b2480fb63378992811" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">DescriptorExtractor_create</span></span></span>  using the 
			<span id="crayon-56d5b2480fb66055473921" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">SIFT</span></span></span>  keyword to setup our SIFT feature 
			<span id="crayon-56d5b2480fb6a383750751" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">extractor</span></span></span> . Calling the 
			<span id="crayon-56d5b2480fb6e282896594" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">compute</span></span></span>  method of the 
			<span id="crayon-56d5b2480fb71185441532" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">extractor</span></span></span>  returns a set of feature vectors which quantify the region surrounding each of the detected keypoints in the image.</p>
<p>Finally, our keypoints are converted from 
			<span id="crayon-56d5b2480fb74346721326" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">KeyPoint</span></span></span>  objects to a NumPy array (<strong>Line 69</strong>) and returned to the calling method (<strong>Line 72</strong>).</p>
<p>Next up, let’s look at the 
			<span id="crayon-56d5b2480fb78773356247" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">matchKeypoints</span></span></span>  method:</p>

		<div id="crayon-56d5b2480fb7b464222266" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb7b464222266-74">74</p><p class="crayon-num" data-line="crayon-56d5b2480fb7b464222266-75">75</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb7b464222266-76">76</p><p class="crayon-num" data-line="crayon-56d5b2480fb7b464222266-77">77</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb7b464222266-78">78</p><p class="crayon-num" data-line="crayon-56d5b2480fb7b464222266-79">79</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb7b464222266-80">80</p><p class="crayon-num" data-line="crayon-56d5b2480fb7b464222266-81">81</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb7b464222266-82">82</p><p class="crayon-num" data-line="crayon-56d5b2480fb7b464222266-83">83</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb7b464222266-84">84</p><p class="crayon-num" data-line="crayon-56d5b2480fb7b464222266-85">85</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb7b464222266-86">86</p><p class="crayon-num" data-line="crayon-56d5b2480fb7b464222266-87">87</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb7b464222266-74"><span class="crayon-h">	</span><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">matchKeypoints</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">kpsA</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">kpsB</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">featuresA</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">featuresB</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d5b2480fb7b464222266-75"><span class="crayon-h">		</span><span class="crayon-v">ratio</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">reprojThresh</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb7b464222266-76"><span class="crayon-h">		</span><span class="crayon-c"># compute the raw matches and initialize the list of actual</span></p><p class="crayon-line" id="crayon-56d5b2480fb7b464222266-77"><span class="crayon-h">		</span><span class="crayon-c"># matches</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb7b464222266-78"><span class="crayon-h">		</span><span class="crayon-v">matcher</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">DescriptorMatcher_create</span><span class="crayon-sy">(</span><span class="crayon-s">"BruteForce"</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2480fb7b464222266-79"><span class="crayon-h">		</span><span class="crayon-v">rawMatches</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">matcher</span><span class="crayon-sy">.</span><span class="crayon-e">knnMatch</span><span class="crayon-sy">(</span><span class="crayon-v">featuresA</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">featuresB</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb7b464222266-80"><span class="crayon-h">		</span><span class="crayon-v">matches</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">]</span></p><p class="crayon-line" id="crayon-56d5b2480fb7b464222266-81"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb7b464222266-82"><span class="crayon-h">		</span><span class="crayon-c"># loop over the raw matches</span></p><p class="crayon-line" id="crayon-56d5b2480fb7b464222266-83"><span class="crayon-h">		</span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">m</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">rawMatches</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb7b464222266-84"><span class="crayon-h">			</span><span class="crayon-c"># ensure the distance is within a certain ratio of each</span></p><p class="crayon-line" id="crayon-56d5b2480fb7b464222266-85"><span class="crayon-h">			</span><span class="crayon-c"># other (i.e. Lowe's ratio test)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb7b464222266-86"><span class="crayon-h">			</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-k ">len</span><span class="crayon-sy">(</span><span class="crayon-v">m</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-h"> </span><span class="crayon-st">and</span><span class="crayon-h"> </span><span class="crayon-v">m</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">distance</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-v">m</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">distance</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">ratio</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2480fb7b464222266-87"><span class="crayon-h">				</span><span class="crayon-v">matches</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">m</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">trainIdx</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">m</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">queryIdx</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>The 
			<span id="crayon-56d5b2480fb81289461718" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">matchKeypoints</span></span></span>  function requires four arguments: the keypoints and feature vectors associated with the first image, followed by the keypoints and feature vectors associated with the second image. David Lowe’s 
			<span id="crayon-56d5b2480fb85159371378" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">ratio</span></span></span>  test variable and RANSAC re-projection threshold are also be supplied.</p>
<p>Matching features together is actually a fairly straightforward process. We simply loop over the descriptors from both images, compute the distances, and find the smallest distance for each pair of descriptors. Since this is a very common practice in computer vision, OpenCV has a built-in function called 
			<span id="crayon-56d5b2480fb89533518272" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">DescriptorMatcher_create</span></span></span>  that constructs the feature matcher for us. The 
			<span id="crayon-56d5b2480fb8c436012239" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">BruteForce</span></span></span>  value indicates that we are going to <em>exhaustively</em> compute the Euclidean distance between <em>all feature vectors</em> from both images and find the pairs of descriptors that have the smallest distance.</p>
<p>A call to 
			<span id="crayon-56d5b2480fb90371244025" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">knnMatch</span></span></span>  on <strong>Line 79</strong> performs <a href="https://en.wikipedia.org/wiki/K-nearest_neighbors_algorithm" target="_blank">k-NN matching</a> between the two feature vector sets using <em>k=2 </em>(indicating the top two matches for each feature vector are returned).</p>
<p>The reason we want the top <em>two</em> matches rather than just the top one match is because we need to apply David Lowe’s ratio test for false-positive match pruning.</p>
<p>Again, <strong>Line 79</strong> computes the 
			<span id="crayon-56d5b2480fb94032354915" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">rawMatches</span></span></span>  for each pair of descriptors — but there is a chance that some of these pairs are false positives, meaning that the image patches are not actually true matches. In an attempt to prune these false-positive matches, we can loop over each of the 
			<span id="crayon-56d5b2480fb97057943423" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">rawMatches</span></span></span>  individually (<strong>Line 83</strong>) and apply Lowe’s ratio test, which is used to determine high-quality feature matches. Typical values for Lowe’s ratio are normally in the range <em>[0.7, 0.8]</em>.</p>
<p>Once we have obtained the 
			<span id="crayon-56d5b2480fb9b894695445" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">matches</span></span></span>  using Lowe’s ratio test, we can compute the homography between the two sets of keypoints:</p>

		<div id="crayon-56d5b2480fb9f184542257" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-56d5b2480fb9f184542257-89">89</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb9f184542257-90">90</p><p class="crayon-num" data-line="crayon-56d5b2480fb9f184542257-91">91</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb9f184542257-92">92</p><p class="crayon-num" data-line="crayon-56d5b2480fb9f184542257-93">93</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb9f184542257-94">94</p><p class="crayon-num" data-line="crayon-56d5b2480fb9f184542257-95">95</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb9f184542257-96">96</p><p class="crayon-num" data-line="crayon-56d5b2480fb9f184542257-97">97</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb9f184542257-98">98</p><p class="crayon-num" data-line="crayon-56d5b2480fb9f184542257-99">99</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb9f184542257-100">100</p><p class="crayon-num" data-line="crayon-56d5b2480fb9f184542257-101">101</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb9f184542257-102">102</p><p class="crayon-num" data-line="crayon-56d5b2480fb9f184542257-103">103</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fb9f184542257-104">104</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b2480fb9f184542257-89"><span class="crayon-h">		</span><span class="crayon-c"># computing a homography requires at least 4 matches</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb9f184542257-90"><span class="crayon-h">		</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-k ">len</span><span class="crayon-sy">(</span><span class="crayon-v">matches</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-cn">4</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2480fb9f184542257-91"><span class="crayon-h">			</span><span class="crayon-c"># construct the two sets of points</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb9f184542257-92"><span class="crayon-h">			</span><span class="crayon-v">ptsA</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">np</span><span class="crayon-sy">.</span><span class="crayon-e">float32</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">kpsA</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">_</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">matches</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2480fb9f184542257-93"><span class="crayon-h">			</span><span class="crayon-v">ptsB</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">np</span><span class="crayon-sy">.</span><span class="crayon-e">float32</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">kpsB</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">i</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">_</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">matches</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb9f184542257-94"> </p><p class="crayon-line" id="crayon-56d5b2480fb9f184542257-95"><span class="crayon-h">			</span><span class="crayon-c"># compute the homography between the two sets of points</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb9f184542257-96"><span class="crayon-h">			</span><span class="crayon-sy">(</span><span class="crayon-v">H</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">status</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">findHomography</span><span class="crayon-sy">(</span><span class="crayon-v">ptsA</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ptsB</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">RANSAC</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d5b2480fb9f184542257-97"><span class="crayon-h">				</span><span class="crayon-v">reprojThresh</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb9f184542257-98"> </p><p class="crayon-line" id="crayon-56d5b2480fb9f184542257-99"><span class="crayon-h">			</span><span class="crayon-c"># return the matches along with the homograpy matrix</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb9f184542257-100"><span class="crayon-h">			</span><span class="crayon-c"># and status of each matched point</span></p><p class="crayon-line" id="crayon-56d5b2480fb9f184542257-101"><span class="crayon-h">			</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">matches</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">H</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">status</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb9f184542257-102"> </p><p class="crayon-line" id="crayon-56d5b2480fb9f184542257-103"><span class="crayon-h">		</span><span class="crayon-c"># otherwise, no homograpy could be computed</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fb9f184542257-104"><span class="crayon-h">		</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">None</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>Computing a homography between two sets of points requires <em>at a bare minimum</em> an initial set of four matches. For a more reliable homography estimation, we should have substantially more than just four matched points.</p>
<p>Finally, the last method in our 
			<span id="crayon-56d5b2480fba6785715322" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">Stitcher</span></span></span>  method, 
			<span id="crayon-56d5b2480fba9958729202" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">drawMatches</span></span></span>  is used to visualize keypoint correspondences between two images:</p>

		<div id="crayon-56d5b2480fbad647746193" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fbad647746193-106">106</p><p class="crayon-num" data-line="crayon-56d5b2480fbad647746193-107">107</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fbad647746193-108">108</p><p class="crayon-num" data-line="crayon-56d5b2480fbad647746193-109">109</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fbad647746193-110">110</p><p class="crayon-num" data-line="crayon-56d5b2480fbad647746193-111">111</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fbad647746193-112">112</p><p class="crayon-num" data-line="crayon-56d5b2480fbad647746193-113">113</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fbad647746193-114">114</p><p class="crayon-num" data-line="crayon-56d5b2480fbad647746193-115">115</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fbad647746193-116">116</p><p class="crayon-num" data-line="crayon-56d5b2480fbad647746193-117">117</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fbad647746193-118">118</p><p class="crayon-num" data-line="crayon-56d5b2480fbad647746193-119">119</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fbad647746193-120">120</p><p class="crayon-num" data-line="crayon-56d5b2480fbad647746193-121">121</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fbad647746193-122">122</p><p class="crayon-num" data-line="crayon-56d5b2480fbad647746193-123">123</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fbad647746193-124">124</p><p class="crayon-num" data-line="crayon-56d5b2480fbad647746193-125">125</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fbad647746193-106"><span class="crayon-h">	</span><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">drawMatches</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">imageA</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">imageB</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">kpsA</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">kpsB</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">matches</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">status</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2480fbad647746193-107"><span class="crayon-h">		</span><span class="crayon-c"># initialize the output visualization image</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fbad647746193-108"><span class="crayon-h">		</span><span class="crayon-sy">(</span><span class="crayon-v">hA</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">wA</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">imageA</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span></p><p class="crayon-line" id="crayon-56d5b2480fbad647746193-109"><span class="crayon-h">		</span><span class="crayon-sy">(</span><span class="crayon-v">hB</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">wB</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">imageB</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fbad647746193-110"><span class="crayon-h">		</span><span class="crayon-v">vis</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">np</span><span class="crayon-sy">.</span><span class="crayon-e">zeros</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-k ">max</span><span class="crayon-sy">(</span><span class="crayon-v">hA</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">hB</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">wA</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">wB</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">3</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dtype</span><span class="crayon-o">=</span><span class="crayon-s">"uint8"</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2480fbad647746193-111"><span class="crayon-h">		</span><span class="crayon-v">vis</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-v">hA</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-v">wA</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">imageA</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fbad647746193-112"><span class="crayon-e">		</span><span class="crayon-v">vis</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-v">hB</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">wA</span><span class="crayon-o">:</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">imageB</span></p><p class="crayon-line" id="crayon-56d5b2480fbad647746193-113"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fbad647746193-114"><span class="crayon-h">		</span><span class="crayon-c"># loop over the matches</span></p><p class="crayon-line" id="crayon-56d5b2480fbad647746193-115"><span class="crayon-h">		</span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">trainIdx</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">queryIdx</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">s</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-k ">zip</span><span class="crayon-sy">(</span><span class="crayon-v">matches</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">status</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fbad647746193-116"><span class="crayon-h">			</span><span class="crayon-c"># only process the match if the keypoint was successfully</span></p><p class="crayon-line" id="crayon-56d5b2480fbad647746193-117"><span class="crayon-h">			</span><span class="crayon-c"># matched</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fbad647746193-118"><span class="crayon-h">			</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">s</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2480fbad647746193-119"><span class="crayon-h">				</span><span class="crayon-c"># draw the match</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fbad647746193-120"><span class="crayon-h">				</span><span class="crayon-v">ptA</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-k ">int</span><span class="crayon-sy">(</span><span class="crayon-v">kpsA</span><span class="crayon-sy">[</span><span class="crayon-v">queryIdx</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-k ">int</span><span class="crayon-sy">(</span><span class="crayon-v">kpsA</span><span class="crayon-sy">[</span><span class="crayon-v">queryIdx</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2480fbad647746193-121"><span class="crayon-h">				</span><span class="crayon-v">ptB</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-k ">int</span><span class="crayon-sy">(</span><span class="crayon-v">kpsB</span><span class="crayon-sy">[</span><span class="crayon-v">trainIdx</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">wA</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-k ">int</span><span class="crayon-sy">(</span><span class="crayon-v">kpsB</span><span class="crayon-sy">[</span><span class="crayon-v">trainIdx</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fbad647746193-122"><span class="crayon-h">				</span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">line</span><span class="crayon-sy">(</span><span class="crayon-v">vis</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ptA</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ptB</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">255</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2480fbad647746193-123"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fbad647746193-124"><span class="crayon-h">		</span><span class="crayon-c"># return the visualization</span></p><p class="crayon-line" id="crayon-56d5b2480fbad647746193-125"><span class="crayon-h">		</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">vis</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>This method requires that we pass in the two original images, the set of keypoints associated with each image, the initial matches after applying Lowe’s ratio test, and finally the 
			<span id="crayon-56d5b2480fbb5000587629" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">status</span></span></span>  list provided by the homography calculation. Using these variables, we can visualize the “inlier” keypoints by drawing a straight line from keypoint <em>N</em> in the first image to keypoint <em>M</em> in the second image.</p>
<p>Now that we have our 
			<span id="crayon-56d5b2480fbb9656672423" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">Stitcher</span></span></span>  class defined, let’s move on to creating the 
			<span id="crayon-56d5b2480fbbc426383402" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">stitch</span><span class="crayon-sy">.</span><span class="crayon-v">py</span></span></span>  driver script:</p>

		<div id="crayon-56d5b2480fbc0461021252" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b2480fbc0461021252-1"><span class="crayon-c"># import the necessary packages</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fbc0461021252-2"><span class="crayon-st">from</span><span class="crayon-h"> </span><span class="crayon-v">pyimagesearch</span><span class="crayon-sy">.</span><span class="crayon-e">panorama </span><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">Stitcher</span></p><p class="crayon-line" id="crayon-56d5b2480fbc0461021252-3"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-k ">argparse</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fbc0461021252-4"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">imutils</span></p><p class="crayon-line" id="crayon-56d5b2480fbc0461021252-5"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fbc0461021252-6"> </p><p class="crayon-line" id="crayon-56d5b2480fbc0461021252-7"><span class="crayon-c"># construct the argument parse and parse the arguments</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fbc0461021252-8"><span class="crayon-v">ap</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">argparse</span><span class="crayon-sy">.</span><span class="crayon-e">ArgumentParser</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2480fbc0461021252-9"><span class="crayon-v">ap</span><span class="crayon-sy">.</span><span class="crayon-e">add_argument</span><span class="crayon-sy">(</span><span class="crayon-s">"-f"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"--first"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">required</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fbc0461021252-10"><span class="crayon-h">	</span><span class="crayon-k ">help</span><span class="crayon-o">=</span><span class="crayon-s">"path to the first image"</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2480fbc0461021252-11"><span class="crayon-v">ap</span><span class="crayon-sy">.</span><span class="crayon-e">add_argument</span><span class="crayon-sy">(</span><span class="crayon-s">"-s"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"--second"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">required</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fbc0461021252-12"><span class="crayon-h">	</span><span class="crayon-k ">help</span><span class="crayon-o">=</span><span class="crayon-s">"path to the second image"</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2480fbc0461021252-13"><span class="crayon-v">args</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">vars</span><span class="crayon-sy">(</span><span class="crayon-v">ap</span><span class="crayon-sy">.</span><span class="crayon-e">parse_args</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>We start off by importing our required packages on <strong>Lines 2-5</strong>. Notice how we’ve placed the 
			<span id="crayon-56d5b2480fbc4163997155" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">panorama</span><span class="crayon-sy">.</span><span class="crayon-v">py</span></span></span>  and 
			<span id="crayon-56d5b2480fbc7145398691" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">Stitcher</span></span></span>  class into the 
			<span id="crayon-56d5b2480fbca664821827" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">pyimagesearch</span></span></span>  module just to keep our code tidy.</p>
<p><em><strong>Note: </strong>If you are following along with this post and having trouble organizing your code, please be sure to download the source code using the form at the bottom of this post. The .zip of the code download will run out of the box without any errors.</em></p>
<p>From there, <strong>Lines 8-14 </strong>parse our command line arguments: 
			<span id="crayon-56d5b2480fbce763481313" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-o">--</span><span class="crayon-v">first</span></span></span> , which is the path to the first image in our panorama (the <em>left-most</em> image), and 
			<span id="crayon-56d5b2480fbd1847452261" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-o">--</span><span class="crayon-v">second</span></span></span> , the path to the second image in the panorama (the <em>right-most</em> image).</p>
<p><strong>Remember, these image paths need to be suppled in <em>left-to-right</em> order!</strong></p>
<p>The rest of the 
			<span id="crayon-56d5b2480fbd5050958052" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">stitch</span><span class="crayon-sy">.</span><span class="crayon-v">py</span></span></span>  driver script simply handles loading our images, resizing them (so they can fit on our screen), and constructing our panorama:</p>

		<div id="crayon-56d5b2480fbd9485302775" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-56d5b2480fbd9485302775-15">15</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fbd9485302775-16">16</p><p class="crayon-num" data-line="crayon-56d5b2480fbd9485302775-17">17</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fbd9485302775-18">18</p><p class="crayon-num" data-line="crayon-56d5b2480fbd9485302775-19">19</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fbd9485302775-20">20</p><p class="crayon-num" data-line="crayon-56d5b2480fbd9485302775-21">21</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fbd9485302775-22">22</p><p class="crayon-num" data-line="crayon-56d5b2480fbd9485302775-23">23</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fbd9485302775-24">24</p><p class="crayon-num" data-line="crayon-56d5b2480fbd9485302775-25">25</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fbd9485302775-26">26</p><p class="crayon-num" data-line="crayon-56d5b2480fbd9485302775-27">27</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fbd9485302775-28">28</p><p class="crayon-num" data-line="crayon-56d5b2480fbd9485302775-29">29</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b2480fbd9485302775-30">30</p><p class="crayon-num" data-line="crayon-56d5b2480fbd9485302775-31">31</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b2480fbd9485302775-15"><span class="crayon-c"># load the two images and resize them to have a width of 400 pixels</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fbd9485302775-16"><span class="crayon-c"># (for faster processing)</span></p><p class="crayon-line" id="crayon-56d5b2480fbd9485302775-17"><span class="crayon-v">imageA</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">imread</span><span class="crayon-sy">(</span><span class="crayon-v">args</span><span class="crayon-sy">[</span><span class="crayon-s">"first"</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fbd9485302775-18"><span class="crayon-v">imageB</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">imread</span><span class="crayon-sy">(</span><span class="crayon-v">args</span><span class="crayon-sy">[</span><span class="crayon-s">"second"</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2480fbd9485302775-19"><span class="crayon-v">imageA</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">imutils</span><span class="crayon-sy">.</span><span class="crayon-e">resize</span><span class="crayon-sy">(</span><span class="crayon-v">imageA</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">width</span><span class="crayon-o">=</span><span class="crayon-cn">400</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fbd9485302775-20"><span class="crayon-v">imageB</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">imutils</span><span class="crayon-sy">.</span><span class="crayon-e">resize</span><span class="crayon-sy">(</span><span class="crayon-v">imageB</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">width</span><span class="crayon-o">=</span><span class="crayon-cn">400</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2480fbd9485302775-21"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fbd9485302775-22"><span class="crayon-c"># stitch the images together to create a panorama</span></p><p class="crayon-line" id="crayon-56d5b2480fbd9485302775-23"><span class="crayon-v">stitcher</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Stitcher</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fbd9485302775-24"><span class="crayon-sy">(</span><span class="crayon-v">result</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">vis</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">stitcher</span><span class="crayon-sy">.</span><span class="crayon-e">stitch</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">imageA</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">imageB</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">showMatches</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2480fbd9485302775-25"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fbd9485302775-26"><span class="crayon-c"># show the images</span></p><p class="crayon-line" id="crayon-56d5b2480fbd9485302775-27"><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">imshow</span><span class="crayon-sy">(</span><span class="crayon-s">"Image A"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">imageA</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fbd9485302775-28"><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">imshow</span><span class="crayon-sy">(</span><span class="crayon-s">"Image B"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">imageB</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2480fbd9485302775-29"><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">imshow</span><span class="crayon-sy">(</span><span class="crayon-s">"Keypoint Matches"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">vis</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fbd9485302775-30"><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">imshow</span><span class="crayon-sy">(</span><span class="crayon-s">"Result"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">result</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2480fbd9485302775-31"><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">waitKey</span><span class="crayon-sy">(</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>Once our images are loaded and resized, we initialize our 
			<span id="crayon-56d5b2480fbdd737451021" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">Stitcher</span></span></span>  class on <b>Line 23</b>. We then call the 
			<span id="crayon-56d5b2480fbe0307219623" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">stitch</span></span></span>  method, passing in our two images (<strong>again, in left-to-right order)</strong> and indicate that we would like to visualize the keypoint matches between the two images.</p>
<p>Finally, <strong>Lines 27-31</strong> display our output images to our screen.</p>
<h2>Panorama stitching results</h2>
<p>In mid-2014 I took a trip out to Arizona and Utah to enjoy the national parks. Along the way I stopped at many locations, including Bryce Canyon, Grand Canyon, and Sedona. Given that these areas contain beautiful scenic views, I naturally took a bunch of photos — some of which are perfect for constructing panoramas. I’ve included a sample of these images in today’s blog to demonstrate panorama stitching.</p>
<p>All that said, let’s give our OpenCV panorama stitcher a try. Open up a terminal and issue the following command:</p>

		<div id="crayon-56d5b2480fbe4246667889" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b2480fbe4246667889-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">python </span><span class="crayon-v">stitch</span><span class="crayon-e">.py</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">first </span><span class="crayon-v">images</span><span class="crayon-o">/</span><span class="crayon-v">bryce_left_01</span><span class="crayon-e">.png</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fbe4246667889-2"><span class="crayon-h">	</span><span class="crayon-o">--</span><span class="crayon-e">second </span><span class="crayon-v">images</span><span class="crayon-o">/</span><span class="crayon-v">bryce_right_01</span><span class="crayon-e">.png</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p/><div id="attachment_3554" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2016/01/bryce_match_01.jpg"><img class="wp-image-3554" src="http://www.pyimagesearch.com/wp-content/uploads/2016/01/bryce_match_01.jpg" alt="Figure 1: (Top) The two input images from Bryce canyon (in left-to-right order). (Bottom) The matched keypoint correspondences between the two images." srcset="http://www.pyimagesearch.com/wp-content/uploads/2016/01/bryce_match_01-300x239.jpg 300w, http://www.pyimagesearch.com/wp-content/uploads/2016/01/bryce_match_01-1024x814.jpg 1024w, http://www.pyimagesearch.com/wp-content/uploads/2016/01/bryce_match_01.jpg 1250w" sizes="(max-width: 600px) 100vw, 600px"/></a><p class="wp-caption-text"><strong>Figure 1:</strong> <em>(Top)</em> The two input images from Bryce canyon (in left-to-right order). <em>(Bottom)</em> The matched keypoint correspondences between the two images.</p></div>
<p>At the <em>top</em> of this figure, we can see two input images (resized to fit on my screen, the raw .jpg files are a much higher resolution). And on the <em>bottom</em>, we can see the matched keypoints between the two images.</p>
<p>Using these matched keypoints, we can apply a perspective transform and obtain the final panorama:</p>
<div id="attachment_3555" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2016/01/bryce_result_01.jpg"><img class="wp-image-3555" src="http://www.pyimagesearch.com/wp-content/uploads/2016/01/bryce_result_01.jpg" alt="Figure 2: Constructing a panorama from our two input images." srcset="http://www.pyimagesearch.com/wp-content/uploads/2016/01/bryce_result_01-300x234.jpg 300w, http://www.pyimagesearch.com/wp-content/uploads/2016/01/bryce_result_01-1024x800.jpg 1024w, http://www.pyimagesearch.com/wp-content/uploads/2016/01/bryce_result_01.jpg 1250w" sizes="(max-width: 600px) 100vw, 600px"/></a><p class="wp-caption-text"><strong>Figure 2:</strong> Constructing a panorama from our two input images.</p></div>
<p>As we can see, the two images have been successfully stitched together!</p>
<p><b><i>Note: </i></b><i>On many of these example images, you’ll often see a visible “seam” running through the center of the stitched images. This is because I shot many of photos using either my iPhone or a digital camera with autofocus turned </i>on<em>, thus the focus is slightly different between each shot</em><i>. Image stitching and panorama construction work best when you use the same focus for every photo. I never intended to use these vacation photos for image stitching, otherwise I would have taken care to adjust the camera sensors. In either case, just keep in mind the seam is due to varying sensor properties at the time I took the photo and was not intentional.</i></p>
<p>Let’s give another set of images a try:</p>

		<div id="crayon-56d5b2480fbe9276867764" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b2480fbe9276867764-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">python </span><span class="crayon-v">stitch</span><span class="crayon-e">.py</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">first </span><span class="crayon-v">images</span><span class="crayon-o">/</span><span class="crayon-v">bryce_left_02</span><span class="crayon-e">.png</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fbe9276867764-2"><span class="crayon-h">	</span><span class="crayon-o">--</span><span class="crayon-e">second </span><span class="crayon-v">images</span><span class="crayon-o">/</span><span class="crayon-v">bryce_right_02</span><span class="crayon-e">.png</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p/><div id="attachment_3553" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2016/01/bryce_result_02.jpg"><img class="wp-image-3553" src="http://www.pyimagesearch.com/wp-content/uploads/2016/01/bryce_result_02.jpg" alt="Figure 3: Another successful application of image stitching with OpenCV." srcset="http://www.pyimagesearch.com/wp-content/uploads/2016/01/bryce_result_02-300x238.jpg 300w, http://www.pyimagesearch.com/wp-content/uploads/2016/01/bryce_result_02-1024x811.jpg 1024w, http://www.pyimagesearch.com/wp-content/uploads/2016/01/bryce_result_02.jpg 1250w" sizes="(max-width: 600px) 100vw, 600px"/></a><p class="wp-caption-text"><strong>Figure 3:</strong> Another successful application of image stitching with OpenCV.</p></div>
<p>Again, our 
			<span id="crayon-56d5b2480fbee065071966" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">Stitcher</span></span></span>  class was able to construct a panorama from the two input images.</p>
<p>Now, let’s move on to the Grand Canyon:</p>

		<div id="crayon-56d5b2480fbf1261052635" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b2480fbf1261052635-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">python </span><span class="crayon-v">stitch</span><span class="crayon-e">.py</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">first </span><span class="crayon-v">images</span><span class="crayon-o">/</span><span class="crayon-v">grand_canyon_left_01</span><span class="crayon-e">.png</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fbf1261052635-2"><span class="crayon-h">	</span><span class="crayon-o">--</span><span class="crayon-e">second </span><span class="crayon-v">images</span><span class="crayon-o">/</span><span class="crayon-v">grand_canyon_right_01</span><span class="crayon-e">.png</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p/><div id="attachment_3556" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2016/01/grand_canyon_result_01.jpg"><img class="wp-image-3556" src="http://www.pyimagesearch.com/wp-content/uploads/2016/01/grand_canyon_result_01.jpg" alt="Figure 4: Applying image stitching and panorama construction using OpenCV." srcset="http://www.pyimagesearch.com/wp-content/uploads/2016/01/grand_canyon_result_01-300x239.jpg 300w, http://www.pyimagesearch.com/wp-content/uploads/2016/01/grand_canyon_result_01-1024x816.jpg 1024w, http://www.pyimagesearch.com/wp-content/uploads/2016/01/grand_canyon_result_01.jpg 1250w" sizes="(max-width: 600px) 100vw, 600px"/></a><p class="wp-caption-text"><strong>Figure 4:</strong> Applying image stitching and panorama construction using OpenCV.</p></div>
<p>In the above input images we can see heavy overlap between the two input images. The main addition to the panorama is towards the <em>right side</em> of the stitched images where we can see more of the “ledge” is added to the output.</p>
<p>Here’s another example from the Grand Canyon:</p>

		<div id="crayon-56d5b2480fbf5802959642" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b2480fbf5802959642-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">python </span><span class="crayon-v">stitch</span><span class="crayon-e">.py</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">first </span><span class="crayon-v">images</span><span class="crayon-o">/</span><span class="crayon-v">grand_canyon_left_02</span><span class="crayon-e">.png</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fbf5802959642-2"><span class="crayon-h">	</span><span class="crayon-o">--</span><span class="crayon-e">second </span><span class="crayon-v">images</span><span class="crayon-o">/</span><span class="crayon-v">grand_canyon_right_02</span><span class="crayon-e">.png</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p/><div id="attachment_3557" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2016/01/grand_canyon_result_02.jpg"><img class="wp-image-3557" src="http://www.pyimagesearch.com/wp-content/uploads/2016/01/grand_canyon_result_02.jpg" alt="Figure 5: Using image stitching to build a panorama using OpenCV and Python." srcset="http://www.pyimagesearch.com/wp-content/uploads/2016/01/grand_canyon_result_02-300x242.jpg 300w, http://www.pyimagesearch.com/wp-content/uploads/2016/01/grand_canyon_result_02-1024x825.jpg 1024w, http://www.pyimagesearch.com/wp-content/uploads/2016/01/grand_canyon_result_02.jpg 1250w" sizes="(max-width: 600px) 100vw, 600px"/></a><p class="wp-caption-text"><strong>Figure 5:</strong> Using image stitching to build a panorama using OpenCV and Python.</p></div>
<p>From this example, we can see that more of the <em>huge</em> expanse of the Grand Canyon has been added to the panorama.</p>
<p>Finally, let’s wrap up this blog post with an example image stitching from Sedona, AZ:</p>

		<div id="crayon-56d5b2480fbf9075833564" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b2480fbf9075833564-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">python </span><span class="crayon-v">stitch</span><span class="crayon-e">.py</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">first </span><span class="crayon-v">images</span><span class="crayon-o">/</span><span class="crayon-v">sedona_left_01</span><span class="crayon-e">.png</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2480fbf9075833564-2"><span class="crayon-h">	</span><span class="crayon-o">--</span><span class="crayon-e">second </span><span class="crayon-v">images</span><span class="crayon-o">/</span><span class="crayon-v">sedona_right_01</span><span class="crayon-e">.png</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p/><div id="attachment_3558" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2016/01/sedona_result_01.jpg"><img class="wp-image-3558" src="http://www.pyimagesearch.com/wp-content/uploads/2016/01/sedona_result_01.jpg" alt="Figure 6: One final example of applying image stitching." srcset="http://www.pyimagesearch.com/wp-content/uploads/2016/01/sedona_result_01-300x248.jpg 300w, http://www.pyimagesearch.com/wp-content/uploads/2016/01/sedona_result_01-1024x846.jpg 1024w, http://www.pyimagesearch.com/wp-content/uploads/2016/01/sedona_result_01.jpg 1250w" sizes="(max-width: 600px) 100vw, 600px"/></a><p class="wp-caption-text"><strong>Figure 6:</strong> One final example of applying image stitching.</p></div>
<p>Personally, I find the red rock country of Sedona to be one of the most beautiful areas I’ve ever visited. If you ever have a chance, definitely stop by — you won’t be disappointed.</p>
<p>So there you have it, image stitching and panorama construction using Python and OpenCV!</p>
<h2>Summary</h2>
<p>In this blog post we learned how to perform image stitching and panorama construction using OpenCV. Source code was provided for image stitching for <em>both</em> OpenCV 2.4 and OpenCV 3.</p>
<p>Our image stitching algorithm requires four steps: (1) detecting keypoints and extracting local invariant descriptors; (2) matching descriptors between images; (3) applying RANSAC to estimate the homography matrix; and (4) applying a warping transformation using the homography matrix.</p>
<p>While simple, this algorithm works well in practice when constructing panoramas for two images. In a future blog post, we’ll review how to construct panoramas and perform image stitching <em>for more than two images</em>.</p>
<p>Anyway, I hope you enjoyed this post!<b> Be sure to use the form below to download the source code and give it a try.</b></p>
<h2 id="post_downloads">Downloads:</h2>

	</section>
	</div></body></html>