<html><body><div><article class="markdown-body entry-content" itemprop="text"><h1><a id="user-content-laboratory-" class="anchor" href="#laboratory-" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Laboratory! <a href="https://travis-ci.org/joealcorn/laboratory"><img alt="Build Status" src="https://camo.githubusercontent.com/5ca914332053f4389471922e182a54b8236fa786/68747470733a2f2f7472617669732d63692e6f72672f6a6f65616c636f726e2f6c61626f7261746f72792e7376673f6272616e63683d6d6173746572" data-canonical-src="https://travis-ci.org/joealcorn/laboratory.svg?branch=master"/></a></h1>
<p>A Python library for carefully refactoring critical paths (and a port of
<a href="https://github.com/github/scientist">GitHub's Scientist</a>).</p>
<a name="user-content-why"/>
<h2><a id="user-content-why" class="anchor" href="#why" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Why?</h2>
<p>See GitHub's blog post — <a href="http://githubengineering.com/scientist/">http://githubengineering.com/scientist/</a></p>
<a name="user-content-but-how"/>
<h2><a id="user-content-but-how" class="anchor" href="#but-how" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>But how?</h2>
<p>Imagine you've implemented a complex caching strategy for some objects in your
database and a stale cache is simply not acceptable.  How could you test this
and ensure parity with your previous implementation, under load, with
production data?  Run it in production!</p>
<p>Laboratory will:</p>
<ul>
<li>Run both the new and the old code</li>
<li>Compare their results</li>
<li>Record timing information about all code</li>
<li>Swallow and record exceptions in the new code</li>
<li>Publish all of this information</li>
</ul>
<p>Of course, you're still unsure your candidate code works correctly, so
laboratory will always return the result from the control block.</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">import</span> laboratory

experiment <span class="pl-k">=</span> laboratory.Experiment()
<span class="pl-k">with</span> experiment.control() <span class="pl-k">as</span> c:
    c.record(get_objects_from_database())

<span class="pl-k">with</span> experiment.candidate() <span class="pl-k">as</span> c:
    c.record(get_objects_from_cache())

objects <span class="pl-k">=</span> experiment.run()</pre></div>
<p>Note that the <code>Experiment</code> class can also be used as a decorator.</p>
<div class="highlight highlight-source-python"><pre><span class="pl-en">@Experiment</span>(<span class="pl-v">candidate</span><span class="pl-k">=</span>get_objects_from_cache)
<span class="pl-k">def</span> <span class="pl-en">get_objects_from_database</span>():
    <span class="pl-k">return</span> <span class="pl-c1">True</span></pre></div>
<a name="user-content-publishing-results"/>
<h2><a id="user-content-publishing-results" class="anchor" href="#publishing-results" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Publishing results</h2>
<p>This data is useless unless we can do something with it. Laboratory makes no
assumptions about how to do this — it's entirely for you to implement to suit
your needs.  For example, timing data can be sent to graphite, and mismatches
can be placed in a capped collection in redis for debugging later.</p>
<p>The publish method is passed a <code>Result</code> instance, with control and candidate
data is available in <code>Result.control</code> and <code>Result.observations</code>
respectively.</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">class</span> <span class="pl-en">MyExperiment</span>(<span class="pl-e">laboratory</span>.<span class="pl-e">Experiment</span>):
    <span class="pl-k">def</span> <span class="pl-en">publish</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>, <span class="pl-smi">result</span>):
        statsd.timing(<span class="pl-s"><span class="pl-pds">'</span>MyExperiment.control<span class="pl-pds">'</span></span>, result.control.duration)
        <span class="pl-k">for</span> o <span class="pl-k">in</span> result.observations:
            statsd.timing(<span class="pl-s"><span class="pl-pds">'</span>MyExperiment.<span class="pl-c1">%s</span><span class="pl-pds">'</span></span> <span class="pl-k">%</span> o.name, o.duration)</pre></div>
<a name="user-content-controlling-comparison"/>
<h2><a id="user-content-controlling-comparison" class="anchor" href="#controlling-comparison" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Controlling comparison</h2>
<p>Not all data is created equal. By default laboratory compares using <code>==</code>, but
sometimes you may need to tweak this to suit your needs.  It's easy enough —
just subclass <code>Experiment</code> and implement the <code>compare(control,
observation)</code> method.</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">class</span> <span class="pl-en">MyExperiment</span>(<span class="pl-e">Experiment</span>):
    <span class="pl-k">def</span> <span class="pl-en">compare</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>, <span class="pl-smi">control</span>, <span class="pl-smi">observation</span>):
        <span class="pl-k">return</span> control.value[<span class="pl-s"><span class="pl-pds">'</span>id<span class="pl-pds">'</span></span>] <span class="pl-k">==</span> observation.value[<span class="pl-s"><span class="pl-pds">'</span>id<span class="pl-pds">'</span></span>]</pre></div>
<a name="user-content-adding-context"/>
<h2><a id="user-content-adding-context" class="anchor" href="#adding-context" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Adding context</h2>
<p>A lot of the time there's going to be extra context around an experiment that's
useful to use in publishing or comparisons.  You can set this data in a few
ways.</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"># The first is experiment-wide context, which will be set on every observation laboratory makes.</span>

experiment <span class="pl-k">=</span> laboratory.Experiment(<span class="pl-v">name</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>Object Cache Experiment<span class="pl-pds">'</span></span>, <span class="pl-v">context</span><span class="pl-k">=</span>{<span class="pl-s"><span class="pl-pds">'</span>user<span class="pl-pds">'</span></span>: user})


<span class="pl-c"># Observation-specific context can be updated before or as the experiment is running.</span>

<span class="pl-k">with</span> experiment.control(<span class="pl-v">name</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>Object DB Strategy<span class="pl-pds">'</span></span>, <span class="pl-v">context</span><span class="pl-k">=</span>{<span class="pl-s"><span class="pl-pds">'</span>using<span class="pl-pds">'</span></span>: <span class="pl-s"><span class="pl-pds">'</span>db<span class="pl-pds">'</span></span>}) <span class="pl-k">as</span> e:
    e.update_context({<span class="pl-s"><span class="pl-pds">'</span>uuid<span class="pl-pds">'</span></span>: uuid})

    e.get_context() <span class="pl-c"># ==</span>
    <span class="pl-c"># {</span>
    <span class="pl-c">#     'user': &lt;User&gt;,</span>
    <span class="pl-c">#     'uuid': 'c08d46f1-92a6-46e5-9185-82d90dcb5af1',</span>
    <span class="pl-c">#     'using': 'db',</span>
    <span class="pl-c"># }</span>


<span class="pl-k">with</span> experiment.candidate(<span class="pl-v">name</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>Object Cache Strategy<span class="pl-pds">'</span></span>, <span class="pl-v">context</span><span class="pl-k">=</span>{<span class="pl-s"><span class="pl-pds">'</span>using<span class="pl-pds">'</span></span>: <span class="pl-s"><span class="pl-pds">'</span>cache<span class="pl-pds">'</span></span>}) <span class="pl-k">as</span> e:
    e.update_context({<span class="pl-s"><span class="pl-pds">'</span>uuid<span class="pl-pds">'</span></span>: uuid})

    e.get_context() <span class="pl-c"># ==</span>
    <span class="pl-c"># {</span>
    <span class="pl-c">#     'user': &lt;User&gt;,</span>
    <span class="pl-c">#     'using': 'cache',</span>
    <span class="pl-c"># }</span></pre></div>
<a name="user-content-installation"/>
<h2><a id="user-content-installation" class="anchor" href="#installation" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Installation</h2>
<p>Installing from pypi is recommended</p>
<pre>$ pip install laboratory
</pre>

</article>
  </div></body></html>