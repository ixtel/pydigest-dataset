<html><body><div><div class="post-1522 post type-post status-publish format-standard has-post-thumbnail hentry category-angularjs category-flask-framework-tutorials-and-examples category-python tag-flask-api-web-token-auth tag-flask-json-web-token tag-flask-json-web-token-authentication tag-json-web-token tag-jwt-authentication tag-python-web-token-authentication">
                <p>
                            <a href="" rel="nofollow"><img src="http://techarena51.com/wp-content/uploads/2015/09/json-token-flask-angularjs.png" alt="JSON web token authentication with  Flask and Angularjs" align="left" class="affiliate-image"/></a>
                        </p><p>JSON  web tokens  (JWT)  are a mechanism in which a  token is used instead of a username/password to authenticate  API users.  Token’s are  more secure because they can contain a scope ( Access Level) and an Expiry. Thus in case of a compromise the attacker has very limited access to your data. They can also be encrypted and stored on  the client side.</p>
<p>In this tutorial I will be describing how you can use JSON Web Tokens to authenticate API requests with  Flask  and Angularjs.</p>
<p>Note: This tutorial is based on Python 3.4 and you can use this <a href="https://github.com/Leo-g/Flask-Angularjs-JSON-Auth/blob/master/requirements.txt" target="_blank">requirements</a> file to install the required  python modules via PIP.</p>
<p><strong>Encoding and Decoding Tokens with PyJWT </strong></p>
<p>PyJWT is a simple Python library that allows you to encode and decode web tokens.   In order to create a token, PyJWT  needs a JSON formatted Payload, a secret key and an optional encryption algorithm. As soon as a user is authenticated we can create the token for them as follows:</p>
<pre class="brush: python; title: ; notranslate" title="">
def create_token(user):
    payload = {
        # subject
        'sub': user.id,
        #issued at
        'iat': datetime.utcnow(),
        #expiry
        'exp': datetime.utcnow() + timedelta(days=1)
    }

    token = jwt.encode(payload, SECRET_KEY, algorithm='HS256')
    return token.decode('unicode_escape')

def parse_token(req):
    token = req.headers.get('Authorization').split()[1]
    return jwt.decode(token, SECRET_KEY, algorithms='HS256')
</pre>
<p>For a list  of information the payload can contain see jwt.io.</p>
<p><strong>Login decorator for API endpoints</strong></p>
<p>The login decorator  is what you can use to decorate your API  resource functions or classes so that only  requests with valid tokens can access them.</p>
<p><strong>Example Python3 code of Login decorator</strong></p>
<pre class="brush: python; title: ; notranslate" title="">
def login_required(f):&lt;/pre&gt;
&lt;pre&gt;    @wraps(f)
    def decorated_function(*args, **kwargs):
        if not request.headers.get('Authorization'):
            response = jsonify(message='Missing authorization header')
            response.status_code = 401
            return response
        try:
            payload = parse_token(request)
        except DecodeError:
            response = jsonify(message='Token is invalid')
            response.status_code = 401
            return response
        except ExpiredSignature:
            response = jsonify(message='Token has expired')
            response.status_code = 401
            return response
        g.user_id = payload['sub']
        return f(*args, **kwargs)
    return decorated_function
</pre>
<p>I have used Flask-Restful to create my Flask API,  hence I need to sub-class the Resource class and add the login decorator to its  “method_decorators” property as follows:</p>
<pre class="brush: python; title: ; notranslate" title="">
class Resource(flask_restful.Resource):
    method_decorators = [login_required]  

class User(Resource):
    def get(self):   
                results = Users.query.all()
                users = schema.dump(results, many=True).data
                return jsonify({"users":users})
</pre>
<p>I added relevant code so it’s easier to understand. The complete code is available at <a href="https://github.com/Leo-g/Flask-Angularjs-JSON-Auth/blob/master/app/users/views.py">https://github.com/Leo-g/Flask-Angularjs-JSON-Auth/blob/master/app/users/views.py</a>.</p>
<p><strong>Using Angularjs module Satellizer to store and pass JWT in our API requests</strong></p>
<p>Satellizer is an easy to use angularjs module for token based authentication. You will first need to configure it with the login url from where it can access the Token. Then you can  use methods like <a href="https://github.com/sahat/satellizer#authloginuser-options">$auth.login(UserCreds)</a> , <a href="https://github.com/sahat/satellizer#authisauthenticated">$auth.isAuthenticated()</a> and <a href="https://github.com/sahat/satellizer#authlogout">$auth.logout() </a> to authenticate, verify and logout a user.</p>
<p><strong>Example app.js code </strong></p>
<pre class="brush: jscript; title: ; notranslate" title="">
&lt;pre&gt;angular.module('myApp', ['ui.router', 'ngResource', 'myApp.controllers', 'myApp.services', "angularGrid" , 'satellizer','toaster', 'ngAnimate']);
angular.module('myApp').config(function($stateProvider, $urlRouterProvider, $authProvider) {
  // Satellizer configuration that specifies which API
            // route the JWT should be retrieved from
            $authProvider.loginUrl = '/api/login';          

            $urlRouterProvider.otherwise('/');            

  $stateProvider. state('login', {
url: '/login',
templateUrl: 'partials/login.html',
controller: 'LoginController',
    resolve: {
//Function to check if user is already logged in
          skipIfLoggedIn: skipIfLoggedIn
        }    

  })

</pre>
<p><strong>Example login.html code</strong></p>
<pre class="brush: xml; title: ; notranslate" title="">&lt;/pre&gt;
&lt;form&gt;
&lt;input required="" type="email" placeholder="Email" /&gt;

&lt;input required="" type="password" placeholder="Password" /&gt;

&lt;button class="button-primary"&gt;Login&lt;/button&gt;&lt;/form&gt;
&lt;pre&gt;</pre>
<p><strong>Example controller.js code to Login and Logout a user</strong></p>

<p>


</p>

<pre class="brush: jscript; title: ; notranslate" title="">

#Relevant controller code
#complete code at  https://github.com/Leo-g/Flask-Angularjs-JSON-Auth/blob/master/angularjs-frontend/js/controllers.js
angular.module('myApp.controllers', []).controller('LoginController', function($auth, $state, $window, $scope, toaster) {
$scope.login = function() {
            $scope.credentials = {
                email: $scope.email,
                password: $scope.password
            }          

            // Use Satellizer's $auth.login method to verify the username and password
            $auth.login($scope.credentials).then(function(data) {
                // If login is successful, redirect to users list               

$state.go('users');
            })
            .catch(function(response){ // If login is unsuccessful, display relevant error message.    
               toaster.pop({
                type: 'error',
                title: 'Login Error',
                body: response.data,
                showCloseButton: true,
                timeout: 0
                });
               });
        }       

}).controller('LogoutCtrl', function($auth,  $location, toaster) { // Logout the user if they are authenticaed.

if (!$auth.isAuthenticated()) { return; }
     $auth.logout()
      .then(function() {    

        toaster.pop({
                type: 'success',            
                body: 'Logging out' ,
                showCloseButton: true               

                });
        $location.url('/');
      }); 

</pre>
<p>You will also need to configure any routes that need authentication as follows</p>
<pre class="brush: jscript; title: ; notranslate" title="">
$stateProvider.state('users', {
    url: '/',
    templateUrl: 'partials/users.html',
    controller: 'UserListController',
   //resolve only for authenticated users
    resolve: {
          loginRequired: loginRequired
        }

function loginRequired($q, $location, $auth, $state) {
      var deferred = $q.defer();
      if ($auth.isAuthenticated()) {
        deferred.resolve();
      } else {
        $location.path('/login');

      }
      return deferred.promise;

    }

</pre>
<p>You can view the complete javascript  code at <a href="https://github.com/Leo-g/Flask-Angularjs-JSON-Auth/tree/master/angularjs-frontend/js">https://github.com/Leo-g/Flask-Angularjs-JSON-Auth/tree/master/angularjs-frontend/js</a></p>
<p>For a Live demo check <a href="https://github.com/Leo-G/Flask-Scaffold" target="_blank">https://github.com/Leo-G/Flask-Scaffold</a></p>
<p>Here is a video of the working demo.<br/>
<iframe src="https://www.youtube.com/embed/0sAr0YdxiPE" frameborder="0" allowfullscreen="allowfullscreen">VIDEO</iframe></p>
<p> </p>
<p>Let me know if you have any questions or suggestions in the comment section below.</p>
<p>Flask is an easy and simple framework for python <a href="http://techarena51.com/index.php/how-to-install-python-3-and-flask-on-linux/" target="_blank">here</a> is how you can get started with it.</p>
<p>Ref</p>
<p><a href="http://flask-restful.readthedocs.org/en/latest/extending.html#resource-method-decorators">http://flask-restful.readthedocs.org/en/latest/extending.html#resource-method-decorators</a></p>
<p><a href="https://github.com/jpadilla/pyjwt">https://github.com/jpadilla/pyjwt</a></p>
<p><a href="https://stormpath.com/blog/where-to-store-your-jwts-cookies-vs-html5-web-storage/">https://stormpath.com/blog/where-to-store-your-jwts-cookies-vs-html5-web-storage/</a></p>
<p>https://tools.ietf.org/html/rfc7519#page-6
</p>

<p/>
                         <div class="abh_box abh_box_down abh_box_business"><div class="abh_tab_content"><section class="vcard abh_about_tab abh_tab"><div class="abh_text"><p class="abh_job"/><p class="description note abh_description">Is a Technical project manager who through this blog shares his experience building Web Applications with Python, FlaskAngularjs and Linux.His Projects are opensource and available at https://github.com/Leo-g</p></div> </section><section class="abh_posts_tab abh_tab"><div class="abh_text"><h4>Latest posts by Leo G <span class="abh_allposts">(<a href="http://techarena51.com/index.php/author/leo/">see all</a>)</span></h4></div> </section></div> </div>        <p class="clear"/>
                
    </div>
    
    
        
</div></body></html>