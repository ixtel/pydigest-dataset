<html><body><div><article class="markdown-body entry-content" itemprop="text"><h1><a id="user-content-expressions" class="anchor" href="#expressions" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Expressions</h1>

<p>Arithmetic expression parser library.  Embed customized expression evaluation
into your application or library. Example uses:</p>

<ul>
<li>Safely process an expression entered through a web application,
for example some formula to be plotted. The library allows safe translation
of such expression without exposing any application's internals</li>
<li>precompiler that checks for allowed and denied identifiers in an expression</li>
<li>have a common expression language through your application regardless of the
backend languages</li>
<li>compile arithmetic expression to any other expression tree (semantic), for
example <a href="http://docs.sqlalchemy.org/en/rel_0_7/core/expression_api.html">SQLAlchemy</a> expression objects</li>
</ul>

<p>Part of the <a href="http://databrewery.org">Data Brewery</a></p>

<h2><a id="user-content-installation" class="anchor" href="#installation" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Installation</h2>

<p>Install using pip:</p>

<pre><code>pip install expressions
</code></pre>

<p>Expressions sources are available at <a href="https://github.com/DataBrewery/expressions">Github</a></p>

<p>Works with Python 2.7 and Python 3.3. Uses <a href="https://bitbucket.org/apalala/grako">Grako</a>.</p>

<h2><a id="user-content-quick-start" class="anchor" href="#quick-start" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Quick Start</h2>

<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> expressions <span class="pl-k">import</span> Compiler

compiler <span class="pl-k">=</span> Compiler()
result <span class="pl-k">=</span> compiler.compile(<span class="pl-s"><span class="pl-pds">"</span>min(a, b) * 2<span class="pl-pds">"</span></span>)</pre></div>

<p>Result from the default (non-extended) compiler will be abstract semantic
graph containing nodes <em>Literal</em>, <em>Variable</em>, <em>Function</em>, <em>Binary</em> and <em>Unary</em>
operators. Subclasses of <code>Compiler</code> can yield different outputs by
implementing just few simple methods which represent semantic graph nodes
(same as the objects).</p>

<h2><a id="user-content-example" class="anchor" href="#example" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Example</h2>

<p>Here is an example compiler that allows only certain variables. The list of
allowed variables is provided in the compilation context:</p>

<div class="highlight highlight-source-python"><pre>    <span class="pl-k">from</span> expressions <span class="pl-k">import</span> Compiler, ExpressionError

    <span class="pl-k">class</span> <span class="pl-en">AllowingCompiler</span>(<span class="pl-e">Compiler</span>):
        <span class="pl-k">def</span> <span class="pl-en">compile_literal</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>, <span class="pl-smi">context</span>, <span class="pl-smi">literal</span>):
            <span class="pl-k">return</span> <span class="pl-c1">repr</span>(literal)

        <span class="pl-k">def</span> <span class="pl-en">compile_variable</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>, <span class="pl-smi">context</span>, <span class="pl-smi">variable</span>):
            <span class="pl-k">if</span> context <span class="pl-k">and</span> variable <span class="pl-k">not</span> <span class="pl-k">in</span> context:
                <span class="pl-k">raise</span> ExpressionError(<span class="pl-s"><span class="pl-pds">"</span>Variable <span class="pl-c1">%s</span> is not allowed<span class="pl-pds">"</span></span> <span class="pl-k">%</span> variable)

            <span class="pl-k">return</span> variable

        <span class="pl-k">def</span> <span class="pl-en">compile_binary</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>, <span class="pl-smi">context</span>, <span class="pl-smi">operator</span>, <span class="pl-smi">op1</span>, <span class="pl-smi">op2</span>):
            <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span>(<span class="pl-c1">%s</span> <span class="pl-c1">%s</span> <span class="pl-c1">%s</span>)<span class="pl-pds">"</span></span> <span class="pl-k">%</span> (op1, operator, op2)

        <span class="pl-k">def</span> <span class="pl-en">compile_function</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>, <span class="pl-smi">context</span>, <span class="pl-smi">function</span>, <span class="pl-smi">args</span>):
            arglist <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>, <span class="pl-pds">"</span></span> <span class="pl-k">%</span> args
            <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-c1">%s</span>(<span class="pl-c1">%s</span>)<span class="pl-pds">"</span></span> <span class="pl-k">%</span> (function, arglist)</pre></div>

<p>Allow only <code>a</code> and <code>b</code> variables:</p>

<pre><code>compiler = AllowingCompiler()

allowed_variables = ["a", "b"]
</code></pre>

<p>Try to compile and execute the expression:</p>

<pre><code>result = compiler.compile("a + b", allowed_variables)

a = 1
b = 1
print(eval(result))
</code></pre>

<p>This will fail, because only <code>a</code> and <code>b</code> are allowed, <code>c</code> is not:</p>

<pre><code>result = compiler.compile("a + c", allowed_variables)
</code></pre>

<p>See the examples source directory for more examples such as very simplified
expression-to-SQLAlchemy compiler.</p>

<h1><a id="user-content-syntax" class="anchor" href="#syntax" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Syntax</h1>

<p>Example expressions:</p>

<div class="highlight highlight-source-sql"><pre>    <span class="pl-c1">1</span> <span class="pl-k">+</span> <span class="pl-c1">1</span>
    (a <span class="pl-k">+</span> b) ^ <span class="pl-c1">2</span>
    <span class="pl-c1">sum</span>(amount) <span class="pl-k">/</span> <span class="pl-c1">count</span>()
    <span class="pl-k">date</span>.year <span class="pl-k">=</span> <span class="pl-c1">2010</span> <span class="pl-k">and</span> amount <span class="pl-k">&gt;</span> <span class="pl-c1">10</span></pre></div>

<ul>
<li>Binary arithmetic operators: <code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>, <code>%</code> (modulo), <code>^</code> (power)</li>
<li>Binary comparison operators: <code>&lt;</code>, <code>&lt;=</code>, <code>=</code>, <code>&gt;=</code>, <code>&gt;</code>, <code>in</code>, <code>is</code></li>
<li>Binary bit-wise operators: <code>|</code> (or), <code>&amp;</code> (and), <code>&lt;&lt;</code> (shift left), <code>&gt;&gt;</code> (shift right)</li>
<li>Binary logical operators: <code>and</code>, <code>or</code></li>
<li><p>Unary operators: <code>+</code>, <code>-</code>, <code>~</code> (bit-wise not)</p></li>
<li><p>Function call: <code>function_name(arg1, arg2, ...)</code></p></li>
</ul>

<p><em>Variable</em> and <em>function</em> names are either regular identifiers or identifiers
separated by <code>.</code>. There is no value dereference and the dot <code>.</code> is just
namespace composition operator for variable names. Example variable names:
<code>amount</code>, <code>date.year</code>, <code>product.name</code>.</p>

<p>The suggested meaning of the operators is based mostly on the
<a href="http://www.postgresql.org/docs/9.0/static/functions.html">PostgreSQL operators</a></p>

<h1><a id="user-content-writing-a-compiler" class="anchor" href="#writing-a-compiler" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Writing a compiler</h1>

<p>To write a custom compiler subclass a <code>Compiler</code> class and implement all of
some of the following methods:</p>

<ul>
<li><em>compile_function(context, reference, args)</em> – compile a function call. The
<code>reference</code> is the same kind of object as passed to the
<em>compile_variable()</em>, <code>args</code> is list of function arguments. Default
implementation returns an object with attributes <code>reference</code> and <code>args</code></li>
<li><em>compile_binary(context, operator, left, right)</em> – compile a binary
operator <code>operator</code> with two operands <code>left</code> and <code>right</code>. Default
implementation returns an object with attributes <code>operator</code>, <code>left</code> and <code>right</code></li>
<li><em>compile_unary(context, operator, operand)</em> – compile a unary <code>operator</code> with
a single <code>operand</code>. Default implementation returns an object with attributes
<code>operator</code> and <code>operand</code>.</li>
<li><em>compile_variable(context, variable)</em> – compile a variable reference
<code>variable</code> which is an object with properties <code>name</code> and <code>reference</code>. <code>name</code>
is the full variable name (joined with <code>.</code>), <code>reference</code> is a list of
variable name components. Return value should be either evaluated variable
as a constant or some other useful variable reference.</li>
<li><em>compile_literal(context, literal)</em> – compile an integer, float or a string
object <code>literal</code>. Default implementation just passes the argument. You
rarely need to override this method.</li>
<li><em>finalize(context, object)</em> – return the final compilation result.</li>
</ul>

<p>When compiling function arguments or operator operands you should check
whether they are literals or instances of a <code>Variable</code>. For example:</p>

<div class="highlight highlight-source-python"><pre>    <span class="pl-k">def</span> <span class="pl-en">compile_function</span>(<span class="pl-smi">context</span>, <span class="pl-smi">reference</span>, <span class="pl-smi">args</span>):
        <span class="pl-c"># Assume that the context is a dictionary with variables and functions</span>

        values <span class="pl-k">=</span> []
        <span class="pl-k">for</span> arg <span class="pl-k">in</span> args:
            <span class="pl-k">if</span> <span class="pl-c1">isinstance</span>(arg, Variable):
                value <span class="pl-k">=</span> context[arg.name]
            <span class="pl-k">else</span>:
                value <span class="pl-k">=</span> arg
            values.append(value)

        function <span class="pl-k">=</span> context[reference.name]

        <span class="pl-k">return</span> function(<span class="pl-k">*</span>args)</pre></div>

<p>Example compiler: Identifier Preprocessor</p>

<p>The following compiler is included in the library:</p>

<div class="highlight highlight-source-python"><pre>    <span class="pl-k">class</span> <span class="pl-en">IdentifierPreprocessor</span>(<span class="pl-e">Compiler</span>):
        <span class="pl-k">def</span> <span class="pl-c1">__init__</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>):
            <span class="pl-c1">super</span>(IdentifierPreprocessor, <span class="pl-v">self</span>).<span class="pl-c1">__init__</span>()

            <span class="pl-v">self</span>.variables <span class="pl-k">=</span> <span class="pl-c1">set</span>()
            <span class="pl-v">self</span>.functions <span class="pl-k">=</span> <span class="pl-c1">set</span>()

        <span class="pl-k">def</span> <span class="pl-en">compile_variable</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>, <span class="pl-smi">context</span>, <span class="pl-smi">variable</span>):
            <span class="pl-v">self</span>.variables.add(variable)
            <span class="pl-k">return</span> variable

        <span class="pl-k">def</span> <span class="pl-en">compile_function</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>, <span class="pl-smi">context</span>, <span class="pl-smi">function</span>, <span class="pl-smi">args</span>):
            <span class="pl-v">self</span>.functions.add(function)
            <span class="pl-k">return</span> function</pre></div>

<p>Use:</p>

<div class="highlight highlight-source-python"><pre><span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> preproc <span class="pl-k">=</span> IdentifierPreprocessor()
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> preproc.compile(<span class="pl-s"><span class="pl-pds">"</span>a + b<span class="pl-pds">"</span></span>)
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> preproc.compile(<span class="pl-s"><span class="pl-pds">"</span>sum(amount)<span class="pl-pds">"</span></span>)</pre></div>

<p>The <code>preproc.variables</code> will contain <em>Variable</em> objects for <code>a</code>, <code>b</code> and
<code>amount</code>, the <code>proproc.functions</code> will contain one <em>Variable</em> object <code>sum</code>:</p>

<div class="highlight highlight-source-python"><pre><span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-c1">print</span>(preproc.variables)
{Variable(amount), Variable(b), Variable(a)}
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-c1">print</span>(preproc.functions)
{Variable(<span class="pl-c1">sum</span>)}</pre></div>

<p>Note that the <em>Variable</em> object represents any named object reference – both
variables and functions.</p>

<h1><a id="user-content-classes" class="anchor" href="#classes" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Classes</h1>

<p>The following classes are provided by the library:</p>

<ul>
<li><em>Compiler</em> – core compiler class that generates default structure,
<code>compile_*</code> methods can be overriden to generate custom results</li>
<li><em>IdentifierPreprocessor</em> – a <em>Compiler</em> subclass with two attributes
<code>variables</code> and <code>functions</code> containing list of <code>Variable</code> objects collected
from the compiled expression. Can be used for validation or preparation of
variables</li>
</ul>

<h2><a id="user-content-what-expressions-is-not" class="anchor" href="#what-expressions-is-not" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>What Expressions is <em>not</em></h2>

<ul>
<li><p>This is <em>not</em> a Python expression compiler. The grammar is based on very
basic SQL grammar and few other simple SQL grammar features might be added in
the future. There is no SQL compatibility guaranteed though. It is not meant
to be a rich expression, but a small subset of quite common expressions to
allow easy translation to other languages or object structures. Main use is
arithmetic expression support for a modular application with different
backends</p></li>
<li><p>It is <em>not</em> an expression of an object-oriented language – it does not have
access to object attributes – the '.' dot operator is just an attribute name
concatenation. The compiler receives full object reference as a string and
as a list of reference components.</p></li>
</ul>

<h2><a id="user-content-license" class="anchor" href="#license" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>License</h2>

<p>Expressions framework is licensed under the MIT license.</p>

<p>For more information see the LICENSE file.</p>

<h2><a id="user-content-author" class="anchor" href="#author" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Author</h2>

<p>Stefan Urbanek, <a href="mailto:stefan.urbanek@gmail.com">stefan.urbanek@gmail.com</a>, Twitter: @Stiivi</p>
</article>
  </div></body></html>