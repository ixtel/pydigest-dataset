<html><body><div><div class="span8">
    
<p><em>Using a context manager to allow painless rewriting of files</em></p>

<p>Whenever you need to process a file in-place, transforming the contents and writing it out again in the same location, you can reach out for the <a href="http://docs.python.org/2/library/fileinput.html"><code>fileinput</code> module</a> and use its <code>inplace</code> option:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">fileinput</span>

<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fileinput</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">somefilename</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="s">'additional information '</span> <span class="o">+</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">line</span></code></pre></div>

<p>There are a few problems with the <code>fileinput</code> module, however. My biggest nitpick with the module is that it has an API that relies heavily on globals; <code>fileinput.input()</code> creates a global <a href="http://docs.python.org/2/library/fileinput.html#fileinput.FileInput"><code>fileinput.FileInput()</code> object</a>, which other functions in the module then access. You can of course ignore all that and reach straight for the <code>fileinput.FileInput()</code> constructor, but <code>fileinput.input()</code> is presented as the main API entrypoint.</p>

<p>The other is that the in-place modus hijacks <code>sys.stdout</code> as the means to write back to the replacement file. Obstensibly this is to make it easy to use a <code>print</code> statement, but then you have to remember to remove the newline from the lines read from the old file.</p>

<p>Last, but not least, the <a href="http://docs.python.org/3/library/fileinput.html"><code>fileinput</code> version in the Python 3 standard library</a> does not support specifying an encoding, error mode or newline handling. You can open the input file in binary mode, but output is always handled in text mode. This greatly diminishes the usefulness of this library. </p>

<p>So I wrote my own replacement, using the excellent <a href="http://docs.python.org/2/library/contextlib.html#contextlib.contextmanager"><code>@contextlib.contextmanager</code> decorator</a>. This version works on both Python 2 and 3, relying on <a href="http://docs.python.org/2/library/io.html#io.open"><code>io.open()</code></a> to remain compatible between Python versions:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">os</span>


<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">inplace</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'r'</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">newline</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">backup_extension</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">"""Allow for a file to be replaced with new content.</span>

<span class="sd">    yields a tuple of (readable, writable) file objects, where writable</span>
<span class="sd">    replaces readable.</span>

<span class="sd">    If an exception occurs, the old file is restored, removing the</span>
<span class="sd">    written data.</span>

<span class="sd">    mode should *not* use 'w', 'a' or '+'; only read-only-modes are supported.</span>

<span class="sd">    """</span>

    <span class="c"># move existing file to backup, create new file with same permissions</span>
    <span class="c"># borrowed extensively from the fileinput module</span>
    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="s">'wa+'</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">'Only read-only file modes can be used'</span><span class="p">)</span>

    <span class="n">backupfilename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="p">(</span><span class="n">backup_extension</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">extsep</span> <span class="o">+</span> <span class="s">'bak'</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">backupfilename</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">os</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">backupfilename</span><span class="p">)</span>
    <span class="n">readable</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">backupfilename</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="n">buffering</span><span class="p">,</span>
                       <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="n">newline</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">perm</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fstat</span><span class="p">(</span><span class="n">readable</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span><span class="o">.</span><span class="n">st_mode</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="n">writable</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">'w'</span> <span class="o">+</span> <span class="n">mode</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'r'</span><span class="p">,</span> <span class="s">''</span><span class="p">),</span>
                        <span class="n">buffering</span><span class="o">=</span><span class="n">buffering</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">,</span>
                        <span class="n">newline</span><span class="o">=</span><span class="n">newline</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">os_mode</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_TRUNC</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">'O_BINARY'</span><span class="p">):</span>
            <span class="n">os_mode</span> <span class="o">|=</span> <span class="n">os</span><span class="o">.</span><span class="n">O_BINARY</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">os_mode</span><span class="p">,</span> <span class="n">perm</span><span class="p">)</span>
        <span class="n">writable</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">"w"</span> <span class="o">+</span> <span class="n">mode</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'r'</span><span class="p">,</span> <span class="s">''</span><span class="p">),</span> <span class="n">buffering</span><span class="o">=</span><span class="n">buffering</span><span class="p">,</span>
                           <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="n">newline</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">'chmod'</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">perm</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">readable</span><span class="p">,</span> <span class="n">writable</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="c"># move backup back</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">os</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">backupfilename</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">raise</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">readable</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">writable</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">backupfilename</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">os</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="k">pass</span></code></pre></div>

<p>This context manager deliberately focuses on just <em>one</em> file, and ignores <code>sys.stdin</code>, unlike the <code>fileinput</code> module. It is aimed squarly at just replacing a file in-place.</p>

<p>Usage example, in Python 2, with the CSV module:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">csv</span>

<span class="k">with</span> <span class="n">inplace</span><span class="p">(</span><span class="n">csvfilename</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">infh</span><span class="p">,</span> <span class="n">outfh</span><span class="p">):</span>
    <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">infh</span><span class="p">)</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">outfh</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
        <span class="n">row</span> <span class="o">+=</span> <span class="p">[</span><span class="s">'new'</span><span class="p">,</span> <span class="s">'columns'</span><span class="p">]</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span></code></pre></div>

<p>and the Python 3 version:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">csv</span>

<span class="k">with</span> <span class="n">inplace</span><span class="p">(</span><span class="n">csvfilename</span><span class="p">,</span> <span class="s">'r'</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s">''</span><span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">infh</span><span class="p">,</span> <span class="n">outfh</span><span class="p">):</span>
    <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">infh</span><span class="p">)</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">outfh</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
        <span class="n">row</span> <span class="o">+=</span> <span class="p">[</span><span class="s">'new'</span><span class="p">,</span> <span class="s">'columns'</span><span class="p">]</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span></code></pre></div>


    <hr/>
    
    <hr/>
    


  









    


  <p id="disqus_thread"/>

<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
  
  </div></body></html>