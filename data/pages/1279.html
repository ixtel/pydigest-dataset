<html><body><div><div class="section-inner layoutSingleColumn"><p name="da01" id="da01" class="graf--p graf--first">We, like many companies, build and iterate quickly — releasing new or improved features almost every week.</p><p name="0fff" id="0fff" class="graf--p graf-after--p">With each change, we try to be thoughtful about adding indexes, deleting dead code, and refactoring. But performance is not the primary objective, improving and testing the product is. We’re OK with a little speed-debt creeping in, and we combat it by taking a few days every month to focus on speed.</p><p name="b151" id="b151" class="graf--p graf-after--p">Our goal last week was to spend two days halving average load times from 350ms to ~180ms.</p><p name="7ed0" id="7ed0" class="graf--p graf-after--p">We started with our most important page, <a href="http://socratic.org/questions/how-do-transverse-waves-move" data-href="http://socratic.org/questions/how-do-transverse-waves-move" class="markup--anchor markup--p-anchor" rel="nofollow">the questions page</a>. The code revealed so many opportunities! We added missing indexes, deleted unnecessary database lookups, and deferred loading of some components till after the page load.</p><p name="eea2" id="eea2" class="graf--p graf-after--p">A few hours of work sped up this one page by 20%. Great, but far from our goal.</p><p name="ed78" id="ed78" class="graf--p graf-after--p">We turned to New Relic, and the real problem became clear. Here’s a breakdown of the most time-consuming function calls for rendering the page:</p><figure name="1950" id="1950" class="graf--figure graf-after--p"><figcaption class="imageCaption">A breakdown of the 10 most time-consuming functions on this page</figcaption></figure><p name="cd08" id="cd08" class="graf--p graf-after--figure">7 out of 10 of them relate to compiling templates. In all, 65 separate templates are used by this page, 22 of which are compiled in more than 1 out of every 5 requests.</p><p name="76cf" id="76cf" class="graf--p graf-after--p">A separate template for each potentially reusable bit of UI is great for DRY and consistency, but apparently not for performance.</p><p name="b0f6" id="b0f6" class="graf--p graf-after--p">We discovered that Flask defaults to a 50-template limit for the Jinja2 template cache. With scores of separate templates required by each view, each page would result in dozens of cache misses and recompilations.</p><p name="e4e4" id="e4e4" class="graf--p graf-after--p">To confirm that the template cache was the problem, we <a href="https://gist.github.com/shreyansb/86b74ae47719a27bbb25" data-href="https://gist.github.com/shreyansb/86b74ae47719a27bbb25" class="markup--anchor markup--p-anchor" rel="nofollow">set up a profiler</a>. We saw that switching routes would consistently result in scores of calls to `jinja2/[nodes|lexer|compiler].py`, while loading subsequent pages within a route without changing routes would not.</p><p name="3c4e" id="3c4e" class="graf--p graf-after--p">We decided to change the cache limit. Unfortunately, contrary to the usual ease of use of Flask, there was no clean and easy way to do this. Instead, we found a way to remove the cache limit entirely, and added this line before `app.run()`:</p><pre name="6f60" id="6f60" class="graf--pre graf-after--p">app.jinja_env.cache = {}</pre><p name="f894" id="f894" class="graf--p graf-after--pre">One line to set the cache to a dictionary, and by doing so, removing the limit of the number of cached templates.</p><p name="bfa6" id="bfa6" class="graf--p graf-after--p">The profiler immediately showed that templates would only be compiled the first time a route was loaded.</p><p name="88c5" id="88c5" class="graf--p graf-after--p">We deployed the change, and got this:<br/>(ignore the average ms — it’s for the entire time range):</p><figure name="650f" id="650f" class="graf--figure graf-after--p"><figcaption class="imageCaption">The questions page</figcaption></figure><figure name="6a3e" id="6a3e" class="graf--figure graf-after--figure"><figcaption class="imageCaption">The landing page</figcaption></figure><figure name="3806" id="3806" class="graf--figure graf-after--figure"><figcaption class="imageCaption">The course page</figcaption></figure><p name="bfbf" id="bfbf" class="graf--p graf-after--figure graf--last">This one line brought us below our goal, without any of the other changes we made to the code.</p></div></div></body></html>