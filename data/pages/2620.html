<html><body><div><div class="entry-content clearfix"><p><strong>This tutorial details how to validate email addresses during user registration.</strong></p>














<p><strong>Updated 04/30/2015</strong>: Added Python 3 support.</p>

<hr/>


<p>In terms of workflow, after a user registers a new account, a confirmation email is sent. The user account is marked as “unconfirmed” until the user, well, “confirms” the account via the instructions in the email. This is a simple workflow that most web applications follow.</p>

<p>One important thing to take into account is what unconfirmed users are allowed to do. In other words, do they have full access to your application, limited/restricted access, or no access at all? For the application in this tutorial, unconfirmed users can log in but they are immediately redirected to a page reminding them that they need to confirm their account before they can access the application.</p>

<blockquote><p>Before beginning, most of the functionality that we will be adding is part of the <a href="http://pythonhosted.org/Flask-User/">Flask-User</a> and <a href="https://pythonhosted.org/Flask-Security/">Flask-Security</a> extensions – which begs the question why not just use the extensions? Well, first and foremost, this is an opportunity to learn. Also, both of those extensions have limitations, like the supported databases. What if you wanted to use <a href="http://www.rethinkdb.com/">RethinkDB</a>, for example?</p></blockquote>

<p>Let’s begin.</p>

<a name="Flask.basic.registration"/>
<h2>Flask basic registration</h2>

<p>We’re going to start with a Flask boilerplate that includes basic user registration. Grab the code from the <a href="https://github.com/mjhea0/flask-basic-registration">repository</a>. Once you’ve created and activated a virtualenv, run the following commands to quickly get started:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>pip install -r requirements.txt
</span><span class="line"><span class="nv">$ </span><span class="nb">export </span><span class="nv">APP_SETTINGS</span><span class="o">=</span><span class="s2">"project.config.DevelopmentConfig"</span>
</span><span class="line"><span class="nv">$ </span>python manage.py create_db
</span><span class="line"><span class="nv">$ </span>python manage.py db init
</span><span class="line"><span class="nv">$ </span>python manage.py db migrate
</span><span class="line"><span class="nv">$ </span>python manage.py create_admin
</span><span class="line"><span class="nv">$ </span>python manage.py runserver
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Check out the <a href="https://github.com/mjhea0/flask-basic-registration#quickstart">readme</a> for more information.</p></blockquote>

<p>With the app running, navigate to <a href="http://localhost:5000/register">http://localhost:5000/register</a> and register a new user. Notice that after registration, the app automatically logs you in and redirects you to the main page. Take a look around, then run through the code – specifically the “user” blueprint.</p>

<p>Kill the server when done.</p>

<a name="Update.the.current.app"/>
<h2>Update the current app</h2>

<a name="Models"/>
<h3>Models</h3>

<p>First, let’s add the <code>confirmed</code> field to our <code>User</code> model in <em>project/models.py</em>:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span><span class="line">
</span><span class="line">    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">"users"</span>
</span><span class="line">
</span><span class="line">    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class="line">    <span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span class="line">    <span class="n">password</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span class="line">    <span class="n">registered_on</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span class="line">    <span class="n">admin</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span class="line">    <span class="n">confirmed</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span class="line">    <span class="n">confirmed_on</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">confirmed</span><span class="p">,</span>
</span><span class="line">                 <span class="n">paid</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">admin</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">confirmed_on</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">generate_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">registered_on</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">admin</span> <span class="o">=</span> <span class="n">admin</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">confirmed</span> <span class="o">=</span> <span class="n">confirmed</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">confirmed_on</span> <span class="o">=</span> <span class="n">confirmed_on</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice how this field defaults to ‘False’. We also added a <code>confirmed_on</code> field, which is a <code>datetime</code>. I like to include this field as well in order to analyze the difference between the <code>registered_on</code> and <code>confirmed_on</code> dates using <a href="http://mherman.org/blog/2012/11/16/the-benefits-of-performing-a-cohort-analysis-in-determining-engagement-over-time/#.VJS2tcADA">cohort analysis</a>.</p>

<p>Let’s completely start over with our database and migrations. So, go ahead and delete the database, <em>dev.sqlite</em>, as well as the “migrations” folder.</p>

<a name="Manage.command"/>
<h3>Manage command</h3>

<p>Next, within <em>manage.py</em>, update the <code>create_admin</code> command to take the new database fields into account:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="nd">@manager.command</span>
</span><span class="line"><span class="k">def</span> <span class="nf">create_admin</span><span class="p">():</span>
</span><span class="line">    <span class="sd">"""Creates the admin user."""</span>
</span><span class="line">    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">User</span><span class="p">(</span>
</span><span class="line">        <span class="n">email</span><span class="o">=</span><span class="s">"ad@min.com"</span><span class="p">,</span>
</span><span class="line">        <span class="n">password</span><span class="o">=</span><span class="s">"admin"</span><span class="p">,</span>
</span><span class="line">        <span class="n">admin</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
</span><span class="line">        <span class="n">confirmed</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
</span><span class="line">        <span class="n">confirmed_on</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
</span><span class="line">    <span class="p">)</span>
</span><span class="line">    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Make sure to import <code>datetime</code>. Now, go ahead and run the following commands again:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>python manage.py create_db
</span><span class="line"><span class="nv">$ </span>python manage.py db init
</span><span class="line"><span class="nv">$ </span>python manage.py db migrate
</span><span class="line"><span class="nv">$ </span>python manage.py create_admin
</span></code></pre></td></tr></table></div></figure>


<a name="L.code.register....code..view.function"/>
<h3><code>register()</code> view function</h3>

<p>Finally, before we can register a user again, we need to make a quick change to the <code>register()</code> view function in <em>project/user/views.py</em>…</p>

<p>Change:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
</span><span class="line">    <span class="n">email</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
</span><span class="line">    <span class="n">password</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">data</span>
</span><span class="line"><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>To:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
</span><span class="line">    <span class="n">email</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
</span><span class="line">    <span class="n">password</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
</span><span class="line">    <span class="n">confirmed</span><span class="o">=</span><span class="bp">False</span>
</span><span class="line"><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Make sense? Think about why we would want to default <code>confirmed</code> to <code>False</code>.</p>

<p>Okay. Run the app again. Navigate to <a href="http://localhost:5000/register">http://localhost:5000/register</a> and register a new user again. If you open your SQLite database in the SQLite Browser, you should see:</p>














<p>So, the new user that I registered, <code>michael@realpython.com</code>, is not confirmed. Let’s change that.</p>

<a name="Add.email.confirmation"/>
<h2>Add email confirmation</h2>

<a name="Generate.confirmation.token"/>
<h3>Generate confirmation token</h3>

<p>The email confirmation should contain a unique URL that a user simply needs to click in order to confirm his/her account. Ideally, the URL should look something like this – <code>http://yourapp.com/confirm/&lt;id&gt;</code>. The key here is the <code>id</code>. We are going to encode the user email (along with a timestamp) in the <code>id</code> using the <a href="http://pythonhosted.org/itsdangerous/">itsdangerous</a> package.</p>

<p>Create a file called <em>project/token.py</em> and add the following code:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c"># project/token.py</span>
</span><span class="line">
</span><span class="line"><span class="kn">from</span> <span class="nn">itsdangerous</span> <span class="kn">import</span> <span class="n">URLSafeTimedSerializer</span>
</span><span class="line">
</span><span class="line"><span class="kn">from</span> <span class="nn">project</span> <span class="kn">import</span> <span class="n">app</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">generate_confirmation_token</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
</span><span class="line">    <span class="n">serializer</span> <span class="o">=</span> <span class="n">URLSafeTimedSerializer</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'SECRET_KEY'</span><span class="p">])</span>
</span><span class="line">    <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'SECURITY_PASSWORD_SALT'</span><span class="p">])</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">confirm_token</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">expiration</span><span class="o">=</span><span class="mi">3600</span><span class="p">):</span>
</span><span class="line">    <span class="n">serializer</span> <span class="o">=</span> <span class="n">URLSafeTimedSerializer</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'SECRET_KEY'</span><span class="p">])</span>
</span><span class="line">    <span class="k">try</span><span class="p">:</span>
</span><span class="line">        <span class="n">email</span> <span class="o">=</span> <span class="n">serializer</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
</span><span class="line">            <span class="n">token</span><span class="p">,</span>
</span><span class="line">            <span class="n">salt</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'SECURITY_PASSWORD_SALT'</span><span class="p">],</span>
</span><span class="line">            <span class="n">max_age</span><span class="o">=</span><span class="n">expiration</span>
</span><span class="line">        <span class="p">)</span>
</span><span class="line">    <span class="k">except</span><span class="p">:</span>
</span><span class="line">        <span class="k">return</span> <span class="bp">False</span>
</span><span class="line">    <span class="k">return</span> <span class="n">email</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, in the <code>generate_confirmation_token()</code> function we use the <code>URLSafeTimedSerializer</code> to generate a token using the email address obtained during user registration. The <em>actual</em> email is encoded in the token. Then to confirm the token, within the <code>confirm_token()</code> function, we can use the <code>loads()</code> method, which takes the token and expiration – valid for one hour (3,600 seconds) – as arguments. As long as the token has not expired, then it will return an email.</p>

<p>Be sure to add the <code>SECURITY_PASSWORD_SALT</code> to your app’s config (<code>BaseConfig()</code>):</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">SECURITY_PASSWORD_SALT</span> <span class="o">=</span> <span class="s">'my_precious_two'</span>
</span></code></pre></td></tr></table></div></figure>


<a name="Update..code.register....code..view.function"/>
<h3>Update <code>register()</code> view function</h3>

<p>Now let’s update the <code>register()</code> view function again from <em>project/user/views.py</em>:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="nd">@user_blueprint.route</span><span class="p">(</span><span class="s">'/register'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
</span><span class="line"><span class="k">def</span> <span class="nf">register</span><span class="p">():</span>
</span><span class="line">    <span class="n">form</span> <span class="o">=</span> <span class="n">RegisterForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
</span><span class="line">    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
</span><span class="line">        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
</span><span class="line">            <span class="n">email</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
</span><span class="line">            <span class="n">password</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
</span><span class="line">            <span class="n">confirmed</span><span class="o">=</span><span class="bp">False</span>
</span><span class="line">        <span class="p">)</span>
</span><span class="line">        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class="line">        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span class="line">
</span><span class="line">        <span class="n">token</span> <span class="o">=</span> <span class="n">generate_confirmation_token</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Also, make sure to update the imports:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">project.token</span> <span class="kn">import</span> <span class="n">generate_confirmation_token</span><span class="p">,</span> <span class="n">confirm_token</span>
</span></code></pre></td></tr></table></div></figure>


<a name="Handle.Email.Confirmation"/>
<h3>Handle Email Confirmation</h3>

<p>Next, let’s add a new view to handle the email confirmation:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="nd">@user_blueprint.route</span><span class="p">(</span><span class="s">'/confirm/&lt;token&gt;'</span><span class="p">)</span>
</span><span class="line"><span class="nd">@login_required</span>
</span><span class="line"><span class="k">def</span> <span class="nf">confirm_email</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
</span><span class="line">    <span class="k">try</span><span class="p">:</span>
</span><span class="line">        <span class="n">email</span> <span class="o">=</span> <span class="n">confirm_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
</span><span class="line">    <span class="k">except</span><span class="p">:</span>
</span><span class="line">        <span class="n">flash</span><span class="p">(</span><span class="s">'The confirmation link is invalid or has expired.'</span><span class="p">,</span> <span class="s">'danger'</span><span class="p">)</span>
</span><span class="line">    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">first_or_404</span><span class="p">()</span>
</span><span class="line">    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">confirmed</span><span class="p">:</span>
</span><span class="line">        <span class="n">flash</span><span class="p">(</span><span class="s">'Account already confirmed. Please login.'</span><span class="p">,</span> <span class="s">'success'</span><span class="p">)</span>
</span><span class="line">    <span class="k">else</span><span class="p">:</span>
</span><span class="line">        <span class="n">user</span><span class="o">.</span><span class="n">confirmed</span> <span class="o">=</span> <span class="bp">True</span>
</span><span class="line">        <span class="n">user</span><span class="o">.</span><span class="n">confirmed_on</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</span><span class="line">        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class="line">        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span class="line">        <span class="n">flash</span><span class="p">(</span><span class="s">'You have confirmed your account. Thanks!'</span><span class="p">,</span> <span class="s">'success'</span><span class="p">)</span>
</span><span class="line">    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'main.home'</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Add this to <em>project/user/views.py</em>. Also, be sure to update the imports:</p>

<figure class="code"><figcaption><span/></figcaption></figure>


<p>Here, we call the <code>confirm_token()</code> function, passing in the token. If successful, we update the user, changing the <code>email_confirmed</code> attribute to <code>True</code> and setting the <code>datetime</code> for when the confirmation took place. Also, in case the user already went through the confirmation process – and is confirmed – then we alert the user of this.</p>

<a name="Create.the.email.template"/>
<h3>Create the email template</h3>

<p>Next, let’s add a base email template:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="html"><span class="line"><span class="nt">&lt;p&gt;</span>Welcome! Thanks for signing up. Please follow this link to activate your account:<span class="nt">&lt;/p&gt;</span>
</span><span class="line"><span class="nt">&lt;p&gt;&lt;a</span> <span class="na">href=</span><span class="s">"{{ confirm_url }}"</span><span class="nt">&gt;</span>{{ confirm_url }}<span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
</span><span class="line"><span class="nt">&lt;br&gt;</span>
</span><span class="line"><span class="nt">&lt;p&gt;</span>Cheers!<span class="nt">&lt;/p&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Save this as <em>activate.html</em> in “project/templates/user”. This take a single variable called <code>confirm_url</code>, which will be created in the <code>register()</code> view function.</p>

<a name="Send.email"/>
<h3>Send email</h3>

<p>Let’s create a basic function for sending emails with a little help from <a href="https://pythonhosted.org/flask-mail/">Flask-Mail</a>, which is already installed and setup in <code>project/__init__.py</code>.</p>

<p>Create a file called <em>email.py</em>:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c"># project/email.py</span>
</span><span class="line">
</span><span class="line"><span class="kn">from</span> <span class="nn">flask.ext.mail</span> <span class="kn">import</span> <span class="n">Message</span>
</span><span class="line">
</span><span class="line"><span class="kn">from</span> <span class="nn">project</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">mail</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">send_email</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">template</span><span class="p">):</span>
</span><span class="line">    <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span>
</span><span class="line">        <span class="n">subject</span><span class="p">,</span>
</span><span class="line">        <span class="n">recipients</span><span class="o">=</span><span class="p">[</span><span class="n">to</span><span class="p">],</span>
</span><span class="line">        <span class="n">html</span><span class="o">=</span><span class="n">template</span><span class="p">,</span>
</span><span class="line">        <span class="n">sender</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'MAIL_DEFAULT_SENDER'</span><span class="p">]</span>
</span><span class="line">    <span class="p">)</span>
</span><span class="line">    <span class="n">mail</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Save this in the “project” folder.</p>

<p>So, we simply need to pass a list of recipients, a subject, and a template. We’ll deal with the mail configuration settings in a bit.</p>

<a name="Update..code.register....code..view.function.in.project.user.views.py..again.."/>
<h3>Update <code>register()</code> view function in project/user/views.py (again!)</h3>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="nd">@user_blueprint.route</span><span class="p">(</span><span class="s">'/register'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
</span><span class="line"><span class="k">def</span> <span class="nf">register</span><span class="p">():</span>
</span><span class="line">    <span class="n">form</span> <span class="o">=</span> <span class="n">RegisterForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
</span><span class="line">    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
</span><span class="line">        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
</span><span class="line">            <span class="n">email</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
</span><span class="line">            <span class="n">password</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
</span><span class="line">            <span class="n">confirmed</span><span class="o">=</span><span class="bp">False</span>
</span><span class="line">        <span class="p">)</span>
</span><span class="line">        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class="line">        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span class="line">
</span><span class="line">        <span class="n">token</span> <span class="o">=</span> <span class="n">generate_confirmation_token</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
</span><span class="line">        <span class="n">confirm_url</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s">'user.confirm_email'</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class="line">        <span class="n">html</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'user/activate.html'</span><span class="p">,</span> <span class="n">confirm_url</span><span class="o">=</span><span class="n">confirm_url</span><span class="p">)</span>
</span><span class="line">        <span class="n">subject</span> <span class="o">=</span> <span class="s">"Please confirm your email"</span>
</span><span class="line">        <span class="n">send_email</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">html</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">        <span class="n">login_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">        <span class="n">flash</span><span class="p">(</span><span class="s">'A confirmation email has been sent via email.'</span><span class="p">,</span> <span class="s">'success'</span><span class="p">)</span>
</span><span class="line">        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">"main.home"</span><span class="p">))</span>
</span><span class="line">
</span><span class="line">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'user/register.html'</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Add the following import as well:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">project.email</span> <span class="kn">import</span> <span class="n">send_email</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>Here, we are putting everything together. This function basically acts as a controller (either directly or indirectly) for the entire process:</strong></p>

<ul>
<li>Handle initial registration,</li>
<li>Generate token and confirmation URL,</li>
<li>Send confirmation email,</li>
<li>Flash confirmation,</li>
<li>Log in the user, and</li>
<li>Redirect user.</li>
</ul>


<p>Did you notice the <code>_external=True</code> argument? This adds the full absolute URL that includes the hostname and port (<a href="http://localhost:5000">http://localhost:5000</a>, in our case.)</p>

<p>Before we can test this out, we need to set up our mail settings.</p>

<a name="Mail"/>
<h3>Mail</h3>

<p>Start by updating the <code>BaseConfig()</code> in <em>project/config.py</em>:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">class</span> <span class="nc">BaseConfig</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class="line">    <span class="sd">"""Base configuration."""</span>
</span><span class="line">
</span><span class="line">    <span class="c"># main config</span>
</span><span class="line">    <span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s">'my_precious'</span>
</span><span class="line">    <span class="n">SECURITY_PASSWORD_SALT</span> <span class="o">=</span> <span class="s">'my_precious_two'</span>
</span><span class="line">    <span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class="line">    <span class="n">BCRYPT_LOG_ROUNDS</span> <span class="o">=</span> <span class="mi">13</span>
</span><span class="line">    <span class="n">WTF_CSRF_ENABLED</span> <span class="o">=</span> <span class="bp">True</span>
</span><span class="line">    <span class="n">DEBUG_TB_ENABLED</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class="line">    <span class="n">DEBUG_TB_INTERCEPT_REDIRECTS</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class="line">
</span><span class="line">    <span class="c"># mail settings</span>
</span><span class="line">    <span class="n">MAIL_SERVER</span> <span class="o">=</span> <span class="s">'smtp.googlemail.com'</span>
</span><span class="line">    <span class="n">MAIL_PORT</span> <span class="o">=</span> <span class="mi">465</span>
</span><span class="line">    <span class="n">MAIL_USE_TLS</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class="line">    <span class="n">MAIL_USE_SSL</span> <span class="o">=</span> <span class="bp">True</span>
</span><span class="line">
</span><span class="line">    <span class="c"># gmail authentication</span>
</span><span class="line">    <span class="n">MAIL_USERNAME</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'APP_MAIL_USERNAME'</span><span class="p">]</span>
</span><span class="line">    <span class="n">MAIL_PASSWORD</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'APP_MAIL_PASSWORD'</span><span class="p">]</span>
</span><span class="line">
</span><span class="line">    <span class="c"># mail accounts</span>
</span><span class="line">    <span class="n">MAIL_DEFAULT_SENDER</span> <span class="o">=</span> <span class="s">'from@example.com'</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Check out the <a href="https://pythonhosted.org/flask-mail/#configuring-flask-mail">official Flask-Mail documentation</a> for more info.</p></blockquote>

<p>If you already have a GMAIL account then you can use that or register a test GMAIL account. Then set the environment variables temporarily in the current shell session:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span><span class="nb">export </span><span class="nv">APP_MAIL_USERNAME</span><span class="o">=</span><span class="s2">"foo"</span>
</span><span class="line"><span class="nv">$ </span><span class="nb">export </span><span class="nv">APP_MAIL_PASSWORD</span><span class="o">=</span><span class="s2">"bar"</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>If your GMAIL account has <a href="https://support.google.com/accounts/topic/28786?hl=en&amp;ref_topic=3382253">2-step authentication</a>, Google will block the attempt.</p></blockquote>

<p>Now let’s test!</p>

<a name="First.test"/>
<h2>First test</h2>

<p>Fire up the app, and navigate to <a href="http://localhost:5000/register">http://localhost:5000/register</a>. Then register with an email address that you have access to. If all went well, you should have an email in your inbox that looks something like this:</p>














<p>Click the URL and you should be taken to <a href="http://localhost:5000/">http://localhost:5000/</a>. Make sure that the user is in the database, the ‘confirmed’ field is <code>True</code>, and there is a <code>datetime</code> associated with the <code>confirmed_on</code> field.</p>

<p>Nice!</p>

<a name="Handle.permissions"/>
<h2>Handle permissions</h2>

<p>If you remember, at the beginning of this tutorial, we decided that “unconfirmed users can log in but they should be immediately redirected to a page – let’s call the route <code>/unconfirmed</code> – reminding users that they need to confirm their account before they can access the application”.</p>

<p>So, we need to-</p>

<ol>
<li>Add the <code>/unconfirmed</code> route</li>
<li>Add an <em>unconfirmed.html</em> template</li>
<li>Update the <code>register()</code> view function</li>
<li>Create a decorator</li>
<li>Update <em>navigation.html</em> template</li>
</ol>


<a name="Add..code..unconfirmed..code..route"/>
<h3>Add <code>/unconfirmed</code> route</h3>

<p>Add the following route to <em>project/user/views.py</em>:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="nd">@user_blueprint.route</span><span class="p">(</span><span class="s">'/unconfirmed'</span><span class="p">)</span>
</span><span class="line"><span class="nd">@login_required</span>
</span><span class="line"><span class="k">def</span> <span class="nf">unconfirmed</span><span class="p">():</span>
</span><span class="line">    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">confirmed</span><span class="p">:</span>
</span><span class="line">        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'main.home'</span><span class="p">)</span>
</span><span class="line">    <span class="n">flash</span><span class="p">(</span><span class="s">'Please confirm your account!'</span><span class="p">,</span> <span class="s">'warning'</span><span class="p">)</span>
</span><span class="line">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'user/unconfirmed.html'</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>You’ve seen similar code before, so let’s move on.</p>

<a name="Add..em.unconfirmed.html..em..template"/>
<h3>Add <em>unconfirmed.html</em> template</h3>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="html"><span class="line">{% extends "_base.html" %}
</span><span class="line">
</span><span class="line">{% block content %}
</span><span class="line">
</span><span class="line"><span class="nt">&lt;h1&gt;</span>Welcome!<span class="nt">&lt;/h1&gt;</span>
</span><span class="line"><span class="nt">&lt;br&gt;</span>
</span><span class="line"><span class="nt">&lt;p&gt;</span>You have not confirmed your account. Please check your inbox (and your spam folder) - you should have received an email with a confirmation link.<span class="nt">&lt;/p&gt;</span>
</span><span class="line"><span class="nt">&lt;p&gt;</span>Didn't get the email? <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/"</span><span class="nt">&gt;</span>Resend<span class="nt">&lt;/a&gt;</span>.<span class="nt">&lt;/p&gt;</span>
</span><span class="line">
</span><span class="line">{% endblock %}
</span></code></pre></td></tr></table></div></figure>


<p>Save this as <em>unconfirmed.html</em> in “project/templates/user”. Again, this should all be straightforward. For now, we just added a dummy URL in for resending the confirmation email. We’ll address this further down.</p>

<a name="Update.the..code.register....code..view.function"/>
<h3>Update the <code>register()</code> view function</h3>

<p>Now simply change:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">"main.home"</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>To:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">"user.unconfirmed"</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, after the confirmation email is sent, the user is now redirected to the <code>/unconfirmed</code> route.</p>

<a name="Create.a.decorator"/>
<h3>Create a decorator</h3>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c"># project/decorators.py</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
</span><span class="line">
</span><span class="line"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">flash</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">flask.ext.login</span> <span class="kn">import</span> <span class="n">current_user</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">check_confirmed</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
</span><span class="line">    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">decorated_function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span class="line">        <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">confirmed</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
</span><span class="line">            <span class="n">flash</span><span class="p">(</span><span class="s">'Please confirm your account!'</span><span class="p">,</span> <span class="s">'warning'</span><span class="p">)</span>
</span><span class="line">            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'user.unconfirmed'</span><span class="p">))</span>
</span><span class="line">        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">return</span> <span class="n">decorated_function</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we have a basic function to check if a user is unconfirmed. If unconfirmed, the user is redirected to the <code>/unconfirmed</code> route. Save this as <em>decorators.py</em> in the “project” directory.</p>

<p>Now, decorate the <code>profile()</code> view function:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="nd">@user_blueprint.route</span><span class="p">(</span><span class="s">'/profile'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
</span><span class="line"><span class="nd">@login_required</span>
</span><span class="line"><span class="nd">@check_confirmed</span>
</span><span class="line"><span class="k">def</span> <span class="nf">profile</span><span class="p">():</span>
</span><span class="line">    <span class="o">...</span> <span class="n">snip</span> <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>Make sure to import the decorator:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">project.decorators</span> <span class="kn">import</span> <span class="n">check_confirmed</span>
</span></code></pre></td></tr></table></div></figure>


<a name="Update..em.navigation.html..em..template"/>
<h3>Update <em>navigation.html</em> template</h3>

<p>Finally, update the following part of the <em>navigation.html</em> template-</p>

<p>Change:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="html"><span class="line"><span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav navbar-nav"</span><span class="nt">&gt;</span>
</span><span class="line">  {% if current_user.is_authenticated() %}
</span><span class="line">    <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"{{ url_for('user.profile') }}"</span><span class="nt">&gt;</span>Profile<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
</span><span class="line">  {% endif %}
</span><span class="line"><span class="nt">&lt;/ul&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>To:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="html"><span class="line"><span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav navbar-nav"</span><span class="nt">&gt;</span>
</span><span class="line">  {% if current_user.confirmed and current_user.is_authenticated() %}
</span><span class="line">    <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"{{ url_for('user.profile') }}"</span><span class="nt">&gt;</span>Profile<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
</span><span class="line">  {% elif current_user.is_authenticated() %}
</span><span class="line">    <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"{{ url_for('user.unconfirmed') }}"</span><span class="nt">&gt;</span>Confirm<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
</span><span class="line">  {% endif %}
</span><span class="line"><span class="nt">&lt;/ul&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Time to test again!</p>

<a name="Second.test"/>
<h2>Second test</h2>

<p>Fire up the app, and register again with an email address that you have access to. (Feel free to delete the old user that you registered before first from the database to use again.) Now you should be redirected to <a href="http://localhost:5000/unconfirmed">http://localhost:5000/unconfirmed</a> after registration.</p>

<p>Make sure to test the <a href="http://localhost:5000/profile">http://localhost:5000/profile</a> route. This should redirect you to <a href="http://localhost:5000/unconfirmed">http://localhost:5000/unconfirmed</a>.</p>

<p>Go ahead and confirm the email, and you will have access to all pages. Boom!</p>

<a name="Resend.email"/>
<h2>Resend email</h2>

<p>Finally, let’s get the resend link working. Add the following view function to <em>project/user/views.py</em>:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="nd">@user_blueprint.route</span><span class="p">(</span><span class="s">'/resend'</span><span class="p">)</span>
</span><span class="line"><span class="nd">@login_required</span>
</span><span class="line"><span class="k">def</span> <span class="nf">resend_confirmation</span><span class="p">():</span>
</span><span class="line">    <span class="n">token</span> <span class="o">=</span> <span class="n">generate_confirmation_token</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
</span><span class="line">    <span class="n">confirm_url</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s">'user.confirm_email'</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class="line">    <span class="n">html</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'user/activate.html'</span><span class="p">,</span> <span class="n">confirm_url</span><span class="o">=</span><span class="n">confirm_url</span><span class="p">)</span>
</span><span class="line">    <span class="n">subject</span> <span class="o">=</span> <span class="s">"Please confirm your email"</span>
</span><span class="line">    <span class="n">send_email</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">html</span><span class="p">)</span>
</span><span class="line">    <span class="n">flash</span><span class="p">(</span><span class="s">'A new confirmation email has been sent.'</span><span class="p">,</span> <span class="s">'success'</span><span class="p">)</span>
</span><span class="line">    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'user.unconfirmed'</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now update the <em>unconfirmed.html</em> template:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="html"><span class="line">{% extends "_base.html" %}
</span><span class="line">
</span><span class="line">{% block content %}
</span><span class="line">
</span><span class="line"><span class="nt">&lt;h1&gt;</span>Welcome!<span class="nt">&lt;/h1&gt;</span>
</span><span class="line"><span class="nt">&lt;br&gt;</span>
</span><span class="line"><span class="nt">&lt;p&gt;</span>You have not confirmed your account. Please check your inbox (and your spam folder) - you should have received an email with a confirmation link.<span class="nt">&lt;/p&gt;</span>
</span><span class="line"><span class="nt">&lt;p&gt;</span>Didn't get the email? <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{{ url_for('user.resend_confirmation') }}"</span><span class="nt">&gt;</span>Resend<span class="nt">&lt;/a&gt;</span>.<span class="nt">&lt;/p&gt;</span>
</span><span class="line">
</span><span class="line">{% endblock %}
</span></code></pre></td></tr></table></div></figure>


<a name="Third.test"/>
<h2>Third test</h2>

<p>You know the drill. This time make sure to resend a new confirmation email and test the link. It should work.</p>

<p>Finally, what happens if you send yourself a few confirmation links? Are each valid? Test it out. Register a new user, and then send a few new confirmation emails. Try to confirm with the first email. Did it work? It should. Is this okay? Do you think those other emails should expire if a new one is sent?</p>

<p>Do some research on this. And test out other web applications that you use. How do they handle such behavior?</p>

<a name="Update.test.suite"/>
<h2>Update test suite</h2>

<p>Alright. So that’s it for the main functionality. How about we update the current test suite since it’s, well, broken.</p>

<p>Run the tests:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>python manage.py <span class="nb">test</span>
</span></code></pre></td></tr></table></div></figure>


<p>You should see the following error:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line">TypeError: __init__<span class="o">()</span> takes at least 4 arguments <span class="o">(</span>3 given<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>To correct this we just need to update the <code>setUp()</code> method in <em>project/util.py</em>:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">    <span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>
</span><span class="line">    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s">"ad@min.com"</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">"admin_user"</span><span class="p">,</span> <span class="n">confirmed</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span class="line">    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class="line">    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now run the tests again. All should pass!</p>

<a name="Conclusion"/>
<h2>Conclusion</h2>

<p>There’s clearly a lot more we can do:</p>

<ol>
<li>Rich vs. plain text emails – We should be sending out both.</li>
<li>Reset password email – These should be sent out for users that have forgotten their passwords.</li>
<li>User management – We should allow users to update their emails and passwords, and when an email is changed, it should be confirmed again.</li>
<li><a href="https://realpython.com/blog/python/the-minimum-viable-test-suite/">Testing – We need to write more tests to cover the new features.</a></li>
</ol>





<p>Download the entire source code from the <a href="https://github.com/realpython/flask-registration">Github repository</a>. Comment below with questions. Check out <a href="https://realpython.com/blog/python/the-minimum-viable-test-suite/">part 2</a>.</p>

<p>Happy holidays!</p>






<p>
  <em>Edits made by <a href="https://twitter.com/diek007">Derrick Kearney</a>. Thank you!</em>
</p>

</div>


      </div></body></html>