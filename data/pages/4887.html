<html><body><div><section class="post-content">
            <p>Google Analytics is a great platform for people to want to get to know what is happening with your users, and a good alternative if you cannot host your own analytics software, or just don't want to. <br/>
It's a great first step to on your way to help improving your SEO footprint; working with keywords, seeing how campaigns are tracking, how your users interact with your site and from where, via referrers. This brings us to the problem that all SEO companies and people who work with low-to-medium traffic websites end up dealing with and no-one really has a real answer or solution to. Referrer spam.</p>

<h4 id="whatarereferrersabriefintroductionandhistory">What are referrers? A brief introduction and history.</h4>

<p>Some small background on referrers is a must (or not, you could skip it) before we follow on. <br/>
Referrers are used by web servers (such as nginx &amp; apache); browsers (firefox, chrome); and nearly anything that is connected to the web. Funnily enough they indicate where a user was 'referred' from. This was part of the original specification for the HTTP specification that the world wide web now exists on. <br/>
Referrers are useful information that can be used by website operators, which is nearly everyone and their dog nowadays (including dog fan pages) to figure out who is linking to their site around the web. </p>

<p>If you were to visit this blog, at <a href="https://blog.slowb.ro">https://blog.slowb.ro</a> and click this post your browser would make a request similar to the following example. The server operator, (Me) can see that you started from the home page and clicked on this post. (I have highlighted the referrer in bold for you)</p>

<blockquote>
  <p>10.0.0.101 - - [10/Jun/XXXX:XX:XX:XX +XXXX] "GET /google-analytics-filter-whitelister-in-python HTTP/1.1" 200 0 "<strong><a href="https://blog.slowb.ro/">https://blog.slowb.ro/</a></strong>" "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Ubuntu Chromium/41.0.2272.76 Chrome/41.0.2272.76 Safari/537.36"</p>
</blockquote>

<p>It shows a valuable amount of information about the user, such as:</p>

<ul>
<li>Operating system: Ubuntu</li>
<li>Browser:  Chromium</li>
<li>Page: /beat-google-analytics-referrer-spam-programmatically</li>
<li>IP: 10.0.0.101</li>
<li>Referrer: <a href="http://blog.slowb.ro/">http://blog.slowb.ro/</a></li>
</ul>

<p>This is all information the client has given us just by visiting our site. We accept all data at face value and assume that data is correct. This is the reason why referrer spam exists. "Companies" use the good nature of web servers that trust the user, to make requests to websites with a "fake" referrer header. As far as the web server is concerned its a real referral. Technically it is. Anything can be in the referrer. Just as anything can be the Operating system, and anything can in the "User Agent" field. </p>

<p>Now when you browse your latest analytics data from google and see all these random sites you might of never heard of at the top of your referrer list. You end up visiting the site, and you can see it obviously has nothing to do with your site and they are doing it for their own malicious purposes. Or maybe its not obvious. But if you cannot find a direct link to your site, on the page your just viewed, then it's more than likely a nefarious company. Their goals are their own, but I feel confident on speculating that its either traffic or revenue related. Each site will have its own motives. 99% of the time its always revenue related. </p>

<p><img src="https://slowb.ro/upload/server/php/files/nd5bot204pu7mfjm3bj6cr8o86/Screenshot%20from%202015-06-10%2018%3A34%3A16.png" alt="Analytics Data showing Referrer Spam"/></p>

<h4 id="referrerspam">Referrer spam.</h4>

<p>Lately I was tasked to help our company deal with our own referrer spam problems for our clients and the original solution I proposed (which is certainly not new) is to filter out all the referrers that are known spammers not at the analytics level, but at the web server level. Stop them before they even reaching the server. That was the plan atleast. Thus the javascript for these "users" would never end up being executed. This proved successful for a good portion of the spammers who, (I suspect) used actual browsers which conformed to the HTTP standards. Or they used a browser framework such as phantomjs or selenium, which are highly scriptable and configurable to do just about anything. </p>

<p>The image above was taken from this blog's (old) Google Analytics account. Which I used originally when I started blogging before moving on to <a href="https://piwik.org/">piwik</a>, a self hosted analytics platform. What these companies don't know, is that I have stopped using Google Analytics for the past 3 months. This is not because of referral spam, it's for my own personal <em>lets not give google too much power</em>. These companies are the worst of the bunch. They don't even have the decency to view your page. I searched all the log files on my server (and our production logs) for any indication of these referrers. But to no avail. They must run the javascript code with your UA-xxxx-xx tag through, what I assume, would be open proxies and set the referrer url to be whatever they desire. As javascipt is never run by our webserver, only in the clients browser they could easily scrape your page once for your UA code, using a script similar to the one over <a href="https://blog.slowb.ro/google-analytics-code-scraper/">here</a>. Then in their leisure time, cycle through open proxies (or tor exit nodes) for all the UA codes they have found. Then just wait for all the users to click on the new "top" referrer for the week.</p>

<p>Blocking referrers at the webserver level would only work if these people played ball. Unfortunately I needed to come up with another solution that would be able to be rolled out to our 4000 "views" (also known as profiles)</p>

<h5 id="codingasolution">Coding a solution.</h5>

<p><img src="https://slowb.ro/upload/server/php/files/3mr8llo30f91gb4d4rpg1rdn07/gaManagementModel.png" alt="Google API Analytics Overview"/></p>

<p>My final and current solution (as of this post) is to programmatically add and remove our filters and to attach them to all the views under our umbrella analytics account. </p>

<p>Google Analytics is quite convoluted to say the least. The above picture shows the hierarchy of the analytics platform. If you wish to learn how everything works together, the latest management API is <a href="https://developers.google.com/analytics/devguides/config/mgmt/v3/">here</a>. You can do a lot more than just add and remove filters programmatically. You could develop your own dashboard by pulling in the data from the analytics api, or create a webpage application to manage all your sites. (Which if I had the time, I would love to do)</p>

<p>If you are a company with more than a few sites and wanting to implement this solution you will need to follow the <a href="https://developers.google.com/analytics/devguides/reporting/core/v3/quickstart/service-py">API tutorial for Python</a> as stated in the analytics documentation. </p>

<p>tl;dr for the setup guide: </p>

<ul>
<li>Create a project in the <a href="https://console.developers.google.com/">Google Developers Console</a>. </li>
<li>Enable all the API's needed. </li>
<li>Download the Service Account's client_secrets.json. (into the same directory as the python scripts)</li>
<li>run python analytics<em>api</em>v3_auth.py</li>
</ul>

<p>If you are a user with a simple website with just one or two sites and just want all these referrers to disappear. Google has a <a href="https://support.google.com/analytics/answer/1034823?hl=en#CreateFilterAccountLevel">howto</a> in managing filters. But here is a pretty picture as well on how to create one. (You will need to create two filters for it to block everything)</p>

<p><img src="https://slowb.ro/upload/server/php/files/p7ibuosk29ajf9d39osus5v5m0/Google-Analytics-Example.png" alt="Analytics Example of Creating a referrer"/></p>

<p>Current Filters 15/06/10:  </p>

<pre><code>.*((darodar|priceg|semalt|buttons-for(-your)?-website|makemoneyonline|blackhatworth|hulfingtonpost|o-o-6-o-o|(social|(simple|free)-share)-buttons|best-seo-(solution|offer)|googlsucks|bestwebsitesawards)\.com)
.*((econom\.co|ilovevitaly\.(co(m)?|ru)|(humanorightswatch|guardlink|smailik|webmasters|nticrawler)\.org)|(get-free-traffic-now|alivematrix)\.com)|(youporn-forum)
</code></pre>

<h6 id="filtercreator">Filter Creator</h6>



<h6 id="authenticationmechanism">Authentication Mechanism</h6>



<h4 id="pitfalls">Pitfalls.</h4>

<p>Unfortunately, all <em>they</em> have to do is register a new domain, redirect it to their main one, and continuing spamming Google Analytics again. Hey presto, they just bypassed all our newly created filters. <br/>
If you are not a "power user", the developer API has a daily limit of 500 writes for analytics objects. This means you need 1 write per filter object, and 1 write per linking of the filter to the view. So if you have 1 domain per account, it will take 3 writes to set it up. You don't need a mathematics degree to know that if you have a huge amount of domains (over 200) then you will have to do multiple batches. (The script already handles that for you) <br/>
This does <strong>not</strong> change historical data. These filters will only be applied to all future data from the date added. </p>

<h4 id="ideasforthefutureothersolutions">Ideas for the future &amp; other solutions.</h4>

<p>This isn't a solution unfortunately, it's more of a bandage over a broken arm that is a serious referrer problem. There are a few things you can do to minimise the amount of referrers your sites get.</p>

<ul>
<li>Block the referrers in nginx/apache</li>
<li>Leave Google Analytics behind for a Open Source solution: <a href="https://piwik.org">Piwik</a>
<ul><li>They even have a 'cloud' platform if you cannot host it yourself. </li></ul></li>
</ul>

<p>I have not received any referrer spam since running piwik. Which is going on 4 years now. Seems they are only targeting Analytics currently. </p>
        </section>
        
            
            </div></body></html>