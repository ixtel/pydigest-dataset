<html><body><div><div class="right_panel">
    <a href="/blog/2014/12/how-not-knowing-encoding-can-trip-you/" class="noline"><h1 class="post_title" itemprop="headline">How not knowing encoding can trip you</h1></a>
    
    
      <p/><p>Our Scenario:</p>
<ul>
<li>You are provided with a link to a file on the internet.</li>
<li>Download and read this file</li>
<li>Insert read value into the database</li>
</ul>
<p>Make sure your terminal encoding is set to utf-8. Most probably that would be the default so you would not require any change.</p>
<p>There could be other similar scenarios. Another collaborator on your project adds a file containing some data in version control. You have to read the file and insert this data in database.</p>
<p>I have added one file to Dropbox. We will use this file in our example. Link for the file is <a href="https://www.dropbox.com/s/arcz0jsinipuixp/latin_encoded.txt?dl=0" target="_blank">https://www.dropbox.com/s/arcz0jsinipuixp/latin_encoded.txt?dl=0</a></p>
<p>You can't read the contents of this file using 'urllib' or 'requests' because then you will get html page source for this link. So download the file on your machine.</p>
<p>Read this file:</p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="err">'</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">akshar</span><span class="o">/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">latin_encoded</span><span class="p">.</span><span class="n">txt</span><span class="err">'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">read_value</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">type</span><span class="p">(</span><span class="n">read_value</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">type</span> <span class="err">'</span><span class="n">str</span><span class="err">'</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">print</span> <span class="n">read_value</span>
<span class="err">ï¿½</span>
</pre></div>


<p>As you are aware, reading a file gives a 'str' and doesn't give a 'unicode'. And remember, 'str' means encoded 'unicode'? We try to print it. It seems the file content was encoded using a encoding scheme which our terminal doesn't understand, that's why it shows question mark. Terminal understands 'utf-8' encoded content by default. Seems file content was encoded with an encoding other that 'utf-8'. And you don't know what encoding that was.</p>
<p>Anyways without caring about it, let's try to write our read_value into PostgreSQL db.</p>
<p>If you require help setting up the database, see <a href="#database-setup">database setup section</a> at bottom.</p>
<p>Let's write the script to read from the file and insert in db.</p>
<div class="highlight"><pre><span class="cp"># You can save it in psyco.py</span>
<span class="n">import</span> <span class="n">psycopg2</span>

<span class="n">conn_string</span> <span class="o">=</span> <span class="s">"host='localhost' dbname='hack' user='jack' password='crack'"</span>
<span class="n">print</span> <span class="s">"Connecting to database</span><span class="se">\n</span><span class="s"> -&gt;%s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">conn_string</span><span class="p">)</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">conn_string</span><span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">print</span> <span class="s">"Connected!</span><span class="se">\n</span><span class="s">"</span>
<span class="cp"># You need to change file path to your ~/Downloads folder</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="err">'</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">akshar</span><span class="o">/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">latin_encoded</span><span class="p">.</span><span class="n">txt</span><span class="err">'</span><span class="p">)</span>
<span class="n">read_value</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">f</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">cursor</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"insert into names values ('%s')"</span> <span class="o">%</span> <span class="p">(</span><span class="n">read_value</span><span class="p">,))</span>
<span class="n">conn</span><span class="p">.</span><span class="n">commit</span><span class="p">()</span>
<span class="n">print</span> <span class="s">"Inserted</span><span class="se">\n</span><span class="s">"</span>
</pre></div>


<p>Run the script:</p>



<p>Boom! You must have got an error:</p>
<div class="highlight"><pre><span class="p">(</span><span class="nx">hack</span><span class="p">)/</span><span class="k">private</span><span class="p">/</span><span class="nx">tmp</span> <span class="err">$</span> <span class="nx">python</span> <span class="nx">psyco.py</span>
<span class="nx">Connecting</span> <span class="k">to</span> <span class="nx">database</span>
 <span class="o">-&gt;</span><span class="nb">host</span><span class="o">=</span><span class="s1">'localhost'</span> <span class="n">dbname</span><span class="o">=</span><span class="s1">'hack'</span> <span class="n">user</span><span class="o">=</span><span class="s1">'jack'</span> <span class="n">password</span><span class="o">=</span><span class="s1">'crack'</span>
<span class="nx">Connected</span><span class="o">!</span>

<span class="nx">Traceback</span> <span class="p">(</span><span class="nx">most</span> <span class="nx">recent</span> <span class="nb">call</span> <span class="nb">last</span><span class="p">):</span>
  <span class="nb">File</span> <span class="s2">"psyco.py"</span><span class="p">,</span> <span class="nb">line</span> <span class="mi">15</span><span class="p">,</span> <span class="k">in</span> <span class="o">&lt;</span><span class="nx">module</span><span class="o">&gt;</span>
    <span class="nx">cursor.execute</span><span class="p">(</span><span class="s2">"insert into names values ('%s')"</span> <span class="o">%</span> <span class="p">(</span><span class="nx">read_value</span><span class="p">,))</span>
<span class="nx">psycopg2.DataError</span><span class="p">:</span> <span class="nx">invalid</span> <span class="nx">byte</span> <span class="nx">sequence</span> <span class="nb">for</span> <span class="nb">encoding</span> <span class="s2">"UTF8"</span><span class="p">:</span> <span class="mh">0xe4</span> <span class="mh">0x27</span> <span class="mh">0x29</span>
</pre></div>


<p>So Python tried to insert read_value to db. read_value was encoded using some encoding scheme which we don't know. Database's default encoding scheme is UTF8. So db tries to decode whatever you are trying to insert with utf8. But in utf8 the byte sequence we are trying to insert doesn't correspond to any codepoint and so decoding fails. And hence an error was raised.</p>
<p>So we must know what is the encoding of read_value. After reading from file, read_value should be decoded using the known encoding scheme and then encoded back to utf8. It should be encoded back to utf8 because our db works with utf8.</p>
<p>Now I tell you, the file which you have downloaded is encoded with encoding scheme '8859'.</p>
<p>So we will have to make following change:</p>
<div class="highlight"><pre><span class="n">decoded_read_value</span> <span class="o">=</span> <span class="n">read_value</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="err">'</span><span class="mi">8859</span><span class="err">'</span><span class="p">)</span>
<span class="n">read_value</span> <span class="o">=</span> <span class="n">decoded_read_value</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="err">'</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span><span class="err">'</span><span class="p">)</span>
</pre></div>


<p>So final script becomes:</p>
<div class="highlight"><pre><span class="n">import</span> <span class="n">psycopg2</span>

<span class="n">conn_string</span> <span class="o">=</span> <span class="s">"host='localhost' dbname='hack' user='jack' password='crack'"</span>
<span class="n">print</span> <span class="s">"Connecting to database</span><span class="se">\n</span><span class="s"> -&gt;%s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">conn_string</span><span class="p">)</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">conn_string</span><span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">print</span> <span class="s">"Connected!</span><span class="se">\n</span><span class="s">"</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="err">'</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">akshar</span><span class="o">/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">latin_encoded</span><span class="p">.</span><span class="n">txt</span><span class="err">'</span><span class="p">)</span>
<span class="n">read_value</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">f</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">decoded_read_value</span> <span class="o">=</span> <span class="n">read_value</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="err">'</span><span class="mi">8859</span><span class="err">'</span><span class="p">)</span>
<span class="n">read_value</span> <span class="o">=</span> <span class="n">decoded_read_value</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="err">'</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span><span class="err">'</span><span class="p">)</span>
<span class="n">cursor</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"insert into names values ('%s')"</span> <span class="o">%</span> <span class="p">(</span><span class="n">read_value</span><span class="p">,))</span>
<span class="n">conn</span><span class="p">.</span><span class="n">commit</span><span class="p">()</span>
<span class="n">print</span> <span class="s">"Inserted</span><span class="se">\n</span><span class="s">"</span>
</pre></div>


<p>Run the script:</p>
<div class="highlight"><pre><span class="p">(</span><span class="n">hack</span><span class="p">)</span><span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">tmp</span> <span class="err">$</span> <span class="n">python</span> <span class="n">psyco</span><span class="p">.</span><span class="n">py</span>
<span class="n">Connecting</span> <span class="n">to</span> <span class="n">database</span>
 <span class="o">-&gt;</span><span class="n">host</span><span class="o">=</span><span class="err">'</span><span class="n">localhost</span><span class="err">'</span> <span class="n">dbname</span><span class="o">=</span><span class="err">'</span><span class="n">hack</span><span class="err">'</span> <span class="n">user</span><span class="o">=</span><span class="err">'</span><span class="n">jack</span><span class="err">'</span> <span class="n">password</span><span class="o">=</span><span class="err">'</span><span class="n">crack</span><span class="err">'</span>
<span class="n">Connected</span><span class="o">!</span>

<span class="n">Inserted</span>
</pre></div>


<p>Seems insert operation worked properly.</p>
<p>Check db content now:</p>
<div class="highlight"><pre><span class="n">hack</span><span class="o">=&gt;</span> <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">names</span><span class="p">;</span>
 <span class="n">name</span>
<span class="o">------</span>
 <span class="err">Ã¤</span>
<span class="p">(</span><span class="mi">1</span> <span class="n">row</span><span class="p">)</span>
</pre></div>


<p>So you had to know the encoding of file to make it work. Unless you knew the encoding of file you wouldn't have been able to decode it.</p>


<div class="highlight"><pre><span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">tmp</span> <span class="err">$</span> <span class="n">psql</span>

<span class="n">akshar</span><span class="o">=</span><span class="err">#</span> <span class="n">create</span> <span class="n">database</span> <span class="n">hack</span><span class="p">;</span>
<span class="n">CREATE</span> <span class="n">DATABASE</span>

<span class="n">akshar</span><span class="o">=</span><span class="err">#</span> <span class="n">create</span> <span class="n">user</span> <span class="n">jack</span> <span class="n">with</span> <span class="n">password</span> <span class="err">'</span><span class="n">crack</span><span class="err">'</span><span class="p">;</span>
<span class="n">CREATE</span> <span class="n">ROLE</span>

<span class="n">akshar</span><span class="o">=</span><span class="err">#</span> <span class="n">grant</span> <span class="n">all</span> <span class="n">privileges</span> <span class="n">on</span> <span class="n">database</span> <span class="n">hack</span> <span class="n">to</span> <span class="n">jack</span><span class="p">;</span>
<span class="n">GRANT</span>
</pre></div>


<p>Close db connection.</p>
<p>Connect to this db as 'jack' and create a table. You should create the table as user 'jack' otherwise you'll not be able to insert into the table when connected as jack.</p>
<div class="highlight"><pre><span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">tmp</span> <span class="err">$</span> <span class="n">psql</span> <span class="n">hack</span> <span class="o">--</span><span class="n">username</span><span class="o">=</span><span class="n">jack</span> <span class="o">-</span><span class="n">W</span>
<span class="n">Password</span> <span class="k">for</span> <span class="n">user</span> <span class="n">jack</span><span class="o">:</span> <span class="n">crack</span>

<span class="n">hack</span><span class="o">=&gt;</span> <span class="n">create</span> <span class="n">table</span> <span class="n">names</span><span class="p">(</span><span class="n">name</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>
<span class="n">CREATE</span> <span class="n">TABLE</span>
</pre></div>


<p>Close db connection.</p>

      
          <hr/>
          
      

      
      
        <h4>Related Posts</h4>
        
      

      <hr/>
      <p>Can we help you build amazing apps? <a href="/contactus">Contact us today.</a>
    
    </p> 


  </div>
</div></body></html>