<html><body><div><article class="post-content">
    <p>As many programmers who use Python for their scientific work, I really like the IPython notebook interface. However, using a German keyboard, I got annoyed by IPython’s hotkeys. Many of them just won’t work with a non-US-keyboard-layout. After a while of unsuccessful research about how to change them, I inally found a way to change them.</p>

<p>After a few hours of pointless googleing, the kind response on my <a href="https://github.com/ipython/ipython/issues/8586">github issue</a> from <a href="https://github.com/Carreau">Matthias Bussonnier</a>, one of IPython’s developers, got me on the right track. In the following I want to briefly summarize <a href="http://carreau.gitbooks.io/jupyter-book/content/keyboardshortcut.html">his documentation</a> on this feature and explain how I changed my keyboard shortcuts.</p>

<p>The backend of the IPython notebook, as you probably know, is based on JavaScript. Therefore, the implementation of all IDE features is as well. Knowing JavaScript, you can customize the hell out of your IPython notebook; the only challenge is to find to appropriate commands.</p>

<p>For testing and understanding purposes, I suggest to open a IPython notebook now.</p>

<p>First, we gonna need the list of predefined functions we can create hotkeys for. The easiest way is to run the following lines od code in your browser’s JavaScript console (“crtl+shift+J” to open in Chrome and “crtl+shift+K” in Firefox).</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">$</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span>
     <span class="nx">IPython</span><span class="p">.</span><span class="nx">keyboard_manager</span><span class="p">.</span><span class="nx">command_shortcuts</span><span class="p">.</span><span class="nx">actions</span><span class="p">.</span><span class="nx">_actions</span><span class="p">,</span>
     <span class="kd">function</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span><span class="nx">v</span><span class="p">){</span><span class="k">return</span> <span class="nx">v</span><span class="p">}</span>
     <span class="p">)</span></code></pre></div>

<p>This should print out a long list of commands to your console. Fortunately, the names are all self-explanatory. However, this is only a small selection of the available commands, since not all of them are handled by the keyboard_manager. Still, there a some commands I want have new key-bindings for.<br/>
To do so, we have to run some more lines of JavaScript. Using the <code>%%JavaScript</code> cell-magic, we can play with the JavaScript settings directly from inside our notebook.</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="o">%%</span><span class="nx">JavaScript</span>
<span class="nx">IPython</span><span class="p">.</span><span class="nx">keyboard_manager</span><span class="p">.</span><span class="nx">command_shortcuts</span><span class="p">.</span><span class="nx">add_shortcut</span><span class="p">(</span><span class="s1">'Shift-k'</span><span class="p">,</span><span class="s1">'ipython.move-selected-cell-up'</span><span class="p">)</span>
<span class="nx">IPython</span><span class="p">.</span><span class="nx">keyboard_manager</span><span class="p">.</span><span class="nx">command_shortcuts</span><span class="p">.</span><span class="nx">add_shortcut</span><span class="p">(</span><span class="s1">'Shift-j'</span><span class="p">,</span><span class="s1">'ipython.move-selected-cell-down'</span><span class="p">)</span></code></pre></div>

<p>So, basically we are just using the provided add_shortcut function to connect a key press with an action.<br/>
You can remove a key-bining in the same manner:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="o">%%</span><span class="nx">JavaScript</span>
<span class="nx">IPython</span><span class="p">.</span><span class="nx">keyboard_manager</span><span class="p">.</span><span class="nx">command_shortcuts</span><span class="p">.</span><span class="nx">remove_shortcut</span><span class="p">(</span><span class="s1">'Shift-k'</span><span class="p">)</span></code></pre></div>

<p>As said, we are limited in terms of available functions using this method. The get access to many of the line based commands we have to dig deeper into “Code Mirror”, the JavaScript based code editor which powers the notebook. This means, we have to create our own <code>actions</code> based on its API instead of using predefined ones.</p>

<p>The basic structure of a new command looks like this (example modified from <a href="https://github.com/juhasch/IPython-notebook-extensions/blob/master/usability/comment-uncomment.js">here</a>):</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="s1">'Alt-3'</span> <span class="o">:</span> <span class="p">{</span>
    <span class="nx">help</span>    <span class="o">:</span> <span class="s1">'Toggle comments'</span><span class="p">,</span>
    <span class="nx">help_index</span> <span class="o">:</span> <span class="s1">'zz'</span><span class="p">,</span>
    <span class="nx">handler</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">env</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">cm</span><span class="o">=</span><span class="nx">env</span><span class="p">.</span><span class="nx">notebook</span><span class="p">.</span><span class="nx">get_selected_cell</span><span class="p">().</span><span class="nx">code_mirror</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">from</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">getCursor</span><span class="p">(</span><span class="s2">"start"</span><span class="p">),</span> <span class="nx">to</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">getCursor</span><span class="p">(</span><span class="s2">"end"</span><span class="p">);</span>
        <span class="nx">cm</span><span class="p">.</span><span class="nx">uncomment</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">)</span> <span class="o">||</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">lineComment</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span></code></pre></div>

<p>So, we start off with the new shortcut (‘Alt-3’) followed by its assigned attributes. The <em>help</em>-parameter helds the tooltip for our new action and the <em>help_index</em>-parameter defines the sorting position in the shortcut list (zz = at the end). The real magic happens at the <em>handler</em>-parameter; it contains the actual functionality of our shortcut. In the general case (= all examples I saw), the handler is a function and you can literally do what ever JavaScript allows you to do inside it.<br/>
Further breaking down the example, in the first line of the function, the currently active Code Mirror instance of the currently active IPython environment (env) is called (IPython uses one instance of the code editor for each cell). This instance has a bunch of functions you can call and use. To find out which, we can map and output them in the same way as before using our JavaScript-console.</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">$</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span>
     <span class="nx">IPython</span><span class="p">.</span><span class="nx">notebook</span><span class="p">.</span><span class="nx">get_selected_cell</span><span class="p">().</span><span class="nx">code_mirror</span><span class="p">,</span>
     <span class="kd">function</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span><span class="nx">v</span><span class="p">){</span><span class="k">return</span> <span class="nx">v</span><span class="p">}</span>
     <span class="p">)</span></code></pre></div>

<p>Using the <code>getCursor</code>, <code>uncomment</code>, and the <code>lineComment</code> functions, we can create a <em>toggle-comments</em>-function as above. Regarding the last line, I’m not sure why the <code>return false</code> is necessary; in my testing it seems not. But, according to another <a href="http://nbviewer.ipython.org/github/adrn/ipython/blob/2.x/examples/Notebook/User%20Interface.ipynb#Keyboard-shortcut-customization">guide on this topic</a>, this line prevents the default action from being executed (again, I’m not a 100 % sure why this is important).</p>

<p>Before we make the created hotkey available inside of our notebook, I quickly gonna show you the other hotkeys I created.</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="s1">'Alt-1'</span> <span class="o">:</span> <span class="p">{</span>
    <span class="nx">help</span><span class="o">:</span> <span class="s1">'Indent'</span><span class="p">,</span>
    <span class="nx">help_index</span> <span class="o">:</span> <span class="s1">'zz'</span><span class="p">,</span>
    <span class="nx">handler</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">env</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">cm</span><span class="o">=</span><span class="nx">env</span><span class="p">.</span><span class="nx">notebook</span><span class="p">.</span><span class="nx">get_selected_cell</span><span class="p">().</span><span class="nx">code_mirror</span><span class="p">;</span>
        <span class="nx">cm</span><span class="p">.</span><span class="nx">execCommand</span><span class="p">(</span><span class="s1">'indentMore'</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">},</span>

<span class="s1">'Alt-2'</span> <span class="o">:</span> <span class="p">{</span>
    <span class="nx">help</span>    <span class="o">:</span> <span class="s1">'Indent less'</span><span class="p">,</span>
    <span class="nx">help_index</span> <span class="o">:</span> <span class="s1">'zz'</span><span class="p">,</span>
    <span class="nx">handler</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">env</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">cm</span> <span class="o">=</span> <span class="nx">env</span><span class="p">.</span><span class="nx">notebook</span><span class="p">.</span><span class="nx">get_selected_cell</span><span class="p">().</span><span class="nx">code_mirror</span><span class="p">;</span>
        <span class="nx">cm</span><span class="p">.</span><span class="nx">execCommand</span><span class="p">(</span><span class="s1">'indentLess'</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>

<p>As you may noticed, these two are not using a provided Code Mirror function directly, but rather the <code>execCommand</code>-function to get access to a even deeper level of <a href="https://codemirror.net/doc/manual.html#commands">commands</a>. Through Code Mirror Addons this list can be extended even further. However, I haven’t really looked into it jet and therefore, I’m not sure if you can use addons in combination with IPython (If you no something about it, let me know!).</p>

<p>So, we got our three hotkeys. Now we have to actually add them as shortcuts to our notebook. To do so, we create a variable which contains our shortcuts.</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">add_edit_shortcuts</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'Alt-3'</span> <span class="o">:</span> <span class="p">{</span>
            <span class="nx">help</span>    <span class="o">:</span> <span class="s1">'Toggle comments'</span><span class="p">,</span>
            <span class="nx">help_index</span> <span class="o">:</span> <span class="s1">'zz'</span><span class="p">,</span>
            <span class="nx">handler</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">env</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">cm</span><span class="o">=</span><span class="nx">env</span><span class="p">.</span><span class="nx">notebook</span><span class="p">.</span><span class="nx">get_selected_cell</span><span class="p">().</span><span class="nx">code_mirror</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">from</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">getCursor</span><span class="p">(</span><span class="s2">"start"</span><span class="p">),</span> <span class="nx">to</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">getCursor</span><span class="p">(</span><span class="s2">"end"</span><span class="p">);</span>
                <span class="nx">cm</span><span class="p">.</span><span class="nx">uncomment</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">)</span> <span class="o">||</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">lineComment</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">);</span>
                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">},</span>

        <span class="s1">'Alt-1'</span> <span class="o">:</span> <span class="p">{</span>
            <span class="nx">help</span><span class="o">:</span> <span class="s1">'Indent'</span><span class="p">,</span>
            <span class="nx">help_index</span> <span class="o">:</span> <span class="s1">'zz'</span><span class="p">,</span>
            <span class="nx">handler</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">env</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">cm</span><span class="o">=</span><span class="nx">env</span><span class="p">.</span><span class="nx">notebook</span><span class="p">.</span><span class="nx">get_selected_cell</span><span class="p">().</span><span class="nx">code_mirror</span><span class="p">;</span>
                <span class="nx">cm</span><span class="p">.</span><span class="nx">execCommand</span><span class="p">(</span><span class="s1">'indentMore'</span><span class="p">);</span>
                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">},</span>

        <span class="s1">'Alt-2'</span> <span class="o">:</span> <span class="p">{</span>
            <span class="nx">help</span>    <span class="o">:</span> <span class="s1">'Indent less'</span><span class="p">,</span>
            <span class="nx">help_index</span> <span class="o">:</span> <span class="s1">'zz'</span><span class="p">,</span>
            <span class="nx">handler</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">env</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">cm</span> <span class="o">=</span> <span class="nx">env</span><span class="p">.</span><span class="nx">notebook</span><span class="p">.</span><span class="nx">get_selected_cell</span><span class="p">().</span><span class="nx">code_mirror</span><span class="p">;</span>
                <span class="nx">cm</span><span class="p">.</span><span class="nx">execCommand</span><span class="p">(</span><span class="s1">'indentLess'</span><span class="p">);</span>
                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span></code></pre></div>

<p>In a final step, we add them to the keyboard_manager:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">IPython</span><span class="p">.</span><span class="nx">keyboard_manager</span><span class="p">.</span><span class="nx">edit_shortcuts</span><span class="p">.</span><span class="nx">add_shortcuts</span><span class="p">(</span><span class="nx">add_edit_shortcuts</span><span class="p">);</span></code></pre></div>

<p>And we are done; but, only for this notebook. To make our shortcuts available ín every notebook, we have to create an notebook extension. While IPython extensions are .py-files stored in your local <code>/.ipython/extensions</code> folder, notebook extensions are JavaScript files stored in the /.ipython/nbextensions folder. To locate either one of these folders, run <code>ipython locate</code> from a terminal. Now we just have to create a .js-file containing our shortcut commands. In addition, we gonna nest everything into a on-load function, as suggested <a href="http://carreau.gitbooks.io/jupyter-book/content/Jsextensions.html#">here</a>. It looks like this and prevents timing issues when the extension is loaded:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">define</span><span class="p">([</span><span class="s1">'base/js/namespace'</span><span class="p">],</span><span class="kd">function</span><span class="p">(</span><span class="nx">IPython</span><span class="p">){</span>
  <span class="s2">"use strict"</span><span class="p">;</span>
  <span class="c1">// Here go our variable definitions</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="c1">// this will be called at extension loading time</span>
    <span class="c1">//---</span>
    <span class="nx">load_ipython_extension</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="c1">// Here goes code which should be executed on start up (Alias the add_shortcut commands)</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"I have been loaded ! -- custom_shortcuts"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//---</span>
  <span class="p">};</span>
<span class="p">})</span></code></pre></div>

<p>So, you put variable definitions and all this stuff before the return command, and inside the <code>load_ipython_extension</code>-function you gonna place everything, which “actually” changes something. This prevents the issue, that our custom functions are loaded before IPython is correctly initialized.<br/>
As always, you can find the full .js file on <a href="https://github.com/AKuederle/IPython-custom-shortcuts/blob/old-way/custom_shortcuts.js">github</a>.</p>

<p>If you created the file and saved it as “custom_shortcuts.js” inside the nbextensions-folder you should be able to load it from inside of any notebook by running these two lines:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="o">%%</span><span class="nx">JavaScript</span>
<span class="nx">IPython</span><span class="p">.</span><span class="nx">load_extensions</span><span class="p">(</span><span class="s1">'custom_shortcuts'</span><span class="p">);</span></code></pre></div>

<p>To load the extension automatically when starting a new notebook, open up a IPython notebook and run the following lines:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="o">%%</span><span class="nx">JavaScript</span>
<span class="nx">IPython</span><span class="p">.</span><span class="nx">notebook</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="s2">"load_extensions"</span><span class="o">:</span><span class="p">{</span><span class="s2">"custom_shortcuts"</span><span class="o">:</span><span class="kc">true</span><span class="p">}})</span></code></pre></div>

<p>This should update <code>~/.ipython/profile_default/nbconfig/notebook.json</code> accordingly. Now your new awesome shortcuts are available everywhere and every time.</p>

<p>I hope you found this little tutorial helpful, and I would really appreciate more input regarding this topic. So, if you happen to know more about IPython’s extensions, please leave a comment with resources and suggestions.</p>

<p><strong>Update:</strong> As pointed out in the comments, it might actually be better to create each shortcut individually as a new action. This would make it easier to reuse them in other parts of IPython again. Here is an example how to do this for the first shortcut:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">toggle_comments</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">help</span>    <span class="o">:</span> <span class="s1">'Toggle comments'</span><span class="p">,</span>
    <span class="nx">help_index</span> <span class="o">:</span> <span class="s1">'zz'</span><span class="p">,</span>
    <span class="nx">handler</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">env</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">cm</span><span class="o">=</span><span class="nx">env</span><span class="p">.</span><span class="nx">notebook</span><span class="p">.</span><span class="nx">get_selected_cell</span><span class="p">().</span><span class="nx">code_mirror</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">from</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">getCursor</span><span class="p">(</span><span class="s2">"start"</span><span class="p">),</span> <span class="nx">to</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">getCursor</span><span class="p">(</span><span class="s2">"end"</span><span class="p">);</span>
        <span class="nx">cm</span><span class="p">.</span><span class="nx">uncomment</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">)</span> <span class="o">||</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">lineComment</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nx">IPython</span><span class="p">.</span><span class="nx">keyboard_manager</span><span class="p">.</span><span class="nx">actions</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="nx">toggle_comments</span><span class="p">,</span><span class="s1">'toggle_comments'</span><span class="p">)</span></code></pre></div>

<p>Now, our action is registered. We can check this by calling the following from the JavaScript console.</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">$</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span>
     <span class="nx">IPython</span><span class="p">.</span><span class="nx">keyboard_manager</span><span class="p">.</span><span class="nx">command_shortcuts</span><span class="p">.</span><span class="nx">actions</span><span class="p">.</span><span class="err">\</span><span class="nx">_actions</span><span class="p">,</span>
     <span class="kd">function</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span><span class="nx">v</span><span class="p">){</span><span class="k">return</span> <span class="nx">v</span><span class="p">}</span>
     <span class="p">)</span></code></pre></div>

<p>At the very end of the list, there should be a function called <code>auto.toggle_comments</code>. We can assigned this action to any shortcut as before:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">IPython</span><span class="p">.</span><span class="nx">keyboard_manager</span><span class="p">.</span><span class="nx">edit_shortcuts</span><span class="p">.</span><span class="nx">add_shortcut</span><span class="p">(</span><span class="s1">'Alt-5'</span><span class="p">,</span> <span class="s1">'auto.toggle_comments'</span><span class="p">)</span></code></pre></div>

<p>Note, that you need the <code>auto.</code> prefix!<br/>
A updated version of the whole script based on this idea, can be found <a href="https://github.com/AKuederle/IPython-custom-shortcuts/blob/futureproof/custom_shortcuts.js">here</a>.</p>

<p>I hope you found this little tutorial helpful, and I would really appreciate more input regarding this topic. So, if you happen to know more about IPython’s extensions, please leave a comment with resources and suggestions.</p>

  </article>

</div></body></html>