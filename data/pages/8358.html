<html><body><div><div class="content">
      
        <h1 class="content-title">SQLite Spellfix Extension and Python</h1>
      
      
      
  <div class="post-info"><p>
    
    
      December 04, 2015 20:31
      </p><span class="separator">/</span>
      <a href="#comments">1 comments</a>
      <span class="separator">/</span>
      
        <a href="/blog/tags/peewee/">peewee</a>
      
        <a href="/blog/tags/python/">python</a>
      
        <a href="/blog/tags/sqlite/">sqlite</a>
      
    
  </div>
  
  
    <p>The SQLite source tree is full of wonders. There is the the <a href="http://www.sqlite.org/src/doc/trunk/doc/lemon.html">lemon parser generator</a>, a <a href="https://www.sqlite.org/btreemodule.html">btree</a> implementation (well, kind of not surprising), multiple search engines, a <a href="https://www.sqlite.org/json1.html">json library</a>, and more. It looks like Dr. Hipp is also experimenting with integrating the <a href="https://www.sqlite.org/cgi/src/dir?ci=8aede091c4740511&amp;name=ext/lsm1">LSM key/value store</a> from SQLite4 as a standalone virtual table.</p>
<p>I've written about the <a href="/blog/using-the-sqlite-json1-and-fts5-extensions-with-python/">json and full-text search extensions</a>, the <a href="/blog/using-sqlite4-s-lsm-storage-engine-as-a-stand-alone-nosql-database-with-python/">lsm key/value store</a>, and the <a href="/blog/querying-tree-structures-in-sqlite-using-python-and-the-transitive-closure-extension/">transitive closure extension</a> (useful when querying hierarchical data). In this post I'll be covering another interesting extension, the <code>spellfix1</code> extension (<a href="http://www.sqlite.org/spellfix1.html">documentation</a>).</p>
<p>The <code>spellfix1</code> extension is useful for providing suggestions for misspelled words, but could also be used alongside a full-text search implementation to provide corrections for commonly misspelled words in searches. If you have a mobile app, you could use it to correct misspellings due to...mobile. It's a snap to use the extension, so let's compile it and give it a shot. I'll be using <a href="http://docs.peewee-orm.com">Peewee</a>, a lightweight Python ORM, to communicate with the database.</p>
<h3>Building the extension</h3>
<p>There are a number of ways you can get the source code for the extension. You can download the entire source using the <a href="https://www.sqlite.org/2015/sqlite-src-3090200.zip">3.9.2 snapshot</a>, or alternatively just fetch the <a href="http://sqlite.org/cgi/src/raw/ext/misc/spellfix.c?name=b9065af7ab1f2597b505a8aa9892620866d502fc">spellfix.c file</a>:</p>
<div class="highlight"><pre><span class="gp">$</span> wget http://sqlite.org/cgi/src/raw/ext/misc/spellfix.c?name<span class="o">=</span>b9065af7ab1f2597b505a8aa9892620866d502fc -O spellfix1.c
</pre></div>
<p>If you downloaded the source snapshot, you can find the file in the <code>ext/misc/</code> subdirectory.</p>
<p>We'll compile the extension into a shared library:</p>
<div class="highlight"><pre><span class="gp">$</span> gcc -fPIC -shared spellfix1.c -o spellfix1.so
</pre></div>
<p>You should now have a <code>spellfix1.so</code> file in your current directory.</p>
<h3>Setting up the database</h3>
<p>The <code>spellfix1</code> extension creates a <a href="https://www.sqlite.org/vtab.html">virtual table</a> with a number of columns that provide metadata about the words listed in the table. To get started, we'll create a new Python file (<code>spelling.py</code>) and define our database and spelling table:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">peewee</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">playhouse.sqlite_ext</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">SqliteExtDatabase</span><span class="p">(</span><span class="s1">'spelling.db'</span><span class="p">)</span>

<span class="c1"># Configure the database to load the `spellfix1.so` extension</span>
<span class="c1"># whenever a connection is opened.</span>
<span class="n">db</span><span class="o">.</span><span class="n">load_extension</span><span class="p">(</span><span class="s1">'spellfix1'</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Spellfix</span><span class="p">(</span><span class="n">VirtualModel</span><span class="p">):</span>
    <span class="n">_extension</span> <span class="o">=</span> <span class="s1">'spellfix1'</span>
    <span class="n">word</span> <span class="o">=</span> <span class="n">VirtualCharField</span><span class="p">()</span>
    <span class="n">rank</span> <span class="o">=</span> <span class="n">VirtualIntegerField</span><span class="p">()</span>
    <span class="n">distance</span> <span class="o">=</span> <span class="n">VirtualIntegerField</span><span class="p">()</span>
    <span class="n">langid</span> <span class="o">=</span> <span class="n">VirtualIntegerField</span><span class="p">()</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">VirtualFloatField</span><span class="p">()</span>
    <span class="n">matchlen</span> <span class="o">=</span> <span class="n">VirtualIntegerField</span><span class="p">()</span>
    <span class="n">phonehash</span> <span class="o">=</span> <span class="n">VirtualCharField</span><span class="p">()</span>
    <span class="n">top</span> <span class="o">=</span> <span class="n">VirtualIntegerField</span><span class="p">()</span>
    <span class="n">scope</span> <span class="o">=</span> <span class="n">VirtualFloatField</span><span class="p">()</span>
    <span class="n">soundslike</span> <span class="o">=</span> <span class="n">VirtualCharField</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">db</span>
        <span class="n">primary_key</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c1"># Create the table if it does not exist.</span>
<span class="n">db</span><span class="o">.</span><span class="n">create_tables</span><span class="p">([</span><span class="n">Spellfix</span><span class="p">],</span> <span class="n">safe</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
<p>When populating the spellfix table, all that is required is a value for the <code>word</code> column. The <code>langid</code> can be specified if you plan on supporting multiple languages, and if you would like to associate weights with words, you can specify a value for the <code>rank</code> column. In this post we'll just specify a value for the <code>word</code> column.</p>
<p>The <code>spellfix</code> table is now ready to be populated with a word list. If you're a linux user there is typically a word list in <code>/usr/share/dict/words</code>. On arch linux, I just installed the <code>words</code> package (<code>sudo pacman -S words</code>) - I imagine there's a similar process for noobuntu/fapple users.</p>
<p>Add the following code to populate the table:</p>
<div class="highlight"><pre><span class="n">WORD_FILE</span> <span class="o">=</span> <span class="s1">'/usr/share/dict/words'</span>

<span class="c1"># Populate the table if it hasn't been already.</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">Spellfix</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">WORD_FILE</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">db</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">Spellfix</span><span class="o">.</span><span class="n">insert</span><span class="p">({</span><span class="n">Spellfix</span><span class="o">.</span><span class="n">word</span><span class="p">:</span> <span class="n">word</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()})</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>
<p>If you run the script at this point, it should take a minute to finish, after which you'll have a SQLite database named <code>spelling.db</code> which has been populated with our list of words.</p>
<h3>Getting spelling suggestions</h3>
<p>To use the extension, we will query the <code>Spellfix</code> table's <code>word</code> column using the special SQLite <code>MATCH</code> operator. When we query the table, the extension will calculate the edit distance between the input word and a potential match in the database. The edit distance, combined with the rank provided when the table was created, determines the <code>score</code> of the match.</p>
<p>Here is a short snippet of code you can put at the end of the script to test the extension out:</p>
<div class="highlight"><pre><span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">phrase</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s1">'Enter phrase: '</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">phrase</span> <span class="ow">or</span> <span class="n">phrase</span> <span class="o">==</span> <span class="s1">'q'</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="n">accum</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">phrase</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">Spellfix</span>
                 <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Spellfix</span><span class="o">.</span><span class="n">word</span><span class="p">,</span> <span class="n">Spellfix</span><span class="o">.</span><span class="n">score</span><span class="p">)</span>
                 <span class="o">.</span><span class="n">where</span><span class="p">(</span>
                     <span class="n">match</span><span class="p">(</span><span class="n">Spellfix</span><span class="o">.</span><span class="n">word</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span> <span class="o">&amp;</span>
                     <span class="p">(</span><span class="n">Spellfix</span><span class="o">.</span><span class="n">top</span> <span class="o">==</span> <span class="mi">5</span><span class="p">))</span>
                 <span class="o">.</span><span class="n">dicts</span><span class="p">())</span>
        <span class="k">print</span> <span class="n">word</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">'    '</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s1">'word'</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s1">'score'</span><span class="p">]</span>
</pre></div>
<p>Let's try running the script now and seeing how things work:</p>
<div class="highlight"><pre><span class="gp">$</span> python spelling.py
<span class="go">Enter phrase: hello fellowe pythonn users </span>
<span class="go">hello</span>
<span class="go">     hello 31.0</span>
<span class="go">     Eloy 45.0</span>
<span class="go">     hello's 56.0</span>
<span class="go">     hellos 56.0</span>
<span class="go">     helot 66.0</span>
<span class="go">fellowe</span>
<span class="go">     fallowed 96.0</span>
<span class="go">     bellowed 96.0</span>
<span class="go">     followed 96.0</span>
<span class="go">     follower 96.0</span>
<span class="go">     Felipe 121.0</span>
<span class="go">pythonn</span>
<span class="go">     Python 41.0</span>
<span class="go">     python 41.0</span>
<span class="go">     Python's 66.0</span>
<span class="go">     pythons 66.0</span>
<span class="go">     python's 66.0</span>
<span class="go">users</span>
<span class="go">     users 31.0</span>
<span class="go">     user's 32.0</span>
<span class="go">     ushers 32.0</span>
<span class="go">     usher's 33.0</span>
<span class="go">     USSR's 62.0</span>
<span class="go">     USSR's 62.0</span>

<span class="go">Enter phrase: foo bar baz baze</span>
<span class="go">foo</span>
<span class="go">     foo 31.0</span>
<span class="go">     foe 44.0</span>
<span class="go">     food 56.0</span>
<span class="go">     foot 56.0</span>
<span class="go">     Foch 66.0</span>
<span class="go">bar</span>
<span class="go">     bar 31.0</span>
<span class="go">     Barr 33.0</span>
<span class="go">     bare 36.0</span>
<span class="go">     barre 38.0</span>
<span class="go">     Barry 38.0</span>
<span class="go">baz</span>
<span class="go">     Baez 46.0</span>
<span class="go">     bash 71.0</span>
<span class="go">     bag 71.0</span>
<span class="go">     biz 71.0</span>
<span class="go">     Bach 71.0</span>
<span class="go">baze</span>
<span class="go">     baize 46.0</span>
<span class="go">     bake 71.0</span>
<span class="go">     base 71.0</span>
<span class="go">     baize's 71.0</span>
<span class="go">     faze 71.0</span>
</pre></div>
<p>Pretty neat! If you'd like to learn more about how to use the <code>spellfix1</code> extension, including using the "sounds like" feature and integrating with full-text search, check out the <a href="http://www.sqlite.org/spellfix1.html">official extension documentation</a>.</p>
<p>Thanks for reading, I hope you found this post interesting! If you'd like to check out some similar posts, check out the <a href="/blog/tags/sqlite/">sqlite tag</a> on my blog as it's one of my favorite topics lately!</p>
  
  

  
  
  


<hr/>

  <p>Commenting has been closed, but please feel free to <a href="/contact/">contact me</a></p>


    </div>

    </div></body></html>