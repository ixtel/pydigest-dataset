<html><body><div><div class="content html_format">
      <a href="https://habrahabr.ru/post/276731/"><img src="https://habrastorage.org/files/2f2/e45/c50/2f2e45c507a846ec88030b21a1d0610c.png"/></a>
<p>
Привет, Хабр! Меня зовут Владимир, мне 28 лет и я </p><s>наркоман</s><p> наркоман. Мой наркотик – простота. На простоту я подсел из-за своего перфекционизма, которым меня наградили при рождении.
</p><p>
Врачи говорят, что это взаимосвязано, мол перфекционизм — это стремление к совершенству, а простота позволяет подобраться к этому мифическому совершенству. Чем проще решение, тем меньше ошибок можно допустить, вот я и подсел. Я не стал с ними спорить и вместо того, что бы искать виновников моей истории, решил с этим жить и постараться повысить качество этой самой жизни. 
</p><p>
Мир вокруг не идеален, сложную вещь сделать простой – невероятно сложно, поэтому всё чрезмерно усложнено. Людям нравиться чувствовать себя профессионалами, поэтому они оперируют сложными терминами, когда в этом нет необходимости, так они ощущают свою значимость и заполняют пустоту, которая образовалась из-за страха потерянного времени.
</p><a name="habracut"/>
<div class="spoiler"><b class="spoiler_title">Усложнить можно всё: ты/Вы/вы</b><p class="spoiler_text">Почему я должен постоянно вспоминать о том, общался я с этим человеком или нет? Мы уже перешли на ты? Я пишу какое-то коммерческое предложение и мне надо «Выкнуть» или это ответ на рядовое письмо и достаточно простого «вы». Почему мне постоянно надо расстраиваться, когда мне с порога совершенно незнакомый человек начинает «тыкать», как будто я его друг с курилки?<br/>
<br/>
Я принципиально всем «выкаю» с маленькой буквы и я убеждён, что это имеет свою цену. Наверняка есть люди, которым не нравится, что их назвали с маленькой буквы и они не ответят на моё письмо.<br/>
<br/>
Так зачем эти сложности?<br/>
</p></div><p>
Когда я упомянул про повышение качества жизни, я имел ввиду некоторые правила, которые помогают быстро принимать решения и не жалеть об этом. Например, я не использую сложные вещи постоянно, не общаюсь с людьми, которым нравится всё усложнять. Если вещь, которой вы пользуетесь каждый день – сложна, то это значит только то, что ей не уделили достаточно внимания. Если человек вам не может объяснить даже трудную для понимания тему простым языком, значит, он сам не до конца понимает о чём говорит.
</p><p>
Есть ещё кое-что, что имеет не менее важное значение – время. Время – бесценный ресурс, а выражение «Время — деньги» из уст умных людей вызывает у меня улыбку с разочарованием (</p><i>выглядишь как идиот и чувствуешь себя так же</i><p>). Я до сих пор не знаю ни одного миллиардера, которому деньги помогли прожить дольше других людей.

</p><h4><font>Введение</font></h4><p>
Речь пойдёт об инструменте, который позволит вам построить полноценный и простой в использовании </p><i>REST API</i><p> за минимальное количество времени. Называется он – </p><a href="http://python-eve.org/index.html">Python Eve</a><p>.
</p><p>
К сожалению в Интернете очень много инструкций на эту тему, но все они вводят в заблуждение. Начинающие разработчики, начитавшись подобных статей, думают, что </p><i>REST API</i><p> это </p><i>GET/POST/PUT/DELETE</i><p>. Заказчики думают, что это дело пары часов. А когда они встречаются вместе, происходят магия в виде </p><i>Express.js/Mongoose/Passport</i><p> и ещё кучи хлама, который течёт и временами блокирует event-loop. Всё это запускается с помощью какого-нибудь </p><i>supervisor</i><p>, потому что иногда падает и надо как-то перезапускать. 
</p><p>
И всё бы ничего, но вчера у меня состоялся разговор с хабра-пользователем, который предложил воспользоваться "</p><i>Express.js, MongoDB, Mongoose, Passport, отладчиком WebStorm'a и головой на плечах</i><p>". Похожие разговоры случались часто, поэтому я решил написать эту статью и «отсылать» ссылкой на неё.

</p><h4><font>Полноценный REST API?</font></h4><p>
Речь не только о реализации </p><a href="https://ru.wikipedia.org/wiki/REST">архитектурного стиля <i>REST API</i></a><p>, но и о </p><a href="https://ru.wikipedia.org/wiki/HTTP">протоколе HTTP</a><p>, о </p><a href="http://python-eve.org/features.html#data-validation">валидации</a><p> и </p><a href="http://python-eve.org/features.html#resource-level-cache-control">кэшировании</a><p>, о </p><a href="http://python-eve.org/features.html#hateoas">HATEOAS</a><p> (</p><a href="https://en.wikipedia.org/wiki/HATEOAS"><i>wikipedia</i></a><p>), о котором, похоже, вообще предпочитают не вспоминать. Затем нам понадобится </p><a href="http://python-eve.org/features.html#filtering">фильтрация результатов</a><p> и </p><a href="http://python-eve.org/features.html#sorting">сортировка</a><p>, </p><a href="http://python-eve.org/features.html#pagination">постраничная навигация</a><p> и частичное обновление записей. Потом мы задумаемся о </p><a href="http://python-eve.org/features.html#data-integrity-and-concurrency-control">целостности данных</a><p> и </p><a href="http://python-eve.org/features.html#conditional-requests">условных запросах</a><p>. Наверняка нам понадобится </p><a href="http://python-eve.org/features.html#authentication">аутентификация</a><p>, возможно захотим отображать данные</p><a href="http://python-eve.org/features.html#json-and-xml-rendering"> не только в JSON, но и в XML</a><p>. Это ещё про </p><a href="http://python-eve.org/features.html#document-versioning">версионность</a><p> и </p><a href="http://python-eve.org/features.html#embedded-resource-serialization">вложенные записи</a><p> я не упомянул. Затем, как это обычно бывает, какой-то #$%$%^ начнёт долбить в наш могучий API с тяжёлым запросом и нам понадобится </p><a href="http://python-eve.org/features.html#rate-limiting">ограничить частоту запросов</a><p>.
</p><p>
Даже если представить, что разработкой такого API займётся невероятно крутой разработчик с 3-мя мониторами, отладчиком WebStorm'a и головой на плечах, он затратит на это не просто много времени, а очень много. Поддержка кодовой базы будет обходиться дорого, а внедрение новых функций будет долгим.

</p><img src="https://habrastorage.org/files/07c/1f0/d59/07c1f0d590fe4b4fbee0345e2054427d.jpg"/>
<p>
Но мы с вами простоту – любим, а время – уважаем. Так приступим же!

</p><h4><font>Установка</font></h4><p>
Это обычный python-пакет, поэтому устанавливается он стандартным способом:

</p><pre><code class="bash">$ pip install eve
</code></pre><p>
Если вас интересуют альтернативные методы установки, можете заглянуть в </p><a href="http://python-eve.org/install.html">официальную документацию</a><p>.

</p><h4><font>Быстрый старт</font></h4><p>
Перед тем, как мы начнём «творить» магию, нам понадобится база данных </p><i>MongoDB</i><p>. Если у вас её нет, вы можете воспользоваться любым бесплатным сервисом, например </p><a href="https://mongolab.com/">MongoLab</a><p>. Регистрация займёт не больше минуты. После регистрации создайте базу данных и пользователя для этой базы.
</p><p>
Теперь давайте напишем минимальную версию нашего </p><i>REST API</i><p>. Для начала создадим главный файл </p><b>run.py</b><p> со следующим содержимым:

</p><pre><code class="python">from eve import Eve
app = Eve()

if __name__ == '__main__':
    app.run()
</code></pre><p>
Теперь нам надо создать файл настроек </p><b>settings.py</b><p>:

</p><pre><code class="python"># замените user, password, ds049945.mongolab.com, example на ваши данные доступа к БД.
MONGO_URI = "mongodb://user:password@ds049945.mongolab.com:49945/example"

# По умолчанию Eve запускает API в режиме "read-only" (т.е. поддерживаются только GET запросы),
# мы включаем поддержку методов POST, PUT, PATCH, DELETE.
RESOURCE_METHODS = ['GET', 'POST', 'DELETE']
ITEM_METHODS = ['GET', 'PATCH', 'PUT', 'DELETE']

DOMAIN = {
    # Описываем ресурс `/users`
    'users': {
        # Здесь мы описываем модель данных. Для валидации используется модуль Cerberus от автора Eve.
        # Вы можете ознакомиться с ним в официальной документации модуля http://docs.python-cerberus.org/en/stable/.
        # Либо прочитать заметки в официальной документации EVE http://python-eve.org/validation.html#validation.
        'schema': {
            'username': {
                'type': 'string',
                'minlength': 5,
                'maxlength': 32,
                'required': True,
                # уникальное поле (индекс не создаётся, просто значение должно быть уникальным)
                'unique': True,
            },
            'firstname': {
                'type': 'string',
                'minlength': 1,
                'maxlength': 10,
                'required': True,
            },
            'lastname': {
                'type': 'string',
                'minlength': 1,
                'maxlength': 15,
                'required': True,
            },
            'role': {
                
                'type': 'list', # тип: список
                'allowed': ["author", "contributor"], # разрешаем использовать значения: "author", "contributor"
            },
            'location': {
                'type': 'dict', # тип: словарь
                # описываем "схему" словаря
                'schema': {
                    'address': {'type': 'string'},
                    'city': {'type': 'string'}
                },
            },
            'born': {
                'type': 'datetime',
            },
            'active': {
                'type': 'boolean',
                'default': True
            }
        }
    },

    # Описываем ресурс `/groups`
    'groups': {
        # Описываем модель данных (см. выше).
        'schema': {
            'title': {
                'type': 'string',
                'minlength': 5,
                'maxlength': 32,
                'required': True,
                'unique': True
            },
            'users': {
                'type': 'list',  # тип: список
                'default': [],   # по умолчанию: пустой список
                # описываем "схему" списка
                'schema': { 
                    'type': 'objectid', # тип данных: objectid
                    # ссылаемся на запись в другой коллекции
                    'data_relation': {
                        'resource': 'users',  # на ресурс `users` (который мы описали выше)
                        'field': '_id',  # на поле `_id`
                        'embeddable': True
                    }
                }
            }
        }
    }
}
</code></pre><p>
На мой взгляд здесь всё достаточно просто и вопросов возникнуть не должно. Если это не так – добро пожаловать в комментарии. Полный список параметров конфигурации вы можете глянуть в </p><a href="http://python-eve.org/config.html">документации</a><p>.
</p><p>
Всё готово, запускаем:

</p><pre><code class="bash">$ python3.5 run.py
 * Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)
</code></pre>

<h4><font>Прелюдия</font></h4><p>
Вы уже подумали, что сейчас мы начнём безбожно "</p><i>curl</i><p>ить", но я вынужден вас разочаровать. Мы, со свойственным нам перфекционизмом, воспользуемся инструментом автора, который обладает чувством прекрасного:

</p><img src="https://habrastorage.org/files/98b/5e6/5a3/98b5e65a30c9467fae795626e25a3e8b.png"/><p>
Инструмент называется </p><a href="https://github.com/jkbrzt/httpie">HTTPie</a><p> и ставится в </p><s>один клик</s><p> одну команду:

</p><pre><code class="bash">$ pip install httpie
</code></pre>
<h4><font>Игрища и забавы</font></h4>
<i>HTTPie</i><p> вызывается командой "</p><i>http</i><p>". Для того, что бы отправить </p><i>GET</i><p> запрос к нашему </p><i>API</i><p>, выполним:

</p><pre><code class="bash">$ http http://0.0.0.0:5000/
HTTP/1.0 200 OK
Content-Length: 99
Content-Type: application/json
Date: Sun, 07 Feb 2016 18:13:33 GMT
Server: Eve/0.6.1 Werkzeug/0.10.4 Python/3.5.0

{
    "_links": {
        "child": [
            {
                "href": "users",
                "title": "users"
            },
            {
                "href": "groups",
                "title": "groups"
            }
        ]
    }
}
</code></pre><p>
Благодаря </p><a href="http://python-eve.org/features.html#hateoas-feature">HATEOAS</a><p> мы видим, что у нас есть 2 ресурса: </p><i>users</i><p> и </p><i>groups</i><p>. Заглянем внутрь:

</p><pre><code class="bash">» http http://0.0.0.0:5000/users
HTTP/1.0 200 OK
Content-Length: 166
Content-Type: application/json
Date: Sun, 07 Feb 2016 18:20:41 GMT
Server: Eve/0.6.1 Werkzeug/0.10.4 Python/3.5.0
X-Total-Count: 0

{
    "_items": [],
    "_links": {
        "parent": {
            "href": "/",
            "title": "home"
        },
        "self": {
            "href": "users",
            "title": "users"
        }
    },
    "_meta": {
        "max_results": 25,
        "page": 1,
        "total": 0
    }
}
</code></pre><p>
Давайте создадим пользователя </p><i>johndoe</i><p>:

</p><pre><code class="bash">$ http http://0.0.0.0:5000/users username=johndoe
HTTP/1.0 422 UNPROCESSABLE ENTITY
Content-Length: 184
Content-Type: application/json
Date: Sun, 07 Feb 2016 18:22:44 GMT
Server: Eve/0.6.1 Werkzeug/0.10.4 Python/3.5.0

{
    "_error": {
        "code": 422,
        "message": "Insertion failure: 1 document(s) contain(s) error(s)"
    },
    "_issues": {
        "firstname": "required field",
        "lastname": "required field"
    },
    "_status": "ERR"
}
</code></pre><p>
Первое, на что стоит обратить внимание, это на нашу команду:

</p><pre><code class="bash">$ http http://0.0.0.0:5000/users username=johndoe
</code></pre>
<i>HTTPie</i><p> увидел, что мы отправляем параметр </p><i>username</i><p> и превратил его в </p><i>JSON</i><p>:

</p><pre><code class="javascript">{
    "username": "johndoe"
}
</code></pre> <p>
Затем отправил нашему </p><i>API</i><p> методом </p><i>POST</i><p>. Давайте обратим внимание на ошибки:

</p><pre><code class="javascript">"_issues": {
    "firstname": "required field",
    "lastname": "required field"
}
</code></pre><p>
Мы видим сразу весь список ошибок валидации и это здорово. Исправим их и выполним запрос повторно:

</p><pre><code class="bash">$ http http://0.0.0.0:5000/users username=johndoe firstname=John lastname=Doe
HTTP/1.0 201 CREATED
Content-Length: 276
Content-Type: application/json
Date: Sun, 07 Feb 2016 18:34:42 GMT
Server: Eve/0.6.1 Werkzeug/0.10.4 Python/3.5.0

{
    "_created": "Sun, 07 Feb 2016 18:34:41 GMT",
    "_etag": "24509359443095dd05dece6d0eb7d98cce70b076",
    "_id": "56b78e41cf7b35255aa5a1e6",
    "_links": {
        "self": {
            "href": "users/56b78e41cf7b35255aa5a1e6",
            "title": "User"
        }
    },
    "_status": "OK",
    "_updated": "Sun, 07 Feb 2016 18:34:41 GMT"
}
</code></pre><p>
Ну вот, мы только что успешно создали нового пользователя. Давайте проверим так ли это:

</p><pre><code class="bash">$ http http://0.0.0.0:5000/users
HTTP/1.0 200 OK
Content-Length: 504
Content-Type: application/json
Date: Sun, 07 Feb 2016 18:36:00 GMT
Last-Modified: Sun, 07 Feb 2016 18:34:41 GMT
Server: Eve/0.6.1 Werkzeug/0.10.4 Python/3.5.0
X-Total-Count: 1

{
    "_items": [
        {
            "_created": "Sun, 07 Feb 2016 18:34:41 GMT",
            "_etag": "24509359443095dd05dece6d0eb7d98cce70b076",
            "_id": "56b78e41cf7b35255aa5a1e6",
            "_links": {
                "self": {
                    "href": "users/56b78e41cf7b35255aa5a1e6",
                    "title": "User"
                }
            },
            "_updated": "Sun, 07 Feb 2016 18:34:41 GMT",
            "active": true,
            "firstname": "John",
            "lastname": "Doe",
            "username": "johndoe"
        }
    ],
    "_links": {
        "parent": {
            "href": "/",
            "title": "home"
        },
        "self": {
            "href": "users",
            "title": "users"
        }
    },
    "_meta": {
        "max_results": 25,
        "page": 1,
        "total": 1
    }
}
</code></pre><p>
Нет никаких сомнений, что это так. Настало время попробовать перезаписать (</p><i>обратите внимание, не отредактировать, а перезаписать</i><p>) пользователя. Делается это с помощью метода </p><i>PUT</i><p>, который надо указать явно (</p><i>если не указать, будет выполнен POST</i><p>):
 
</p><pre><code class="bash">$ http put http://0.0.0.0:5000/users/56b78e41cf7b35255aa5a1e6 username=janedoe firstname="Jane" lastname="Doe"
HTTP/1.0 403 FORBIDDEN
Content-Length: 101
Content-Type: application/json
Date: Sun, 07 Feb 2016 18:43:04 GMT
Server: Eve/0.6.1 Werkzeug/0.10.4 Python/3.5.0

{
    "_error": {
        "code": 403,
        "message": "An etag must be provided to edit a document"
    },
    "_status": "ERR"
}
</code></pre><p>
Упс, ошибка. Я выше упоминал о </p><a href="http://Data Integrity and Concurrency Control">целостности данных</a><p>. Дело в том, что может произойти ситуация, в которой кто-то уже изменил запись, которую хотите поменять вы. И когда вы её отредактируете, то будете думать, что изменили одну запись, но на самом деле уже совсем другую.
</p><p>
Для того, что бы мы в такой ситуации не оказались, используется </p><a href="https://ru.wikipedia.org/wiki/HTTP_ETag">идентификатор <i>ETag</i></a><p>. В двух словах — это уникальный идентификатор, который генерируется </p><i>Eve</i><p> при каждом изменении записи. Используя этот идентификатор мы можем сказать нашему </p><i>API</i><p>, что хотим изменить запись только определённой версии и если она с тех пор была отредактирована, то наши изменения выполнены не будут. Делается это с помощью </p><a href="http://python-eve.org/features.html#conditional-requests">условного запроса</a><p> с </p><i>HTTP</i><p> заголовком "</p><i>If-Match</i><p>":

</p><pre><code class="bash">$ http put http://0.0.0.0:5000/users/56b78e41cf7b35255aa5a1e6 "If-Match":"24509359443095dd05dece6d0eb7d98cce70b076" username=janedoe firstname="Jane" lastname="Doe"
HTTP/1.0 200 OK
Content-Length: 276
Content-Type: application/json
Date: Sun, 07 Feb 2016 18:46:56 GMT
ETag: 0138d193174528c205827ba9af25b7b8fb93940e
Last-Modified: Sun, 07 Feb 2016 18:46:56 GMT
Server: Eve/0.6.1 Werkzeug/0.10.4 Python/3.5.0

{
    "_created": "Sun, 07 Feb 2016 18:34:41 GMT",
    "_etag": "0138d193174528c205827ba9af25b7b8fb93940e",
    "_id": "56b78e41cf7b35255aa5a1e6",
    "_links": {
        "self": {
            "href": "users/56b78e41cf7b35255aa5a1e6",
            "title": "User"
        }
    },
    "_status": "OK",
    "_updated": "Sun, 07 Feb 2016 18:46:56 GMT"
}
</code></pre><p>
Обратите внимание каким образом мы передали </p><i>HTTP</i><p> заголовок </p><i>HTTPie</i><p>. Это не единственное, для чего может использоваться идентификатор </p><i>ETag</i><p> и условные запросы. Я здесь не буду останавливаться на этом, но советую вам ознакомиться с этой темой, если вы этого ещё не сделали. 
</p><p>
Настало время создать новую группу. Для начала попробуем создать группу с несуществующим пользователем:

</p><pre><code class="bash">$ http http://0.0.0.0:5000/groups title="Friends" users:='["56b77466cf7b352414deb451"]'
HTTP/1.0 422 UNPROCESSABLE ENTITY
Content-Length: 220
Content-Type: application/json
Date: Sun, 07 Feb 2016 19:14:31 GMT
Server: Eve/0.6.1 Werkzeug/0.10.4 Python/3.5.0

{
    "_error": {
        "code": 422,
        "message": "Insertion failure: 1 document(s) contain(s) error(s)"
    },
    "_issues": {
        "users": {
            "0": "value '56b77466cf7b352414deb451' must exist in resource 'users', field '_id'."
        }
    },
    "_status": "ERR"
}
</code></pre><p>
И действительно, пользователя с таким </p><i>_id</i><p> не существует. Обратите внимание как мы передаём список пользователей: 

</p><pre><code class="bash">users:='["56b77466cf7b352414deb451"]'
</code></pre><p>
Подробнее вы можете почитать в </p><a href="https://github.com/jkbrzt/httpie#json">официальной документации</a><p> к HTTPie, которая такая же качественная, как и сам инструмент.
</p><p>
На этот раз мы укажем правильный </p><i>_id</i><p>:

</p><pre><code class="bash">» http http://0.0.0.0:5000/groups title="Friends" users:='["56b78e41cf7b35255aa5a1e6"]'
HTTP/1.0 201 CREATED
Content-Length: 278
Content-Type: application/json
Date: Sun, 07 Feb 2016 19:21:42 GMT
Server: Eve/0.6.1 Werkzeug/0.10.4 Python/3.5.0

{
    "_created": "Sun, 07 Feb 2016 19:21:41 GMT",
    "_etag": "c6fc02a0bd4bae92a1310be0748ff8bc971ff209",
    "_id": "56b79945cf7b35255aa5a1e7",
    "_links": {
        "self": {
            "href": "groups/56b79945cf7b35255aa5a1e7",
            "title": "Group"
        }
    },
    "_status": "OK",
    "_updated": "Sun, 07 Feb 2016 19:21:41 GMT"
}
</code></pre><p>
«Усё добра», как говорила моя прабабушка. Проверим:

</p><pre><code class="bash">$ http http://0.0.0.0:5000/groups
HTTP/1.0 200 OK
Content-Length: 488
Content-Type: application/json
Date: Sun, 07 Feb 2016 19:24:50 GMT
Last-Modified: Sun, 07 Feb 2016 19:21:41 GMT
Server: Eve/0.6.1 Werkzeug/0.10.4 Python/3.5.0
X-Total-Count: 1

{
    "_items": [
        {
            "_created": "Sun, 07 Feb 2016 19:21:41 GMT",
            "_etag": "c6fc02a0bd4bae92a1310be0748ff8bc971ff209",
            "_id": "56b79945cf7b35255aa5a1e7",
            "_links": {
                "self": {
                    "href": "groups/56b79945cf7b35255aa5a1e7",
                    "title": "Group"
                }
            },
            "_updated": "Sun, 07 Feb 2016 19:21:41 GMT",
            "title": "Friends",
            "users": [
                "56b78e41cf7b35255aa5a1e6"
            ]
        }
    ],
    "_links": {
        "parent": {
            "href": "/",
            "title": "home"
        },
        "self": {
            "href": "groups",
            "title": "groups"
        }
    },
    "_meta": {
        "max_results": 25,
        "page": 1,
        "total": 1
    }
}
</code></pre><p>
Прабабушка оказалась бы права. На этом можно было бы закончить, но мы поступим иначе.
</p><p>
Получим группу с пользователями, которые в неё входят, в развёрнутом виде:

</p><pre><code class="bash">$ http http://0.0.0.0:5000/groups/56b79945cf7b35255aa5a1e7/\?embedded='{"users":1}'
HTTP/1.0 200 OK
Content-Length: 646
Content-Type: application/json
Date: Sun, 07 Feb 2016 19:38:27 GMT
ETag: c6fc02a0bd4bae92a1310be0748ff8bc971ff209
Last-Modified: Sun, 07 Feb 2016 19:21:41 GMT
Server: Eve/0.6.1 Werkzeug/0.10.4 Python/3.5.0

{
    "_created": "Sun, 07 Feb 2016 19:21:41 GMT",
    "_etag": "c6fc02a0bd4bae92a1310be0748ff8bc971ff209",
    "_id": "56b79945cf7b35255aa5a1e7",
    "_links": {
        "collection": {
            "href": "groups",
            "title": "groups"
        },
        "parent": {
            "href": "/",
            "title": "home"
        },
        "self": {
            "href": "groups/56b79945cf7b35255aa5a1e7",
            "title": "Group"
        }
    },
    "_updated": "Sun, 07 Feb 2016 19:21:41 GMT",
    "title": "Friends",
    "users": [
        {
            "_created": "Sun, 07 Feb 2016 18:34:41 GMT",
            "_etag": "0138d193174528c205827ba9af25b7b8fb93940e",
            "_id": "56b78e41cf7b35255aa5a1e6",
            "_updated": "Sun, 07 Feb 2016 18:46:56 GMT",
            "active": true,
            "firstname": "Jane",
            "lastname": "Doe",
            "username": "janedoe"
        }
    ]
}
</code></pre><p>
Попросим тоже самое в </p><i>XML</i><p>:

</p><pre><code class="xml">$ http http://0.0.0.0:5000/groups/56b79945cf7b35255aa5a1e7/\?embedded='{"users":1}' "Accept":"application/xml"
HTTP/1.0 200 OK
Content-Length: 690
Content-Type: application/xml; charset=utf-8
Date: Sun, 07 Feb 2016 19:43:36 GMT
ETag: c6fc02a0bd4bae92a1310be0748ff8bc971ff209
Last-Modified: Sun, 07 Feb 2016 19:21:41 GMT
Server: Eve/0.6.1 Werkzeug/0.10.4 Python/3.5.0

&lt;resource href="groups/56b79945cf7b35255aa5a1e7" title="Group"&gt;
    &lt;link href="groups" rel="collection" title="groups" /&gt;
    &lt;link href="/" rel="parent" title="home" /&gt;
    &lt;_created&gt;Sun, 07 Feb 2016 19:21:41 GMT&lt;/_created&gt;
    &lt;_etag&gt;c6fc02a0bd4bae92a1310be0748ff8bc971ff209&lt;/_etag&gt;
    &lt;_id&gt;56b79945cf7b35255aa5a1e7&lt;/_id&gt;
    &lt;_updated&gt;Sun, 07 Feb 2016 19:21:41 GMT&lt;/_updated&gt;
    &lt;title&gt;Friends&lt;/title&gt;
    &lt;users&gt;
        &lt;_created&gt;Sun, 07 Feb 2016 18:34:41 GMT&lt;/_created&gt;
        &lt;_etag&gt;0138d193174528c205827ba9af25b7b8fb93940e&lt;/_etag&gt;
        &lt;_id&gt;56b78e41cf7b35255aa5a1e6&lt;/_id&gt;
        &lt;_updated&gt;Sun, 07 Feb 2016 18:46:56 GMT&lt;/_updated&gt;
        &lt;active&gt;True&lt;/active&gt;
        &lt;firstname&gt;Jane&lt;/firstname&gt;
        &lt;lastname&gt;Doe&lt;/lastname&gt;
        &lt;username&gt;janedoe&lt;/username&gt;
    &lt;/users&gt;
&lt;/resource&gt;
</code></pre><p>
Попробуем изменить только имя нашего пользователя (</p><i>без полной перезаписи</i><p>). Для этого воспользуемся </p><i>HTTP</i><p> методом </p><i>PATCH</i><p>:

</p><pre><code class="bash">$ http patch http://0.0.0.0:5000/users/56b78e41cf7b35255aa5a1e6 firstname=John "If-Match":"0138d193174528c205827ba9af25b7b8fb93940e"
HTTP/1.0 200 OK
Content-Length: 276
Content-Type: application/json
Date: Sun, 07 Feb 2016 19:46:48 GMT
ETag: 86f3495cf1d6edf301e25563099844bd816c5a3c
Server: Eve/0.6.1 Werkzeug/0.10.4 Python/3.5.0

{
    "_created": "Sun, 07 Feb 2016 18:34:41 GMT",
    "_etag": "86f3495cf1d6edf301e25563099844bd816c5a3c",
    "_id": "56b78e41cf7b35255aa5a1e6",
    "_links": {
        "self": {
            "href": "users/56b78e41cf7b35255aa5a1e6",
            "title": "User"
        }
    },
    "_status": "OK",
    "_updated": "Sun, 07 Feb 2016 19:46:47 GMT"
}
</code></pre><p>
Что сказала бы бабуля?

</p><pre><code class="bash">» http http://0.0.0.0:5000/users/56b78e41cf7b35255aa5a1e6
HTTP/1.0 200 OK
Content-Length: 431
Content-Type: application/json
Date: Sun, 07 Feb 2016 19:50:06 GMT
ETag: 86f3495cf1d6edf301e25563099844bd816c5a3c
Last-Modified: Sun, 07 Feb 2016 19:46:47 GMT
Server: Eve/0.6.1 Werkzeug/0.10.4 Python/3.5.0

{
    "_created": "Sun, 07 Feb 2016 18:34:41 GMT",
    "_etag": "86f3495cf1d6edf301e25563099844bd816c5a3c",
    "_id": "56b78e41cf7b35255aa5a1e6",
    "_links": {
        "collection": {
            "href": "users",
            "title": "users"
        },
        "parent": {
            "href": "/",
            "title": "home"
        },
        "self": {
            "href": "users/56b78e41cf7b35255aa5a1e6",
            "title": "User"
        }
    },
    "_updated": "Sun, 07 Feb 2016 19:46:47 GMT",
    "active": true,
    "firstname": "John",
    "lastname": "Doe",
    "username": "janedoe"
}
</code></pre><p>
«Усё добра». Мне так понравилось, что я бы создавал пользователей пачками:

</p><pre><code class="bash">$ echo '[{"username": "userone", "firstname": "First", "lastname":"Last"},{"username":"usertwo", "firstname":"First", "lastname":"Last"}]' | http http://0.0.0.0:5000/users
HTTP/1.0 201 CREATED
Content-Length: 585
Content-Type: application/json
Date: Sun, 07 Feb 2016 20:01:33 GMT
Server: Eve/0.6.1 Werkzeug/0.10.4 Python/3.5.0

{
    "_items": [
        {
            "_created": "Sun, 07 Feb 2016 20:01:33 GMT",
            "_etag": "6f397b570ef12769d372c902fa6149bb7e9eaf89",
            "_id": "56b7a29dcf7b35255aa5a1e8",
            "_links": {
                "self": {
                    "href": "users/56b7a29dcf7b35255aa5a1e8",
                    "title": "User"
                }
            },
            "_status": "OK",
            "_updated": "Sun, 07 Feb 2016 20:01:33 GMT"
        },
        {
            "_created": "Sun, 07 Feb 2016 20:01:33 GMT",
            "_etag": "378f30b37724139c213a85079185226ab2b209f3",
            "_id": "56b7a29dcf7b35255aa5a1e9",
            "_links": {
                "self": {
                    "href": "users/56b7a29dcf7b35255aa5a1e9",
                    "title": "User"
                }
            },
            "_status": "OK",
            "_updated": "Sun, 07 Feb 2016 20:01:33 GMT"
        }
    ],
    "_status": "OK"
}
</code></pre><p>
Найдём пользователя "</p><i>John Doe</i><p>" по его имени:

</p><pre><code class="bash">$ http http://0.0.0.0:5000/users\?where='{"firstname":"John"}'
HTTP/1.0 200 OK
Content-Length: 535
Content-Type: application/json
Date: Sun, 07 Feb 2016 20:05:28 GMT
Last-Modified: Sun, 07 Feb 2016 19:46:47 GMT
Server: Eve/0.6.1 Werkzeug/0.10.4 Python/3.5.0
X-Total-Count: 1

{
    "_items": [
        {
            "_created": "Sun, 07 Feb 2016 18:34:41 GMT",
            "_etag": "86f3495cf1d6edf301e25563099844bd816c5a3c",
            "_id": "56b78e41cf7b35255aa5a1e6",
            "_links": {
                "self": {
                    "href": "users/56b78e41cf7b35255aa5a1e6",
                    "title": "User"
                }
            },
            "_updated": "Sun, 07 Feb 2016 19:46:47 GMT",
            "active": true,
            "firstname": "John",
            "lastname": "Doe",
            "username": "janedoe"
        }
    ],
    "_links": {
        "parent": {
            "href": "/",
            "title": "home"
        },
        "self": {
            "href": "users?where={\"firstname\":\"John\"}",
            "title": "users"
        }
    },
    "_meta": {
        "max_results": 25,
        "page": 1,
        "total": 1
    }
}
</code></pre><p>
Отсортируем пользователей по их логину в обратном порядке:

</p><pre><code class="bash">$ http http://0.0.0.0:5000/users\?sort\=-username
HTTP/1.0 200 OK
Content-Length: 1203
Content-Type: application/json
Date: Sun, 07 Feb 2016 20:08:08 GMT
Last-Modified: Sun, 07 Feb 2016 20:01:33 GMT
Server: Eve/0.6.1 Werkzeug/0.10.4 Python/3.5.0
X-Total-Count: 3

{
    "_items": [
        {
            "_created": "Sun, 07 Feb 2016 20:01:33 GMT",
            "_etag": "378f30b37724139c213a85079185226ab2b209f3",
            "_id": "56b7a29dcf7b35255aa5a1e9",
            "_links": {
                "self": {
                    "href": "users/56b7a29dcf7b35255aa5a1e9",
                    "title": "User"
                }
            },
            "_updated": "Sun, 07 Feb 2016 20:01:33 GMT",
            "active": true,
            "firstname": "First",
            "lastname": "Last",
            "username": "usertwo"
        },
        {
            "_created": "Sun, 07 Feb 2016 20:01:33 GMT",
            "_etag": "6f397b570ef12769d372c902fa6149bb7e9eaf89",
            "_id": "56b7a29dcf7b35255aa5a1e8",
            "_links": {
                "self": {
                    "href": "users/56b7a29dcf7b35255aa5a1e8",
                    "title": "User"
                }
            },
            "_updated": "Sun, 07 Feb 2016 20:01:33 GMT",
            "active": true,
            "firstname": "First",
            "lastname": "Last",
            "username": "userone"
        },
        {
            "_created": "Sun, 07 Feb 2016 18:34:41 GMT",
            "_etag": "86f3495cf1d6edf301e25563099844bd816c5a3c",
            "_id": "56b78e41cf7b35255aa5a1e6",
            "_links": {
                "self": {
                    "href": "users/56b78e41cf7b35255aa5a1e6",
                    "title": "User"
                }
            },
            "_updated": "Sun, 07 Feb 2016 19:46:47 GMT",
            "active": true,
            "firstname": "John",
            "lastname": "Doe",
            "username": "janedoe"
        }
    ],
    "_links": {
        "parent": {
            "href": "/",
            "title": "home"
        },
        "self": {
            "href": "users?sort=-username",
            "title": "users"
        }
    },
    "_meta": {
        "max_results": 25,
        "page": 1,
        "total": 3
    }
}
</code></pre><p>
Ну и наконец-то удалим всех пользователей:

</p><pre><code class="bash">$ http delete http://0.0.0.0:5000/users
HTTP/1.0 204 NO CONTENT
Content-Length: 0
Content-Type: application/json
Date: Sun, 07 Feb 2016 20:10:06 GMT
Server: Eve/0.6.1 Werkzeug/0.10.4 Python/3.5.0
</code></pre><p>
Я бы не стал включать данную возможность в </p><i>production</i><p>. Указывается это в параметре </p><i>RESOURCE_METHODS</i><p> (</p><i>стоит убрать из списка DELETE</i><p>):

</p><pre><code class="python">RESOURCE_METHODS = ['GET', 'POST', 'DELETE']
</code></pre>
<h4><font>Заключение</font></h4><p>
Мы рассмотрели не </p><a href="http://python-eve.org/features.html">все возможности</a><p> Eve, но даже c учётом этого – получили законченный вариант </p><i>REST API</i><p>. 
</p><p>
В данной статье я хотел обратить внимание на то, что настоящий RESTful сервис это гораздо больше, чем пара модулей для Node.js и в большинстве случаев нет необходимости разрабатывать такие вещи с нуля, а тем более писать статьи о том, как это сделать за один час. Достаточно взглянуть на </p><a href="https://github.com/nicolaiarocci/eve/commits/develop">историю развития проекта</a><p>, что бы лишний раз убедиться в том, что пары часов/дней/недель недостаточно даже для хорошей команды.

</p><a href="http://nicolaiarocci.com/">Nicola Iarocci</a><p>, автор </p><a href="http://python-eve.org/">Eve</a><p>, создал прекрасный инструмент для быстрого развёртывания </p><i>REST API</i><p>, уделил этому достаточно внимания и сохранил простоту использования.

</p><h4><font>Ссылки</font></h4>

<a href="https://twitter.com/vkozlovski">Подписывайтесь на меня в Twitter</a><p>, я рассказываю о работе в стартапе, своих ошибках и правильных решениях, о python и всём, что касается веб-разработки. 
</p><p>
P.S. </p><i>Я ищу разработчиков в стартап, подробности у меня <a href="http://habrahabr.ru/users/vladkozlovski/">в профиле</a>.</i>

      
      <p class="clear"/>
    </div>

    
  </div></body></html>