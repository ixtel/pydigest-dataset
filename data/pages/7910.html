<html><body><div><div class="entry"><p><a href="https://github.com/mattbierner/blotre-py">Blot’re.py</a> is a thin <a href="https://blot.re">Blot’re</a> client for Python. This library has similar capabilities to <a href="https://blot.re">Blot’re.js</a> and makes it easy to connect all sorts of good stuff to Blot’re. Good stuff like your household plants.</p>

<p>This post provides a quick introduction to Blot’re.py by example. We’ll hook a plant up to Blot’re using a Raspberry Pi and a simple moisture sensor. You can find the complete <a href="https://github.com/mattbierner/blotre-py-moisture-sensor-example">example source code here</a>.</p>

<figure class="image">
    
    <a href="/content/2015-07-23-of-interneting-trees-with-python-and-pi/Chrome_Painter.jpg">
        <img src="/content/2015-07-23-of-interneting-trees-with-python-and-pi/Chrome_Painter.jpg" alt="So shiny, so chrome!"/>
    </a>
    
        <figcaption>So shiny, so chrome!</figcaption>
    
</figure>

<h2 id="hardware">Hardware</h2>
<p>This post is more focused on the software side of things, but let me quickly overview the hardware I used for a simple soil moisture sensor. I’m not a hardware expert by any means, but even I was able to cobble together a working sensor just fine using a few tutorials.</p>

<h3 id="components">Components</h3>
<p>The basic component list comes <a href="http://computers.tutsplus.com/tutorials/build-a-raspberry-pi-moisture-sensor-to-monitor-your-plants--mac-52875">from this tutorial</a>, with a few substations and subtractions.</p>



<h3 id="wiring">Wiring</h3>
<p>The Tuts+ moisture sensor tutorial was written for a Raspberry Pi Model B, so to wire up the analog to digital converter, I switched over to <a href="https://learn.adafruit.com/reading-a-analog-in-and-controlling-audio-volume-with-the-raspberry-pi/connecting-the-cobbler-to-a-mcp3008">an Adafruit tutorial</a>. The only important part is the connection from the Pi to the MCP3008, just ignore all the switches and sensors and whatnot.</p>

<figure class="image">
    
    <a href="/content/2015-07-23-of-interneting-trees-with-python-and-pi/raspberry_pi_pi_volume_knob_bb.png">
        <img src="/content/2015-07-23-of-interneting-trees-with-python-and-pi/raspberry_pi_pi_volume_knob_bb.png" alt=""/>
    </a>
    
</figure>

<p>I wried up the moisture sensor to pin 0 on the MCP3008. The Adafruit tutorial also had some helpful Python code for reading integer values from the MCP3008 that I’ll reference, but won’t cover in any detail. The <a href="https://github.com/mattbierner/blotre-py-moisture-sensor-example">example source</a> includes all that if you’re interested.</p>

<figure class="image">
    
    <a href="/content/2015-07-23-of-interneting-trees-with-python-and-pi/wire-ratking.png">
        <img src="/content/2015-07-23-of-interneting-trees-with-python-and-pi/wire-ratking.png" alt="I must admit that my wiring was actually closer to this."/>
    </a>
    
        <figcaption>I must admit that my wiring was actually closer to this.</figcaption>
    
</figure>

<h2 id="blotrepy">Blot’re.py</h2>
<p>Back to the safety of software.</p>

<h3 id="installation">Installation</h3>
<p>We’ll need to install a few Python libraries before starting.</p>

<p><code class="highlighter-rouge">rpi.gpio</code> allows us to read the sensor data.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ sudo easy_install rpi.gpio
</code></pre>
</div>

<p>And Blot’re.py of course, along with <a href="https://github.com/jsvine/spectra">Spectra</a>, a library for sampling colors. Both have pip packages:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ pip install blotre spectra 
</code></pre>
</div>

<h3 id="basic-queries">Basic Queries</h3>
<p>The most basic use of Blot’re.py is to query Blot’re. This can be performed without authorization of any kind.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">blotre</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">blotre</span><span class="o">.</span><span class="n">Blotre</span><span class="p">({})</span>
</code></pre>
</div>

<p>Blot’re.py has thin wrappers for all the common Blot’re stream [REST operations][blotre-retst]. All operations return the exact same JSON data that the REST endpoints do, but parsed to Python dicts and lists.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">client</span><span class="o">.</span><span class="n">get_streams</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="p">[{</span><span class="s">u'status'</span><span class="p">:</span> <span class="p">{</span><span class="s">u'color'</span><span class="p">:</span> <span class="s">u'#362f55'</span><span class="p">,</span> <span class="s">u'poster'</span><span class="p">:</span> <span class="s">u'554666c3e4b0fa7f3e694afe'</span><span class="p">,</span> <span class="s">u'created'</span><span class="p">:</span> <span class="mi">1437632689172</span><span class="p">},</span> <span class="s">u'updated'</span><span class="p">:</span> <span class="mi">1437632689172</span><span class="p">,</span> <span class="s">u'name'</span><span class="p">:</span> <span class="s">u'Eyes Wide Shut'</span><span class="p">,</span> <span class="s">u'created'</span><span class="p">:</span> <span class="mi">1436757651967</span><span class="p">,</span> <span class="s">u'uri'</span><span class="p">:</span> <span class="s">u'matt/vidre/eyes+wide+shut'</span><span class="p">,</span> <span class="s">u'owner'</span><span class="p">:</span> <span class="s">u'554666c3e4b0fa7f3e694afe'</span><span class="p">,</span> <span class="s">u'id'</span><span class="p">:</span> <span class="s">u'55a32e93e4b0a1c13daf2e93'</span><span class="p">},</span> <span class="p">{</span><span class="s">u'status'</span><span class="p">:</span> <span class="p">{</span><span class="s">u'color'</span><span class="p">:</span> <span class="s">u'#dc4343'</span><span class="p">,</span> <span class="s">u'poster'</span><span class="p">:</span> <span class="s">u'554666c3e4b0fa7f3e694afe'</span><span class="p">,</span> <span class="s">u'created'</span><span class="p">:</span> <span class="mi">1437632688970</span><span class="p">},</span> <span class="s">u'updated'</span><span class="p">:</span> <span class="mi">1437632688970</span><span class="p">,</span> <span class="s">u'name'</span><span class="p">:</span> <span class="s">u'Moby Dick'</span><span class="p">,</span> <span class="s">u'created'</span><span class="p">:</span> <span class="o">...</span><span class="p">]</span>
</code></pre>
</div>

<p>Operations take an optional set of parameters as well, which are treated as the query parameters of the REST request.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">client</span><span class="o">.</span><span class="n">get_streams</span><span class="p">({</span> <span class="s">'query'</span><span class="p">:</span> <span class="s">'moby'</span> <span class="p">})</span>
<span class="o">&gt;&gt;&gt;</span> <span class="p">[{</span><span class="s">u'status'</span><span class="p">:</span> <span class="p">{</span><span class="s">u'color'</span><span class="p">:</span> <span class="s">u'#41d4d4'</span><span class="p">,</span> <span class="s">u'poster'</span><span class="p">:</span> <span class="s">u'554666c3e4b0fa7f3e694afe'</span><span class="p">,</span> <span class="s">u'created'</span><span class="p">:</span> <span class="mi">1437632991057</span><span class="p">},</span> <span class="s">u'updated'</span><span class="p">:</span> <span class="mi">1437632991057</span><span class="p">,</span> <span class="s">u'name'</span><span class="p">:</span> <span class="s">u'Moby Dick'</span><span class="p">,</span> <span class="s">u'created'</span><span class="p">:</span> <span class="mi">1433486657156</span><span class="p">,</span> <span class="s">u'uri'</span><span class="p">:</span> <span class="s">u'matt/moby+dick'</span><span class="p">,</span> <span class="s">u'owner'</span><span class="p">:</span> <span class="s">u'554666c3e4b0fa7f3e694afe'</span><span class="p">,</span> <span class="s">u'id'</span><span class="p">:</span> <span class="s">u'55714541e4b0bdccb3e69644'</span><span class="p">}]</span>
</code></pre>
</div>

<p>If a request fails, it raises a <code class="highlighter-rouge">blotre.RestError</code>. This object has the status code of the response, along with the <code class="highlighter-rouge">error</code> and <code class="highlighter-rouge">error_description</code> fields returned by Blot’re.</p>

<h3 id="authorization-and-authorization-code-flow">Authorization and Authorization Code Flow</h3>
<p>Authorization is required for create, update, and delete operations. If you already have credentials, you can manually provides them when you create a new client instance.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">client</span> <span class="o">=</span> <span class="n">blotre</span><span class="o">.</span><span class="n">Blotre</span><span class="p">({},</span> <span class="n">creds</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'access_token'</span> <span class="o">=</span> <span class="s">"token value"</span><span class="p">,</span>
    <span class="s">'refresh_token'</span> <span class="o">=</span> <span class="s">"optional, refresh token value"</span>
<span class="p">})</span>
</code></pre>
</div>

<p>But if your app needs to obtain credentials, you have two options: the OAuth2 authorization code flow or using a <a href="https://github.com/mattbierner/blotre/wiki/single-use-clients">Blot’re disposable clients</a>. We’ll use a disposable client, but let’s take a quick look at the authorization code flow first.</p>

<p>The empty <code class="highlighter-rouge"><span class="p">{}</span></code> we’ve been passing to the <code class="highlighter-rouge">Blotre</code> constructor is the client metadata. <a href="https://github.com/mattbierner/blotre/wiki/registering-a-client">Register a client app on Blot’re</a> and then use this provided values to create a new instance:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">client</span> <span class="o">=</span> <span class="n">blotre</span><span class="o">.</span><span class="n">Blotre</span><span class="p">({</span>
    <span class="s">'client_id'</span><span class="p">:</span> <span class="s">"55614f0630042c617481d7c3"</span><span class="p">,</span>
    <span class="s">'client_secret'</span><span class="p">:</span> <span class="s">"YTY1Njg2MDctZTdjYy00ODlhLWFkNmYtNjkzYjI3N2M0MDRl"</span><span class="p">,</span>
    <span class="s">'redirect_uri'</span><span class="p">:</span> <span class="s">"http://localhost:50000"</span><span class="p">,</span>
<span class="p">})</span>
</code></pre>
</div>

<p>This app is not yet authorized, so we must get the user to visit the authorization url and obtain an authorization code.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">print</span> <span class="n">client</span><span class="o">.</span><span class="n">get_authorization_url</span><span class="p">()</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">blot</span><span class="o">.</span><span class="n">re</span><span class="o">/</span><span class="n">v0</span><span class="o">/</span><span class="n">oauth2</span><span class="o">/</span><span class="n">authorize</span><span class="err">?</span><span class="n">redirect_uri</span><span class="o">=</span><span class="n">http</span><span class="o">%</span><span class="mi">3</span><span class="n">A</span><span class="o">%</span><span class="mi">2</span><span class="n">F</span><span class="o">%</span><span class="mi">2</span><span class="n">Flocalhost</span><span class="o">%</span><span class="mi">3</span><span class="n">A50000</span><span class="o">&amp;</span><span class="n">response_type</span><span class="o">=</span><span class="n">code</span><span class="o">&amp;</span><span class="n">client_id</span><span class="o">=</span><span class="mi">55614</span><span class="n">f0630042c617481d7c3</span>
</code></pre>
</div>

<p>Once you obtain the code, call <code class="highlighter-rouge">redeem_authorization_code</code> to get credentials. Any of the token endpoint requests may raise an <code class="highlighter-rouge">blotre.TokenEndpointError</code> if the request fails.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">try</span><span class="p">:</span>
    <span class="c"># Exchange the code for creds and update the current client</span>
    <span class="n">client</span><span class="o">.</span><span class="n">redeem_authorization_code</span><span class="p">(</span><span class="n">returned_code</span><span class="p">)</span>
    <span class="c"># Client is now authorized</span>
<span class="k">except</span> <span class="n">blotre</span><span class="o">.</span><span class="n">TokenEndpointError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="c"># Something went wrong.</span>
    <span class="k">print</span> <span class="n">e</span>
</code></pre>
</div>

<p>But if the request succeeded, you can now make authorized requests on behalf of the authorizing user.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c"># Create a new child stream for the authorized user.</span>
<span class="n">name</span> <span class="o">=</span> <span class="s">'$T O A S T$'</span>
<span class="n">client</span><span class="o">.</span><span class="n">create_stream</span><span class="p">({</span>
    <span class="s">'name'</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
    <span class="s">'uri'</span><span class="p">:</span> <span class="n">client</span><span class="o">.</span><span class="n">join_uri</span><span class="p">(</span>
        <span class="n">client</span><span class="o">.</span><span class="n">get_stream</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">creds</span><span class="p">[</span><span class="s">'user'</span><span class="p">][</span><span class="s">'rootStream'</span><span class="p">])[</span><span class="s">'uri'</span><span class="p">],</span>
        <span class="n">name</span><span class="p">)</span>
<span class="p">})</span>
</code></pre>
</div>

<h3 id="disposable-client">Disposable Client</h3>
<p><a href="https://github.com/mattbierner/blotre/wiki/single-use-clients">Disposable client apps</a> are good for prototyping and hacking together simple applications, like our soil moisture sensor. Blot’re has two APIs for creating disposable client apps: one that is just a thin wrapper around the Blot’re disposable API and one that provides a framework for persisting creds and prompting the user to redeem the onetime code. We’ll use the latter.</p>

<p>To create a new disposable app, call <code class="highlighter-rouge">create_disposable_app</code> and pass in the required client metadata.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">client</span> <span class="o">=</span> <span class="n">blotre</span><span class="o">.</span><span class="n">create_disposable_app</span><span class="p">({</span>
    <span class="s">'name'</span><span class="p">:</span> <span class="s">"FaceToast"</span><span class="p">,</span>
    <span class="s">'blurb'</span><span class="p">:</span> <span class="s">"Your face on toast!"</span>
<span class="p">})</span>
</code></pre>
</div>
<p><code class="highlighter-rouge">create_disposable_app</code> checks for persisted client data and makes sure these credentials are valid. If the creds are valid, no further steps are required and <code class="highlighter-rouge">client</code> can make authorized requests.</p>

<p>If no persisted creds are available or the client data has expired, a new disposable app is registered with Blot’re. The user is then prompted to redeem the code and press enter once they have completed this. Once they do this, the client exchanges its secret for an access token and becomes authorized. In either case, we always end up with an authorized client app after <code class="highlighter-rouge">create_disposable_app</code> returns.</p>

<h2 id="plantre">Plant’re</h2>
<p>Now let’s use Blot’re.py to connect some plants to the internet. The actual client app is pretty simple.</p>

<h3 id="python-app">Python App</h3>
<p>First we have to set up GPIO:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">RPi.GPIO</span> <span class="kn">as</span> <span class="nn">GPIO</span>

<span class="n">SPICLK</span> <span class="o">=</span> <span class="mi">18</span>
<span class="n">SPIMISO</span> <span class="o">=</span> <span class="mi">23</span>
<span class="n">SPIMOSI</span> <span class="o">=</span> <span class="mi">24</span>
<span class="n">SPICS</span> <span class="o">=</span> <span class="mi">25</span>

<span class="n">GPIO</span><span class="o">.</span><span class="n">setmode</span><span class="p">(</span><span class="n">GPIO</span><span class="o">.</span><span class="n">BCM</span><span class="p">)</span>
<span class="n">GPIO</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">SPIMOSI</span><span class="p">,</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="n">GPIO</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">SPIMISO</span><span class="p">,</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">IN</span><span class="p">)</span>
<span class="n">GPIO</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">SPICLK</span><span class="p">,</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="n">GPIO</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">SPICS</span><span class="p">,</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
</code></pre>
</div>

<p>We’ll also use a few other constants. We’ll use Spectra to sample the colors and I’ve included a sample range from my testing. Feel free to adjust any of these.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">spectra</span>

<span class="n">TARGET_STREAM_NAME</span> <span class="o">=</span> <span class="s">"Mr Tree"</span>

<span class="c"># Range of sensor reading, from just watered to dry soil</span>
<span class="n">MOISTURE_SENSOR_MAX</span> <span class="o">=</span> <span class="mi">825</span>
<span class="n">MOISTURE_SENSOR_MIN</span> <span class="o">=</span> <span class="mi">400</span>

<span class="n">MOISTURE_SCALE</span> <span class="o">=</span> <span class="n">spectra</span><span class="o">.</span><span class="n">scale</span><span class="p">([</span><span class="s">"#654d00"</span><span class="p">,</span> <span class="s">"green"</span><span class="p">])</span>
    <span class="o">.</span><span class="n">domain</span><span class="p">([</span><span class="n">MOISTURE_SENSOR_MIN</span><span class="p">,</span> <span class="n">MOISTURE_SENSOR_MAX</span><span class="p">])</span>

<span class="c"># How often should the sensor be checked? (in seconds)</span>
<span class="n">INTERVAL</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">5</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">update_plant_status</code> is the function that actually uploads the status of the plant. <code class="highlighter-rouge">create_stream</code> will automatically create a new stream if none exists or update the color of the existing stream.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">update_plant_status</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">rootStream</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">create_stream</span><span class="p">({</span>
        <span class="s">'name'</span><span class="p">:</span> <span class="n">TARGET_STREAM_NAME</span><span class="p">,</span>
        <span class="s">'uri'</span><span class="p">:</span> <span class="n">client</span><span class="o">.</span><span class="n">join_uri</span><span class="p">(</span><span class="n">rootStream</span><span class="p">[</span><span class="s">'uri'</span><span class="p">],</span> <span class="n">TARGET_STREAM_NAME</span><span class="p">),</span>
        <span class="s">'status'</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">'color'</span><span class="p">:</span> <span class="n">status</span>
        <span class="p">}</span>
    <span class="p">})</span>
</code></pre>
</div>

<p>Creating the client itself is very easy. The optional <code class="highlighter-rouge">file</code> parameter ensures that we always persist the client credentials to the same location even if the script is run from multiple places.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">client</span> <span class="o">=</span> <span class="n">blotre</span><span class="o">.</span><span class="n">create_disposable_app</span><span class="p">({</span>
    <span class="s">'name'</span><span class="p">:</span> <span class="s">"Plant're"</span><span class="p">,</span>
    <span class="s">'blurb'</span><span class="p">:</span> <span class="s">"Blot're you a plant."</span><span class="p">,</span>
    <span class="s">'file'</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">)),</span>
        <span class="s">'plantre.clientdata.json'</span><span class="p">)</span>
<span class="p">})</span>

<span class="k">def</span> <span class="nf">get_root_stream</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">get_stream</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">creds</span><span class="p">[</span><span class="s">'user'</span><span class="p">][</span><span class="s">'rootStream'</span><span class="p">])</span>

<span class="n">rootStream</span> <span class="o">=</span> <span class="n">get_root_stream</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
</code></pre>
</div>

<p>Finally, we start reading the sensor value every five minutes and uploading the data. <code class="highlighter-rouge">readadc</code> comes from the <a href="https://learn.adafruit.com/reading-a-analog-in-and-controlling-audio-volume-with-the-raspberry-pi/connecting-the-cobbler-to-a-mcp3008">Adafruit tutorial</a>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">clamp</span><span class="p">(</span><span class="n">minVal</span><span class="p">,</span> <span class="n">maxVal</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">maxVal</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">minVal</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
    
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">readadc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SPICLK</span><span class="p">,</span> <span class="n">SPIMOSI</span><span class="p">,</span> <span class="n">SPIMISO</span><span class="p">,</span> <span class="n">SPICS</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">sample</span>
    <span class="n">update_plant_status</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">rootStream</span><span class="p">,</span>
        <span class="n">MOISTURE_SCALE</span><span class="p">(</span><span class="n">clamp</span><span class="p">(</span><span class="n">MOISTURE_SENSOR_MIN</span><span class="p">,</span> <span class="n">MOISTURE_SENSOR_MAX</span><span class="p">,</span> <span class="n">sample</span><span class="p">))</span><span class="o">.</span><span class="n">hexcode</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">INTERVAL</span><span class="p">)</span>
</code></pre>
</div>

<p>On the first run, you’ll be prompted to redeem the code. After that though, if everything goes right, this script should continue to run forever, with Blot’re.py silently exchanging the refresh token for new credentials behind the scenes.</p>

<h3 id="starting-on-boot">Starting on Boot</h3>
<p>If you are interested in using Blot’re.py for sensors, it’s helpful to running your scripts as daemons and starting them on boot. I’ve included a sample init.d script in <a href="https://github.com/mattbierner/blotre-py-moisture-sensor-example">the source</a> based on <a href="http://blog.scphillips.com/posts/2013/07/getting-a-python-script-to-run-in-the-background-as-a-service-on-boot/">this post</a>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>!/bin/sh
<span class="c"># Based on: http://blog.scphillips.com/posts/2013/07/getting-a-python-script-to-run-in-the-background-as-a-service-on-boot/</span>

<span class="c"># kFreeBSD do not accept scripts as interpreters, using #!/bin/sh and sourcing.</span>
<span class="k">if</span> <span class="o">[</span> <span class="nb">true</span> !<span class="o">=</span> <span class="s2">"</span><span class="nv">$INIT_D_SCRIPT_SOURCED</span><span class="s2">"</span> <span class="o">]</span> ; <span class="k">then
    </span><span class="nb">set</span> <span class="s2">"</span><span class="nv">$0</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span>; <span class="nv">INIT_D_SCRIPT_SOURCED</span><span class="o">=</span><span class="nb">true</span> . /lib/init/init-d-script
<span class="k">fi</span>

<span class="c">### BEGIN INIT INFO</span>
<span class="c"># Provides:          plantre</span>
<span class="c"># Required-Start:    $remote_fs $syslog</span>
<span class="c"># Required-Stop:     $remote_fs $syslog</span>
<span class="c"># Default-Start:     2 3 4 5</span>
<span class="c"># Default-Stop:      0 1 6</span>
<span class="c"># Short-Description: Blot're soil moisture sensor.</span>
<span class="c">### END INIT INFO</span>

<span class="c"># Update to point to where script `main.py` lives.</span>
<span class="nv">DIR</span><span class="o">=</span>/home/blotre/plantre
<span class="nv">DAEMON</span><span class="o">=</span><span class="nv">$DIR</span>/main.py
<span class="nv">DAEMON_NAME</span><span class="o">=</span>plantre

<span class="c"># Must run as root for GIPO.</span>
<span class="nv">DAEMON_USER</span><span class="o">=</span>root

<span class="nv">PIDFILE</span><span class="o">=</span>/var/run/<span class="nv">$DAEMON_NAME</span>.pid

do_start <span class="o">()</span> <span class="o">{</span>
    log_daemon_msg <span class="s2">"Starting system </span><span class="nv">$DAEMON_NAME</span><span class="s2"> daemon"</span>
    start-stop-daemon --start --background --pidfile <span class="nv">$PIDFILE</span> --make-pidfile --user <span class="nv">$DAEMON_USER</span> --chuid <span class="nv">$DAEMON_USER</span> --startas <span class="nv">$DAEMON</span> -- <span class="nv">$DAEMON_OPTS</span>
    log_end_msg <span class="nv">$?</span>
<span class="o">}</span>

do_stop <span class="o">()</span> <span class="o">{</span>
    log_daemon_msg <span class="s2">"Stopping system </span><span class="nv">$DAEMON_NAME</span><span class="s2"> daemon"</span>
    start-stop-daemon --stop --pidfile <span class="nv">$PIDFILE</span> --retry 10
    log_end_msg <span class="nv">$?</span>
<span class="o">}</span>

<span class="k">case</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="k">in
    </span>start|stop<span class="p">)</span>
        do_<span class="k">${</span><span class="nv">1</span><span class="k">}</span>
        <span class="p">;;</span>
    restart|reload|force-reload<span class="p">)</span>
        do_stop
        do_start
        <span class="p">;;</span>
    status<span class="p">)</span>
        status_of_proc <span class="s2">"</span><span class="nv">$DAEMON_NAME</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$DAEMON</span><span class="s2">"</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>0 <span class="o">||</span> <span class="nb">exit</span> <span class="nv">$?</span>
        <span class="p">;;</span>
    <span class="k">*</span><span class="p">)</span>
        <span class="nb">echo</span> <span class="s2">"Usage: /etc/init.d/</span><span class="nv">$DAEMON_NAME</span><span class="s2"> {start|stop|restart|status}"</span>
        <span class="nb">exit </span>1
        <span class="p">;;</span>
<span class="k">esac</span>
<span class="nb">exit </span>0
</code></pre>
</div>

<p>To use this script be sure to:</p>

<ul>
  <li>Update <code class="highlighter-rouge">DIR</code> to point to where your copy of <code class="highlighter-rouge">main.py</code> lives.</li>
  <li>Copy it into <code class="highlighter-rouge">/etc/init</code></li>
  <li>Make sure both all scripts are executable.</li>
  <li>Run <code class="highlighter-rouge">sudo update-rc.d plantre.init.d.sh defaults</code> to register script to be run at init.</li>
</ul>

<p>Start or stop the script by running:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>sudo /etc/init.d/plantre.init.d.sh start
</code></pre>
</div>

<h1 id="conclusion">Conclusion</h1>
<p>Here’s the <a href="https://blot.re/s/matt/mr+tree">stream from my tree</a> using this script.</p>

<figure class="image">
    
    <a href="/content/2015-07-23-of-interneting-trees-with-python-and-pi/_DSC7976.jpg">
        <img src="/content/2015-07-23-of-interneting-trees-with-python-and-pi/_DSC7976.jpg" alt="Featuring production ready tupperware enclosure."/>
    </a>
    
        <figcaption>Featuring production ready tupperware enclosure.</figcaption>
    
</figure>

<p>Be sure to checkout the rest of the <a href="https://github.com/mattbierner/blotre-py-moisture-sensor-example">example source</a> and please report any bug you find in <a href="https://github.com/mattbierner/blotre-py">Blot’re.py</a>.</p>

</div>

    
</div></body></html>