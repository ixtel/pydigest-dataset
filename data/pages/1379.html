<html><body><div><div class="entry-content">
		<p>I don’t know whether I can be considered a <a href="http://en.wikipedia.org/wiki/Data_steward">data steward</a> or maybe more like a data janitor for my department, but what I know is that my work consists of a lot of data wrangling in Excel. Some are routine like generating monthly reports, while the rest ad-hoc analytics and policy making, especially important as we are building a new hospital and setting up new systems.</p>
<p>There is of course <em>tremendous</em> amount of time saving if you actually use some programming skillz to automate the data analysis. One tricky part though is that the input and output must be in Excel files (non-technical people will want to view the output), and those are not exactly the most pleasant file type to work with from programming perspective.</p>
<p>Luckily there are a lot of options to parse and write Excel files in Python – my language of choice for quick-and-dirty scripting – and goodness gracious I have tried almost all of them. So here are the methods I have used and their pros and cons.</p>


<h1><span id="Convert_to_CSV_death_to_proprietary_file_formats">Convert to CSV: death to proprietary file formats!</span></h1>
<p>Probably the most straightforward way to import the data to Python constructs is to just convert the Excel file to CSV, either by manually using the “Save As” function in Excel or using tools like <a href="https://csvkit.readthedocs.org"><code>csvkit</code></a>. Then you can use <code>csvkit</code> again for some basic manipulation like merging workbooks and performing joins.</p>
<p>This is not strictly Python only, because <code>csvkit</code> is a command line program and you can read the resulting CSV with whatever libraries available including the <a href="https://docs.python.org/3/library/csv.html">built in <code>csv</code> module in Python</a>.</p>
<p>This method is simple and probably the fastest to write for basic tasks like merging sheets. The <code>csvkit</code> docs gives a nice overview of how to do those tasks. However, you need to use other method to write Excel workbooks (or write CSVs and then convert to Excel manually). Also, in case you haven’t noticed yet, CSVs do not support rich formatting.</p>
<h1><span id="Datanitro_Excel_macros_for_Python_literates">Datanitro: Excel macros for Python literates</span></h1>
<p><a href="https://datanitro.com/">Datanitro</a> is a great tool (was free for personal use some time ago but not anymore) that basically enables you to write macros in Python that are able to modify the workbook in place while the Excel application is open. It is an alternative to the built-in Visual Basic for Applications (VBA) macros, which are to be frank rather unpleasant to write in.</p>
<p>I like the simplicity and also the ability to retain and apply formatting, which can also save quite some tedious time reformatting output workbooks. This makes Datanitro a very good choice for reports that needs to be “pretty”, and in my case I am also able to use it together with the charting capabilities of Excel. I created a “template” Excel file; whenever I want to generate the report, I copy the data into the template, run the Datanitro script, and the Save As the workbook to a new file.</p>
<p>The biggest turnoff is that Datanitro scripts, while valid Python programs, cannot be run without the Datanitro itself installed. Installation requires administrative rights and also money (after the free trial expires), which a lot of my colleagues do not have. It also means that those scripts are vendor-locked-in to the Datanitro platform.</p>
<p><del datetime="2014-08-24T01:40:51+00:00">Another issue is that it simply cannot access more than one workbook at the same time, thus tasks that uses more than one workbook at the same time are impossible to automate this way.</del> <strong>EDIT:</strong> Datanitro does support <a href="https://datanitro.com/docs/workbook.html#multiple-workbooks">opening multiple workbooks</a>! Ben the co-founder showed it to me. Thanks <img src="http://i1.wp.com/leontius.net/wp-includes/images/smilies/simple-smile.png?w=700" alt=":)" class="wp-smiley" data-recalc-dims="1"/></p>
<h1><span id="Parsing_let8217s_do_some_real_programming">Parsing: let’s do some real programming</span></h1>
<p>This is of course by far the most flexible automation method that you can come up with, and it is basically writing a script that reads, processes, and writes Excel files. There are modules in Python that provide common tasks so that you do not need to write routines for parsing the Excel workbooks.</p>
<h2><span id="openpyxl">openpyxl</span></h2>
<p><a href="https://pythonhosted.org/openpyxl/"><em>openpyxl</em></a> is the one that I used the most. The APIs are convenient (with several high-level functions like accessing ranges), concise, and well documented. Besides accessing cells, cell ranges, and sheets, as well as writing Excel files from scratch, openpyxl can also perform basic formatting tasks like setting bold/italic font, text colour, and row/column sizes. This is really helpful if you want to create Excel files from scratch that are readily human-digestible.</p>
<p>My only gripe about openpyxl now is probably just performance. It takes almost a full minute to parse one workbook with (3 sheets x 1000 rows x 10 columns) in an i5 laptop. Last time I checked it doesn’t seem to be compatible yet with <a href="http://pypy.org/">pypy</a>.</p>
<h2><span id="pandas">pandas</span></h2>
<p><a href="http://pandas.pydata.org/"><em>pandas</em></a> is <em>the</em> module to use for any serious number-crunching in Python; users of Matlab and R will feel right at home using this tool. It has <a href="http://pandas.pydata.org/pandas-docs/stable/io.html">read and write functions to several common data format, including Excel workbooks</a>. It imports the Excel workbook into a Pandas DataFrame objects, with which you can analyse and manipulate using any of the provided methods. Pandas has extensive utility functions for merging, joining, grouping, filtering, performing calculations, as well as statistical concepts like standard descriptive analysis (mean/median/mode/standard error) and moving average. Together with <a href="http://matplotlib.org/">matplotlib</a> for plotting/charting capabilities and <a href="http://ipython.org/">IPython</a> for interactive programming, it enables you to perform advanced analysis pretty quickly.</p>
<p>I have begun to use this method more often the more I learn about Pandas. The learning curve is definitely higher than just using openpyxl – DataFrames can have their own quirks – but the reward is significant. Anyway when you parse using openpyxl, usually you are building a data structure in memory; rather than doing that, might as well just use Pandas DataFrames.</p>
<p>Performance wise it is comparable to openpyxl as pandas uses it under the hood. The stock <code>to_excel()</code> method does not allow any formatting customizations though. Also, I find that loading from CSV is much faster than loading from Excel, so you may want to do a one-time conversion to CSV (via <code>from_excel()</code> then <code>to_csv()</code>, or use <code>csvkit</code> tool elaborated in a previous section) if you load a workbook often.</p>
<h2><span id="xlwt_xlrd">xlwt / xlrd</span></h2>
<p>The modules <a href=""><em>xlrd</em> and <em>xlwt</em></a> reads and writes to Excel 2003 (<code>.xls</code>) format. I do not have much experience using these modules, since openpyxl is usually what I need, but in case you still need to parse <code>.xls</code> files, you know where to look.</p>
<h1><span id="Using_SQL_in_Excel">Using SQL in Excel</span></h1>
<p>A lot of common data cleaning and analysis tasks become easier if you are able to use SQL over an Excel database, but doing this without jumping through the hoops is not trivial. A few ways doing this I have yet to explore fully include:</p>
<ul>
<li>Using utilities like <a href="https://github.com/dinedal/textql">textql</a>: I’m not able to find one that is easily downloadable. textql requires compilation using the Go development environment which for various reason I have not been doing.</li>
<li><a href="https://pypi.python.org/pypi/pandasql">pandasql</a> enables you to run SQL queries in Pandas DataFrames.</li>
<li>Using Pandas <code>from_excel()</code> to get the DataFrame, and then <code>to_sql()</code> to put it inside an SQLite database (can be in-memory too). Then use <code>read_sql_table()</code> and <code>read_sql_query()</code> for queries.</li>
<li>Import the Excel files to Microsoft Access. I find the UI rather clunky (e.g. unable to import multiple Excel files at one go) but MS Access <em>is</em> a real database. Not to mention that it is rather expensive.</li>
</ul>
<p>In general though, vanilla Pandas DataFrames can usually suit your needs and are probably faster for multi-megabyte workbooks.</p>
<h1><span id="Conclusion_or_TLDR">Conclusion, or TL;DR</span></h1>
<p>Invest time in studying <a href="http://pandas.pydata.org/">pandas</a>.</p>

<p id="jp-relatedposts" class="jp-relatedposts">
	<h3 class="jp-relatedposts-headline"><span id="Related"><em>Related</em></span></h3>
</p>			</div>
		</div></body></html>