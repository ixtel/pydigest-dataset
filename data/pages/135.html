<html><body><div><div class="entry-content">
      <p>Today for <a href="/learning-30-technologies-in-30-days-a-developer-challenge">my 30 day challenge</a>, I decided to take a break from JavaScript and learn a web framework called <a href="http://www.tornadoweb.org/">Tornado</a>.</p>
<p>I decided to learn Tornado to write a web application in Python. I only know the <a href="http://flask.pocoo.org/">Flask framework</a> so I thought Tornado would be a good addition to my Python web development skills. Today’s application uses <a href="http://www.tornadoweb.org/">Tornado</a> for the REST backend, <a href="http://www.mongodb.org/">MongoDB</a> as the database, <a href="http://angularjs.org/">AngularJS</a> as the client side JavaScript MV* framework, and <a href="https://www.openshift.com/">OpenShift</a> as the deployment platform.</p>
<p><img src="/wp-content/uploads/imported/tornado.png" alt="Tornado logo"/></p>
<h2>What is Tornado?</h2>
<p><a href="https://github.com/facebook/tornado">Tornado</a> is an open-source Python Web framework and non blocking web server, developed at FriendFeed. Facebook bought FriendFeed and continues to maintains and develops Tornado. It has excellent scalability characteristics due to its non-blocking network I/O nature and scales to thousands of simultaneous connections.</p>
<h2>Application Usecase</h2>
<p>In this blog post, we will develop a social bookmarking application which allows users to post and share links. You can view the live application running on OpenShift <a href="http://day25demo-shekhargulati.rhcloud.com/#/">here</a>. This is the same application which we developed on <a href="/day-22-developing-single-page-applications-with-spring-mongodb-and-angularjs">day 22</a> so please refer to the blog to better understand the application usecase.</p>
<h2>Github Repository</h2>
<p>The code for today’s demo application is available on <a href="https://github.com/shekhargulati/day25-tornado-demo-app">github: day25-tornado-demo-app</a>.</p>
<h2>Prerequisite</h2>
<p>Before we can get started with Tornado, we need to install <a href="http://www.python.org/download/">Python</a> and <a href="http://www.virtualenv.org/en/latest/">virtualenv</a> on the machine. The Python version I am using in this blog post is 2.7.</p>
<p>This application uses MongoDB as data storage choice so please <a href="http://www.mongodb.org/downloads">download the latest MongoDB release</a> for your operation system.</p>
<h2>Developing Tornado MongoDB Application</h2>
<p>We will use the pip install to get started with Tornado. For developers unaware of pip, it is Python package manager. We can install pip from the <a href="https://pypi.python.org/pypi/pip">official website</a>. Go to any convenient directory on your file system, and run following commands.</p>
<div class="geshifilter">
<pre class="text geshifilter-text">$ mkdir getbookmarks
$ cd getbookmarks
$ virtualenv venv --python=python2.7
$ . venv/bin/activate
$ pip install tornado
$ pip install pymongo</pre>
</div>
<p>Theses commands create a getbookmarks directory on the local machine, activate virtualenv with Python version 2.7, install the tornado package and install pymongo. The pymongo is the official MongoDB Python driver. We will use it to write stories into MongoDB.</p>
<p>Create a new file called getbookmarks.py under the getbookmarks folder.</p>

<p>Copy the following code and paste it in the getbookmarks.py source file</p>
<div class="geshifilter">
<pre class="text geshifilter-text">import os
from tornado import ioloop,web
from pymongo import MongoClient
import json
from bson import json_util
from bson.objectid import ObjectId
 
class IndexHandler(web.RequestHandler):
    def get(self):
        self.write("Hello World!!")
 
settings = {
    "template_path": os.path.join(os.path.dirname(__file__), "templates"),
    "static_path": os.path.join(os.path.dirname(__file__), "static"),
    "debug" : True
}
 
application = web.Application([
    (r'/', IndexHandler),
    (r'/index', IndexHandler),
],**settings)
 
if __name__ == "__main__":
    application.listen(8888)
    ioloop.IOLoop.instance().start()</pre>
</div>
<p>This code:</p>
<ol>
<li>
<p>Imports the required libraries.</p>
</li>
<li>
<p>Defines a new class called IndexHandler which extends web.RequestHandler. A Tornado web applications maps URLs or URL patterns to subclasses of the web.RequestHandler class. These classes define get(), post(),etc. methods to handle HTTP GET or POST requests to that URL. When a GET request is made  to the ‘/’ url, then IndexHandler will respond with “Hello World!!”.</p>
</li>
<li>
<p>Defines some application settings. The <strong><em>template_path</em></strong> setting tells the Tornado application to look for application templates in the <strong><em>templates</em></strong> directory. The <strong><em>static_path</em></strong> setting informs the application to use the static directory for static assets like css, images, and javascript files.  We also enable debugging by passing <strong><em>debug:True</em></strong>.  The main benefit of the debugger is it automatically reloads changes. We can keep the debugger running in the background and work through our application. This provides a highly productive environment.</p>
</li>
<li>
<p>Creates the Tornado application instance passing it the routes and settings.</p>
</li>
<li>
<p>Starts application server using the python getbookmarks.py command.</p>
</li>
</ol>
<p>Run the application using the command shown below. Go to <a href="http://localhost:8888" title="http://localhost:8888">http://localhost:8888</a> and <a href="http://localhost:8888/index" title="http://localhost:8888/index">http://localhost:8888/index</a> to verify you see “Hello World!!”.</p>

<h3>Configure MongoDB</h3>
<p>Add the following lines after importing the libraries. We defined MongoDB connection url and database name. If the application is deployed on OpenShift then OpenShift specific environment variables will be used otherwise local machine configuration will be used.</p>
<div class="geshifilter">
<pre class="text geshifilter-text">MONGODB_DB_URL = os.environ.get('OPENSHIFT_MONGODB_DB_URL') if os.environ.get('OPENSHIFT_MONGODB_DB_URL') else 'mongodb://localhost:27017/'
MONGODB_DB_NAME = os.environ.get('OPENSHIFT_APP_NAME') if os.environ.get('OPENSHIFT_APP_NAME') else 'getbookmarks'
 
client = MongoClient(MONGODB_DB_URL)
db = client[MONGODB_DB_NAME]</pre>
</div>
<p>We created an instance of MongoClient passing it the connection url.  This connects it to the running mongod instance. Next we get the database using MongoClient instance.</p>
<h3>Create and List All Stories</h3>
<p>Now we will add functionality to create new stories and list all the stories. We will first add the route to Application instance as shown below.</p>
<div class="geshifilter">
<pre class="text geshifilter-text">application = web.Application([
    (r'/', IndexHandler),
    (r'/index', IndexHandler),
    (r'/api/v1/stories',StoriesHandler),
],**settings)</pre>
</div>
<p>Next we will define the StoriesHandler which will be responsible for persisting stories into MongoDB and finding all the stories.</p>
<div class="geshifilter">
<pre class="text geshifilter-text">class StoriesHandler(web.RequestHandler):
    def get(self):
        stories = db.stories.find()
        self.set_header("Content-Type", "application/json")
        self.write(json.dumps(list(stories),default=json_util.default))
 
 
    def post(self):
        story_data = json.loads(self.request.body)
        story_id = db.stories.insert(story_data)
        print('story created with id ' + str(story_id))
        self.set_header("Content-Type", "application/json")
        self.set_status(201)</pre>
</div>
<p>In the code shown above</p>
<ol>
<li>
<p>When a user makes a GET request to ‘/api/v1/stories’, then we make a find() call to MongoDB. As we are not specifying any query so it will fetch all the stories from MongoDB. We set the content type to “application/json” and dump the json response.</p>
</li>
<li>
<p>When a user makes POST request to ‘/api/v1/stories’, then we first decode the json body to a dictionary and then write the data to MongoDB. We set the response status to 201(Created).</p>
</li>
</ol>
<h3>View Individual Story</h3>
<p>The last backend functionality is to view the individual story. We first specify the route.</p>
<div class="geshifilter">
<pre class="text geshifilter-text">application = web.Application([
    (r'/', IndexHandler),
    (r'/index', IndexHandler),
    (r'/api/v1/stories',StoriesHandler),
    (r'/api/v1/stories/(.*)', StoryHandler)
],**settings)</pre>
</div>
<p>Then we will write the StoryHandler</p>
<div class="geshifilter">
<pre class="text geshifilter-text">class StoryHandler(web.RequestHandler):
    def get(self , story_id):
        story = db.stories.find_one({"_id":ObjectId(str(story_id))})
        self.set_header("Content-Type", "application/json")
        self.write(json.dumps((story),default=json_util.default))</pre>
</div>
<p>The code shown above finds the story corresponding the story_id and then dumps the json response.</p>
<h3>AngularJS Front End</h3>
<p>I decided to reuse the AngularJS front end which we wrote on <a href="/day-22-developing-single-page-applications-with-spring-mongodb-and-angularjs">day 22</a>. The day 22 showcased how we can use AngularJS with Java Spring framework backend. The best part of using JavaScript MV* frameworks is that you can reuse the frontend code if your application stick to the REST interface client needs. Please read the <a href="/day-22-developing-single-page-applications-with-spring-mongodb-and-angularjs">day 22 blog</a> for more information.</p>
<p>You can download the AngularJS front end from my <a href="https://github.com/shekhargulati/day25-tornado-demo-app">github repository</a>. Copy the static and templates folder and place it next to the getbookmarks.py.</p>
<h2>Deploying Application to OpenShift</h2>
<p>Before we deploy the application to OpenShift, we’ll have to do few setup tasks :</p>
<ol>
<li>
<p>Sign up for an <a href="https://www.openshift.com/app/account/new">OpenShift Account</a>. It is completely free, and Red Hat gives every user three free Gears on which to run your applications. At the time of this writing, the combined resources allocated for each user is 1.5 GB of memory and 3 GB of disk space.</p>
</li>
<li>
<p>Install the <a href="https://openshift.redhat.com/community/get-started#cli">rhc client tool</a> on the machine. The rhc is a ruby gem so you need to have ruby 1.8.7 or above on your machine. To install rhc, just type<code class="text geshifilter-text">sudo gem install rhc</code><br/>
If you already have one, make sure it is the latest one. To update the rhc, execute the command shown below.<code class="text geshifilter-text">sudo gem update rhc</code><br/>
For additional assistance setting up the rhc command-line tool, see the following page: <a href="https://openshift.redhat.com/community/developers/rhc-client-tools-install" title="https://openshift.redhat.com/community/developers/rhc-client-tools-install">https://openshift.redhat.com/community/developers/rhc-client-tools-install</a></p>
</li>
<li>
<p>Setup the OpenShift account using <code class="text geshifilter-text">rhc setup</code> command. This command will help us create a namespace and upload your ssh keys to OpenShift server.</p>
</li>
</ol>
<p>After setup, we can create a new OpenShift application by running the following command.</p>
<div class="geshifilter">
<pre class="text geshifilter-text">$ rhc create-app day25demo python-2.7 mongodb-2 --from-code https://github.com/shekhargulati/day25-tornado-demo-app.git</pre>
</div>
<p>It will do all the stuff from creating an application, to setting up public DNS, to creating private git repository, and then finally deploying the application using code from my Github repository. The app is running here <a href="http://day25demo-shekhargulati.rhcloud.com/#/" title="http://day25demo-shekhargulati.rhcloud.com/#/">http://day25demo-shekhargulati.rhcloud.com/#/</a></p>
<p>That’s it for today. Keep giving feedback.</p>
<h2>Next Steps</h2>

      <dl class="cat-tags clearfix row">
        <dt>Categories</dt>
        <dd>
          <a href="https://blog.openshift.com/category/technologies/mongodb/" rel="category tag">MongoDB</a>, <a href="https://blog.openshift.com/category/technologies/python/" rel="category tag">Python</a> 
        </dd>
        <dt>Tags</dt>
        <dd>
          <a href="https://blog.openshift.com/tag/angularjs/" rel="tag">AngularJS</a>, <a href="https://blog.openshift.com/tag/tornado/" rel="tag">tornado</a>        </dd>
      </dl>
    </div>
    </div></body></html>