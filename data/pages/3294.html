<html><body><div><section class="entry">
<p class="fsb-clear"/><p><a href="http://www.pyimagesearch.com/wp-content/uploads/2014/10/nms_fast_01.jpg"><img class="aligncenter wp-image-1448" src="http://www.pyimagesearch.com/wp-content/uploads/2014/10/nms_fast_01.jpg" alt="Fast Non-Maximum Suppression for Object Detection in Images"/></a></p>
<p>I have issues — <strong><em>I can’t stop thinking about object detection</em>.</strong></p>
<p>You see, last night I was watching <i>The Walking Dead</i> and instead of enjoying the zombie brutality, the forced cannibalism, or the enthralling storyline, <strong><em>all I wanted to do was build an object detection system to recognize zombies.</em></strong></p>
<p>Would it be very useful? Probably not.</p>
<p>I mean, it’s quite obvious if a zombie is coming after you. The stench alone should be a <strong><em>dead</em></strong> (hey, look at that pun) giveaway, let alone the gnashing of teeth and outstretched arms. And we might as well throw in guttural <em>“brainnnnsss”</em> moans as well.</p>
<p>Like I said, it would be pretty obvious if a zombie was after you — you certainly wouldn’t need a computer vision system to tell you that. But this is just an example of the type of stuff that runs through my head on a day-to-day basis.</p>
<p>To give you some context, two weeks ago I posted about using <a href="http://www.pyimagesearch.com/2014/11/10/histogram-oriented-gradients-object-detection/" target="_blank">Histogram of Oriented Gradients and a Linear Support Vector Machine</a> to build an object detection system. Sick of using the OpenCV Haar cascades and obtaining poor performance, and not to mention, extremely long training times, I took it upon myself to write my own Python object detection framework.</p>
<p>So far, it’s gone extremely well and it’s been a lot of fun to implement.</p>
<p>But there’s <em>an unescapable issue</em> you must handle when building an object detection system — <em>overlapping bounding boxes</em>. It’s going to happen, there’s no way around it. In fact, it’s actually a good sign that your object detector is firing properly so I wouldn’t even call it an “issue” exactly.</p>
<p>To handle the removal overlapping bounding boxes (that refer to the same object) we can either use non-maximum suppression on the <a href="http://en.wikipedia.org/wiki/Mean-shift" target="_blank">Mean-Shift algorithm</a>. While <a href="http://lear.inrialpes.fr/people/triggs/pubs/Dalal-cvpr05.pdf" target="_blank">Dalal and Triggs</a> prefer Mean-Shift, I find Mean-Shift to give sub-par results.</p>
<p>After receiving advice from my friend (and expert on object detection), <a href="http://people.csail.mit.edu/tomasz/" target="_blank">Dr. Tomasz Malisiewicz</a>, I decided to port his non-maximum suppression MATLAB implementations over to Python.</p>
<p><a href="http://www.pyimagesearch.com/2014/11/17/non-maximum-suppression-object-detection-python" target="_blank">Last week</a> I showed you how to implement the Felzenszwalb et al. method. And this week I am going to show you the <a href="http://quantombone.blogspot.com/2011/08/blazing-fast-nmsm-from-exemplar-svm.html" target="_blank">Malisiewicz et al. method</a> which is over <em>100x faster</em>.</p>
<p><em><strong>Note:</strong> I intended on publishing this blog post way back in November, but due to some poor planning on my part, it’s taken awhile for me to get this post out the door. Anyway, it’s online now!</em></p>
<p>So where does the speedup come from? And how do we obtain such faster suppression times?</p>
<p>Read on to find out.</p>

<p><strong>OpenCV and Python versions:</strong><br/>
This example will run on<strong> Python 2.7/Python 3.4+</strong> and <strong>OpenCV 2.4.X/OpenCV 3.0+</strong>.</p>
<h1>(Faster) Non-Maximum Suppression in Python</h1>
<p>Before we get started, if you haven’t read <a href="http://www.pyimagesearch.com/2014/11/17/non-maximum-suppression-object-detection-python" target="_blank">last week’s post on non-maximum suppression</a>, I would definitely start there.</p>
<p>Otherwise, open up a new file in your favorite editor, name it 
			<span id="crayon-56d5a5d662867496104029" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">nms</span><span class="crayon-sy">.</span><span class="crayon-v">py</span></span></span> , and let’s get started on creating a faster non-maximum suppression implementation:</p>

		<div id="crayon-56d5a5d662873194335204" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-56d5a5d662873194335204-1">1</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a5d662873194335204-2">2</p><p class="crayon-num" data-line="crayon-56d5a5d662873194335204-3">3</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a5d662873194335204-4">4</p><p class="crayon-num" data-line="crayon-56d5a5d662873194335204-5">5</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a5d662873194335204-6">6</p><p class="crayon-num" data-line="crayon-56d5a5d662873194335204-7">7</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a5d662873194335204-8">8</p><p class="crayon-num" data-line="crayon-56d5a5d662873194335204-9">9</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a5d662873194335204-10">10</p><p class="crayon-num" data-line="crayon-56d5a5d662873194335204-11">11</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a5d662873194335204-12">12</p><p class="crayon-num" data-line="crayon-56d5a5d662873194335204-13">13</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a5d662873194335204-14">14</p><p class="crayon-num" data-line="crayon-56d5a5d662873194335204-15">15</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a5d662873194335204-16">16</p><p class="crayon-num" data-line="crayon-56d5a5d662873194335204-17">17</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a5d662873194335204-18">18</p><p class="crayon-num" data-line="crayon-56d5a5d662873194335204-19">19</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a5d662873194335204-20">20</p><p class="crayon-num" data-line="crayon-56d5a5d662873194335204-21">21</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a5d662873194335204-22">22</p><p class="crayon-num" data-line="crayon-56d5a5d662873194335204-23">23</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a5d662873194335204-24">24</p><p class="crayon-num" data-line="crayon-56d5a5d662873194335204-25">25</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a5d662873194335204-26">26</p><p class="crayon-num" data-line="crayon-56d5a5d662873194335204-27">27</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a5d662873194335204-28">28</p><p class="crayon-num" data-line="crayon-56d5a5d662873194335204-29">29</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a5d662873194335204-30">30</p><p class="crayon-num" data-line="crayon-56d5a5d662873194335204-31">31</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a5d662873194335204-32">32</p><p class="crayon-num" data-line="crayon-56d5a5d662873194335204-33">33</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a5d662873194335204-34">34</p><p class="crayon-num" data-line="crayon-56d5a5d662873194335204-35">35</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a5d662873194335204-36">36</p><p class="crayon-num" data-line="crayon-56d5a5d662873194335204-37">37</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a5d662873194335204-38">38</p><p class="crayon-num" data-line="crayon-56d5a5d662873194335204-39">39</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a5d662873194335204-40">40</p><p class="crayon-num" data-line="crayon-56d5a5d662873194335204-41">41</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a5d662873194335204-42">42</p><p class="crayon-num" data-line="crayon-56d5a5d662873194335204-43">43</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a5d662873194335204-44">44</p><p class="crayon-num" data-line="crayon-56d5a5d662873194335204-45">45</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a5d662873194335204-46">46</p><p class="crayon-num" data-line="crayon-56d5a5d662873194335204-47">47</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a5d662873194335204-48">48</p><p class="crayon-num" data-line="crayon-56d5a5d662873194335204-49">49</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a5d662873194335204-50">50</p><p class="crayon-num" data-line="crayon-56d5a5d662873194335204-51">51</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a5d662873194335204-52">52</p><p class="crayon-num" data-line="crayon-56d5a5d662873194335204-53">53</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a5d662873194335204-54">54</p><p class="crayon-num" data-line="crayon-56d5a5d662873194335204-55">55</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a5d662873194335204-56">56</p><p class="crayon-num" data-line="crayon-56d5a5d662873194335204-57">57</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a5d662873194335204-58">58</p><p class="crayon-num" data-line="crayon-56d5a5d662873194335204-59">59</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5a5d662873194335204-1"><span class="crayon-c"># import the necessary packages</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a5d662873194335204-2"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">numpy </span><span class="crayon-st">as</span><span class="crayon-h"> </span><span class="crayon-v">np</span></p><p class="crayon-line" id="crayon-56d5a5d662873194335204-3"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5a5d662873194335204-4"><span class="crayon-c"># Malisiewicz et al.</span></p><p class="crayon-line" id="crayon-56d5a5d662873194335204-5"><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">non_max_suppression_fast</span><span class="crayon-sy">(</span><span class="crayon-v">boxes</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">overlapThresh</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a5d662873194335204-6"><span class="crayon-h">	</span><span class="crayon-c"># if there are no boxes, return an empty list</span></p><p class="crayon-line" id="crayon-56d5a5d662873194335204-7"><span class="crayon-h">	</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-k ">len</span><span class="crayon-sy">(</span><span class="crayon-v">boxes</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a5d662873194335204-8"><span class="crayon-h">		</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">]</span></p><p class="crayon-line" id="crayon-56d5a5d662873194335204-9"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5a5d662873194335204-10"><span class="crayon-h">	</span><span class="crayon-c"># if the bounding boxes integers, convert them to floats --</span></p><p class="crayon-line" id="crayon-56d5a5d662873194335204-11"><span class="crayon-h">	</span><span class="crayon-c"># this is important since we'll be doing a bunch of divisions</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a5d662873194335204-12"><span class="crayon-h">	</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">boxes</span><span class="crayon-sy">.</span><span class="crayon-v">dtype</span><span class="crayon-sy">.</span><span class="crayon-v">kind</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">"i"</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5a5d662873194335204-13"><span class="crayon-h">		</span><span class="crayon-v">boxes</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">boxes</span><span class="crayon-sy">.</span><span class="crayon-e">astype</span><span class="crayon-sy">(</span><span class="crayon-s">"float"</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a5d662873194335204-14"> </p><p class="crayon-line" id="crayon-56d5a5d662873194335204-15"><span class="crayon-h">	</span><span class="crayon-c"># initialize the list of picked indexes	</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a5d662873194335204-16"><span class="crayon-h">	</span><span class="crayon-v">pick</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">]</span></p><p class="crayon-line" id="crayon-56d5a5d662873194335204-17"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5a5d662873194335204-18"><span class="crayon-h">	</span><span class="crayon-c"># grab the coordinates of the bounding boxes</span></p><p class="crayon-line" id="crayon-56d5a5d662873194335204-19"><span class="crayon-h">	</span><span class="crayon-v">x1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">boxes</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a5d662873194335204-20"><span class="crayon-h">	</span><span class="crayon-v">y1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">boxes</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></p><p class="crayon-line" id="crayon-56d5a5d662873194335204-21"><span class="crayon-h">	</span><span class="crayon-v">x2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">boxes</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a5d662873194335204-22"><span class="crayon-h">	</span><span class="crayon-v">y2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">boxes</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-cn">3</span><span class="crayon-sy">]</span></p><p class="crayon-line" id="crayon-56d5a5d662873194335204-23"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5a5d662873194335204-24"><span class="crayon-h">	</span><span class="crayon-c"># compute the area of the bounding boxes and sort the bounding</span></p><p class="crayon-line" id="crayon-56d5a5d662873194335204-25"><span class="crayon-h">	</span><span class="crayon-c"># boxes by the bottom-right y-coordinate of the bounding box</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a5d662873194335204-26"><span class="crayon-h">	</span><span class="crayon-v">area</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">x2</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">x1</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">y2</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">y1</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a5d662873194335204-27"><span class="crayon-h">	</span><span class="crayon-v">idxs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">np</span><span class="crayon-sy">.</span><span class="crayon-e">argsort</span><span class="crayon-sy">(</span><span class="crayon-v">y2</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a5d662873194335204-28"> </p><p class="crayon-line" id="crayon-56d5a5d662873194335204-29"><span class="crayon-h">	</span><span class="crayon-c"># keep looping while some indexes still remain in the indexes</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a5d662873194335204-30"><span class="crayon-h">	</span><span class="crayon-c"># list</span></p><p class="crayon-line" id="crayon-56d5a5d662873194335204-31"><span class="crayon-h">	</span><span class="crayon-st">while</span><span class="crayon-h"> </span><span class="crayon-k ">len</span><span class="crayon-sy">(</span><span class="crayon-v">idxs</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a5d662873194335204-32"><span class="crayon-h">		</span><span class="crayon-c"># grab the last index in the indexes list and add the</span></p><p class="crayon-line" id="crayon-56d5a5d662873194335204-33"><span class="crayon-h">		</span><span class="crayon-c"># index value to the list of picked indexes</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a5d662873194335204-34"><span class="crayon-h">		</span><span class="crayon-v">last</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">len</span><span class="crayon-sy">(</span><span class="crayon-v">idxs</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></p><p class="crayon-line" id="crayon-56d5a5d662873194335204-35"><span class="crayon-h">		</span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">idxs</span><span class="crayon-sy">[</span><span class="crayon-v">last</span><span class="crayon-sy">]</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a5d662873194335204-36"><span class="crayon-h">		</span><span class="crayon-v">pick</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">i</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a5d662873194335204-37"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5a5d662873194335204-38"><span class="crayon-h">		</span><span class="crayon-c"># find the largest (x, y) coordinates for the start of</span></p><p class="crayon-line" id="crayon-56d5a5d662873194335204-39"><span class="crayon-h">		</span><span class="crayon-c"># the bounding box and the smallest (x, y) coordinates</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a5d662873194335204-40"><span class="crayon-h">		</span><span class="crayon-c"># for the end of the bounding box</span></p><p class="crayon-line" id="crayon-56d5a5d662873194335204-41"><span class="crayon-h">		</span><span class="crayon-v">xx1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">np</span><span class="crayon-sy">.</span><span class="crayon-e">maximum</span><span class="crayon-sy">(</span><span class="crayon-v">x1</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">x1</span><span class="crayon-sy">[</span><span class="crayon-v">idxs</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-v">last</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a5d662873194335204-42"><span class="crayon-h">		</span><span class="crayon-v">yy1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">np</span><span class="crayon-sy">.</span><span class="crayon-e">maximum</span><span class="crayon-sy">(</span><span class="crayon-v">y1</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y1</span><span class="crayon-sy">[</span><span class="crayon-v">idxs</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-v">last</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a5d662873194335204-43"><span class="crayon-h">		</span><span class="crayon-v">xx2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">np</span><span class="crayon-sy">.</span><span class="crayon-e">minimum</span><span class="crayon-sy">(</span><span class="crayon-v">x2</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">x2</span><span class="crayon-sy">[</span><span class="crayon-v">idxs</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-v">last</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a5d662873194335204-44"><span class="crayon-h">		</span><span class="crayon-v">yy2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">np</span><span class="crayon-sy">.</span><span class="crayon-e">minimum</span><span class="crayon-sy">(</span><span class="crayon-v">y2</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y2</span><span class="crayon-sy">[</span><span class="crayon-v">idxs</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-v">last</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a5d662873194335204-45"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5a5d662873194335204-46"><span class="crayon-h">		</span><span class="crayon-c"># compute the width and height of the bounding box</span></p><p class="crayon-line" id="crayon-56d5a5d662873194335204-47"><span class="crayon-h">		</span><span class="crayon-k ">w</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">np</span><span class="crayon-sy">.</span><span class="crayon-e">maximum</span><span class="crayon-sy">(</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">xx2</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">xx1</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a5d662873194335204-48"><span class="crayon-h">		</span><span class="crayon-v">h</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">np</span><span class="crayon-sy">.</span><span class="crayon-e">maximum</span><span class="crayon-sy">(</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">yy2</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">yy1</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a5d662873194335204-49"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5a5d662873194335204-50"><span class="crayon-h">		</span><span class="crayon-c"># compute the ratio of overlap</span></p><p class="crayon-line" id="crayon-56d5a5d662873194335204-51"><span class="crayon-h">		</span><span class="crayon-v">overlap</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-k ">w</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">h</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-v">area</span><span class="crayon-sy">[</span><span class="crayon-v">idxs</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-v">last</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a5d662873194335204-52"> </p><p class="crayon-line" id="crayon-56d5a5d662873194335204-53"><span class="crayon-h">		</span><span class="crayon-c"># delete all indexes from the index list that have</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a5d662873194335204-54"><span class="crayon-h">		</span><span class="crayon-v">idxs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">np</span><span class="crayon-sy">.</span><span class="crayon-e">delete</span><span class="crayon-sy">(</span><span class="crayon-v">idxs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">np</span><span class="crayon-sy">.</span><span class="crayon-e">concatenate</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">last</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d5a5d662873194335204-55"><span class="crayon-h">			</span><span class="crayon-v">np</span><span class="crayon-sy">.</span><span class="crayon-e">where</span><span class="crayon-sy">(</span><span class="crayon-v">overlap</span><span class="crayon-h"> </span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">overlapThresh</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a5d662873194335204-56"> </p><p class="crayon-line" id="crayon-56d5a5d662873194335204-57"><span class="crayon-h">	</span><span class="crayon-c"># return only the bounding boxes that were picked using the</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a5d662873194335204-58"><span class="crayon-h">	</span><span class="crayon-c"># integer data type</span></p><p class="crayon-line" id="crayon-56d5a5d662873194335204-59"><span class="crayon-h">	</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">boxes</span><span class="crayon-sy">[</span><span class="crayon-v">pick</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">astype</span><span class="crayon-sy">(</span><span class="crayon-s">"int"</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>Take a second to really examine this code and compare it to the <a href="http://www.pyimagesearch.com/2014/11/17/non-maximum-suppression-object-detection-python" target="_blank">Felzenszwalb et al. implementation of last week</a>.</p>
<p>The code looks <strong><em>almost identical</em></strong>, right?</p>
<p>So you’re probably asking yourself <em>“Where does this 100x speed-up come from?”</em></p>
<p><em><strong>And the answer is the removal of an inner 
			<span id="crayon-56d5a5d66287a651502760" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-st">for</span></span></span>  loop.</strong></em></p>
<p>The implementation from last week required an extra inner 
			<span id="crayon-56d5a5d66287f355382706" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-st">for</span></span></span>  loop to compute the size of bounding regions and compute the ratio of overlapped area.</p>
<p>Instead, Dr. Malisiewicz replaced this inner 
			<span id="crayon-56d5a5d662882399862526" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-st">for</span></span></span>  loop with vectorized code — <em>and this is how we are able to achieve substantially faster speeds when applying non-maximum suppression.</em></p>
<p>Instead of repeating myself and going line-by-line through the code like I did last week, let’s just examine the important parts.</p>
<p><strong>Lines 6-22</strong> of our faster non-maximum suppression function are essentially the same as they are from last week. We start by grabbing the <em>(x, y)</em> coordinates of the bounding boxes, computing their area, and sorting the indexes into the 
			<span id="crayon-56d5a5d662886589931921" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">boxes</span></span></span>  list according to their bottom-right y-coordinate of each box.</p>
<p><strong>Lines 31-55 </strong>contain our speed-up, where <strong>Lines 41-55</strong> are especially important.</p>
<p>Instead of using an inner 
			<span id="crayon-56d5a5d66288a315541900" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-st">for</span></span></span>  loop to loop over each of the individual boxes, we instead vectorize the code using the 
			<span id="crayon-56d5a5d66288e383859600" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">np</span><span class="crayon-sy">.</span><span class="crayon-v">maximum</span></span></span>  and 
			<span id="crayon-56d5a5d662891557708583" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">np</span><span class="crayon-sy">.</span><span class="crayon-v">minimum</span></span></span>  functions — this allows us to find the maximum and minimum values across the <em>axis</em> rather than just <em>individual scalars</em>.</p>
<p><strong>Note:</strong> You <strong><em>have</em></strong><em> </em>to use the 
			<span id="crayon-56d5a5d662895187657917" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">np</span><span class="crayon-sy">.</span><span class="crayon-v">maximum</span></span></span>  and 
			<span id="crayon-56d5a5d662899184581705" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">np</span><span class="crayon-sy">.</span><span class="crayon-v">minimum</span></span></span>  functions here — they allow you to mix scalars and vectors. The 
			<span id="crayon-56d5a5d66289c442842064" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">np</span><span class="crayon-sy">.</span><span class="crayon-v">max</span></span></span>  and 
			<span id="crayon-56d5a5d66289f974371493" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">np</span><span class="crayon-sy">.</span><span class="crayon-v">min</span></span></span>  functions do not, and if you use them, you will find yourself with some pretty fierce bugs to find and fix. It took me quite awhile to debug this problem when I was porting the algorithm from MATLAB to Python.</p>
<p><strong>Lines 47 and 48</strong> are also vectorized — here we compute the width and height of each of the rectangles to check. Similarly, computing the 
			<span id="crayon-56d5a5d6628a3841926660" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">overlap</span></span></span>  ratio on <strong>Line 51 </strong>is also vectorized. From there, we just delete all entries from our 
			<span id="crayon-56d5a5d6628a7460487443" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">idx</span></span></span>  list that are greater than our supplied overlap threshold. Typical values for the overlap threshold normally fall in the range 0.3-0.5.</p>
<p>The Malisiewicz et al. method is essentially identical to the Felzenszwalb et al. method, but by using vectorized code we are able to reach a <a href="http://quantombone.blogspot.com/2011/08/blazing-fast-nmsm-from-exemplar-svm.html" target="_blank">reported 100x speed-up</a> in non-maximum suppression!</p>
<h1>Faster Non-Maximum Suppression in Action</h1>
<p>Let’s go ahead and explore a few examples. We’ll start with the creepy little girl zombie that we saw at the top of this image:</p>
<div id="attachment_1448" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2014/10/nms_fast_01.jpg"><img class="wp-image-1448" src="http://www.pyimagesearch.com/wp-content/uploads/2014/10/nms_fast_01.jpg" alt="Figure 1: Detecting three bounding boxes in the image, but non-maximum suppression suppresses two of the overlapping boxes."/></a><p class="wp-caption-text"><strong>Figure 1:</strong> Detecting <strong>three</strong> bounding boxes in the image, but non-maximum suppression suppresses two of the overlapping boxes.</p></div>
<p>It’s actually really funny how well our face detector trained on real, healthy human faces generalizes to zombie faces as well. Granted, they are still “human” faces, but with all the blood and disfigurement, I wouldn’t be surprised to see some strange results.</p>
<div id="attachment_1449" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2014/10/nms_fast_02.jpg"><img class="wp-image-1449" src="http://www.pyimagesearch.com/wp-content/uploads/2014/10/nms_fast_02.jpg" alt="Figure 2: It looks like our face detector didn't generalize as well. Clearly the teeth of this zombie looks like a face to the detector." srcset="http://www.pyimagesearch.com/wp-content/uploads/2014/10/nms_fast_02-300x159.jpg 300w, http://www.pyimagesearch.com/wp-content/uploads/2014/10/nms_fast_02.jpg 1000w" sizes="(max-width: 600px) 100vw, 600px"/></a><p class="wp-caption-text"><strong>Figure 2:</strong> It looks like our face detector didn’t generalize as well — the teeth of this zombie looks like a face to the detector.</p></div>
<p>Speaking of strange results, it looks like our face detector detected the mouth/teeth region of the zombie on the right. Perhaps if I had explicitly trained the HOG + Linear SVM face detector on zombie images the results would be better.</p>
<div id="attachment_1450" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2014/10/nms_fast_03.jpg"><img class="wp-image-1450" src="http://www.pyimagesearch.com/wp-content/uploads/2014/10/nms_fast_03.jpg" alt="Figure 3: Six bounding boxes are detected around the face, but by applying fast non-maximum suppression we are correctly able to reduce the number of bounding boxes to one." srcset="http://www.pyimagesearch.com/wp-content/uploads/2014/10/nms_fast_03-300x162.jpg 300w, http://www.pyimagesearch.com/wp-content/uploads/2014/10/nms_fast_03.jpg 1000w" sizes="(max-width: 600px) 100vw, 600px"/></a><p class="wp-caption-text"><strong>Figure 3:</strong> <strong>Six</strong> bounding boxes are detected around the face, but by applying fast non-maximum suppression we are correctly able to reduce the number of bounding boxes to <strong>one</strong>.</p></div>
<p>In this last example we can again see that our non-maximum suppression algorithm is working correctly — even though <b>six</b> original bounding boxes were detected by the HOG + Linear SVM detector, applying non-maximum suppression has correctly suppressed five of the boxes, leaving us with the final detection.</p>
<h1>Summary</h1>
<p>In this blog post we reviewed the Malisiewicz et al. method for non-maximum suppression.</p>
<p>This method is nearly identical to the Felzenszwalb et al. method, but by removing an inner 
			<span id="crayon-56d5a5d6628ae325310583" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-st">for</span></span></span>  loop and using vectorized code we are able to obtain substantial speed-ups.</p>
<p>And if you have a second, <a href="https://twitter.com/quantombone" target="_blank">be sure to thank Dr. Tomasz Malisiewicz</a>!</p>
<h1 id="post_downloads">Downloads:</h1>

	</section>
	</div></body></html>