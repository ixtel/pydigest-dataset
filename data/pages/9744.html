<html><body><div><section class="entry">
<p class="fsb-clear"/><p><a href="http://www.pyimagesearch.com/wp-content/uploads/2016/01/realtime_panorama_stitching_animation.gif"><img class="aligncenter size-full wp-image-3594" src="http://www.pyimagesearch.com/wp-content/uploads/2016/01/realtime_panorama_stitching_animation.gif" alt="realtime_panorama_stitching_animation"/></a></p>
<p>One of my favorite parts of running the PyImageSearch blog is a being able to <em>link together previous blog posts</em> and <em>create a solution to a particular problem</em> — <em><strong>in this case, real-time panorama and image stitching with Python and OpenCV.</strong></em></p>
<p>Over the past month and a half, we’ve learned how to <a href="http://www.pyimagesearch.com/2015/12/21/increasing-webcam-fps-with-python-and-opencv/" target="_blank">increase the FPS processing rate of builtin/USB webcams</a> and the <a href="http://www.pyimagesearch.com/2015/12/28/increasing-raspberry-pi-fps-with-python-and-opencv/" target="_blank">Raspberry Pi camera module</a>. We also learned how to <a href="http://www.pyimagesearch.com/2016/01/04/unifying-picamera-and-cv2-videocapture-into-a-single-class-with-opencv/" target="_blank">unify access to <em><strong>both</strong></em> USB webcams and the Raspberry Pi camera into a <em>single class</em></a>, making all video processing and examples on the PyImageSearch blog capable of running on both USB and Pi camera setups without having to modify a single line of code.</p>
<p>And just to weeks ago, we discussed how keypoint detection, local invariant descriptors, keypoint matching, and homography matrix estimation can be used to <a href="http://www.pyimagesearch.com/2016/01/11/opencv-panorama-stitching/" target="_blank">construct panoramas and stitch images together</a>.</p>
<p>Today we are going to link together the past 1.5 months worth of posts and use them to perform <strong><a href="http://www.pyimagesearch.com/2016/01/11/opencv-panorama-stitching/" target="_blank">real-time panorama and image stitching</a></strong> using Python and OpenCV. Our solution will be able to run on both laptop/desktops systems, along with the Raspberry Pi.</p>
<p><strong>Furthermore, we’ll also apply our <em>basic motion detection</em> implementation from <a href="http://www.pyimagesearch.com/2016/01/18/multiple-cameras-with-the-raspberry-pi-and-opencv/" target="_blank">last week’s post</a> to perform motion detection on the panorama image.</strong></p>
<p>This solution is especially useful in situations where you want to survey a wide area for motion, but don’t want “blind spots” in your camera view.</p>

<p>Keep reading to learn more…</p>
<h2>Real-time panorama and image stitching with OpenCV</h2>
<p>As I mentioned in the introduction to this post, we’ll be linking together concepts we have learned in the previous 1.5 months of PyImageSearch posts and:</p>
<ol>
<li>Use our improved FPS processing rate Python classes to access our builtin/USB webcams and/or the Raspberry Pi camera module.</li>
<li>Access <em>multiple</em> camera streams at once.</li>
<li>Apply image stitching and panorama construction to the frames from these video streams.</li>
<li>Perform motion detection in the panorama image.</li>
</ol>
<p>Again, the benefit of performing motion detection in the <em>panorama image</em> versus <em>two separate frames</em> is that we won’t have any “blind spots” in our field of view.</p>
<h3>Hardware setup</h3>
<p>For this project, I’ll be using my Raspberry Pi 2, although you could certainly use your laptop or desktop system instead. I simply went with the Pi 2 for it’s small form factor and ease of maneuvering in space constrained places.</p>
<p>I’ll also be using my <a href="http://www.amazon.com/gp/product/B006JH8T3S/ref=as_li_tl?ie=UTF8&amp;camp=1789&amp;creative=390957&amp;creativeASIN=B006JH8T3S&amp;linkCode=as2&amp;tag=trndingcom-20&amp;linkId=BWJJLCCXZCBM465P" target="_blank">Logitech C920 webcam</a> (that is plug-and-play compatible with the Raspberry Pi) along with the <a href="http://www.amazon.com/gp/product/B00E1GGE40/ref=as_li_tl?ie=UTF8&amp;camp=1789&amp;creative=390957&amp;creativeASIN=B00E1GGE40&amp;linkCode=as2&amp;tag=trndingcom-20&amp;linkId=XF5KMO3TGBUENU5T" target="_blank">Raspberry Pi camera module</a>. Again, if you decide to use your laptop/desktop system, you can simply hook-up multiple webcams to your machine — the same concepts discussed in this post still apply.</p>
<p>Below you can see my setup:</p>
<div id="attachment_3591" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2016/01/realtime_panorama_setup_02.jpg"><img class="wp-image-3591" src="http://www.pyimagesearch.com/wp-content/uploads/2016/01/realtime_panorama_setup_02.jpg" alt="Figure 1: My the Raspberry Pi 2 + USB webcam + Pi camera module setup." srcset="http://www.pyimagesearch.com/wp-content/uploads/2016/01/realtime_panorama_setup_02-300x225.jpg 300w, http://www.pyimagesearch.com/wp-content/uploads/2016/01/realtime_panorama_setup_02-1024x768.jpg 1024w, http://www.pyimagesearch.com/wp-content/uploads/2016/01/realtime_panorama_setup_02.jpg 1400w" sizes="(max-width: 600px) 100vw, 600px"/></a><p class="wp-caption-text"><strong>Figure 1:</strong> My the Raspberry Pi 2 + USB webcam + Pi camera module setup.</p></div>
<p>Here is another angle looking up at the setup:</p>
<div id="attachment_3593" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2016/01/realtime_panorama_setup_03.jpg"><img class="wp-image-3593" src="http://www.pyimagesearch.com/wp-content/uploads/2016/01/realtime_panorama_setup_03.jpg" alt="Figure 2: Placing my setup on top of a bookcase so it has a good viewing angle of my apartment." srcset="http://www.pyimagesearch.com/wp-content/uploads/2016/01/realtime_panorama_setup_03-300x225.jpg 300w, http://www.pyimagesearch.com/wp-content/uploads/2016/01/realtime_panorama_setup_03-1024x768.jpg 1024w, http://www.pyimagesearch.com/wp-content/uploads/2016/01/realtime_panorama_setup_03.jpg 1400w" sizes="(max-width: 600px) 100vw, 600px"/></a><p class="wp-caption-text"><strong>Figure 2:</strong> Placing my setup on top of a bookcase so it has a good viewing angle of my apartment.</p></div>
<p>The setup is pointing towards my front door, kitchen, and hallway, giving me a full view of what’s going on inside my apartment:</p>
<div id="attachment_3592" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2016/01/realtime_panorama_setup_01.jpg"><img class="wp-image-3592" src="http://www.pyimagesearch.com/wp-content/uploads/2016/01/realtime_panorama_setup_01.jpg" alt="Figure 3: Getting ready for real-time panorama construction." srcset="http://www.pyimagesearch.com/wp-content/uploads/2016/01/realtime_panorama_setup_01-300x225.jpg 300w, http://www.pyimagesearch.com/wp-content/uploads/2016/01/realtime_panorama_setup_01-1024x768.jpg 1024w, http://www.pyimagesearch.com/wp-content/uploads/2016/01/realtime_panorama_setup_01.jpg 1400w" sizes="(max-width: 600px) 100vw, 600px"/></a><p class="wp-caption-text"><strong>Figure 3:</strong> Getting ready for real-time panorama construction.</p></div>
<p>The goal is to take frames captured from both my video streams, stitch them together, and then perform motion detection in the panorama image.</p>
<p>Constructing a panorama, rather than <a href="http://www.pyimagesearch.com/2016/01/18/multiple-cameras-with-the-raspberry-pi-and-opencv/" target="_blank">using multiple cameras and performing motion detection independently in each stream</a> ensures that I don’t have any “blind spots” in my field of view.</p>
<h3>Project structure</h3>
<p>Before we get started, let’s look at our project structure:</p>

		<div id="crayon-56d5a066ad05b768594076" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5a066ad05b768594076-1"><span class="crayon-o">|</span><span class="crayon-o">--</span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">pyimagesearch</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad05b768594076-2"><span class="crayon-o">|</span><span class="crayon-h">    </span><span class="crayon-o">|</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-h"> </span><span class="crayon-v">__init__</span><span class="crayon-e">.py</span></p><p class="crayon-line" id="crayon-56d5a066ad05b768594076-3"><span class="crayon-o">|</span><span class="crayon-h">    </span><span class="crayon-o">|</span><span class="crayon-o">--</span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">basicmotiondetector</span><span class="crayon-e">.py</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad05b768594076-4"><span class="crayon-o">|</span><span class="crayon-h">    </span><span class="crayon-o">|</span><span class="crayon-o">--</span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">panorama</span><span class="crayon-e">.py</span></p><p class="crayon-line" id="crayon-56d5a066ad05b768594076-5"><span class="crayon-o">|</span><span class="crayon-o">--</span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">realtime_stitching</span><span class="crayon-e">.py</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>As you can see, we have defined a 
			<span id="crayon-56d5a066ad067112667431" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">pyimagesearch</span></span></span>  module for organizational purposes. We then have the 
			<span id="crayon-56d5a066ad06b251262125" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">basicmotiondetector</span><span class="crayon-sy">.</span><span class="crayon-v">py</span></span></span>  implementation from last week’s post on <a href="http://www.pyimagesearch.com/2016/01/18/multiple-cameras-with-the-raspberry-pi-and-opencv/" target="_blank">accessing multiple cameras with Python and OpenCV</a>. This class hasn’t changed at all, so we <em>won’t</em> be reviewing the implementation in this post. For a thorough review of the basic motion detector, be sure to read <a href="http://www.pyimagesearch.com/2016/01/18/multiple-cameras-with-the-raspberry-pi-and-opencv/" target="_blank">last week’s post</a>.</p>
<p>We then have our 
			<span id="crayon-56d5a066ad06f357883165" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">panorama</span><span class="crayon-sy">.</span><span class="crayon-v">py</span></span></span>  file which defines the 
			<span id="crayon-56d5a066ad073040054325" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">Stitcher</span></span></span>  class used to stitch images together. We initially used this class in the <a href="http://www.pyimagesearch.com/2016/01/11/opencv-panorama-stitching/" target="_blank">OpenCV panorama stitching tutorial</a>.</p>
<p>However, as we’ll see later in this post, I have made a <em>slight</em> modifications to the constructor and 
			<span id="crayon-56d5a066ad077871131072" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">stitch</span></span></span>  methods to facilitate real-time panorama construction — we’ll learn more about these slight modifications later in this post.</p>
<p>Finally, the 
			<span id="crayon-56d5a066ad07a380465543" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">realtime_stitching</span><span class="crayon-sy">.</span><span class="crayon-v">py</span></span></span>  file is our main Python driver script that will access the multiple video streams (in an efficient, threaded manner of course), stitch the frames together, and then perform motion detection on the panorama image.</p>
<h3>Updating the image stitcher</h3>
<p>In order to (1) create a real-time image stitcher and (2) perform motion detection on the panorama image, we’ll assume that both cameras are <em>fixed</em> and <em>non-moving</em>, like in <strong>Figure 1</strong> above.</p>
<p>Why is the fixed and non-moving assumption so important?</p>
<p>Well, remember back to our lesson on <a href="http://www.pyimagesearch.com/2016/01/11/opencv-panorama-stitching/" target="_blank">panorama and image stitching</a>.</p>
<p>Performing keypoint detection, local invariant description, keypoint matching, and homography estimation is a <em>computationally expensive</em> task. If we were to use our previous implementation, we would have to perform stitching on <em>each</em> set of frames, making it near impossible to run in real-time (especially for resource constrained hardware such as the Raspberry Pi).</p>
<p>However, if we assume that the cameras are fixed, <em><strong>we only have to perform the homography matrix estimation once!</strong></em></p>
<p>After the initial homography estimation, we can use the same matrix to transform and warp the images to construct the final panorama — doing this enables us to skip the computationally expensive steps of keypoint detection, local invariant feature extraction, and keypoint matching in each set of frames.</p>
<p>Below I have provided the relevant updates to the 
			<span id="crayon-56d5a066ad07e252455329" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">Sticher</span></span></span>  class to facilitate a cached homography matrix:</p>

		<div id="crayon-56d5a066ad082716513947" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5a066ad082716513947-1"><span class="crayon-c"># import the necessary packages</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad082716513947-2"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">numpy </span><span class="crayon-st">as</span><span class="crayon-h"> </span><span class="crayon-e">np</span></p><p class="crayon-line" id="crayon-56d5a066ad082716513947-3"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">imutils</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad082716513947-4"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">cv2</span></p><p class="crayon-line" id="crayon-56d5a066ad082716513947-5"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad082716513947-6"><span class="crayon-t">class</span><span class="crayon-h"> </span><span class="crayon-v">Stitcher</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5a066ad082716513947-7"><span class="crayon-h">	</span><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">__init__</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad082716513947-8"><span class="crayon-h">		</span><span class="crayon-c"># determine if we are using OpenCV v3.X and initialize the</span></p><p class="crayon-line" id="crayon-56d5a066ad082716513947-9"><span class="crayon-h">		</span><span class="crayon-c"># cached homography matrix</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad082716513947-10"><span class="crayon-h">		</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">isv3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">imutils</span><span class="crayon-sy">.</span><span class="crayon-e">is_cv3</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a066ad082716513947-11"><span class="crayon-h">		</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">cachedH</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">None</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>The only addition here is on <strong>Line 11</strong> were I define 
			<span id="crayon-56d5a066ad085525045245" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">cachedH</span></span></span> , the cached homography matrix.</p>
<p>We also need to update the 
			<span id="crayon-56d5a066ad089912355618" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">stitch</span></span></span>  method to cache the homography matrix after it is computed:</p>

		<div id="crayon-56d5a066ad08c041903259" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-56d5a066ad08c041903259-13">13</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad08c041903259-14">14</p><p class="crayon-num" data-line="crayon-56d5a066ad08c041903259-15">15</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad08c041903259-16">16</p><p class="crayon-num" data-line="crayon-56d5a066ad08c041903259-17">17</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad08c041903259-18">18</p><p class="crayon-num" data-line="crayon-56d5a066ad08c041903259-19">19</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad08c041903259-20">20</p><p class="crayon-num" data-line="crayon-56d5a066ad08c041903259-21">21</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad08c041903259-22">22</p><p class="crayon-num" data-line="crayon-56d5a066ad08c041903259-23">23</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad08c041903259-24">24</p><p class="crayon-num" data-line="crayon-56d5a066ad08c041903259-25">25</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad08c041903259-26">26</p><p class="crayon-num" data-line="crayon-56d5a066ad08c041903259-27">27</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad08c041903259-28">28</p><p class="crayon-num" data-line="crayon-56d5a066ad08c041903259-29">29</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad08c041903259-30">30</p><p class="crayon-num" data-line="crayon-56d5a066ad08c041903259-31">31</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad08c041903259-32">32</p><p class="crayon-num" data-line="crayon-56d5a066ad08c041903259-33">33</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad08c041903259-34">34</p><p class="crayon-num" data-line="crayon-56d5a066ad08c041903259-35">35</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad08c041903259-36">36</p><p class="crayon-num" data-line="crayon-56d5a066ad08c041903259-37">37</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad08c041903259-38">38</p><p class="crayon-num" data-line="crayon-56d5a066ad08c041903259-39">39</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad08c041903259-40">40</p><p class="crayon-num" data-line="crayon-56d5a066ad08c041903259-41">41</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad08c041903259-42">42</p><p class="crayon-num" data-line="crayon-56d5a066ad08c041903259-43">43</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5a066ad08c041903259-13"><span class="crayon-h">	</span><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">stitch</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">images</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ratio</span><span class="crayon-o">=</span><span class="crayon-cn">0.75</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">reprojThresh</span><span class="crayon-o">=</span><span class="crayon-cn">4.0</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad08c041903259-14"><span class="crayon-h">		</span><span class="crayon-c"># unpack the images</span></p><p class="crayon-line" id="crayon-56d5a066ad08c041903259-15"><span class="crayon-h">		</span><span class="crayon-sy">(</span><span class="crayon-v">imageB</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">imageA</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">images</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad08c041903259-16"> </p><p class="crayon-line" id="crayon-56d5a066ad08c041903259-17"><span class="crayon-h">		</span><span class="crayon-c"># if the cached homography matrix is None, then we need to</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad08c041903259-18"><span class="crayon-h">		</span><span class="crayon-c"># apply keypoint matching to construct it</span></p><p class="crayon-line" id="crayon-56d5a066ad08c041903259-19"><span class="crayon-h">		</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">cachedH </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-t">None</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad08c041903259-20"><span class="crayon-h">			</span><span class="crayon-c"># detect keypoints and extract</span></p><p class="crayon-line" id="crayon-56d5a066ad08c041903259-21"><span class="crayon-h">			</span><span class="crayon-sy">(</span><span class="crayon-v">kpsA</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">featuresA</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">detectAndDescribe</span><span class="crayon-sy">(</span><span class="crayon-v">imageA</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad08c041903259-22"><span class="crayon-h">			</span><span class="crayon-sy">(</span><span class="crayon-v">kpsB</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">featuresB</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">detectAndDescribe</span><span class="crayon-sy">(</span><span class="crayon-v">imageB</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a066ad08c041903259-23"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad08c041903259-24"><span class="crayon-h">			</span><span class="crayon-c"># match features between the two images</span></p><p class="crayon-line" id="crayon-56d5a066ad08c041903259-25"><span class="crayon-h">			</span><span class="crayon-v">M</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">matchKeypoints</span><span class="crayon-sy">(</span><span class="crayon-v">kpsA</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">kpsB</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad08c041903259-26"><span class="crayon-h">				</span><span class="crayon-v">featuresA</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">featuresB</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ratio</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">reprojThresh</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a066ad08c041903259-27"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad08c041903259-28"><span class="crayon-h">			</span><span class="crayon-c"># if the match is None, then there aren't enough matched</span></p><p class="crayon-line" id="crayon-56d5a066ad08c041903259-29"><span class="crayon-h">			</span><span class="crayon-c"># keypoints to create a panorama</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad08c041903259-30"><span class="crayon-h">			</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-i">M</span><span class="crayon-h"> </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-t">None</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5a066ad08c041903259-31"><span class="crayon-h">				</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">None</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad08c041903259-32"> </p><p class="crayon-line" id="crayon-56d5a066ad08c041903259-33"><span class="crayon-h">			</span><span class="crayon-c"># cache the homography matrix</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad08c041903259-34"><span class="crayon-h">			</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">cachedH</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">M</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></p><p class="crayon-line" id="crayon-56d5a066ad08c041903259-35"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad08c041903259-36"><span class="crayon-h">		</span><span class="crayon-c"># apply a perspective transform to stitch the images together</span></p><p class="crayon-line" id="crayon-56d5a066ad08c041903259-37"><span class="crayon-h">		</span><span class="crayon-c"># using the cached homography matrix</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad08c041903259-38"><span class="crayon-h">		</span><span class="crayon-v">result</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">warpPerspective</span><span class="crayon-sy">(</span><span class="crayon-v">imageA</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">cachedH</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d5a066ad08c041903259-39"><span class="crayon-h">			</span><span class="crayon-sy">(</span><span class="crayon-v">imageA</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">imageB</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">imageA</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad08c041903259-40"><span class="crayon-h">		</span><span class="crayon-v">result</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-v">imageB</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-v">imageB</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">imageB</span></p><p class="crayon-line" id="crayon-56d5a066ad08c041903259-41"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad08c041903259-42"><span class="crayon-h">		</span><span class="crayon-c"># return the stitched image</span></p><p class="crayon-line" id="crayon-56d5a066ad08c041903259-43"><span class="crayon-h">		</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">result</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>On <strong>Line 19</strong> we make a check to see if the homography matrix has been computed before. If not, we detect keypoints and extract local invariant descriptors from the two images, followed by applying keypoint matching. We then cache the homography matrix on <strong>Line 34</strong>.</p>
<p>Subsequent calls to 
			<span id="crayon-56d5a066ad091121270730" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">stitch</span></span></span>  will use this cached matrix, allowing us to sidestep detecting keypoints, extracting features, and performing keypoint matching on <em>every</em> set of frames.</p>
<p>For the rest of the source code to 
			<span id="crayon-56d5a066ad095012905393" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">panorama</span><span class="crayon-sy">.</span><span class="crayon-v">py</span></span></span> , please see the <a href="http://www.pyimagesearch.com/2016/01/11/opencv-panorama-stitching/" target="_blank">image stitching tutorial</a> or use the form at the bottom of this post to download the source code.</p>
<h3>Performing real-time panorama stitching</h3>
<p>Now that our 
			<span id="crayon-56d5a066ad098423408816" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">Stitcher</span></span></span>  class has been updated, let’s move on to to the 
			<span id="crayon-56d5a066ad09c402983894" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">realtime_stitching</span><span class="crayon-sy">.</span><span class="crayon-v">py</span></span></span>  driver script:</p>

		<div id="crayon-56d5a066ad09f533079952" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5a066ad09f533079952-1"><span class="crayon-c"># import the necessary packages</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad09f533079952-2"><span class="crayon-st">from</span><span class="crayon-h"> </span><span class="crayon-k ">__future__</span><span class="crayon-h"> </span><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">print_function</span></p><p class="crayon-line" id="crayon-56d5a066ad09f533079952-3"><span class="crayon-st">from</span><span class="crayon-h"> </span><span class="crayon-v">pyimagesearch</span><span class="crayon-sy">.</span><span class="crayon-e">basicmotiondetector </span><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">BasicMotionDetector</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad09f533079952-4"><span class="crayon-st">from</span><span class="crayon-h"> </span><span class="crayon-v">pyimagesearch</span><span class="crayon-sy">.</span><span class="crayon-e">panorama </span><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">Stitcher</span></p><p class="crayon-line" id="crayon-56d5a066ad09f533079952-5"><span class="crayon-st">from</span><span class="crayon-h"> </span><span class="crayon-v">imutils</span><span class="crayon-sy">.</span><span class="crayon-e">video </span><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">VideoStream</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad09f533079952-6"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">numpy </span><span class="crayon-st">as</span><span class="crayon-h"> </span><span class="crayon-e">np</span></p><p class="crayon-line" id="crayon-56d5a066ad09f533079952-7"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-k ">datetime</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad09f533079952-8"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">imutils</span></p><p class="crayon-line" id="crayon-56d5a066ad09f533079952-9"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-k ">time</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad09f533079952-10"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span></p><p class="crayon-line" id="crayon-56d5a066ad09f533079952-11"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad09f533079952-12"><span class="crayon-c"># initialize the video streams and allow them to warmup</span></p><p class="crayon-line" id="crayon-56d5a066ad09f533079952-13"><span class="crayon-k ">print</span><span class="crayon-sy">(</span><span class="crayon-s">"[INFO] starting cameras..."</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad09f533079952-14"><span class="crayon-v">leftStream</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">VideoStream</span><span class="crayon-sy">(</span><span class="crayon-v">src</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">start</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a066ad09f533079952-15"><span class="crayon-v">rightStream</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">VideoStream</span><span class="crayon-sy">(</span><span class="crayon-v">usePiCamera</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">start</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad09f533079952-16"><span class="crayon-k ">time</span><span class="crayon-sy">.</span><span class="crayon-e">sleep</span><span class="crayon-sy">(</span><span class="crayon-cn">2.0</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>We start off by importing our required Python packages. The 
			<span id="crayon-56d5a066ad0a3033909194" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">BasicMotionDetector</span></span></span>  and 
			<span id="crayon-56d5a066ad0a7687739594" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">Stitcher</span></span></span>  classes are imported from the 
			<span id="crayon-56d5a066ad0aa203315638" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">pyimagesearch</span></span></span>  module. We’ll also need the 
			<span id="crayon-56d5a066ad0ad682201016" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">VideoStream</span></span></span>  class from the <a href="https://github.com/jrosebr1/imutils" target="_blank">imutils</a> package.</p>
<p>If you don’t already have 
			<span id="crayon-56d5a066ad0b1782947156" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">imutils</span></span></span>  installed on your system, you can install it using:</p>

		

<p>If you do already have it installed, make sure you have upgraded to the latest version (which has added Python 3 support to the 
			<span id="crayon-56d5a066ad0b8378148298" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">video</span></span></span>  sub-module):</p>

		<div id="crayon-56d5a066ad0bb722832170" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5a066ad0bb722832170-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">pip </span><span class="crayon-v">install</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">upgrade </span><span class="crayon-v">imutils</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p><strong>Lines 14 and 15</strong> then initialize our two 
			<span id="crayon-56d5a066ad0bf661288825" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">VideoStream</span></span></span>  classes. Here I assume that 
			<span id="crayon-56d5a066ad0c2219563894" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">leftStream</span></span></span>  is a USB camera and 
			<span id="crayon-56d5a066ad0c5733262578" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">rightStream</span></span></span>  is a Raspberry Pi camera (indicated by 
			<span id="crayon-56d5a066ad0c9822008608" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">usePiCamera</span><span class="crayon-o">=</span><span class="crayon-t">True</span></span></span> ).</p>
<p>If you wanted to use <em>two USB cameras</em>, you would simply have to update the stream initializations to:</p>

		<div id="crayon-56d5a066ad0cc065375909" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5a066ad0cc065375909-1"><span class="crayon-v">leftStream</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">VideoStream</span><span class="crayon-sy">(</span><span class="crayon-v">src</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">start</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad0cc065375909-2"><span class="crayon-v">rightStream</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">VideoStream</span><span class="crayon-sy">(</span><span class="crayon-v">src</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">start</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>The 
			<span id="crayon-56d5a066ad0cf629460933" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">src</span></span></span>  parameter controls the <em>index</em> of the camera on your system.</p>
<p>Again, it’s <strong><em>imperative</em></strong> that you initialize 
			<span id="crayon-56d5a066ad0d3469690272" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">leftStream</span></span></span>  and 
			<span id="crayon-56d5a066ad0d6799653081" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">rightStream</span></span></span>  correctly. When standing <em>behind</em> the cameras, the 
			<span id="crayon-56d5a066ad0da569399658" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">leftStream</span></span></span>  should be the camera to your lefthand side and the 
			<span id="crayon-56d5a066ad0dd991202307" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">rightStream</span></span></span>  should be the camera to your righthand side.</p>
<p><strong>Failure to set these stream variables correctly will result in a “panorama” that contains only <em>one</em> of the <em>two</em> frames.</strong></p>
<p>From here, let’s initialize the image stitcher and motion detector:</p>

		<div id="crayon-56d5a066ad0e0851651630" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad0e0851651630-18"><span class="crayon-c"># initialize the image stitcher, motion detector, and total</span></p><p class="crayon-line" id="crayon-56d5a066ad0e0851651630-19"><span class="crayon-c"># number of frames read</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad0e0851651630-20"><span class="crayon-v">stitcher</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Stitcher</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a066ad0e0851651630-21"><span class="crayon-v">motion</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">BasicMotionDetector</span><span class="crayon-sy">(</span><span class="crayon-v">minArea</span><span class="crayon-o">=</span><span class="crayon-cn">500</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad0e0851651630-22"><span class="crayon-v">total</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>Now we come to the main loop of our driver script where we loop over frames infinitely until instructed to exit the program:</p>

		<div id="crayon-56d5a066ad0e5938454802" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad0e5938454802-24">24</p><p class="crayon-num" data-line="crayon-56d5a066ad0e5938454802-25">25</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad0e5938454802-26">26</p><p class="crayon-num" data-line="crayon-56d5a066ad0e5938454802-27">27</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad0e5938454802-28">28</p><p class="crayon-num" data-line="crayon-56d5a066ad0e5938454802-29">29</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad0e5938454802-30">30</p><p class="crayon-num" data-line="crayon-56d5a066ad0e5938454802-31">31</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad0e5938454802-32">32</p><p class="crayon-num" data-line="crayon-56d5a066ad0e5938454802-33">33</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad0e5938454802-34">34</p><p class="crayon-num" data-line="crayon-56d5a066ad0e5938454802-35">35</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad0e5938454802-36">36</p><p class="crayon-num" data-line="crayon-56d5a066ad0e5938454802-37">37</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad0e5938454802-38">38</p><p class="crayon-num" data-line="crayon-56d5a066ad0e5938454802-39">39</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad0e5938454802-40">40</p><p class="crayon-num" data-line="crayon-56d5a066ad0e5938454802-41">41</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad0e5938454802-42">42</p><p class="crayon-num" data-line="crayon-56d5a066ad0e5938454802-43">43</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad0e5938454802-44">44</p><p class="crayon-num" data-line="crayon-56d5a066ad0e5938454802-45">45</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad0e5938454802-46">46</p><p class="crayon-num" data-line="crayon-56d5a066ad0e5938454802-47">47</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad0e5938454802-48">48</p><p class="crayon-num" data-line="crayon-56d5a066ad0e5938454802-49">49</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad0e5938454802-24"><span class="crayon-c"># loop over frames from the video streams</span></p><p class="crayon-line" id="crayon-56d5a066ad0e5938454802-25"><span class="crayon-st">while</span><span class="crayon-h"> </span><span class="crayon-t">True</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad0e5938454802-26"><span class="crayon-h">	</span><span class="crayon-c"># grab the frames from their respective video streams</span></p><p class="crayon-line" id="crayon-56d5a066ad0e5938454802-27"><span class="crayon-h">	</span><span class="crayon-v">left</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">leftStream</span><span class="crayon-sy">.</span><span class="crayon-e">read</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad0e5938454802-28"><span class="crayon-h">	</span><span class="crayon-v">right</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">rightStream</span><span class="crayon-sy">.</span><span class="crayon-e">read</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a066ad0e5938454802-29"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad0e5938454802-30"><span class="crayon-h">	</span><span class="crayon-c"># resize the frames</span></p><p class="crayon-line" id="crayon-56d5a066ad0e5938454802-31"><span class="crayon-h">	</span><span class="crayon-v">left</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">imutils</span><span class="crayon-sy">.</span><span class="crayon-e">resize</span><span class="crayon-sy">(</span><span class="crayon-v">left</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">width</span><span class="crayon-o">=</span><span class="crayon-cn">400</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad0e5938454802-32"><span class="crayon-h">	</span><span class="crayon-v">right</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">imutils</span><span class="crayon-sy">.</span><span class="crayon-e">resize</span><span class="crayon-sy">(</span><span class="crayon-v">right</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">width</span><span class="crayon-o">=</span><span class="crayon-cn">400</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a066ad0e5938454802-33"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad0e5938454802-34"><span class="crayon-h">	</span><span class="crayon-c"># stitch the frames together to form the panorama</span></p><p class="crayon-line" id="crayon-56d5a066ad0e5938454802-35"><span class="crayon-h">	</span><span class="crayon-c"># IMPORTANT: you might have to change this line of code</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad0e5938454802-36"><span class="crayon-h">	</span><span class="crayon-c"># depending on how your cameras are oriented; frames</span></p><p class="crayon-line" id="crayon-56d5a066ad0e5938454802-37"><span class="crayon-h">	</span><span class="crayon-c"># should be supplied in left-to-right order</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad0e5938454802-38"><span class="crayon-h">	</span><span class="crayon-v">result</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">stitcher</span><span class="crayon-sy">.</span><span class="crayon-e">stitch</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">left</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">right</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a066ad0e5938454802-39"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad0e5938454802-40"><span class="crayon-h">	</span><span class="crayon-c"># no homograpy could be computed</span></p><p class="crayon-line" id="crayon-56d5a066ad0e5938454802-41"><span class="crayon-h">	</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">result </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-t">None</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad0e5938454802-42"><span class="crayon-h">		</span><span class="crayon-k ">print</span><span class="crayon-sy">(</span><span class="crayon-s">"[INFO] homography could not be computed"</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a066ad0e5938454802-43"><span class="crayon-h">		</span><span class="crayon-st">break</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad0e5938454802-44"> </p><p class="crayon-line" id="crayon-56d5a066ad0e5938454802-45"><span class="crayon-h">	</span><span class="crayon-c"># convert the panorama to grayscale, blur it slightly, update</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad0e5938454802-46"><span class="crayon-h">	</span><span class="crayon-c"># the motion detector</span></p><p class="crayon-line" id="crayon-56d5a066ad0e5938454802-47"><span class="crayon-h">	</span><span class="crayon-v">gray</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">cvtColor</span><span class="crayon-sy">(</span><span class="crayon-v">result</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">COLOR_BGR2GRAY</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad0e5938454802-48"><span class="crayon-h">	</span><span class="crayon-v">gray</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">GaussianBlur</span><span class="crayon-sy">(</span><span class="crayon-v">gray</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">21</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">21</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a066ad0e5938454802-49"><span class="crayon-h">	</span><span class="crayon-v">locs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">motion</span><span class="crayon-sy">.</span><span class="crayon-e">update</span><span class="crayon-sy">(</span><span class="crayon-v">gray</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p><strong>Lines 27 and 28</strong> read the 
			<span id="crayon-56d5a066ad0e9612832373" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">left</span></span></span>  and 
			<span id="crayon-56d5a066ad0ed882080878" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">right</span></span></span>  frames from their respective video streams. We then resize the frames to have a width of 400 pixels, followed by stitching them together to form the panorama. Remember, frames supplied to the 
			<span id="crayon-56d5a066ad0f0967273428" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">stitch</span></span></span>  method need to be supplied in <em>left-to-right order!</em></p>
<p>In the case that the images cannot be stitched (i.e., a homography matrix could not be computed), we break from the loop (<strong>Lines 41-43</strong>).</p>
<p>Provided that the panorama could be constructed, we then process it by converting it to grayscale and blurring it slightly (<strong>Lines 47 and 48</strong>). The processed panorama is then passed into the motion detector (<strong>Line 49</strong>).</p>
<p>However, before we can detect any motion, we first need to allow the motion detector to “run” for a bit to obtain an accurate running average of the background model:</p>

		<div id="crayon-56d5a066ad0f4679967965" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-56d5a066ad0f4679967965-51">51</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad0f4679967965-52">52</p><p class="crayon-num" data-line="crayon-56d5a066ad0f4679967965-53">53</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad0f4679967965-54">54</p><p class="crayon-num" data-line="crayon-56d5a066ad0f4679967965-55">55</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad0f4679967965-56">56</p><p class="crayon-num" data-line="crayon-56d5a066ad0f4679967965-57">57</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad0f4679967965-58">58</p><p class="crayon-num" data-line="crayon-56d5a066ad0f4679967965-59">59</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad0f4679967965-60">60</p><p class="crayon-num" data-line="crayon-56d5a066ad0f4679967965-61">61</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad0f4679967965-62">62</p><p class="crayon-num" data-line="crayon-56d5a066ad0f4679967965-63">63</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad0f4679967965-64">64</p><p class="crayon-num" data-line="crayon-56d5a066ad0f4679967965-65">65</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad0f4679967965-66">66</p><p class="crayon-num" data-line="crayon-56d5a066ad0f4679967965-67">67</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad0f4679967965-68">68</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5a066ad0f4679967965-51"><span class="crayon-h">	</span><span class="crayon-c"># only process the panorama for motion if a nice average has</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad0f4679967965-52"><span class="crayon-h">	</span><span class="crayon-c"># been built up</span></p><p class="crayon-line" id="crayon-56d5a066ad0f4679967965-53"><span class="crayon-h">	</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">total</span><span class="crayon-h"> </span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-cn">32</span><span class="crayon-h"> </span><span class="crayon-st">and</span><span class="crayon-h"> </span><span class="crayon-k ">len</span><span class="crayon-sy">(</span><span class="crayon-v">locs</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad0f4679967965-54"><span class="crayon-h">		</span><span class="crayon-c"># initialize the minimum and maximum (x, y)-coordinates,</span></p><p class="crayon-line" id="crayon-56d5a066ad0f4679967965-55"><span class="crayon-h">		</span><span class="crayon-c"># respectively</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad0f4679967965-56"><span class="crayon-h">		</span><span class="crayon-sy">(</span><span class="crayon-v">minX</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">minY</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">np</span><span class="crayon-sy">.</span><span class="crayon-v">inf</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">np</span><span class="crayon-sy">.</span><span class="crayon-v">inf</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a066ad0f4679967965-57"><span class="crayon-h">		</span><span class="crayon-sy">(</span><span class="crayon-v">maxX</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">maxY</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-o">-</span><span class="crayon-v">np</span><span class="crayon-sy">.</span><span class="crayon-v">inf</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">np</span><span class="crayon-sy">.</span><span class="crayon-v">inf</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad0f4679967965-58"> </p><p class="crayon-line" id="crayon-56d5a066ad0f4679967965-59"><span class="crayon-h">		</span><span class="crayon-c"># loop over the locations of motion and accumulate the</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad0f4679967965-60"><span class="crayon-h">		</span><span class="crayon-c"># minimum and maximum locations of the bounding boxes</span></p><p class="crayon-line" id="crayon-56d5a066ad0f4679967965-61"><span class="crayon-h">		</span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">l</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">locs</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad0f4679967965-62"><span class="crayon-h">			</span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-k ">w</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">h</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">boundingRect</span><span class="crayon-sy">(</span><span class="crayon-v">l</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a066ad0f4679967965-63"><span class="crayon-h">			</span><span class="crayon-sy">(</span><span class="crayon-v">minX</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">maxX</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-k ">min</span><span class="crayon-sy">(</span><span class="crayon-v">minX</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">x</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-k ">max</span><span class="crayon-sy">(</span><span class="crayon-v">maxX</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">x</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-k ">w</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad0f4679967965-64"><span class="crayon-h">			</span><span class="crayon-sy">(</span><span class="crayon-v">minY</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">maxY</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-k ">min</span><span class="crayon-sy">(</span><span class="crayon-v">minY</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-k ">max</span><span class="crayon-sy">(</span><span class="crayon-v">maxY</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">h</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a066ad0f4679967965-65"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad0f4679967965-66"><span class="crayon-h">		</span><span class="crayon-c"># draw the bounding box</span></p><p class="crayon-line" id="crayon-56d5a066ad0f4679967965-67"><span class="crayon-h">		</span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">rectangle</span><span class="crayon-sy">(</span><span class="crayon-v">result</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">minX</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">minY</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">maxX</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">maxY</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad0f4679967965-68"><span class="crayon-h">			</span><span class="crayon-sy">(</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">255</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">3</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>We use the first 32 frames of the initial video streams as an estimation of the background — during these 32 frames <em>no</em> motion should be taking place.</p>
<p>Otherwise, provided that we have processed the 32 initial frames for the background model initialization, we can check the 
			<span id="crayon-56d5a066ad0f9154051313" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">len</span></span></span>  of 
			<span id="crayon-56d5a066ad0fd198512336" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">locs</span></span></span>  to see if it is greater than zero. If it is, then we can assume “motion” is taking place in the panorama image.</p>
<p>We then initialize the minimum and maximum <em>(x, y)-</em>coordinates associated with the locations containing motion. Given this list (i.e., 
			<span id="crayon-56d5a066ad100519835248" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">locs</span></span></span> ), we loop over the contour regions individually, compute the bounding box, and determine the smallest region encompassing all contours. This bounding box is then drawn on the panorama image.</p>
<p>As mentioned in <a href="http://www.pyimagesearch.com/2016/01/18/multiple-cameras-with-the-raspberry-pi-and-opencv/" target="_blank">last week’s post</a>, the motion detector we use assumes there is only <em>one</em> object/person moving at a time. For <em>multiple objects</em>, a more advanced algorithm is required (which we will cover in a future PyImageSearch post).</p>
<p>Finally, the last step is to draw the timestamp on panorama and show the output images:</p>

		<div id="crayon-56d5a066ad104420460038" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad104420460038-70">70</p><p class="crayon-num" data-line="crayon-56d5a066ad104420460038-71">71</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad104420460038-72">72</p><p class="crayon-num" data-line="crayon-56d5a066ad104420460038-73">73</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad104420460038-74">74</p><p class="crayon-num" data-line="crayon-56d5a066ad104420460038-75">75</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad104420460038-76">76</p><p class="crayon-num" data-line="crayon-56d5a066ad104420460038-77">77</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad104420460038-78">78</p><p class="crayon-num" data-line="crayon-56d5a066ad104420460038-79">79</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad104420460038-80">80</p><p class="crayon-num" data-line="crayon-56d5a066ad104420460038-81">81</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad104420460038-82">82</p><p class="crayon-num" data-line="crayon-56d5a066ad104420460038-83">83</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad104420460038-84">84</p><p class="crayon-num" data-line="crayon-56d5a066ad104420460038-85">85</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad104420460038-86">86</p><p class="crayon-num" data-line="crayon-56d5a066ad104420460038-87">87</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad104420460038-88">88</p><p class="crayon-num" data-line="crayon-56d5a066ad104420460038-89">89</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad104420460038-90">90</p><p class="crayon-num" data-line="crayon-56d5a066ad104420460038-91">91</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a066ad104420460038-92">92</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad104420460038-70"><span class="crayon-h">	</span><span class="crayon-c"># increment the total number of frames read and draw the </span></p><p class="crayon-line" id="crayon-56d5a066ad104420460038-71"><span class="crayon-h">	</span><span class="crayon-c"># timestamp on the image</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad104420460038-72"><span class="crayon-h">	</span><span class="crayon-v">total</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></p><p class="crayon-line" id="crayon-56d5a066ad104420460038-73"><span class="crayon-h">	</span><span class="crayon-v">timestamp</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">datetime</span><span class="crayon-sy">.</span><span class="crayon-k ">datetime</span><span class="crayon-sy">.</span><span class="crayon-e">now</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad104420460038-74"><span class="crayon-h">	</span><span class="crayon-v">ts</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">timestamp</span><span class="crayon-sy">.</span><span class="crayon-e">strftime</span><span class="crayon-sy">(</span><span class="crayon-s">"%A %d %B %Y %I:%M:%S%p"</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a066ad104420460038-75"><span class="crayon-h">	</span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">putText</span><span class="crayon-sy">(</span><span class="crayon-v">result</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ts</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">10</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">result</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad104420460038-76"><span class="crayon-h">		</span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">FONT_HERSHEY_SIMPLEX</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0.35</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">255</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a066ad104420460038-77"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad104420460038-78"><span class="crayon-h">	</span><span class="crayon-c"># show the output images</span></p><p class="crayon-line" id="crayon-56d5a066ad104420460038-79"><span class="crayon-h">	</span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">imshow</span><span class="crayon-sy">(</span><span class="crayon-s">"Result"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">result</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad104420460038-80"><span class="crayon-h">	</span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">imshow</span><span class="crayon-sy">(</span><span class="crayon-s">"Left Frame"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">left</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a066ad104420460038-81"><span class="crayon-h">	</span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">imshow</span><span class="crayon-sy">(</span><span class="crayon-s">"Right Frame"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">right</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad104420460038-82"><span class="crayon-h">	</span><span class="crayon-v">key</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">waitKey</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-cn">0xFF</span></p><p class="crayon-line" id="crayon-56d5a066ad104420460038-83"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad104420460038-84"><span class="crayon-h">	</span><span class="crayon-c"># if the `q` key was pressed, break from the loop</span></p><p class="crayon-line" id="crayon-56d5a066ad104420460038-85"><span class="crayon-h">	</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">key</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-k ">ord</span><span class="crayon-sy">(</span><span class="crayon-s">"q"</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad104420460038-86"><span class="crayon-h">		</span><span class="crayon-st">break</span></p><p class="crayon-line" id="crayon-56d5a066ad104420460038-87"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad104420460038-88"><span class="crayon-c"># do a bit of cleanup</span></p><p class="crayon-line" id="crayon-56d5a066ad104420460038-89"><span class="crayon-k ">print</span><span class="crayon-sy">(</span><span class="crayon-s">"[INFO] cleaning up..."</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad104420460038-90"><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">destroyAllWindows</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a066ad104420460038-91"><span class="crayon-v">leftStream</span><span class="crayon-sy">.</span><span class="crayon-e">stop</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a066ad104420460038-92"><span class="crayon-v">rightStream</span><span class="crayon-sy">.</span><span class="crayon-e">stop</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p><strong>Lines 82-86</strong> make a check to see if the 
			<span id="crayon-56d5a066ad10a173098923" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">q</span></span></span>  key is pressed. If it is, we break from the video stream loop and do a bit of cleanup.</p>
<h3>Running our panorama builder + motion detector</h3>
<p>To execute our script, just issue the following command:</p>

		<div id="crayon-56d5a066ad10d184658843" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5a066ad10d184658843-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">python </span><span class="crayon-v">realtime_stitching</span><span class="crayon-e">.py</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>Below you can find an example GIF of my results:</p>
<div id="attachment_3594" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2016/01/realtime_panorama_stitching_animation.gif"><img class="size-full wp-image-3594" src="http://www.pyimagesearch.com/wp-content/uploads/2016/01/realtime_panorama_stitching_animation.gif" alt="Figure 4: Applying motion detection on a panorama constructed from multiple cameras on the Raspberry Pi, using Python + OpenCV."/></a><p class="wp-caption-text"><strong>Figure 4:</strong> Applying motion detection on a panorama constructed from multiple cameras on the Raspberry Pi, using Python + OpenCV.</p></div>
<p>On the <i>top-left</i> we have the <strong>left video stream</strong>. And on the <em>top-right</em> we have the <strong>right video stream</strong>. <strong>On the <i>bottom</i>, we can see that both frames have been stitched together into a single panorama.</strong> Motion detection is then performed on the panorama image and a bounding box drawn around the motion region.</p>
<p>The full video demo can be seen below:</p>
<p><iframe src="http://www.youtube.com/embed/n3CsQEC4Z3U?feature=oembed" frameborder="0" allowfullscreen="">VIDEO</iframe></p>
<h2>Summary</h2>
<p>In this blog post, we combined our knowledge over the past 1.5 months of tutorials and:</p>
<ol>
<li>Increased FPS processing rate using threadng.</li>
<li>Accessed <em>multiple</em> video streams at once.</li>
<li>Performed image stitching and panorama construction from these video streams.</li>
<li>And applied motion detection on the panorama image.</li>
</ol>
<p>Overall, we were able to easily accomplish all of this on the Raspberry Pi. We can expect <em>even faster</em> performance on a modern laptop or desktop system.</p>
<p>See you next week!</p>
<p><strong>If you enjoyed this post, <em>please be sure to signup for the PyImageSearch Newsletter using the form below!</em></strong></p>
<h2 id="post_downloads">Downloads:</h2>

	</section>
	</div></body></html>