<html><body><div><div class="content html_format"><p>
      Ещё совсем недавно было первое июня, а тут уже первое сентября. Осень на дворе.</p>
<p>
Да, недавно тоже так отвернулся, а очнулся — Mail поглотил VK. И началось: видео без рекламы не посмотришь, музыку не послушаешь — запретили правообладатели. Ходят слухи, что вообще запретят. Почуял неладное. А тут как раз такое время года. Вот и подумал, а почему бы мне не собрать свои запасы? Законсервирую свою музыку на своём компе, перекину на диск — слаще любого варенья будет! А поможет мне в этом, как не странно, сам ВК, а точнее — его api. А ещё третий python, встроенная библиотека urllib и библиотека по работе с данным в формате json.
</p><a name="habracut"/><p>
У api vk можно запрашивать информацию о аудиозаписях пользователя. Ответ нам будет приходить в формате json, и в нём будет содержаться количество аудиозаписей пользователя, а также расширенная информация о каждой песне, если такая информация имеется. А главное, что у каждой песни будет url-адрес, по которому она лежит на серверах ВК. Как раз то, что нам нужно.
</p><p>
Для работы с большинством методов api нужен специальный ключ (далее — access_token), который vk выдает приложениям. Как его получить — расскажу чуть позже.
</p><p>
Помните окошко, которое появляется, как только приложение запрашивает доступ к информации с вашей страницы? Нажимая «Разрешить», вы даете приложению право получить access_token на ваше имя, в котором будут содержаться параметры доступа к информации с вашей страницы. 
</p><p>
Что ж, начнём?
</p><p>
Откроем вкладку "</p><a href="http://vk.com/dev">разработчикам</a><p>" и создадим новое приложение:
 
</p><img src="https://habrastorage.org/getpro/habr/post_images/50f/4fb/afb/50f4fbafb494313ea52a1363ac3bb686.png" alt="image"/>
<p>
Вводим название вашего приложения и выбираем его тип: standalone-приложение:

</p><img src="https://habrastorage.org/getpro/habr/post_images/b68/370/8da/b683708da0f7b8545cda8e927c43db1e.png" alt="image"/>
<p>
Подтверждаем действие через смс, которая падает в ваш мобильный:

</p><img src="https://habrastorage.org/getpro/habr/post_images/3be/dcd/ae1/3bedcdae1aa7385ca8e6d6ada4d90724.png" alt="image"/>
 <p>
Как только мы прошли все формальности, мы получаем id нашего приложения, который будем использовать для получения access_token-a. Откроем ту часть документации, которая посвящена авторизации клиентских </p><a href="http://vk.com/dev/auth_mobile">standalone-приложений</a><p>.

</p><img src="https://habrastorage.org/getpro/habr/post_images/a09/ca4/9b8/a09ca49b83cbdc3f0b0158f30aaf7cd4.png" alt="image"/>

<img src="https://habrastorage.org/getpro/habr/post_images/d35/9cc/401/d359cc401f70f38317ccbde875a4b9ac.png" alt="image"/>
 
<i>Важно</i><p>
redirect_uri в нашем случае должен быть равен </p><code><a href="https://oauth.vk.com/blank.html"/>oauth.vk.com/blank.html</code><p>, так как другой адрес нужно указывать, только если мы разрабатываем браузерное javascript-приложение.
</p><p>
Так как в нашем приложении мы будем работать с аудиозаписями, в атрибут scope мы передадим параметр audio. Обычно access_token выдается на время. Чтобы получить его бессрочно, в атрибут scope можно передать параметр offline.
</p><p>
Примечания:
</p><ul>
<li>несколько параметров в один и тот же атрибут пишутся через запятую. </li>
<li>атрибуты в запросе пишутся через амперсанд (&amp;)</li>
</ul><p>
Для полной таблицы параметров атрибута scope посетите </p><a href="http://vk.com/dev/permissions">ссылку</a><p>.
</p><p>
В итоге в адресной строке мы вбиваем что-то на подобие:
</p><blockquote><pre>https://oauth.vk.com/authorize/client_id=YOUR_CLIENT_ID&amp;redirect_uri=https://oauth.vk.com/blank.html&amp;display=page&amp;response_type=token</pre></blockquote><p>
Если у вас всё получилось, вы увидите это окошко. 

</p><img src="https://habrastorage.org/getpro/habr/post_images/53f/db2/546/53fdb25460942ccaed3675d6ec9cc5f4.png" alt="image"/>
<p>
После успешной авторизации и получения прав доступа вы будете перенаправлены по адресу </p><code><a href="https://oauth.vk.com/blank.html"/>oauth.vk.com/blank.html</code><p>. В адресной строке вы увидите атрибут </p><code>access_token= YOUR_ACCESS_TOKEN</code><p>. Обязательно сохраните этот ключ, чтобы не потерять его в дальнейшем. Именно его мы будем использовать при написании запросов к api.
</p><p>
Для того, чтобы получать список аудиозаписей пользователя, мы воспользуемся методом api audio.get. Как я уже говорил выше, метод audio.get возвращает нам ответ в json-формате. Вот пример json-объекта, который возвращает этот метод.
</p><pre>
{
	"response":
		[712,
			{
			"aid":393825624,
			"owner_id":59223044,
			"artist":"Saint Asonia",
			"title":"Blow Me Wide Open",
			"duration":224,
			"url":"http:\/\/cs9-11v4.vk.me\/p13\/39a25fcb2c8ce0.mp3?extra=hLsHqDEzrwLWudHCpV1RRIAEHmwymoX6DyWikmJFCpjhdS_xrATqtAtC9trWSyyd1asFakko8BvXCTkjfQKEPlqdVFL6",
			"lyrics_id":"274446714",
			"genre":18
			},
			{"aid":392782493,
			"owner_id":59223044,
			"artist":"Kongos",
			"title":"I'm Only Joking",
			"duration":225,
			"url":"http:\/\/cs9-12v4.vk.me\/p15\/b4d77a6a010d08.mp3?extra=7PQDPyENs9k029CQcO7hVtYV3AHQx90-ZUxKYKhE3ztr5BY9esrUeLaF-KG-ub1_svELz0E1M5pd6zca3BK12J4EwrnI",
			"lyrics_id":"184734619"
			,"genre":21
			}
		]
}
</pre><p>
Итак, как вы видите, объект состоит из словаря с ключом response, по которому хранится массив песен.
</p><p>
Первый объект — количество песен на странице пользователя, а все последующие являются словарями, содержащими информацию о песнях. Воспользуемся методом request.urlopen из библиотеки urllib, который позволяет получать данные, хранящиеся по url-адресу в интернете.

</p><blockquote>from urllib.request import urlopen<br/>
</blockquote><p>
Функция urlopen требует обязательный параметр — url-адрес, который она откроет. В нашем случае — это метод audio.get:

</p><img src="https://habrastorage.org/getpro/habr/post_images/90d/50a/634/90d50a634a0d7e342793bba0cf6c280e.png" alt="image"/>
<p>
Для обращения к методам api vk нужно дергать методы, расположенные по адресу </p><pre>https://api.vk.com/method/METHOD_NAME?</pre><p>, передавая туда все нужные методу аргументы.
</p><p>
Итак, напишем тот урл, который будем открывать:
</p><blockquote>address = 'https://api.vk.com/method/audio.get?owner_id=YOUR_OWNER_ID&amp;access_token=YOUR_ACCESS_TOKEN'</blockquote><p>
и откроем его:

</p><blockquote>data = urlopen(address)<br/>
</blockquote><p>
Данные, которые мы получили, надо прочитать и раскодировать, так как нам приходит нераскодированная информация. А так, как это всё завернуто в формат json, то чтобы обращаться со словарём, как с объектом Python, мы должны воспользоваться библиотекой json.

</p><blockquote>import json<br/>
</blockquote><p>
Воспользуемся методом loads(), который превращает строку, содержащую объект формата json, в объект языка Python:

</p><blockquote>decoded_response = data.read().decode()<br/>
final_data = json.loads(decoded_response)<br/>
</blockquote><p>
Ура! Теперь мы можем обращаться к данным, содержащимся в переменной final_data. Получим все словари, в которых содержится информация о песнях:

</p><blockquote>songs = final_data['response'][1:]<br/>
</blockquote><p>
Этой строчкой мы получили все элементы массива response с 1 по конечный. Теперь будем работать с каждой песней отдельно. 
</p><blockquote><pre>
for song in songs:
	song_artist = song['artist']
	song_title = song['title']
	song_url = song['url']</pre><br/>
</blockquote><p>
Получим информацию, хранящуюся по адресу song_url:

</p><blockquote>cached_song = urlopen(song_url).read()<br/>
</blockquote><p>
И запишем её в файл. Где же его создавать, спросите вы? А для этого вам нужна будет библиотека os. Напишем вне нашего цикла:
</p><blockquote>import os<br/>
</blockquote><p>
И создадим папку music на диске С функцией</p><blockquote> os.mkdir('C://Music')<br/>
</blockquote><p>
Теперь у нас есть папка, в которую мы хотим записывать наши песни.
</p><p>
Для того, чтобы наши песни хранились в порядке, мы будем создавать группы для каждого артиста. А для того, чтобы понять, нужно ли нам создавать папку, или нет, воспользуемся функцией os.listdir, которая возвращает список объектов по указанному пути:
</p><blockquote><pre>
if song_artist not in os.listdir('C://Music'):
	os.mkdir('C://Music/%s' %(song_artist))</pre></blockquote>
<p>
Теперь мы создаём файл и записываем туда нашу песню.
</p><blockquote>filename = 'C://Music/%s/%s.mp3' %(song_artist, song_title)<br/>
file = open(filename, 'wb')<br/>
file.write(cached_song)<br/>
file.close()<br/>
</blockquote><p>
Ура. Осталось всего лишь ещё раз посмотреть на красивый код и нажать «Выполнить». Ну, а ещё, конечно, подождать немного, ведь песням нужно какое-то время на запись.

</p><div class="spoiler"><b class="spoiler_title">Полный текст программы</b><div class="spoiler_text"><pre>
from urllib.request import urlopen
import json
import os
os.mkdir('C://Music')

address = 'https://api.vk.com/method/audio.get?owner_id=MY_ID&amp;access_token=MY_TOKEN'
data = urlopen(address)
decoded_response = data.read().decode()
final_data = json.loads(decoded_response)
songs = final_data['response'][1:]
for song in songs:
       song_artist = song['artist']
       song_title = song['title']
       song_url = song['url']
       cached_song = urlopen(song_url).read()
       if song_artist not in os.listdir('C://Music'):
              os.mkdir('C://Music/%s' %(song_artist))
       filename = 'C://Music/%s/%s.mp3' %(song_artist, song_title)
       file = open(filename, 'wb')
       file.write(cached_song)
       file.close()
</pre>
</div></div><p>
Наслаждайтесь музыкой и любите программирование. До связи!
      </p><p class="clear"/>
    </div>

    
  </div></body></html>