<html><body><div><article class="post-content">
  <p>All heard the stories about Smalltalk and LISP apps which worked for
decades and was developed/updated via REPL (or similar), so why don’t
do something similar on microcontroller board?</p>

<p>On pyboard we have a REPL, but we can’t run it and code on pyboard
concurrently, so first of all we need to develop simple REPL with which we can do it.
And for making it more interesting – make this REPL to work through
bluetooth:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pyb</span> <span class="kn">import</span> <span class="n">UART</span>

<span class="n">uart</span> <span class="o">=</span> <span class="n">UART</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">uart</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="mi">115200</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">exec_command</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
    <span class="s">"""Runs command and returns output for REPL."""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">SyntaxError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># For stuff like `a = 10`:</span>
            <span class="k">return</span> <span class="k">exec</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">e</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">e</span>


<span class="k">def</span> <span class="nf">handle_repl</span><span class="p">():</span>
    <span class="s">"""Tries to read command from uart and exec it."""</span>
    <span class="n">command</span> <span class="o">=</span> <span class="n">uart</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">command</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">exec_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">uart</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">'{}</span><span class="se">\n</span><span class="s">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">iteration</span><span class="p">():</span>
    <span class="s">"""Function for overriding."""</span>


<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">handle_repl</span><span class="p">()</span>
    <span class="n">iteration</span><span class="p">()</span>
</code></pre>
</div>

<p>So now we can test it:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>➜ <span class="nb">echo</span> <span class="s2">"1 + 1"</span> &gt; /dev/rfcomm1
➜ head -n 1 /dev/rfcomm1
2
</code></pre>
</div>

<p>It works, so let’s try to override <code class="highlighter-rouge">iteration</code> for sending <code class="highlighter-rouge">Hello World!</code>
on each iteration to us through bluetooth:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>➜ <span class="nb">echo</span> <span class="s2">"globals()['iteration'] = lambda: uart.write('Hello World</span><span class="se">\n</span><span class="s2">')"</span> &gt; /dev/rfcomm1
➜ cat /dev/rfcomm1
Hello World
Hello World
<span class="gp">^C%  </span>
</code></pre>
</div>

<p>Or we can do something more practical – send measurements from
accel sensors:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>➜ <span class="nb">echo</span> <span class="s2">"from pyb import Accel

def _send_accel():
    accel = Accel()
    xyz = accel.filtered_xyz()
    uart.write('{}</span><span class="se">\n</span><span class="s2">'.format(xyz))
    
globals()['iteration'] = _send_accel"</span> &gt; /dev/rfcomm1
➜ cat /dev/rfcomm1    
<span class="o">(</span>9, -6, 90<span class="o">)</span>
<span class="o">(</span>7, -4, 91<span class="o">)</span>
<span class="o">(</span>6, -5, 91<span class="o">)</span>
<span class="o">(</span>5, -4, 92<span class="o">)</span>
^C%
</code></pre>
</div>

<p>That’s not all, we can also modify the way that REPL works,
for example – display all REPL commands/results on
little screen (<a href="https://gist.github.com/nvbn/ef690c341dcea667ec8b">ssd1306 module</a>):</p>

<div class="highlighter-rouge"><pre class="highlight"><code>➜ <span class="nb">echo</span> <span class="s2">"from ssd1306 import Display

display = Display(pinout={'sda': 'Y10',
                          'scl': 'Y9'},
                  height=64,
                  external_vcc=False)

orig = exec_command

def wrapper(command):
    display.write('&gt;&gt;&gt; {}'.format(command))
    result = orig(command)
    if result is not None:
        display.write('{}</span><span class="se">\n</span><span class="s2">'.format(result))
    return result

globals()['exec_command'] = wrapper"</span> &gt; /dev/rfcomm1
➜ <span class="nb">echo</span> <span class="s2">"a = 1"</span> &gt; /dev/rfcomm1
➜ <span class="nb">echo</span> <span class="s2">"b = 2"</span> &gt; /dev/rfcomm1
➜ <span class="nb">echo</span> <span class="s2">"a + b"</span> &gt; /dev/rfcomm1
➜ <span class="nb">echo</span> <span class="s2">"[x ** 2 for x in range(a + b)]"</span> &gt; /dev/rfcomm1 
</code></pre>
</div>

<p>And it works:</p>

<p><img src="/assets/pyboard_bt_repl.jpg" alt="photo"/></p>

<p>So it’s cool and maybe can be useful for developing/updating some
hard-to-reach devices.</p>

</article>


</div></body></html>