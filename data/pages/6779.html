<html><body><div><div class="wall_post_text"><a href="/feed?section=search&amp;q=%23python">#python</a> <a href="/feed?section=search&amp;q=%23pynsk">#pynsk</a><p>Таинство стандартной библиотеки: слабые ссылки - weakref</p><p>Python имеет автоматическое управление памятью: подсчёт ссылок для большинства объектов и сборка мусора для удаления циклов. Память освобождается сразу после того, как была удалена последняя ссылка на объект.</p><p>Этот подход отлично работает для большинства приложений, но иногда возникает необходимость вести учёт объектов только когда они используются где-нибудь ещё. К сожалению, само слежение за объектами уже создает ссылку и тем самым объекты остаются в памяти. Модуль weakref (от англ. weak reference - слабая ссылка) даёт средство для учёта объектов без создания ссылок на них. Когда объект больше не нужен, он автоматически удаляется из таблицы слабых ссылок и производится обратный вызов weakref-объектов. Типичное применение модуля - кэширование объектов, которые затратно воспроизвести снова.</p><p>»&gt; import weakref, gc</p><p>»&gt; class A:</p><p>...     def __init__(self, value):</p><p>...             self.value = value</p><p>...     def __repr__(self):</p><p>...             return str(self.value)</p><p>...</p><p>»&gt; a = A(10)                   # создаёт ссылку</p><p>»&gt; d = weakref.WeakValueDictionary()  # словарь, использующий слабые ссылки</p><p>»&gt; d['primary'] = a            # не создаёт ссылки</p><p>»&gt; d['primary']                # достать объект, если он все ещё "жив"</p><p>10</p><p>»&gt; del a                       # удалить одну ссылку</p><p>»&gt; gc.collect()                # произвести сборку мусора</p><p>0</p><p>»&gt; d['primary']                # запись была автоматически удалена</p><p>Traceback (most recent call last):</p><p>...File "&lt;stdin&gt;", line 1, in &lt;module&gt;</p><p>....d['primary']</p><p>...File "C:/python31/lib/</p><a href="/away.php?to=http%3A%2F%2Fweakref.py&amp;post=-96469126_411" target="_blank">weakref.py</a><p>", line 46, in __getitem__</p><p>....o = self.data[key]()</p><p>KeyError: 'primary'</p><p>Ссылки на тему:</p><a href="/away.php?to=https%3A%2F%2Fdocs.python.org%2F3%2Flibrary%2Fweakref.html&amp;post=-96469126_411" target="_blank">https://docs.python.org/3/library/weakref.html</a><a href="/away.php?to=http%3A%2F%2Fpep8.ru%2Fdoc%2Ftutorial-3.1%2F11.html&amp;post=-96469126_411" target="_blank">http://pep8.ru/doc/tutorial-3.1/11.html</a><a href="/away.php?to=http%3A%2F%2Fwww.ilnurgi1.ru%2Fdocs%2Fpython%2Fmodules%2Fweakref.html&amp;post=-96469126_411" target="_blank">http://www.ilnurgi1.ru/docs/python/modules/weakref.html</a></div></div></body></html>