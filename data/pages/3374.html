<html><body><div><div class="content html_format"><p>
      Мотивированный </p><a href="http://habrahabr.ru/post/172043/">статьей</a><p> пользователя  </p><a href="http://habrahabr.ru/users/bubavv/" class="user_link">BubaVV</a><p> про предсказание веса модели Playboy по ее формам и росту, автор решил углубиться </p><s>if you know what I mean</s><p> в эту будоражащую кровь тему исследования и в тех же данных найти выбросы, то есть </p><s>особо сисястые</s><p> модели, выделяющиеся на фоне других своими формами, ростом или весом. А на фоне этой разминки чувства юмора заодно немного рассказать начинающим исследователям данных про обнаружение выбросов (outlier detection) и аномалий (anomaly detection) в данных с помощью реализации одноклассовой машины опорных векторов (One-class Support Vector Machine) в библиотеке Scikit-learn, написанной на языке Python. 
</p><a name="habracut"/>
<h3>Загрузка и первичный анализ данных</h3><p>
Итак, по-честному сославшись на </p><a href="http://www.wired.com/special_multimedia/2009/st_infoporn_1702">первоисточник</a><p> данных и человека, который над ними поработал, откроем CSV-файл с данными </p><a href="https://yadi.sk/d/FCGEKxaKeqDrS">girls.csv</a><p> и посмотрим, что там есть. Видим параметры 604-х девушек месяца Playboy с декабря 1953 по январь 2009: обхват груди (Bust, в см), обхват талии (Waist, в см), обхват бедер (Hips, в см), а также рост (Height, в см.) и вес (Weight, в кг).
</p><p>
Откроем нашу любимую среду программирования для Python (в моем случае Eclipse + PyDev) и загрузим данные с помощью библиотеки Pandas. В этой статье предполагается, что библиотеки Pandas, NumPy, SciPy, sklearn и matplotlib установлены. Если нет, пользователи Windows могут порадоваться и элементарно установить прекомпилированные библиотеки </p><a href="http://www.lfd.uci.edu/~gohlke/pythonlibs/">отсюда</a><p>. </p><p>
Ну а пользователям никсов и маков (как и автору) придется чуть-чуть помучаться, но статья не об этом.
</p><p>
Вначале импортируем модули, которые нам понадобятся. Об их роли будем говорить по мере поступления. 

</p><pre><code class="python">import pandas
import numpy as np
import matplotlib.pyplot as plt
import matplotlib.font_manager
from scipy import stats
from sklearn.preprocessing import scale
from sklearn import svm
from sklearn.decomposition import PCA
</code></pre><p>
Создаем экземпляр </p><i>girls</i><p> структуры данных DataFrame модуля Pandas считыванием данных из файла </p><i>girls.csv</i><p> (он лежит рядом с данным py-файлом, иначе надо указывать полный путь). Параметр </p><i>header</i><p> говорит, что названия признаков находятся в первой строке (т.е. в нулевой, если считать, как программисты). 

</p><pre><code class="python">girls = pandas.read_csv('girls.csv', header=0)
</code></pre><p>
Кстати, Pandas — отличный вариант для тех, кто привык к питону, но все еще любит быстроту парсинга данных в R. Главное, что унаследовал Pandas от R — это как раз удобную структуру данных DataFrame. </p><p>
Автор знакомился с Pandas по </p><a href="http://www.kaggle.com/c/titanic-gettingStarted/details/getting-started-with-python-ii">тьюториалу</a><p> Kaggle в пробном соревновании «Titanic: Machine Learning from Disaster». Для тех, кто не знаком с Kaggle, — отличный повод наконец сделать это. 
</p><p>
Посмотрим общую статистику наших девушек:

</p><pre><code class="python">print  girls.info()
</code></pre><p>
Нам сообщат, что в нашем распоряжении 604 девушки, каждая с 7-ю признаками — Month (тип object), Year (тип int64) и еще 5-ю признаками типа int64, которые мы уже называли.</p><p>
Дальше узнаем про девушек побольше:

</p><pre><code class="python">print  girls.describe()
</code></pre><p>
Эх, если бы в жизни все было так просто! </p><p>
Интерпретатор нам перечислит основные статистические характеристики признаков девушек — среднее, минимальное и максимальное значения. Уже неплохо. Отсюда заключаем, что средние формы модели Playboy 89-60-88 (ожидаемо), средний рост — 168 см, вес — 52 кг. </p><p>
Вот рост то, кажется, маловат. Видимо, объясняется тем, что данные исторические, с середины ХХ века, сейчас-то стандартом у моделей, кажется, считается рост 180 см. </p><p>
Охват груди девушек меняется от 81 до 104 см, талия — от 46 до 89, бедра — от 61 до 99, рост — от 150 см до 188 см, вес — от 42 кг до 68 кг.</p><p>
Ух ты, уже можно подозревать, что в данные вкралась ошибка. Это что за </p><s>пивная бочка</s><p> модель с талией 89 см? А как бедра могут быть 61 см? 
</p><p>
Давайте посмотрим, что это за уникумы:

</p><pre><code class="python">print girls[['Month','Year']][girls['Waist'] == 89]
</code></pre><p>
Это девушки месяца Playboy в декабре 1998-го и январе 2005-го соответственно. Несложно их отыскать </p><a href="http://en.wikipedia.org/wiki/List_of_Playboy_Playmates_of_the_Month">здесь</a><p>. Это тройняшки Николь, Эрика и Жаклин </p><s>с неговорящей фамилей</s><p> Дам (</p><a href="http://en.wikipedia.org/wiki/Nicole,_Erica_and_Jaclyn_Dahm">Dahm</a><p>) — все три «под одним аккаунтом» и Дэстини Дэвис (</p><a href="http://en.wikipedia.org/wiki/List_of_Playboy_Playmates_of_2005#January">Destiny Davis</a><p>). Легко заметить, что талии тройняшек — 25 дюймов (64 см), а не 89, а бедра нашей Дэстини — 86 см, а никак не 61.
</p><p>
Для красоты можно еще построить и гистограммы распределения параметров девушек (для разнообразия они сделаны в R).

</p><img src="https://habrastorage.org/files/d5e/3b4/af7/d5e3b4af71e741eeb393b2f9c6349552.png"/>
<img src="https://habrastorage.org/files/fd6/262/b01/fd6262b019be4c288cfb83702814e6f9.png"/>
<p>
Итак, простым, невооруженным взглядом на данные уже можно найти в них какие-то странности, если, конечно, данных не очень много, и признаки можно как-то трактовать в понятном человеку виде. 

</p><h3>Предобработка данных</h3><p>
Для обучения модели оставим только численные параметры, кроме года. Запишем их в массив NumPy </p><i>girl_params</i><p>, попутно преобразовав к типу float64. Шкалируем данные так, чтобы все признаки лежали в диапазоне от -1 до 1. Это важно для многих алгоритмов маишинного обучения. Не вдаваясь в детали, шкалированием мы избегаем того, что признак получает больший вес только из-за того, что у него больший диапазон изменения. Например, если по признакам «Возраст» и «Доход» считать Евклидово расстояние между людьми, то у дохода вклад в метрику будет намного выше только из-за того, что он измеряется, например, в тысячах, а возраст в десятках.

</p><pre><code class="python">girl_params = np.array(girls.values[:,2:], dtype="float64")
girl_params = scale(girl_params) 
</code></pre><p>
Далее выделяем 2 главных компонента в данных, чтоб их можно было отобразить. Тут нам пригодилась библиотека Scikit-learn Principal Component Analysis (</p><a href="http://scikit-learn.org/stable/modules/decomposition.html#pca">PCA</a><p>). Также нам не помешает сохранить число наших девушек. Кроме того, мы скажем, что ищем 1% выбросов в данных, то есть ограничимся 6-7 «странными» девушками. (Переменные в Питоне, записанные в верхнем регистре, символизируют константы и обычно записываются в начале файла после подключения модулей). 

</p><pre><code class="python">X = PCA(n_components=2).fit_transform(girl_params)
girls_num = X.shape[0]
OUTLIER_FRACTION = 0.01
</code></pre>
<h3>Обучение модели</h3><p>
Для обнаружения «выбросов» в данных используем одноклассовую модель машины опорных векторов. Теоретическую работу над этой вариацией SVM начал Алексей Яковлевич Червоненкис. Как </p><a href="http://shad.yandex.ru/chervonenkis/">заявляет</a><p> «Яндекс», сейчас разработка методов решения этой задачи занимает первое место в развитии теории машинного обучения. </p><p>
Не буду здесь рассказывать, что такое SVM и ядра, про это и так много написано, например </p><a href="http://habrahabr.ru/post/105220/">на Хабре</a><p> (попроще) и </p><a href="http://www.machinelearning.ru/wiki/index.php?title=SVM">на machinelearning.ru</a><p> (посложнее). Отмечу только, что One-class SVM позовляет, как это следует из названия, отличать объекты одного класса. Обнаружение аномалий в данных — всего лишь скромное приложение этой идеи. Сейчас, в эпоху глубинного обучения, с помощью алгоритмов одноклассовой классификации пытаются научить компьютер «создавать представление» предмета, как, например, ребенок отличает собаку от всех остальных предметов. 
</p><p>
Но вернемся к Scikit-реализации One-class SVM, которая неплохо </p><a href="http://scikit-learn.org/stable/modules/generated/sklearn.svm.OneClassSVM.html#sklearn.svm.OneClassSVM">документирована</a><p> на сайте Scikit-learn. </p><p>
Создаем экземпляр классификатора с гауссовым ядром и «скармливаем» ему данные. 

</p><pre><code class="python">clf = svm.OneClassSVM(kernel="rbf")
clf.fit(X)
</code></pre>

<h3>Поиск выбросов</h3><p>
Создаем массив </p><i>dist_to_border</i><p>, который хранит расстояния от объектов обучающей выборки X до построенной разделяющей поверхности, а затем, после того, как мы выбрали порог, создаем массив индикаторов (True или False) того, что объект является представителем данного класса, а не выбросом. При этом расстояние положительно, если объект лежит «внутри» области, ограниченной построенной разделяющей поверхностью (т.е. является представителем класса), и отрицательно в противном случае. Порог определяется статистически, как такое расстояние до разделяющей поверхности, что у OUTLIER_FRACTION (в нашем случае у одного) процента выборки оно больше (т.е в нашем случае, </p><i>threshold</i><p> — это 1%-перцентиль массива расстояний до разделяющей поверхности). 

</p><pre><code class="python">dist_to_border = clf.decision_function(X).ravel()
threshold = stats.scoreatpercentile(dist_to_border,
            100 * OUTLIER_FRACTION)
is_inlier = dist_to_border &gt; threshold
</code></pre>

<h3>Отображение и трактовка результатов</h3><p>
Наконец, визуализируем то что получилось. На этом моменте я не буду останавливаться, разобраться с matplotlib желающие могут самостоятельно. Это переработанный код из </p><a href="http://scikit-learn.org/stable/auto_examples/covariance/plot_outlier_detection.html">примера</a><p> Scikit-learn «Outlier detection with several methods».

</p><pre><code class="python">xx, yy = np.meshgrid(np.linspace(-7, 7, 500), np.linspace(-7, 7, 500))
n_inliers = int((1. - OUTLIER_FRACTION) * girls_num)
n_outliers = int(OUTLIER_FRACTION * girls_num)
Z = clf.decision_function(np.c_[xx.ravel(), yy.ravel()])
Z = Z.reshape(xx.shape)
plt.title("Outlier detection")
plt.contourf(xx, yy, Z, levels=np.linspace(Z.min(), threshold, 7),
                         cmap=plt.cm.Blues_r)
a = plt.contour(xx, yy, Z, levels=[threshold],
                            linewidths=2, colors='red')
plt.contourf(xx, yy, Z, levels=[threshold, Z.max()],
                         colors='orange')
b = plt.scatter(X[is_inlier == 0, 0], X[is_inlier == 0, 1], c='white')
c = plt.scatter(X[is_inlier == 1, 0], X[is_inlier == 1, 1], c='black')
plt.axis('tight')
plt.legend([a.collections[0], b, c],
           ['learned decision function', 'outliers', 'inliers'],
           prop=matplotlib.font_manager.FontProperties(size=11))
plt.xlim((-7, 7))
plt.ylim((-7, 7))
plt.show()
</code></pre>
<p>
Получаем такую картинку:
</p><img src="https://habrastorage.org/files/5bd/f5a/43c/5bdf5a43cb6943e8a8d9db2c0291220a.png"/>
<p>
Видны 7 «выбросов». Чтобы понять, что за девушки таятся под этим нелицеприятным «выбросы», посмотрим их в исходных данных. 

</p><pre><code class="python">print girls[is_inlier == 0]
</code></pre>
<pre><code class="python">         Month  Year  Bust  Waist  Hips  Height  Weight
54   September  1962    91     46    86     152      45
67     October  1963    94     66    94     183      68
79     October  1964   104     64    97     168      66
173  September  1972    98     64    99     185      64
483   December  1998    86     89    86     173      52
507   December  2000    86     66    91     188      61
535      April  2003    86     61    69     173      54
</code></pre><p>
А теперь самая занимательная часть — трактовка полученных выбросов.</p><p>
Замечаем, что экспонатов в нашей кунсткамере всего 7 (мы так удачно задали порог OUTLIER_FRACTION), поэтому можно пройтись по каждому из них.

</p><ol>
<li> <a href="http://www.playboy.com/mickey-winters">Мики Уинтерс</a>. Сентябрь, 1962. 91-46-86, рост 152, вес 45. <br/>
<img src="https://habrastorage.org/files/83a/a2c/0cc/83aa2c0cc8fe4994a33e34ac661bb55e.jpg"/><br/>
Талия 46 — это, конечно, круто! Как у них при этом грудь 91?<br/>
</li>
<li> <a href="http://www.playboy.com/christine-williams">Кристин Уильямс</a>. Октябрь, 1963. 94-66-94, рост 183, вес 68.<br/>
<img src="https://habrastorage.org/files/28e/f0c/32a/28ef0c32aaa548fead478c38275fa701.jpg"/><br/>
Не маленькая девушка для тех лет. Это тебе не Мики Уинтерс.<br/>
</li>
<li> <a href="http://www.playboy.com/rosemarie-hillcrest">Розмари Хилкрест</a>. Октябрь, 1964. 104-64-97, рост 168, вес 66.<br/>
<img src="https://habrastorage.org/files/591/9dc/017/5919dc017e29414589bbb713fef056c8.jpg"/><br/>
<s>Воу-воу, палехче!</s> Внушительная дама. <br/>
</li>
<li> <a href="http://www.playboy.com/susan-miller">Сюзан Миллер</a>. Сентябрь, 1972. 98-64-99, рост 185, вес 64.<br/>
<img src="https://habrastorage.org/files/e82/c9b/83e/e82c9b83e3e148bf8d0a946487a231c6.jpg"/><br/>
</li>
<li> Милашки-тройняшки <a href="http://www.playboy.com/erica-nicole-and-jaclyn-dahm">Дам</a>. 86-89 (реально 64)-86, рост 173, вес 52. <br/>
<img src="https://habrastorage.org/files/b99/917/1fb/b999171fbc194dc68b25dca7a9e9f9f0.jpg"/><br/>
Пример ошибки в данных. Не очень понятно, как им все на троих мерили.<br/>
</li>
<li> <a href="http://www.playboy.com/cara-michelle">Кара Мишель</a>. Декабрь, 2000. 86-66-91, рост 188, вес 61.<br/>
<img src="https://habrastorage.org/files/a8a/fcd/60c/a8afcd60c64c436e9dc39125ec3d5996.jpg"/><br/>
Ростом 188 — выше автора этой статьи. Явный «выброс» для таких «исторических» данных.<br/>
</li>
<li> <a href="http://www.playboy.com/carmella-decesare">Кармелла де Сезаре</a>. Апрель, 2003. 86-61-69, рост 173, вес 54. <br/>
<img src="https://habrastorage.org/files/829/7b8/f13/8297b8f138654342bf5d73fcd6bdc2c6.jpg"/><br/>
Пожалуй, из-за бедер.<br/>
</li>
</ol>
<p>
Примечательно, что дама с охватом бедер в 61 см, которую мы подозревали в сильном отличии от прочих девушек, по остальным параметрам вполне в норме, и SVM-ом не была определена как «выброс».

</p><h3>Заключение</h3><p>
Напоследок отмечу важность первичного анализа данных, «просто глазами» и, конечно, отмечу, что обнаружение аномалий в данных применяется и в более серьезных задачах — в кредитном скоринге, чтоб распознать неблагонадежных клиентов, в системах безопасности для обнаружения потенциальных «узких мест», при анализе банковских транзакций для поиска злоумышленников и не только. Заинтересованный читатель найдет и множество других алгоритмов обнаружения аномалий и выбросов в данных и их применений.

      
      </p><p class="clear"/>
    </div>

    
  </div></body></html>