<html><body><div><div class="outline-text-2" id="text-orgheadline11">
<p>
The Abstract Syntax Tree for such a format is nothing more than a list of opcode.
Parsing just requires making sure the first opcode is a protocol one and should
stop when a stop opcode is met.
</p>

<p>
Generating an AST for the above syntax in clojure turned out to be very simple,
provided we worked with the java <a href="http://docs.oracle.com/javase/7/docs/api/java/nio/ByteBuffer.html">ByteBuffer</a> class.
</p>

<p>
Here's the bulk of the work:
</p>

<div class="org-src-container">

<pre class="src src-clojure"><span>(</span><span>defn</span> <span>raw-&gt;ast</span>
  <span>"Convert binary data into a list of pickle opcodes and data"</span>
  <span>[</span>bb<span>]</span>
  <span>(</span>lazy-seq
   <span>(</span><span>when</span> <span>(</span>pos? <span>(</span><span>.remaining</span> bb<span>)</span><span>)</span>
     <span>(</span><span>let</span> <span>[</span>b    <span>(</span>bit-and 0xff <span>(</span><span>.get</span> bb<span>)</span><span>)</span>
           elem <span>(</span>opcode b bb<span>)</span><span>]</span>
       <span>(</span>cons elem <span>(</span>raw-&gt;ast bb<span>)</span><span>)</span><span>)</span><span>)</span><span>)</span><span>)</span>
</pre>
</div>

<p>
A seq is built by fetching a byte and sending it to an <code>opcode</code> function,
along with the rest of the buffer.
</p>

<p>
The <code>opcode</code> function is best built as a <code>multimethod</code> which dispatches on the
opcode: <code>(defmulti opcode (fn [b _] (bit-or b 0x00)))</code>, methods can then be
implemented simply, for instance here are append and int parsing:
</p>

<div class="org-src-container">

<pre class="src src-clojure"><span>(</span><span>defmethod</span> <span>opcode</span> 0x4a
  <span>[</span>_ bb<span>]</span>
  <span>{</span><span>:type</span> <span>:int</span> <span>:val</span> <span>(</span><span>.getInt</span> bb<span>)</span><span>}</span><span>)</span>

<span>(</span><span>defmethod</span> <span>opcode</span> 0x65
  <span>[</span>_ bb<span>]</span>
  <span>{</span><span>:type</span> <span>:append</span><span>}</span><span>)</span>
</pre>
</div>

<p>
With this, we end up with an AST of the following form. It's now much easier
to write functions that parse this AST and extract 
</p>

<div class="org-src-container">

<pre class="src src-clojure"><span>(</span><span>{</span><span>:type</span> <span>:protocol</span>, <span>:version</span> 3<span>}</span>
 <span>{</span><span>:type</span> <span>:startlist</span><span>}</span>
 <span>{</span><span>:type</span> <span>:binput</span>, <span>:index</span> 0<span>}</span>
 <span>{</span><span>:type</span> <span>:mark</span><span>}</span>
 <span>{</span><span>:type</span> <span>:startlist</span><span>}</span>
 <span>{</span><span>:type</span> <span>:binput</span>, <span>:index</span> 1<span>}</span>
 <span>{</span><span>:type</span> <span>:mark</span><span>}</span>
 <span>{</span><span>:type</span> <span>:unicode</span>, <span>:size</span> 14, <span>:val</span> <span>"web1.cpu0.user"</span><span>}</span>
 <span>{</span><span>:type</span> <span>:binput</span>, <span>:index</span> 2<span>}</span>
 <span>{</span><span>:type</span> <span>:startlist</span><span>}</span>
 <span>{</span><span>:type</span> <span>:binput</span>, <span>:index</span> 3<span>}</span>
 <span>{</span><span>:type</span> <span>:mark</span><span>}</span>
 <span>{</span><span>:type</span> <span>:int</span>, <span>:val</span> 1332444075<span>}</span>
 <span>{</span><span>:type</span> <span>:double</span>, <span>:val</span> 10.5<span>}</span>
 <span>{</span><span>:type</span> <span>:append</span><span>}</span>
 <span>{</span><span>:type</span> <span>:append</span><span>}</span>
 <span>{</span><span>:type</span> <span>:startlist</span><span>}</span>
 <span>{</span><span>:type</span> <span>:binput</span>, <span>:index</span> 4<span>}</span>
 <span>{</span><span>:type</span> <span>:mark</span><span>}</span>
 <span>{</span><span>:type</span> <span>:unicode</span>, <span>:size</span> 14, <span>:val</span> <span>"web1.cpu1.user"</span><span>}</span>
 <span>{</span><span>:type</span> <span>:binput</span>, <span>:index</span> 5<span>}</span>
 <span>{</span><span>:type</span> <span>:startlist</span><span>}</span>
 <span>{</span><span>:type</span> <span>:binput</span>, <span>:index</span> 6<span>}</span>
 <span>{</span><span>:type</span> <span>:mark</span><span>}</span>
 <span>{</span><span>:type</span> <span>:int</span>, <span>:val</span> 1332444076<span>}</span>
 <span>{</span><span>:type</span> <span>:double</span>, <span>:val</span> 90.3<span>}</span>
 <span>{</span><span>:type</span> <span>:append</span><span>}</span>
 <span>{</span><span>:type</span> <span>:append</span><span>}</span>
 <span>{</span><span>:type</span> <span>:append</span><span>}</span>
 <span>{</span><span>:type</span> <span>:stop</span><span>}</span><span>)</span>
</pre>
</div>
</div>
</div></body></html>