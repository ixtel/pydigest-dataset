<html><body><div><div class="entry-content">
        
      <h1 class="post-title entry-title">Python for Android Tutorial #5 – Our first Mobile Game with Kivy!!</h1>
      <h3 id="welcome">Welcome!</h3>

<p>This is the fifth post about mobile development with Python.</p>

<p>In this  post, we’ll code our first mobile game with Kivy! Android and iOS game development with Python?? Wow! Really nice, hum? So, let’s check this out!</p>

<figure class="center ">
  <a href="/images/python-mobile.png"><img src="/images/python-mobile.png" alt=""/></a>
  <figcaption>Python Mobile course</figcaption>
</figure>




<p><ins class="adsbygoogle" data-ad-client="ca-pub-7559770887681599" data-ad-slot="6312284669" data-ad-format="auto"/>
</p>

<h2 id="i---about-the-tutorials">I - About the Tutorials</h2>

<p>I’ll show you how to use each mobile API, like compass, camera, sensors, sound, and others. After the API, we will start to test some Python libs, as PyGame and OpenCV.
I’m using Android with buildozer, but major part are compatible with iOS as well.</p>

<p>Must read:</p>



<h3 id="source-code">Source code</h3>



<h2 id="ii---index">II - Index</h2>

<p>Available tutorials:</p>



<h2 id="iii---about-this-tutorial">III - About this tutorial</h2>

<p>This is a big post, to work in this game, we are going to learn and use a lot of Kivy.</p>

<p>But don’t worry, I’ll be writing around more five posts related to this one, explaining more about each component used in this game, like how to save scores, how to monetize your Kivy app, how to work with multiple scenes and more.</p>

<p>You can download and test our app here:</p>

<figure class="center ">
  <a href="https://play.google.com/store/apps/details?id=com.aronbordin.game.fastperception"><img src="/images/fast_perception.png" alt=""/></a>
</figure>

<p>This is a simple game. You’ll see a grid in the screen, and some buttons will blink some times.
Then it’ll stop to blink and you need to remember what was the last block to blink.</p>

<p>It’s a simple and nice example to help you learn more about Kivy. So, let’s start right now!</p>



<p>Just I’d like to thanks <a href="http://opengameart.org/">http://opengameart.org/</a> , I’m not a designer, and in this kind of project, this website can be very useful :).</p>

<p>I used these links to this game:</p>



<p>I edited these files with Gimp and Inkscape, if you want to edit something, open the <strong>design</strong> folder and get the files.</p>

<h2 id="v---create-your-project">V - Create your project</h2>

<p>Go to a folder and add two files, <strong>main.py</strong> and <strong>main.kv</strong>.</p>

<p>Now, run:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">buildozer init</code></pre></figure>

<p>to configure buildozer.</p>

<h2 id="vi---game-interface">VI - Game interface</h2>

<p>The game is divided in two screens, the menu and the game screen.</p>

<h3 id="menu">Menu:</h3>

<figure class="center ">
  <a href="/images/menu_ids.png"><img src="/images/menu_ids.png" alt=""/></a>
  <figcaption>Menu Widget Ids</figcaption>
</figure>

<p>You can check the id of each widget with the yellow color. The game interface was created with kv. In your <strong>main.kv</strong> file, add the following code:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">&lt;</span><span class="n">MenuScreen</span><span class="o">&gt;</span><span class="p">:</span>
    <span class="n">Image</span><span class="p">:</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">background</span>
        <span class="n">source</span><span class="p">:</span> <span class="s">"res/background.png"</span>
        <span class="n">allow_stretch</span><span class="p">:</span> <span class="bp">True</span> <span class="c">#image in fullscreen</span>
        <span class="n">keep_ratio</span><span class="p">:</span> <span class="bp">False</span> <span class="c">#image in fullscreen</span>
    <span class="n">Image</span><span class="p">:</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">title</span>
        <span class="n">source</span><span class="p">:</span> <span class="s">"res/title.png"</span>
        <span class="n">pos_hint</span><span class="p">:</span> <span class="p">{</span><span class="s">'top'</span><span class="p">:</span> <span class="mf">1.3</span><span class="p">}</span>

    <span class="n">Label</span><span class="p">:</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">label_best</span>
        <span class="n">text</span><span class="p">:</span> <span class="s">'Best score: 1'</span>
        <span class="n">font_size</span><span class="p">:</span> <span class="s">'27sp'</span>
        <span class="n">pos_hint</span><span class="p">:</span> <span class="p">{</span><span class="s">'x'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">'y'</span><span class="p">:</span><span class="mf">0.15</span><span class="p">}</span>

    <span class="n">ImageButton</span><span class="p">:</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">new_game</span>
        <span class="n">source</span><span class="p">:</span> <span class="s">"res/new_game.png"</span>
        <span class="n">on_press</span><span class="p">:</span> <span class="n">root</span><span class="o">.</span><span class="n">new_game</span><span class="p">()</span>
        <span class="n">size_hint</span><span class="p">:</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.15</span>
        <span class="n">pos_hint</span><span class="p">:</span> <span class="p">{</span><span class="s">'x'</span><span class="p">:</span> <span class="o">.</span><span class="mi">2</span><span class="p">,</span> <span class="s">'y'</span><span class="p">:</span> <span class="o">.</span><span class="mi">4</span><span class="p">}</span>
        <span class="n">allow_stretch</span><span class="p">:</span> <span class="bp">True</span> <span class="c">#image full the button</span>
        <span class="n">keep_ratio</span><span class="p">:</span> <span class="bp">False</span> <span class="c">#image full the button</span>

    <span class="n">ImageButton</span><span class="p">:</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">share</span>
        <span class="n">source</span><span class="p">:</span> <span class="s">"res/share.png"</span>
        <span class="n">on_press</span><span class="p">:</span> <span class="n">root</span><span class="o">.</span><span class="n">share</span><span class="p">()</span>
        <span class="n">size_hint</span><span class="p">:</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.15</span>
        <span class="n">pos_hint</span><span class="p">:</span> <span class="p">{</span><span class="s">'x'</span><span class="p">:</span> <span class="o">.</span><span class="mi">2</span><span class="p">,</span> <span class="s">'y'</span><span class="p">:</span> <span class="o">.</span><span class="mi">25</span><span class="p">}</span>
        <span class="n">allow_stretch</span><span class="p">:</span> <span class="bp">True</span> <span class="c">#image full the button</span>
        <span class="n">keep_ratio</span><span class="p">:</span> <span class="bp">False</span> <span class="c">#image full the button</span>

    <span class="n">ImageButton</span><span class="p">:</span>
        <span class="nb">id</span><span class="p">:</span> <span class="nb">exit</span>
        <span class="n">source</span><span class="p">:</span> <span class="s">"res/exit.png"</span>
        <span class="n">on_press</span><span class="p">:</span> <span class="n">root</span><span class="o">.</span><span class="nb">exit</span><span class="p">()</span>
        <span class="n">size_hint</span><span class="p">:</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.15</span>
        <span class="n">pos_hint</span><span class="p">:</span> <span class="p">{</span><span class="s">'x'</span><span class="p">:</span> <span class="o">.</span><span class="mi">2</span><span class="p">,</span> <span class="s">'y'</span><span class="p">:</span> <span class="o">.</span><span class="mi">1</span><span class="p">}</span>
        <span class="n">allow_stretch</span><span class="p">:</span> <span class="bp">True</span> <span class="c">#image full the button</span>
        <span class="n">keep_ratio</span><span class="p">:</span> <span class="bp">False</span> <span class="c">#image full the button  </span></code></pre></figure>

<p>In this source, we used <strong>allow_stretch: True</strong> and  <strong>keep_ratio: False</strong> so the image can fit the parent widget.
The background fits the layout and the ImageButton fits the Button.</p>

<p>We use <strong>pos_hint: {‘x’: value, ‘y’:value}</strong> to place our widget in the screen.</p>

<p>The <strong>size_hint: 0.6, 0.15</strong> resize the width to 60% of the parent and height to 15%.</p>

<h3 id="game"><strong>Game:</strong></h3>

<figure class="center ">
  <a href="/images/game_scene.png"><img src="/images/game_scene.png" alt=""/></a>
</figure>

<p>You can check the id of each widget with the yellow color. The game interface was created with kv. In your <strong>main.kv</strong> file, add the following code:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">&lt;</span><span class="n">GameScreen</span><span class="o">&gt;</span><span class="p">:</span>
	<span class="n">Image</span><span class="p">:</span>
			<span class="n">source</span><span class="p">:</span> <span class="s">"res/background.png"</span>
			<span class="n">allow_stretch</span><span class="p">:</span> <span class="bp">True</span> <span class="c">#image in fullscreen</span>
			<span class="n">keep_ratio</span><span class="p">:</span> <span class="bp">False</span> <span class="c">#image in fullscreen</span>

	<span class="n">Label</span><span class="p">:</span>
			<span class="nb">id</span><span class="p">:</span> <span class="n">label_level</span>
			<span class="n">font_size</span><span class="p">:</span> <span class="s">'25sp'</span>
			<span class="n">pos_hint</span><span class="p">:</span> <span class="p">{</span><span class="s">'x'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">'y'</span><span class="p">:</span><span class="mf">0.45</span><span class="p">}</span>
	<span class="n">Label</span><span class="p">:</span>
			<span class="nb">id</span><span class="p">:</span> <span class="n">label_last_block</span>
			<span class="n">text</span><span class="p">:</span> <span class="s">''</span>
			<span class="n">font_size</span><span class="p">:</span> <span class="s">'20sp'</span>
			<span class="n">pos_hint</span><span class="p">:</span> <span class="p">{</span><span class="s">'x'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">'y'</span><span class="p">:</span><span class="mf">0.35</span><span class="p">}</span>
	<span class="n">Label</span><span class="p">:</span>
			<span class="nb">id</span><span class="p">:</span> <span class="n">label_best</span>
			<span class="n">font_size</span><span class="p">:</span> <span class="s">'20sp'</span>
			<span class="n">pos_hint</span><span class="p">:</span> <span class="p">{</span><span class="s">'x'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">'y'</span><span class="p">:</span><span class="o">-</span><span class="mf">0.4</span><span class="p">}</span>

	<span class="n">ImageButton</span><span class="p">:</span>
			<span class="nb">id</span><span class="p">:</span> <span class="n">back_menu</span>
			<span class="n">pos_hint</span><span class="p">:</span> <span class="p">{</span><span class="s">'x'</span><span class="p">:</span> <span class="o">.</span><span class="mi">75</span><span class="p">,</span> <span class="s">'y'</span><span class="p">:</span> <span class="o">.</span><span class="mi">9</span><span class="p">}</span>
			<span class="n">source</span><span class="p">:</span> <span class="s">"res/menu.png"</span>
			<span class="n">size_hint</span><span class="p">:</span> <span class="o">.</span><span class="mi">23</span><span class="p">,</span> <span class="o">.</span><span class="mi">08</span>
			<span class="n">allow_stretch</span><span class="p">:</span> <span class="bp">True</span> <span class="c">#image in fullscreen</span>
			<span class="n">keep_ratio</span><span class="p">:</span> <span class="bp">False</span> <span class="c">#image in fullscreen</span>
			<span class="n">on_press</span><span class="p">:</span> <span class="n">root</span><span class="o">.</span><span class="n">go_menu</span><span class="p">()</span>

	<span class="n">ImageButton</span><span class="p">:</span>
			<span class="nb">id</span><span class="p">:</span> <span class="n">restart</span>
			<span class="n">source</span><span class="p">:</span> <span class="s">"res/restart.png"</span>
			<span class="n">size_hint</span><span class="p">:</span> <span class="o">.</span><span class="mi">23</span><span class="p">,</span> <span class="o">.</span><span class="mi">08</span>
			<span class="n">allow_stretch</span><span class="p">:</span> <span class="bp">True</span> <span class="c">#image in fullscreen</span>
			<span class="n">keep_ratio</span><span class="p">:</span> <span class="bp">False</span> <span class="c">#image in fullscreen</span>
			<span class="n">on_press</span><span class="p">:</span> <span class="n">root</span><span class="o">.</span><span class="n">restart</span><span class="p">()</span>
	<span class="n">GridLayout</span><span class="p">:</span>
			<span class="nb">id</span><span class="p">:</span> <span class="n">game_grid</span>
			<span class="n">cols</span><span class="p">:</span> <span class="mi">2</span>
			<span class="n">rows</span><span class="p">:</span> <span class="mi">2</span>
			<span class="n">size_hint</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span> <span class="n">root</span><span class="o">.</span><span class="n">width</span><span class="o">*</span><span class="mf">0.9</span><span class="o">/</span><span class="n">root</span><span class="o">.</span><span class="n">height</span>
			<span class="n">pos_hint</span><span class="p">:</span> <span class="p">{</span><span class="s">'x'</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span> <span class="s">'y'</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">root</span><span class="o">.</span><span class="n">width</span><span class="o">*</span><span class="mf">0.9</span><span class="o">/</span><span class="n">root</span><span class="o">.</span><span class="n">height</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">}</span></code></pre></figure>

<p>Now, the game grid is empty. We’ll fill it with the Python code.</p>

<h2 id="vii---game-code">VII - Game code</h2>

<p>Now, we can code it.</p>

<p>As I told you, this is a big post and we have a lot of important thing in this code.</p>

<p>So I’ll create more posts to explain each component. I’ll post about sounds, files, how to monetize the app and how to manage multiple scenes.</p>

<p>From now, I commented everything possible in this code, so I hope that is easy to understand. If you have any question, feel free to ask here :)</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># Some resource that helped a lot :)</span>
<span class="c"># http://opengameart.org/content/fantasy-ui-button</span>
<span class="c"># http://opengameart.org/content/ui-button</span>
<span class="c"># http://opengameart.org/content/brick-wall</span>
<span class="c"># http://opengameart.org/content/menu-loop</span>

<span class="kn">from</span> <span class="nn">kivy.utils</span> <span class="kn">import</span> <span class="n">platform</span>
<span class="kn">from</span> <span class="nn">kivy.app</span> <span class="kn">import</span> <span class="n">App</span>
<span class="kn">from</span> <span class="nn">kivy.uix.floatlayout</span> <span class="kn">import</span> <span class="n">FloatLayout</span>
<span class="kn">from</span> <span class="nn">kivy.core.audio</span> <span class="kn">import</span> <span class="n">SoundLoader</span>
<span class="kn">from</span> <span class="nn">kivy.uix.behaviors</span> <span class="kn">import</span> <span class="n">ButtonBehavior</span>
<span class="kn">from</span> <span class="nn">kivy.uix.image</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">kivy.properties</span> <span class="kn">import</span> <span class="n">ObjectProperty</span>
<span class="kn">from</span> <span class="nn">kivy.lang</span> <span class="kn">import</span> <span class="n">Builder</span>
<span class="kn">from</span> <span class="nn">kivy.clock</span> <span class="kn">import</span> <span class="n">Clock</span> <span class="c">#clock to schedule the game update</span>
<span class="kn">from</span> <span class="nn">kivy.storage.jsonstore</span> <span class="kn">import</span> <span class="n">JsonStore</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="k">if</span> <span class="n">platform</span><span class="p">()</span> <span class="o">==</span> <span class="s">"android"</span><span class="p">:</span>
	<span class="kn">from</span> <span class="nn">jnius</span> <span class="kn">import</span> <span class="n">cast</span>
	<span class="kn">from</span> <span class="nn">jnius</span> <span class="kn">import</span> <span class="n">autoclass</span>
	<span class="kn">from</span> <span class="nn">revmob</span> <span class="kn">import</span> <span class="n">RevMob</span> <span class="k">as</span> <span class="n">revmob</span>


<span class="c">#here we create a custom class called ImageButton. It's a image, however with</span>
<span class="c"># some button properties. We use this class to use the on_press event</span>
<span class="k">class</span> <span class="nc">ImageButton</span><span class="p">(</span><span class="n">ButtonBehavior</span><span class="p">,</span> <span class="n">Image</span><span class="p">):</span>
	<span class="k">pass</span>

<span class="c"># This is the App screen, all game scenes(menu and the game) extends this object</span>
<span class="k">class</span> <span class="nc">AppScreen</span><span class="p">(</span><span class="n">FloatLayout</span><span class="p">):</span>
	<span class="c"># MainApp referece, so we can call some functions provided by this object</span>
	 <span class="n">app</span> <span class="o">=</span> <span class="n">ObjectProperty</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>

<span class="c"># This is our menu screen.</span>
<span class="k">class</span> <span class="nc">MenuScreen</span><span class="p">(</span><span class="n">AppScreen</span><span class="p">):</span>
	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span> <span class="c">#init the object, receiving the MainApp instance</span>
			<span class="nb">super</span><span class="p">(</span><span class="n">MenuScreen</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span> <span class="c"># get the MainApp reference</span>

	<span class="c"># switch to the GameScreen</span>
	<span class="k">def</span> <span class="nf">new_game</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">open_screen</span><span class="p">(</span><span class="s">'game'</span><span class="p">)</span>

	<span class="c"># just close our application</span>
	<span class="k">def</span> <span class="nf">exit_game</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
			<span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

	<span class="c"># App share with Android</span>
	<span class="c"># It will open an intent to share a message</span>
	<span class="k">def</span> <span class="nf">share</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">platform</span><span class="p">()</span> <span class="o">==</span> <span class="s">'android'</span><span class="p">:</span> <span class="c">#check if the app is on Android</span>
					<span class="c"># read more here: http://developer.android.com/training/sharing/send.html</span>
					<span class="n">PythonActivity</span> <span class="o">=</span> <span class="n">autoclass</span><span class="p">(</span><span class="s">'org.renpy.android.PythonActivity'</span><span class="p">)</span> <span class="c">#request the activity instance</span>
					<span class="n">Intent</span> <span class="o">=</span> <span class="n">autoclass</span><span class="p">(</span><span class="s">'android.content.Intent'</span><span class="p">)</span> <span class="c"># get the Android Intend class</span>

					<span class="n">String</span> <span class="o">=</span> <span class="n">autoclass</span><span class="p">(</span><span class="s">'java.lang.String'</span><span class="p">)</span> <span class="c"># get the Java object</span>

					<span class="n">intent</span> <span class="o">=</span> <span class="n">Intent</span><span class="p">()</span> <span class="c"># create a new Android Intent</span>
					<span class="n">intent</span><span class="o">.</span><span class="n">setAction</span><span class="p">(</span><span class="n">Intent</span><span class="o">.</span><span class="n">ACTION_SEND</span><span class="p">)</span> <span class="c">#set the action</span>
					<span class="c"># to send a message, it need to be a Java char array. So we use the cast to convert and Java String to a Java Char array</span>
					<span class="n">intent</span><span class="o">.</span><span class="n">putExtra</span><span class="p">(</span><span class="n">Intent</span><span class="o">.</span><span class="n">EXTRA_SUBJECT</span><span class="p">,</span> <span class="n">cast</span><span class="p">(</span><span class="s">'java.lang.CharSequence'</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="s">'Fast Perception'</span><span class="p">)))</span>
					<span class="n">intent</span><span class="o">.</span><span class="n">putExtra</span><span class="p">(</span><span class="n">Intent</span><span class="o">.</span><span class="n">EXTRA_TEXT</span><span class="p">,</span> <span class="n">cast</span><span class="p">(</span><span class="s">'java.lang.CharSequence'</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="s">'Wow, I just scored </span><span class="si">%</span><span class="s">d on Fast Perception. Check this game: https://play.google.com/store/apps/details?id=com.aronbordin.fastperception'</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_score</span><span class="p">))))</span>

					<span class="n">intent</span><span class="o">.</span><span class="n">setType</span><span class="p">(</span><span class="s">'text/plain'</span><span class="p">)</span> <span class="c">#text message</span>

					<span class="n">currentActivity</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s">'android.app.Activity'</span><span class="p">,</span> <span class="n">PythonActivity</span><span class="o">.</span><span class="n">mActivity</span><span class="p">)</span>
					<span class="n">currentActivity</span><span class="o">.</span><span class="n">startActivity</span><span class="p">(</span><span class="n">intent</span><span class="p">)</span> <span class="c"># show the intent in the game activity</span>

	<span class="c"># will be called when our screen be displayed</span>
	<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">best_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'score'</span><span class="p">)[</span><span class="s">'best'</span><span class="p">]</span> <span class="c"># get the best score saved</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="o">.</span><span class="n">label_best</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">'Best score: '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_score</span><span class="p">)</span> <span class="c">#show it</span>
			<span class="k">if</span> <span class="n">platform</span><span class="p">()</span> <span class="o">==</span> <span class="s">'android'</span><span class="p">:</span> <span class="c"># if we are using android, we can show an ADs</span>
					<span class="k">if</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span> <span class="c"># get a random and show a ads in the menu</span>
							<span class="n">revmob</span><span class="o">.</span><span class="n">show_popup</span><span class="p">()</span>

<span class="c">#Our game screen, where everything happens :)</span>
<span class="k">class</span> <span class="nc">GameScreen</span><span class="p">(</span><span class="n">AppScreen</span><span class="p">):</span>
	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span> <span class="c">#init the object, receiving the MainApp instance</span>
			<span class="nb">super</span><span class="p">(</span><span class="n">GameScreen</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

	<span class="c">#initialize defaults values to start a new game</span>
	<span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="mi">1</span> <span class="c"># the current level</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">best_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'score'</span><span class="p">)[</span><span class="s">'best'</span><span class="p">]</span> <span class="c"># best level</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">game_grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="o">.</span><span class="n">game_grid</span> <span class="c"># the game grid widget instance</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">label_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="o">.</span><span class="n">label_level</span> <span class="c"># the label widget to show the current level</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span> <span class="o">=</span> <span class="mi">2</span> <span class="c">#we are using a grid layout to show our blocks, the fist level has a 2x2 grid</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">last_id</span> <span class="o">=</span> <span class="bp">None</span> <span class="c">#last btn blinked</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">remain_interaction</span> <span class="o">=</span> <span class="mi">4</span> <span class="c"># number of blinks before turn off</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">can_click</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># if the user can choose a block. Only true while not blinking</span>

	<span class="c"># called when the game scene be displayed</span>
	<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">start_game</span><span class="p">()</span>

	<span class="c"># start a new game round</span>
	<span class="k">def</span> <span class="nf">start_game</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">can_click</span> <span class="o">=</span> <span class="bp">False</span> <span class="c">#while playing, user cannot choose a block</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="o">.</span><span class="n">label_last_block</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">""</span> <span class="c"># clear the id of last blinked block</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">check_best</span><span class="p">()</span> <span class="c">#check if user has a new highscore</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="o">.</span><span class="n">label_best</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">'Best level: '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_level</span><span class="p">)</span> <span class="c"># show the best score in the screen</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="o">.</span><span class="n">restart</span><span class="o">.</span><span class="n">pos_hint</span> <span class="o">=</span> <span class="p">{</span><span class="s">'x'</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s">'y'</span><span class="p">:</span> <span class="mf">0.025</span><span class="p">}</span> <span class="c">#hide the restart button</span>
			<span class="n">Clock</span><span class="o">.</span><span class="n">unschedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">)</span> <span class="c"># stop updating the game screen</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">label_level</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">'Level: '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">)</span> <span class="c">#show the current level</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">remain_interaction</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="c">#generate a random number of interactions</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">draw_screen</span><span class="p">()</span> <span class="c">#show the blocks in the screen</span>

			<span class="c"># here we set the speed of the animation</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
					<span class="n">interval</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">*</span><span class="mf">0.1</span>
			<span class="k">else</span><span class="p">:</span>
					<span class="n">interval</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">*</span><span class="mf">0.001</span>

			<span class="c">#update the screen using the interval calculated above</span>
			<span class="n">Clock</span><span class="o">.</span><span class="n">schedule_interval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span>

	<span class="c">#each update a different block will blink</span>
	<span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
			<span class="c"># when last_id is not none there is a green block in the screen</span>
			<span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">game_grid</span><span class="o">.</span><span class="n">ids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_id</span><span class="p">)</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="s">"res/block.png"</span> <span class="c">#turn off the block</span>

			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remain_interaction</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c">#if executed all interactions</span>
					<span class="n">Clock</span><span class="o">.</span><span class="n">unschedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">)</span> <span class="c">#stop updating the screen</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="o">.</span><span class="n">label_last_block</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">'Click in the last block that blinked'</span> <span class="c">#ask user to click in a block</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">can_click</span> <span class="o">=</span> <span class="bp">True</span> <span class="c"># allow the click</span>
					<span class="k">return</span>

			<span class="c">#if we can still blinking:</span>

			<span class="nb">id</span> <span class="o">=</span> <span class="s">'btn_'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="c">#generate a random int to blink a random block</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">game_grid</span><span class="o">.</span><span class="n">ids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">source</span><span class="o">=</span><span class="s">"res/block_blink.png"</span> <span class="c">#make this block border green</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">last_id</span> <span class="o">=</span> <span class="nb">id</span> <span class="c"># save the id of the green block</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">remain_interaction</span> <span class="o">-=</span> <span class="mi">1</span>

	<span class="c"># draw the blocks in the screen</span>
	<span class="k">def</span> <span class="nf">draw_screen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">game_grid</span><span class="o">.</span><span class="n">clear_widgets</span><span class="p">()</span> <span class="c"># this command remove all children(blocks) from the game_grid</span>

			<span class="c"># according to the level, we can change the size of the grid</span>
			<span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">):</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">game_grid</span><span class="o">.</span><span class="n">cols</span> <span class="o">=</span> <span class="mi">2</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">game_grid</span><span class="o">.</span><span class="n">rows</span> <span class="o">=</span> <span class="mi">2</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span> <span class="o">=</span> <span class="mi">2</span>
			<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">game_grid</span><span class="o">.</span><span class="n">cols</span> <span class="o">=</span> <span class="mi">3</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">game_grid</span><span class="o">.</span><span class="n">rows</span> <span class="o">=</span> <span class="mi">3</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span> <span class="o">=</span> <span class="mi">3</span>
			<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">game_grid</span><span class="o">.</span><span class="n">cols</span> <span class="o">=</span> <span class="mi">4</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">game_grid</span><span class="o">.</span><span class="n">rows</span> <span class="o">=</span> <span class="mi">4</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span> <span class="o">=</span> <span class="mi">4</span>
			<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">game_grid</span><span class="o">.</span><span class="n">cols</span> <span class="o">=</span> <span class="mi">5</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">game_grid</span><span class="o">.</span><span class="n">rows</span> <span class="o">=</span> <span class="mi">5</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span> <span class="o">=</span> <span class="mi">5</span>
			<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">game_grid</span><span class="o">.</span><span class="n">cols</span> <span class="o">=</span> <span class="mi">6</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">game_grid</span><span class="o">.</span><span class="n">rows</span> <span class="o">=</span> <span class="mi">6</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span> <span class="o">=</span> <span class="mi">6</span>

			<span class="c"># this is a block in KV lang.</span>
			<span class="n">btn_str</span> <span class="o">=</span> <span class="s">'''
ImageButton:
	source: "res/block.png"
	allow_stretch: True
	keep_ratio: False'''</span>


			<span class="c"># generate a grid_sizeXgrid_size grid</span>
			<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="p">):</span>
					<span class="n">btn</span> <span class="o">=</span> <span class="n">Builder</span><span class="o">.</span><span class="n">load_string</span><span class="p">(</span><span class="n">btn_str</span><span class="p">)</span> <span class="c"># create a ImageButton from the string</span>
					<span class="nb">id</span> <span class="o">=</span> <span class="s">'btn_'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
					<span class="n">btn</span><span class="o">.</span><span class="nb">id</span> <span class="o">=</span> <span class="nb">id</span> <span class="c"># set the button ID</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">game_grid</span><span class="o">.</span><span class="n">ids</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">btn</span> <span class="c">#add this button to the list of children of the GameGrid</span>
					<span class="n">btn</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">on_press</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_btn_press</span><span class="p">)</span> <span class="c"># bind the press event</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">game_grid</span><span class="o">.</span><span class="n">add_widget</span><span class="p">(</span><span class="n">btn</span><span class="p">)</span> <span class="c"># and show this button on the grid</span>

	<span class="c"># grid button event</span>
	<span class="k">def</span> <span class="nf">on_btn_press</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">btn</span><span class="p">):</span>
			<span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">can_click</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">):</span> <span class="c"># check if the user can click</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">can_click</span> <span class="o">=</span> <span class="bp">False</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">game_grid</span><span class="o">.</span><span class="n">ids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_id</span><span class="p">)</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="s">'res/block_blink.png'</span> <span class="c"># blink the clicked button</span>
					<span class="k">if</span><span class="p">(</span><span class="n">btn</span><span class="o">.</span><span class="nb">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_id</span><span class="p">):</span> <span class="c"># if the clicked button was the last one to blink</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="o">.</span><span class="n">label_last_block</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">'Right!'</span> <span class="c"># the user was right</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c">#user can go to the next level</span>
							<span class="n">Clock</span><span class="o">.</span><span class="n">schedule_once</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_game</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c">#wait a second and start the next level</span>
					<span class="k">else</span><span class="p">:</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="o">.</span><span class="n">label_last_block</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">'Wrong :('</span> <span class="c">#user was wrong</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="o">.</span><span class="n">restart</span><span class="o">.</span><span class="n">pos_hint</span> <span class="o">=</span> <span class="p">{</span><span class="s">'x'</span><span class="p">:</span> <span class="mf">0.75</span><span class="p">,</span> <span class="s">'y'</span><span class="p">:</span> <span class="mf">0.025</span><span class="p">}</span> <span class="c">#the restart button is visible now</span>

	<span class="c"># compare the current level with the highscore</span>
	<span class="k">def</span> <span class="nf">check_best</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_level</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">best_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">'score'</span><span class="p">,</span> <span class="n">best</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">)</span> <span class="c">#save the best score. We are saving it in the key 'score', in the child 'best'</span>

	<span class="c"># open the menu screen</span>
	<span class="k">def</span> <span class="nf">go_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
			<span class="n">Clock</span><span class="o">.</span><span class="n">unschedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">open_screen</span><span class="p">(</span><span class="s">'menu'</span><span class="p">)</span>

	<span class="c"># restart the first level</span>
	<span class="k">def</span> <span class="nf">restart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
			<span class="n">Clock</span><span class="o">.</span><span class="n">unschedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">start_game</span><span class="p">()</span>


<span class="c"># This is the main app</span>
<span class="c"># This object create our application and manage all game screens</span>
<span class="k">class</span> <span class="nc">MainApp</span><span class="p">(</span><span class="n">App</span><span class="p">):</span>
	<span class="c">#create the application screens</span>
	<span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

			<span class="n">data_dir</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">'user_data_dir'</span><span class="p">)</span> <span class="c">#get a writable path to save our score</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">JsonStore</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s">'score.json'</span><span class="p">))</span> <span class="c"># create a JsonScore file in the available location</span>

			<span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">'score'</span><span class="p">)):</span> <span class="c"># if there is no file, we need to save the best score as 1</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">'score'</span><span class="p">,</span> <span class="n">best</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

			<span class="k">if</span> <span class="n">platform</span><span class="p">()</span> <span class="o">==</span> <span class="s">'android'</span><span class="p">:</span> <span class="c"># if we are on Android, we can initialize the ADs service</span>
					<span class="n">revmob</span><span class="o">.</span><span class="n">start_session</span><span class="p">(</span><span class="s">'54c247f420e1fb71091ad44a'</span><span class="p">)</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">screens</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># list of app screens</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">screens</span><span class="p">[</span><span class="s">'menu'</span><span class="p">]</span> <span class="o">=</span> <span class="n">MenuScreen</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="c">#self the MainApp instance, so others objects can change the screen</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">screens</span><span class="p">[</span><span class="s">'game'</span><span class="p">]</span> <span class="o">=</span> <span class="n">GameScreen</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">FloatLayout</span><span class="p">()</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">open_screen</span><span class="p">(</span><span class="s">'menu'</span><span class="p">)</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">sound</span> <span class="o">=</span> <span class="n">SoundLoader</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s">'res/background.mp3'</span><span class="p">)</span> <span class="c"># open the background music</span>
			<span class="c"># kivy support music loop, but it was not working on Android. I coded in a different way to fix it</span>
			<span class="c"># but if fixed, we can just set the loop to True and call the play(), so it'll auto repeat</span>
			<span class="c"># self.sound.loop = True It # was not working on android, so I wrote the following code:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">sound</span><span class="o">.</span><span class="n">play</span><span class="p">()</span> <span class="c"># play the sound</span>
			<span class="n">Clock</span><span class="o">.</span><span class="n">schedule_interval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">check_sound</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c">#every second force the music to be playing</span>

			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span>

	<span class="c"># play the sound</span>
	<span class="k">def</span> <span class="nf">check_sound</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">sound</span><span class="o">.</span><span class="n">play</span><span class="p">()</span>

	<span class="c"># when the app is minimized on Android</span>
	<span class="k">def</span> <span class="nf">on_pause</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">sound</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span> <span class="c"># the stop the sound</span>
			<span class="n">Clock</span><span class="o">.</span><span class="n">unschedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">check_sound</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">platform</span><span class="p">()</span> <span class="o">==</span> <span class="s">'android'</span><span class="p">:</span> <span class="c">#if on android, we load an ADs and show it</span>
					<span class="n">revmob</span><span class="o">.</span><span class="n">show_popup</span><span class="p">()</span>
			<span class="k">return</span> <span class="bp">True</span>

	<span class="c"># when the app is resumed</span>
	<span class="k">def</span> <span class="nf">on_resume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">sound</span><span class="o">.</span><span class="n">play</span><span class="p">()</span> <span class="c"># we start the music again</span>
			<span class="n">Clock</span><span class="o">.</span><span class="n">schedule_interval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">check_sound</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

	<span class="c"># show a new screen.</span>
	<span class="k">def</span> <span class="nf">open_screen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">clear_widgets</span><span class="p">()</span> <span class="c">#remove the current screen</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">add_widget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">screens</span><span class="p">[</span><span class="n">name</span><span class="p">])</span> <span class="c"># add a new one</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">screens</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">run</span><span class="p">()</span> <span class="c"># call the run method from the desired screen</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
	<span class="n">MainApp</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></code></pre></figure>

<p>To help you understand the game logic. The user always start on the first level.</p>

<p>Then we draw some blocks in the screen and blink them calculated times.</p>

<p>After it, the user must to click in one of the blocks.</p>

<p>So we check if the button clicked is the same that we expect, if so, we just move to the next scene.</p>

<p>To manage multiple scenes, we load each of them in a variable. So we just add the desired screen to the MainApp widget and show it.</p>

<p>To monetize this app, we are going to use <a href="http://revmobmobileadnetwork.com/">http://revmobmobileadnetwork.com/ </a></p>

<p>They officially support Kivy apps, so it’s easier to work with it in this post. Just download this file: <a href="http://sdk.revmobmobileadnetwork.com/kivy.html#download">http://sdk.revmobmobileadnetwork.com/kivy.html#download</a> , move the <strong>libs</strong> and <strong>revmob</strong> folders to your project root and go to the next step.</p>

<h2 id="viii---configuration"><strong>VIII - Configuration</strong></h2>

<p>This app will need some special configurations, because we are using the revmob to monetize it. Open your buildozer.spec file and add the following permissions:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">android.permissions = INTERNET,ACCESS_WIFI_STATE,READ_PHONE_STATE,ACCESS_NETWORK_STATE</code></pre></figure>

<p>Now, to add the revmob API, add the following line:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">android.add_jars = %(source.dir)s/libs/*.jar</code></pre></figure>

<p>Add Pyjnius</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">requirements = kivy, pyjnius</code></pre></figure>

<p>And, as we are using a .mp3 file, add .mp3 in this line:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">source.include_exts = py,png,jpg,kv,atlas,mp3</code></pre></figure>

<p>And finally, set your app version with</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">version = 1.0.0</code></pre></figure>

<p>You can read my full <a href="https://github.com/aron-bordin/Kivy-Tutorials/blob/master/5_Perception/Perception/buildozer.spec">buildozer.spec here: https://github.com/aron-bordin/Kivy-Tutorials/blob/master/5_Perception/Perception/buildozer.spec</a></p>

<h2 id="ix---running-our-python-game-on-android-and-ios">IX - Running our Python game on Android and iOS</h2>

<p>Now, we can run it and check if anything is working.</p>

<p>It’s a really big post, so if you have any problem in any step, feel free to comment here.</p>

<p>I tested only on Android, but it’s probably going to work with <a href="https://github.com/kivy/kivy-ios">iOS</a> too.</p>

<p>To run this game on Android, use the following command:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">buildozer --verbose android debug deploy run</code></pre></figure>

<p>To run this game on iOS, use the following command:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">buildozer --verbose ios debug deploy run  </code></pre></figure>

<p>Or, just type python main.py to run it on your PC.</p>

<p>That’s it. Thank’s for reading!</p>


<center>
  <ins class="adsbygoogle" data-ad-client="ca-pub-7559770887681599" data-ad-slot="1350374663">
  </ins>
</center>



      <footer class="entry-meta">
        <span class="entry-tags"><a href="/tags#Android" title="Pages tagged Android" class="tag"><span class="term">Android</span></a><a href="/tags#ios" title="Pages tagged ios" class="tag"><span class="term">ios</span></a><a href="/tags#kivy" title="Pages tagged kivy" class="tag"><span class="term">kivy</span></a><a href="/tags#monetize" title="Pages tagged monetize" class="tag"><span class="term">monetize</span></a><a href="/tags#mp3" title="Pages tagged mp3" class="tag"><span class="term">mp3</span></a><a href="/tags#multiple" title="Pages tagged multiple" class="tag"><span class="term">multiple</span></a><a href="/tags#music" title="Pages tagged music" class="tag"><span class="term">music</span></a><a href="/tags#python" title="Pages tagged python" class="tag"><span class="term">python</span></a><a href="/tags#python2" title="Pages tagged python2" class="tag"><span class="term">python2</span></a><a href="/tags#python3" title="Pages tagged python3" class="tag"><span class="term">python3</span></a><a href="/tags#scene" title="Pages tagged scene" class="tag"><span class="term">scene</span></a><a href="/tags#sound" title="Pages tagged sound" class="tag"><span class="term">sound</span></a><a href="/tags#Tutorial" title="Pages tagged Tutorial" class="tag"><span class="term">Tutorial</span></a></span>
        
        <span class="author vcard"><span class="fn">Aron Bordin</span></span>
        

      </footer>
    </div>
    </div></body></html>