<html><body><div><div class="content html_format"><p>
      Не так давно передо мной встала задача: распечатка документа определенного формата с помощью мобильного устройства. На телефоне должны были вводиться определенные значения, отправляться на сервер (для того, чтобы потом можно было использовать эти данные на веб сайте) и печать документ с этими данными. С самого начала мой выбор пал на </p><a href="http://www.google.com/cloudprint/learn/?hl=ru">Google cloud print</a><p>, так как он максимально прост в использовании и решении подобных задач. Но при использовании этого варианта есть несколько недостатков: 

</p><ul>
<li>Очень медленная обработка запроса </li>
<li>Нужно где-то формировать PDF документ и возвращать ссылку на него</li>
<li>Постоянно нужно выбирать принтер (если у вас подключен только один принтер к Google cloud print, то все равно нужно выбирать между ним и сохранением на Google Drive)</li>
</ul> <p>
Поэтому я решил написать свой скрипт для подобных операций.
</p><a name="habracut"/><p>
Мой выбор пал на язык программирования Python, так как он наиболее гибкий и подходит для данных задач. В своей разработке я использовал ОС Ubuntu Linux. Так что установка библиотек будет представлена для нее.
</p><p>
С самого начала нам нужно научиться формировать PDF документ. Проще всего конвертировать HTML разметку в PDF с помощью библиотеки xhtml2pdf. Для начала установим необходимые пакеты:

</p><pre><code class="bash">sudo apt-get install python-cups python-pip
python-dev
</code></pre><p>
python-cups – это библиотека, с помощью которой Python может работать с вашим принтером, python-pip сделает установку xhtml2pdf проще.
</p><p>
Дальше устанавливаем xhtml2pdf:

</p><pre><code class="bash"> sudo pip install xhtml2pdf
</code></pre><p>
 Следующий код покажет, как все работает:

</p><pre><code class="python"> #!/usr/bin/env python
 # Печать файла
 
 import cups
 from xhtml2pdf import pisa
	
 def main():
       # Имя, для промежуточного файла PDF формата
       filename = "/home/pi/print.pdf"
	
       # Генерируем контент в виде HTML страницы
       xhtml = "&lt;h1&gt;Test print&lt;/h1&gt;\n"
       xhtml += "&lt;h2&gt;This is printed from within a Python application&lt;/h2&gt;\n"
       xhtml += "&lt;p style=\"color:red;\"&gt;Coloured red using css&lt;/p&gt;\n"
          
       pdf = pisa.CreatePDF(xhtml, file(filename, "w"))
       if not pdf.err:
              # Закрываем PDF файл - в противном случае мы не сможем прочитать его
              pdf.dest.close()
      
              # Печатаем файл используя CUPS
              conn = cups.Connection()
              # Получаем список всех принтеров, подключенных к компьютеру
              printers = conn.getPrinters()
              for printer in printers: 
                     # Выводим имя принтера в консоль
                     print printer, printers[printer]["device-uri"]
                     # Получаем первый принтер со списка принтеров
                     printer_name = printers.keys()[0]
                     conn.printFile(printer_name, filename, "Python_Status_print", {})
       else:
              print "Unable to create pdf file"

 if __name__=="__main__":
       main()
</code></pre><p>
Тут все предельно просто и понятно. Картинки можно вставлять обычным HTML кодом: 

</p><pre><code class="html">&lt;p&gt;&lt;img src='/home/usr/image.jpg'/&gt;
</code></pre><p>
Но возникает вопрос: "</p><i>Где хранить данные и откуда их достать для распечатки?</i><p>".
</p><p>
Для этого мы воспользуемся сервисом </p><a href="http://parse.com">Parse</a><p>. Это хорошее бесплатное облако, для хранения ваших данных. Его удобно использовать тем, что оно работает практически на всех платформах (Грубо говоря: вы можете добавить закинуть данные на облако с Android устройства, а достать на IOS, PHP, JavaScript и других платформах).
</p><p>
Специально для Python там есть REST API, с помощью которого можно слать любые запросы в несколько строчек. Для того, чтобы достать их с Pars'a используем код: 

</p><pre><code class="python"> connection = httplib.HTTPSConnection('api.parse.com', 443)
 connection.connect()
 connection.request('GET', '/1/classes/TestPay', '', {
       "X-Parse-Application-Id": "&lt;b&gt;yourAppId&lt;/b&gt;",
       "X-Parse-REST-API-Key": "&lt;b&gt;yourRestApiKey&lt;/b&gt;"
 })
 result = json.loads(connection.getresponse().read())
</code></pre><p>
Здесь </p><i>yourAppId</i><p> – это ключ к вашему приложению, а </p><i>yourRestApiKey</i><p> – ключ к Api, которое вы используете. Детальнее читайте на сайте. Дальше массив result обрабатываете как JSON обьект и можете вставлять в вашу HTML страницу, которая тут же пойдет на печать. 
</p><p>
Если возникнут какие-то вопросы, подсказки или вы просто решите высказать свое мнение по поводу статьи — пишите в комментариях. Всех с наступающим Новым Годом!
      </p><p class="clear"/>
    </div>

    
  </div></body></html>