<html><body><div><div class="content">
      
        <h1 class="content-title">A Flask Front-End and Chrome Extension for YouTube-DL</h1>
      
      
      
  
  
  
    <p><a href="http://media.charlesleifer.com/blog/photos/s1399310859.29.png" title="YouTube screenshot"><img alt="YouTube screenshot" class="img-responsive" src="http://m.charlesleifer.com/t/800x-/blog/photos/s1399310859.29.png?key=am_dc87u_LyFDRk9eE25ZA"/></a></p>
<p>I was cruising through some old bookmarked YouTube videos this evening and was sad to see that a few of my favorites were no longer available. I was able to search and find them again, but I decided it might not be a bad idea to save my favorites to my media server. I installed <a href="http://rg3.github.io/youtube-dl/">youtube-dl</a> and was impressed by how well it <em>just worked</em>. Since I wanted to store these videos on my media server and watch them on <a href="https://plex.tv/">Plex</a> I then <code>scp</code>-ed the video files to the media server. Then it hit me -- why not just write a tiny web frontend for youtube-dl? Once I had a web app, then I could write a chrome extension to communicate with it...</p>
<p>With Flask the whole process took about 20 minutes, so I thought I'd share in case anyone else would find this useful.</p>
<h3>The Flask App</h3>
<p>I created a fresh virtualenv on my media server and installed the following packages:</p>

<p>Then I placed the following script in the root of the virtualenv. The code is intentionally simplistic since <code>youtube-dl</code> will be doing all the hard work:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">flash</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">url_for</span>

<span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s1">'this is needed for flash messages'</span>

<span class="n">BINARY</span> <span class="o">=</span> <span class="s1">'/path/to/bin/youtube-dl'</span>
<span class="n">DEST_DIR</span> <span class="o">=</span> <span class="s1">'/path/to/my/videos'</span>
<span class="n">OUTPUT_TEMPLATE</span> <span class="o">=</span> <span class="s1">'</span><span class="si">%s</span><span class="s1">/</span><span class="si">%%</span><span class="s1">(title)s-</span><span class="si">%%</span><span class="s1">(id)s.</span><span class="si">%%</span><span class="s1">(ext)s'</span> <span class="o">%</span> <span class="n">DEST_DIR</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'GET'</span><span class="p">,</span> <span class="s1">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">download</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">'POST'</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">'url'</span><span class="p">]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">BINARY</span><span class="p">,</span> <span class="s1">'-o'</span><span class="p">,</span> <span class="n">OUTPUT_TEMPLATE</span><span class="p">,</span> <span class="s1">'-q'</span><span class="p">,</span> <span class="n">url</span><span class="p">])</span>
        <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="n">flash</span><span class="p">(</span><span class="s1">'Successfully downloaded!'</span><span class="p">,</span> <span class="s1">'success'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">'download'</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">'download.html'</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">'0.0.0.0'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8801</span><span class="p">)</span>
</pre></div>
<p>When a video URL is POSTed to the download view, it will shell out to the <code>youtube-dl</code> binary and block until the download finishes. I'm specifying an <em>output template</em> for youtube-dl to use when saving the downloaded video, ensuring everything ends up in a directory watched by Plex.</p>
<h3>A minimal template</h3>
<p>I made a simple template using bootstrap, which looks like:</p>
<div class="highlight"><pre><span class="cp">&lt;!doctype html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>youtuber<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">stylesheet</span> <span class="na">type</span><span class="o">=</span><span class="s">text/css</span> <span class="na">href</span><span class="o">=</span><span class="s">"{{ url_for('static', filename='css/youtuber.min.css') }}"</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"{{ url_for('static', filename='js/jquery-1.11.0.min.js') }}"</span> <span class="na">type</span><span class="o">=</span><span class="s">"text/javascript"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"{{ url_for('static', filename='js/bootstrap.min.js') }}"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"container"</span><span class="p">&gt;</span>
      {% for category, message in get_flashed_messages(with_categories=true) %}
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"alert alert-{{ category }} alert-dismissable"</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">button</span> <span class="na">type</span><span class="o">=</span><span class="s">"button"</span> <span class="na">class</span><span class="o">=</span><span class="s">"close"</span> <span class="na">data-dismiss</span><span class="o">=</span><span class="s">"alert"</span> <span class="na">aria-hidden</span><span class="o">=</span><span class="s">"true"</span><span class="p">&gt;</span><span class="ni">Ã—</span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>{{ message }}<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      {% endfor %}

      <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Download<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">"{{ url_for('download') }}"</span> <span class="na">method</span><span class="o">=</span><span class="s">"post"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"form-group"</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">"url"</span><span class="p">&gt;</span>URL<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">name</span><span class="o">=</span><span class="s">"url"</span> <span class="na">class</span><span class="o">=</span><span class="s">"form-control"</span> <span class="na">id</span><span class="o">=</span><span class="s">"url"</span> <span class="na">placeholder</span><span class="o">=</span><span class="s">"url"</span> <span class="p">/&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">button</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">class</span><span class="o">=</span><span class="s">"btn btn-primary"</span><span class="p">&gt;</span>Download<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
<h3>The Chrome Extension</h3>
<p>The final piece to the puzzle is a Chrome extension that adds a button to the toolbar which, when clicked, will send the currently open URL to the Flask app for downloading (via an ajax request).</p>
<p>This extension will add a toolbar-icon and run in the background waiting for click events. In addition to a simple 16x16 icon, here are the three files required for the extension.</p>
<p><code>manifest.json</code> stores metadata about the extension, including the name of the background script and the icon used in the toolbar:</p>
<div class="highlight"><pre><span class="cm">/* manifest.json */</span>
<span class="p">{</span>
  <span class="s2">"background"</span><span class="o">:</span> <span class="p">{</span><span class="s2">"scripts"</span><span class="o">:</span> <span class="p">[</span><span class="s2">"background.js"</span><span class="p">]},</span>
  <span class="s2">"browser_action"</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">"default_icon"</span><span class="o">:</span> <span class="s2">"youtuber.png"</span><span class="p">,</span>
    <span class="s2">"default_title"</span><span class="o">:</span> <span class="s2">"youtuber"</span>
  <span class="p">},</span>
  <span class="s2">"name"</span><span class="o">:</span> <span class="s2">"YouTuber"</span><span class="p">,</span>
  <span class="s2">"description"</span><span class="o">:</span> <span class="s2">"Store youtube vids on media server"</span><span class="p">,</span>
  <span class="s2">"icons"</span><span class="o">:</span> <span class="p">{</span><span class="s2">"16"</span><span class="o">:</span> <span class="s2">"youtuber.png"</span><span class="p">},</span>
  <span class="s2">"permissions"</span><span class="o">:</span> <span class="p">[</span>
    <span class="s2">"tabs"</span><span class="p">,</span>
    <span class="s2">"http://*/*"</span><span class="p">,</span>
    <span class="s2">"https://*/*"</span><span class="p">],</span>
  <span class="s2">"version"</span><span class="o">:</span> <span class="s2">"0.1"</span><span class="p">,</span>
  <span class="s2">"manifest_version"</span><span class="o">:</span> <span class="mi">2</span>
<span class="p">}</span>
</pre></div>
<p><code>background.js</code> binds a click handler which executes our YouTube script, making the ajax request.</p>
<div class="highlight"><pre><span class="cm">/* background.js */</span>
<span class="nx">chrome</span><span class="p">.</span><span class="nx">browserAction</span><span class="p">.</span><span class="nx">onClicked</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">tab</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">chrome</span><span class="p">.</span><span class="nx">tabs</span><span class="p">.</span><span class="nx">executeScript</span><span class="p">(</span><span class="nx">tab</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="p">{</span><span class="nx">file</span><span class="o">:</span> <span class="s2">"youtuber.js"</span><span class="p">});</span>
<span class="p">});</span>
</pre></div>
<p>Finally, here is <code>youtuber.js</code>, the script that POSTs the URL to the Flask app running on my media server. When the download finishes an ugly little message pops up letting me know it's done.</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">youtubeURL</span> <span class="o">=</span> <span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">xmlhttp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
<span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">alert</span><span class="p">(</span><span class="s1">'Finished downloading '</span> <span class="o">+</span> <span class="nb">document</span><span class="p">.</span><span class="nx">title</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">alert</span><span class="p">(</span><span class="s1">'Something went wrong: '</span> <span class="o">+</span> <span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">status</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">'POST'</span><span class="p">,</span> <span class="s1">'http://my.server.url:8801/'</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s1">'Content-type'</span><span class="p">,</span> <span class="s1">'application/x-www-form-urlencoded'</span><span class="p">);</span>
<span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">'url='</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">youtubeURL</span><span class="p">));</span>
</pre></div>
<p>Now any time I'm watching a YouTube video I want to save, I simply click the little toolbar icon and it shows up on my media server!</p>
<h3>Thanks for reading</h3>
<p>Thanks for taking the time to read this post. I hope you found it useful!</p>
<p>If you're interested in more projects like this, check out <a href="/blog/tags/saturday-morning-hacks/">the saturday-morning hack posts</a>.</p>
  
  

  
  
  

  
  
  

  
  
  

  
  
  


<hr/>

  <p>Commenting has been closed, but please feel free to <a href="/contact/">contact me</a></p>


    </div>

    </div></body></html>