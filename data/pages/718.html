<html><body><div><div class="entry-content"><div id="attachment_8104" class="wp-caption aligncenter"><a href="http://artandlogic.com/wp-content/uploads/2014/04/magic-django-pony-iphone.png"><img class="size-full wp-image-8104 " alt="Image via http://www.djangopony.com/" src="http://artandlogic.com/wp-content/uploads/2014/04/magic-django-pony-iphone.png"/></a><p class="wp-caption-text">Image via http://www.djangopony.com/</p></div><p>I needed to add Facebook authentication to a Django app today, and instead of writing it directly against the Facebook API (or re-implementing the OAuth2 dance again), I decided to look around and see if there’s a pre-packaged solution for this common task. Turns out, there’s an excellent project called <a href="https://github.com/omab/python-social-auth">Python Social Auth</a>, and it covers pretty much any social website with an authentication API.</p><p>As it often happens with amazing open-source projects, the documentation is somewhat minimalistic. One key piece that I could not find was a tutorial. This post is aiming to fill that gap. In this tutorial, we will use Facebook, Twitter and Google, as the most common social APIs, but we could easily substitute them with LinkedIn, Yahoo, Forsquare, or a bunch of other providers supported by Python Social Auth library.<span class="more-anchor" id="more-8084"/></p><p>If you are comfortable with Django, feel free to skip to Step2.</p><h2>Step 0. Start a simple Django project</h2><p>Let’s begin with a barebones Django project named “thirdauth”, named in honour of third-party authentication.</p><pre>$ django-admin.py startproject thirdauth
$ tree thirdauth/
thirdauth/
├── manage.py
└── thirdauth
    ├── __init__.py
    ├── settings.py
    ├── urls.py
    └── wsgi.py</pre><p>Running <code>./manage.py syncdb</code> and then <code>./manage.py runserver</code> and navigating to localhost:8000 will show the familiar “It worked!” Django page. Let’s put some custom application code in place, so that we can tell whether the current user is authenticated or anonymous.</p><h2>Step 1. Show current user’s authentication status</h2><p>Let’s throw together a simple basic page, add CSS, JavaScript and fonts from Twitter Bootstrap, and add a view for home page. For this tutorial, we won’t need custom models or any other views.</p><p>NOTE: if you need help with Django views, templates and settings, please check out the <a href="https://docs.djangoproject.com/en/dev/intro/tutorial01/">Django tutorial</a>.</p><p>Another NOTE: Bootstrap is Twitter’s basic set of CSS and JavaScript to help make even minimal web interfaces look and behave consistently well. You do not have to use it for this tutorial, it adds only aesthetic side – it adds a polished feel to things. Bootstrap can be downloaded from <a href="http://getbootstrap.com/">http://getbootstrap.com/</a></p><p>Now, the very small customizations we’ll add are:</p><ul><li>Add ‘thirdauth’ to INSTALLED_APPS</li><li>Create the template for the home page</li><li>Add a view for the home page</li><li>Add a URL pointing to the home page view</li></ul><p>Relevant portion of settings.py:</p><pre>INSTALLED_APPS = (
  'django.contrib.admin',
  'django.contrib.auth',
  ...
  <b>'thirdauth',</b>
)</pre><p>Template: thirdauth/base.html:</p><pre>&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
 &lt;head&gt;
   &lt;meta charset="utf-8"&gt;
   &lt;meta http-equiv="X-UA-Compatible" content="IE=edge"&gt;
   &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;
   &lt;title&gt;{% block title %}Third-party Authentication Tutorial{% endblock %}&lt;/title&gt;

   &lt;!-- Bootstrap --&gt;
   &lt;link href="/static/css/bootstrap.min.css" rel="stylesheet"&gt;
   &lt;link href="/static/css/bootstrap-theme.min.css" rel="stylesheet"&gt;
   &lt;link href="/static/css/fbposter.css" rel="stylesheet"&gt;

   &lt;!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries --&gt;
   &lt;!-- WARNING: Respond.js doesn't work if you view the page via file:// --&gt;
   &lt;!--[if lt IE 9]&gt;
     &lt;script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"&gt;&lt;/script&gt;
     &lt;script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"&gt;&lt;/script&gt;
   &lt;![endif]--&gt;
 &lt;/head&gt;
 &lt;body&gt;
   {% block main %}{% endblock %}
   &lt;!-- jQuery (necessary for Bootstrap's JavaScript plugins) --&gt;
   &lt;script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"&gt;&lt;/script&gt;
   &lt;!-- Include all compiled plugins (below), or include individual files as needed --&gt;
   &lt;script src="/static/js/bootstrap.min.js"&gt;&lt;/script&gt;
 &lt;/body&gt;
&lt;/html&gt;</pre><p>Template: thirdauth/home.html:</p><pre>{% extends 'thirdauth/base.html' %}

{% block main %}
 &lt;div&gt;
 &lt;h1&gt;Third-party authentication demo&lt;/h1&gt;

 &lt;p&gt;
   {% if user and not user.is_anonymous %}
     Hello {{ user.get_full_name|default:user.username }}!
   {% else %}
     I don’t think we’ve met before.
   {% endif %}
 &lt;/p&gt;
 &lt;/div&gt;
{% endblock %}</pre><p>File views.py:</p><pre>from django.shortcuts import render_to_response
from django.template.context import RequestContext

def home(request):
   context = RequestContext(request,
                           {'user': request.user})
   return render_to_response('thirdauth/home.html',
                             context_instance=context)</pre><p>File urls.py:</p><pre>from django.conf.urls import patterns, include, url

from django.contrib import admin
admin.autodiscover()

urlpatterns = patterns('',
   url(r'^$', 'thirdauth.views.home', name='home'),
   url(r'^admin/', include(admin.site.urls)),
)</pre><p>Now, when we refresh the page, we will see:</p><p>Fair enough – we have not authenticated yet. To make sure our identity-checking template works, try logging in to Django admin with the default Django authentication (assuming you created an admin account on Step 0). You should see a different message: “Hello admin!”, or something like that.</p><h2>Step 2. Install Python Social Auth</h2><p>First, let’s add it to our virtualenv:</p><pre>pip install python-social-auth</pre><p>Second, let’s make some modifications to our settings.py to include python-social-auth in our project:</p><pre>INSTALLED_APPS = (
   ...
   'social.apps.django_app.default',
   ...
)

TEMPLATE_CONTEXT_PROCESSORS = (
   'django.contrib.auth.context_processors.auth',
   'django.core.context_processors.debug',
   'django.core.context_processors.i18n',
   'django.core.context_processors.media',
   'django.core.context_processors.static',
   'django.core.context_processors.tz',
   'django.contrib.messages.context_processors.messages',
   'social.apps.django_app.context_processors.backends',
   'social.apps.django_app.context_processors.login_redirect',
)

AUTHENTICATION_BACKENDS = (
   'social.backends.facebook.FacebookOAuth2',
   'social.backends.google.GoogleOAuth2',
   'social.backends.twitter.TwitterOAuth',
   'django.contrib.auth.backends.ModelBackend',
)</pre><p>Let’s update the urls module to include the new group of URLs:</p><pre>urlpatterns = patterns('',
...
url('', include('social.apps.django_app.urls', namespace='social')),
...
)</pre><p>And finally, let’s update the database models:</p><p>./manage.py syncdb</p><p>Now, if we runserver again, and navigate to Django admin, we’ll see three new tables: Associations, Nonces, and User social auths. This last one will contain the records of our users’ social accounts when they use social networks to authenticate from our app.</p><p>We are almost there. Let’s add some links for logging in and logging out, and then we’ll start adding application IDs for social apps.</p><h2>Step 3. Add links for logging in and logging out.</h2><p>Since we’ll be logging in and out multiple times, let’s include django.contrib.auth URLs into our URLs configuration:</p><pre>urlpatterns = patterns('',
   ...
   url('', include('django.contrib.auth.urls', namespace='auth')),
   ...
)</pre><p>Let’s modify our Home page template like this:</p><pre>{% extends 'thirdauth/base.html' %}

{% block main %}
 &lt;div&gt;
 &lt;h1&gt;Third-party authentication demo&lt;/h1&gt;

 &lt;p&gt;
   &lt;ul&gt;
   {% if user and not user.is_anonymous %}
     &lt;li&gt;
       &lt;a&gt;Hello {{ user.get_full_name|default:user.username }}!&lt;/a&gt;
     &lt;/li&gt;
     &lt;li&gt;
       &lt;a href="{% url 'auth:logout' %}?next={{ request.path }}"&gt;Logout&lt;/a&gt;
     &lt;/li&gt;
   {% else %}
     &lt;li&gt;
       &lt;a href="{% url 'social:begin' 'facebook' %}?next={{ request.path }}"&gt;Login with Facebook&lt;/a&gt;
     &lt;/li&gt;
     &lt;li&gt;
       &lt;a href="{% url 'social:begin' 'google-oauth2' %}?next={{ request.path }}"&gt;Login with Google&lt;/a&gt;
     &lt;/li&gt;
     &lt;li&gt;
       &lt;a href="{% url 'social:begin' 'twitter' %}?next={{ request.path }}"&gt;Login with Twitter&lt;/a&gt;
     &lt;/li&gt;
   {% endif %}
   &lt;/ul&gt;
 &lt;/p&gt;
 &lt;/div&gt;
{% endblock %}</pre><p>For the login and logout links in this template to work correctly, we need to modify a few things. First, let’s take care of logout, it’s easier. Just add ‘request’ to the context object that we pass into template-rendering code. Updated views.py:</p><pre>from django.shortcuts import render_to_response
from django.template.context import RequestContext

def home(request):
   context = RequestContext(request,
                           {'request': request,
                            'user': request.user})
   return render_to_response('thirdauth/home.html',
                             context_instance=context)</pre><p>For login to work, let’s first add a LOGIN_REDIRECT_URL parameter to settings (to prevent the default /account/profile from raising a 404):</p><pre>LOGIN_REDIRECT_URL = '/'</pre><p>And then start adding API-specific parameters for social networks. Right this moment, if you click on any of the “login with X” links, you’ll get redirected to the corresponding social site, but will get an error about invalid client ID. That’s because we have not provided any client IDs yet.</p><h2>Step 4. Get Client IDs for the social sites.</h2><p>For all the social networks we are using in this demo, the process of obtaining an OAuth2 client ID (also known as application ID) is pretty similar. All of them will require that your application has a “real” URL – that is, not http://127.0.0.1 or http://localhost. You can add an entry in your /etc/hosts file that maps 127.0.0.1 to something like “test1.com”, and the URL of your application becomes http://test1.com:8000 – that is good enough for testing. You can change it in the social app settings when it goes into production.</p><h3>Facebook</h3><ul><li>Go to <a href="https://developers.facebook.com/apps/?action=create">https://developers.facebook.com/apps/?action=create</a> and click the green “Create New App” button.</li><li>In the settings of the newly-created application, click “Add Platform”. From the options provided, choose Web, and fill in the URL of the site (<a href="http://test1.com:8000">http://test1.com:8000</a> in our example).</li><li>Copy the App ID and App Secret, and place them into settings.py file:<br/> SOCIAL_AUTH_FACEBOOK_KEY = …<br/> SOCIAL_AUTH_FACEBOOK_SECRET = …</li><li>This should be enough to get your app to login with Facebook! Try logging in and out – you should get redirected between your app and FB OAuth2 service, and a new record in the User social auths table will get created, along with a new User record pointing to it.</li></ul><h3>Google</h3><ul><li>Go to <a href="https://console.developers.google.com/">https://console.developers.google.com/</a> and create a new application.</li><li>Under APIs and Auth &gt; Credentials, create a new Client ID.</li><li>Make sure to specify the right callback URL: http://test1.com:8000/complete/google-oauth2/</li><li>Copy the values into settings file:<br/> SOCIAL_AUTH_GOOGLE_OAUTH2_KEY = …<br/> SOCIAL_AUTH_GOOGLE_OAUTH2_SECRET = …</li></ul><h3>Twitter</h3><ul><li>Go to <a href="https://apps.twitter.com/app/new">https://apps.twitter.com/app/new</a> and create the new application</li><li>The callback URL should be something like http://test1.com:8000/complete/twitter/</li><li>Copy the values into settings.py:<br/> SOCIAL_AUTH_TWITTER_KEY = …<br/> SOCIAL_AUTH_TWITTER_SECRET = …</li></ul><h2>What’s next?</h2><p>Python Social Auth can provide more than just authentication. By customizing pipeline, we can get account information for our users, manage accounts through email confirmation, and more. But those topics are beyond the scope of this tutorial.</p><div id="ts-fab-below" class="ts-fab-wrapper"><span class="screen-reader-text">The following two tabs change content below.</span><div class="ts-fab-tabs"><div class="ts-fab-tab" id="ts-fab-latest-posts-below"><div class="ts-fab-text"><div class="ts-fab-header"><h4>Latest posts by Vlad Orlenko <span class="latest-see-all">(<a href="http://artandlogic.com/author/vorlenko2012/" rel="nofollow">see all</a>)</span></h4></div></div></div></div></div><p id="jp-relatedposts" class="jp-relatedposts"><h3 class="jp-relatedposts-headline"><em>Related</em></h3></p><p>Tags: <a href="http://artandlogic.com/tag/django/" rel="tag">Django</a>, <a href="http://artandlogic.com/tag/facebook/" rel="tag">Facebook</a>, <a href="http://artandlogic.com/tag/google-authentication/" rel="tag">Google Authentication</a>, <a href="http://artandlogic.com/tag/oauth2/" rel="tag">OAuth2</a>, <a href="http://artandlogic.com/tag/python/" rel="tag">python</a>, <a href="http://artandlogic.com/tag/twitter/" rel="tag">twitter</a></p> </div>  </div></body></html>