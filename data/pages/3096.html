<html><body><div><div class="body"><div itemscope="" itemtype="http://schema.org/Article"><h1 class="title" itemprop="name">VirtualBox VM auto-shutdown</h1><p class="date"> Sat 04 January 2014</p><div itemprop="articleBody"><p>So I've decided to really try <a class="reference external" href="http://www.vagrantup.com">Vagrant</a> again - there's just this annoyance that makes it very inconvenient: on Windows, <a class="reference external" href="https://www.virtualbox.org">VirtualBox</a> doesn't graciously shutdown your VMs. Logged off? Aborted VM. Shutdown in rush? You probably forgot to take care of those VMs. Want to worder every time about why some service doesn't start at boot? Want to recover that mongo database every time you forgot to <tt class="docutils literal">sudo shutdown</tt> or <tt class="docutils literal">vagrant halt</tt>? I certainly do not.</p><p>There's a mysterious <a class="reference external" href="https://www.virtualbox.org/sdkref/interface_i_machine.html#a724adf774f12d25744bbac488c7fe26e">IMachine::autostopType</a> property in the <a class="reference external" href="https://www.virtualbox.org/sdkref/index.html">vboxapi</a> but it appears that it's not supported on Windows :(</p><p>So the plan is to create some tool to make those VMs get a nice, gracious ACPI shutdown. And if ACPI shutdown not possible then suspend them.</p><p>I've tried to make <a class="reference external" href="http://technet.microsoft.com/en-us/library/cc753583.aspx">logoff scripts</a> to run <tt class="docutils literal">vagrant halt</tt> but it appears that by the time the script is run the VMs are already killed. Bummer.</p><p>Because the VMs are started by Vagrant under the user's account we cannot use any Windows Service based solution <a class="footnote-reference" href="#id4" id="id1">[1]</a>.</p><div class="section" id="so-the-plan"><h2>So, the plan<a class="headerlink" href="#so-the-plan" title="Permalink to this headline"> *</a></h2><p>Is going to be like this:</p><ul class="simple"><li>Have some sort of process that runs in the background.</li><li>Have a notification area icon (to see that it's running and maybe disable it).</li><li>When process is sent <a class="reference external" href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa376889%28v=vs.85%29.aspx">WM_ENDSESSION</a>, <a class="reference external" href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa376890%28v=vs.85%29.aspx">WM_QUERYENDSESSION</a>, <a class="reference external" href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms632641%28v=vs.85%29.aspx">WM_QUIT</a>, <a class="reference external" href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms632617%28v=vs.85%29.aspx">WM_CLOSE</a> or anything that might look like a logoff/shutdown event then shamelessly block and patiently wait for all the VMs to shutdown.</li><li>Make the process get the close messages first (set priority using <a class="reference external" href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms686227%28v=vs.85%29.aspx">SetProcessShutdownParameters</a>).</li><li>For each VM the shutdown process is going to be like this:<ul><li>Unpause if VM paused.</li><li>Send ACPI shutdown signal, wait for a state change for 10 seconds</li><li>If machine still running then suspend it, wait again till it changes state.</li></ul></li></ul><p>I've implemented it <a class="reference external" href="https://gist.github.com/ionelmc/8245494">here</a> - give it shot!</p></div><div class="section" id="install"><h2>Install<a class="headerlink" href="#install" title="Permalink to this headline"> *</a></h2><p>Here's what you need to run it:</p><ul class="simple"><li>Download <a class="reference external" href="https://gist.github.com/ionelmc/8245494/raw/vbox-shutdown.py">vbox-shutdown.py</a> somewhere there are write permissions (it will create a logfile unless you specify it a different path).</li><li>Python 2.7 with same architecture as VirtualBox - if you have 64bit system most probably you'll need a 64-bit Python (I've used the COM api - it doesn't allow cross arch interop for now <a class="footnote-reference" href="#id7" id="id2">[3]</a>). This could change by using the <a class="reference external" href="https://www.virtualbox.org/manual/ch08.html">command line API</a> if <em>anyone</em> really wanted this. <em>Anyone</em> can fix it - it's just some Python code.</li><li>Install pywin32 - same architecture/reason as above. <a class="footnote-reference" href="#id5" id="id3">[2]</a></li><li>Install the <tt class="docutils literal">vboxapi</tt> package. Running <tt class="docutils literal">python vboxapisetup.py install</tt> in <tt class="docutils literal"><span class="pre">c:\Program</span> Files\Oracle\VirtualBox\sdk\install\</tt> did the trick for me. I wonder why they have this <a class="reference external" href="https://pypi.python.org/pypi/vboxapi">useless pypi package</a> with no distributions ...</li></ul><p>Now just run <tt class="docutils literal">shell:startup</tt> and put the file in there.</p><div class="section" id="note"><h3>Note<a class="headerlink" href="#note" title="Permalink to this headline"> *</a></h3><blockquote> I've tested this on Windows 8.1 but there's no reason it wouldn't run on older versions <span class="small">(or be something that cannot be fixed easily)</span>.</blockquote></div></div><div class="section" id="obligatory-screenshot"><h2>Obligatory screenshot<a class="headerlink" href="#obligatory-screenshot" title="Permalink to this headline"> *</a></h2><img alt="Screenshot of VirtualBoxAutoShutdownTray" src="https://blog.ionelmc.ro/2014/01/04/virtualbox-vm-auto-shutdown/vbox-shutdown.png"/></div></div><p class="tags">This entry was tagged as <a href="https://blog.ionelmc.ro/tag/python/"><span itemprop="keywords">python</span></a><a href="https://blog.ionelmc.ro/tag/virtualbox/"><span itemprop="keywords">virtualbox</span></a><a href="https://blog.ionelmc.ro/tag/windows/"><span itemprop="keywords">windows</span></a></p></div><p id="disqus_thread"/><noscript> Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </div></div></body></html>