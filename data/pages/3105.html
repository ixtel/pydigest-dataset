<html><body><div><div itemprop="articleBody"><p>If you're <a class="reference external" href="http://docs.python.org/2/library/unittest.html">unittest</a>-ing your code and that code issues some warnings using <a class="reference external" href="http://docs.python.org/2/library/warnings.html#warnings.warn">warnings.warn</a> you should make some assertions for those messages too.</p><p>You probably do it because you're deprecating some API in your library or want to inform the library user that he's doing something very bad. You should have some assertions so you're sure those warnings were issued.</p><p>There's <a class="reference external" href="http://docs.python.org/2/library/warnings.html#warnings.catch_warnings">warnings.catch_warnings</a> that you can use but it has a couple of issues:</p><ul class="simple"><li>Warnings already issues cannot be captured. They are stored in a magic <tt class="docutils literal">__warningregistry__</tt> module attribute. Which module depends on the stacklevel arguments and/or the caller. It's certainly not documented in the warnings module's <a class="reference external" href="http://docs.python.org/2/library/warnings.html#testing-warnings">testing section</a>.</li><li>Warnings are wrapped in objects, so if you want to just check some strings you have to do some additional processing.</li></ul><p>So here's a assert method that clears that nasty <tt class="docutils literal">__warningregistry__</tt> from every module. Note that the method expects the messages to be issued in the given order. It could be changed but I think this is good - if you can't predict the order from the test then you are probably testing too much code from a single test method.</p><p>There's also an <tt class="docutils literal">assertNoWarnings</tt> method but it just raises the warning as an exception instead of checking the message list. You should always be able to easily pinpoint causes of failures in tests.</p><div class="highlight"><pre><span/><span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>

<span class="k">class</span> <span class="nc">WarnAssertionsMixin</span><span class="p">:</span>
    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">assertNoWarnings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">"error"</span><span class="p">)</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">resetwarnings</span><span class="p">()</span>

    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">assertWarnings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Asserts that the given messages are issued in the given order.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">messages</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">"Use assertNoWarnings instead!"</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">(</span><span class="n">record</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">warning_list</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">"always"</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="s1">'__warningregistry__'</span><span class="p">):</span>
                    <span class="n">mod</span><span class="o">.</span><span class="n">__warningregistry__</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="k">yield</span>
            <span class="n">warning_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">warning_list</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span>
                <span class="n">messages</span><span class="p">,</span>
                <span class="n">warning_list</span>
            <span class="p">)</span>

<span class="c1"># to use it just include it in your testcase, eg:</span>
<span class="k">class</span> <span class="nc">MyTestCase</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">,</span> <span class="n">WarnAssertionsMixin</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div><p>If you don't like mucking with all the modules you could monkey patch the <a class="reference external" href="http://docs.python.org/2/library/warnings.html#warnings.warn">warnings.warn</a> method using the <a class="reference external" href="https://pypi.python.org/pypi/mock">mock</a> library. It won't work if you do things like <tt class="docutils literal">from warnings import warn</tt> but it's a bit shorter:</p><div class="highlight"><pre><span/><span class="kn">import</span> <span class="nn">mock</span>

<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">assertWarnings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">messages</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">"Use assertNoWarnings instead!"</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s2">"warnings.warn"</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_warnings</span><span class="p">:</span>
        <span class="k">yield</span>
        <span class="n">warning_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">call</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">mock_warnings</span><span class="o">.</span><span class="n">mock_calls</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span>
            <span class="n">messages</span><span class="p">,</span>
            <span class="n">warning_list</span>
        <span class="p">)</span>
</pre></div></div></div></body></html>