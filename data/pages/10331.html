<html><body><div><article class="markdown-body entry-content" itemprop="text"><p><a href="https://badge.fury.io/py/rma"><img alt="PyPI version" src="https://camo.githubusercontent.com/685282ccd6d8ba2957d74f9a6e6936e31ad96415/68747470733a2f2f62616467652e667572792e696f2f70792f726d612e737667" data-canonical-src="https://badge.fury.io/py/rma.svg"/>
</a> <a href="https://travis-ci.org/gamenet/redis-memory-analyzer"><img alt="Build Status" src="https://camo.githubusercontent.com/9b649cb635b959702fecffcdb453086e1c48b7b9/68747470733a2f2f7472617669732d63692e6f72672f67616d656e65742f72656469732d6d656d6f72792d616e616c797a65722e7376673f6272616e63683d6d6173746572" data-canonical-src="https://travis-ci.org/gamenet/redis-memory-analyzer.svg?branch=master"/></a> <a href="https://landscape.io/github/gamenet/redis-memory-analyzer/master"><img alt="Code Health" src="https://camo.githubusercontent.com/73f4431b8cd63d01eb0ba8b4d722fb6d35318f2e/68747470733a2f2f6c616e6473636170652e696f2f6769746875622f67616d656e65742f72656469732d6d656d6f72792d616e616c797a65722f6d61737465722f6c616e6473636170652e7376673f7374796c653d666c61742d737175617265" data-canonical-src="https://landscape.io/github/gamenet/redis-memory-analyzer/master/landscape.svg?style=flat-square"/></a> <a href="https://raw.githubusercontent.com/gamenet/redis-memory-analyzer/master/LICENSE"><img alt="GitHub license" src="https://camo.githubusercontent.com/890acbdcb87868b382af9a4b1fac507b9659d9bf/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f6c6963656e73652d4d49542d626c75652e737667" data-canonical-src="https://img.shields.io/badge/license-MIT-blue.svg"/>
</a></p>
<a name="user-content-redis-memory-analyzer"/>
<h2><a id="user-content-redis-memory-analyzer" class="anchor" href="#redis-memory-analyzer" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Redis Memory Analyzer</h2>
<p>RMA is a console tool to scan Redis key space in real time and aggregate
memory usage statistic by key patterns. You may use this tools without
maintenance on production servers. You can scanning by all or selected
Redis types such as "string", "hash", "list", "set", "zset" and use
matching pattern as you like. RMA try to discern key names by patterns,
for example if you have keys like 'user:100' and 'user:101' application
would pick out common pattern 'user:*' in output so you can analyze
most memory distressed data in your instance.</p>
<a name="user-content-installing-rma"/>
<h3><a id="user-content-installing-rma" class="anchor" href="#installing-rma" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Installing rma</h3>
<p>Pre-Requisites :</p>
<ol>
<li>python &gt;= 3.4 and pip.</li>
<li>redis-py.</li>
</ol>
<p>To install from PyPI (recommended) :</p>
<pre>pip install rma
</pre>
<p>To install from source :</p>
<pre>git clone https://github.com/gamenet/redis-memory-analyzer
cd redis-memory-analyzer
sudo python setup.py install
</pre>
<a name="user-content-running"/>
<h4><a id="user-content-running" class="anchor" href="#running" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Running</h4>
<p>After install used it from console:</p>
<pre>&gt;rma --help
usage: rma [-h] [-s HOST] [-p PORT] [-a PASSWORD] [-d DB] [-m MATCH] [-l LIMIT]
           [-b BEHAVIOUR] [-t TYPES]

RMA is used to scan Redis key space in and aggregate memory usage statistic by
key patterns.

optional arguments:
  -h, --help                 show this help message and exit
  -s, --server HOST          Redis Server hostname. Defaults to 127.0.0.1
  -p, --port PORT            Redis Server port. Defaults to 6379
  -a, --password PASSWORD    Password to use when connecting to the server
  -d, --db DB                Database number, defaults to 0
  -m, --match MATCH          Keys pattern to match
  -l, --limit LIMIT          Get max key matched by pattern
  -b, --behaviour BEHAVIOUR  Specify application working mode. Allowed values
                             areall, scanner, ram, global
  -t, --type TYPES           Data types to include. Possible values are string,
                             hash, list, set. Multiple types can be provided. If
                             not specified, all data types will be returned.
                             Allowed values arestring, hash, list, set, zset
</pre>
<p>If you have large database try running first with <code>--limit</code> option to
run first limited amount of keys. Also run with <code>--types</code> to limit
only specified Redis types in large database. Not this tool has
performance issues - call encoding for individual keys instead if batch
queue with LUA (like in scanner does). So this option may be very
useful. You can choose what kind of data would be aggregated from Redis
node using <code>-b (--behaviour)</code> option as console argument. Supported
behaviours are 'global', 'scanner', 'ram' and 'all'.</p>
<a name="user-content-internals"/>
<h4><a id="user-content-internals" class="anchor" href="#internals" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Internals</h4>
<p>RMA shows statistics separated by types. All works in application
separated by few steps:</p>
<ol>
<li>Load type and encoding for each key matched by given pattern with Lua
scripting in batch mode. <code>SCAN</code> used to iterate keys from Redis key
db.</li>
<li>Separate keys by types and match patterns.</li>
<li>Run behaviours and rules for given data set.</li>
<li>Output result with given reported (now only TextReported implemented)</li>
</ol>
<a name="user-content-global-output-global-behaviour"/>
<h3><a id="user-content-global-output-global-behaviour" class="anchor" href="#global-output-global-behaviour" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Global output ('global' behaviour)</h3>
<p>The global data is some Redis server statistics which helps you to
understand other data from this tools:</p>
<pre>| Stat                             | Value          |
|:---------------------------------|:---------------|
| Total keys in db                 | 28979          |
| RedisDB key space overhead       | 790528         |
| Used `set-max-intset-entries`    | 512            |
| ....                             | ...            |
| Info `total_system_memory`       | 3190095872     |
| ....                             | ...            |
</pre>
<p>The one of interesting things here is "RedisDB key space overhead". The
amount of memory used Redis to store key space data. If you have lots of
keys in your Redis instance this actually shows your overhead for this.
Keep in mind that part of data such as total keys in db or key space overhead
shows data for selected db. But statistics started with <code>Info</code> or <code>Config</code>
keywords is server based.</p>
<a name="user-content-key-types-scanner-behaviour"/>
<h3><a id="user-content-key-types-scanner-behaviour" class="anchor" href="#key-types-scanner-behaviour" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Key types ('scanner' behaviour)</h3>
<p>This table helps then you do not know actually that kind of keys stored
in your Redis database. For example then DevOps or system administrator
want to understand what kind of keys stored in Redis instance. Which
data structure is most used in system. This also helps if you are new to
some big project - this kind of <code>SHOW ALL TABLES</code> request :)</p>
<pre>| Match                 |   Count | Type   | %      |
|:----------------------|--------:|:-------|:-------|
| job:*                 |    5254 | hash   | 18.13% |
| game:privacy:*        |    2675 | hash   | 9.23%  |
| user:*                |    1890 | hash   | 6.52%  |
| group:*               |    1885 | set    | 6.50%  |
</pre>
<a name="user-content-data-related-output-ram-behaviour"/>
<h3><a id="user-content-data-related-output-ram-behaviour" class="anchor" href="#data-related-output-ram-behaviour" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Data related output ('ram' behaviour)</h3>
<p>All output separated by keys and values statistics. This division is
used because: 1. Keys of any type in Redis actually stored in RedisDB
internal data structure based on dict (more about this on
<a href="http://redisplanet.com/">RedisPlanet</a>). 2. This type of data
specially important in Redis instances with lots of keys.</p>
<pre>| Match                         | Count | Useful |   Real | Ratio | Encoding                     | Min | Max |   Avg |
|:------------------------------|------:|-------:|-------:|------:|:-----------------------------|----:|----:|------:|
| event:data:*                  |  1198 |  17970 |  76672 |  4.27 | embstr [50.0%] / raw [50.0%] |  15 |  71 | 41.20 |
| mm:urllist:*                  |   524 |   7648 |  33536 |  4.38 | embstr [100.0%]              |  12 |  15 | 14.60 |
| Provider:ParallelForm:*:*:*:* |   459 |  43051 |  66096 |  1.54 | raw [100.0%]                 |  92 |  94 | 93.79 |
| user:spamblocked:dialy:post:* |    48 |   2208 |   4608 |  2.09 | raw [100.0%]                 |  46 |  46 | 46.00 |
| ...                           |   ... |    ... |    ... |   ... |                          ... | ... | ... |   ... |
| Total:                        |  2432 |  80493 | 200528 |  0.00 |                              |   0 |   0 |  0.00 |
</pre>
<p>So you can see count of keys matching given pattern, expected (by
developer) and real memory with taking into account the Redis data
structures and allocator overhead. Ratio and encoding distribution
min/max/avg len of key. For example in sample above keys some keys
encoded as <code>raw</code> (sds string). Each sds encoded string:</p>
<ol>
<li>Has useful payload</li>
<li>Has sds string header overhead</li>
<li>Has <code>redis object</code> overhead</li>
<li>The Redis implementation during memory allocation would be
align(redis object) + align(sds header + useful payload)</li>
</ol>
<p>In x64 instance of Redis key <code>event:data:f1wFFqgqqwgeg</code> (24 byte len)
actually would use 24 bytes payload bytes, 9 bytes sds header and 32
bytes in r_obj (<code>redis object</code>). So we may think this would use 65
bytes. But after jemalloc allocator align it this 24 byte (65 byte data
with Redis internals) would use 80 bytes - in ~3,3 more times as you
expect (`Ratio`` value in table).</p>
<p>Not we can look at values. All values output individual by Redis type.
Each type has they own limitations so here is some common data for each
type and some unique. The <code>strings</code> data type value same as keys
output above. The only one difference is <code>Free</code> field which shows
unused but allocated memory by SDS strings in <code>raw</code> encoding.</p>
<p>So for example look at output for <code>HASH</code> values:</p>
<pre>| Match                 | Count | Avg field count | Key mem |   Real | Ratio | Value mem |   Real |    Ratio |   System | Encoding         | Total mem |  Total aligned |
|:----------------------|------:|----------------:|--------:|-------:|------:|----------:|-------:|---------:|---------:|:-----------------|----------:|---------------:|
| job:*                 |  5254 |            9.00 |  299485 | 619988 |  2.07 |    685451 | 942984 |     1.38 |  1345024 | ziplist [100.0%] |    984936 |        2907996 |
| LIKE:*                |  1890 |            1.02 |    5744 |  30262 |  5.27 |      1932 |  15432 |     7.99 |    91344 | ziplist [100.0%] |      7676 |         137038 |
| game:*:count:*        |  1231 |            1.00 |    7386 |  19696 |  2.67 |      1234 |   9848 |     7.98 |    59088 | ziplist [100.0%] |      8620 |          88632 |
| LIKE:game:like:*      |  1207 |            1.00 |    3621 |  19312 |  5.33 |      1210 |   9656 |     7.98 |    57936 | ziplist [100.0%] |      4831 |          86904 |
| integration:privacy:* |   530 |            3.00 |   20140 |  33920 |  1.68 |         0 |  25440 | 25440.00 |    42400 | ziplist [100.0%] |     20140 |         101760 |
</pre>
<p>Look at <code>job:*</code> hashes. This instance contains 5254 such keys with 9
fields each. Looks like this data has regular structure like python
tuple. This means you can change data structure of this data from Redis
<code>hash</code> to <code>list</code> and use 2 times less memory then now. Why do this?
Now you <code>job:*</code> hash uses ~3,2 times more memory as you developers
expect.</p>
<a name="user-content-why-doesn-t-reported-memory-match-actual-memory-used"/>
<h3><a id="user-content-why-doesnt-reported-memory-match-actual-memory-used" class="anchor" href="#why-doesnt-reported-memory-match-actual-memory-used" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Why doesn't reported memory match actual memory used?</h3>
<p>The memory reported by this tool is approximate. In general, the
reported memory should be within 10% of what is reported by
<a href="http://redis.io/commands/info">info</a>.</p>
<p>Also note that the tool does not (and cannot) account for the following:
- Memory used by allocator metadata (it is actually not possible without <code>c</code>)
- Memory used for pub/sub (no any commands in Redis for that)
- Redis process internals (like shared objects)</p>
<a name="user-content-known-issues"/>
<h3><a id="user-content-known-issues" class="anchor" href="#known-issues" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Known issues</h3>
<ol>
<li><code>Skiplist</code> (<code>zset</code> actually) encoding actually not realized.</li>
<li><code>Quicklist</code> now calculated as <code>ziplist</code>.</li>
<li>SDS strings from redis 3.2 (optimized headers) not implemented. Now
used fixed 9 bytes header.</li>
</ol>
<a name="user-content-whats-next"/>
<h3><a id="user-content-whats-next" class="anchor" href="#whats-next" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Whats next?</h3>
<p>Now we use this tools as awesome helper. We most used data structures in
our Redis instances is <code>hash</code> and <code>list</code>. After upgradings our
servers to Redis 3.2.x planning to fix known issues. Be glad to know
that are you think about this tool. In my dreams this tools should used
as <code>redis-lint</code> tools which can say you
<code>Hey, change this from this to this and save 30% of RAM</code>,
<code>Hey, you are using PHP serializer for strings - change to msgpack and save 15% of RAM</code>
and so on.</p>
<a name="user-content-license"/>
<h4><a id="user-content-license" class="anchor" href="#license" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>License</h4>
<p>This application was developed for using in
<a href="https://gamenet.ru/">GameNet</a> project as part of Redis memory
optimizations and analise. RMA is licensed under the MIT License. See
<a href="https://github.com/gamenet/redis-memory-analyzer/blob/master/LICENSE">LICENSE</a></p>

</article>
  </div></body></html>