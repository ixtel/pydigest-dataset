<html><body><div><div class="post-1501 post type-post status-publish format-standard has-post-thumbnail hentry category-flask-framework-tutorials-and-examples category-git-linux-tutorials category-python tag-flask-github-webhook-handler">
                <p>
                            <a href="" rel="nofollow"><img src="http://techarena51.com/wp-content/uploads/2015/07/github-webhooks-flask.png" alt="Continuously deploying your Flask/Python code  to your Linux production server with GitHub webhooks" align="left" class="affiliate-image"/></a>
                        </p><p>In this article I will describe how you can deploy your Flask or python code in your GitHub Repository to your Linux production server as soon as you have committed a change.</p>
<p><strong>What is a GitHub Webhook?</strong><br/>
GitHub Webhooks allow you to set triggers for specific events like a PUSH to your GitHub repository. When an event occurs GitHub will send a HTTP POST payload which contains data regarding your commit to the URL you have configured in your webhook settings.</p>
<p><strong>To Continuously Deploy your Flask/Python code to your Linux production server you need to</strong>:</p>
<ol>
<li>Write a Flask GitHub Webhook handler script that will pull changes to your production server when it receives the payload from GitHub.</li>
<li>Add a GitHub Webhook which will notify your script that an event such as PUSH has occurred on your GitHub repository.</li>
</ol>
<p><strong>Step 1: Creating and deploying the Flask GitHub WebHook handler script</strong></p>
<pre class="brush: python; title: ; notranslate" title="">
#Compare the HMAC hash signature
def verify_hmac_hash(data, signature):
    GitHub_secret = bytes('some secret', 'UTF-8')
    mac = hmac.new(GitHub_secret, msg=data, digestmod=hashlib.sha1)
    return hmac.compare_digest('sha1=' + mac.hexdigest(), signature)

#Flask route that will process the payload
@app.route("/payload", methods=['POST'])
def GitHub_payload():
    signature = request.headers.get('X-Hub-Signature')
    data = request.data
    if verify_hmac_hash(data, signature):
        if request.headers.get('X-GitHub-Event') == "ping":
            return jsonify({'msg': 'Ok'})
        if request.headers.get('X-GitHub-Event') == "push":
            payload = request.get_json()
            if payload['commits'][0]['distinct'] == True:
                try:
                    cmd_output = subprocess.check_output(
                        ['git', 'pull', 'origin', 'master'],)
                    return jsonify({'msg': str(cmd_output)})
                except subprocess.CalledProcessError as error:
                    return jsonify({'msg': str(error.output)})

    else:
        return jsonify({'msg': 'invalid hash'})
</pre>
<p>The complete code is available at https://GitHub.com/Leo-g/Flask-GitHub-Webhooks/blob/master/GitHub-webhook.py .</p>
<p>The first function in our GitHub Webhook Handler is a hash compare. While configuring a webhook you will need to set a  secret  which will be used to generate a hash signature. GitHub will send this hash signature along with each request in the headers as “X-Hub-Signature”. Comparing the hash signature is the recommended way to secure your repository and ensure that the request came from your GitHub repository. GitHub uses a HMAC hexdigest to compute a hash signature, hence I have used the hmac module to generate and compare hashes, you can read more about the module and its methods in the docs at the end of the article.</p>
<p>Next I defined an endpoint for the URL where I want to receive the GitHub payload via Flask routes<br/>
“@app.route(“/payload”, methods=['POST'])” . A POST request to this URL will call the function GitHub_payload(). The function GitHub_payload() will first verify the hash signature and then return a response accordingly for the PING and PUSH events. In case of a PUSH event it will also run the “git pull “ command. The output of the command will be returned in the response. This will allow you to check if the pull was a success or not.</p>
<p><strong>Deploying the script on your Linux production server</strong></p>
<p>First Clone the script</p>
<pre>   [leo@linux-production]$ git clone git@GitHub.com:Leo-g/Flask-GitHub-Webhooks-Handler.git
</pre>
<p>Next install flask</p>
<pre>[leo@linux-production]$ cd    Flask-GitHub-Webhooks-Handler
[leo@linux-production Flask-GitHub-Webhooks]$ pip install -r requirements.txt         
</pre>
<p>Set your secret in an environment variable named GitHub_SECRET</p>
<pre>[leo@linux-production Flask-GitHub-Webhooks]$ export GitHub_SECRET="some secret"
</pre>
<p>Add your IP address</p>
<pre>[leo@linux-production Flask-GitHub-Webhooks]$ vim GitHub-webhook.py

app.run(host="YourIP")

</pre>
<p>Run the script</p>

<p>


</p>

<pre>[leo@linux-production Flask-GitHub-Webhooks]$ python3.4 GitHub-webhook.py 
 * Running on http://YourIP:5000/ (Press CTRL+C to quit)
 * Restarting with stat
</pre>
<p><strong>Step 2: Adding a GitHub webhook to your repository</strong></p>
<p>To add a GitHub WebHook to your repository you need to go to<br/>
https://GitHub.com/Leo-g/Flask-GitHub-Webhooks-Handler/settings/hooks (Replace Flask-GitHub-Webhooks-Handler  with the name of your repository)</p>
<p><a href="http://techarena51.com/wp-content/uploads/2015/07/github-webhooks-handler.png"><br/>
</a> <a href="http://techarena51.com/wp-content/uploads/2015/07/github-webhooks-python.png"><img class="aligncenter wp-image-1506 size-full" src="http://techarena51.com/wp-content/uploads/2015/07/github-webhooks-python.png" alt="flask github webhook handler"/></a></p>
<p>Here you need to fill out the following fields:<br/>
<em>Payload URL</em> : Add “yourdomain.com/payload”<br/>
<em>Content type</em> : Select json<br/>
<em>Secret</em> : Add the same secret you used in your script to generate the HMAC hash.<br/>
<em>Which events you like to trigger this webhook?</em> : Select the push event for this tutorial.</p>
<p>Select the <em>Active</em> checkbox and click on <em>Add webhook</em> to start receiving notifications.</p>
<p>You should immediately receive a ping event.</p>
<p>If you received a “200 ok” response then you should be able to continuous deploy your GitHub code to your Linux production server in the event of a PUSH..( Make sure to add this script in the directory which contains your git repo information)</p>
<p><a href="http://techarena51.com/wp-content/uploads/2015/07/github-webhooks-handler.png"><img class="aligncenter size-full wp-image-1504" src="http://techarena51.com/wp-content/uploads/2015/07/github-webhooks-handler.png" alt="flask github webhook handler"/></a></p>
<p>Here is video of the whole process.</p>
<p>Video<br/>
<iframe src="https://www.youtube.com/embed/bqfoYehAL6c" frameborder="0" allowfullscreen="allowfullscreen">VIDEO</iframe></p>
<p>References:</p>
<p>https://developer.GitHub.com/webhooks/securing/</p>
<p>http://githooks.com/</p>
<p>https://developer.GitHub.com/webhooks/</p>
<p>https://docs.python.org/3/library/hmac.html
</p>

<p/>
                         <div class="abh_box abh_box_down abh_box_business"><div class="abh_tab_content"><section class="vcard abh_about_tab abh_tab"><div class="abh_text"><p class="abh_job"/><p class="description note abh_description">Is a Technical project manager who through this blog shares his experience building Web Applications with Python, FlaskAngularjs and Linux.His Projects are opensource and available at https://github.com/Leo-g</p></div> </section><section class="abh_posts_tab abh_tab"><div class="abh_text"><h4>Latest posts by Leo G <span class="abh_allposts">(<a href="http://techarena51.com/index.php/author/leo/">see all</a>)</span></h4></div> </section></div> </div>        <p class="clear"/>
                
    </div>
    
    
        
</div></body></html>