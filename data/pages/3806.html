<html><body><div><div class="right_panel">
    <a href="/blog/2015/03/getting-started-with-django-tastypie/" class="noline"><h1 class="post_title" itemprop="headline">Getting started with Django tastypie</h1></a>
    
    
      <p/><p>Django tastypie is a library to write RESTful apis in Django.</p>
<h3>Why use REST</h3>
<p>You have a database backed web application. This application tracks expenses. The application allows the capability to enter your expenses, view all your expenses, delete an expense etc. Essentially this application provides CRUD functionality. Django application has access to database credentials, but they are never seen by the users of the web application. Django application decides what to show to which user. Django application ensures that a particular user only sees the expenses entered by him and not somebody else's expenses.</p>
<p>Now you want to provide a mobile application (Android or iOS) corresponding to this web application. Android application should allow the user to view his expenses, create an expense as well as any other CRUD functionality. But database credentials could not be put in Android code as it is not too hard to decompile an apk and get the db credentials. And we never want a user to get the db credentials else he will be in a position to see everyone's expenses and the entire database. So there has to be another way to allow mobile applications to get things from the database. This is where REST comes into picture.</p>
<p>With REST, we have three components. A database, a Django application and a mobile application. Mobile application never accesses the database directly. It makes a REST api call to Django application. Mobile application also sends a api_key specific to the mobile user. Based on api_key, Django application determines what data to make visible to this particular api_key owner and sends the corresponding data in response.</p>
<h3>Resource</h3>
<p>REST stands for Representational State Transfer. It is a standard for transferring the state of a <strong>Resource</strong>, from web to mobile.</p>
<h4>What do I mean by <strong>state of a Resource</strong>?</h4>
<p>An expense could be a resource. A Person could be a resource. A blog post could be a resource. Basically any object or instance your program deals with could be a resource. And a resource's state is maintained in it's attributes. eg: You could have a model called Expense. The state of a expense instance is represented by its attributes.</p>
<p>Any REST library should be able to create and return a representation of such resource, which simply stated means that REST library should be able to tell us the attributes and their values for different model instances. And tastypie is adept at doing this.</p>
<h3>Setting up the application</h3>
<p>I am using Django 1.7. Some things might be different for you if you are using different version of Django.</p>
<p>As with all projects, I want to keep things in a virtual environment</p>
<div class="highlight"><pre><span class="err">$</span> <span class="n">mkvirtualenv</span> <span class="n">tastier</span>
<span class="err">$</span> <span class="n">workon</span> <span class="n">tastier</span>
</pre></div>


<p>Install Django</p>



<p>Start a Django project</p>
<div class="highlight"><pre><span class="p">(</span><span class="n">tastier</span><span class="p">)</span> <span class="err">$</span> <span class="n">django</span><span class="o">-</span><span class="n">admin</span><span class="p">.</span><span class="n">py</span> <span class="n">startproject</span> <span class="n">tastier</span>

<span class="p">(</span><span class="n">tastier</span><span class="p">)</span> <span class="err">$</span> <span class="n">cd</span> <span class="n">tastier</span><span class="o">/</span>
</pre></div>


<p>Start an app</p>
<div class="highlight"><pre><span class="p">(</span><span class="n">tastier</span><span class="p">)</span> <span class="err">$</span> <span class="n">python</span> <span class="n">manage</span><span class="p">.</span><span class="n">py</span> <span class="n">startapp</span> <span class="n">expenses</span>
</pre></div>


<p>Add this app to INSTALLED_APPS</p>
<p>Run migration</p>
<div class="highlight"><pre><span class="p">(</span><span class="n">tastier</span><span class="p">)</span><span class="o">~</span> <span class="err">$</span> <span class="n">python</span> <span class="n">manage</span><span class="p">.</span><span class="n">py</span> <span class="n">migrate</span>
</pre></div>


<p>Runserver</p>
<div class="highlight"><pre><span class="p">(</span><span class="n">tastier</span><span class="p">)</span><span class="o">~</span> <span class="err">$</span> <span class="n">python</span> <span class="n">manage</span><span class="p">.</span><span class="n">py</span> <span class="n">runserver</span>
</pre></div>


<p>Check that your are able to access http://localhost:8000/admin/login/</p>
<p>I have pushed the code for this project to <a href="https://github.com/akshar-raaj/tastier" target="_blank">Github</a>. You will be able to checkout at different commits in the project to see specific things.</p>
<h3>Getting started</h3>
<p>Install django-tastypie.</p>
<div class="highlight"><pre><span class="p">(</span><span class="n">tastier</span><span class="p">)</span> <span class="err">$</span> <span class="n">pip</span> <span class="n">install</span> <span class="n">django</span><span class="o">-</span><span class="n">tastypie</span>
</pre></div>


<p>Create a file called <code>expenses/api.py</code> where you will keep all the tastypie related things.</p>
<p>Suppose your program deals with a resource called Expense. Let's create a model Expense in expenses/models.py</p>
<div class="highlight"><pre><span class="n">class</span> <span class="n">Expense</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">)</span><span class="o">:</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">amount</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">IntegerField</span><span class="p">()</span>
</pre></div>


<p>Run migrations</p>
<div class="highlight"><pre><span class="n">python</span> <span class="n">manage</span><span class="p">.</span><span class="n">py</span> <span class="n">makemigrations</span>
<span class="n">python</span> <span class="n">manage</span><span class="p">.</span><span class="n">py</span> <span class="n">migrate</span>
</pre></div>


<p>We will later add a ForeignKey(User) to Expense to associate an expense with User. Don't worry about it for now, we will come back to it.</p>
<p>Let's add few Expense instances in the database.</p>
<div class="highlight"><pre><span class="n">Expense</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="err">'</span><span class="n">Ate</span> <span class="n">pizza</span><span class="err">'</span><span class="p">,</span> <span class="n">amount</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">Expense</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="err">'</span><span class="n">Went</span> <span class="n">to</span> <span class="n">Cinema</span><span class="err">'</span><span class="p">,</span> <span class="n">amount</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
</pre></div>


<h3>Handling GET</h3>
<p>You want the ability to get the representation of all expenses in your program at url "http://localhost:8000/api/expenses/".</p>
<p>To deal with a resource, tastypie requires a class which overrides <strong>ModelResource</strong>. Let's call our class <strong>ExpenseResource</strong>. Add following to expenses/api.py</p>
<div class="highlight"><pre><span class="n">from</span> <span class="n">tastypie</span><span class="p">.</span><span class="n">resources</span> <span class="n">import</span> <span class="n">ModelResource</span>

<span class="n">from</span> <span class="p">.</span><span class="n">models</span> <span class="n">import</span> <span class="n">Expense</span>

<span class="n">class</span> <span class="n">ExpenseResource</span><span class="p">(</span><span class="n">ModelResource</span><span class="p">)</span><span class="o">:</span>

    <span class="n">class</span> <span class="n">Meta</span><span class="o">:</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="n">Expense</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">resource_name</span> <span class="o">=</span> <span class="err">'</span><span class="n">expense</span><span class="err">'</span>
</pre></div>


<p>And you need to add the following to tastier/urls.py</p>
<div class="highlight"><pre><span class="n">from</span> <span class="n">expenses</span><span class="p">.</span><span class="n">api</span> <span class="n">import</span> <span class="n">ExpenseResource</span>

<span class="n">expense_resource</span> <span class="o">=</span> <span class="n">ExpenseResource</span><span class="p">()</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="err">''</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="n">r</span><span class="err">'</span><span class="o">^</span><span class="n">admin</span><span class="o">/</span><span class="err">'</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">admin</span><span class="p">.</span><span class="n">site</span><span class="p">.</span><span class="n">urls</span><span class="p">)),</span>
    <span class="n">url</span><span class="p">(</span><span class="n">r</span><span class="err">'</span><span class="o">^</span><span class="n">api</span><span class="o">/</span><span class="err">'</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">expense_resource</span><span class="p">.</span><span class="n">urls</span><span class="p">)),</span>
<span class="p">)</span>
</pre></div>


<h4>GET all expenses</h4>
<p>After this you should be able to hit</p>
<div class="highlight"><pre><span class="nl">http:</span><span class="c1">//localhost:8000/api/expense/?format=json</span>
</pre></div>


<p>and you will see all the expenses from database in the response.</p>
<p>The response would be:</p>
<div class="highlight"><pre><span class="p">{</span><span class="s">"meta"</span><span class="o">:</span> <span class="p">{</span><span class="s">"limit"</span><span class="o">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s">"next"</span><span class="o">:</span> <span class="n">null</span><span class="p">,</span> <span class="s">"offset"</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"previous"</span><span class="o">:</span> <span class="n">null</span><span class="p">,</span> <span class="s">"total_count"</span><span class="o">:</span> <span class="mi">2</span><span class="p">},</span> <span class="s">"objects"</span><span class="o">:</span> <span class="p">[{</span><span class="s">"amount"</span><span class="o">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s">"description"</span><span class="o">:</span> <span class="s">"Ate pizza"</span><span class="p">,</span> <span class="s">"id"</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">"resource_uri"</span><span class="o">:</span> <span class="s">"/api/expense/1/"</span><span class="p">},</span> <span class="p">{</span><span class="s">"amount"</span><span class="o">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s">"description"</span><span class="o">:</span> <span class="s">"Went to Cinema"</span><span class="p">,</span> <span class="s">"id"</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">"resource_uri"</span><span class="o">:</span> <span class="s">"/api/expense/2/"</span><span class="p">}]}</span>
</pre></div>


<p>You will find the representation of <code>expense</code> instances in <strong>objects</strong> key of response.</p>
<h4>Get a particular expense</h4>
<p>You can get the representation of expense with id 1 at</p>
<div class="highlight"><pre><span class="nl">http:</span><span class="c1">//localhost:8000/api/expense/1/?format=json</span>
</pre></div>


<p>See how you are able to hit these two urls without adding them in urlpatterns. These urlpatterns are added by tastypie internally.</p>
<h4>How these endpoints help and ties with mobile application example?</h4>
<p>If the mobile app wants to show all the expenses it could use the url <strong>http://localhost:8000/api/expense/?format=json</strong>, get the response, parse the response and show the result on app.</p>
<p>Right now every user will see all the expenses. As we move forward we will see how only a user's expenses will be returned when a REST call is made from his/her mobile device.</p>
<h4>Serialization</h4>
<p>You must have realized that REST returns you serialized data. You might be wondering why use django-tastypie to achieve it, and not just use json.dumps. You can undoubtedly use json.dumps and not use django-tastypie to provide REST endpoints. But django-tastypie allows the ability to do many more things very easily as you will soon agree. Just hang on.</p>
<h4>Changing Meta.resource_name</h4>
<p>You can change ExpenseResource.Meta.resource_name from <code>expense</code> to <code>expenditure</code>.</p>
<div class="highlight"><pre><span class="n">class</span> <span class="n">ExpenseResource</span><span class="p">(</span><span class="n">ModelResource</span><span class="p">)</span><span class="o">:</span>

    <span class="n">class</span> <span class="n">Meta</span><span class="o">:</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="n">Expense</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">resource_name</span> <span class="o">=</span> <span class="err">'</span><span class="n">expenditure</span><span class="err">'</span>
</pre></div>


<p>And then the old urls will stop working. Your new GET urls in that case will be</p>
<div class="highlight"><pre><span class="nl">http:</span><span class="c1">//localhost:8000/api/expenditure/?format=json</span>
<span class="nl">http:</span><span class="c1">//localhost:8000/api/expenditure/1/?format=json</span>
</pre></div>


<p>Changing the resource_name changes the urls tastypie makes available to you.</p>
<p>Now change the resource_name back to <code>expense</code>.</p>
<p>We have our first commit at this point. You can checkout to this commit to see the code till this point.</p>



<h4>Meta.fields</h4>
<p>Suppose you only want <code>description</code> in expense representation, but don't want <code>amount</code>. So you can add a fields attribute on ExpenseResource.Meta</p>
<div class="highlight"><pre><span class="n">class</span> <span class="n">Meta</span><span class="o">:</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Expense</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">resource_name</span> <span class="o">=</span> <span class="err">'</span><span class="n">expenditure</span><span class="err">'</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="err">'</span><span class="n">description</span><span class="err">'</span><span class="p">]</span>
</pre></div>


<p>Try</p>
<div class="highlight"><pre><span class="nl">http:</span><span class="c1">//localhost:8000/api/expense/?format=json</span>
</pre></div>


<p>So if you don't have <strong>fields</strong> attribute on Meta, all the attributes of Model will be sent in response. If you have <strong>fields</strong>, only attributes listed in fields will be sent in response.</p>
<p>Let's add <code>amount</code> also to <code>fields</code>. Though this gives us the same behaviour as not having ExpenseResource.Meta.fields at all.</p>
<div class="highlight"><pre><span class="n">class</span> <span class="n">Meta</span><span class="o">:</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Expense</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">resource_name</span> <span class="o">=</span> <span class="err">'</span><span class="n">expenditure</span><span class="err">'</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="err">'</span><span class="n">description</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="n">amount</span><span class="err">'</span><span class="p">]</span>
</pre></div>


<p>We have our second commit at this point. You can checkout till this point by doing:</p>



<h4>Filtering</h4>
<p>Suppose you only want the Expenses where amount exceeds 150.</p>
<p>If we had to do this with Django model we would say:</p>
<div class="highlight"><pre><span class="n">Expense</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">filter</span><span class="p">(</span><span class="n">amount__gt</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
</pre></div>


<p><strong>amount__gt</strong> is the key thing here. This could be appended to our url pattern to get the expenses where amount exceeds 150.</p>
<p>This could be achieved at url</p>
<div class="highlight"><pre><span class="nl">http:</span><span class="c1">//localhost:8000/api/expense/?amount__gt=150&amp;format=json</span>
</pre></div>


<p>Try this. You will get an error because we haven't asked tastypie to allow filtering yet.</p>
<p>Add <strong>filtering</strong> attribute to ExpenseResource.Meta</p>
<div class="highlight"><pre><span class="n">class</span> <span class="n">Meta</span><span class="o">:</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Expense</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">resource_name</span> <span class="o">=</span> <span class="err">'</span><span class="n">expense</span><span class="err">'</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="err">'</span><span class="n">description</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="n">amount</span><span class="err">'</span><span class="p">]</span>
    <span class="n">filtering</span> <span class="o">=</span> <span class="p">{</span>
        <span class="err">'</span><span class="n">amount</span><span class="err">'</span><span class="o">:</span> <span class="p">[</span><span class="err">'</span><span class="n">gt</span><span class="err">'</span><span class="p">]</span>
    <span class="p">}</span>
</pre></div>


<p>You should be able to use</p>
<div class="highlight"><pre><span class="nl">http:</span><span class="c1">//localhost:8000/api/expense/?amount__gt=150&amp;format=json</span>
</pre></div>


<p>This will only return the expenses where amount exceeds 150.</p>
<p>Now we want to get all the expenses on Pizza. We could get pizza expenses in following way from shell.</p>
<div class="highlight"><pre><span class="n">Expense</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">filter</span><span class="p">(</span><span class="n">description__icontains</span><span class="o">=</span><span class="err">'</span><span class="n">pizza</span><span class="err">'</span><span class="p">)</span>
</pre></div>


<p>So to achieve this thing in api, we need to make following changes to ExpenseResource.Meta.filtering:</p>
<div class="highlight"><pre><span class="n">class</span> <span class="n">Meta</span><span class="o">:</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Expense</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">resource_name</span> <span class="o">=</span> <span class="err">'</span><span class="n">expense</span><span class="err">'</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="err">'</span><span class="n">description</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="n">amount</span><span class="err">'</span><span class="p">]</span>
    <span class="n">filtering</span> <span class="o">=</span> <span class="p">{</span>
        <span class="err">'</span><span class="n">amount</span><span class="err">'</span><span class="o">:</span> <span class="p">[</span><span class="err">'</span><span class="n">gt</span><span class="err">'</span><span class="p">],</span>
        <span class="err">'</span><span class="n">description</span><span class="err">'</span><span class="o">:</span> <span class="p">[</span><span class="err">'</span><span class="n">icontains</span><span class="err">'</span><span class="p">]</span>
    <span class="p">}</span>
</pre></div>


<p>And then following url would give us the pizza expenses</p>
<div class="highlight"><pre><span class="nl">http:</span><span class="c1">//localhost:8000/api/expense/?description__icontains=pizza&amp;format=json</span>
</pre></div>


<p>With GET endpoints we were able to do the Read operations. With POST we will be able to do Create operations, as we will see in next section.</p>
<h3>Handling POST</h3>
<p>It's hard to do POST from the browser. So we will use <strong>requests</strong> library to achieve this.</p>
<p>Check expense count before doing POST.</p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">Expense</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">count</span><span class="p">()</span>
<span class="mi">2</span>
</pre></div>


<p>Tastypie by default doesn't authorize a person to do POST request. The default authorization class is <strong>ReadOnlyAuthorization</strong> which allows GET calls but doesn't allow POST calls. So you will have to disallow authorization checks for the time being. Add the following to ExpenseResource.Meta</p>
<div class="highlight"><pre><span class="n">authorization</span> <span class="o">=</span> <span class="n">Authorization</span><span class="p">()</span>
</pre></div>


<p>You'll need to import <code>Authorization</code> class for it.</p>
<div class="highlight"><pre><span class="n">from</span> <span class="n">tastypie</span><span class="p">.</span><span class="n">authorization</span> <span class="n">import</span> <span class="n">Authorization</span>
</pre></div>


<p>After this, ExpenseResource would look like:</p>
<div class="highlight"><pre><span class="n">class</span> <span class="n">ExpenseResource</span><span class="p">(</span><span class="n">ModelResource</span><span class="p">)</span><span class="o">:</span>

    <span class="n">class</span> <span class="n">Meta</span><span class="o">:</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="n">Expense</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">resource_name</span> <span class="o">=</span> <span class="err">'</span><span class="n">expense</span><span class="err">'</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="err">'</span><span class="n">description</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="n">amount</span><span class="err">'</span><span class="p">]</span>
        <span class="n">filtering</span> <span class="o">=</span> <span class="p">{</span>
            <span class="err">'</span><span class="n">amount</span><span class="err">'</span><span class="o">:</span> <span class="p">[</span><span class="err">'</span><span class="n">gt</span><span class="err">'</span><span class="p">],</span>
            <span class="err">'</span><span class="n">description</span><span class="err">'</span><span class="o">:</span> <span class="p">[</span><span class="err">'</span><span class="n">icontains</span><span class="err">'</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">authorization</span> <span class="o">=</span> <span class="n">Authorization</span><span class="p">()</span>
</pre></div>


<p>Don't get into detail of Authorization for now, I will come back to it.</p>
<p>Let's make a POST request to our rest endpoint which will create an Expense object in the database.</p>
<div class="highlight"><pre><span class="n">post_url</span> <span class="o">=</span> <span class="err">'</span><span class="n">http</span><span class="o">:</span><span class="c1">//localhost:8000/api/expense/'</span>
<span class="n">post_data</span> <span class="o">=</span> <span class="p">{</span><span class="err">'</span><span class="n">description</span><span class="err">'</span><span class="o">:</span> <span class="err">'</span><span class="n">Bought</span> <span class="n">first</span> <span class="n">Disworld</span> <span class="n">book</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="n">amount</span><span class="err">'</span><span class="o">:</span> <span class="mi">399</span><span class="p">}</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="err">'</span><span class="n">Content</span><span class="o">-</span><span class="n">type</span><span class="err">'</span><span class="o">:</span> <span class="err">'</span><span class="n">application</span><span class="o">/</span><span class="n">json</span><span class="err">'</span><span class="p">}</span>
<span class="n">import</span> <span class="n">requests</span>
<span class="n">import</span> <span class="n">json</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">post_url</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">post_data</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">print</span> <span class="n">r</span><span class="p">.</span><span class="n">status_code</span>
<span class="mi">201</span>
</pre></div>


<p>status_code 201 means that your Expense object was properly created. You can also verify it by checking that Expense count increased by 1.</p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">Expense</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">count</span><span class="p">()</span>
<span class="mi">3</span>
</pre></div>


<p>If you hit the GET endpoint from your browser, you will see this new Expense object too in the response. Try</p>
<div class="highlight"><pre><span class="nl">http:</span><span class="c1">//localhost:8000/api/expense/?format=json</span>
</pre></div>


<p>We have third commit at this point.</p>



<h4>Explanation of POST</h4>
<ul>
<li>You need to POST at the same url where you get all the expenses. Compare the two urls.</li>
<li>One way of posting is to POST json encoded data. So we used json.dumps</li>
<li>If you are sending json encoded data, you need to send appopriate Content-type header too.</li>
</ul>
<p><br/></p>
<h4>How this ties in with mobile</h4>
<p>Android or iOS has a way to make POST request at a given url with headers. So you tell mobile app about the endpoint where they need to post and the data to post. They will call this rest endpoint, and the posted data will be handled by Django tastypie and proper row will be created in the database table.</p>
<h3>Adding authentication</h3>
<p>Currently GET and POST endpoints respond to every request. So even users who aren't registered with the site will be able to see the expenses. Our first step is ensuring that only registered users are able to use the GET endpoints.</p>
<h4>Api tokens and sessions</h4>
<p>In a web application, a user logs in once and then she is able to make any number of web requests without being asked to login every time. eg: User logs in once and then can see her expense list page. After first request she can refresh the page, and can still get response without being asked for her login credentials again. This works because Django uses sessions and cookies to store user state. So browser sends a cookie to Django everytime the user makes a request, and Django app can associate the cookie with a user and shows the data for this particular user.</p>
<p>With mobile apps, there is no concept of sessions, unless the mobile is working with a WebView. The session corresponding thing in a mobile app is Api key. So an api key is associated with a user. Every REST call should include this api key, and then tastypie can use this key to verify whether a logged in user is making the request.</p>
<h4>Creating user and api token</h4>
<p>Let's create an user in our system and a corresponding api token for her.</p>
<p>On a shell</p>
<div class="highlight"><pre><span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="err">'</span><span class="n">sheryl</span><span class="err">'</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="err">'</span><span class="n">abc</span><span class="err">'</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="err">'</span><span class="n">sheryl</span><span class="err">@</span><span class="n">abc</span><span class="p">.</span><span class="n">com</span><span class="err">'</span><span class="p">)</span>
</pre></div>


<p>Tastypie provides a model called ApiKey which allows storing tokens for users. Let's create a token for Sheryl.</p>
<div class="highlight"><pre><span class="n">from</span> <span class="n">tastypie</span><span class="p">.</span><span class="n">models</span> <span class="n">import</span> <span class="n">ApiKey</span>
<span class="n">ApiKey</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="err">'</span><span class="mi">1</span><span class="n">a23</span><span class="err">'</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">u</span><span class="p">)</span>
</pre></div>


<p>We are setting the api token for sheryl as '1a23'</p>
<p>You need to ensure tastypie is in INSTALLED_APPS and you have migrated before you could create ApiKey instance.</p>
<p>The default authentication class provided by tastypie is <strong>Authentication</strong> which allows anyone to make GET requests. We need to set ExpenseResource.Meta.authentication to ensure that only users who provide valid api key are able to get response from GET endpoints.</p>
<p>Add the following on ExpensesResource.Meta.</p>
<div class="highlight"><pre><span class="n">authentication</span> <span class="o">=</span> <span class="n">ApiKeyAuthentication</span><span class="p">()</span>
</pre></div>


<p>You need to import ApiKeyAuthentication.</p>
<div class="highlight"><pre><span class="n">from</span> <span class="n">tastypie</span><span class="p">.</span><span class="n">authentication</span> <span class="n">import</span> <span class="n">ApiKeyAuthentication</span>
</pre></div>


<p>Try the GET endpoint to get the list of expenses</p>
<div class="highlight"><pre><span class="nl">http:</span><span class="c1">//localhost:8000/api/expense/?format=json</span>
</pre></div>


<p>You will not see anything in response. If you see your runserver terminal, you'll notice that status code 401 is raised.</p>
<p>Api key should be sent in the request to get proper response.</p>
<p>Try the following url</p>
<div class="highlight"><pre><span class="nl">http:</span><span class="c1">//localhost:8000/api/expense/?format=json&amp;username=sheryl&amp;api_key=1a23</span>
</pre></div>


<p>With this Sheryl will be able to get proper api response.</p>
<p>Try sending wrong api_key for sheryl and you will not see proper response.</p>
<div class="highlight"><pre><span class="nl">http:</span><span class="c1">//localhost:8000/api/expense/?format=json&amp;username=sheryl&amp;api_key=1a2</span>
</pre></div>


<p>With these we ensure that only registered users of the system with proper api key will be able to make GET requests.</p>
<p>Fourth commit at this point</p>



<h4>How this ties in with mobile app</h4>
<p>When user installs the app, he logs in using his username and password for first time. These credentials are sent to Django server using a REST call. Django server returns the api key corresponding to this user to the mobile app. Mobile app stores this api token on mobile end and then uses this token for every subsequent REST call. User doesn't have to provide the credentials anymore.</p>
<h4>Making unauthenticated POST requests</h4>
<p>Unauthenticated POST requests will not work anymore</p>
<p>Try creating an Expense without passing any api key.</p>
<div class="highlight"><pre><span class="n">post_data</span> <span class="o">=</span> <span class="p">{</span><span class="err">'</span><span class="n">description</span><span class="err">'</span><span class="o">:</span> <span class="err">'</span><span class="n">Bought</span> <span class="n">Two</span> <span class="n">scoops</span> <span class="n">of</span> <span class="n">Django</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="n">amount</span><span class="err">'</span><span class="o">:</span> <span class="mi">399</span><span class="p">}</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="err">'</span><span class="n">Content</span><span class="o">-</span><span class="n">type</span><span class="err">'</span><span class="o">:</span> <span class="err">'</span><span class="n">application</span><span class="o">/</span><span class="n">json</span><span class="err">'</span><span class="p">}</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">"http://localhost:8000/api/expense/"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">post_data</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
<span class="n">print</span> <span class="n">r</span><span class="p">.</span><span class="n">status_code</span>       <span class="err">#</span><span class="n">This</span> <span class="n">will</span> <span class="n">give</span> <span class="mi">401</span>
</pre></div>


<p>Check that Expense count isn't increased</p>
<h4>Making authenticated POST requests</h4>
<p>You only need to change the url to include username and api_key in the url. This will make the request authenticated.</p>
<div class="highlight"><pre><span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">"http://localhost:8000/api/expense/?username=sheryl&amp;api_key=1a23"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">post_data</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
</pre></div>


<p>This should have worked and Expense count should have increased.</p>
<p>Try with wrong api_key and it will fail.</p>
<h3>Getting only User's expense</h3>
<p>Till now we aren't associating Expense to User. Let's add a ForeignKey to User from Expense.</p>
<p>Expense model becomes:</p>
<div class="highlight"><pre><span class="n">from</span> <span class="n">django</span><span class="p">.</span><span class="n">db</span> <span class="n">import</span> <span class="n">models</span>
<span class="n">from</span> <span class="n">django</span><span class="p">.</span><span class="n">contrib</span><span class="p">.</span><span class="n">auth</span><span class="p">.</span><span class="n">models</span> <span class="n">import</span> <span class="n">User</span>


<span class="n">class</span> <span class="n">Expense</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">)</span><span class="o">:</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">amount</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">IntegerField</span><span class="p">()</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>
</pre></div>


<p>Since we already have some Expenses in db which aren't associated with a User, so we kept User as a nullable field.</p>
<p>Make and run migrations</p>
<div class="highlight"><pre><span class="n">python</span> <span class="n">manage</span><span class="p">.</span><span class="n">py</span> <span class="n">makemigrations</span>
<span class="n">python</span> <span class="n">manage</span><span class="p">.</span><span class="n">py</span> <span class="n">migrate</span>
</pre></div>


<p>Right now our <strong>authorization</strong> class is set to <strong>Authorization</strong>. With this every user is <strong>authorized</strong> to see every expense. We will have to add a custom authorization class to enforce that users see only their expenses.</p>
<p>Add the following to expenses/api.py</p>
<div class="highlight"><pre><span class="n">class</span> <span class="n">ExpenseAuthorization</span><span class="p">(</span><span class="n">Authorization</span><span class="p">)</span><span class="o">:</span>

    <span class="n">def</span> <span class="n">read_list</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">object_list</span><span class="p">,</span> <span class="n">bundle</span><span class="p">)</span><span class="o">:</span>
        <span class="k">return</span> <span class="n">object_list</span><span class="p">.</span><span class="n">filter</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">bundle</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">user</span><span class="p">)</span>
</pre></div>


<p>And change <strong>authorization</strong> on ExpenseResource.Meta so it becomes:</p>
<div class="highlight"><pre><span class="n">class</span> <span class="n">ExpenseResource</span><span class="p">(</span><span class="n">ModelResource</span><span class="p">)</span><span class="o">:</span>

    <span class="n">class</span> <span class="n">Meta</span><span class="o">:</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="n">Expense</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">resource_name</span> <span class="o">=</span> <span class="err">'</span><span class="n">expense</span><span class="err">'</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="err">'</span><span class="n">description</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="n">amount</span><span class="err">'</span><span class="p">]</span>
        <span class="n">filtering</span> <span class="o">=</span> <span class="p">{</span>
            <span class="err">'</span><span class="n">amount</span><span class="err">'</span><span class="o">:</span> <span class="p">[</span><span class="err">'</span><span class="n">gt</span><span class="err">'</span><span class="p">],</span>
            <span class="err">'</span><span class="n">description</span><span class="err">'</span><span class="o">:</span> <span class="p">[</span><span class="err">'</span><span class="n">icontains</span><span class="err">'</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">authorization</span> <span class="o">=</span> <span class="n">ExpenseAuthorization</span><span class="p">()</span>
        <span class="n">authentication</span> <span class="o">=</span> <span class="n">ApiKeyAuthentication</span><span class="p">()</span>
</pre></div>


<h4>Explanation of ExpenseAuthorization</h4>
<ul>
<li>When GET endpoint is called for expense list, object_list is created which gives all the expenses.</li>
<li>After this, authorization is checked where further filtering could be done.</li>
<li>In case of GET on list endpoint, authorization class' read_list() method is called. object_list is passed to read_list.</li>
<li>In tastypie there is a variable called bundle. And bundle has access to request using bundle.request</li>
<li>When authentication is used properly, bundle.request.user is populated with correct user.</li>
</ul>
<p>Try expense list endpoint for Sheryl</p>
<div class="highlight"><pre><span class="nl">http:</span><span class="c1">//localhost:8000/api/expense/?format=json&amp;username=sheryl&amp;api_key=1a23</span>
</pre></div>


<p>You will not get any expense after adding ExpenseAuthorization</p>
<div class="highlight"><pre><span class="p">{</span><span class="s">"meta"</span><span class="o">:</span> <span class="p">{</span><span class="s">"limit"</span><span class="o">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s">"next"</span><span class="o">:</span> <span class="n">null</span><span class="p">,</span> <span class="s">"offset"</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"previous"</span><span class="o">:</span> <span class="n">null</span><span class="p">,</span> <span class="s">"total_count"</span><span class="o">:</span> <span class="mi">0</span><span class="p">},</span> <span class="s">"objects"</span><span class="o">:</span> <span class="p">[]}</span>
</pre></div>


<p>This happenned because at this point no expense is associated with Sheryl.</p>
<h4>Create an expense for Sheryl and try the GET endpoint</h4>
<p>On the shell</p>
<div class="highlight"><pre><span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="err">'</span><span class="n">sheryl</span><span class="err">'</span><span class="p">)</span>
<span class="n">Expense</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="err">'</span><span class="n">Paid</span> <span class="k">for</span> <span class="n">the</span> <span class="n">servers</span><span class="err">'</span><span class="p">,</span> <span class="n">amount</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">u</span><span class="p">)</span>
<span class="n">Expense</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="err">'</span><span class="n">Paid</span> <span class="k">for</span> <span class="n">CI</span> <span class="n">server</span><span class="err">'</span><span class="p">,</span> <span class="n">amount</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">u</span><span class="p">)</span>
</pre></div>


<p>Try expense list endpoint for Sheryl again</p>
<div class="highlight"><pre><span class="nl">http:</span><span class="c1">//localhost:8000/api/expense/?format=json&amp;username=sheryl&amp;api_key=1a23</span>
</pre></div>


<p>You should be able to see all of Sheryl's expenses.</p>
<p>Fifth commit here.</p>



<h4>How mobile app will use it.</h4>
<p>When Sheryl installs the app, she will be asked to login for the first time. There will be a REST endpoint which takes the username and password for a user and if the credentials are right, returns the api key for the user. Sheryl's api key will be returned to the mobile app which will store it in local storage. And when Sheryl wants to see her expenses, this REST call will be made to Django server.</p>
<div class="highlight"><pre><span class="nl">http:</span><span class="c1">//localhost:8000/api/expense/?format=json&amp;username=sheryl&amp;api_key=1a23</span>
</pre></div>


<p>This will only return Sheryl's expenses.</p>
<h3>POST and create Sheryl's expense</h3>
<p>Till now if a POST request is made, even if with Sheryl's api key, expense is created in db but is not associated with Sheryl.</p>
<p>We want to add functionality where if POST request is made from Sheryl's device then expense is associated with Sheryl. If POST request is made from Mark's device then expense should be associated with Mark.</p>
<p>Tastypie provides several hookpoints. We will use one such hookpoint. ModelResource provides a method called <strong>hydrate</strong> which we need to override. Add the following method to ExpenseResource.</p>
<div class="highlight"><pre><span class="n">def</span> <span class="n">hydrate</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">)</span><span class="o">:</span>
    <span class="n">bundle</span><span class="p">.</span><span class="n">obj</span><span class="p">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">bundle</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">user</span>
    <span class="k">return</span> <span class="n">bundle</span>
</pre></div>


<ul>
<li>This method is called during POST/PUT calls.</li>
<li>bundle.obj is an Expense instance about to be saved in the database.</li>
<li>So we set <strong>user</strong> on bundle.obj by reading it from bundle.request. We have already discussed how bundle.request is populated during authentication flow.</li>
</ul>
<p>Make a POST request now with Sheryl's api_key.</p>
<div class="highlight"><pre><span class="n">post_data</span> <span class="o">=</span> <span class="p">{</span><span class="err">'</span><span class="n">description</span><span class="err">'</span><span class="o">:</span> <span class="err">'</span><span class="n">Paid</span> <span class="k">for</span> <span class="n">iDoneThis</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="n">amount</span><span class="err">'</span><span class="o">:</span> <span class="mi">700</span><span class="p">}</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">"http://localhost:8000/api/expense/?username=sheryl&amp;api_key=1a23"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">post_data</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
</pre></div>


<p>Verify that the latest expense instance gets associated with Sheryl. You can also verify it by seeing that this object gets returned in GET expense list endpoint.</p>
<div class="highlight"><pre><span class="nl">http:</span><span class="c1">//localhost:8000/api/expense/?format=json&amp;username=sheryl&amp;api_key=1a23</span>
</pre></div>


<p>Sixth commit at this point</p>



<h4>Try on your own</h4>
<ul>
<li>Create one more user in database, from shell.</li>
<li>Create api key for this user.</li>
<li>POST to REST endpoint with this new user's api_key and username and verify that the expense gets associated with this new user.</li>
<li>Check GET expense list for this new user and verify that only expense created for this user is in the response.</li>
</ul>
<p>Now is a good time to dig deeper into django-tastypie and understand about following:</p>
<ul>
<li>Dehydrate cycle. It is used during GET calls.</li>
<li>Hydrate cycle. It is used during POST/PUT calls. Once you read about hydrate cycle, you will understand when method <strong>hydrate()</strong> is called.</li>
<li>More about authorization and different methods available on <strong>Authorization</strong> which could be overridden by you.</li>
</ul>
<h3>Want more?</h3>
<p>I am still trying few things with tastypie. Hereafter I will not have much explanation, but I will point to the commit where I attain certain functionality change.</p>
<h3>Authorization on detail endpoint.</h3>
<p>Expense with id 1 is not associated with any user. But Sheryl is still able to see it at:</p>
<div class="highlight"><pre><span class="nl">http:</span><span class="c1">//localhost:8000/api/expense/1/?format=json&amp;username=sheryl&amp;api_key=1a23</span>
</pre></div>


<p>She shouldn't be able to see it as it is not her expense.</p>
<p>So add the following to ExpenseAuthorization</p>
<div class="highlight"><pre><span class="n">def</span> <span class="n">read_detail</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">object_list</span><span class="p">,</span> <span class="n">bundle</span><span class="p">)</span><span class="o">:</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">object_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">obj</span><span class="p">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">bundle</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">user</span>
</pre></div>


<p>After this Sheryl will not be able to see detail endpoint of any expense which doesn't belong to her. Try it</p>
<div class="highlight"><pre><span class="nl">http:</span><span class="c1">//localhost:8000/api/expense/1/?format=json&amp;username=sheryl&amp;api_key=1a23</span>
</pre></div>


<p>Commit id for this:</p>



<h3>PUT endpoint</h3>
<p>Expense with id 5 belongs to Sheryl. She wants to <strong>update</strong> this expense, she essentially want to change the description.</p>
<p>Current thing is:</p>
<div class="highlight"><pre><span class="nl">http:</span><span class="c1">//localhost:8000/api/expense/5/?format=json&amp;username=sheryl&amp;api_key=1a23</span>
</pre></div>


<p>Make PUT request</p>
<div class="highlight"><pre><span class="n">put_url</span> <span class="o">=</span> <span class="s">"http://localhost:8000/api/expense/5/?username=sheryl&amp;api_key=1a23"</span>
<span class="n">put_data</span> <span class="o">=</span> <span class="p">{</span><span class="err">'</span><span class="n">description</span><span class="err">'</span><span class="o">:</span> <span class="err">'</span><span class="n">Paid</span> <span class="k">for</span> <span class="n">Travis</span><span class="err">'</span><span class="p">}</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="err">'</span><span class="n">Content</span><span class="o">-</span><span class="n">type</span><span class="err">'</span><span class="o">:</span> <span class="err">'</span><span class="n">application</span><span class="o">/</span><span class="n">json</span><span class="err">'</span><span class="p">}</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">put_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">put_data</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
</pre></div>


<p>Description of Expense 5 is updated as you can verify by trying the detail endpoint again.</p>
<div class="highlight"><pre><span class="nl">http:</span><span class="c1">//localhost:8000/api/expense/5/?format=json&amp;username=sheryl&amp;api_key=1a23</span>
</pre></div>


<p>Notice that amount remains unchanged. So PUT changes whatever data you provide in the api call and lets everything else remain as it is.</p>
<h3>DELETE endpoint</h3>
<p>First check all of Sheryl's expenses</p>
<div class="highlight"><pre><span class="nl">http:</span><span class="c1">//localhost:8000/api/expense/?format=json&amp;username=sheryl&amp;api_key=1a23</span>
</pre></div>


<p>Sheryl wants to delete her expense with id 5. After this is done she will have one less expense in db.</p>
<div class="highlight"><pre><span class="n">delete_url</span> <span class="o">=</span> <span class="s">"http://localhost:8000/api/expense/5/?username=sheryl&amp;api_key=1a23"</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">delete</span><span class="p">(</span><span class="n">delete_url</span><span class="p">)</span>
</pre></div>


<p>Verify that this expense got deleted.</p>
<p>So we were able to do Create, Read, Update and Delete with REST api calls.</p>
<h3>Restrict POST request to certain users only</h3>
<p>Suppose we want the users to be able to create expenses from web end but don't want to allow creating expense from mobile using the api. Yeah, weird requiremtn.</p>
<p>Also we don't want to disallow POST for all users. We still want Sheryl to be able to POST.</p>
<p>To try this we first need a new user with api key in our system. Create it from Django shell.</p>
<div class="highlight"><pre><span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="err">'</span><span class="n">mark</span><span class="err">'</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="err">'</span><span class="n">def</span><span class="err">'</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="err">'</span><span class="n">mark</span><span class="err">@</span><span class="n">abc</span><span class="p">.</span><span class="n">com</span><span class="err">'</span><span class="p">)</span>
<span class="n">ApiKey</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="err">'</span><span class="mi">2</span><span class="n">b34</span><span class="err">'</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">u</span><span class="p">)</span>
</pre></div>


<h4>Restricting POST for everyone except Sheryl</h4>
<p>Add following method to ExpenseAuthorization</p>
<div class="highlight"><pre><span class="n">def</span> <span class="n">create_detail</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">object_list</span><span class="p">,</span> <span class="n">bundle</span><span class="p">)</span><span class="o">:</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">bundle</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">user</span>
    <span class="err">#</span> <span class="n">Return</span> <span class="n">True</span> <span class="k">if</span> <span class="n">current</span> <span class="n">user</span> <span class="n">is</span> <span class="n">Sheryl</span> <span class="k">else</span> <span class="k">return</span> <span class="n">False</span>
    <span class="k">return</span> <span class="n">user</span><span class="p">.</span><span class="n">username</span> <span class="o">==</span> <span class="s">"sheryl"</span>
</pre></div>


<p>Try making POST request as Mark and see you will not be able to do it. If you want you can see the expense count at this point.</p>
<div class="highlight"><pre><span class="n">post_data</span> <span class="o">=</span> <span class="p">{</span><span class="err">'</span><span class="n">description</span><span class="err">'</span><span class="o">:</span> <span class="err">'</span><span class="n">Petty</span> <span class="n">expense</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="n">amount</span><span class="err">'</span><span class="o">:</span> <span class="mi">3000</span><span class="p">}</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">"http://localhost:8000/api/expense/?username=mark&amp;api_key=2b34"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">post_data</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
<span class="n">print</span> <span class="n">r</span><span class="p">.</span><span class="n">status_code</span> <span class="err">#</span><span class="n">Should</span> <span class="n">have</span> <span class="n">got</span> <span class="mi">401</span>
</pre></div>


<p>Also you can check the expense count again to verify that expense isn't created.</p>
<p>Status code 401 tells that you aren't authorized to do this operation.</p>
<h4>Verify that Sheryl is still able to create expense</h4>
<p>Try posting the same post_data as Sheryl</p>
<div class="highlight"><pre><span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">"http://localhost:8000/api/expense/?username=sheryl&amp;api_key=1a23"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">post_data</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
<span class="n">print</span> <span class="n">r</span><span class="p">.</span><span class="n">status_code</span>
</pre></div>


<p>Status code must be 201 in this case which means expense is created. You will be able to see this expense at Sheryl's GET expense list endpoint.</p>
<h4>Verify that Mark is still able to do GET</h4>
<p>Mark or any other user should still be able to make GET request even if he isn't able to make POST request.</p>
<div class="highlight"><pre><span class="nl">http:</span><span class="c1">//localhost:8000/api/expense/?username=mark&amp;api_key=2b34&amp;format=json</span>
</pre></div>


<p>Since Mark doesn't have any expense in db, so no object is there is <strong>objects</strong> key of response. Try creating an expense for this user from shell and then try the GET endpoint again.</p>
<h3>Explicitly defining fields and customising them</h3>
<p>ModelResource.Meta.fields can be dealt with in a similar way to ModelForm.Meta.fields. If you add the field to ModelResource.Meta.fields then it gets sane default behavriour. But it can be customised by adding the field explicitly on the ModelResource.</p>
<p>Let's try customising <strong>description</strong> field.</p>
<p>Add it explicitly on ExpenseResource</p>
<div class="highlight"><pre><span class="n">description</span> <span class="o">=</span> <span class="n">fields</span><span class="p">.</span><span class="n">CharField</span><span class="p">()</span>
</pre></div>


<p>You will need to import the following for it to work.</p>
<div class="highlight"><pre><span class="n">from</span> <span class="n">tastypie</span> <span class="n">import</span> <span class="n">fields</span>
</pre></div>


<p>Try the GET endpoint</p>
<div class="highlight"><pre><span class="nl">http:</span><span class="c1">//localhost:8000/api/expense/?username=sheryl&amp;api_key=1a23&amp;format=json</span>
</pre></div>


<p>You will see description as null for every expense. Because we committed a mistake.</p>
<p>While explicitly defining a field, we also need to tell the expense attribute that needs to be used for this particular field.</p>
<p>So we need to say</p>
<div class="highlight"><pre><span class="n">description</span> <span class="o">=</span> <span class="n">fields</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">attribute</span><span class="o">=</span><span class="err">'</span><span class="n">description</span><span class="err">'</span><span class="p">)</span>
</pre></div>


<p>Now GET endpoint will work as it used to work earlier.</p>
<p>But we did not achieve anything by explicitly adding the field. So what's the point of explicitly adding it.</p>
<p>Suppose you want the description in the detail endpoint but don't want it on list endpoint. This can be achieved in following way</p>
<div class="highlight"><pre><span class="n">description</span> <span class="o">=</span> <span class="n">fields</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">attribute</span><span class="o">=</span><span class="err">'</span><span class="n">description</span><span class="err">'</span><span class="p">,</span> <span class="n">use_in</span><span class="o">=</span><span class="err">'</span><span class="n">detail</span><span class="err">'</span><span class="p">)</span>
</pre></div>


<p>Try the list and detail endpoint now and notice the difference.</p>
<div class="highlight"><pre><span class="nl">http:</span><span class="c1">//localhost:8000/api/expense/?username=sheryl&amp;api_key=1a23&amp;format=json</span>
<span class="nl">http:</span><span class="c1">//localhost:8000/api/expense/8/?username=sheryl&amp;api_key=1a23&amp;format=json</span>
</pre></div>


<p><strong>use_in</strong> is documented <a href="http://django-tastypie.readthedocs.org/en/latest/fields.html#use-in" target="_blank">here</a></p>

      
          <hr/>
          
      

      
      
        <h4>Related Posts</h4>
        
      

      <hr/>
      <p>Can we help you build amazing apps? <a href="/contactus">Contact us today.</a>
    
    </p> 


  </div>
</div></body></html>