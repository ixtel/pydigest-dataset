<html><body><div><div itemprop="articleBody"><p>You know the cached property technique right? It's like this:</p><div class="highlight"><pre><span/><span class="k">class</span> <span class="nc">cached_property</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">cls</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>
</pre></div><p>Objects implementing <tt class="docutils literal">__get__</tt> and/or <tt class="docutils literal">__set__</tt> are called descriptors. If you assign descriptors to a class then attribute lookups and assignments will call <tt class="docutils literal">__get__</tt> and respectively <tt class="docutils literal">__set__</tt> on the descriptor.</p><p>The <tt class="docutils literal">cached_property</tt> above is very popular due to the fact that no function calls are involved after the first call - making it quite fast on CPython.</p><p>You'd use it like this:</p><div class="highlight"><pre><span/><span class="k">class</span> <span class="nc">Shape</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">area</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># compute value</span>
        <span class="k">return</span> <span class="n">value</span>
</pre></div><p>So armed with knowledge of that technique, I was doing something like this in my code:</p><div class="highlight"><pre><span/><span class="k">class</span> <span class="nc">Shape</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">area</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># compute value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="s1">'area'</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">value</span>
</pre></div><p>To my bewilderment that didn't work - every lookup called the function. It's looks like it's equivalent to <tt class="docutils literal">cached_property</tt> - what makes it different?</p><p>After some digging in CPython sources it turns out that objects use <tt class="docutils literal">PyObject_GenericGetAttr</tt> as the <a class="reference external" href="https://docs.python.org/3/c-api/object.html#c.PyObject_GenericGetAttr">default</a> <tt class="docutils literal">__getattr__</tt>. That in turn <a class="reference external" href="https://hg.python.org/cpython/file/7be6ef737aaf/Objects/object.c#l1101">calls</a> <a class="reference external" href="https://hg.python.org/cpython/file/7be6ef737aaf/Objects/object.c#l1013">_PyObject_GenericGetAttrWithDict</a> and it looks like that uses <tt class="docutils literal">PyDescr_IsData</tt> macro to <a class="reference external" href="https://hg.python.org/cpython/file/7be6ef737aaf/Objects/object.c#l1042">decide</a> if it should look first in <tt class="docutils literal">__dict__</tt>.</p><p>The <a class="reference external" href="https://hg.python.org/cpython/file/7be6ef737aaf/Include/descrobject.h#l93">macro</a>:</p><div class="highlight"><pre><span/><span class="cp">#define</span> <span class="n">PyDescr_IsData</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="p">(</span><span class="n">Py_TYPE</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tp_descr_set</span> <span class="o">!=</span> <span class="n">NULL</span><span class="p">)</span><span class="x"/>
</pre></div><p><tt class="docutils literal">tp_descr_set</tt> is the slot for <tt class="docutils literal">__set__</tt>. So this means that if the descriptor doesn't have a <tt class="docutils literal">__set__</tt> method then attributes are first looked up in the instance's <tt class="docutils literal">__dict__</tt>.</p><p>Interestingly enough, it turns out this was documented all along, albeit <a class="reference external" href="https://docs.python.org/dev/reference/datamodel.html#invoking-descriptors">not very prominently</a>. There are <span class="uppercase">data descriptors</span> (<tt class="docutils literal">__set__</tt> is implemented) and <span class="uppercase">non-data descriptors</span> (no <tt class="docutils literal">__set__</tt>).</p><p>This allows you to do the <tt class="docutils literal">cached_decorator</tt> trick above. It also allows you to override methods on the instance (think monkey-patching) as functions are actually <span class="uppercase">non-data descriptors</span>.</p><p>Other reasoning can be found in <a class="reference external" href="http://legacy.python.org/dev/peps/pep-0252/">PEP-252</a> (search for <span class="uppercase">data descriptors</span>).</p></div></div></body></html>