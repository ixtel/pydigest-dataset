<html><body><div><div class="content">
      
        <h1 class="content-title">Announcing sophy: fast Python bindings for Sophia Database</h1>
      
      
      
  <div class="post-info"><p>
    
    
      December 19, 2015 15:58
      </p><span class="separator">/</span>
      <a href="#comments">0 comments</a>
      <span class="separator">/</span>
      
        <a href="/blog/tags/cython/">cython</a>
      
        <a href="/blog/tags/kv/">kv</a>
      
        <a href="/blog/tags/nosql/">nosql</a>
      
        <a href="/blog/tags/python/">python</a>
      
    
  </div>
  
  
    <p><a href="http://media.charlesleifer.com/blog/photos/sophia-logo.png" title="photos/sophia-logo.png"><img alt="photos/sophia-logo.png" class="img-responsive" src="http://m.charlesleifer.com/t/800x-/blog/photos/sophia-logo.png?key=YGTbT6a7IOumPD68HjgNUw"/></a></p>
<p><a href="http://sphia.org">Sophia</a> is a powerful key/value database with loads of features packed into a simple C API. In order to use this database in some upcoming projects I've got planned, I decided to write some Python bindings and the result is <a href="https://github.com/coleifer/sophy">sophy</a>. In this post, I'll describe the features of Sophia database, and then show example code using <code>sophy</code>, the Python wrapper.</p>
<p>Here is an overview of the <a href="http://sphia.org/features.html">features</a> of the Sophia database:</p>
<ul>
<li>Append-only MVCC database</li>
<li>ACID transactions</li>
<li>Consistent cursors</li>
<li>Compression</li>
<li>Ordered key/value store</li>
<li>Range searches</li>
<li>Multi-part keys</li>
<li>Prefix searches</li>
</ul>
<p>The <a href="http://sphia.org/architecture.html">architecture</a> is unique and definitely worthy of a skim if you plan to use Sophia.</p>
<h3>Installing sophy</h3>
<p>The <a href="http://sphia.org">Sophia</a> sources are bundled with the <code>sophy</code> source code, so the only thing you need to install is <a href="http://cython.org">Cython</a>. You can install from <a href="https://github.com/coleifer/sophy">GitHub</a> or from <a href="https://pypi.python.org/pypi/sophy/">PyPI</a>.</p>
<p>Pip instructions:</p>
<div class="highlight"><pre><span class="gp">$</span> pip install Cython sophy
</pre></div>
<p>Git instructions:</p>
<div class="highlight"><pre><span class="gp">$</span> pip install Cython
<span class="gp">$</span> git clone https://github.com/coleifer/sophy
<span class="gp">$</span> <span class="nb">cd</span> sophy
<span class="gp">$</span> python setup.py build
<span class="gp">$</span> python setup.py install
</pre></div>
<h3>Usage</h3>
<p><code>sophy</code> is very simple to use. It acts primarly like a Python <code>dict</code> object, but in addition to normal dictionary operations, you can read slices of data that are returned efficiently using cursors. Similarly, bulk writes using <code>update()</code> use an efficient, atomic batch operation.</p>
<p>To begin, instantiate and open a Sophia database. If the database and path do not exist, they will be created automatically. Multiple databases can exist under the same path:</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sophy</span> <span class="kn">import</span> <span class="n">Sophia</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">env</span> <span class="o">=</span> <span class="n">Sophia</span><span class="p">(</span><span class="s1">'/tmp/sophia-env'</span><span class="p">,</span> <span class="p">[(</span><span class="s1">'test-db'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">)])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">env</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">'test-db'</span><span class="p">]</span>  <span class="c1"># Environments can have many dbs.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db2</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">create_database</span><span class="p">(</span><span class="s1">'another-db'</span><span class="p">,</span> <span class="s1">'u64'</span><span class="p">)</span>  <span class="c1"># A database keyed by 64-bit unsigned ints.</span>
</pre></div>
<p>We can set values individually or in groups:</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="p">[</span><span class="s1">'k1'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'v1'</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">k2</span><span class="o">=</span><span class="s1">'v2'</span><span class="p">,</span> <span class="n">k3</span><span class="o">=</span><span class="s1">'v3'</span><span class="p">,</span> <span class="n">k4</span><span class="o">=</span><span class="s1">'v4'</span><span class="p">)</span>  <span class="c1"># Efficient, atomic.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">db</span><span class="o">.</span><span class="n">transaction</span><span class="p">()</span> <span class="k">as</span> <span class="n">txn</span><span class="p">:</span>  <span class="c1"># Same as .update()</span>
<span class="gp">... </span>    <span class="n">txn</span><span class="p">[</span><span class="s1">'k1'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'v1-e'</span>
<span class="gp">... </span>    <span class="n">txn</span><span class="p">[</span><span class="s1">'k5'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'v5'</span>
<span class="gp">...</span>
</pre></div>
<p>We can read values individually or in groups. When requesting a slice, the third parameter (<code>step</code>) is used to indicate the results should be returned in reverse. Alternatively, if the first key is higher than the second key in a slice, <code>sophy</code> will interpret that as ordered in reverse.</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="p">[</span><span class="s1">'k1'</span><span class="p">]</span>
<span class="go">'v1-e'</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">db</span><span class="p">[</span><span class="s1">'k2'</span><span class="p">:</span> <span class="s1">'k444'</span><span class="p">]]</span>
<span class="go">[('k2', 'v2'), ('k3', 'v3'), ('k4', 'v4')]</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nb">list</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="s1">'k3'</span><span class="p">:</span><span class="s1">'k1'</span><span class="p">])</span>  <span class="c1"># Results are returned in reverse.</span>
<span class="go">[('k3', 'v3'), ('k2', 'v2'), ('k1', 'v1-e')]</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nb">list</span><span class="p">(</span><span class="n">db</span><span class="p">[:</span><span class="s1">'k3'</span><span class="p">])</span>  <span class="c1"># All items from lowest key up to 'k3'.</span>
<span class="go">[('k1', 'v1-e'), ('k2', 'v2'), ('k3', 'v3')]</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nb">list</span><span class="p">(</span><span class="n">db</span><span class="p">[:</span><span class="s1">'k3'</span><span class="p">:</span><span class="bp">True</span><span class="p">])</span>  <span class="c1"># Same as above, but ordered in reverse.</span>
<span class="go">[('k3', 'v3'), ('k2', 'v2'), ('k1', 'v1-e')]</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nb">list</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="s1">'k3'</span><span class="p">:])</span>  <span class="c1"># All items from k3 to highest key.</span>
<span class="go">[('k3', 'v3'), ('k4', 'v4'), ('k5', 'v5')]</span>
</pre></div>
<p>Values can also be deleted singly or in groups. To delete multiple items atomically use the <code>transaction()</code> method.</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">del</span> <span class="n">db</span><span class="p">[</span><span class="s1">'k3'</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="p">[</span><span class="s1">'k3'</span><span class="p">]</span>  <span class="c1"># 'k3' no longer exists.</span>
<span class="gt">Traceback (most recent call last):</span>
  <span class="c">...</span>
<span class="gr">KeyError</span>: <span class="n">'k3'</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">db</span><span class="o">.</span><span class="n">transaction</span><span class="p">()</span> <span class="k">as</span> <span class="n">wb</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">del</span> <span class="n">wb</span><span class="p">[</span><span class="s1">'k2'</span><span class="p">]</span>
<span class="gp">... </span>    <span class="k">del</span> <span class="n">wb</span><span class="p">[</span><span class="s1">'k5'</span><span class="p">]</span>
<span class="gp">... </span>    <span class="k">del</span> <span class="n">wb</span><span class="p">[</span><span class="s1">'kxx'</span><span class="p">]</span>  <span class="c1"># No error raised.</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">list</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="go">[('k1', 'v1-e'), ('k4', 'v4')]</span>
</pre></div>
<h3>Transactions</h3>
<p>As shown above, transactions can be used to effect multiple changes atomically.</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">db</span><span class="o">.</span><span class="n">transaction</span><span class="p">()</span> <span class="k">as</span> <span class="n">txn</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">txn</span><span class="p">[</span><span class="s1">'k2'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'v2-e'</span>
<span class="gp">... </span>    <span class="n">txn</span><span class="p">[</span><span class="s1">'k1'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'v1-e2'</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">list</span><span class="p">(</span><span class="n">db</span><span class="p">[::</span><span class="bp">True</span><span class="p">])</span>
<span class="go">[('k4', 'v4'), ('k2', 'v2-e'), ('k1', 'v1-e2')]</span>
</pre></div>
<p>You can call <code>commit()</code> or <code>rollback()</code> inside the transaction block itself:</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">db</span><span class="o">.</span><span class="n">transaction</span><span class="p">()</span> <span class="k">as</span> <span class="n">txn</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">txn</span><span class="p">[</span><span class="s1">'k1'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'whoops'</span>
<span class="gp">... </span>    <span class="n">txn</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">txn</span><span class="p">[</span><span class="s1">'k2'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'v2-e2'</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">list</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
<span class="go">[('k1', 'v1-e2'), ('k2', 'v2-e2'), ('k4', 'v4')]</span>
</pre></div>
<p>If an exception occurs in the wrapped block, the transaction will automatically be rolled back.</p>
<h3>Cursors</h3>
<p>Sophia is an ordered key/value store, so cursors will by default iterate through the keyspace in ascending order. To iterate in descending order, you can specify this using the slicing technique described above. For finer-grained control, however, you can use the <code>cursor()</code> method.</p>
<p>The <code>Database.cursor()</code> method supports a number of interesting parameters:</p>
<ul>
<li><code>order</code>: either <code>'&gt;='</code> (default), <code>'&lt;='</code> (reverse), <code>'&gt;'</code> (ascending not including endpoint), <code>'&lt;'</code> (reverse, not including endpoint).</li>
<li><code>key</code>: seek to this key before beginning to iterate.</li>
<li><code>prefix</code>: perform a prefix search.</li>
<li><code>keys</code>: include the database key while iterating (default <code>True</code>).</li>
<li><code>values</code>: include the database value while iterating (default <code>True</code>).</li>
</ul>
<p>To perform a prefix search, for example, you might do something like:</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">aa</span><span class="o">=</span><span class="s1">'foo'</span><span class="p">,</span> <span class="n">abc</span><span class="o">=</span><span class="s1">'bar'</span><span class="p">,</span> <span class="n">az</span><span class="o">=</span><span class="s1">'baze'</span><span class="p">,</span> <span class="n">baz</span><span class="o">=</span><span class="s1">'nugget'</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">'a'</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="n">item</span>
<span class="gp">...</span>
<span class="go">('aa', 'foo')</span>
<span class="go">('abc', 'bar')</span>
<span class="go">('az', 'baze')</span>
</pre></div>
<h3>Configuration</h3>
<p>Sophia supports a huge number of <a href="http://sphia.org/configuration.html">configuration options</a>, most of which are exposed as simple properties on the <code>Sophia</code> database object. For example, to configure <code>Sophia</code> with a set memory limit and number of worker threads:</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">env</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># We may need to close the env to set some options.</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">env</span><span class="o">.</span><span class="n">scheduler_threads</span> <span class="o">=</span> <span class="mi">4</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">env</span><span class="o">.</span><span class="n">memory_limit</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">16</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">env</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>  <span class="c1"># Now using 4 threads and 16mb mem limit.</span>
<span class="go">True</span>
</pre></div>
<p>You can also force checkpointing, garbage-collection, and other things using simple methods:</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">env</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">env</span><span class="o">.</span><span class="n">gc</span><span class="p">()</span>
</pre></div>
<p>Some properties are read-only:</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">index_count</span>
<span class="go">10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">len</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="go">10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">status</span>
<span class="go">'online'</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">memory_used</span>
<span class="go">69</span>
</pre></div>
<p>Take a look at the <a href="http://sphia.org/configuration.html">configuration docs</a> for more details.</p>
<h3>Not mentioned, but cool</h3>
<p>Sophia supports multiple key types as well as multi-part keys (up to 8 parts). So while all these examples have used a string key, we can mix and match strings, 32-bit and 64-bit unsigned ints.</p>
<p>Sophia also supports read-only views which reflect the state of the database at a given moment. Views act much like the regular database interface (dictionary-lookup and slicing, cursor support).</p>
<h3>Similarity to other projects</h3>
<p>The <code>sophy</code> bindings are quite similar to the SQLite4 <a href="http://lsm-db.readthedocs.org/en/latest/">lsm-db</a> bindings I wrote a couple months ago. Both databases are ordered key/value stores, and the Python bindings both implement a dictionary-like API with the addition of efficient slicing to read multiple key/value pairs. I've written bindings to <a href="http://unqlite.org">UnQLite</a> (<a href="http://unqlite-python.readthedocs.org/en/latest/">unqlite-python</a>) and <a href="http://vedis.symisc.net/">Vedis</a> (<a href="http://vedis-python.readthedocs.org/en/latest/">vedis-python</a>), both of which are embedded databases, the former is a JSON document store, the latter is Redis-like embedded data-structure store. Lastly, I've got another project kicking around called <a href="https://github.com/coleifer/kvkit">kvkit</a> which provides a high-level Python API around a number of ordered key/value stores (kyotocabinet, leveldb, rocksdb, etc).</p>
<p>If you'd like to experiment with embedded databases from Python, hopefully one of the above projects will meet your needs! ... and if not, <a href="/blog/sqlite-small-fast-reliable-choose-any-three-/">give SQLite a try!</a>.</p>
<h3>Thanks for reading</h3>
<p>Thanks for taking the time to read this post, I hope you found it interesting! As always, please feel free to write a <a href="#comments">comment</a>. Happy hacking!</p>
  
  


<hr/>

  <p>Commenting has been closed, but please feel free to <a href="/contact/">contact me</a></p>


    </div>

    </div></body></html>