<html><body><div><section class="entry">
<p class="fsb-clear"/><p><a href="http://www.pyimagesearch.com/wp-content/uploads/2015/05/animated_motion_02.gif"><img class="aligncenter wp-image-2361" src="http://www.pyimagesearch.com/wp-content/uploads/2015/05/animated_motion_02.gif" alt="animated_motion_02"/></a></p>
<blockquote><p><em><strong>That son of a bitch. I knew he took my last beer.</strong></em></p></blockquote>
<p>These are words a man should never, <em>ever</em> have to say. But I muttered them to myself in an exasperated sigh of disgust as I closed the door to my refrigerator.</p>
<p>You see, I had just spent over 12 hours writing content for the upcoming <a href="http://www.pyimagesearch.com/pyimagesearch-gurus/" target="_blank">PyImageSearch Gurus course</a>. My brain was fried, practically leaking out my ears like half cooked scrambled eggs. And after calling it quits for the night, all I wanted was to do relax and watch my all-time favorite movie, <em>Jurassic Park</em>, while sipping an ice cold Finestkind IPA from Smuttynose, a brewery I have become quite fond of as of late.</p>
<p>But that <em>son of a bitch James</em> had come over last night and drank my last beer.</p>
<p>Well, <strong><i>allegedly</i></strong>.</p>
<p><strong>I couldn’t actually prove anything</strong>. In reality, I didn’t <em>really see</em> him drink the beer as my face was buried in my laptop, fingers floating above the keyboard, feverishly pounding out tutorials and articles. <em>But I had a feeling he was the culprit.</em> He is my only (ex-)friend who drinks IPAs.</p>
<p>So I did what any man would do.</p>
<p><em><strong>I mounted a Raspberry Pi to the top of my kitchen cabinets to automatically detect if he tried to pull that beer stealing shit again:</strong></em></p>
<div id="attachment_2354" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2015/05/raspberry_pi_cabinents.jpg"><img class="wp-image-2354" src="http://www.pyimagesearch.com/wp-content/uploads/2015/05/raspberry_pi_cabinents.jpg" alt="Figure 1: Don't steal my damn beer. Otherwise I'll mount a Raspberry Pi + camera on top of my kitchen cabinets and catch you." srcset="http://www.pyimagesearch.com/wp-content/uploads/2015/05/raspberry_pi_cabinents-225x300.jpg 225w, http://www.pyimagesearch.com/wp-content/uploads/2015/05/raspberry_pi_cabinents-768x1024.jpg 768w, http://www.pyimagesearch.com/wp-content/uploads/2015/05/raspberry_pi_cabinents.jpg 1000w" sizes="(max-width: 450px) 100vw, 450px"/></a><p class="wp-caption-text"><strong>Figure 1:</strong> Don’t steal my damn beer. Otherwise I’ll mount a Raspberry Pi + camera on top of my kitchen cabinets and catch you.</p></div>
<p>Excessive?</p>
<p>Perhaps.</p>
<p>But I take my beer seriously. And if James tries to steal my beer again, I’ll catch him redhanded.</p>

<p><strong>OpenCV and Python versions:</strong><br/>
In order to run this example, you’ll need <strong>Python 2.7</strong> and <strong>OpenCV 2.4.X</strong>.</p>
<h1>A 2-part series on motion detection</h1>
<p><strong>This is the <em>first post</em> in a <em>two part series</em> on building a motion detection and tracking system for home surveillance. </strong></p>
<p>The remainder of this article will detail how to build a basic motion detection and tracking system for home surveillance using computer vision techniques. This example will work with both <em>pre-recorded videos</em> and <em>live streams from your webcam</em>; however, we’ll be developing this system on our laptops/desktops.</p>
<p>In the second post in this series I’ll show you how to update the code to work with your Raspberry Pi and camera board — <em>and how to extend your home surveillance system to capture any detected motion and upload it to your personal Dropbox.</em></p>
<p>And maybe at the end of all this we can catch James red handed…</p>
<h1>A little bit about background subtraction</h1>
<p>Background subtraction is critical in many computer vision applications. We use it to count the number of cars passing through a toll booth. We use it to count the number of people walking in and out of a store.</p>
<p><em>And we use it for motion detection.</em></p>
<p>Before we get started coding in this post, let me say that there are many, <em>many</em> ways to perform motion detection, tracking, and analysis in OpenCV. Some are very simple. And others are very complicated. The two primary methods are forms of Gaussian Mixture Model-based foreground and background segmentation:</p>
<ol>
<li><a href="http://www.ee.surrey.ac.uk/CVSSP/Publications/papers/KaewTraKulPong-AVBS01.pdf" target="_blank"><em>An improved adaptive background mixture model for real-time tracking with shadow detection</em></a> by KaewTraKulPong et al., available through the 
			<span id="crayon-56d5903495196803174684" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">BackgroundSubtractorMOG</span></span></span>  function.</li>
<li><a href="http://www.zoranz.net/Publications/zivkovic2004ICPR.pdf" target="_blank"><em>Improved adaptive Gaussian mixture model for background subtraction</em></a> by Zivkovic, and <em><a href="http://www.zoranz.net/Publications/zivkovicPRL2006.pdf" target="_blank">Efficient Adaptive Density Estimation per Image Pixel for the Task of Background Subtraction</a></em>, also by Zivkovic, available through the 
			<span id="crayon-56d59034951a9212716543" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">BackgroundSubtractorMOG2</span></span></span>  function.</li>
</ol>
<p>And in newer versions of OpenCV we have Bayesian (probability) based foreground and background segmentation, implemented from Godbehere et al.’s 2012 paper, <em><a href="http://goldberg.berkeley.edu/pubs/acc-2012-visual-tracking-final.pdf" target="_blank">Visual Tracking of Human Visitors under Variable-Lighting Conditions for a Responsive Audio Art Installation</a></em>. We can find this implementation in the 
			<span id="crayon-56d59034951b1272576396" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">createBackgroundSubtractorGMG</span></span></span>  function (we’ll be waiting for OpenCV 3 to fully play with this function though).</p>
<p>All of these methods are concerned with <i>segmenting the background from the foreground </i>(and they even provide mechanisms for us to discern between actual motion and just shadowing and small lighting changes)!</p>
<p>So why is this so important? And why do we care what pixels belong to the <em>foreground</em> and what pixels are part of the <i>background</i>?</p>
<p>Well, in motion detection, we tend to make the following assumption:</p>
<p><strong>The <em>background</em> of our video stream is largely <em>static and unchanging</em> over consecutive frames of a video. Therefore, if we can model the background, we monitor it for substantial changes. If there is a substantial change, we can detect it — this change normally corresponds to <em>motion</em> on our video.</strong></p>
<p>Now obviously in the real-world this assumption can easily fail. Due to shadowing, reflections, lighting conditions, and any other possible change in the environment, our background can look quite different in various frames of a video. And if the background appears to be different, it can throw our algorithms off. That’s why the most successful background subtraction/foreground detection systems <em>utilize fixed mounted cameras</em> and in <em>controlled lighting conditions.</em></p>
<p>The methods I mentioned above, while very powerful, are also computationally expensive. And since our end goal is to deploy this system to a Raspberry Pi at the end of this 2 part series, it’s best that we stick to simple approaches. We’ll return to these more powerful methods in future blog posts, but for the time being we are going to keep it simple and efficient.</p>
<p>In the rest of this blog post, I’m going to detail (arguably) the most basic motion detection and tracking system you can build. It won’t be perfect, but it will be able to run on a Pi and still deliver good results.</p>
<h1>Basic motion detection and tracking with Python and OpenCV</h1>
<p>Alright, are you ready to help me develop a home surveillance system to catch that beer stealing jackass?</p>
<p>Open up a editor, create a new file, name it 
			<span id="crayon-56d59034951b9138015005" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">motion_detector</span><span class="crayon-sy">.</span><span class="crayon-v">py</span></span></span> , and let’s get coding:</p>

		<div id="crayon-56d59034951bf884374872" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-56d59034951bf884374872-1">1</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59034951bf884374872-2">2</p><p class="crayon-num" data-line="crayon-56d59034951bf884374872-3">3</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59034951bf884374872-4">4</p><p class="crayon-num" data-line="crayon-56d59034951bf884374872-5">5</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59034951bf884374872-6">6</p><p class="crayon-num" data-line="crayon-56d59034951bf884374872-7">7</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59034951bf884374872-8">8</p><p class="crayon-num" data-line="crayon-56d59034951bf884374872-9">9</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59034951bf884374872-10">10</p><p class="crayon-num" data-line="crayon-56d59034951bf884374872-11">11</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59034951bf884374872-12">12</p><p class="crayon-num" data-line="crayon-56d59034951bf884374872-13">13</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59034951bf884374872-14">14</p><p class="crayon-num" data-line="crayon-56d59034951bf884374872-15">15</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59034951bf884374872-16">16</p><p class="crayon-num" data-line="crayon-56d59034951bf884374872-17">17</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59034951bf884374872-18">18</p><p class="crayon-num" data-line="crayon-56d59034951bf884374872-19">19</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59034951bf884374872-20">20</p><p class="crayon-num" data-line="crayon-56d59034951bf884374872-21">21</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59034951bf884374872-22">22</p><p class="crayon-num" data-line="crayon-56d59034951bf884374872-23">23</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59034951bf884374872-24">24</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d59034951bf884374872-1"><span class="crayon-c"># import the necessary packages</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59034951bf884374872-2"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-k ">argparse</span></p><p class="crayon-line" id="crayon-56d59034951bf884374872-3"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-k ">datetime</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59034951bf884374872-4"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">imutils</span></p><p class="crayon-line" id="crayon-56d59034951bf884374872-5"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-k ">time</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59034951bf884374872-6"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span></p><p class="crayon-line" id="crayon-56d59034951bf884374872-7"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59034951bf884374872-8"><span class="crayon-c"># construct the argument parser and parse the arguments</span></p><p class="crayon-line" id="crayon-56d59034951bf884374872-9"><span class="crayon-v">ap</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">argparse</span><span class="crayon-sy">.</span><span class="crayon-e">ArgumentParser</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59034951bf884374872-10"><span class="crayon-v">ap</span><span class="crayon-sy">.</span><span class="crayon-e">add_argument</span><span class="crayon-sy">(</span><span class="crayon-s">"-v"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"--video"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-k ">help</span><span class="crayon-o">=</span><span class="crayon-s">"path to the video file"</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59034951bf884374872-11"><span class="crayon-v">ap</span><span class="crayon-sy">.</span><span class="crayon-e">add_argument</span><span class="crayon-sy">(</span><span class="crayon-s">"-a"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"--min-area"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-k ">type</span><span class="crayon-o">=</span><span class="crayon-k ">int</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">default</span><span class="crayon-o">=</span><span class="crayon-cn">500</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-k ">help</span><span class="crayon-o">=</span><span class="crayon-s">"minimum area size"</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59034951bf884374872-12"><span class="crayon-v">args</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">vars</span><span class="crayon-sy">(</span><span class="crayon-v">ap</span><span class="crayon-sy">.</span><span class="crayon-e">parse_args</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59034951bf884374872-13"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59034951bf884374872-14"><span class="crayon-c"># if the video argument is None, then we are reading from webcam</span></p><p class="crayon-line" id="crayon-56d59034951bf884374872-15"><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">args</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-s">"video"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">None</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-t">None</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59034951bf884374872-16"><span class="crayon-h">	</span><span class="crayon-v">camera</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">VideoCapture</span><span class="crayon-sy">(</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59034951bf884374872-17"><span class="crayon-h">	</span><span class="crayon-k ">time</span><span class="crayon-sy">.</span><span class="crayon-e">sleep</span><span class="crayon-sy">(</span><span class="crayon-cn">0.25</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59034951bf884374872-18"> </p><p class="crayon-line" id="crayon-56d59034951bf884374872-19"><span class="crayon-c"># otherwise, we are reading from a video file</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59034951bf884374872-20"><span class="crayon-st">else</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d59034951bf884374872-21"><span class="crayon-h">	</span><span class="crayon-v">camera</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">VideoCapture</span><span class="crayon-sy">(</span><span class="crayon-v">args</span><span class="crayon-sy">[</span><span class="crayon-s">"video"</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59034951bf884374872-22"> </p><p class="crayon-line" id="crayon-56d59034951bf884374872-23"><span class="crayon-c"># initialize the first frame in the video stream</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59034951bf884374872-24"><span class="crayon-v">firstFrame</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">None</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p><strong>Lines 2-6</strong> import our necessary packages. All of these should look pretty familiar, except perhaps the 
			<span id="crayon-56d59034951c6244970978" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">imutils</span></span></span>  package, which  is a set of convenience functions that I have created to make basic image processing tasks easier. If you do not already have <a href="https://github.com/jrosebr1/imutils" target="_blank">imutils</a> installed on your system, you can install it via pip: 
			<span id="crayon-56d59034951cc538350861" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-e">pip </span><span class="crayon-e">install </span><span class="crayon-v">imutils</span></span></span> .</p>
<p>Next up, we’ll parse our command line arguments on <strong>Lines 9-12</strong>. We’ll define two switches here. The first, 
			<span id="crayon-56d59034951d2710681205" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-o">--</span><span class="crayon-v">video</span></span></span> , is optional. It simply defines a path to a pre-recorded video file that we can detect motion in. If you <em>do not</em> supply a path to a video file, then OpenCV will utilize your webcam to detect motion.</p>
<p>We’ll also define 
			<span id="crayon-56d59034951d8397900034" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-o">--</span><span class="crayon-v">min</span><span class="crayon-o">-</span><span class="crayon-v">area</span></span></span> , which is the minimum size (in pixels) for a region of an image to be considered actual “motion”. As I’ll discuss later in this tutorial, we’ll often find small regions of an image that have changed substantially, likely due to noise or changes in lighting conditions. In reality, these small regions are not actual motion at all — so we’ll define a minimum size of a region to combat and filter out these false-positives.</p>
<p><strong>Lines 15-21</strong> handle grabbing a reference to our 
			<span id="crayon-56d59034951df721475867" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">camera</span></span></span>  object. In the case that a video file path is <em>not</em> supplied (<strong>Lines 15-17</strong>), we’ll grab a reference to the webcam. And if a video file <i>is</i> supplied, then we’ll create a pointer to it on <b>Lines 20 and 21</b>.</p>
<p>Lastly, we’ll end this code snippet by defining a variable called 
			<span id="crayon-56d59034951e5694185767" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">firstFrame</span></span></span> .</p>
<p>Any guesses as to what 
			<span id="crayon-56d59034951eb832077288" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">firstFrame</span></span></span>  is?</p>
<p>If you guessed that it stores the first frame of the video file/webcam stream, you’re right.</p>
<p><em><strong>Assumption:</strong> The first frame of our video file will contain </em>no motion<em> and </em>just background<em> — therefore, we can model the background of our video stream using only the first frame of the video</em>.</p>
<p>Obviously we are making a pretty big assumption here. But again, our goal is to run this system on a Raspberry Pi, so we can’t get too complicated. And as you’ll see in the results section of this post, we are able to easily detect motion while tracking a person as they walk around the room.</p>

		<div id="crayon-56d59034951f1439181656" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num crayon-striped-num" data-line="crayon-56d59034951f1439181656-26">26</p><p class="crayon-num" data-line="crayon-56d59034951f1439181656-27">27</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59034951f1439181656-28">28</p><p class="crayon-num" data-line="crayon-56d59034951f1439181656-29">29</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59034951f1439181656-30">30</p><p class="crayon-num" data-line="crayon-56d59034951f1439181656-31">31</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59034951f1439181656-32">32</p><p class="crayon-num" data-line="crayon-56d59034951f1439181656-33">33</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59034951f1439181656-34">34</p><p class="crayon-num" data-line="crayon-56d59034951f1439181656-35">35</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59034951f1439181656-36">36</p><p class="crayon-num" data-line="crayon-56d59034951f1439181656-37">37</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59034951f1439181656-38">38</p><p class="crayon-num" data-line="crayon-56d59034951f1439181656-39">39</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59034951f1439181656-40">40</p><p class="crayon-num" data-line="crayon-56d59034951f1439181656-41">41</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59034951f1439181656-42">42</p><p class="crayon-num" data-line="crayon-56d59034951f1439181656-43">43</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59034951f1439181656-44">44</p><p class="crayon-num" data-line="crayon-56d59034951f1439181656-45">45</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59034951f1439181656-46">46</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line crayon-striped-line" id="crayon-56d59034951f1439181656-26"><span class="crayon-c"># loop over the frames of the video</span></p><p class="crayon-line" id="crayon-56d59034951f1439181656-27"><span class="crayon-st">while</span><span class="crayon-h"> </span><span class="crayon-t">True</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59034951f1439181656-28"><span class="crayon-h">	</span><span class="crayon-c"># grab the current frame and initialize the occupied/unoccupied</span></p><p class="crayon-line" id="crayon-56d59034951f1439181656-29"><span class="crayon-h">	</span><span class="crayon-c"># text</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59034951f1439181656-30"><span class="crayon-h">	</span><span class="crayon-sy">(</span><span class="crayon-v">grabbed</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">frame</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">camera</span><span class="crayon-sy">.</span><span class="crayon-e">read</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59034951f1439181656-31"><span class="crayon-h">	</span><span class="crayon-v">text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"Unoccupied"</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59034951f1439181656-32"> </p><p class="crayon-line" id="crayon-56d59034951f1439181656-33"><span class="crayon-h">	</span><span class="crayon-c"># if the frame could not be grabbed, then we have reached the end</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59034951f1439181656-34"><span class="crayon-h">	</span><span class="crayon-c"># of the video</span></p><p class="crayon-line" id="crayon-56d59034951f1439181656-35"><span class="crayon-h">	</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-v">grabbed</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59034951f1439181656-36"><span class="crayon-h">		</span><span class="crayon-st">break</span></p><p class="crayon-line" id="crayon-56d59034951f1439181656-37"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59034951f1439181656-38"><span class="crayon-h">	</span><span class="crayon-c"># resize the frame, convert it to grayscale, and blur it</span></p><p class="crayon-line" id="crayon-56d59034951f1439181656-39"><span class="crayon-h">	</span><span class="crayon-v">frame</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">imutils</span><span class="crayon-sy">.</span><span class="crayon-e">resize</span><span class="crayon-sy">(</span><span class="crayon-v">frame</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">width</span><span class="crayon-o">=</span><span class="crayon-cn">500</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59034951f1439181656-40"><span class="crayon-h">	</span><span class="crayon-v">gray</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">cvtColor</span><span class="crayon-sy">(</span><span class="crayon-v">frame</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">COLOR_BGR2GRAY</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59034951f1439181656-41"><span class="crayon-h">	</span><span class="crayon-v">gray</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">GaussianBlur</span><span class="crayon-sy">(</span><span class="crayon-v">gray</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">21</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">21</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59034951f1439181656-42"> </p><p class="crayon-line" id="crayon-56d59034951f1439181656-43"><span class="crayon-h">	</span><span class="crayon-c"># if the first frame is None, initialize it</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59034951f1439181656-44"><span class="crayon-h">	</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">firstFrame </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-t">None</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d59034951f1439181656-45"><span class="crayon-h">		</span><span class="crayon-v">firstFrame</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">gray</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59034951f1439181656-46"><span class="crayon-e">		</span><span class="crayon-st">continue</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>So now that we have a reference to our video file/webcam stream, we can start looping over each of the frames on <strong>Line 27</strong>.</p>
<p>A call to 
			<span id="crayon-56d59034951f9529334079" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">camera</span><span class="crayon-sy">.</span><span class="crayon-e">read</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></span></span>  returns a 2-tuple for us. The first value of the tuple is 
			<span id="crayon-56d59034951ff827791069" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">grabbed</span></span></span> , indicating whether or not the 
			<span id="crayon-56d5903495205378618335" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">frame</span></span></span>  was successfully read from the buffer. The second value of the tuple is the 
			<span id="crayon-56d590349520b069815463" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">frame</span></span></span>  itself.</p>
<p>We’ll also define a string named 
			<span id="crayon-56d5903495211010407082" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">text</span></span></span>  and initialize it to indicate that the room we are monitoring is “Unoccupied”. If there is indeed activity in the room, we can update this string.</p>
<p>And in the case that a frame is not successfully read from the video file, we’ll break from the loop on <strong>Lines 35 and 36</strong>.</p>
<p>Now we can start processing our frame and preparing it for motion analysis (<strong>Lines 39-41</strong>). We’ll first resize it down to have a width of 500 pixels — there is no need to process the large, raw images straight from the video stream. We’ll also convert the image to grayscale since color has no bearing on our motion detection algorithm. Finally, we’ll apply Gaussian blurring to smooth our images.</p>
<p>It’s important to understand that even <em>consecutive frames of a video stream will not be identical!</em></p>
<p>Due to tiny variations in the digital camera sensors, no two frames will be 100% the same — some pixels will <em>most certainly</em> have different intensity values. That said, we need to account for this and apply Gaussian smoothing to average pixel intensities across an <em>11 x 11</em> region (<strong>Line 41</strong>). This helps smooth out high frequency noise that could throw our motion detection algorithm off.</p>
<p>As I mentioned above, we need to model the background of our image somehow. Again, we’ll make the assumption that the first frame of the video stream contains <em>no motion</em> and is a <em>good example</em> of what our background looks like. If the 
			<span id="crayon-56d5903495218415912821" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">firstFrame</span></span></span>  is not initialized, we’ll store it for reference and continue on to processing the next frame of the video stream (<strong>Lines 44-46</strong>).</p>
<p>Here’s an example of the first frame of an example video:</p>
<div id="attachment_2356" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2015/05/first_frame_example_02.jpg"><img class="size-full wp-image-2356" src="http://www.pyimagesearch.com/wp-content/uploads/2015/05/first_frame_example_02.jpg" alt="Figure 2: Example first frame of a video file. Notice how it's a still shot of the background, no motion is taking place." srcset="http://www.pyimagesearch.com/wp-content/uploads/2015/05/first_frame_example_02-300x187.jpg 300w, http://www.pyimagesearch.com/wp-content/uploads/2015/05/first_frame_example_02.jpg 500w" sizes="(max-width: 500px) 100vw, 500px"/></a><p class="wp-caption-text"><strong>Figure 2:</strong> Example first frame of a video file. Notice how it’s a still-shot of the background, no motion is taking place.</p></div>
<p>The above frame satisfies the assumption that the first frame of the video is simply the static background — no motion is taking place.</p>
<p>Given this static background image, we’re now ready to actually perform motion detection and tracking:</p>

		<div id="crayon-56d590349521f163368115" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num crayon-striped-num" data-line="crayon-56d590349521f163368115-48">48</p><p class="crayon-num" data-line="crayon-56d590349521f163368115-49">49</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d590349521f163368115-50">50</p><p class="crayon-num" data-line="crayon-56d590349521f163368115-51">51</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d590349521f163368115-52">52</p><p class="crayon-num" data-line="crayon-56d590349521f163368115-53">53</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d590349521f163368115-54">54</p><p class="crayon-num" data-line="crayon-56d590349521f163368115-55">55</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d590349521f163368115-56">56</p><p class="crayon-num" data-line="crayon-56d590349521f163368115-57">57</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d590349521f163368115-58">58</p><p class="crayon-num" data-line="crayon-56d590349521f163368115-59">59</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d590349521f163368115-60">60</p><p class="crayon-num" data-line="crayon-56d590349521f163368115-61">61</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d590349521f163368115-62">62</p><p class="crayon-num" data-line="crayon-56d590349521f163368115-63">63</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d590349521f163368115-64">64</p><p class="crayon-num" data-line="crayon-56d590349521f163368115-65">65</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d590349521f163368115-66">66</p><p class="crayon-num" data-line="crayon-56d590349521f163368115-67">67</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d590349521f163368115-68">68</p><p class="crayon-num" data-line="crayon-56d590349521f163368115-69">69</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line crayon-striped-line" id="crayon-56d590349521f163368115-48"><span class="crayon-h">	</span><span class="crayon-c"># compute the absolute difference between the current frame and</span></p><p class="crayon-line" id="crayon-56d590349521f163368115-49"><span class="crayon-h">	</span><span class="crayon-c"># first frame</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d590349521f163368115-50"><span class="crayon-h">	</span><span class="crayon-v">frameDelta</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">absdiff</span><span class="crayon-sy">(</span><span class="crayon-v">firstFrame</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">gray</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d590349521f163368115-51"><span class="crayon-h">	</span><span class="crayon-v">thresh</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">threshold</span><span class="crayon-sy">(</span><span class="crayon-v">frameDelta</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">25</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">255</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">THRESH_BINARY</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d590349521f163368115-52"> </p><p class="crayon-line" id="crayon-56d590349521f163368115-53"><span class="crayon-h">	</span><span class="crayon-c"># dilate the thresholded image to fill in holes, then find contours</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d590349521f163368115-54"><span class="crayon-h">	</span><span class="crayon-c"># on thresholded image</span></p><p class="crayon-line" id="crayon-56d590349521f163368115-55"><span class="crayon-h">	</span><span class="crayon-v">thresh</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">dilate</span><span class="crayon-sy">(</span><span class="crayon-v">thresh</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">None</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">iterations</span><span class="crayon-o">=</span><span class="crayon-cn">2</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d590349521f163368115-56"><span class="crayon-h">	</span><span class="crayon-sy">(</span><span class="crayon-v">cnts</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">_</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">findContours</span><span class="crayon-sy">(</span><span class="crayon-v">thresh</span><span class="crayon-sy">.</span><span class="crayon-k ">copy</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">RETR_EXTERNAL</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d590349521f163368115-57"><span class="crayon-h">		</span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">CHAIN_APPROX_SIMPLE</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d590349521f163368115-58"> </p><p class="crayon-line" id="crayon-56d590349521f163368115-59"><span class="crayon-h">	</span><span class="crayon-c"># loop over the contours</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d590349521f163368115-60"><span class="crayon-h">	</span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">c</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">cnts</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d590349521f163368115-61"><span class="crayon-h">		</span><span class="crayon-c"># if the contour is too small, ignore it</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d590349521f163368115-62"><span class="crayon-h">		</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">contourArea</span><span class="crayon-sy">(</span><span class="crayon-v">c</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-v">args</span><span class="crayon-sy">[</span><span class="crayon-s">"min_area"</span><span class="crayon-sy">]</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d590349521f163368115-63"><span class="crayon-h">			</span><span class="crayon-st">continue</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d590349521f163368115-64"> </p><p class="crayon-line" id="crayon-56d590349521f163368115-65"><span class="crayon-h">		</span><span class="crayon-c"># compute the bounding box for the contour, draw it on the frame,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d590349521f163368115-66"><span class="crayon-h">		</span><span class="crayon-c"># and update the text</span></p><p class="crayon-line" id="crayon-56d590349521f163368115-67"><span class="crayon-h">		</span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-k ">w</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">h</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">boundingRect</span><span class="crayon-sy">(</span><span class="crayon-v">c</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d590349521f163368115-68"><span class="crayon-h">		</span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">rectangle</span><span class="crayon-sy">(</span><span class="crayon-v">frame</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-k ">w</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">h</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">255</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d590349521f163368115-69"><span class="crayon-h">		</span><span class="crayon-v">text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"Occupied"</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>Now that we have our background modeled via the 
			<span id="crayon-56d5903495227827411825" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">firstFrame</span></span></span>  variable, we can utilize it to compute the difference between the initial frame and subsequent new frames from the video stream.</p>
<p>Computing the difference between two frames is a simple subtraction, where we take the absolute value of their corresponding pixel intensity differences (<strong>Line 50</strong>):</p>
<p><em>delta = |background_model – current_frame|</em></p>
<p>An example of a frame delta can be seen below:</p>
<div id="attachment_2357" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2015/05/frame_delta_example.jpg"><img class="wp-image-2357" src="http://www.pyimagesearch.com/wp-content/uploads/2015/05/frame_delta_example.jpg" alt="Figure 3: An example of the frame delta, the difference between the original first frame and the current frame." srcset="http://www.pyimagesearch.com/wp-content/uploads/2015/05/frame_delta_example-300x110.jpg 300w, http://www.pyimagesearch.com/wp-content/uploads/2015/05/frame_delta_example.jpg 1000w" sizes="(max-width: 600px) 100vw, 600px"/></a><p class="wp-caption-text"><strong>Figure 3:</strong> An example of the frame delta, the difference between the original first frame and the current frame.</p></div>
<p>Notice how the background of the image is clearly <em>black</em>. However, regions that contain motion (such as the region of myself walking through the room) is much <em>lighter</em>. This implies that larger frame deltas indicate that motion is taking place in the image.</p>
<p>We’ll then threshold the 
			<span id="crayon-56d590349522e428422714" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">frameDelta</span></span></span>  on <strong>Line 51</strong> to reveal regions of the image that only have <em>significant</em> changes in pixel intensity values. If the delta is less than <em>25</em>, we discard the pixel and set it to black (i.e. background). If the delta is greater than <em>25</em>, we’ll set it to white (i.e. foreground). An example of our thresholded delta image can be seen below:</p>
<div id="attachment_2358" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2015/05/frame_delta_thresholded.jpg"><img class="wp-image-2358" src="http://www.pyimagesearch.com/wp-content/uploads/2015/05/frame_delta_thresholded.jpg" alt="Figure 4: Thresholding the frame delta image to segment the foreground from the background." srcset="http://www.pyimagesearch.com/wp-content/uploads/2015/05/frame_delta_thresholded-300x107.jpg 300w, http://www.pyimagesearch.com/wp-content/uploads/2015/05/frame_delta_thresholded.jpg 1000w" sizes="(max-width: 600px) 100vw, 600px"/></a><p class="wp-caption-text"><strong>Figure 4:</strong> Thresholding the frame delta image to segment the foreground from the background.</p></div>
<p>Again, note that the background of the image is black, whereas the foreground (and where the motion is taking place) is white.</p>
<p>Given this thresholded image, it’s simple to apply contour detection to to find the outlines of these white regions (<strong>Line 56</strong>).</p>
<p>We start looping over each of the contours on <b>Line 60</b>, where we’ll filter the small, irrelevant contours on <strong>Line 62 and 63</strong>.</p>
<p>If the contour area is larger than our supplied 
			<span id="crayon-56d5903495235644593062" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-o">--</span><span class="crayon-v">min</span><span class="crayon-o">-</span><span class="crayon-v">area</span></span></span> , we’ll draw the bounding box surrounding the foreground and motion region on <strong>Lines 67 and 68</strong>. We’ll also update our 
			<span id="crayon-56d590349523a465536378" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">text</span></span></span>  status string to indicate that the room is “Occupied”.</p>

		<div id="crayon-56d5903495240918416678" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-56d5903495240918416678-71">71</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5903495240918416678-72">72</p><p class="crayon-num" data-line="crayon-56d5903495240918416678-73">73</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5903495240918416678-74">74</p><p class="crayon-num" data-line="crayon-56d5903495240918416678-75">75</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5903495240918416678-76">76</p><p class="crayon-num" data-line="crayon-56d5903495240918416678-77">77</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5903495240918416678-78">78</p><p class="crayon-num" data-line="crayon-56d5903495240918416678-79">79</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5903495240918416678-80">80</p><p class="crayon-num" data-line="crayon-56d5903495240918416678-81">81</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5903495240918416678-82">82</p><p class="crayon-num" data-line="crayon-56d5903495240918416678-83">83</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5903495240918416678-84">84</p><p class="crayon-num" data-line="crayon-56d5903495240918416678-85">85</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5903495240918416678-86">86</p><p class="crayon-num" data-line="crayon-56d5903495240918416678-87">87</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5903495240918416678-88">88</p><p class="crayon-num" data-line="crayon-56d5903495240918416678-89">89</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5903495240918416678-71"><span class="crayon-h">	</span><span class="crayon-c"># draw the text and timestamp on the frame</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5903495240918416678-72"><span class="crayon-h">	</span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">putText</span><span class="crayon-sy">(</span><span class="crayon-v">frame</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"Room Status: {}"</span><span class="crayon-sy">.</span><span class="crayon-k ">format</span><span class="crayon-sy">(</span><span class="crayon-v">text</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">10</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">20</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d5903495240918416678-73"><span class="crayon-h">		</span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">FONT_HERSHEY_SIMPLEX</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0.5</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">255</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5903495240918416678-74"><span class="crayon-h">	</span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">putText</span><span class="crayon-sy">(</span><span class="crayon-v">frame</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-k ">datetime</span><span class="crayon-sy">.</span><span class="crayon-k ">datetime</span><span class="crayon-sy">.</span><span class="crayon-e">now</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">strftime</span><span class="crayon-sy">(</span><span class="crayon-s">"%A %d %B %Y %I:%M:%S%p"</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d5903495240918416678-75"><span class="crayon-h">		</span><span class="crayon-sy">(</span><span class="crayon-cn">10</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">frame</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">FONT_HERSHEY_SIMPLEX</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0.35</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">255</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5903495240918416678-76"> </p><p class="crayon-line" id="crayon-56d5903495240918416678-77"><span class="crayon-h">	</span><span class="crayon-c"># show the frame and record if the user presses a key</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5903495240918416678-78"><span class="crayon-h">	</span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">imshow</span><span class="crayon-sy">(</span><span class="crayon-s">"Security Feed"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">frame</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5903495240918416678-79"><span class="crayon-h">	</span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">imshow</span><span class="crayon-sy">(</span><span class="crayon-s">"Thresh"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">thresh</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5903495240918416678-80"><span class="crayon-h">	</span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">imshow</span><span class="crayon-sy">(</span><span class="crayon-s">"Frame Delta"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">frameDelta</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5903495240918416678-81"><span class="crayon-h">	</span><span class="crayon-v">key</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">waitKey</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-cn">0xFF</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5903495240918416678-82"> </p><p class="crayon-line" id="crayon-56d5903495240918416678-83"><span class="crayon-h">	</span><span class="crayon-c"># if the `q` key is pressed, break from the lop</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5903495240918416678-84"><span class="crayon-h">	</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">key</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-k ">ord</span><span class="crayon-sy">(</span><span class="crayon-s">"q"</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5903495240918416678-85"><span class="crayon-h">		</span><span class="crayon-st">break</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5903495240918416678-86"> </p><p class="crayon-line" id="crayon-56d5903495240918416678-87"><span class="crayon-c"># cleanup the camera and close any open windows</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5903495240918416678-88"><span class="crayon-v">camera</span><span class="crayon-sy">.</span><span class="crayon-e">release</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5903495240918416678-89"><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">destroyAllWindows</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>The remainder of this example simply wraps everything up. We draw the room status on the image in the top-left corner, followed by a timestamp (to make it feel like “real” security footage) on the bottom-left.</p>
<p><strong>Lines 77-80</strong> display the results of our work, allowing us to visualize if any motion was detected in our video, along with the frame delta and thresholded image so we can debug our script.</p>
<p><em><strong>Note:</strong> If you download the code to this post and intend to apply it to your own video files, you’ll likely need to tune the values for 
			<span id="crayon-56d5903495249623568211" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">threshold</span></span></span>  and the 
			<span id="crayon-56d590349524e783362493" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-o">--</span><span class="crayon-v">min</span><span class="crayon-o">-</span><span class="crayon-v">area</span></span></span>  argument to obtain the best results for your lighting conditions.</em></p>
<p>Finally, <strong>Lines 88 and 89</strong> cleanup and release the video stream pointer.</p>
<h1>Results</h1>
<p>Obviously I want to make sure that our motion detection system is working before James, the beer stealer, pays me a visit again — we’ll save that for Part 2 of this series. To test out our motion detection system using Python and OpenCV, I have created two video files.</p>
<p>The first, 
			<span id="crayon-56d5903495254708808014" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">example_01</span><span class="crayon-sy">.</span><span class="crayon-v">mp4</span></span></span>  monitors the front door of my apartment and detects when the door opens. The second, 
			<span id="crayon-56d5903495259951515375" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">example_02</span><span class="crayon-sy">.</span><span class="crayon-v">mp4</span></span></span>  was captured using a Raspberry Pi mounted to my kitchen cabinets. It looks down on the kitchen and living room, detecting motion as people move and walk around.</p>
<p>Let’s give our simple detector a try. Open up a terminal and execute the following command:</p>

		<div id="crayon-56d590349525f295323834" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d590349525f295323834-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">python </span><span class="crayon-v">motion_detector</span><span class="crayon-e">.py</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">video </span><span class="crayon-v">videos</span><span class="crayon-o">/</span><span class="crayon-v">example_01</span><span class="crayon-e">.mp4</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>Below is a .gif of a few still frames from the motion detection:</p>
<div id="attachment_2362" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2015/05/animated_motion_01.gif"><img class="wp-image-2362" src="http://www.pyimagesearch.com/wp-content/uploads/2015/05/animated_motion_01.gif" alt="Figure 5: A few example frames of our motion detection system in Python and OpenCV in action."/></a><p class="wp-caption-text"><strong>Figure 5:</strong> A few example frames of our motion detection system in Python and OpenCV in action.</p></div>
<p>Notice how that no motion is detected until the door opens — then we are able to detect myself walking through the door. You can see the full video here:</p>
<p><iframe src="http://www.youtube.com/embed/fi4LORwk8Fc?feature=oembed" frameborder="0" allowfullscreen="">VIDEO</iframe></p>
<p>Now, what about when I mount the camera such that it’s looking down on the kitchen and living room? Let’s find out. Just issue the following command:</p>

		<div id="crayon-56d5903495265018945126" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5903495265018945126-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">python </span><span class="crayon-v">motion_detector</span><span class="crayon-e">.py</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">video </span><span class="crayon-v">videos</span><span class="crayon-o">/</span><span class="crayon-v">example_02</span><span class="crayon-e">.mp4</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>A sampling of the results from the second video file can be seen below:</p>
<div id="attachment_2361" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2015/05/animated_motion_02.gif"><img class="wp-image-2361" src="http://www.pyimagesearch.com/wp-content/uploads/2015/05/animated_motion_02.gif" alt="animated_motion_02"/></a><p class="wp-caption-text"><strong>Figure 6:</strong> Again, our motion detection system is able to track a person as they walk around a room.</p></div>
<p>And again, here is the full vide of our motion detection results:</p>
<p><iframe src="http://www.youtube.com/embed/36j238XtcIE?feature=oembed" frameborder="0" allowfullscreen="">VIDEO</iframe></p>
<p>So as you can see, our motion detection system is performing fairly well despite how simplistic it is! We are able to detect as I am entering and leaving a room without a problem.</p>
<p>However, to be realistic, the results are far from perfect. We get <em>multiple</em> bounding boxes even though there is only <em>one</em> person moving around the room — this is far from ideal. And we can clearly see that small changes to the lighting, such as shadows and reflections on the wall, trigger false-positive motion detections.</p>
<p>To combat this, we can lean on the more powerful background subtractions methods in OpenCV which can actually account for shadowing and small amounts of reflection (I’ll be covering the more advanced background subtraction/foreground detection methods in future blog posts).</p>
<p><strong>But for the meantime, consider our end goal.</strong></p>
<p>This system, while developed on our laptop/desktop systems, is meant to be deployed to a Raspberry Pi where the computational resources are very limited. Because of this, we need to keep our motion detection methods <em>simple </em>and <em>fast</em>. An unfortunate downside to this is that our motion detection system is not perfect, but it still does a fairly good job for this particular project.</p>
<p>Finally, if you want to perform motion detection on your own raw video stream from your webcam, just leave off the 
			<span id="crayon-56d590349526c385507954" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-o">--</span><span class="crayon-v">video</span></span></span>  switch:</p>

		<div id="crayon-56d5903495272075663911" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5903495272075663911-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">python </span><span class="crayon-v">motion_detector</span><span class="crayon-e">.py</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p/>
<h1>Summary</h1>
<p>In this blog post we found out that my friend James is a beer stealer. What an asshole.</p>
<p>And in order to catch him red handed, we have decided to build a motion detection and tracking system using Python and OpenCV. While basic, this system is capable of taking video streams and analyzing them for motion while obtaining fairly reasonable results given the limitations of the method we utilized.</p>
<p>The end goal if this system is to deploy it to a Raspberry Pi, so we did not leverage some of the more advanced background subtraction methods in OpenCV. Instead, we relied on a simple yet reasonably effective assumption — <em>that the first frame of our video stream contains the background we want to model and nothing more.</em></p>
<p>Under this assumption we were able to perform background subtraction, detect motion in our images, and draw a bounding box surrounding the region of the image that contains motion.</p>
<p>In the <strong>second part</strong> of this series on motion detection, we’ll be <strong>updating this code to run on the Raspberry Pi.</strong></p>
<p>We’ll also be <strong>integrating with the Dropbox API</strong>, allowing us to monitor our home surveillance system and receive real-time updates whenever our system detects motion.</p>
<p>Stay tuned!</p>
<h1 id="post_downloads">Downloads:</h1>

	</section>
	</div></body></html>