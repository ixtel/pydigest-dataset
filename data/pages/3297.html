<html><body><div><div class="content-body" itemprop="text articleBody">
	<div class="section" id="introduction">
<h2>Introduction</h2>
<p>Pandas is excellent at manipulating large amounts of data and summarizing it in
multiple text and visual representations. Without much effort, pandas supports
output to <span class="caps">CSV</span>, Excel, <span class="caps">HTML</span>, json and more. Where things get more difficult is if
you want to combine multiple pieces of data into one document. For example, if you want to put
two DataFrames on one Excel sheet, you need to use the Excel libraries to manually construct your output.
It is certainly possible but not simple. This article will describe one method to
combine multiple pieces of information into an <span class="caps">HTML</span> template and then converting it to a
standalone <span class="caps">PDF</span> document using <a class="reference external" href="http://jinja.pocoo.org/">Jinja templates</a> and <a class="reference external" href="http://weasyprint.org/">WeasyPrint</a>.</p>
<p>Before going too far through this article, I would recommend that you
review the previous articles on <a class="reference external" href="http://pbpython.com/pandas-pivot-table-explained.html">Pandas Pivot Tables</a> and the follow-on article
on generating <a class="reference external" href="http://pbpython.com/pandas-pivot-report.html">Excel reports</a> from these tables. They explain the data set
I am using and how to work with pivot tables.</p>
</div>
<div class="section" id="the-process">
<h2>The Process</h2>
<p>As shown in the <a class="reference external" href="http://pbpython.com/pandas-pivot-report.html">reporting article</a>, it is very convenient to use Pandas to output data
into multiple sheets in an Excel file or create multiple Excel files from
pandas DataFrames. However, if you would like to combine multiple pieces of
information into a single file, there are not many simple ways to do it straight
from Pandas. Fortunately, the python environment has many options to help us out.</p>
<p>In this article, I’m going to use the following process flow to create a
multi-page <span class="caps">PDF</span> document.</p>

<p>The nice thing about this approach is that you can substitute your own tools
into this workflow. Don’t like Jinja? Plug in <a class="reference external" href="http://www.makotemplates.org/">mako</a> or your templating tool of choice.
If you want to use another type of markup outside of <span class="caps">HTML</span>, go for it.</p>
</div>

<div class="section" id="the-data">
<h2>The Data</h2>
<p>As discussed above, we’ll use the same data from my previous articles.
In order to keep this all a self-contained article, here is how I import
the data and generate a pivot table as well as some summary statistics of the
average quantity and price of the <span class="caps">CPU</span> and Software sales.</p>
<p>Import modules, and read in the sales funnel information.</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s">"sales-funnel.xlsx"</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
<div>
<table border="1" class="table table-condensed">
<thead>
<tr>
<th/>
<th>Account</th>
<th>Name</th>
<th>Rep</th>
<th>Manager</th>
<th>Product</th>
<th>Quantity</th>
<th>Price</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td> 714466</td>
<td>              Trantow-Barrows</td>
<td>  Craig Booker</td>
<td> Debra Henley</td>
<td> <span class="caps">CPU</span></td>
<td> 1</td>
<td> 30000</td>
<td> presented</td>
</tr>
<tr>
<th>1</th>
<td> 714466</td>
<td>              Trantow-Barrows</td>
<td>  Craig Booker</td>
<td> Debra Henley</td>
<td>    Software</td>
<td> 1</td>
<td> 10000</td>
<td> presented</td>
</tr>
<tr>
<th>2</th>
<td> 714466</td>
<td>              Trantow-Barrows</td>
<td>  Craig Booker</td>
<td> Debra Henley</td>
<td> Maintenance</td>
<td> 2</td>
<td>  5000</td>
<td>   pending</td>
</tr>
<tr>
<th>3</th>
<td> 737550</td>
<td> Fritsch, Russel and Anderson</td>
<td>  Craig Booker</td>
<td> Debra Henley</td>
<td> <span class="caps">CPU</span></td>
<td> 1</td>
<td> 35000</td>
<td>  declined</td>
</tr>
<tr>
<th>4</th>
<td> 146832</td>
<td>                 Kiehn-Spinka</td>
<td> Daniel Hilton</td>
<td> Debra Henley</td>
<td> <span class="caps">CPU</span></td>
<td> 2</td>
<td> 65000</td>
<td>       won</td>
</tr>
</tbody>
</table>
</div><p>Pivot the data to summarize.</p>
<div class="highlight"><pre><span class="n">sales_report</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s">"Manager"</span><span class="p">,</span> <span class="s">"Rep"</span><span class="p">,</span> <span class="s">"Product"</span><span class="p">],</span> <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="s">"Price"</span><span class="p">,</span> <span class="s">"Quantity"</span><span class="p">],</span>
                           <span class="n">aggfunc</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">],</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">sales_report</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
<div>
<table border="1" class="table table-condensed">
<thead>
<tr>
<th/>
<th/>
<th/>
<th colspan="2" halign="left">sum</th>
<th colspan="2" halign="left">mean</th>
</tr>
<tr>
<th/>
<th/>
<th/>
<th>Price</th>
<th>Quantity</th>
<th>Price</th>
<th>Quantity</th>
</tr>
<tr>
<th>Manager</th>
<th>Rep</th>
<th>Product</th>
<th/>
<th/>
<th/>
<th/>
</tr>
</thead>
<tbody>
<tr>
<th rowspan="5" valign="top">Debra Henley</th>
<th rowspan="3" valign="top">Craig Booker</th>
<th><span class="caps">CPU</span></th>
<td>  65000</td>
<td> 2</td>
<td> 32500</td>
<td> 1</td>
</tr>
<tr>
<th>Maintenance</th>
<td>   5000</td>
<td> 2</td>
<td>  5000</td>
<td> 2</td>
</tr>
<tr>
<th>Software</th>
<td>  10000</td>
<td> 1</td>
<td> 10000</td>
<td> 1</td>
</tr>
<tr>
<th rowspan="2" valign="top">Daniel Hilton</th>
<th><span class="caps">CPU</span></th>
<td> 105000</td>
<td> 4</td>
<td> 52500</td>
<td> 2</td>
</tr>
<tr>
<th>Software</th>
<td>  10000</td>
<td> 1</td>
<td> 10000</td>
<td> 1</td>
</tr>
</tbody>
</table>
</div><p>Generate some overall descriptive statistics about the entire data set.
In this case, we want to show the average quantity and price for <span class="caps">CPU</span> and
Software sales.</p>
<div class="highlight"><pre><span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s">"Product"</span><span class="p">]</span><span class="o">==</span><span class="s">"CPU"</span><span class="p">][</span><span class="s">"Quantity"</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s">"Product"</span><span class="p">]</span><span class="o">==</span><span class="s">"CPU"</span><span class="p">][</span><span class="s">"Price"</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s">"Product"</span><span class="p">]</span><span class="o">==</span><span class="s">"Software"</span><span class="p">][</span><span class="s">"Quantity"</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s">"Product"</span><span class="p">]</span><span class="o">==</span><span class="s">"Software"</span><span class="p">][</span><span class="s">"Price"</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</pre></div>
<pre class="literal-block">
1.88888888889
51666.6666667
1.0
10000.0
</pre>
<p>Ideally what we would like to do now is to split our data up by manager
and include some of the summary statistics on a page to help understand
how the individual results compare to the national averages.</p>
</div>
<div class="section" id="dataframe-options">
<h2>DataFrame Options</h2>
<p>I have one quick aside before we talk templates. For some quick and dirty needs,
sometimes all you need to do is copy and paste the data. Fortunately
a DataFrame has a <code class="code">
to_clipboard()</code>
 function that will copy the whole
DataFrame to the clipboard which you can then easily paste into Excel.
I have found this to be a really helpful option in certain situations.</p>
<p>The other option we will use later in the template is the <code class="code">
to_html()</code>

which will generate a string containing a fully composed <span class="caps">HTML</span> table with
minimal styling applied.</p>
</div>
<div class="section" id="templating">
<h2>Templating</h2>
<p>Jinja templating is very powerful and supports a lot of advanced features
such as sandboxed execution and auto-escaping that are not necessary for this application.
These capabilities however will serve you well as your reports grow more complex or
you choose to use Jinja for your web apps.</p>
<p>The other nice feature of Jinja is that it includes multiple <a class="reference external" href="http://jinja.pocoo.org/docs/dev/templates/#builtin-filters">builtin filters</a>
which will allow us to format some of our data in a way that is difficult
to do within Pandas.</p>
<p>In order to use Jinja in our application, we need to do 3 things:</p>
<ul class="simple">
<li>Create a template</li>
<li>Add variables into the templates context</li>
<li>Render the template into <span class="caps">HTML</span></li>
</ul>
<p>Here is a very simple template, let’s call it <strong>myreport.html</strong> :</p>
<div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>{{ title }}<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h2&gt;</span>Sales Funnel Report - National<span class="nt">&lt;/h2&gt;</span>
     {{ national_pivot_table }}
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
<p>The two keys portions of this code are the <code class="code">
{{ title }}</code>
 and
<code class="code">
{{ national_pivot_table }}</code>
. They are essentially placeholders
for variables that we will provide when we render the document.</p>
<p>To populate those variable, we need to create a Jinja environment and get our template:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">jinja2</span> <span class="kn">import</span> <span class="n">Environment</span><span class="p">,</span> <span class="n">FileSystemLoader</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span><span class="n">loader</span><span class="o">=</span><span class="n">FileSystemLoader</span><span class="p">(</span><span class="s">'.'</span><span class="p">))</span>
<span class="n">template</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s">"myreport.html"</span><span class="p">)</span>
</pre></div>
<p>In the example above, I am assuming that the template is in the current directory
but you could put the full path to a template location.</p>
<p>The other key component is the creation of <code class="code">
env</code>
. This variable is how
we pass content to our template. We create a dictionary called <code class="code">
template_var</code>

that contains all the variable we want to pass to the template.</p>
<p>Note how the names of the variables match our templates.</p>
<div class="highlight"><pre><span class="n">template_vars</span> <span class="o">=</span> <span class="p">{</span><span class="s">"title"</span> <span class="p">:</span> <span class="s">"Sales Funnel Report - National"</span><span class="p">,</span>
                 <span class="s">"national_pivot_table"</span><span class="p">:</span> <span class="n">sales_report</span><span class="o">.</span><span class="n">to_html</span><span class="p">()}</span>
</pre></div>
<p>The final step is to render the <span class="caps">HTML</span> with the variables included in the output.
This will create a string that we will eventually pass to our <span class="caps">PDF</span> creation engine.</p>
<div class="highlight"><pre><span class="n">html_out</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">template_vars</span><span class="p">)</span>
</pre></div>
<p>For the sake of brevity, I won’t show the full <span class="caps">HTML</span> but you should get the idea.</p>
</div>
<div class="section" id="generate-pdf">
<h2>Generate <span class="caps">PDF</span></h2>
<p>The <span class="caps">PDF</span> creation portion is relatively simple as well. We need
to do some imports and pass a string to the <span class="caps">PDF</span> generator.</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">weasyprint</span> <span class="kn">import</span> <span class="n">HTML</span>
<span class="n">HTML</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="n">html_out</span><span class="p">)</span><span class="o">.</span><span class="n">write_pdf</span><span class="p">(</span><span class="s">"report.pdf"</span><span class="p">)</span>
</pre></div>
<p>This command creates a <span class="caps">PDF</span> report that looks something like this:</p>

<p>Ugh. It’s cool that it’s a <span class="caps">PDF</span> but it is ugly. The main problem is that
we don’t have any styling on it. The mechanism we have to use to style
is <span class="caps">CSS</span>.</p>
<p>As an aside, I really don’t like <span class="caps">CSS</span>. Every time I start playing with it
I feel like I spend more time monkeying with the presentation than I did
getting the data summarized. I am open to ideas on how to make this look
nicer but in the end, I decided to go the route of using a portion of
<a class="reference external" href="http://www.blueprintcss.org/">blueprint <span class="caps">CSS</span></a> to have very simple styling that would work with the
rendering engines.</p>
<p>For the rest of the article, I’ll be using blue print’s <a class="reference external" href="http://www.blueprintcss.org/blueprint/src/typography.css">typography.css</a> as the
basis for my style.css shown below. What I like about this css is:</p>
<ul class="simple">
<li>It is relatively small and easy to understand</li>
<li>It works will in the <span class="caps">PDF</span> engines without throwing errors and warnings</li>
<li>It includes basic table formatting that looks pretty decent</li>
</ul>
<p>Let’s try re-rendering it with our updated stylesheet:</p>
<div class="highlight"><pre><span class="n">HTML</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="n">html_out</span><span class="p">)</span><span class="o">.</span><span class="n">write_pdf</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">outfile</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">stylesheets</span><span class="o">=</span><span class="p">[</span><span class="s">"style.css"</span><span class="p">])</span>
</pre></div>

<p>Just adding a simple stylesheet makes a huge difference!</p>
<p>There is still a lot more you can do with it but this shows how to make it
at least serviceable for a start. As an aside, I think it would be pretty
cool if someone that knew <span class="caps">CSS</span> way better than me developed an open sourced, simple
<span class="caps">CSS</span> sheet we could use for report generation like this.</p>
</div>
<div class="section" id="more-complex-templating">
<h2>More Complex Templating</h2>
<p>Up until now, we haven’t done anything different than if we had just generated
a simple Excel sheet using <code class="code">
to_excel()</code>
 on a DataFrame.</p>
<p>In order to generate a more useful report, we are going to combine the
summary statistics shown above as well as break out the report to include
a separate <span class="caps">PDF</span> page per manager.</p>
<p>Let’s start with the updated template (<strong>myreport.html</strong>):</p>
<div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>{{ title }} <span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h2&gt;</span>Sales Funnel Report - National<span class="nt">&lt;/h2&gt;</span>
     {{ national_pivot_table }}
    {% include "summary.html" %}
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
    {% for manager in Manager_Detail %}
        <span class="nt">&lt;p</span> <span class="na">style=</span><span class="s">"page-break-before: always"</span> <span class="nt">&gt;&lt;/p&gt;</span>
        <span class="nt">&lt;h2&gt;</span>Sales Funnel Report - {{manager.0}}<span class="nt">&lt;/h2&gt;</span>
        {{manager.1}}
        {% include "summary.html" %}
    {% endfor %}
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
<p>The first thing you’ll notice is that there is an <code class="code">
include</code>
 statement
which mentions another file. The <code class="code">
include</code>
 allows us to bring in a snippet
of <span class="caps">HTML</span> and use it repeteadly in different portions of the code. In this case
the summary contains some simple national level stats we want to include on
each report so that the managers can compare their performance to the national average.</p>
<p>Here is what <strong>summary.html</strong> looks like:</p>
<div class="highlight"><pre><span class="nt">&lt;h3&gt;</span>National Summary: CPUs<span class="nt">&lt;/h3&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
        <span class="nt">&lt;li&gt;</span>Average Quantity: {{CPU.0|round(1)}}<span class="nt">&lt;/li&gt;</span>
        <span class="nt">&lt;li&gt;</span>Average Price: {{CPU.1|round(1)}}<span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
<span class="nt">&lt;h3&gt;</span>National Summary: Software<span class="nt">&lt;/h3&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
        <span class="nt">&lt;li&gt;</span>Average Quantity: {{Software.0|round(1)}}<span class="nt">&lt;/li&gt;</span>
        <span class="nt">&lt;li&gt;</span>Average Price: {{Software.1|round(1)}}<span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
</pre></div>
<p>In this snippet, you’ll see that there are some additional variables
we have access to: <code class="code">
CPU</code>
 and <code class="code">
Software</code>
. Each of these is a python
list that includes the average quantity and price for <span class="caps">CPU</span> and Software sales.</p>
<p>You may also notice that we use a pipe <code class="code">
|</code>
 to <code class="code">
round</code>
 each value
to 1 decimal place. This is one specific example of the use of Jinja’s filters.</p>
<p>There is also a for loop that allows us to display the details for each manager
in our report. Jinja’s template language only includes a very small subset
of code that alters the control flow. Basic for-loops are a mainstay of
almost any template so they should make sense to most of you.</p>
<p>I want to call out one final piece of code that looks a little out of place:</p>
<div class="highlight"><pre><span class="nt">&lt;p</span> <span class="na">style=</span><span class="s">"page-break-before: always"</span> <span class="nt">&gt;&lt;/p&gt;</span>
</pre></div>
<p>This is a simple <span class="caps">CSS</span> directive that I put in to make sure the <span class="caps">CSS</span> breaks on each
page. I had to do a little digging to figure out the best way to make the pages
break so I thought I would include it to help others out.</p>
</div>
<div class="section" id="additional-stats">
<h2>Additional Stats</h2>
<p>Now that we have gone through the templates, here is how to create the additional
context variables used in the templates.</p>
<p>Here is a simple summary function:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">get_summary_stats</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">product</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    For certain products we want National Summary level information on the reports</span>
<span class="sd">    Return a list of the average quantity and price</span>
<span class="sd">    """</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s">"Product"</span><span class="p">]</span><span class="o">==</span><span class="n">product</span><span class="p">][</span><span class="s">"Quantity"</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s">"Product"</span><span class="p">]</span><span class="o">==</span><span class="n">product</span><span class="p">][</span><span class="s">"Price"</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">results</span>
</pre></div>
<p>We also need to create the manager details:</p>
<div class="highlight"><pre><span class="n">manager_df</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">manager</span> <span class="ow">in</span> <span class="n">sales_report</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
    <span class="n">manager_df</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">manager</span><span class="p">,</span> <span class="n">sales_report</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to_html</span><span class="p">()])</span>
</pre></div>
<p>Finally, call the template with these variables:</p>
<div class="highlight"><pre><span class="n">template_vars</span> <span class="o">=</span> <span class="p">{</span><span class="s">"title"</span> <span class="p">:</span> <span class="s">"National Sales Funnel Report"</span><span class="p">,</span>
                 <span class="s">"CPU"</span> <span class="p">:</span> <span class="n">get_summary_stats</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s">"CPU"</span><span class="p">),</span>
                 <span class="s">"Software"</span><span class="p">:</span> <span class="n">get_summary_stats</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s">"Software"</span><span class="p">),</span>
                 <span class="s">"national_pivot_table"</span><span class="p">:</span> <span class="n">sales_report</span><span class="o">.</span><span class="n">to_html</span><span class="p">(),</span>
                 <span class="s">"Manager_Detail"</span><span class="p">:</span> <span class="n">manager_df</span><span class="p">}</span>
<span class="c"># Render our file and create the PDF using our css style file</span>
<span class="n">html_out</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">template_vars</span><span class="p">)</span>
<span class="n">HTML</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="n">html_out</span><span class="p">)</span><span class="o">.</span><span class="n">write_pdf</span><span class="p">(</span><span class="s">"report.pdf"</span><span class="p">,</span><span class="n">stylesheets</span><span class="o">=</span><span class="p">[</span><span class="s">"style.css"</span><span class="p">])</span>
</pre></div>
<p>Here is the final <a class="reference external" href="http://pbpython.com/extras/report.pdf"><span class="caps">PDF</span> Report</a> . I think it looks pretty decent for a simple report.</p>
</div>
<div class="section" id="ideas-for-improvements">
<h2>Ideas For Improvements</h2>
<p>In the example above, we used the simple <code class="code">
to_html()</code>
 to generate
our <span class="caps">HTML</span>. I suspect that when you start to do more of these you will
want to have finer grained control over the output of your table.</p>
<p>There are a couple of <a class="reference external" href="http://pandas.pydata.org/pandas-docs/dev/generated/pandas.DataFrame.to_html.html">options</a>:</p>
<ul class="simple">
<li>Pass a custom css class to_html using <code class="code">
classes</code>
</li>
<li>Use <code class="code">
formatters</code>
 to format the data</li>
<li>Pass the data directly to your template and use <code class="code">
iterrows</code>
 to manually construct your table</li>
</ul>
</div>
<div class="section" id="final-program">
<h2>Final Program</h2>
<p>In order to pull it all together, here is the full program:</p>
<div class="highlight"><pre><span class="sd">"""</span>
<span class="sd">Generate PDF reports from data included in several Pandas DataFrames</span>
<span class="sd">From pbpython.com</span>
<span class="sd">"""</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">from</span> <span class="nn">jinja2</span> <span class="kn">import</span> <span class="n">Environment</span><span class="p">,</span> <span class="n">FileSystemLoader</span>
<span class="kn">from</span> <span class="nn">weasyprint</span> <span class="kn">import</span> <span class="n">HTML</span>


<span class="k">def</span> <span class="nf">create_pivot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">infile</span><span class="p">,</span> <span class="n">index_list</span><span class="o">=</span><span class="p">[</span><span class="s">"Manager"</span><span class="p">,</span> <span class="s">"Rep"</span><span class="p">,</span> <span class="s">"Product"</span><span class="p">],</span> <span class="n">value_list</span><span class="o">=</span><span class="p">[</span><span class="s">"Price"</span><span class="p">,</span> <span class="s">"Quantity"</span><span class="p">]):</span>
    <span class="sd">"""</span>
<span class="sd">    Create a pivot table from a raw DataFrame and return it as a DataFrame</span>
<span class="sd">    """</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index_list</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">value_list</span><span class="p">,</span>
                           <span class="n">aggfunc</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">],</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">table</span>

<span class="k">def</span> <span class="nf">get_summary_stats</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">product</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    For certain products we want National Summary level information on the reports</span>
<span class="sd">    Return a list of the average quantity and price</span>
<span class="sd">    """</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s">"Product"</span><span class="p">]</span><span class="o">==</span><span class="n">product</span><span class="p">][</span><span class="s">"Quantity"</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s">"Product"</span><span class="p">]</span><span class="o">==</span><span class="n">product</span><span class="p">][</span><span class="s">"Price"</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">results</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s">'Generate PDF report'</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'infile'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">FileType</span><span class="p">(</span><span class="s">'r'</span><span class="p">),</span>
    <span class="n">help</span><span class="o">=</span><span class="s">"report source file in Excel"</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'outfile'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">FileType</span><span class="p">(</span><span class="s">'w'</span><span class="p">),</span>
    <span class="n">help</span><span class="o">=</span><span class="s">"output file in PDF"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="c"># Read in the file and get our pivot table summary</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">infile</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">sales_report</span> <span class="o">=</span> <span class="n">create_pivot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">infile</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="c"># Get some national summary to include as well</span>
    <span class="n">manager_df</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">manager</span> <span class="ow">in</span> <span class="n">sales_report</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="n">manager_df</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">manager</span><span class="p">,</span> <span class="n">sales_report</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to_html</span><span class="p">()])</span>
    <span class="c"># Do our templating now</span>
    <span class="c"># We can specify any directory for the loader but for this example, use current directory</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span><span class="n">loader</span><span class="o">=</span><span class="n">FileSystemLoader</span><span class="p">(</span><span class="s">'.'</span><span class="p">))</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s">"myreport.html"</span><span class="p">)</span>
    <span class="n">template_vars</span> <span class="o">=</span> <span class="p">{</span><span class="s">"title"</span> <span class="p">:</span> <span class="s">"National Sales Funnel Report"</span><span class="p">,</span>
                     <span class="s">"CPU"</span> <span class="p">:</span> <span class="n">get_summary_stats</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s">"CPU"</span><span class="p">),</span>
                     <span class="s">"Software"</span><span class="p">:</span> <span class="n">get_summary_stats</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s">"Software"</span><span class="p">),</span>
                     <span class="s">"national_pivot_table"</span><span class="p">:</span> <span class="n">sales_report</span><span class="o">.</span><span class="n">to_html</span><span class="p">(),</span>
                     <span class="s">"Manager_Detail"</span><span class="p">:</span> <span class="n">manager_df</span><span class="p">}</span>
    <span class="c"># Render our file and create the PDF using our css style file</span>
    <span class="n">html_out</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">template_vars</span><span class="p">)</span>
    <span class="n">HTML</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="n">html_out</span><span class="p">)</span><span class="o">.</span><span class="n">write_pdf</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">outfile</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">stylesheets</span><span class="o">=</span><span class="p">[</span><span class="s">"style.css"</span><span class="p">])</span>
</pre></div>
<p>You can also view the <a class="reference external" href="https://gist.github.com/chris1610/d5a0f1dd1a69fc623437">gist</a> if you are interested amd download a <a class="reference external" href="http://pbpython.com/extras/pbpython-report-files.zip">zip file</a> of
<strong>myreport.html</strong>, <strong>style.css</strong> and <strong>summary.html</strong> if you find it helpful.</p>
<p>Thanks for reading all the way to the end. As always, feedback is appreciated.</p>
</div>

  </div>
  
</div></body></html>