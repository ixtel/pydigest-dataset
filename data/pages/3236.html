<html><body><div><div class="post-content">
				<p class="western">We set up a computing cluster running five Raspberry Pi’s for a project in Africa. The machines ran on solar power with the idea of supporting 2000 to 10,000 concurrent connections. The cluster also ran Docker.</p>
<p class="western">We then wanted to allow a Python program to exploit the multiple processors of the cluster to perform various tasks. To accomplish this, we needed to install the message passing interface <a title="MPI for Python" href="http://mpi4py.scipy.org/" class="ext-link" rel="external nofollow">(MPI) for Python</a>, which provides binding of the MPI standard for the Python programming language.</p>
<p class="western">This article describes how to install and test the MPI for Python and assumes that the Raspberry Pi cluster is running the latest <a title="Raspbian Home Page" href="http://www.raspbian.org/" class="ext-link" rel="external nofollow">Raspbian</a> OS. The <a title="MPICH2 Home Page" href="http://www.mpich.org/" class="ext-link" rel="external nofollow">MPICH2</a> interface should also be installed and operational.</p>
<p class="western">The MPI for Python software needs to be loaded individually on each cluster node, so being able to log in using a secure shell (SSH), is required. If you already know how to use SSH, you may skip the next section and just proceed to the MPI for Python installation and testing instructions. Let’s see how to get going with SSH.</p>
<h2 class="western"><b>Using SSH</b></h2>
<p class="western"><a title="SSH Home Page" href="http://www.openssh.com/" class="ext-link" rel="external nofollow">SSH</a> stands for secure shell and is an encrypted remote login protocol. Once it has been set up on each node, it’s used to communicate with the other nodes on that network.</p>
<p class="western">The main benefits of SSH are:</p>
<ul>
<li>
<p class="western">SSH uses the RSA encryption algorithm to generate public and private keys, making intrusion extremely difficult.</p>
</li>
<li>
<p class="western">Since SSH is a remote login protocol, it can be configured on a laptop allowing connectivity to the raspberry pi cluster, even over WiFi.</p>
</li>
<li>
<p class="western">SCP (Secure Copy) and SFTP (Secure File Transfer Protocol) run on top of SSH, allowing you to transfer files and directories directly from one node to another.</p>
</li>
<li>
<p class="western">SSH supports one-time log in. This means that you only have to enter credentials the first time you log in. From the second log in onwards, you go right to the shell.</p>
</li>
</ul>
<p class="western">To log in to another node from the master node use the following command.</p>
<p class="western"><i>ssh </i><span><span lang="zxx"><span><a href="mailto:pi@192.168.3.216"><i>pi@192.168.3.216</i></a></span></span></span> (replace the IP address to with one of your worker node addresses)</p>
<p class="western">Enter your password. Once you log in, all the commands you type will run on that node and not on the master.</p>
<p class="western">SSH can also be used to run commands directly on the other nodes. For example, to change the host name on three of the nodes, use these commands:</p>
<p class="western"><i>ssh pi@192.168.3.216 ‘sudo echo “cilent001″ | sudo nano /etc/hostname<br/>
ssh pi@192.168.3.217 ‘sudo echo “cilent002″ | sudo nano /etc/hostname<br/>
ssh pi@192.168.3.218 ‘sudo echo “cilent003″ | sudo nano /etc/hostname </i></p>
<p class="western">Here’s another example.</p>
<p class="western"><i>ssh pi@192.168.3.216 ‘sudo poweroff’</i></p>
<p class="western">This command safely shuts down the node at IP address 192.168.3.216.</p>
<p class="western">The following figure shows how SSH is used to log in to a worker node (192.168.3.216) and from the worker node, get the control terminal back to the master node.</p>
<p class="western"><a href="http://thenewstack.io/wp-content/uploads/2015/01/ssh-screenshot.png" class="local-link"><img class=" wp-image-227682 size-large aligncenter" src="http://thenewstack.io/wp-content/uploads/2015/01/ssh-screenshot-1024x761.png" alt="ssh-screenshot" srcset="http://thenewstack.io/wp-content/uploads/2015/01/ssh-screenshot-300x223.png 300w, http://thenewstack.io/wp-content/uploads/2015/01/ssh-screenshot-1024x761.png 1024w, http://thenewstack.io/wp-content/uploads/2015/01/ssh-screenshot.png 1100w" sizes="(max-width: 640px) 100vw, 640px"/></a></p>
<p class="western">As you can see in the above figure, logging in to a worker node happens directly. But each time the control of the terminal comes back to the master node (192.168.3.215), the login credential has to be re-entered.</p>
<p class="western">So after issuing commands via SSH to other nodes, there might be situations where data has to be sent to multiple nodes over SSH. If the number of nodes are small, then we can manually log in to each node, connect it to a display and keyboard, and send files. This is a highly inefficient way to do it when the size of the cluster is large.</p>
<p class="western">The easy way is to use SCP to send the files. Install SCP using the following command.</p>
<p class="western"><i>sudo apt-get install scp</i></p>
<p class="western">The general form of the command is as follows:</p>
<p class="western">scp (path of file on local device) pi@192.168.3.215 (path of remote location)</p>
<p class="western">Take a look at this example.</p>
<p class="western"><i>scp /pi/example.c pi@192.168.3.215 /pi/project </i></p>
<p class="western">Here, the file is sent to the remote device using it’s IP address. Many files in a directory can be sent using the recursive option (-R), such as the following.</p>
<p class="western"><i>scp -R /pi/project pi@192.168.3.216 /pi/project</i></p>
<p class="western">This command recursively transfers all the files in the /pi/project directory from the local host to the directory on the remote host, identified by the IP address.</p>
<p class="western">With remote login using SSH out of the way, we can now turn our attention to installing MPI for Python on the cluster.</p>
<h2 class="western"><b>Installing MPI for Python</b></h2>
<p class="western">The conventional way to load MPI for Python, known as mpi4py, will not work. It is usually installed with the following command line.</p>
<p class="western"><i>sudo apt-get install python-mpi4py</i></p>
<p class="western">This approach will crash when executed because it installs a copy of openMPI, which conflicts with the already installed MPICH2 software. MPICH2 system is designed to run only one interface and when multiple instances are started, the whole cluster fails.</p>
<p class="western">To avoid this grave situation and the tedious task of restoring the operating system back to its previous state, a work-around exists. It’s a relatively straightforward matter to build mpi4py manually, on each of the nodes in the cluster.</p>
<p class="western">Here are the steps.</p>
<p class="western">1) Download the mpi4py package.</p>
<p class="western"><i>curl –k –O</i><span><span lang="zxx"><span><a href="https://mpi4py.googlecode.com/files/mpi4py-1.3.1.tar.gz" class="ext-link" rel="external nofollow"><i> https://mpi4py.googlecode.com/files/mpi4py-1.3.1.tar.gz</i></a></span></span></span></p>
<p class="western">You can use wget instead of curl but I couldn’t find an option that bypasses the certificate issue that hasn’t been resolved by the website maintenance team.</p>
<p class="western">2) Unpack it and then change into the mpi directory.</p>
<p class="western"><i>tar –zxf mpi4py-1.3.1.tar.gz</i></p>
<p class="western"><i>cd mpi4py-1.3.1.tar.gz</i></p>
<p class="western">3) Before starting the build, it is important to make sure that all the Python development tools are available. This ensures that many important header files like Python.h are present and can be used by the build function.</p>
<p class="western">This step can be skipped if the python development tools are already installed.</p>
<p class="western"><i>sudo apt-get update –fix-missing</i></p>
<p class="western"><i>sudo apt-get install python-dev</i></p>
<p class="western">4) Now, build the package.</p>
<p class="western"><i>cd mpi4py-1.3.1.tar.gz</i></p>
<p class="western"><i>sudo python setup.py build –mpicc=/usr/local/mpich2/bin/mpicc</i></p>
<p class="western">A few things need to be noted here:</p>
<ul>
<li>
<p class="western">The option –mpicc is used to provide the build file the location of the MPI compiler.</p>
</li>
<li>
<p class="western">The option –mpicc has to be used only if the location of that compiler doesn’t already exist in the system path.</p>
</li>
<li>
<p class="western">The path /usr/local/mpich2/bin/mpicc is the location on my node, where the mpich2 is built. It might not be the same for everyone and so that has to be replaced with the path, where mpicc is located in that system.</p>
</li>
</ul>
<p class="western">Now we can start the build. Change the working directory to mpi4py:</p>
<p class="western"><i>cd mpi4py</i></p>
<p class="western">Next, run the following command</p>
<p class="western"><i>sudo python setup.py install</i></p>
<p class="western">Once the command finishes, repeat the process on every other node in the cluster. Then the demo program helloworld.py can be run to test if mpi4py is installed on all the node successfully and is running correctly.</p>
<p class="western">At the command line execute the following.</p>
<p class="western"><i>python helloworld.py</i></p>
<p class="western">If the nodes of the cluster aren’t already built, then the easier way to do it would be to perform the above procedure on one node and read the entire image of the OS and write it into the SD cards of each of the other node. This would eliminate building the mpi4py package on each node individually.</p>
<h2 class="western"><b>Testing mpi4py And Running MPI With Python Programs</b></h2>
<p class="western">We just finished building mpi4py so that we can write and run Python programs using MPICH. We need to test mpi4py and make sure everything is working correctly.</p>
<p class="western">You should have a file named machinefile (example screenshot below) that stores the IP addresses of all the nodes in the network. This will be used by the MPICH to communicate and send/receive messages between various nodes.</p>
<p class="western"><a href="http://thenewstack.io/wp-content/uploads/2015/01/machinefile-screenshot.png" class="local-link"><img class="aligncenter wp-image-227677 size-full" src="http://thenewstack.io/wp-content/uploads/2015/01/machinefile-screenshot.png" alt="machinefile-screenshot" srcset="http://thenewstack.io/wp-content/uploads/2015/01/machinefile-screenshot-278x300.png 278w, http://thenewstack.io/wp-content/uploads/2015/01/machinefile-screenshot.png 361w" sizes="(max-width: 361px) 100vw, 361px"/></a></p>
<p class="western">In the extracted directory mpi4py, there is another directory named demo. The demo directory has a variety of Python programs that can be run to test mpi4py.</p>
<p class="western">A good, basic testing program is helloworld.py. The procedure to run it is:</p>
<p class="western"><i>cd ~/mpi4py/demo</i></p>
<p class="western"><i>mpiexec –np 4 –machinefile ~/mpitest/machinefile python helloworld.py</i></p>
<p class="western">The output should look something like the following screenshot.</p>
<p class="western"><a href="http://thenewstack.io/wp-content/uploads/2015/01/mpi-execution.png" class="local-link"><img class="aligncenter wp-image-227678 size-full" src="http://thenewstack.io/wp-content/uploads/2015/01/mpi-execution.png" alt="mpi-execution" srcset="http://thenewstack.io/wp-content/uploads/2015/01/mpi-execution-300x60.png 300w, http://thenewstack.io/wp-content/uploads/2015/01/mpi-execution.png 918w" sizes="(max-width: 918px) 100vw, 918px"/></a></p>
<p class="western">If the output looks similar to the above and all the nodes have been included, then it works.</p>
<p class="western">Note that ~/mpi4py/demo is the path to mpi4py on my system and should be replaced with the one under your username. The same goes for the path to your machinefile.</p>
<p class="western">There are other programs in the demo directory that can also be used.</p>
<p class="western">A few benchmark programs have been created by Ohio State University.</p>
<ul>
<li>
<p class="western">osu_bw.py – This program calculates bandwidth. The master node sends out a series of fixed size messages to other nodes, and the receiver sends a reply only after all the messages are received. So the master node calculates the bandwidth based on the time elapsed and bytes sent by the user.</p>
</li>
<li>
<p class="western">osu_bibw.py – This program is similar to the above, except both nodes are involved in sending and receiving a series of messages.</p>
</li>
<li>
<p class="western">osu_latency.py – This program sends messages to various nodes and waits for a reply. This repeats a number of times and then the latency is calculated.</p>
</li>
</ul>
<p class="western">Many of the other programs in the demo directory can also be used for testing. All of these can be run in a similar way to the helloworld.py program.</p>
<p class="western">The following screenshot shows the output of the osu_latency.py program.</p>
<p class="western"><a href="http://thenewstack.io/wp-content/uploads/2015/01/osu-latency-screenshot.png" class="local-link"><img class="alignnone wp-image-227681 size-full" src="http://thenewstack.io/wp-content/uploads/2015/01/osu-latency-screenshot.png" alt="osu-latency-screenshot" srcset="http://thenewstack.io/wp-content/uploads/2015/01/osu-latency-screenshot-300x170.png 300w, http://thenewstack.io/wp-content/uploads/2015/01/osu-latency-screenshot-1024x581.png 1024w, http://thenewstack.io/wp-content/uploads/2015/01/osu-latency-screenshot.png 1394w" sizes="(max-width: 1394px) 100vw, 1394px"/></a></p>
<p class="western">Once testing is done, programs compatible with MPI can be written using Python. All the nodes in the cluster should run the same program and depending on conditions, executes only a part of the program, thereby allowing parallel execution.</p>
<p class="western">This also means that we can write two different programs and give it the same name on different nodes. You could use this technique to create a server program and store it on the master node. You could then write a client program and store it with the same name, on worker nodes.</p>
<p class="western">The following screenshot shows a sample MPI program.</p>
<p class="western"><a href="http://thenewstack.io/wp-content/uploads/2015/01/mpi-sample-program.png" class="local-link"><img class="alignnone wp-image-227680 size-full" src="http://thenewstack.io/wp-content/uploads/2015/01/mpi-sample-program.png" alt="mpi-sample-program" srcset="http://thenewstack.io/wp-content/uploads/2015/01/mpi-sample-program-300x252.png 300w, http://thenewstack.io/wp-content/uploads/2015/01/mpi-sample-program.png 583w" sizes="(max-width: 583px) 100vw, 583px"/></a></p>
<p class="western">The file is a communicator application that contains several methods and gathers some process information. I called it MPI.COMM_WORLD. Its features include the following.</p>
<ul>
<li>
<p class="western">comm.rank – It gives the rank of the process running on that processor or node.</p>
</li>
<li>
<p class="western">comm.size – It provides the number of nodes in the cluster</p>
</li>
<li>
<p class="western">comm.get_processor_name() – It gives the name of the processor on which a particular process is running.</p>
</li>
<li>
<p class="western">com.send() – is used to send data to a node, indicated by the dest parameter.</p>
</li>
<li>
<p class="western">comm.receive() – is used to receive some data from source node received from the node indicated by the source parameter.</p>
</li>
</ul>
<p class="western">These are the basic functions and many other functions are available, to create MPI compliant Python programs.</p>
<p class="western">Note that if edge conditions exist and the number of processes exceed the number of nodes, then the execution of the program will fail. To avoid this situation, the processes can be given a loop around by using the %size operation as shown in the screenshot above. The process would then wrap around to the first processor to do the task.</p>
<h2 class="western"><strong>Next Steps</strong></h2>
<p class="western">We’ve taken a quick tour through how to use SSH, install MPI for Python, and how to test the finished installation. A lot more can be done with this cluster, including adding more nodes. Give it a try and be sure to share your experiences in the comments.</p>
<p class="western"><em>Feature image <a href="http://thenewstack.io/?p=224945&amp;preview=true&amp;preview_id=224945&amp;preview_nonce=92628f99e9&amp;post_format=standard" class="local-link">via</a> Flickr Creative Commons.</em></p>
			</div>
			
					
		</div></body></html>