<html><body><div><div class="e-content entry-content" itemprop="articleBody text">
    <p>I've recently been working on a set of internal tools for automating common
processes. It's leveraging some great open source projects
(<a class="reference external" href="http://www.fabfile.org/">Fabric</a>, <a class="reference external" href="http://www.ansible.com/home">Ansible</a>,
<a class="reference external" href="https://www.docker.com/">Docker</a>, <a class="reference external" href="http://www.vagrantup.com/">Vagrant</a>, and
more) but the core functionality is in a python package which we're deploying to
a private PyPi repo. (Not <a class="reference external" href="http://doc.devpi.net/latest/">devpi</a> yet, but
hopefully soon.)</p>
<p>There are quite a few internal users of our package, so we were finding
ourselves needing to do point releases pretty often. Since we were already using
fabric, we put a basic version of our release process into a <cite>fabfile.py</cite>, and it's
grown to the point that a lot of useful things happen when you run <cite>fab
release</cite>.</p>
<ul class="simple">
<li>We use <a class="reference external" href="https://github.com/peritus/bumpversion">bumpversion</a> to figure out
the current and next version numbers, configurably updating the right
major/minor/point values.</li>
<li>It opens your default <cite>$EDITOR</cite> with an already-added new section in the
<cite>HISTORY.rst</cite>, then commits that edit.</li>
<li>The version is bumped and the release is tagged.</li>
<li>The software is built</li>
<li>The build is shipped to the private PyPI Repo</li>
<li>The documentation is built and then shipped</li>
<li>Finally, the right channel in our <a class="reference external" href="http://slack.com">#slack</a> chat room is notified.</li>
</ul>
<p>All that's left to do is push all the changes to <cite>origin</cite>. This is done manually
in case anything went horribly wrong; it's easy to revert the changes to your
local repository, much uglier when a mess has gone upstream.</p>
<p>You can view the whole <a class="reference external" href="https://gist.github.com/jbarratt/85c91d7b904462702892">release fabfile.py as a gist</a>. This feels like the
kind of thing that could be (and probably has been) abstracted and generalized,
but this works for now.</p>
<p>There's nothing too complicated in the file, but there are some nice tricks. One
of the most fun capabilities is the Slack integration, which we recently did.
All credit to slack, it was incredibly easy.</p>
<pre class="code python literal-block">
<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">notify_slack</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">""" Notify the slack channel of a new release """</span>

    <span class="c"># hardcoded URI from the slack integration panel</span>
    <span class="n">url</span> <span class="o">=</span> <span class="p">(</span><span class="s">"https://ourteam.slack.com/services/hooks/incoming-webhook"</span>
           <span class="s">"?token=tokenid"</span><span class="p">)</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'username'</span><span class="p">:</span> <span class="s">'ourpackage-fabfile'</span><span class="p">,</span>
        <span class="s">'icon_emoji'</span><span class="p">:</span> <span class="s">':shipit:'</span><span class="p">,</span>
        <span class="s">'text'</span><span class="p">:</span> <span class="s">'Deployed version {} of ourpackage-python'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">version</span><span class="p">)}</span>

    <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
</pre>
<p>Automating the release process has made it take seconds and, more importantly,
work identically every time. It's well worth doing. (I just can't shake the
feeling that there's a more generic way to do it.)</p>
<p><strong>Update</strong>: I was pointed to <a class="reference external" href="http://zestreleaser.readthedocs.org/en/latest/">zest.releaser</a> which has the same basic
features, minus the slack integration. You can also use it with
<a class="reference external" href="https://pypi.python.org/pypi/gocept.zestreleaser.customupload">gocept.zestreleaser.customupload</a> to enable the scp uploading we're doing here via fabric.</p>
    </div>
    </div></body></html>