<html><body><div><div id="article_text">
    <p>When I attended the <a class="reference external" href="http://www.meetup.com/The-London-Django-Meetup-Group/">London Django Meetup</a> in May one of my fellow attendees asked how best to test files uploaded to Amazon S3 via a form. I used the question as the basis of a talk I gave at a later meet up in July. This post is the written form of that talk I gave.</p>
<div class="section" id="when-you-test-patch-network-requests">
<h2>When you test, patch network requests</h2>
<p>When I write tests I try and patch all external network requests in order to:</p>
<ol class="arabic simple">
<li>Isolate the behaviour of my code during testing.</li>
<li>Speed up the test by avoiding network operations.</li>
<li>Avoid leaving leftover files in storage buckets in the cloud.</li>
</ol>
</div>
<div class="section" id="get-the-boilerplate-code-out-of-the-way">
<h2>Get the boilerplate code out of the way</h2>
<p>The full source code for this tutorial can be found on <a class="reference external" href="https://github.com/marklit/meetup-testing">GitHub</a>.</p>
<p>To start, I installed various requirements I'll need both to run and to test this project:</p>
<div class="highlight"><pre><span class="nv">$ </span>cat requirements.txt
<span class="nv">Django</span><span class="o">==</span>1.6.5
<span class="nv">argparse</span><span class="o">==</span>1.2.1
<span class="nv">boto</span><span class="o">==</span>2.30.0
django-boto<span class="o">==</span>0.3.1
django-storages<span class="o">==</span>1.1.8
<span class="nv">mock</span><span class="o">==</span>1.0.1
<span class="nv">wsgiref</span><span class="o">==</span>0.1.2

<span class="nv">$ </span>pip install -r requirements.txt
</pre></div>
<p>I then created a Dajngo project called <cite>meetup-testing</cite> and created a <cite>candidate</cite> application within it. Here is the layout of the files and folders:</p>
<div class="highlight"><pre><span class="nv">$ </span>tree
.
├── base
│   ├── __init__.py
│   ├── local_settings.py
│   ├── settings.py
│   ├── urls.py
│   └── wsgi.py
├── candidate
│   ├── admin.py
│   ├── fixtures
│   │   └── gradient.jpg
│   ├── forms.py
│   ├── __init__.py
│   ├── models.py
│   ├── tests.py
│   └── views.py
├── manage.py
├── README.md
├── requirements.txt
└── templates
    ├── candidate.html
    └── thanks.html
</pre></div>
<p>I use <a class="reference external" href="http://boto.readthedocs.org/en/latest/s3_tut.html">boto</a> to perform the I/O between my server and Amazon S3. It requires an access key id, secret access key and bucket name. I've kept these out of <cite>settings.py</cite> and instead placed them in <cite>local_settings.py</cite> which is excluded from the git repo. I also took <cite>SECRET_KEY</cite> out of the boilerplate <cite>settings.py</cite> Django generates and placed it in <cite>local_settings.py</cite> as well.</p>
<div class="highlight"><pre><span class="nv">$ </span>cat base/local_settings.py
<span class="nv">AWS_S3_ACCESS_KEY_ID</span> <span class="o">=</span> <span class="s1">'Get this from Amazon'</span>
<span class="nv">AWS_S3_SECRET_ACCESS_KEY</span> <span class="o">=</span> <span class="s1">'This as well'</span>
<span class="nv">AWS_STORAGE_BUCKET_NAME</span> <span class="o">=</span> <span class="s1">'your-s3-bucket-name'</span>
<span class="nv">SECRET_KEY</span> <span class="o">=</span> <span class="s1">'A long string with many different types of characters'</span>
</pre></div>
<p>In <cite>settings.py</cite> I made the following <strong>additions</strong> to the boilerplate file:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>


<span class="n">BASE_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
<span class="n">TEMPLATE_DIRS</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s">'templates'</span><span class="p">)</span>
<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">'django.contrib.admin'</span><span class="p">,</span>
    <span class="s">'django.contrib.auth'</span><span class="p">,</span>
    <span class="s">'django.contrib.contenttypes'</span><span class="p">,</span>
    <span class="s">'django.contrib.sessions'</span><span class="p">,</span>
    <span class="s">'django.contrib.messages'</span><span class="p">,</span>
    <span class="s">'django.contrib.staticfiles'</span><span class="p">,</span>
    <span class="s">'storages'</span><span class="p">,</span>
    <span class="s">'candidate'</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">DEFAULT_FILE_STORAGE</span> <span class="o">=</span> <span class="s">'storages.backends.s3boto.S3BotoStorage'</span>
</pre></div>
<p>And, at the very bottom of <cite>settings.py</cite> I added the following in:</p>
<div class="highlight"><pre><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">local_settings</span> <span class="kn">import</span> <span class="o">*</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">SECRET_KEY</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">,</span> <span class="s">'Please set SECRET_KEY in local_settings.py'</span>
</pre></div>
</div>
<div class="section" id="writing-the-application-code">
<h2>Writing the application code</h2>
<p>I wrote a model called <cite>Candidate</cite>, created a form for it and used those in a view method:</p>
<p>candidate/models.py:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>


<span class="k">class</span> <span class="nc">Candidate</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">first_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">photo</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FileField</span><span class="p">(</span><span class="n">upload_to</span><span class="o">=</span><span class="s">'candidate-photos'</span><span class="p">)</span>
</pre></div>
<p>candidate/forms.py:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.forms</span> <span class="kn">import</span> <span class="n">ModelForm</span>

<span class="kn">from</span> <span class="nn">candidate.models</span> <span class="kn">import</span> <span class="n">Candidate</span>


<span class="k">class</span> <span class="nc">CandidateForm</span><span class="p">(</span><span class="n">ModelForm</span><span class="p">):</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Candidate</span>
</pre></div>
<p>candidate/views.py:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.core.urlresolvers</span> <span class="kn">import</span> <span class="n">reverse</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponseRedirect</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>

<span class="kn">from</span> <span class="nn">candidate.forms</span> <span class="kn">import</span> <span class="n">CandidateForm</span>


<span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CandidateForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s">'created'</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CandidateForm</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'candidate.html'</span><span class="p">,</span> <span class="p">{</span>
        <span class="s">'form'</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
    <span class="p">})</span>


<span class="k">def</span> <span class="nf">created</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'thanks.html'</span><span class="p">)</span>
</pre></div>
<p>Normally I create a <cite>urls.py</cite> for each application in a Django project but since this was a 2-view project I just used the main <cite>base/urls.py</cite> file to configure the two endpoints:</p>
<p>base/urls.py:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">url</span>


<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">''</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^$'</span><span class="p">,</span> <span class="s">'candidate.views.create'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'create'</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^thanks/'</span><span class="p">,</span> <span class="s">'candidate.views.created'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'created'</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="section" id="testing-uploads">
<h2>Testing uploads</h2>
<p>With the application built I wanted to write a test to make sure the form will accept a file, a first name and save them.</p>
<p>I created a small JPEG file and saved it to <cite>candidate/fixtures/gradient.jpg</cite>. This will be the example image I upload when I'm testing the form.</p>
<p>The default file storage class in <cite>settings.py</cite> is <cite>S3BotoStorage</cite>. This class will upload any files to whichever cloud provider  configured. I don't want to upload to the cloud when I'm running my tests so I've patched <cite>S3BotoStorage</cite> with <cite>FileSystemStorage</cite>.</p>
<p>But by using <cite>FileSystemStorage</cite> I'll end up with any files uploaded during testing being stored in my Django project's folder. To avoid this littering I'll create a temporary folder, save the files there and then remove that folder when testing is complete.</p>
<p>Here is candidate/test.py:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">abspath</span><span class="p">,</span> <span class="n">join</span><span class="p">,</span> <span class="n">dirname</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">rmtree</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">mkdtemp</span>

<span class="kn">from</span> <span class="nn">django.core.files.storage</span> <span class="kn">import</span> <span class="n">FileSystemStorage</span>
<span class="kn">from</span> <span class="nn">django.core.urlresolvers</span> <span class="kn">import</span> <span class="n">reverse</span>
<span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">TestCase</span>
<span class="kn">from</span> <span class="nn">django.test.client</span> <span class="kn">import</span> <span class="n">Client</span>
<span class="kn">from</span> <span class="nn">django.test.utils</span> <span class="kn">import</span> <span class="n">override_settings</span>
<span class="kn">import</span> <span class="nn">mock</span>


<span class="k">class</span> <span class="nc">ViewTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">media_folder</span> <span class="o">=</span> <span class="n">mkdtemp</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">media_folder</span><span class="p">)</span>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s">'storages.backends.s3boto.S3BotoStorage'</span><span class="p">,</span> <span class="n">FileSystemStorage</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_post_photo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">photo_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">abspath</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)),</span> <span class="s">'fixtures/gradient.jpg'</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">photo_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">photo</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">override_settings</span><span class="p">(</span><span class="n">MEDIA_ROOT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">media_folder</span><span class="p">):</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s">'create'</span><span class="p">),</span> <span class="p">{</span>
                    <span class="s">'first_name'</span><span class="p">:</span> <span class="s">'Test'</span><span class="p">,</span>
                    <span class="s">'photo'</span><span class="p">:</span> <span class="n">photo</span>
                <span class="p">})</span>
                <span class="n">redirect</span> <span class="o">=</span> <span class="s">'Location: http://testserver</span><span class="si">%s</span><span class="s">'</span> <span class="o">%</span> <span class="n">reverse</span><span class="p">(</span><span class="s">'created'</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">redirect</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">resp</span><span class="p">))</span>
</pre></div>
<p>Now I can run the <cite>test</cite> command and see that my test passes:</p>
<div class="highlight"><pre>➫ python manage.py <span class="nb">test</span> -v1
Creating <span class="nb">test </span>database <span class="k">for</span> <span class="nb">alias</span> <span class="s1">'default'</span>...
.
----------------------------------------------------------------------
Ran <span class="m">1</span> <span class="nb">test </span>in 0.026s

OK
Destroying <span class="nb">test </span>database <span class="k">for</span> <span class="nb">alias</span> <span class="s1">'default'</span>...
</pre></div>
</div>

  </div>

   <div id="support_text"><p>
    Thank you for taking the time to read this post. If you're considering using </p><a href="https://www.digitalocean.com/?refcode=074ce6598105">Digital Ocean</a><p>, the hosting provider this blog is hosted on, please consider using </p><a href="https://www.digitalocean.com/?refcode=074ce6598105">this link to sign up</a><p>.
  </p></div>


  
</div></body></html>