<html><body><div><div id="content-container">
	    
	    


<h1>My Favorite Underused Python Idiom</h1>
<p class="teaser"/>
<p class="originally">Originally published in the <a href="/python-newsletter/">Advanced Python Newsletter</a></p>


<p>While I can program solo just fine, I always prefer to develop as
part of a team. Among other reasons, it teaches me a lot very
fast. Some of my most significant growth as an engineer has come from
having my code reviewed (or reviewing someone else's), or talking
through a design on a whiteboard, or having simple conversations with
my teammates about how we might implement something.
</p>

<p>An exciting point is when I learn some new idiom or pattern that
has been right under my nose the whole time... and now that I'm aware
of it, will improve my Python code literally for the rest of my coding
life. The best deal with mundane, everyday tasks.
</p>

<p>Let show you my favorite example: opening and reading data from a
file. Here's how a lot of people learn to do it:
</p>


<div class="highlight"><pre><ol><li><p class="line"><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">)</span>
</p></li><li><p class="line"><span class="n">result</span> <span class="o">=</span> <span class="n">do_something_with</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</p></li><li><p class="line"><span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</p></li><li><p class="line"><span class="k">print</span><span class="p">(</span><span class="s">"Got result: {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
</p></li></ol></pre></div>




<p>This works just fine. However, it has a few potential
issues. First, when writing this code, it's possible I might forget to
close the file object. (You might think you're immune to this.  I hate
to be the one to tell you: none of us are.) At the very least,
remembering to close it is a distraction from your focus.
</p>

<p>The second issue is more subtle. While altering this code in the
future, either myself or my teammate may add code after the second
line, pushing the f.close() call down. This leads to the file being
open longer than it needs to be. That may be harmless; but certainly
no good can come from keeping it open longer than necessary.
</p>

<p>(This is ignoring other poor practices, like deliberately closing
the file many lines of code later, long after any reading or writing
is finished; or even not calling the close method at all - letting
Python implicitly close it when the file object goes out of
scope. Again, there are situations where doing these things is
harmless, especially in smaller scripts. But in general they're not
good habits.)
</p>

<p>Fortunately, Python provides an idiom that solves all these
problems, using the <code>with</code> keyword.
</p>


<div class="highlight"><pre><ol><li><p class="line"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</p></li><li><p class="line">    <span class="n">result</span> <span class="o">=</span> <span class="n">do_something_with</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</p></li><li><p class="line"><span class="k">print</span><span class="p">(</span><span class="s">"Got result: {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
</p></li></ol></pre></div>



<p>Some of you have seen this before, but you may not yet be aware of
all the nuances making this even more awesome than it appears at first
glance. Here, the <code>open</code> function is acting as a
<em>context manager</em>. The short version: the object returned by
<code>open()</code> defines two methods, called <code>__enter__</code>
and <code>__exit__</code>. The former returns the file object - i.e.,
self - which is assigned to <code>f</code>. The <code>__exit__</code>
method is called once the <code>with</code> block exits; in this case,
it closes the file. <sup><a href="#note_A">1</a></sup>
</p>

<p>The punchline is that when you use <code>with</code> to open your
files in Python, that file is automatically closed, as soon as it's no
longer needed. There is no way you can forget to close it! It's the
best way to open files in Python today, in most situations.</p>

<p>Notice <code>data</code> is defined inside the <code>with</code>
block, but remains accessible once that block is exited (and the file
object is auto-closed). This is the normal Python scoping rules at
work. If you create (initially define) a variable in a block, it's
also defined in the parent blocks - up until the function
boundary. This is why the <code>print()</code> line is dedented. You
don't want to do something like this:
</p>

<div class="highlight"><pre><ol><li><p class="line"><span class="c"># *** BAD CODE! ***</span>
</p></li><li><p class="line"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</p></li><li><p class="line">    <span class="n">result</span> <span class="o">=</span> <span class="n">do_something_with</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</p></li><li><p class="line">    <span class="c"># Unnecessarily extending the with block keeps</span>
</p></li><li><p class="line">    <span class="c"># the file open longer than it has to be.</span>
</p></li><li><p class="line">    <span class="k">print</span><span class="p">(</span><span class="s">"Got result: {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
</p></li></ol></pre></div>



<p>Keep the <code>with</code> block open only until you've got what
you need from the file, then break out of it and move on.</p>

<p>What's YOUR favorite Python idiom that
not enough people know about? <a href="mailto:aaron@migrateup.com">Tell me by email</a>, or share it on
<a href="https://news.ycombinator.com/item?id=9759069">Hacker News</a>
or the <a href="http://www.reddit.com/r/Python/comments/3apycw/whats_your_favorite_underused_python_idiom/">Python
subreddit</a>.</p>

<section id="footnotes">
    <ol>
	<li id="note_A">
	<p>You can create your own version like this:</p>


<div class="highlight"><pre><ol><li><p class="line"><span class="k">class</span> <span class="nc">myopen</span><span class="p">:</span>
</p></li><li><p class="line">    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</p></li><li><p class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
</p></li><li><p class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
</p></li><li><p class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
</p></li><li><p class="line">    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</p></li><li><p class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">file_obj</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
</p></li><li><p class="line">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_obj</span>
</p></li><li><p class="line">    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">optional_exception_arguments</span><span class="p">):</span>
</p></li><li><p class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">file_obj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</p></li><li><p class="line">
</p></li><li><p class="line"><span class="k">with</span> <span class="n">myopen</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</p></li><li><p class="line">    <span class="n">result</span> <span class="o">=</span> <span class="n">do_something_with</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</p></li><li><p class="line"><span class="k">print</span><span class="p">(</span><span class="s">"Got result: {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
</p></li></ol></pre></div>



<p>If an exception is raised inside the <code>with</code> block,
<code>__exit__</code> will be passed some related arguments. Some
context managers do something with that, but in this case we ignore
them.</p>

	</li>
    </ol>
</section>


	</div> 

    </div></body></html>