<html><body><div><div class="post-text" itemprop="text">
<h1>Summary of requirements</h1>

<p>Having two bigger tables in a database, you need regularly creating some aggregates for past time periods (hour, day, week etc.) and store the results in another database.</p>

<p>I will assume, that once a time period is past, there are no changes to related records, in other words, the aggregate for past period has always the same result.</p>

<h1>Proposed solution: Luigi</h1>

<p><a href="http://luigi.readthedocs.org/en/stable/index.html" rel="nofollow">Luigi</a> is framework for plumbing dependent tasks and one of typical uses is calculating aggregates for past periods.</p>

<p>The concept is as follows:</p>

<ul>
<li>write simple Task instance, which defines required input data, output data (called Target) and process to create the target output.</li>
<li>Tasks can be parametrized, typical parameter is time period (specific day, hour, week etc.)</li>
<li>Luigi can stop tasks in the middle and start later. It will consider any task, for which is target already existing to be completed and will not rerun it (you would have to delete the target content to let it rerun).</li>
</ul>

<p>In short: <strong>if the target exists, the task is done.</strong></p>

<p>This works for multiple types of targets like files in local file system, on hadoop, at AWS S3, and also in database.</p>

<p>To prevent half done results, target implementations take care of atomicity, so e.g. files are first created in temporary location and are moved to final destination just after they are completed.</p>

<p>In databases there are structures to denote, that some database import is completed.</p>

<p>You are free to create your own target implementations (it has to create something and provide method <code>exists</code> to check, the result exists.</p>

<h2>Using Luigi for your task</h2>

<p>For the task you describe you will probably find everything you need already present. Just few tips:</p>

<p>class <a href="http://luigi.readthedocs.org/en/stable/api/luigi.postgres.html?highlight=postgres#luigi.postgres.CopyToTable" rel="nofollow">luigi.postgres.CopyToTable</a> allowing to store records into Postgres database. The target will automatically create so called "marker table" where it will mark all completed tasks.</p>

<p>There are similar classes for other types of databases, one of them using SqlAlchemy which shall probably cover the database you use, see class <a href="http://luigi.readthedocs.org/en/stable/api/luigi.contrib.sqla.html?highlight=sqlalchemy#luigi.contrib.sqla.CopyToTable" rel="nofollow">luigi.contrib.sqla.CopyToTable</a></p>

<p>At Luigi doc is working example of <a href="http://luigi.readthedocs.org/en/stable/api/luigi.contrib.sqla.html?highlight=sqlalchemy#module-luigi.contrib.sqla" rel="nofollow">importing data into sqlite database</a></p>

<p>Complete implementation is beyond extend feasible in StackOverflow answer, but I am sure, you will experience following:</p>

<ul>
<li>The code to do the task is really clear - no boilerplate coding, just write only what has to be done.</li>
<li>nice support for working with time periods - even from command line, see e.g.  <a href="http://luigi.readthedocs.org/en/stable/luigi_patterns.html#efficiently-triggering-recurring-tasks" rel="nofollow">Efficiently triggering recurring tasks</a>. It even takes care of not going too far in past, to prevent generating too many tasks possibly overloading your servers (default values are very reasonably set and can be changed).</li>
<li>Option to run the task on multiple servers (using central scheduler, which is provided with Luigi implementation).</li>
</ul>

<p>I have processed huge amounts of XML files with Luigi and also made some tasks, importing aggregated data into database and can recommend it (I am not author of Luigi, I am just happy user).</p>

<h1>Speeding up database operations (queries)</h1>

<p>If your task suffers from too long execution time to perform the database query, you have few options:</p>

<ul>
<li>if you are counting reviews per product by Python, consider trying SQL query - it is often much faster. It shall be possible to create SQL query which uses <code>count</code> on proper records and returns directly the number you need. With <code>group by</code> you shall even get summary information for all products in one run.</li>
<li>set up proper index, probably on "reviews" table on "product" and "time period" column. This shall speed up the query, but make sure, it does not slow down inserting new records too much (too many indexes can cause that).</li>
</ul>

<p>It might happen, that with optimized SQL query you will get working solution even without using Luigi.</p>
    </div>
    </div></body></html>