<html><body><div><p>Keep generated fields in cache for your Django models.</p>








<p>Keep generated fields in cache for your Django models.</p>
<div id="usage">
<h2>Usage</h2>
<p>You have two options: <tt>@paper</tt> will help you to create a calculated field that is stored in
Django’s cache, and <tt>@cardboard</tt> will create a regular field in your model and update it in
database automatically.</p>
<div id="id1">
<h3>@paper</h3>
<p>Just like the <tt>@property</tt> decorator, you just need to use the <tt>@paper</tt> decorator, that will
transform a method of your class into a cached property.</p>
<pre><span class="k">class</span> <span class="nc">ModelA</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>

    <span class="nd">@paper</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">'testpaper.ModelB'</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">ModelA</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">children</span><span class="o">=</span><span class="n">i</span><span class="p">)),</span>
    <span class="p">])</span>
    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ModelA</span><span class="o">.</span><span class="n">objects</span>\
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="n">Coalesce</span><span class="p">(</span><span class="n">Sum</span><span class="p">(</span><span class="s1">'children__count'</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span>\
            <span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">'count'</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">ModelB</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">'ModelA'</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">'children'</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">()</span>
</pre>
<p><tt>@paper</tt> takes 2 arguments:</p>
<ul>
<li>The method’s version number, in case you want to change the format of what is returned. By
example, imagine you’re returning a complex denormalized data structure. If at some point you
want to add some data in it, you can simply bump the version number and it will invalidate the
caches automatically.</li>
<li>A list of model/lister couples.
- The model is either a model class, either an ‘app.Model’ string
- The lister takes a single argument which is an instance of the updated model (here a ModelB
objet) and returns a list of affected objects to invalidate (here a queryset of ModelA objects).</li>
</ul>
<p>The value will be cached using Django’s default cache. Please note that this requires the cache to
be shared across all your web worker instances, otherwise invalidation won’t have any the intended
effect.</p>
<p>Invalidation is based on Django signals, so it requires <tt>save()</tt> or <tt>delete()</tt> to be called in
order to work correctly. Bulk/SQL operations won’t be detected automatically.</p>
</div>
<div id="cardboard">
<h3>@cardboard</h3>
<p>Use is very similar to <tt>@paper</tt>, the main differences being the absence of versioning and the fact
that result is going to be stored in the model itself instead of caching it.</p>
<pre><span class="k">class</span> <span class="nc">ModelA</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>

    <span class="nd">@cardboard</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">'testpaper.ModelB'</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">ModelA</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">children</span><span class="o">=</span><span class="n">i</span><span class="p">)),</span>
    <span class="p">])</span>
    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ModelA</span><span class="o">.</span><span class="n">objects</span>\
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="n">Coalesce</span><span class="p">(</span><span class="n">Sum</span><span class="p">(</span><span class="s1">'children__count'</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span>\
            <span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">'count'</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">ModelB</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">'ModelA'</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">'children'</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">()</span>
</pre>
<p><tt>@cardboard</tt> takes two arguments:</p>
<ul>
<li>The field that will be used to store results. You have to give it a sensible default value,
because no calculation will be made upon object creation. Calculation are only triggered by the
<tt>dependencies</tt> functions.</li>
<li>A list of dependencies, just like in <tt>@paper</tt>.</li>
</ul>
<p>The same remark goes for this technique being <tt>save()</tt>/<tt>delete()</tt> driven: bulk or SQL operations
won’t trigger recalculation.</p>
</div>
</div>
</div></body></html>