<html><body><div><article class="post text">
						
							
								<a href="http://spikeekips.tumblr.com/post/97743913387/embedding-python-in-golang-part-2" class="post-title"><h2>Embedding PyThon In Golang: Part 2</h2></a>
							
							
							
							<p><a href="http://spikeekips.tumblr.com/post/96390305602/embedding-python-in-golang" target="_blank">In the previous post</a>, I wrote, why I started this project, to embed python code in golang and wrote about the <code>gopy</code> and <code>go-python</code>.</p>

<p>In this post, I will show you the runnable code and explanations. The source code is available at the <a href="http://t.umblr.com/redirect?z=https%3A%2F%2Fgithub.com%2Fspikeekips%2Fembedding-python-in-golang&amp;t=MWY5NTAxYjBlOTFlNmE1ZDU5MWY0MjIyZGI5YWFkNTc2M2IxNGU1YiwwRHA4WkJVRg%3D%3D" target="_blank">https://github.com/spikeekips/embedding-python-in-golang</a>.</p>

<p>I tested with,</p>

<ul><li>golang 1.3.1</li>
<li>python 2.7.4</li>
</ul><p>at </p>

<ul><li>latest Ubuntu 14.04</li>
<li>OSX Mavericks 10.9.4</li>
</ul><h2>Isolate python with <code>sync.Mutex</code></h2>

<p><a href="http://t.umblr.com/redirect?z=https%3A%2F%2Fgithub.com%2Fspikeekips%2Fembedding-python-in-golang%2Ftree%2Fmaster%2Fsync_mutex&amp;t=YTY5MTExZDMzODQ3ZTc5Mzg1YmQ5NTQ3NDQzYTZjZWEzMzkyMjdhOSwwRHA4WkJVRg%3D%3D" target="_blank">https://github.com/spikeekips/embedding-python-in-golang/tree/master/sync_mutex</a></p>

<p>With using <code>go-python</code>, I presumed it could be easy to run the python code at first, and I realized that I missed the big thing, especially <code>GIL</code> in python, it caused a lot of trouble to co-exist, golang and python.</p>

<p>For simple test, I wrote the very short python code, to encode list as json, called <a href="http://t.umblr.com/redirect?z=https%3A%2F%2Fgithub.com%2Fspikeekips%2Fembedding-python-in-golang%2Fblob%2Fmaster%2Fsync_mutex%2Fmain%2Fjson_dump.py&amp;t=MjE0MzI4NjFhYjM0MGU5Njk5ZTgwM2JhNTNlNmI1NzExNTBlYmYwNCwwRHA4WkJVRg%3D%3D" target="_blank"><code>json_dump.py</code></a>,</p>

<pre><code>import json

def run (*a) :
    return json.dumps(a, )
</code></pre>

<p>This will be imported and run in gorouting and encode and return the json string like this,</p>

<pre><code>[
  [
    "oldboy",
    "나는 오대수"
  ],
  {
    "I want to eat something alive.": "살아 있는 것을 먹고 싶다.",
    "who are you?": "누구냐, 넌?"
  }
]
</code></pre>

<p>To make it simple, I used <a href="http://t.umblr.com/redirect?z=https%3A%2F%2Fgithub.com%2Fsbinet%2Fgo-python&amp;t=MzBlY2E1Nzc5NTU4M2QyYzhkZTIzMmNiMDA1YTIzYWE2NWI0YmE1YiwwRHA4WkJVRg%3D%3D" target="_blank">go-python</a>, it used to reduce the extra code to write C code for accessing python C-API.</p>

<p>This is the <a href="http://t.umblr.com/redirect?z=https%3A%2F%2Fgithub.com%2Fspikeekips%2Fembedding-python-in-golang%2Fblob%2Fmaster%2Fsync_mutex%2Fmain%2Fmain.go&amp;t=NGUwYTI3MzQwZmVmMDRkZjBlODkwODhjNTcwZjQ5YzZkOTU1MTJkMCwwRHA4WkJVRg%3D%3D" target="_blank"><code>main.go</code></a>,</p>

<pre><code>package main

import (
    "fmt"
    "github.com/op/go-logging"
    "github.com/sbinet/go-python"
    "github.com/spikeekips/embedding-python-in-golang/common"
    "sync"
)

func init() {
    err := python.Initialize()
    if err != nil {
        panic(err.Error())
    }
}

func embed_function(args []string, kw map[string]string) {
    lock.Lock()
    defer lock.Unlock()

    // import python module
    _module := python.PyImport_ImportModuleNoBlock("json_dump")

    // get `run` attribute from
    _attr := _module.GetAttrString("run")

    // convert golang arguments to python argument.
    _a := python.PyTuple_New(len(args))
    for i, v := range args {
        python.PyTuple_SET_ITEM(_a, i, python.PyString_FromString(v))
    }

    _kw := python.PyDict_New()
    for k, v := range kw {
        python.PyDict_SetItem(
            _kw, python.PyString_FromString(k),
            python.PyString_FromString(v),
        )
    }

    // pack arguments
    _args := python.PyTuple_New(2)
    python.PyTuple_SET_ITEM(_args, 0, _a)
    python.PyTuple_SET_ITEM(_args, 1, _kw)

    // call python function, `pymodule.run`
    _result := _attr.CallObject(_args)

    // the returned value from python will be json string, so convert the
    // string from python to golang string.
    _result_string := python.PyString_AsString(_result)

    log.Debug(
        "got json string: \n%s\n",
        epig.PrettyPrintJson(_result_string),
    )
}

var log = logging.MustGetLogger("gopython-test")
var lock sync.Mutex

func main() {
    logging.SetLevel(logging.DEBUG, "gopython-test")

    log.Info("python embedding test in golang.")

    _ch := make(chan bool)

    // create argument
    _args := []string{"oldboy", "나는 오대수"}

    _kw := map[string]string{
        "who are you?":                   "누구냐, 넌?",
        "I want to eat something alive.": "살아 있는 것을 먹고 싶다.",
    }

    // in goroutine
    log.Info("run inside goroutine")
    go func() {
        embed_function(_args, _kw)
        _ch &lt;- true
    }()
    &lt;-_ch

    fmt.Println("")

    // outside goroutine
    log.Info("run outside goroutine")
    embed_function(_args, _kw)
</code></pre>

<p>This shows the representative example to run python module inside golang and goroutine.</p>

<p><code>embed_function</code> runs inside goroutine and it can be isolated with the <code>sync.Mutex</code> lock.</p>

<p>The <code>python.xxx</code> functions in the <code>embed_function</code> are similar with the native python <code>C-API</code> functions, because the <code>go-python</code> also uses the python <code>C-API</code> using <a href="http://t.umblr.com/redirect?z=http%3A%2F%2Fgolang.org%2Fcmd%2Fcgo%2F&amp;t=ZDRiOTE5YjM0MWU5ZTliMjRiMjk3MjNiYjhlMWEyZWM2MjZjNDBmZiwwRHA4WkJVRg%3D%3D" target="_blank"><code>cgo</code></a>. It helps to create <code>PyObject</code>, so the python function, <code>json_dump.run()</code> can easily receive the arguments, which is pythonized.</p>

<h3>What happens if <code>sync.Mutex</code> lock is removed?</h3>

<p>What happens if <code>sync.Mutex</code> lock is removed? If you run the goroutine with <code>embed_function</code> at once or without goroutine, everything works fine, but if with multiple goroutine, it will occur panic or segfault with the long traceback messages from cgo.</p>

<p>This, <code>sync_mutex</code> example was good before I putted the thread related code in <code>json_dump.py</code>, when I ran another python module, the new <a href="http://t.umblr.com/redirect?z=https%3A%2F%2Fgithub.com%2Fspikeekips%2Fembedding-python-in-golang%2Fblob%2Fmaster%2Fpthreads%2Fmain%2Fjson_dump.py&amp;t=YzQ0ODY1ZDAwN2VlMjNlY2UzMzllNjZjMDhlMzc4MWM4NmEzNzZiNCwwRHA4WkJVRg%3D%3D" target="_blank"><code>json_dump.py</code></a>, this method was failed. It will get the thread identity number.</p>

<pre><code>import threading
...

threading.currentThread().ident, 
...

</code></pre>

<p>So I needed another approach to run the thread-related python code inside golang.</p>

<h2>Using <code>pthread</code> to use GIL in python code</h2>

<p><a href="http://t.umblr.com/redirect?z=https%3A%2F%2Fgithub.com%2Fspikeekips%2Fembedding-python-in-golang%2Ftree%2Fmaster%2Fpthreads&amp;t=Yjc4MDg0MzFiNjE5MGFjNGVjYTU2MmVjYjg2Yzc0NWU0NTNmNjA3NiwwRHA4WkJVRg%3D%3D" target="_blank">https://github.com/spikeekips/embedding-python-in-golang/tree/master/pthreads</a></p>

<p>At first time, I didn’t know exactly the goroutine is not ran in multi-threads environment. The golang’s official FAQ explains on the goroutine and threads,</p>

<blockquote>
<p>Why goroutines instead of threads?</p>

<p>Goroutines are part of making concurrency easy to use. The idea, which has been around for a while, is to multiplex independently executing functions—coroutines—onto a set of threads. … The programmer sees none of this … .</p>
</blockquote>

<p>The function, which runs inside <code>goroutine</code> is not guaranteed that it has a unique thread. So I tried to create the <em>child-thread</em> by force inside goroutine, using <a href="http://t.umblr.com/redirect?z=https%3A%2F%2Fgithub.com%2Fliamzdenek%2Fgo-pthreads&amp;t=ZDIyNTUzZDQxYzkyMzc0ZWM5OWI1NGE2MjFmMTdhNWNiNjI2ZDk4NSwwRHA4WkJVRg%3D%3D" target="_blank"><code>go-pthreads</code></a>. (At this time, I forked <code>go-pthreads</code> because it has some bugs in golang in OSX.)</p>

<p>I used the same python module, <code>json_dump.py</code>, it tries to get the threads id.</p>

<pre><code>import json
import threading

def run (*a) :
    return json.dumps(
            [
                    threading.currentThread().ident,
                ] + list(a),
        )
</code></pre>

<p>This python module must be ran in a unique thread, that is, the thread id must be unique.</p>

<p>I edited the previous <a href="http://t.umblr.com/redirect?z=https%3A%2F%2Fgithub.com%2Fspikeekips%2Fembedding-python-in-golang%2Fblob%2Fmaster%2Fpthreads%2Fmain%2Fmain.go&amp;t=OGU2ZmNkYTdhYTUxZDgyZGI3ZThlNDk4OTU0OTk2ZWViZjViNWE3NCwwRHA4WkJVRg%3D%3D" target="_blank"><code>main.go</code></a> to create thread like this,</p>

<pre><code>// #cgo pkg-config: python-2.7
// #include "Python.h"
// #include &lt;stdlib.h&gt;
// #include &lt;string.h&gt;
// #include &lt;pthread.h&gt;
// #include &lt;signal.h&gt;
import "C"

import (
    "fmt"
    "github.com/op/go-logging"
    "github.com/sbinet/go-python"
    "github.com/spikeekips/embedding-python-in-golang/common"
    "github.com/spikeekips/go-pthreads"
    "runtime"
    "sync"
)

func init() {
    log.Debug("&gt; Initilize Python.")

    runtime.LockOSThread()

    if C.Py_IsInitialized() == 0 {
        C.Py_Initialize()
    }
    if C.Py_IsInitialized() == 0 {
        panic(fmt.Errorf("python: could not initialize the python interpreter"))
    }

    // make sure the GIL is correctly initialized
    if C.PyEval_ThreadsInitialized() == 0 {
        C.PyEval_InitThreads()
    }
    if C.PyEval_ThreadsInitialized() == 0 {
        panic(fmt.Errorf("python: could not initialize the GIL"))
    }
    log.Debug("&lt; Initilized Python.")
    _tstate := C.PyGILState_GetThisThreadState()
    C.PyEval_ReleaseThread(_tstate)
}

func create_thread(ch chan bool, args []string, kw map[string]string) {
    log.Debug("&gt; create_thread")

    lock.Lock()
    defer lock.Unlock()
    defer func() {
        ch &lt;- true
    }()

    _ch := make(chan bool)
    defer func() { close(_ch) }()

    thread := pthread.Create(func() {
        _gstate := C.PyGILState_Ensure()
        defer func() {
            C.PyGILState_Release(_gstate)
        }()
        embed_function(args, kw)
        _ch &lt;- true
    })

    defer func() {
        thread.Kill()
    }()

    &lt;-_ch
    log.Debug("&lt; create_thread: done")
}

func embed_function(args []string, kw map[string]string) {
    // import python module
    _module := python.PyImport_ImportModuleNoBlock("json_dump")

    // get `run` attribute from
    _attr := _module.GetAttrString("run")

    // convert golang arguments to python argument.
    _a := python.PyTuple_New(len(args))
    for i, v := range args {
        python.PyTuple_SET_ITEM(_a, i, python.PyString_FromString(v))

    }

    _kw := python.PyDict_New()
    for k, v := range kw {
        python.PyDict_SetItem(
            _kw, python.PyString_FromString(k),
            python.PyString_FromString(v),
        )
    }

    // pack arguments
    _args := python.PyTuple_New(2)
    python.PyTuple_SET_ITEM(_args, 0, _a)
    python.PyTuple_SET_ITEM(_args, 1, _kw)

    // call python function, `pymodule.run`
    _result := _attr.CallObject(_args)

    // the returned value from python will be json string, so convert the
    // string from python to golang string.
    _result_string := python.PyString_AsString(_result)

    log.Debug(
        "got json string: \n%s\n",
        epig.PrettyPrintJson(_result_string),
    )
}

var log = logging.MustGetLogger("gopython-test")
var lock sync.Mutex

func main() {
    logging.SetLevel(logging.DEBUG, "gopython-test")

    log.Info("python embedding test in golang, using `pthreads`.")

    // create argument
    _args := []string{"oldboy", "나는 오대수"}

    _kw := map[string]string{
        "who are you?":                   "누구냐, 넌?",
        "I want to eat something alive.": "살아 있는 것을 먹고 싶다.",
    }

    var _ch chan bool

    // inside goroutine
    _ch = make(chan bool)
    log.Info("run inside goroutine")
    go func() {
        create_thread(_ch, _args, _kw)
    }()
    go func() {
        create_thread(_ch, _args, _kw)
    }()
    &lt;-_ch
    &lt;-_ch
    close(_ch)

    // outside goroutine
    _ch = make(chan bool, 2)
    log.Info("run outside goroutine")
    create_thread(_ch, _args, _kw)
    &lt;-_ch
    close(_ch)
}
</code></pre>

<h3>Handling <code>GIL</code></h3>

<p>Unlike the previous <code>main.go</code>, this initializes the python environment by force using <code>C</code> golang package for <code>GIL</code>.</p>

<p>The steps to handle <code>GIL</code>,</p>

<ol><li><p>Initialize python environment.</p></li>
<li><p>Get the GIL state and release it for further use.</p></li>
</ol><pre><code>_tstate := C.PyGILState_GetThisThreadState()
C.PyEval_ReleaseThread(_tstate)
</code></pre>

<ol><li><p>Create the thread using <code>pthread</code>.</p></li>
<li><p>The callback function of <code>pthread</code> will get the thread state and release it.</p></li>
</ol><pre><code>thread := pthread.Create(func() {
        _gstate := C.PyGILState_Ensure() // ready to use thread
        defer func() {
            C.PyGILState_Release(_gstate) // release GIL.
        }()
        embed_function(args, kw)
    })
</code></pre>

<ol><li>The callback runs <code>embed_function</code> in the thread inside goroutine.</li>
</ol><p>This pattern is the most used method in Python C-API extension to create and handle multi-threads, and I followed.</p>

<p>The result was,</p>

<ul><li><p><code>embed_function</code> can get the unique thread id without causing panic or segfault.</p></li>
<li><p>With goroutine, the <code>embed_function</code> could be ran in unblocking state.</p></li>
</ul><p>I finally got the running code to embed python code in golang.</p>

<p>5 ryu ws vc vc v vb b </p>

<h2>Using <code>pthread</code> using <code>cgo</code></h2>

<p><a href="http://t.umblr.com/redirect?z=https%3A%2F%2Fgithub.com%2Fspikeekips%2Fembedding-python-in-golang%2Ftree%2Fmaster%2Fpthreads2&amp;t=MGE5ZDgzNGUzODRjMjc5NjQxMmQwZTJlMzJlNzdiZjdiNjdjMWM2ZSwwRHA4WkJVRg%3D%3D" target="_blank">https://github.com/spikeekips/embedding-python-in-golang/tree/master/pthreads2</a></p>

<p>I wanted the fresh and raw meats without <code>go-python</code> and <code>go-pthreads</code>, and just to know about the <code>cgo</code> more deeply, so I tried to implement the <code>main.go</code> without <code>go-python</code> and <code>go-pthreads</code>.</p>

<p>This is the new <a href="http://t.umblr.com/redirect?z=https%3A%2F%2Fgithub.com%2Fspikeekips%2Fembedding-python-in-golang%2Fblob%2Fmaster%2Fpthreads2%2Fmain%2Fmain.go&amp;t=OWVmYzc4N2FjYzBiYjgwMGNkN2Q0YjZiMTNhMjM4OGRhOTQ0ZTlhYiwwRHA4WkJVRg%3D%3D" target="_blank"><code>main.go</code></a>.</p>

<h2>And next,</h2>

<p>At the next time, I will describe about how to run the <code>wsgi</code> applications, including <code>Django</code> in golang.</p>
							
							
							
							
						

						

						

						

						

						

						

						

						

						
							<footer>
								
								
                    
  											
  												
															
							</footer>
						
								


								

					</article> 			
				
  				

				
				
				
							
			</div></body></html>