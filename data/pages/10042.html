<html><body><div><div class="blog-content">

                        

                            
                        



                        
                            
                                <p>Продолжаем писать проект  "Страница со статистикой отжимания" с помощью flask + google chart's. </p>
<p>В этой части дополним шаблон javascript'ом, продумаем и реализуем сохранение/загрузки истории.</p>
<p>Ранее (<a href="http://bit.ly/20cxo8i">http://bit.ly/20cxo8i</a>) создан базовый проект flask и html файл с текстом Hiiii.</p>
<p>Структура файлов перед второй частью:</p>
<div class="codehilite"><pre>.
├── app.py
├── requirements.txt
└── templates
    └── index.html
</pre></div>


<p>Начинаем вторую часть.</p>
<blockquote>
<p>Обращаю внимание что код в цикле этих статей  очевидный и простой. Автор не ставит цели писать идеальный код.</p>
</blockquote>
<p>Сначала разберемся какие данные есть в проекте и как будем их хранить.</p>
<p>В этом проекте нет разнообразия данных. Одна величина - количество отжиманий в момент времени T. Поэтому хранилище или крутая база данных не требуется - хватит и файла.
В файл запишем список (массив) элементов из двух значений - время и количество отжиманий</p>
<p>Пример:</p>
<div class="codehilite"><pre><span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
   <span class="p">(</span><span class="n">date1</span><span class="p">,</span> <span class="n">value1</span><span class="p">),</span>
   <span class="p">(</span><span class="n">date2</span><span class="p">,</span> <span class="n">value2</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>


<p>Дата будет в виде unixtime - т.е. количество секунд, прошедших с полуночи (00:00:00 UTC) 1 января 1970 года - т.е. <strong>целое число</strong>. Будем вычислять так: </p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">datetime</span>
<span class="nb">int</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
</pre></div>


<p>Количество отжиманий тоже <strong>целое число</strong>.</p>
<p>Формат определен. Теперь начнем сохранять/загружать данные из файла.
Для удобства будет использован модуль <strong>pickle</strong> из стандартной библиотеки. </p>
<blockquote>
<p>Модуль pickle позволяет преобразовывать python-объект (переменную) в бинарный формат и обратно.</p>
</blockquote>
<p>Это позволит не думать о способе хранения описанной структуры. Достаточно будет сформировать список кортежей, прогнать через модуль и сохранить в файл. Это и сделаем:</p>
<blockquote>
<p>Далее страшный код с глобальной переменной :) Это аля домашнее задание - переписать код без глобальной переменной.</p>
</blockquote>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">pickle</span>

<span class="n">DATA</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c"># переменная в которой состояние сервера - список кортежей</span>
<span class="n">PATH</span> <span class="o">=</span> <span class="s">'store.pkl'</span> <span class="c"># путь до файла, для сохранения состояния</span>

<span class="c"># функция записи значения в файл, значение это (date1, value1) (кортеж, два элемента - целые числа)</span>
<span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">DATA</span>
    <span class="n">DATA</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">PATH</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">fio</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">DATA</span><span class="p">,</span> <span class="n">fio</span><span class="p">)</span>

<span class="c"># функция чтения данных</span>
<span class="k">def</span> <span class="nf">read</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">DATA</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">PATH</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">fio</span><span class="p">:</span>
            <span class="n">DATA</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fio</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">FileNotFoundError</span><span class="p">:</span>
        <span class="n">DATA</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>


<p>На что стоит обратить внимание:</p>
<ul>
<li>модуль <strong>pickle</strong>. Этот проект пишем под Python3. Для Python2 необходимо написать <strong>cPickle</strong></li>
<li>'<strong>rb</strong>' и '<strong>wb</strong>' - буква <strong>r</strong> означает read, <strong>w</strong> - write, а буква <strong>b</strong> - binary. Напомню, что <strong>pickle</strong> преоразует Python объект в бинарную структуру.</li>
</ul>
<blockquote>
<p>Практика: попрактикуйтесь с этим кодом - запишите данные с помощью функции write, прочитайте с помощью read</p>
<p>Справки: использование модуля six (ставится дополнительно) позволяет упростить написание переносимого кода. (т.е. совместимый с Python 2 и 3)</p>
</blockquote>
<p>Поправим код запуска:</p>
<div class="codehilite"><pre><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">read</span><span class="p">()</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>


<p>Таким образом при запуске сервера в переменной <strong>DATA</strong> будет статистика отжиманий. Вспомним основную задачу проекта - отобразить статистику об отжиманиях на web-странице. Чтобы передать эти данные на страницу перепишем функцию <strong>index()</strong>:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">json</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">"/"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">DATA</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">"index.html"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">DATA</span><span class="p">))</span>
</pre></div>


<p>Что здесь интересного? 
В функцию <strong>render_template</strong> добавили аргумент <strong>data</strong> и передали данные в JSON формате. Название <strong>data</strong> играет роль. По этому имени будет доступны данные в html шаблоне.</p>
<blockquote>
<p>Справка: Формат JSON подходит для web-проектов благодаря поддержке браузерами и простой структуре данных. Про JSON можно прочиать по <a href="http://www.json.org/json-ru.html">ссылке</a></p>
</blockquote>
<p>На данный момент с Python-кодом закончим и перейдем к шаблону. Теперь надо отобразить данные.</p>
<p>Заменив текст <strong>Hiiiiiiii</strong> на <strong>{{ data }}</strong>, как можно догадаться, получим отображение переменной <strong>json.dumps(DATA)</strong> (передали в методе index). Пока DATA пустая (нет файла с данными) можно присвоить какое-то свое значение - попробуйте.</p>
<blockquote>
<p>Справка: формат записи {{ data }} это часть языка движка шаблонов Jinja2. Почитать возможности движка можно по <a href="http://jinja.pocoo.org/">ссылке</a>. Подобный формат синтаксиса используется и в другом веб-фреймворке (django)</p>
</blockquote>
<p>Теперь пойдем дальше, визуализируем данные.</p>
<p>Для этого будет использоваться <a href="https://developers.google.com/chart/">Google charts</a>. Это библиотека для Javascript, которая обладает хорошей документацией и примерами. Разговор про Javascript можно вести долго, поэтому приведу итоговый код и кратко опишу его.</p>
<div class="codehilite"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span>
            <span class="na">src=</span><span class="s">"https://www.google.com/jsapi?autoload={'modules':[{'name':'visualization','version':'1.1','packages':['corechart', 'timeline']}]}"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>

<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"chart_div"</span><span class="nt">&gt;&lt;/div&gt;</span>


<span class="nt">&lt;script&gt;</span>

    <span class="kd">var</span> <span class="nx">dynamic_data</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="kd">var</span> <span class="nx">json_data</span> <span class="o">=</span> <span class="p">{{</span> <span class="nx">data</span><span class="o">|</span><span class="nx">safe</span> <span class="p">}};</span>
    <span class="nx">json_data</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">dynamic_data</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">element</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nx">element</span><span class="p">[</span><span class="mi">1</span><span class="p">]]);</span>
    <span class="p">});</span>

    <span class="kd">var</span> <span class="nx">chart</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">google</span><span class="p">.</span><span class="nx">visualization</span><span class="p">.</span><span class="nx">LineChart</span><span class="p">(</span>
            <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'chart_div'</span><span class="p">));</span>

    <span class="nx">google</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="s1">'visualization'</span><span class="p">,</span> <span class="s1">'1'</span><span class="p">,</span> <span class="p">{</span><span class="nx">packages</span><span class="o">:</span> <span class="p">[</span><span class="s1">'corechart'</span><span class="p">]});</span>
    <span class="nx">google</span><span class="p">.</span><span class="nx">setOnLoadCallback</span><span class="p">(</span><span class="nx">drawChart</span><span class="p">);</span>

    <span class="kd">function</span> <span class="nx">genOptions</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="nx">height</span><span class="o">:</span> <span class="mi">500</span><span class="p">,</span>
            <span class="nx">legend</span><span class="o">:</span> <span class="p">{</span><span class="nx">position</span><span class="o">:</span> <span class="s1">'none'</span><span class="p">},</span>
            <span class="nx">enableInteractivity</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
            <span class="nx">title</span><span class="o">:</span> <span class="s1">'Статистика отжиманий от пола'</span><span class="p">,</span>
            <span class="nx">chartArea</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">width</span><span class="o">:</span> <span class="s1">'85%'</span>
            <span class="p">},</span>
            <span class="nx">hAxis</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">title</span><span class="o">:</span> <span class="s1">'Время'</span><span class="p">,</span>
                <span class="nx">gridlines</span><span class="o">:</span> <span class="p">{</span>
                    <span class="nx">count</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="nx">units</span><span class="o">:</span> <span class="p">{</span>
                        <span class="nx">days</span><span class="o">:</span> <span class="p">{</span><span class="nx">format</span><span class="o">:</span> <span class="p">[</span><span class="s1">'MMM dd'</span><span class="p">]},</span>
                        <span class="nx">hours</span><span class="o">:</span> <span class="p">{</span><span class="nx">format</span><span class="o">:</span> <span class="p">[</span><span class="s1">'HH:mm'</span><span class="p">,</span> <span class="s1">'ha'</span><span class="p">]}</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="nx">minorGridlines</span><span class="o">:</span> <span class="p">{</span>
                    <span class="nx">units</span><span class="o">:</span> <span class="p">{</span>
                        <span class="nx">hours</span><span class="o">:</span> <span class="p">{</span><span class="nx">format</span><span class="o">:</span> <span class="p">[</span><span class="s1">'hh:mm:ss a'</span><span class="p">,</span> <span class="s1">'ha'</span><span class="p">]},</span>
                        <span class="nx">minutes</span><span class="o">:</span> <span class="p">{</span><span class="nx">format</span><span class="o">:</span> <span class="p">[</span><span class="s1">'HH:mm a Z'</span><span class="p">,</span> <span class="s1">':mm'</span><span class="p">]}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="nx">vAxis</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">title</span><span class="o">:</span> <span class="s1">'Количество отжиманий'</span><span class="p">,</span>
                <span class="nx">minValue</span><span class="o">:</span> <span class="mi">0</span>
            <span class="p">}</span>
        <span class="p">};</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">genData</span><span class="p">(</span><span class="nx">dynamic_data</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">google</span><span class="p">.</span><span class="nx">visualization</span><span class="p">.</span><span class="nx">DataTable</span><span class="p">();</span>
        <span class="nx">data</span><span class="p">.</span><span class="nx">addColumn</span><span class="p">(</span><span class="s1">'datetime'</span><span class="p">,</span> <span class="s1">'X'</span><span class="p">);</span>
        <span class="nx">data</span><span class="p">.</span><span class="nx">addColumn</span><span class="p">(</span><span class="s1">'number'</span><span class="p">,</span> <span class="s1">'Отжимания'</span><span class="p">);</span>
        <span class="nx">data</span><span class="p">.</span><span class="nx">addRows</span><span class="p">(</span><span class="nx">dynamic_data</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">data</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">drawChart</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">chart</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span><span class="nx">genData</span><span class="p">(</span><span class="nx">dynamic_data</span><span class="p">),</span> <span class="nx">genOptions</span><span class="p">());</span>
    <span class="p">}</span>

<span class="nt">&lt;/script&gt;</span>

<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>


<p>В этом коде происходит следующее </p>
<ul>
<li>В теге <strong>head</strong> подключаем библиотеки для рисования графиков</li>
<li>В блоке <code>&lt;div id="chart_div"&gt;&lt;/div&gt;</code>будет сам график</li>
<li>В блоке <code>&lt;script&gt;...&lt;/script&gt;</code> описана инициализация графика (сделано форматирование осей и прочее)</li>
</ul>
<p>А выглядит это все так:</p>
<p><img alt="Image" src="http://pynsk.ru/media/uploads/Posts/write_project_1_part_2.png"/></p>
<p>Итог на данный момент:</p>
<ul>
<li>Есть flask приложение с возможностью сохранять и загружать данные в/из файла. Определен формат данных.</li>
<li>Есть страничка, на которой отображается график (пока без данных)</li>
</ul>
<p>Остается связать эти две части вместе.</p>
<p>На этом прерву эту часть. </p>
<hr/>
<p>Продолжение следует.</p>
                            
                        



                        

                            
                            <footer class="post-info">
                                <span class="label label-default">Дата</span>
                            <span class="published">
                                <i class="fa fa-calendar"/><time>
                                2016-01-29 21:34:30</time>
                            </span>


                                <span class="label label-default">Категории</span>

                                
                                    
                                        
                                            <a href="/blog/category/pishem-web-proekty/">Пишем web проекты</a>
                                            
                                        
                                    
                                


                                <span class="label label-default">Теги</span>

                                

                            </footer>
                        


                        
                            
                        

                        
                            
                            <a class="btn btn-sm share-twitter" target="_blank" href="http://twitter.com/home?status=https%3A//pynsk.ru/blog/2016/01/29/write-project-1-part-2/%20%D0%9F%D0%B8%D1%88%D0%B5%D0%BC%20%D0%BF%D1%80%D0%BE%D1%81%D1%82%D1%8B%D0%B5%20%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%D1%8B.%20%D0%9F%D1%80%D0%BE%D0%B5%D0%BA%D1%82%20%231.%20%D0%A7%D0%B0%D1%81%D1%82%D1%8C%20%232">Опубликовать в Twitter</a>
                            <a class="btn btn-sm share-facebook" target="_blank" href="http://facebook.com/sharer.php?u=https://pynsk.ru/blog/2016/01/29/write-project-1-part-2/&amp;t=%D0%9F%D0%B8%D1%88%D0%B5%D0%BC%20%D0%BF%D1%80%D0%BE%D1%81%D1%82%D1%8B%D0%B5%20%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%D1%8B.%20%D0%9F%D1%80%D0%BE%D0%B5%D0%BA%D1%82%20%231.%20%D0%A7%D0%B0%D1%81%D1%82%D1%8C%20%232">Опубликовать в Facebook</a>
                        

                        
                            
                        

                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        


                        <hr/>
                        
                        <hr/>

                        
                            

            </div>

        </div></body></html>