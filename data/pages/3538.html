<html><body><div><section class="post-content">
      <p>Recently I have been overhauling our CI configuration at work, so naturally I am keen to learn new CI techniques that I can integrate. <strong>Canary Builds</strong> piqued my interest:</p>

<blockquote>
  <p>Many projects have external code dependencies, a large amount of which is provided by open source projects. In order to ensure our builds are reproducible, we integrate against known versions of them, but that can mean that it takes a while for us to integrate against newer versions of these libraries leading to a larger merge effort down the line. One approach we have seen to avoid this is to have a nightly Canary Build which tries to pull in the latest version of all dependencies. If the build is green, we know we can change which versions we depend on.</p>
  
  <blockquote>
    <p>- ThoughtWorks <a href="http://www.thoughtworks.com/radar/techniques/canary-builds">Technology Radar</a></p>
  </blockquote>
</blockquote>

<p>An intriguing proposition; instead of tentatively nudging dependency versions, just let the CI server aggressively do it on a nightly basis and upgrade periodically when green.</p>

<p>So how easy is this to integrate in a Python environment?</p>

<h3 id="canarybuildswithtox">Canary Builds with Tox</h3>

<p>It is currently in the "Trial" ring of the radar, I am also keen to trial it using <a href="https://tox.readthedocs.org/en/latest/">Tox</a>. </p>

<p>Below is an example <code>tox.ini</code>:</p>

<pre><code>[deps]
base =
    django-some-stable-lib&gt;=1.4,&lt;2.0
    django-shiny-cutting-edge-lib&gt;=0.2,&lt;0.3   
dj17 =
    Django&gt;=1.7,&lt;1.8       
py2 =
    # Python 2 specifics
py3 =
    # Python 3 specifics

envlist =
    py27-dj17,
    py34-dj17

[testenv]
commands=coverage run runtests.py

[testenv:py27-dj17]
basepython=python2.7
deps =
    {[deps]base}
    {[deps]py2}
    {[deps]dj17}

[testenv:py34-dj17]
basepython=python3.4
deps =
    {[deps]base}
    {[deps]py3}
    {[deps]dj17}
</code></pre>

<p>I have split the requirements into <code>base</code> and environment specifics like <code>dj17</code>, <code>py2</code> and <code>py3</code>. I then have a <code>testenv</code> for each configuration that pulls in the correct dependencies.</p>

<h4 id="integration">Integration</h4>

<p>I first of all add a <code>canary</code> dependency entry to <code>deps</code>, this is comprised of all the relevant dependencies without specifying any upper version limits:</p>

<pre><code>[deps] 
base =
    #...

canary =
    # Take the newest of everything.
    Django&gt;=1.7
    django-some-stable-lib&gt;=1.4
    django-shiny-cutting-edge-lib&gt;=0.2

dj17 = 
    #...
</code></pre>

<p>Next I add a canary environment entry to the <code>envlist</code>:</p>

<pre><code>envlist =
    py27-dj17,
    py34-dj17,
    canary
</code></pre>

<p>And finally the canary <code>testenv</code>:</p>

<pre><code>[testenv:canary]
pip_pre=True
basepython=python3.4
deps =
    {[deps]canary}
</code></pre>

<p>I use <code>pip_pre=True</code> here so tox passes the <code>--pre</code> argument to pip, allowing pip to install non-final (alpha/beta/release candidate) packages. </p>

<p>I have decided for now to just have a canary build for Python 3.4 as it is the latest python we support.</p>

<p>All I need to do is add a nightly scheduled build to my CI server to execute the build by calling <code>tox -r -e canary</code> (<code>-r</code> to recreate the virtualenv and <code>-e</code> to specify the environment).</p>

<h3 id="programminginyourcicd">Programming in your CI/CD</h3>

<p>As an aside; Tox is an excellent example of the negatives highlighted by the <strong>On Hold</strong> blip: Programming in your CI/CD.</p>

<blockquote>
  <p>We still see teams configure their CI and CD tools by directly embedding complex multi-line commands into the configuration of the tool. Often these embedded commands also contain steps that would only ever take effect in the build environment including things such as CI specific environment variables, steps that would create/modify files and templates only in the CI environment etc. This makes the build environment a special beast - whose results cannot be duplicated locally on a developer's machine.</p>
  
  <blockquote>
    <p>- <a href="http://www.thoughtworks.com/radar/techniques/programming-in-your-ci-cd-tool">ThoughtWorks Technology Radar</a></p>
  </blockquote>
</blockquote>

<p>By relying on Tox to run our tests everywhere, we avoid any CI  complex build scripts and special cases whilst also making it easy to run and debug any environment configuration on developer machines.</p>

<p>I recommend that you checkout the <a href="http://www.thoughtworks.com/radar/">ThoughtWorks Technology Radar</a> and see if you find anything to add to your own radar.</p>
  </section>

  </div></body></html>