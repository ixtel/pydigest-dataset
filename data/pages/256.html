<html><body><div><div class="entry-content">
						<p>Python is an easy and powerful programming language that allows us to write sophisticated programs: <a href="https://www.dropbox.com/">Dropbox</a> and <a href="http://www.bittorrent.com/intl/es/">BitTorrent</a> are excellent examples. It is common that Python programs are delivered in source code, but in some cases different techniques like obfuscation and compilation are applied to protect the code from curious eyes. But do these techniques really work?</p>
<p>In this article we will see some tools that supposedly help us to protect our code and how easily they are subverted. </p>
<p>We have two example programs written in Python: the first one is a simple function that asks for a password and shows a message; the second one is the same but this time we have used a class.</p>
<pre>
<code>
def main():

        a = "toomanysecrets"

        res = raw_input("Please enter your password: ")
        
        if res == a:
                print "ACCESS GRANTED"
        else:
                print "ACCESS DENIED"

if __name__ == "__main__":
	main()
</code></pre>
<p>secretapp1.py</p>
<pre>
<code>
class DoMain:

        def __init__(self):
                self.a = "toomanysecrets"

        def Ask(self):
                res = raw_input("Please enter your password: ")

                if res == self.a:
                        print "ACCESS GRANTED"
                else:
                        print "ACCESS DENIED"

if __name__ == "__main__":
	dm = DoMain()
	dm.Ask()
</code></pre>
<p>secretapp2.py</p>
<p>Suppose I don‚Äôt want to deliver these programs code, then I have several options. Our first option is to obfuscate the code, thus making it difficult to read.</p>
<p><b>Pyobfuscate</b></p>
<p>This program allows you to obfuscate the code but it is still completely valid for the Python interpreter. Here is an example with SecretApp1 and SecretApp2.</p>
<p><a href="http://www.simonroses.com/wp-content/uploads/2013/10/simonroses_python_cap1.png"><img src="http://www.simonroses.com/wp-content/uploads/2013/10/simonroses_python_cap1-300x156.png" alt="simonroses_python_cap1"/></a><br/>
Fig. 1 ‚Äì Obfuscated secretapp1</p>
<p><a href="http://www.simonroses.com/wp-content/uploads/2013/10/simonroses_python_cap2.png"><img src="http://www.simonroses.com/wp-content/uploads/2013/10/simonroses_python_cap2-300x156.png" alt="simonroses_python_cap2"/></a><br/>
Fig. 2 ‚Äì Obfuscated secretapp2</p>
<p>At a glance our code makes no sense, but if you look closely at the result we see the text strings in the code and we can recognize Python syntax. It is not too difficult to reconstruct the original code from the obfuscated code.</p>
<p>Despite its limitations, I invite you to visit the <a href="https://github.com/astrand/pyobfuscate">tool website</a> to check its possibilities.</p>
<p><b>Htibctobf</b></p>
<p>This tool was originally written to solve a challenge in a hacking competition at the Hack in the Box conference. I recommend reading <a href="http://jbremer.org/python-source-obfuscation-using-asts/">this great article</a> to learn more about it.</p>
<p>Unlike the previous tool, Htibctobf obfuscates Python code by modifying the AST (<a href="http://docs.python.org/2/library/ast.html">Abstract Syntax Trees</a>). When you run this tool, we can see our obfuscated Python code in Fig. 3 and Fig. 4.</p>
<p><a href="http://www.simonroses.com/wp-content/uploads/2013/10/simonroses_python_cap3.png"><img src="http://www.simonroses.com/wp-content/uploads/2013/10/simonroses_python_cap3-300x151.png" alt="simonroses_python_cap3"/></a><br/>
Fig. 3 ‚Äì Obfucated secretapp1</p>
<p><a href="http://www.simonroses.com/wp-content/uploads/2013/10/simonroses_python_cap4.png"><img src="http://www.simonroses.com/wp-content/uploads/2013/10/simonroses_python_cap4-300x151.png" alt="simonroses_python_cap4"/></a><br/>
Fig. 4 ‚Äì Obfuscated secretapp2</p>
<p>We can see the obfuscated code, including text strings, despite that it is not too difficult to reconstruct the original code as well. </p>
<p>Without a doubt an interesting concept with many possibilities, nevertheless it requires improvements to be useful.</p>
<p>In some cases perhaps it is enough to obfuscate the code, but let‚Äôs look for other options to protect our code more effectively, therefore we will have to resort to compile our Python code to create an executable.</p>
<p><b>Py2exe</b></p>
<p>Possibly one of the most popular choices to turn Python code into a Windows executable. <a href="http://www.py2exe.org">Py2exe</a> </p>
<p>First we have to create a file called Setup that includes a reference to the program we want to build/compile. See setup script.</p>
<pre>
<code>
from distutils.core import setup
import py2exe

setup(console=['secretapp1.py'])
</code></pre>
<p>setup.py</p>
<p>We are now ready to compile our Python code into a Windows executable, so let‚Äôs run py2exe. See Fig. 5.</p>
<p><a href="http://www.simonroses.com/wp-content/uploads/2013/10/simonroses_python_cap5.png"><img src="http://www.simonroses.com/wp-content/uploads/2013/10/simonroses_python_cap5-300x151.png" alt="simonroses_python_cap5"/></a><br/>
Fig. 5 ‚Äì Build secretapp1.exe</p>
<p>Once the building process is completed, py2exe creates a directory called ‚Äúdist‚Äù which includes our executable and some necessary libraries. In Fig. 6 we can see that py2exe completes successfully and we execute our program in exe format.</p>
<p><a href="http://www.simonroses.com/wp-content/uploads/2013/10/simonroses_python_cap6.png"><img src="http://www.simonroses.com/wp-content/uploads/2013/10/simonroses_python_cap6-300x151.png" alt="simonroses_python_cap6"/></a><br/>
Fig. 6 ‚Äì Build completed!</p>
<p>We could now distribute this binary without fear to give out our code or maybe not?</p>
<p><b>Py2exe_extract</b></p>
<p>This tool allows us to extract Python object file within the executable created using py2exe, basically inverting the process. <a href="http://code.google.com/p/py2exe-extract/">Py2exe_extract</a></p>
<p>In Fig. 7 we can see how we use py2exe_extract to get the object file secretapp1.pyc (the content of this file is platform-independent and is known as Bytecode) from secretapp1.exe.</p>
<p><a href="http://www.simonroses.com/wp-content/uploads/2013/10/simonroses_python_cap7.png"><img src="http://www.simonroses.com/wp-content/uploads/2013/10/simonroses_python_cap7-300x151.png" alt="simonroses_python_cap7"/></a><br/>
Fig. 7 ‚Äì Exctracting object file</p>
<p>Now let‚Äôs explore ways to get the code from this object file. </p>
<p><b>Unwind</b></p>
<p><a href="https://github.com/evanw/unwind">Unwind</a> is a disassembler for Python Bytecode that can be used to analyze object files ‚Äú.pyc‚Äù. For this example, I‚Äôve written a simple script in Python, mytest.py, that imports the disassembler and analyzes the pyc file. See code below.</p>
<pre>
<code>
import unwind

print(unwind.disassemble('secretapp1.pyc'))
</code></pre>
<p>mytest.py</p>
<p>With this script you can run the following command and get a disassembly of the object file. See Fig. 8.</p>
<p><a href="http://www.simonroses.com/wp-content/uploads/2013/10/simonroses_python_cap8.png"><img src="http://www.simonroses.com/wp-content/uploads/2013/10/simonroses_python_cap8-236x300.png" alt="simonroses_python_cap8"/></a><br/>
Fig. 8 ‚Äì Python Bytecode</p>
<p>For low level lovers this will be your favorite choice üòâ</p>
<p><b>Uncompyle2</b></p>
<p>Another option is to use a decompiler like <a href="https://github.com/wibiti/uncompyle2">uncompyle2</a> to get the code directly from the object file ‚Äú.pyc‚Äù without having to go through the disassembly as we previously saw.</p>
<p>This tool is powerful and easy to use as you can see in Fig. 9 using a simple command we get the source code for secretapp1.pyc.</p>
<p><a href="http://www.simonroses.com/wp-content/uploads/2013/10/simonroses_python_cap9.png"><img src="http://www.simonroses.com/wp-content/uploads/2013/10/simonroses_python_cap9-300x151.png" alt="simonroses_python_cap9"/></a><br/>
Fig. 9 ‚Äì Secretapp1 code from object file</p>
<p>Wow, we got source code!</p>
<p>Throughout the article, we have seen some obfuscation and compilation techniques to protect Python code, but we have also been able to subvert the entire protection quite easily <img src="http://www.simonroses.com/wp-includes/images/smilies/simple-smile.png" alt=":)" class="wp-smiley"/></p>
<p>The following are other Python compilers that can be used in Windows, Linux, or MacOS, but they suffer from the same problems described in this article. </p>

<p>We could also analyze and subvert binaries using tools such as <a href="https://www.hex-rays.com/products/ida/index.shtml">IDA PRO</a> or <a href="http://www.immunityinc.com/products-immdbg.shtml">Immunity Debugger</a> but I will leave it for a future post. Another interesting tool that I have not mentioned is <a href="https://github.com/MyNameIsMeerkat/pyREtic">pyREtic</a>, which is an extensible framework for in-memory Python Bytecode reverse engineering.</p>
<p>For an attacker to get the Python code is a matter of time, however to make things really difficult from a defensive point of view we have to combine different protection techniques.</p>
<p><b>Do you protect your Python programs? Which methods do you use?</b></p>
<p>‚Äî Simon Roses Femerling</p>
											</div>


					</div></body></html>