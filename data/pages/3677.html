<html><body><div><article class="techblog-post full">

    <header class="page-header">
        <h1>
        Saving processes and threads in a WSGI server with Moya
        </h1>
    </header>

    
<p class="lead">I have a webserver with 3 WSGI applications running on different domains (<a href="https://www.moyaproject.com" class="external-link" title="www.moyaproject.com">1</a>, <a href="https://packages.moyaproject.com" class="external-link" title="packages.moyaproject.com">2</a>, <a href="https://notes.moyaproject.com" class="external-link" title="notes.moyaproject.com">3</a>). All deployed with a combination of Gunicorn and NGINX. A combination that works really well, but there are two annoyances that are only going to get worse the more sites I deploy:</p>
<p>A) The configuration for each server resides in a different location on the filesystem, so I have to recall &amp; type a long path to edit settings.</p>
<p>B) More significantly, each server adds extra resource requirements. I follow the advice of running each WSGI application with (2 * number_of_cores + 1) processes, each with 8 threads. The threads may be overkill, but that ensures that the server can use all available capacity to handle dynamic requests. On my 4 core server, that's 9 processes, 72 threads <em>per site</em>. Or 27 processes, and 216 threads for the 3 sites. Clearly that's not scalable if I want to host more web applications on one server.</p>
<p>A new feature recently added to <a href="https://github.com/moyaproject/moya" class="external-link" title="github.com">Moya</a> fixes both those problems. Rather than deploy a WSGI application for each site, Moya can now optionally create a single WSGI application that serves many sites. With this new system, configuration is read from /etc/moya/, which contains a directory structure like this:</p>



<div class="code"><pre>|-- logging.ini<br/>|-- moya.conf<br/>|-- sites-available<br/>|   |-- moyapi.ini<br/>|   |-- moyaproject.ini<br/>|   `-- notes.ini<br/>`-- sites-enabled<br/>    |-- moyapi.ini<br/>    |-- moyaproject.ini<br/>    `-- notes.ini</pre></div>

<p>At the top level is “moya.conf” which contains a few server-wide settings, and “logging.ini” which contains logging settings. The directories “sites-available” and “sites-enabled” work like Apache and NGINX servers; settings for each site are read from “sites-enabled”, which contains symlinks to files in “sites-available”.</p>
<p>Gunicorn (or any other wsgi server) can run these sites with a single instance by specifying the WSGI module as “moya.service:application”. This application object loads the sites from “sites-available” and is responsible for dispatching requests based on domains specified in the INI files.</p>
<p>Because all sites now go through a single Gunicorn instance, requests are shared amongst one optimal pool of processes / threads. This keeps the memory footprint low and negates the need to allocate resources based on traffic.</p>
<p>This new multi-server system is somewhat experimental, and hasn't been documented. But since I believe in eating my own dog-food, it has been <a href="https://www.moyaproject.com" class="external-link" title="www.moyaproject.com">live</a> now for a whole hour–with no problems.</p>




</article>


</div></body></html>