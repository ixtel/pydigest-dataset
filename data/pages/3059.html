<html><body><div><div class="section" id="the-problem">
<h2>The Problem</h2>
<p>I have to believe that anyone that has created a pivot table in Excel has had the
need (at one time or another) to break the data into multiple “chunks” for distribution to various people.</p>
<p>For example, if we had this pivot table:</p>

<p>We would really like to send a seperate report (or seperate tabs in one file)
to each manager (Debra and Fred in this example). How would you do this in Excel? In my experience, I would normally just
copy and paste - I’m not too proud to admit I’ve done that. Others might write <span class="caps">VBA</span>. There may
even be other options I haven’t figured out.</p>
<p>Bottom line: it’s a hassle.</p>
<p>Pandas has a solution to help you out - <a class="reference external" href="http://pandas.pydata.org/pandas-docs/dev/generated/pandas.DataFrame.xs.html">DataFrame.xs</a> . Have you ever heard of it? Me neither.
Even after reading the documentation it might not be clear to you how useful it can be.
Once you understand what it does, I think you’ll immmediately see the usefulness
for generating custom reports/spreadsheets from your own pivot tables using the
cross-section function.</p>
</div>
<div class="section" id="xs-explained">
<h2><span class="caps">XS</span> Explained</h2>
<p>The easiest way to understand <code class="code">
xs</code>
 is to show an example. I will take a data example
from the <a class="reference external" href="http://pbpython.com/pandas-pivot-table-explained.html">pivot table article</a>.</p>
<p>First we get the data uploaded into a simple pivot table.
Do my standard imports, read in the data and create my pivot table:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s">"sales-funnel.xlsx"</span><span class="p">)</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s">"Manager"</span><span class="p">,</span><span class="s">"Rep"</span><span class="p">,</span><span class="s">"Product"</span><span class="p">],</span>
               <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="s">"Price"</span><span class="p">,</span><span class="s">"Quantity"</span><span class="p">],</span>
               <span class="n">aggfunc</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">],</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

<div>
<table border="1" class="table table-condensed">
<thead>
<tr>
<th/>
<th/>
<th/>
<th colspan="2" halign="left">sum</th>
<th colspan="2" halign="left">mean</th>
</tr>
<tr>
<th/>
<th/>
<th/>
<th>Price</th>
<th>Quantity</th>
<th>Price</th>
<th>Quantity</th>
</tr>
<tr>
<th>Manager</th>
<th>Rep</th>
<th>Product</th>
<th/>
<th/>
<th/>
<th/>
</tr>
</thead>
<tbody>
<tr>
<th rowspan="7" valign="top">Debra Henley</th>
<th rowspan="3" valign="top">Craig Booker</th>
<th><span class="caps">CPU</span></th>
<td>  65000</td>
<td> 2</td>
<td> 32500</td>
<td> 1.0</td>
</tr>
<tr>
<th>Maintenance</th>
<td>   5000</td>
<td> 2</td>
<td>  5000</td>
<td> 2.0</td>
</tr>
<tr>
<th>Software</th>
<td>  10000</td>
<td> 1</td>
<td> 10000</td>
<td> 1.0</td>
</tr>
<tr>
<th rowspan="2" valign="top">Daniel Hilton</th>
<th><span class="caps">CPU</span></th>
<td> 105000</td>
<td> 4</td>
<td> 52500</td>
<td> 2.0</td>
</tr>
<tr>
<th>Software</th>
<td>  10000</td>
<td> 1</td>
<td> 10000</td>
<td> 1.0</td>
</tr>
<tr>
<th rowspan="2" valign="top">John Smith</th>
<th><span class="caps">CPU</span></th>
<td>  35000</td>
<td> 1</td>
<td> 35000</td>
<td> 1.0</td>
</tr>
<tr>
<th>Maintenance</th>
<td>   5000</td>
<td> 2</td>
<td>  5000</td>
<td> 2.0</td>
</tr>
<tr>
<th rowspan="6" valign="top">Fred Anderson</th>
<th rowspan="3" valign="top">Cedric Moss</th>
<th><span class="caps">CPU</span></th>
<td>  95000</td>
<td> 3</td>
<td> 47500</td>
<td> 1.5</td>
</tr>
<tr>
<th>Maintenance</th>
<td>   5000</td>
<td> 1</td>
<td>  5000</td>
<td> 1.0</td>
</tr>
<tr>
<th>Software</th>
<td>  10000</td>
<td> 1</td>
<td> 10000</td>
<td> 1.0</td>
</tr>
<tr>
<th rowspan="3" valign="top">Wendy Yule</th>
<th><span class="caps">CPU</span></th>
<td> 165000</td>
<td> 7</td>
<td> 82500</td>
<td> 3.5</td>
</tr>
<tr>
<th>Maintenance</th>
<td>   7000</td>
<td> 3</td>
<td>  7000</td>
<td> 3.0</td>
</tr>
<tr>
<th>Monitor</th>
<td>   5000</td>
<td> 2</td>
<td>  5000</td>
<td> 2.0</td>
</tr>
</tbody>
</table>
</div><p>This is fairly straightforward once you understand the <code class="code">
pivot_table</code>
 syntax.</p>
<p>Now, let’s take a look at what <code class="code">
xs</code>
 can do:</p>
<div class="highlight"><pre><span class="n">table</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="s">'Debra Henley'</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
<div>
<table border="1" class="table table-condensed">
<thead>
<tr>
<th/>
<th/>
<th colspan="2" halign="left">sum</th>
<th colspan="2" halign="left">mean</th>
</tr>
<tr>
<th/>
<th/>
<th>Price</th>
<th>Quantity</th>
<th>Price</th>
<th>Quantity</th>
</tr>
<tr>
<th>Rep</th>
<th>Product</th>
<th/>
<th/>
<th/>
<th/>
</tr>
</thead>
<tbody>
<tr>
<th rowspan="3" valign="top">Craig Booker</th>
<th><span class="caps">CPU</span></th>
<td>  65000</td>
<td> 2</td>
<td> 32500</td>
<td> 1</td>
</tr>
<tr>
<th>Maintenance</th>
<td>   5000</td>
<td> 2</td>
<td>  5000</td>
<td> 2</td>
</tr>
<tr>
<th>Software</th>
<td>  10000</td>
<td> 1</td>
<td> 10000</td>
<td> 1</td>
</tr>
<tr>
<th rowspan="2" valign="top">Daniel Hilton</th>
<th><span class="caps">CPU</span></th>
<td> 105000</td>
<td> 4</td>
<td> 52500</td>
<td> 2</td>
</tr>
<tr>
<th>Software</th>
<td>  10000</td>
<td> 1</td>
<td> 10000</td>
<td> 1</td>
</tr>
<tr>
<th rowspan="2" valign="top">John Smith</th>
<th><span class="caps">CPU</span></th>
<td>  35000</td>
<td> 1</td>
<td> 35000</td>
<td> 1</td>
</tr>
<tr>
<th>Maintenance</th>
<td>   5000</td>
<td> 2</td>
<td>  5000</td>
<td> 2</td>
</tr>
</tbody>
</table>
</div><p>Ok, this is pretty interesting. <code class="code">
xs</code>
 allows me to drill down to one cross-section of the pivot table.
We can drill down multiple levels as well. If we want to just see one rep’s results:</p>
<div class="highlight"><pre><span class="n">table</span><span class="o">.</span><span class="n">xs</span><span class="p">((</span><span class="s">'Debra Henley'</span><span class="p">,</span><span class="s">'Craig Booker'</span><span class="p">),</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
<div>
<table border="1" class="table table-condensed">
<thead>
<tr>
<th/>
<th colspan="2" halign="left">sum</th>
<th colspan="2" halign="left">mean</th>
</tr>
<tr>
<th/>
<th>Price</th>
<th>Quantity</th>
<th>Price</th>
<th>Quantity</th>
</tr>
<tr>
<th>Product</th>
<th/>
<th/>
<th/>
<th/>
</tr>
</thead>
<tbody>
<tr>
<th><span class="caps">CPU</span></th>
<td> 65000</td>
<td> 2</td>
<td> 32500</td>
<td> 1</td>
</tr>
<tr>
<th>Maintenance</th>
<td>  5000</td>
<td> 2</td>
<td>  5000</td>
<td> 2</td>
</tr>
<tr>
<th>Software</th>
<td> 10000</td>
<td> 1</td>
<td> 10000</td>
<td> 1</td>
</tr>
</tbody>
</table>
</div><p>If you’re like me, you just had light bulb go off and realize that
a lot of cutting and pasting you have done in Excel can be a thing of the past.</p>
<p>We need the <code class="code">
get_level_values</code>
 to make this work as seamlessly as possible.
For example, if we want to see all the Manager values:</p>
<div class="highlight"><pre><span class="n">table</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
<pre class="literal-block">
Index([u'Debra Henley', u'Debra Henley', u'Debra Henley', u'Debra Henley', u'Debra Henley', u'Debra Henley', u'Debra Henley', u'Fred Anderson', u'Fred Anderson', u'Fred Anderson', u'Fred Anderson', u'Fred Anderson', u'Fred Anderson'], dtype='object')
</pre>
<p>If we want to see all the rep values:</p>
<div class="highlight"><pre><span class="n">table</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
<pre class="literal-block">
Index([u'Craig Booker', u'Craig Booker', u'Craig Booker', u'Daniel Hilton', u'Daniel Hilton', u'John Smith', u'John Smith', u'Cedric Moss', u'Cedric Moss', u'Cedric Moss', u'Wendy Yule', u'Wendy Yule', u'Wendy Yule'], dtype='object')
</pre>
<p>To make it a little simpler for iterating, use <code class="code">
unique</code>
:</p>
<div class="highlight"><pre><span class="n">table</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</pre></div>
<pre class="literal-block">
array([u'Debra Henley', u'Fred Anderson'], dtype=object)
</pre>
<p>Now it should be clear what we’re about to do. I’ll print it out first so you can see.</p>
<div class="highlight"><pre><span class="k">for</span> <span class="n">manager</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</pre></div>
<pre class="literal-block">
                              sum            mean
                            Price Quantity  Price Quantity
Rep           Product
Craig Booker  CPU           65000        2  32500        1
              Maintenance    5000        2   5000        2
              Software      10000        1  10000        1
Daniel Hilton CPU          105000        4  52500        2
              Software      10000        1  10000        1
John Smith    CPU           35000        1  35000        1
              Maintenance    5000        2   5000        2
                            sum            mean
                          Price Quantity  Price Quantity
Rep         Product
Cedric Moss CPU           95000        3  47500      1.5
            Maintenance    5000        1   5000      1.0
            Software      10000        1  10000      1.0
Wendy Yule  CPU          165000        7  82500      3.5
            Maintenance    7000        3   7000      3.0
            Monitor        5000        2   5000      2.0
</pre>
<p>As we pull it all together, it is super simple to create a single Excel sheet with one tab per manager:</p>
<div class="highlight"><pre><span class="n">writer</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="s">'output.xlsx'</span><span class="p">)</span>

<span class="k">for</span> <span class="n">manager</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
    <span class="n">temp_df</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">temp_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span><span class="n">manager</span><span class="p">)</span>

<span class="n">writer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
<p>You now get an output that looks like this:</p>

</div>
<div class="section" id="stop-and-think">
<h2>Stop and Think</h2>
<p>As you sit back and think about this code, just take a second to revel in how
much we are doing with 7 lines of code (plus 2 imports):</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s">"sales-funnel.xlsx"</span><span class="p">)</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s">"Manager"</span><span class="p">,</span><span class="s">"Rep"</span><span class="p">,</span><span class="s">"Product"</span><span class="p">],</span> <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="s">"Price"</span><span class="p">,</span><span class="s">"Quantity"</span><span class="p">],</span><span class="n">aggfunc</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">],</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">writer</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="s">'output.xlsx'</span><span class="p">)</span>
<span class="k">for</span> <span class="n">manager</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
    <span class="n">temp_df</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">temp_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span><span class="n">manager</span><span class="p">)</span>
<span class="n">writer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
<p>We have just read in an Excel file, created a powerful summary of data, then
broken the data up into an output Excel file with separate tabs for each manager.
Just by using 9 lines of code!</p>
<p>I think my excitement about this functionality is warranted.</p>
</div>
<div class="section" id="taking-it-one-step-further">
<h2>Taking It One Step Further</h2>
<p>In some cases, you might want to generate separate files per manager or
do some other manipulation. It should be pretty simple to understand
how to do so given the examples above.</p>
<p>To close out this discussion, I decided I would wrap things up with a fully functional
program that utilizes additional python functions to make this script a
truly useful program that utilizes good python programming practices so
that you can scale it up for your own needs:</p>
<div class="highlight"><pre><span class="sd">"""</span>
<span class="sd">Sample report generation script from pbpython.com</span>

<span class="sd">This program takes an input Excel file, reads it and turns it into a</span>
<span class="sd">pivot table.</span>

<span class="sd">The output is saved in multiple tabs in a new Excel file.</span>
<span class="sd">"""</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>


<span class="k">def</span> <span class="nf">create_pivot</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">index_list</span><span class="o">=</span><span class="p">[</span><span class="s">"Manager"</span><span class="p">,</span> <span class="s">"Rep"</span><span class="p">,</span> <span class="s">"Product"</span><span class="p">],</span>
                 <span class="n">value_list</span><span class="o">=</span><span class="p">[</span><span class="s">"Price"</span><span class="p">,</span> <span class="s">"Quantity"</span><span class="p">]):</span>
    <span class="sd">"""</span>
<span class="sd">    Read in the Excel file, create a pivot table and return it as a DataFrame</span>
<span class="sd">    """</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index_list</span><span class="p">,</span>
                           <span class="n">values</span><span class="o">=</span><span class="n">value_list</span><span class="p">,</span>
                           <span class="n">aggfunc</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">],</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">table</span>


<span class="k">def</span> <span class="nf">save_report</span><span class="p">(</span><span class="n">report</span><span class="p">,</span> <span class="n">outfile</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Take a report and save it to a single Excel file</span>
<span class="sd">    """</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">manager</span> <span class="ow">in</span> <span class="n">report</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="n">temp_df</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">temp_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">manager</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s">'Script to generate sales report'</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'infile'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">FileType</span><span class="p">(</span><span class="s">'r'</span><span class="p">),</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">"report source file in Excel"</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'outfile'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">FileType</span><span class="p">(</span><span class="s">'w'</span><span class="p">),</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">"output file in Excel"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="c"># We need to pass the full file name instead of the file object</span>
    <span class="n">sales_report</span> <span class="o">=</span> <span class="n">create_pivot</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">infile</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">save_report</span><span class="p">(</span><span class="n">sales_report</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">outfile</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>
<p>There are other things you could do to this file to make it even more portable
but this should give you the idea. If you are interested, I’ve posted a
<a class="reference external" href="https://gist.github.com/chris1610/ba3f37dd7c52077d4eeb">gist</a> so people can make forks and update if they want.</p>
</div>
</div></body></html>