<html><body><div><div class="section" id="the-data">
<h2>The Data</h2>
<p>One of the challenges with using the panda’s <code class="code">
pivot_table</code>
 is making sure you understand
your data and what questions you are trying to answer with the pivot table. It is a
seemingly simple function but can produce very powerful analysis very quickly.</p>
<p>In this scenario, I’m going to be tracking a sales pipeline (also called funnel).
The basic problem is that some sales cycles are very long (think “enterprise software”, capital equipment, etc.)
and management wants to understand it in more detail throughout the year.</p>
<p>Typical questions include:</p>
<ul class="simple">
<li>How much revenue is in the pipeline?</li>
<li>What products are in the pipeline?</li>
<li>Who has what products at what stage?</li>
<li>How likely are we to close deals by year end?</li>
</ul>
<p>Many companies will have <span class="caps">CRM</span> tools or other software that sales uses to track the process.
While they may have useful tools for analyzing the data, inevitably someone will export the
data to Excel and use a PivotTable to summarize the data.</p>
<p>Using a panda’s pivot table can be a good alternative because it is:</p>
<ul class="simple">
<li>Quicker (once it is set up)</li>
<li>Self documenting (look at the code and you know what it does)</li>
<li>Easy to use to generate a report or email</li>
<li>More flexible because you can define custome aggregation functions</li>
</ul>
</div>
<div class="section" id="read-in-the-data">
<h2>Read in the data</h2>
<p>Let’s set up our environment first.</p>
<p>If you want to follow along, you can download the <a class="reference external" href="http://pbpython.com/extras/sales-funnel.xlsx">Excel file</a>.</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
</pre></div>
<div class="panel panel-warning">
<p class="panel-heading">
Version Warning</p>
<p class="panel-body">
The pivot_table <span class="caps">API</span> has changed over time so please make sure you have a recent version of pandas ( &gt; 0.15) installed for this example to work. This example also uses the category data type which requires a recent version as well.</p>
</div>
<p>Read in our sales funnel data into our DataFrame</p>
<div class="highlight"><pre><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s">"../in/sales-funnel.xlsx"</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
<div>
<table border="1" class="table table-condensed">
<thead>
<tr>
<th/>
<th>Account</th>
<th>Name</th>
<th>Rep</th>
<th>Manager</th>
<th>Product</th>
<th>Quantity</th>
<th>Price</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td> 714466</td>
<td>              Trantow-Barrows</td>
<td>  Craig Booker</td>
<td> Debra Henley</td>
<td> <span class="caps">CPU</span></td>
<td> 1</td>
<td> 30000</td>
<td> presented</td>
</tr>
<tr>
<th>1</th>
<td> 714466</td>
<td>              Trantow-Barrows</td>
<td>  Craig Booker</td>
<td> Debra Henley</td>
<td>    Software</td>
<td> 1</td>
<td> 10000</td>
<td> presented</td>
</tr>
<tr>
<th>2</th>
<td> 714466</td>
<td>              Trantow-Barrows</td>
<td>  Craig Booker</td>
<td> Debra Henley</td>
<td> Maintenance</td>
<td> 2</td>
<td>  5000</td>
<td>   pending</td>
</tr>
<tr>
<th>3</th>
<td> 737550</td>
<td> Fritsch, Russel and Anderson</td>
<td>  Craig Booker</td>
<td> Debra Henley</td>
<td> <span class="caps">CPU</span></td>
<td> 1</td>
<td> 35000</td>
<td>  declined</td>
</tr>
<tr>
<th>4</th>
<td> 146832</td>
<td>                 Kiehn-Spinka</td>
<td> Daniel Hilton</td>
<td> Debra Henley</td>
<td> <span class="caps">CPU</span></td>
<td> 2</td>
<td> 65000</td>
<td>       won</td>
</tr>
</tbody>
</table>
</div><p>For convenience sake, let’s define the status column as a <code class="code">
category</code>
 and
set the order we want to view.</p>
<p>This isn’t strictly required but helps us keep the order we want as we
work through analyzing the data.</p>
<div class="highlight"><pre><span class="n">df</span><span class="p">[</span><span class="s">"Status"</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">"Status"</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">"category"</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s">"Status"</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">set_categories</span><span class="p">([</span><span class="s">"won"</span><span class="p">,</span><span class="s">"pending"</span><span class="p">,</span><span class="s">"presented"</span><span class="p">,</span><span class="s">"declined"</span><span class="p">],</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="pivot-the-data">
<h2>Pivot the data</h2>
<p>As we build up the pivot table, I think it’s easiest to take it one step
at a time. Add items and check each step to verify you are
getting the results you expect. Don’t be afraid to play with the order and the
variables to see what presentation makes the most sense for your needs.</p>
<p>The simplest pivot table must have a dataframe and an <code class="code">
index</code>
. In this
case, let’s use the Name as our index.</p>
<div class="highlight"><pre><span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s">"Name"</span><span class="p">])</span>
</pre></div>
<div>
<table border="1" class="table table-condensed">
<thead>
<tr>
<th/>
<th>Account</th>
<th>Price</th>
<th>Quantity</th>
</tr>
<tr>
<th>Name</th>
<th/>
<th/>
<th/>
</tr>
</thead>
<tbody>
<tr>
<th>Barton <span class="caps">LLC</span></th>
<td> 740150</td>
<td>  35000</td>
<td> 1.000000</td>
</tr>
<tr>
<th>Fritsch, Russel and Anderson</th>
<td> 737550</td>
<td>  35000</td>
<td> 1.000000</td>
</tr>
<tr>
<th>Herman <span class="caps">LLC</span></th>
<td> 141962</td>
<td>  65000</td>
<td> 2.000000</td>
</tr>
<tr>
<th>Jerde-Hilpert</th>
<td> 412290</td>
<td>   5000</td>
<td> 2.000000</td>
</tr>
<tr>
<th>Kassulke, Ondricka and Metz</th>
<td> 307599</td>
<td>   7000</td>
<td> 3.000000</td>
</tr>
<tr>
<th>Keeling <span class="caps">LLC</span></th>
<td> 688981</td>
<td> 100000</td>
<td> 5.000000</td>
</tr>
<tr>
<th>Kiehn-Spinka</th>
<td> 146832</td>
<td>  65000</td>
<td> 2.000000</td>
</tr>
<tr>
<th>Koepp Ltd</th>
<td> 729833</td>
<td>  35000</td>
<td> 2.000000</td>
</tr>
<tr>
<th>Kulas Inc</th>
<td> 218895</td>
<td>  25000</td>
<td> 1.500000</td>
</tr>
<tr>
<th>Purdy-Kunde</th>
<td> 163416</td>
<td>  30000</td>
<td> 1.000000</td>
</tr>
<tr>
<th>Stokes <span class="caps">LLC</span></th>
<td> 239344</td>
<td>   7500</td>
<td> 1.000000</td>
</tr>
<tr>
<th>Trantow-Barrows</th>
<td> 714466</td>
<td>  15000</td>
<td> 1.333333</td>
</tr>
</tbody>
</table>
</div><p>You can have multiple indexes as well. In fact, most of the <code class="code">
pivot_table</code>

args can take multiple values via a list.</p>
<div class="highlight"><pre><span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s">"Name"</span><span class="p">,</span><span class="s">"Rep"</span><span class="p">,</span><span class="s">"Manager"</span><span class="p">])</span>
</pre></div>
<div>
<table border="1" class="table table-condensed">
<thead>
<tr>
<th/>
<th/>
<th/>
<th>Account</th>
<th>Price</th>
<th>Quantity</th>
</tr>
<tr>
<th>Name</th>
<th>Rep</th>
<th>Manager</th>
<th/>
<th/>
<th/>
</tr>
</thead>
<tbody>
<tr>
<th>Barton <span class="caps">LLC</span></th>
<th>John Smith</th>
<th>Debra Henley</th>
<td> 740150</td>
<td>  35000</td>
<td> 1.000000</td>
</tr>
<tr>
<th>Fritsch, Russel and Anderson</th>
<th>Craig Booker</th>
<th>Debra Henley</th>
<td> 737550</td>
<td>  35000</td>
<td> 1.000000</td>
</tr>
<tr>
<th>Herman <span class="caps">LLC</span></th>
<th>Cedric Moss</th>
<th>Fred Anderson</th>
<td> 141962</td>
<td>  65000</td>
<td> 2.000000</td>
</tr>
<tr>
<th>Jerde-Hilpert</th>
<th>John Smith</th>
<th>Debra Henley</th>
<td> 412290</td>
<td>   5000</td>
<td> 2.000000</td>
</tr>
<tr>
<th>Kassulke, Ondricka and Metz</th>
<th>Wendy Yule</th>
<th>Fred Anderson</th>
<td> 307599</td>
<td>   7000</td>
<td> 3.000000</td>
</tr>
<tr>
<th>Keeling <span class="caps">LLC</span></th>
<th>Wendy Yule</th>
<th>Fred Anderson</th>
<td> 688981</td>
<td> 100000</td>
<td> 5.000000</td>
</tr>
<tr>
<th>Kiehn-Spinka</th>
<th>Daniel Hilton</th>
<th>Debra Henley</th>
<td> 146832</td>
<td>  65000</td>
<td> 2.000000</td>
</tr>
<tr>
<th>Koepp Ltd</th>
<th>Wendy Yule</th>
<th>Fred Anderson</th>
<td> 729833</td>
<td>  35000</td>
<td> 2.000000</td>
</tr>
<tr>
<th>Kulas Inc</th>
<th>Daniel Hilton</th>
<th>Debra Henley</th>
<td> 218895</td>
<td>  25000</td>
<td> 1.500000</td>
</tr>
<tr>
<th>Purdy-Kunde</th>
<th>Cedric Moss</th>
<th>Fred Anderson</th>
<td> 163416</td>
<td>  30000</td>
<td> 1.000000</td>
</tr>
<tr>
<th>Stokes <span class="caps">LLC</span></th>
<th>Cedric Moss</th>
<th>Fred Anderson</th>
<td> 239344</td>
<td>   7500</td>
<td> 1.000000</td>
</tr>
<tr>
<th>Trantow-Barrows</th>
<th>Craig Booker</th>
<th>Debra Henley</th>
<td> 714466</td>
<td>  15000</td>
<td> 1.333333</td>
</tr>
</tbody>
</table>
</div><p>This is interesting but not particularly useful. What we probably want
to do is look at this by Manager and Rep. It’s easy enough to do by
changing the <code class="code">
index</code>
.</p>
<div class="highlight"><pre><span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s">"Manager"</span><span class="p">,</span><span class="s">"Rep"</span><span class="p">])</span>
</pre></div>
<div>
<table border="1" class="table table-condensed">
<thead>
<tr>
<th/>
<th/>
<th>Account</th>
<th>Price</th>
<th>Quantity</th>
</tr>
<tr>
<th>Manager</th>
<th>Rep</th>
<th/>
<th/>
<th/>
</tr>
</thead>
<tbody>
<tr>
<th rowspan="3" valign="top">Debra Henley</th>
<th>Craig Booker</th>
<td> 720237.0</td>
<td> 20000.000000</td>
<td> 1.250000</td>
</tr>
<tr>
<th>Daniel Hilton</th>
<td> 194874.0</td>
<td> 38333.333333</td>
<td> 1.666667</td>
</tr>
<tr>
<th>John Smith</th>
<td> 576220.0</td>
<td> 20000.000000</td>
<td> 1.500000</td>
</tr>
<tr>
<th rowspan="2" valign="top">Fred Anderson</th>
<th>Cedric Moss</th>
<td> 196016.5</td>
<td> 27500.000000</td>
<td> 1.250000</td>
</tr>
<tr>
<th>Wendy Yule</th>
<td> 614061.5</td>
<td> 44250.000000</td>
<td> 3.000000</td>
</tr>
</tbody>
</table>
</div><p>You can see that the pivot table is smart enough to start aggregating
the data and summarizing it by grouping the reps with their managers.
Now we start to get a glimpse of what a pivot table can do for us.</p>
<p>For this purpose, the Account and Quantity columns aren’t really useful.
Let’s remove it by explicitly defining the columns we care about using
the <code class="code">
values</code>
 field.</p>
<div class="highlight"><pre><span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s">"Manager"</span><span class="p">,</span><span class="s">"Rep"</span><span class="p">],</span><span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="s">"Price"</span><span class="p">])</span>
</pre></div>
<div>
<table border="1" class="table table-condensed">
<thead>
<tr>
<th/>
<th/>
<th>Price</th>
</tr>
<tr>
<th>Manager</th>
<th>Rep</th>
<th/>
</tr>
</thead>
<tbody>
<tr>
<th rowspan="3" valign="top">Debra Henley</th>
<th>Craig Booker</th>
<td> 20000</td>
</tr>
<tr>
<th>Daniel Hilton</th>
<td> 38333</td>
</tr>
<tr>
<th>John Smith</th>
<td> 20000</td>
</tr>
<tr>
<th rowspan="2" valign="top">Fred Anderson</th>
<th>Cedric Moss</th>
<td> 27500</td>
</tr>
<tr>
<th>Wendy Yule</th>
<td> 44250</td>
</tr>
</tbody>
</table>
</div><p>The price column automatically averages the data but we can do a count
or a sum. Adding them is simple using <code class="code">
aggfunc</code>
 and <code class="code">
np.sum</code>
.</p>
<div class="highlight"><pre><span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s">"Manager"</span><span class="p">,</span><span class="s">"Rep"</span><span class="p">],</span><span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="s">"Price"</span><span class="p">],</span><span class="n">aggfunc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">)</span>
</pre></div>
<div>
<table border="1" class="table table-condensed">
<thead>
<tr>
<th/>
<th/>
<th>Price</th>
</tr>
<tr>
<th>Manager</th>
<th>Rep</th>
<th/>
</tr>
</thead>
<tbody>
<tr>
<th rowspan="3" valign="top">Debra Henley</th>
<th>Craig Booker</th>
<td>  80000</td>
</tr>
<tr>
<th>Daniel Hilton</th>
<td> 115000</td>
</tr>
<tr>
<th>John Smith</th>
<td>  40000</td>
</tr>
<tr>
<th rowspan="2" valign="top">Fred Anderson</th>
<th>Cedric Moss</th>
<td> 110000</td>
</tr>
<tr>
<th>Wendy Yule</th>
<td> 177000</td>
</tr>
</tbody>
</table>
</div><p><code class="code">
aggfunc</code>
 can take a list of functions. Let’s try a mean using the numpy
<code class="code">
mean</code>
 function and <code class="code">
len</code>
 to get a count.</p>
<div class="highlight"><pre><span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s">"Manager"</span><span class="p">,</span><span class="s">"Rep"</span><span class="p">],</span><span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="s">"Price"</span><span class="p">],</span><span class="n">aggfunc</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span><span class="nb">len</span><span class="p">])</span>
</pre></div>
<div>
<table border="1" class="table table-condensed">
<thead>
<tr>
<th/>
<th/>
<th>mean</th>
<th>len</th>
</tr>
<tr>
<th/>
<th/>
<th>Price</th>
<th>Price</th>
</tr>
<tr>
<th>Manager</th>
<th>Rep</th>
<th/>
<th/>
</tr>
</thead>
<tbody>
<tr>
<th rowspan="3" valign="top">Debra Henley</th>
<th>Craig Booker</th>
<td> 20000</td>
<td> 4</td>
</tr>
<tr>
<th>Daniel Hilton</th>
<td> 38333</td>
<td> 3</td>
</tr>
<tr>
<th>John Smith</th>
<td> 20000</td>
<td> 2</td>
</tr>
<tr>
<th rowspan="2" valign="top">Fred Anderson</th>
<th>Cedric Moss</th>
<td> 27500</td>
<td> 4</td>
</tr>
<tr>
<th>Wendy Yule</th>
<td> 44250</td>
<td> 4</td>
</tr>
</tbody>
</table>
</div><p>If we want to see sales broken down by the products, the <code class="code">
columns</code>

variable allows us to define one or more columns.</p>
<div class="panel panel-info">
<p class="panel-heading">
Columns vs. Values</p>
<p class="panel-body">
I think one of the confusing points with the <code class="code">
pivot_table</code>
 is the use of <code class="code">
columns</code>
 and <code class="code">
values</code>
.
Remember, <code class="code">
columns</code>
 are optional - they provide an additional way to segment the actual values you care about.
The aggregation functions are applied to the <code class="code">
values</code>
 you list.</p>
</div>
<div class="highlight"><pre><span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s">"Manager"</span><span class="p">,</span><span class="s">"Rep"</span><span class="p">],</span><span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="s">"Price"</span><span class="p">],</span>
               <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">"Product"</span><span class="p">],</span><span class="n">aggfunc</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">])</span>
</pre></div>
<div>
<table border="1" class="table table-condensed">
<thead>
<tr>
<th/>
<th/>
<th colspan="4" halign="left">sum</th>
</tr>
<tr>
<th/>
<th/>
<th colspan="4" halign="left">Price</th>
</tr>
<tr>
<th/>
<th>Product</th>
<th><span class="caps">CPU</span></th>
<th>Maintenance</th>
<th>Monitor</th>
<th>Software</th>
</tr>
<tr>
<th>Manager</th>
<th>Rep</th>
<th/>
<th/>
<th/>
<th/>
</tr>
</thead>
<tbody>
<tr>
<th rowspan="3" valign="top">Debra Henley</th>
<th>Craig Booker</th>
<td>  65000</td>
<td> 5000</td>
<td>  NaN</td>
<td> 10000</td>
</tr>
<tr>
<th>Daniel Hilton</th>
<td> 105000</td>
<td>  NaN</td>
<td>  NaN</td>
<td> 10000</td>
</tr>
<tr>
<th>John Smith</th>
<td>  35000</td>
<td> 5000</td>
<td>  NaN</td>
<td>   NaN</td>
</tr>
<tr>
<th rowspan="2" valign="top">Fred Anderson</th>
<th>Cedric Moss</th>
<td>  95000</td>
<td> 5000</td>
<td>  NaN</td>
<td> 10000</td>
</tr>
<tr>
<th>Wendy Yule</th>
<td> 165000</td>
<td> 7000</td>
<td> 5000</td>
<td>   NaN</td>
</tr>
</tbody>
</table>
</div><p>The NaN’s are a bit distracting. If we want to remove them, we could use
<code class="code">
fill_value</code>
 to set them to 0.</p>
<div class="highlight"><pre><span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s">"Manager"</span><span class="p">,</span><span class="s">"Rep"</span><span class="p">],</span><span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="s">"Price"</span><span class="p">],</span>
               <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">"Product"</span><span class="p">],</span><span class="n">aggfunc</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">],</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
<div>
<table border="1" class="table table-condensed">
<thead>
<tr>
<th/>
<th/>
<th colspan="4" halign="left">sum</th>
</tr>
<tr>
<th/>
<th/>
<th colspan="4" halign="left">Price</th>
</tr>
<tr>
<th/>
<th>Product</th>
<th><span class="caps">CPU</span></th>
<th>Maintenance</th>
<th>Monitor</th>
<th>Software</th>
</tr>
<tr>
<th>Manager</th>
<th>Rep</th>
<th/>
<th/>
<th/>
<th/>
</tr>
</thead>
<tbody>
<tr>
<th rowspan="3" valign="top">Debra Henley</th>
<th>Craig Booker</th>
<td>  65000</td>
<td> 5000</td>
<td>    0</td>
<td> 10000</td>
</tr>
<tr>
<th>Daniel Hilton</th>
<td> 105000</td>
<td>    0</td>
<td>    0</td>
<td> 10000</td>
</tr>
<tr>
<th>John Smith</th>
<td>  35000</td>
<td> 5000</td>
<td>    0</td>
<td>     0</td>
</tr>
<tr>
<th rowspan="2" valign="top">Fred Anderson</th>
<th>Cedric Moss</th>
<td>  95000</td>
<td> 5000</td>
<td>    0</td>
<td> 10000</td>
</tr>
<tr>
<th>Wendy Yule</th>
<td> 165000</td>
<td> 7000</td>
<td> 5000</td>
<td>     0</td>
</tr>
</tbody>
</table>
</div><p>I think it would be useful to add the quantity as well. Add Quantity to
the <code class="code">
values</code>
 list.</p>
<div class="highlight"><pre><span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s">"Manager"</span><span class="p">,</span><span class="s">"Rep"</span><span class="p">],</span><span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="s">"Price"</span><span class="p">,</span><span class="s">"Quantity"</span><span class="p">],</span>
               <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">"Product"</span><span class="p">],</span><span class="n">aggfunc</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">],</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
<div>
<table border="1" class="table table-condensed">
<thead>
<tr>
<th/>
<th/>
<th colspan="8" halign="left">sum</th>
</tr>
<tr>
<th/>
<th/>
<th colspan="4" halign="left">Price</th>
<th colspan="4" halign="left">Quantity</th>
</tr>
<tr>
<th/>
<th>Product</th>
<th><span class="caps">CPU</span></th>
<th>Maintenance</th>
<th>Monitor</th>
<th>Software</th>
<th><span class="caps">CPU</span></th>
<th>Maintenance</th>
<th>Monitor</th>
<th>Software</th>
</tr>
<tr>
<th>Manager</th>
<th>Rep</th>
<th/>
<th/>
<th/>
<th/>
<th/>
<th/>
<th/>
<th/>
</tr>
</thead>
<tbody>
<tr>
<th rowspan="3" valign="top">Debra Henley</th>
<th>Craig Booker</th>
<td>  65000</td>
<td> 5000</td>
<td>    0</td>
<td> 10000</td>
<td> 2</td>
<td> 2</td>
<td> 0</td>
<td> 1</td>
</tr>
<tr>
<th>Daniel Hilton</th>
<td> 105000</td>
<td>    0</td>
<td>    0</td>
<td> 10000</td>
<td> 4</td>
<td> 0</td>
<td> 0</td>
<td> 1</td>
</tr>
<tr>
<th>John Smith</th>
<td>  35000</td>
<td> 5000</td>
<td>    0</td>
<td>     0</td>
<td> 1</td>
<td> 2</td>
<td> 0</td>
<td> 0</td>
</tr>
<tr>
<th rowspan="2" valign="top">Fred Anderson</th>
<th>Cedric Moss</th>
<td>  95000</td>
<td> 5000</td>
<td>    0</td>
<td> 10000</td>
<td> 3</td>
<td> 1</td>
<td> 0</td>
<td> 1</td>
</tr>
<tr>
<th>Wendy Yule</th>
<td> 165000</td>
<td> 7000</td>
<td> 5000</td>
<td>     0</td>
<td> 7</td>
<td> 3</td>
<td> 2</td>
<td> 0</td>
</tr>
</tbody>
</table>
</div><p>What’s interesting is that you can move items to the index to get a
different visual representation. Remove Product from the <code class="code">
columns</code>
 and add to the <code class="code">
index</code>
.</p>
<div class="highlight"><pre><span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s">"Manager"</span><span class="p">,</span><span class="s">"Rep"</span><span class="p">,</span><span class="s">"Product"</span><span class="p">],</span>
               <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="s">"Price"</span><span class="p">,</span><span class="s">"Quantity"</span><span class="p">],</span><span class="n">aggfunc</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">],</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
<div>
<table border="1" class="table table-condensed">
<thead>
<tr>
<th/>
<th/>
<th/>
<th colspan="2" halign="left">sum</th>
</tr>
<tr>
<th/>
<th/>
<th/>
<th>Price</th>
<th>Quantity</th>
</tr>
<tr>
<th>Manager</th>
<th>Rep</th>
<th>Product</th>
<th/>
<th/>
</tr>
</thead>
<tbody>
<tr>
<th rowspan="7" valign="top">Debra Henley</th>
<th rowspan="3" valign="top">Craig Booker</th>
<th><span class="caps">CPU</span></th>
<td>  65000</td>
<td> 2</td>
</tr>
<tr>
<th>Maintenance</th>
<td>   5000</td>
<td> 2</td>
</tr>
<tr>
<th>Software</th>
<td>  10000</td>
<td> 1</td>
</tr>
<tr>
<th rowspan="2" valign="top">Daniel Hilton</th>
<th><span class="caps">CPU</span></th>
<td> 105000</td>
<td> 4</td>
</tr>
<tr>
<th>Software</th>
<td>  10000</td>
<td> 1</td>
</tr>
<tr>
<th rowspan="2" valign="top">John Smith</th>
<th><span class="caps">CPU</span></th>
<td>  35000</td>
<td> 1</td>
</tr>
<tr>
<th>Maintenance</th>
<td>   5000</td>
<td> 2</td>
</tr>
<tr>
<th rowspan="6" valign="top">Fred Anderson</th>
<th rowspan="3" valign="top">Cedric Moss</th>
<th><span class="caps">CPU</span></th>
<td>  95000</td>
<td> 3</td>
</tr>
<tr>
<th>Maintenance</th>
<td>   5000</td>
<td> 1</td>
</tr>
<tr>
<th>Software</th>
<td>  10000</td>
<td> 1</td>
</tr>
<tr>
<th rowspan="3" valign="top">Wendy Yule</th>
<th><span class="caps">CPU</span></th>
<td> 165000</td>
<td> 7</td>
</tr>
<tr>
<th>Maintenance</th>
<td>   7000</td>
<td> 3</td>
</tr>
<tr>
<th>Monitor</th>
<td>   5000</td>
<td> 2</td>
</tr>
</tbody>
</table>
</div><p>For this data set, this representation makes more sense. Now, what if I
want to see some totals? <code class="code">
margins=True</code>
 does that for us.</p>
<div class="highlight"><pre><span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s">"Manager"</span><span class="p">,</span><span class="s">"Rep"</span><span class="p">,</span><span class="s">"Product"</span><span class="p">],</span>
               <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="s">"Price"</span><span class="p">,</span><span class="s">"Quantity"</span><span class="p">],</span>
               <span class="n">aggfunc</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">],</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">margins</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
<div>
<table border="1" class="table table-condensed">
<thead>
<tr>
<th/>
<th/>
<th/>
<th colspan="2" halign="left">sum</th>
<th colspan="2" halign="left">mean</th>
</tr>
<tr>
<th/>
<th/>
<th/>
<th>Price</th>
<th>Quantity</th>
<th>Price</th>
<th>Quantity</th>
</tr>
<tr>
<th>Manager</th>
<th>Rep</th>
<th>Product</th>
<th/>
<th/>
<th/>
<th/>
</tr>
</thead>
<tbody>
<tr>
<th rowspan="7" valign="top">Debra Henley</th>
<th rowspan="3" valign="top">Craig Booker</th>
<th><span class="caps">CPU</span></th>
<td>  65000</td>
<td>  2</td>
<td> 32500.000000</td>
<td> 1.000000</td>
</tr>
<tr>
<th>Maintenance</th>
<td>   5000</td>
<td>  2</td>
<td>  5000.000000</td>
<td> 2.000000</td>
</tr>
<tr>
<th>Software</th>
<td>  10000</td>
<td>  1</td>
<td> 10000.000000</td>
<td> 1.000000</td>
</tr>
<tr>
<th rowspan="2" valign="top">Daniel Hilton</th>
<th><span class="caps">CPU</span></th>
<td> 105000</td>
<td>  4</td>
<td> 52500.000000</td>
<td> 2.000000</td>
</tr>
<tr>
<th>Software</th>
<td>  10000</td>
<td>  1</td>
<td> 10000.000000</td>
<td> 1.000000</td>
</tr>
<tr>
<th rowspan="2" valign="top">John Smith</th>
<th><span class="caps">CPU</span></th>
<td>  35000</td>
<td>  1</td>
<td> 35000.000000</td>
<td> 1.000000</td>
</tr>
<tr>
<th>Maintenance</th>
<td>   5000</td>
<td>  2</td>
<td>  5000.000000</td>
<td> 2.000000</td>
</tr>
<tr>
<th rowspan="6" valign="top">Fred Anderson</th>
<th rowspan="3" valign="top">Cedric Moss</th>
<th><span class="caps">CPU</span></th>
<td>  95000</td>
<td>  3</td>
<td> 47500.000000</td>
<td> 1.500000</td>
</tr>
<tr>
<th>Maintenance</th>
<td>   5000</td>
<td>  1</td>
<td>  5000.000000</td>
<td> 1.000000</td>
</tr>
<tr>
<th>Software</th>
<td>  10000</td>
<td>  1</td>
<td> 10000.000000</td>
<td> 1.000000</td>
</tr>
<tr>
<th rowspan="3" valign="top">Wendy Yule</th>
<th><span class="caps">CPU</span></th>
<td> 165000</td>
<td>  7</td>
<td> 82500.000000</td>
<td> 3.500000</td>
</tr>
<tr>
<th>Maintenance</th>
<td>   7000</td>
<td>  3</td>
<td>  7000.000000</td>
<td> 3.000000</td>
</tr>
<tr>
<th>Monitor</th>
<td>   5000</td>
<td>  2</td>
<td>  5000.000000</td>
<td> 2.000000</td>
</tr>
<tr>
<th>All</th>
<th/>
<th/>
<td> 522000</td>
<td> 30</td>
<td> 30705.882353</td>
<td> 1.764706</td>
</tr>
</tbody>
</table>
</div><p>Let’s move the analysis up a level and look at our pipeline at the
manager level. Notice how the status is ordered based on our earlier
category definition.</p>
<div class="highlight"><pre><span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s">"Manager"</span><span class="p">,</span><span class="s">"Status"</span><span class="p">],</span><span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="s">"Price"</span><span class="p">],</span>
               <span class="n">aggfunc</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">],</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">margins</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
<div>
<table border="1" class="table table-condensed">
<thead>
<tr>
<th/>
<th/>
<th>sum</th>
</tr>
<tr>
<th/>
<th/>
<th>Price</th>
</tr>
<tr>
<th>Manager</th>
<th>Status</th>
<th/>
</tr>
</thead>
<tbody>
<tr>
<th rowspan="4" valign="top">Debra Henley</th>
<th>declined</th>
<td>  70000</td>
</tr>
<tr>
<th>pending</th>
<td>  50000</td>
</tr>
<tr>
<th>presented</th>
<td>  50000</td>
</tr>
<tr>
<th>won</th>
<td>  65000</td>
</tr>
<tr>
<th rowspan="4" valign="top">Fred Anderson</th>
<th>declined</th>
<td>  65000</td>
</tr>
<tr>
<th>pending</th>
<td>   5000</td>
</tr>
<tr>
<th>presented</th>
<td>  45000</td>
</tr>
<tr>
<th>won</th>
<td> 172000</td>
</tr>
<tr>
<th>All</th>
<th/>
<td> 522000</td>
</tr>
</tbody>
</table>
</div><p>A really handy feature is the ability to pass a dictionary to the
<code class="code">
aggfunc</code>
 so you can perform different functions on each of the values you
select. This has a side-effect of making the labels a little cleaner.</p>
<div class="highlight"><pre><span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s">"Manager"</span><span class="p">,</span><span class="s">"Status"</span><span class="p">],</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">"Product"</span><span class="p">],</span><span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="s">"Quantity"</span><span class="p">,</span><span class="s">"Price"</span><span class="p">],</span>
               <span class="n">aggfunc</span><span class="o">=</span><span class="p">{</span><span class="s">"Quantity"</span><span class="p">:</span><span class="nb">len</span><span class="p">,</span><span class="s">"Price"</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">},</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
<div>
<table border="1" class="table table-condensed">
<thead>
<tr>
<th/>
<th/>
<th colspan="4" halign="left">Price</th>
<th colspan="4" halign="left">Quantity</th>
</tr>
<tr>
<th/>
<th>Product</th>
<th><span class="caps">CPU</span></th>
<th>Maintenance</th>
<th>Monitor</th>
<th>Software</th>
<th><span class="caps">CPU</span></th>
<th>Maintenance</th>
<th>Monitor</th>
<th>Software</th>
</tr>
<tr>
<th>Manager</th>
<th>Status</th>
<th/>
<th/>
<th/>
<th/>
<th/>
<th/>
<th/>
<th/>
</tr>
</thead>
<tbody>
<tr>
<th rowspan="4" valign="top">Debra Henley</th>
<th>declined</th>
<td>  70000</td>
<td>     0</td>
<td>    0</td>
<td>     0</td>
<td> 2</td>
<td> 0</td>
<td> 0</td>
<td> 0</td>
</tr>
<tr>
<th>pending</th>
<td>  40000</td>
<td> 10000</td>
<td>    0</td>
<td>     0</td>
<td> 1</td>
<td> 2</td>
<td> 0</td>
<td> 0</td>
</tr>
<tr>
<th>presented</th>
<td>  30000</td>
<td>     0</td>
<td>    0</td>
<td> 20000</td>
<td> 1</td>
<td> 0</td>
<td> 0</td>
<td> 2</td>
</tr>
<tr>
<th>won</th>
<td>  65000</td>
<td>     0</td>
<td>    0</td>
<td>     0</td>
<td> 1</td>
<td> 0</td>
<td> 0</td>
<td> 0</td>
</tr>
<tr>
<th rowspan="4" valign="top">Fred Anderson</th>
<th>declined</th>
<td>  65000</td>
<td>     0</td>
<td>    0</td>
<td>     0</td>
<td> 1</td>
<td> 0</td>
<td> 0</td>
<td> 0</td>
</tr>
<tr>
<th>pending</th>
<td>      0</td>
<td>  5000</td>
<td>    0</td>
<td>     0</td>
<td> 0</td>
<td> 1</td>
<td> 0</td>
<td> 0</td>
</tr>
<tr>
<th>presented</th>
<td>  30000</td>
<td>     0</td>
<td> 5000</td>
<td> 10000</td>
<td> 1</td>
<td> 0</td>
<td> 1</td>
<td> 1</td>
</tr>
<tr>
<th>won</th>
<td> 165000</td>
<td>  7000</td>
<td>    0</td>
<td>     0</td>
<td> 2</td>
<td> 1</td>
<td> 0</td>
<td> 0</td>
</tr>
</tbody>
</table>
</div><p>You can provide a list of aggfunctions to apply to each value too:</p>
<div class="highlight"><pre><span class="n">table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s">"Manager"</span><span class="p">,</span><span class="s">"Status"</span><span class="p">],</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">"Product"</span><span class="p">],</span><span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="s">"Quantity"</span><span class="p">,</span><span class="s">"Price"</span><span class="p">],</span>
               <span class="n">aggfunc</span><span class="o">=</span><span class="p">{</span><span class="s">"Quantity"</span><span class="p">:</span><span class="nb">len</span><span class="p">,</span><span class="s">"Price"</span><span class="p">:[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">]},</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">table</span>
</pre></div>
<div>
<table border="1" class="table table-condensed">
<thead>
<tr>
<th/>
<th/>
<th colspan="8" halign="left">Price</th>
<th colspan="4" halign="left">Quantity</th>
</tr>
<tr>
<th/>
<th/>
<th colspan="4" halign="left">mean</th>
<th colspan="4" halign="left">sum</th>
<th colspan="4" halign="left">len</th>
</tr>
<tr>
<th/>
<th>Product</th>
<th><span class="caps">CPU</span></th>
<th>Maintenance</th>
<th>Monitor</th>
<th>Software</th>
<th><span class="caps">CPU</span></th>
<th>Maintenance</th>
<th>Monitor</th>
<th>Software</th>
<th><span class="caps">CPU</span></th>
<th>Maintenance</th>
<th>Monitor</th>
<th>Software</th>
</tr>
<tr>
<th>Manager</th>
<th>Status</th>
<th/>
<th/>
<th/>
<th/>
<th/>
<th/>
<th/>
<th/>
<th/>
<th/>
<th/>
<th/>
</tr>
</thead>
<tbody>
<tr>
<th rowspan="4" valign="top">Debra Henley</th>
<th>declined</th>
<td> 35000</td>
<td>    0</td>
<td>    0</td>
<td>     0</td>
<td>  70000</td>
<td>     0</td>
<td>    0</td>
<td>     0</td>
<td> 2</td>
<td> 0</td>
<td> 0</td>
<td> 0</td>
</tr>
<tr>
<th>pending</th>
<td> 40000</td>
<td> 5000</td>
<td>    0</td>
<td>     0</td>
<td>  40000</td>
<td> 10000</td>
<td>    0</td>
<td>     0</td>
<td> 1</td>
<td> 2</td>
<td> 0</td>
<td> 0</td>
</tr>
<tr>
<th>presented</th>
<td> 30000</td>
<td>    0</td>
<td>    0</td>
<td> 10000</td>
<td>  30000</td>
<td>     0</td>
<td>    0</td>
<td> 20000</td>
<td> 1</td>
<td> 0</td>
<td> 0</td>
<td> 2</td>
</tr>
<tr>
<th>won</th>
<td> 65000</td>
<td>    0</td>
<td>    0</td>
<td>     0</td>
<td>  65000</td>
<td>     0</td>
<td>    0</td>
<td>     0</td>
<td> 1</td>
<td> 0</td>
<td> 0</td>
<td> 0</td>
</tr>
<tr>
<th rowspan="4" valign="top">Fred Anderson</th>
<th>declined</th>
<td> 65000</td>
<td>    0</td>
<td>    0</td>
<td>     0</td>
<td>  65000</td>
<td>     0</td>
<td>    0</td>
<td>     0</td>
<td> 1</td>
<td> 0</td>
<td> 0</td>
<td> 0</td>
</tr>
<tr>
<th>pending</th>
<td>     0</td>
<td> 5000</td>
<td>    0</td>
<td>     0</td>
<td>      0</td>
<td>  5000</td>
<td>    0</td>
<td>     0</td>
<td> 0</td>
<td> 1</td>
<td> 0</td>
<td> 0</td>
</tr>
<tr>
<th>presented</th>
<td> 30000</td>
<td>    0</td>
<td> 5000</td>
<td> 10000</td>
<td>  30000</td>
<td>     0</td>
<td> 5000</td>
<td> 10000</td>
<td> 1</td>
<td> 0</td>
<td> 1</td>
<td> 1</td>
</tr>
<tr>
<th>won</th>
<td> 82500</td>
<td> 7000</td>
<td>    0</td>
<td>     0</td>
<td> 165000</td>
<td>  7000</td>
<td>    0</td>
<td>     0</td>
<td> 2</td>
<td> 1</td>
<td> 0</td>
<td> 0</td>
</tr>
</tbody>
</table>
</div><p>It can look daunting to try to pull this all together at one time but as
soon as you start playing with the data and slowly add the items, you
can get a feel for how it works. My general rule of thumb is that once
you use multiple <code class="code">
grouby</code>
 you should evaluate whether a pivot table
is a useful approach.</p>
</div>
</div></body></html>