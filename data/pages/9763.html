<html><body><div><div class="post-text" itemprop="text">

<p>This is sort of a follow-up question to <a href="http://stackoverflow.com/questions/34972570/scrapy-a-simple-way-to-get-around-a-tiny-javascript-function">one I asked earlier</a>. </p>

<p>I'm trying to scrape a webpage which I have to login to reach first. But after authentication, the webpage I need requires a little bit of Javascript to be run before you can view the content. What I've done is followed the instructions <a href="http://blog.scrapinghub.com/2015/03/02/handling-javascript-in-scrapy-with-splash/">here</a> to install splash to try to render the Javascript. However...</p>

<p>Before I switched to splash, the authentication with Scrapy's <code>InitSpider</code> was fine. I was getting through the login page and scraping the target page OK (except without the Javascript working, obviously). But once I add the code to pass the requests through splash, it looks like I'm not parsing the target page.</p>

<p>Spider below. The only difference between the splash version (here) and the non-splash version is the function <code>def start_requests()</code>. Everything else is the same between the two.</p>

<pre class="lang-py prettyprint-override"><code>import scrapy
from scrapy.spiders.init import InitSpider
from scrapy.spiders import Rule
from scrapy.linkextractors import LinkExtractor

class BboSpider(InitSpider):
    name = "bbo"
    allowed_domains = ["bridgebase.com"]
    start_urls = [
            "http://www.bridgebase.com/myhands/index.php"
            ]
    login_page = "http://www.bridgebase.com/myhands/myhands_login.php?t=%2Fmyhands%2Findex.php%3F" 

    # authentication
    def init_request(self):
        return scrapy.http.Request(url=self.login_page, callback=self.login)

    def login(self, response):
        return scrapy.http.FormRequest.from_response(
            response,
            formdata={'username': 'USERNAME', 'password': 'PASSWORD'},
            callback=self.check_login_response)

    def check_login_response(self, response):
        if "recent tournaments" in response.body:
            self.log("Login successful")
            return self.initialized()
        else:
            self.log("Login failed")
            print(response.body)

    # pipe the requests through splash so the JS renders 
    def start_requests(self):
        for url in self.start_urls:
            yield scrapy.Request(url, self.parse, meta={
                'splash': {
                    'endpoint': 'render.html',
                    'args': {'wait': 0.5}
                }
            }) 

    # what to do when a link is encountered
    rules = (
            Rule(LinkExtractor(), callback='parse_item'),
            )

    # do nothing on new link for now
    def parse_item(self, response):
        pass

    def parse(self, response):
        filename = 'test.html' 
        with open(filename, 'wb') as f:
            f.write(response.body)
</code></pre>

<p>What's happening now is that <code>test.html</code>, the result of <code>parse()</code>, is now simply the login page itself rather than the page I'm supposed to be redirected to after login.</p>

<p>This is telling in the log--ordinarily, I would see the "Login successful" line from <code>check_login_response()</code>, but as you can see below it seems like I'm not even getting to that step. Is this because scrapy is now putting the authentication requests through splash too, and that it's getting hung up there? If that's the case, is there any way to bypass splash only for the authentication part?</p>

<pre><code>2016-01-24 14:54:56 [scrapy] INFO: Spider opened
2016-01-24 14:54:56 [scrapy] INFO: Crawled 0 pages (at 0 pages/min), scraped 0 items (at 0 items/min)
2016-01-24 14:54:56 [scrapy] DEBUG: Telnet console listening on 127.0.0.1:6023
2016-01-24 14:55:02 [scrapy] DEBUG: Crawled (200) &lt;POST http://localhost:8050/render.html&gt; (referer: None)
2016-01-24 14:55:02 [scrapy] INFO: Closing spider (finished)
</code></pre>

<p>I'm pretty sure I'm not using splash correctly. Can anyone point me to some documentation where I can figure out what's going on?</p>
    </div>
    </div></body></html>