<html><body><div><div class="section-inner layoutSingleColumn"><h2 name="title" id="title" class="graf--h2 graf--first">My first experience creating an API</h2><h4 name="subtitle" id="subtitle" class="graf--h4 graf-after--h2">A weekend side project to build a Home Automation API</h4><figure name="d67c" id="d67c" class="graf--figure graf-after--h4"/><p name="242a" id="242a" class="graf--p graf-after--figure">Earlier this year I joined <a href="https://www.mashape.com/" data-href="https://www.mashape.com/" class="markup--anchor markup--p-anchor" rel="nofollow">Mashape</a>, an API platform and marketplace allowing you to distribute, monitor, and manage your APIs. While I was familiar with what an API was, I had never made one myself. I learnt programming when I was in college, and had some experience with Python at work (mainly scripting). Over the past couple of weekends, I took it as a personal challenge to learn how to create my own API, as well as experience some “real-world” coding. I worked on what I call the “Smarthome API”, an API for home automation that can control the devices in my house, such as the lights, fan, WeMo, door lock, and climate (via Nest).</p><blockquote name="2414" id="2414" class="graf--pullquote pullquote graf-after--p">In this post, I have documented my journey, the steps I have taken, the learning, and experiences along the way (mostly of my housemates who had to live in darkness while I was testing the app).</blockquote><h4 name="35ec" id="35ec" class="graf--h4 graf-after--pullquote">1. Defining the problem</h4><p name="c0c7" id="c0c7" class="graf--p graf-after--h4">My housemate recently installed several flavors of home automation hardware:</p><ol class="postList"><li name="c362" id="c362" class="graf--li graf-after--p">Z-wave switches and locks that enable home automation over a wireless network. We use <a href="http://getvera.com/" data-href="http://getvera.com/" class="markup--anchor markup--li-anchor" rel="nofollow"><strong class="markup--strong markup--li-strong">Vera</strong></a><strong class="markup--strong markup--li-strong">, </strong>a smart home gateway, to interact with the switches and devices.</li><li name="992f" id="992f" class="graf--li graf-after--li">A <a href="https://nest.com/" data-href="https://nest.com/" class="markup--anchor markup--li-anchor" rel="nofollow"><strong class="markup--strong markup--li-strong">Nest</strong></a><strong class="markup--strong markup--li-strong"> </strong>thermostat, of which we use the mobile app to adjust the temperatures and switch between “Home” and “Away” modes.</li><li name="4a4a" id="4a4a" class="graf--li graf-after--li"><a href="http://www.belkin.com/us/Products/home-automation/c/wemo-home-automation/" data-href="http://www.belkin.com/us/Products/home-automation/c/wemo-home-automation/" class="markup--anchor markup--li-anchor" rel="nofollow"><strong class="markup--strong markup--li-strong">Belkin WeMo</strong></a> appliances.</li></ol><p name="6341" id="6341" class="graf--p graf-after--li">All these products turned out great when we found ourselves too lazy to get out of bed to turn off the light switch, or check if the door is locked. However, it was rather cumbersome to manage different apps, or to manage every device individually.</p><figure name="2f2e" id="2f2e" class="graf--figure graf-after--p"><figcaption class="imageCaption">It also helped that the Vera web interface was not the most aesthetically pleasing.</figcaption></figure><p name="bb22" id="bb22" class="graf--p graf-after--figure">I wanted to have more flexibility and control over these devices. For a start, I scoped out these basic requirements for my API:</p><ul class="postList"><li name="5224" id="5224" class="graf--li graf-after--p">Be able to retrieve the list of all the switches/ devices (lights, locks, Nest) in the house — GET method</li><li name="27c1" id="27c1" class="graf--li graf-after--li">Be able to retrieve information on each individual switch/ device, e.g. Name, current state, etc — GET method</li><li name="ae08" id="ae08" class="graf--li graf-after--li">Be able to modify the state of each switch/ device, e.g. turn a light on or off — PUT method</li></ul><h4 name="de2a" id="de2a" class="graf--h4 graf-after--li"><strong class="markup--strong markup--h4-strong">2. Choosing a language and framework</strong></h4><p name="fa83" id="fa83" class="graf--p graf-after--h4">This was easy. Since I was most familiar with Python, I decided to go with <a href="http://flask.pocoo.org/" data-href="http://flask.pocoo.org/" class="markup--anchor markup--p-anchor" rel="nofollow">Flask</a> (a Python micro-framework), because it is lightweight. Of course, there were many other options, but I’ll not be going into details on the pros and cons of each.</p><p name="d4ec" id="d4ec" class="graf--p graf-after--p"><strong class="markup--strong markup--p-strong">PS. For the rest of this post, I’ll be referring to the switches/ devices as Lights. In reality, they control not just the lights, but also the fan, WeMo, etc. “Lock” refers to the door locks, while “Nest” refers to the climate control.</strong></p><h4 name="4f2a" id="4f2a" class="graf--h4 graf-after--p"><strong class="markup--strong markup--h4-strong">3. Building the scaffolding / creating the models</strong></h4><figure name="8a89" id="8a89" class="graf--figure graf-after--h4"><figcaption class="imageCaption">Once I had everything set up and managed to get my “Hello World” running, it was time to get my hands dirty.</figcaption></figure><p name="4469" id="4469" class="graf--p graf-after--figure">I created the model class for a Light object (on hindsight, I probably should have named it “DeviceSwitch” instead) with 4 properties:</p><ul class="postList"><li name="ef49" id="ef49" class="graf--li graf-after--p">id — device id as specified by Vera</li><li name="39ac" id="39ac" class="graf--li graf-after--li">name — name of the device/ switch to be controlled</li><li name="8982" id="8982" class="graf--li graf-after--li">room — name of the room which the device/ switch is located in</li><li name="7fb7" id="7fb7" class="graf--li graf-after--li">status — 0 for when the device/switch is off, 1 for when it is on</li></ul><p name="4bae" id="4bae" class="graf--p graf-after--li">Next, I created my first endpoint: GET /lights which was supposed to return a JSON with information of all the Lights. I fed it with some dummy data, and saw that my method was working correctly.</p><figure name="bace" id="bace" class="graf--figure graf-after--p"><figcaption class="imageCaption">Pretty much my reaction when I realized that the endpoint was working, albeit with dummy data.</figcaption></figure><figure name="2aed" id="2aed" class="graf--figure graf-after--figure"><figcaption class="imageCaption">Sample response for GET /lights/1 endpoint</figcaption></figure><p name="f8ed" id="f8ed" class="graf--p graf-after--figure">The second endpoint: GET /lights/&lt;id&gt; involved returning a JSON with properties of the requested light. Once again, the method was verified to work correctly with mock data.</p><p name="a2f1" id="a2f1" class="graf--p graf-after--p">Changing the state of the Light was slightly more complicated, as the PUT request would need to take in an &lt;application/json&gt; content type with the desired state. For this, I made use of the <a href="http://www.getpostman.com/" data-href="http://www.getpostman.com/" class="markup--anchor markup--p-anchor" rel="nofollow">Postman Chrome App</a> which was able to verify that my method was working correctly. Success!</p><figure name="e219" id="e219" class="graf--figure graf-after--p"/><blockquote name="f7a0" id="f7a0" class="graf--pullquote pullquote graf-after--figure">At this point, I pretty much went around the house and showed off my wonderful “working” API to my housemates, although it didn’t exactly do anything. They were not impressed ☹</blockquote><h4 name="128b" id="128b" class="graf--h4 graf-after--pullquote">4. Figuring out the Vera interface</h4><p name="0c3d" id="0c3d" class="graf--p graf-after--h4">The difficult part came when I had to figure out how to make requests to Vera to actually control the hardware. I opened the Vera control panel and used Chrome’s inspector to filter the data packets that were sent and received while turning lights on and off.</p><p name="3a19" id="3a19" class="graf--p graf-after--p">For a start, I figured out the request URL which Vera uses to retrieve all the devices.</p></div><div class="section-inner layoutSingleColumn"><p name="56d8" id="56d8" class="graf--p graf-after--figure">All that was required was the id of the device, the target state to change to, as well as a random number parameter.</p><pre name="d03f" id="d03f" class="graf--pre graf-after--p">p = {‘DeviceNum’: id, ‘newTargetValue’: <em class="markup--em markup--pre-em">&lt;the new state&gt;</em>, ‘rand’: random.random() }<br/>response = requests.get(“http://192.168.1.88/port_3480/data_request?id=lu_action&amp;output_format=json&amp;serviceId=urn:upnp-org:serviceId:SwitchPower1&amp;action=SetTarget", params = p)</pre><figure name="c90f" id="c90f" class="graf--figure graf-after--pre"/><p name="7257" id="7257" class="graf--p graf-after--figure">On hindsight, this was much easier to explain, but it took me some effort to learn and understand exactly what I was doing then.</p><h4 name="7b82" id="7b82" class="graf--h4 graf-after--p">5. Making it work</h4><p name="fd4c" id="fd4c" class="graf--p graf-after--h4">Since I had figured out how the HTTP requests worked, all that was left was making my API perform the desired action and return the correct response. (Yes, my API was still not really “working” after all the work ☹)</p><figure name="8179" id="8179" class="graf--figure graf-after--p"/><p name="12e0" id="12e0" class="graf--p graf-after--figure">To list the lights in my home, I inspected the JSON response from the HTTP request, retrieving the values of id, name, room, and state of the device. I parsed the variables into a newly created Light object. Iterating through the entire response, I was able to build a list of Light objects which were then returned by the GET /lights method as a JSON.</p><figure name="be4f" id="be4f" class="graf--figure graf-after--p"><figcaption class="imageCaption">Multiple loops and nested if-s which were not very pretty, but it got the job done.</figcaption></figure><p name="bf83" id="bf83" class="graf--p graf-after--figure">To switch the state of a light, I decided to have my API accept a PUT request with the id in the URL parameters and the requested state in the JSON body. Implementing this was a 2 step process:</p><ol class="postList"><li name="be41" id="be41" class="graf--li graf-after--p">Verifying the legitimacy of the JSON request</li><li name="2de7" id="2de7" class="graf--li graf-after--li">Performing the actual request to Vera and returning a legit response</li></ol><p name="da90" id="da90" class="graf--p graf-after--li">For a start, I only verified that the JSON request defined a proper state which could be used to control the Light device. If the state was specified, I’d send the request to switch the state. If there was no error, the method would return an OK response. Otherwise, it <em class="markup--em markup--p-em">should</em> return the error.</p><figure name="3644" id="3644" class="graf--figure graf-after--p"><figcaption class="imageCaption">Once again, very messy and ugly code, but it works, so we’ll leave the refactoring to later.</figcaption></figure><blockquote name="cebb" id="cebb" class="graf--pullquote pullquote graf-after--figure">Although my code was somewhat messy and ugly, it worked. And I made sure everyone in the house knew it by randomly switching on and off the lights in their room ;)</blockquote><figure name="2a77" id="2a77" class="graf--figure graf-after--pullquote"/><h4 name="0e07" id="0e07" class="graf--h4 graf-after--figure">6. Doing the same thing for other devices</h4><p name="385b" id="385b" class="graf--p graf-after--h4">Once the three methods worked for Lights, it was easy to replicate them for the Locks. Most of the code was pretty straightforward and looked pretty much the same, except for some minor URL changes in the Vera HTTP request. However, I did enforce that a password needed to be parsed in the JSON request when changing the status of the lock. (I definitely didn’t want random hackers being able to remotely lock and unlock my front door!)</p><h4 name="8a10" id="8a10" class="graf--h4 graf-after--p">7. Refactoring the code</h4><p name="cf31" id="cf31" class="graf--p graf-after--h4">Getting to this point was a proud moment for me. However, my code was messy and ugly, with inconsistent variable names, multiple nested loops and conditions, and a ton of duplicated code. One key issue was that my JSON response was returning the room id instead of the actual room name. I needed to retrieve the room names from the Vera API once again, and return them in my response.</p><figure name="316a" id="316a" class="graf--figure graf-after--p"><figcaption class="imageCaption">Sample response body of GET /lights endpoint returning room ID instead of room name</figcaption></figure><h4 name="5029" id="5029" class="graf--h4 graf-after--figure">8. Adding verification functions and increasing sleep time</h4><p name="5a66" id="5a66" class="graf--p graf-after--h4">At this point my API worked for switching individual devices on and off. I tried to create an endpoint that would turn all the lights off. However, I found that not all the lights were being turned off! Upon investigation, I realized that all my requests to the Vera API was succeeding and returning an OK response even though not all the lights were turning off in reality ☹</p><figure name="06fb" id="06fb" class="graf--figure graf-after--p"/><blockquote name="9df6" id="9df6" class="graf--pullquote pullquote graf-after--figure">While I grappled with the issue, my unfortunate housemates had to suffer in darkness, since I refused to switch on the lights for them until I fixed the bug.</blockquote><p name="3055" id="3055" class="graf--p graf-after--pullquote">To resolve the issue, I decided to add a verification function to ensure that the device state switch was successful. Otherwise, I would send the request again. I also added a sleep time just in case the updated device state was not reflected soon enough in the API response.</p><figure name="02c8" id="02c8" class="graf--figure graf-after--p"><figcaption class="imageCaption">Verification function to ensure that the device was switched to the target state</figcaption></figure><h4 name="21db" id="21db" class="graf--h4 graf-after--figure">9. Adding Nest and creating a Devices superclass</h4><p name="2331" id="2331" class="graf--p graf-after--h4">It was time for me to add the Nest device into the mix. For the sake of simplicity, I chose to control Nest through the Vera API, instead of the native API which was recently released. The Nest object that I created was pretty similar to the existing Light and Lock objects. Hence, I decided to create a Devices superclass, in which the Lights, Locks, and Nests would inherit from.</p><figure name="89ea" id="89ea" class="graf--figure graf--layoutInsetLeft graf-after--p"><figcaption class="imageCaption">The Vera API considers the Nest controller as two different devices.</figcaption></figure><p name="94ff" id="94ff" class="graf--p graf-after--figure">The Nest device was slightly more complicated, as the Vera API accounted for each Nest controller with a different id — one id for the Nest device controlling the temperature range, and another to switch between the states. I chose to expose only the id of the main Nest object controlling the temperature, and stored the other controller id as a variable within the main object class.</p><p name="6abf" id="6abf" class="graf--p graf-after--p">Upon creation of the Devices super class, I moved the update &amp; verify state functions (functions controlling the PUT endpoints) into the class definition. This way, I had cleaner and prettier code with less repetition.</p><h4 name="8a98" id="8a98" class="graf--h4 graf-after--p">10. In comes Redis, Custom JSON Encoder, and Device Decoder</h4><p name="26a5" id="26a5" class="graf--p graf-after--h4">I had created endpoints to turn all the lights on and all the lights off (which I called the home and away modes). I added in the “features” to lock doors and turn the A/C down to the away mode (and a corresponding set of states for the home mode).</p><p name="7206" id="7206" class="graf--p graf-after--p">But manually hard coding the “Home” and “Away” modes for all the devices was not very efficient. I wanted to provide a more extensible solution for creating custom modes, where the API users would be able to store and reset the house to previous modes.</p><p name="111d" id="111d" class="graf--p graf-after--p">To do this, I needed to store the current states of all the devices (Lights, Locks, Nests), and be able to retrieve them when necessary. I needed some form of persistent storage… and this was when Redis came into the picture.</p><p name="bb99" id="bb99" class="graf--p graf-after--p">To store a mode, I created a new PUT method for /states/&lt;name of slot&gt; which stored the state of all the devices in Redis. To do that, I wrote a custom JSON Encoder which included a special “_type” variable in each representation of object to determine if it was a Light, Lock or Nest object. This was necessary as I needed to recreate the object based on its type during decoding.</p><figure name="8536" id="8536" class="graf--figure graf-after--p"><figcaption class="imageCaption">Custom JSON Encoder which added a “_type” variable and custom Device Decoder which recreated the objects based on their “_type” variable</figcaption></figure><p name="3f0f" id="3f0f" class="graf--p graf-after--figure">Once I was able to deserialize the JSON that was stored in Redis, creating the PUT method for loading a saved state was as simple as iterating through the states, and calling the respective class function to switch the state of each device. All these was done with lots of code refactoring, of course ;)</p><h3 name="805c" id="805c" class="graf--h3 graf-after--p">Future plans?</h3><p name="99eb" id="99eb" class="graf--p graf-after--h3">So there, over a couple of weekends, I managed to create my first API to make my house a smarter home. There are definitely areas of improvements, for example:</p><ul class="postList"><li name="66c1" id="66c1" class="graf--li graf-after--p">Using ORM for creating models instead of writing custom models</li><li name="dc57" id="dc57" class="graf--li graf-after--li">Some kind of parallelism to set the state of the devices, locks, and Nest all at the same time instead of sequentially. This will greatly speed up the response of the API.</li><li name="85f9" id="85f9" class="graf--li graf-after--li">Verify the state of all devices at once instead of verifying them individually as their states switch. This will also reduce the number of requests being sent to Vera.</li><li name="f427" id="f427" class="graf--li graf-after--li">Ability to roll back to the original state if there is an error in switching the state of the device — This will involve saving the original state before a change is made, and then rolling it back if an error occurs.</li></ul><p name="25dc" id="25dc" class="graf--p graf-after--li">While some of these changes can be made pretty quickly, I’m calling this done for now as I work on my next project.</p><figure name="8526" id="8526" class="graf--figure graf-after--p"/><h3 name="e0e8" id="e0e8" class="graf--h3 graf-after--figure">What’s happening to the API?</h3><figure name="2113" id="2113" class="graf--figure graf--layoutInsetLeft graf-after--h3"/><p name="c0e9" id="c0e9" class="graf--p graf-after--figure">This project doesn’t end here! Now that I've got the API ready, my housemate, <a href="https://medium.com/@benedictchan" data-href="https://medium.com/@benedictchan" class="markup--anchor markup--p-anchor">Ben</a>, is in charge of the front-end work of creating an Android app using my API.</p><p name="4775" id="4775" class="graf--p graf-after--p">For now, this is what the app looks like — it is very basic and lacking in design, but does exactly what we need from one place, and it’s still a work in progress.</p><blockquote name="fcd0" id="fcd0" class="graf--pullquote pullquote graf-after--p">I also heard that he had hacked up a bitcoin integration where sending money to him would result in the door opening ;)</blockquote><p name="138a" id="138a" class="graf--p graf-after--pullquote">I hope to update this with more screenshots once the app is completed! ☺</p><p name="ea8d" id="ea8d" class="graf--p graf-after--p">Update (2/15/2015): Omg! Someone <a href="https://github.com/christinang89/smarthome/pull/1" data-href="https://github.com/christinang89/smarthome/pull/1" class="markup--anchor markup--p-anchor" rel="nofollow">made a pull request</a> to my repo and cleaned up the mess! ☺</p><figure name="2108" id="2108" class="graf--figure graf--layoutInsetLeft graf-after--p"/><p name="6fcf" id="6fcf" class="graf--p graf-after--figure">Update (4/15/2015): About 6 months ago, I bought an iPhone after being an avid Android user for the past 6 years (yes, I owned the G1!). The first thing I missed in iOS was, of course, my wonderful smarthome app. I decided to take the chance to learn some iOS programming by porting the app over to iOS, and here’s what the app looks like. <a href="https://github.com/christinang89/Unicorn" data-href="https://github.com/christinang89/Unicorn" class="markup--anchor markup--p-anchor" rel="nofollow">The code isn’t the prettiest</a>, but hey, it works! ;)</p><h3 name="f024" id="f024" class="graf--h3 graf-after--p">Acknowledgments</h3><p name="a548" id="a548" class="graf--p graf-after--h3">All this would not have been possible without the patient guidance of <a href="http://www.linkedin.com/in/bencxr" data-href="http://www.linkedin.com/in/bencxr" class="markup--anchor markup--p-anchor" rel="nofollow">Ben</a> who taught me everything I needed to know to get this far. The github repo for the API is here: <a href="https://github.com/christinang89/smarthome" data-href="https://github.com/christinang89/smarthome" class="markup--anchor markup--p-anchor" rel="nofollow">https://github.com/christinang89/smarthome</a>, although it currently only works for my house. The repo for the Android app is available at <a href="https://github.com/bencxr/kotl" data-href="https://github.com/bencxr/kotl" class="markup--anchor markup--p-anchor" rel="nofollow">https://github.com/bencxr/kotl</a>, and for the iOS app: <a href="https://github.com/christinang89/Unicorn" data-href="https://github.com/christinang89/Unicorn" class="markup--anchor markup--p-anchor" rel="nofollow">https://github.com/christinang89/Unicorn</a></p><p name="8623" id="8623" class="graf--p graf-after--p">This has been fun side project. While I set out expecting to learn about creating APIs, I ended up taking away a lot more. I learnt how to sniff data packets. I learnt how to write actual code outside of a programming assignment context. I learnt about Redis/ persistent storage, and custom serializers and deserializers. I learnt many design patterns in developing a web application, some coding best practices, <a href="http://legacy.python.org/dev/peps/pep-0008/" data-href="http://legacy.python.org/dev/peps/pep-0008/" class="markup--anchor markup--p-anchor" rel="nofollow">PEP 8</a> (Sorry, I know my code isn’t exactly conforming to it), and how to solve a large problem in simple, manageable pieces.</p><blockquote name="cb38" id="cb38" class="graf--pullquote pullquote graf-after--p">So I would say, if you’re learning how to code, learn how to make an API! ☺</blockquote><figure name="1880" id="1880" class="graf--figure graf-after--pullquote graf--last"/></div></div></body></html>