<html><body><div><div class="main">
	<p>
At the beginning of this year I moved from Neo4j’s field team to dev team and since the code we write there is much lower level than I’m used to I thought I should find some people to follow on twitter whom I can learn from.
</p>
<p>
My technique for finding some of those people was to pick a person from the Neo4j kernel team who’s very good at systems programming and uses twitter which led me to Mr <a href="https://twitter.com/chvest">Chris Vest</a>.
</p>
<p>
I thought that the people Chris interacts with on twitter are likely to be interested in this type of programming so I manually traversed out to those people and had a look who they interacted with and put them all into a <a href="https://twitter.com/markhneedham/lists/comp-science-peoples">list</a>.
</p>
<p>
This approach has worked well and I’ve picked up lots of reading material from following these people. It does feel like something that could be automated though and we’ll using Python and Neo4j as our tool kit.
</p>
<p>
We need to find a library to connect to the Twitter API. There are a few to choose from but <a href="https://github.com/tweepy/tweepy">tweepy</a> seems simple enough so I started using that.
</p>
<p>The first thing we need to so is fill in our <a href="http://docs.tweepy.org/en/latest/getting_started.html#hello-tweepy">Twitter API auth details</a>. Since the application is just for me I’m not going to bother with setting up OAuth – instead I’ll just create an application on <a href="https://apps.twitter.com/">apps.twitter.com</a> and grab the appropriate tokens:
</p>

<p>Once we’ve done that we can navigate to that app and get a consumer key, consumer secret, access token and access token secret. They all reside on the ‘Keys and Access Tokens’ tab:
</p>


<p>
Now that we’ve got ourself all auth’d up let’s write some code that starts from Chris and goes out and finds his latest tweets and the people he’s interacted with in them. We’ll write the appropriate information out to a CSV file so that we can import it into Neo4j later on:
</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python"><span>import</span> tweepy
<span>import</span> <span>csv</span>
<span>from</span> <span>collections</span> <span>import</span> Counter<span>,</span> deque
 
auth <span>=</span> tweepy.<span>OAuthHandler</span><span>(</span>consumer_key<span>,</span> consumer_secret<span>)</span>
auth.<span>set_access_token</span><span>(</span>access_token<span>,</span> access_token_secret<span>)</span>
 
api <span>=</span> tweepy.<span>API</span><span>(</span>auth<span>,</span> wait_on_rate_limit <span>=</span> <span>True</span><span>,</span> wait_on_rate_limit_notify <span>=</span> <span>True</span><span>)</span>
 
counter <span>=</span> Counter<span>(</span><span>)</span>
users_to_process <span>=</span> deque<span>(</span><span>)</span>
USERS_TO_PROCESS <span>=</span> <span>50</span>
 
<span>def</span> extract_tweet<span>(</span>tweet<span>)</span>:
    user_mentions <span>=</span> <span>","</span>.<span>join</span><span>(</span><span>[</span><span>user</span><span>[</span><span>"screen_name"</span><span>]</span>.<span>encode</span><span>(</span><span>"utf-8"</span><span>)</span>
                             <span>for</span> <span>user</span> <span>in</span> tweet.<span>entities</span><span>[</span><span>"user_mentions"</span><span>]</span><span>]</span><span>)</span>
    urls <span>=</span> <span>","</span>.<span>join</span><span>(</span><span>[</span>url<span>[</span><span>"expanded_url"</span><span>]</span>
                     <span>for</span> url <span>in</span> tweet.<span>entities</span><span>[</span><span>"urls"</span><span>]</span><span>]</span><span>)</span>
    <span>return</span> <span>[</span>tweet.<span>user</span>.<span>screen_name</span>.<span>encode</span><span>(</span><span>"utf-8"</span><span>)</span><span>,</span>
            tweet.<span>id</span><span>,</span>
            tweet.<span>text</span>.<span>encode</span><span>(</span><span>"utf-8"</span><span>)</span><span>,</span>
            user_mentions<span>,</span>
            urls<span>]</span>
 
starting_user <span>=</span> <span>"chvest"</span>
<span>with</span> <span>open</span><span>(</span><span>"tweets.csv"</span><span>,</span> <span>"a"</span><span>)</span> <span>as</span> tweets:
    writer <span>=</span> <span>csv</span>.<span>writer</span><span>(</span>tweets<span>,</span> delimiter<span>=</span><span>","</span><span>,</span> escapechar<span>=</span><span>"<span>\\</span>"</span><span>,</span> doublequote <span>=</span> <span>False</span><span>)</span>
    <span>for</span> tweet <span>in</span> tweepy.<span>Cursor</span><span>(</span>api.<span>user_timeline</span><span>,</span> <span>id</span><span>=</span>starting_user<span>)</span>.<span>items</span><span>(</span><span>50</span><span>)</span>:
        writer.<span>writerow</span><span>(</span>extract_tweet<span>(</span>tweet<span>)</span><span>)</span>
        tweets.<span>flush</span><span>(</span><span>)</span>
        <span>for</span> <span>user</span> <span>in</span> tweet.<span>entities</span><span>[</span><span>"user_mentions"</span><span>]</span>:
            <span>if</span> <span>not</span> <span>len</span><span>(</span>users_to_process<span>)</span> <span>&gt;</span> USERS_TO_PROCESS:
                users_to_process.<span>append</span><span>(</span><span>user</span><span>[</span><span>"screen_name"</span><span>]</span><span>)</span>
                counter<span>[</span><span>user</span><span>[</span><span>"screen_name"</span><span>]</span><span>]</span> +<span>=</span> <span>1</span>
            <span>else</span>:
                <span>break</span></pre></td></tr></table></div>

<p>As well as printing out Chris’ tweets I’m also capturing other users who he’s had interacted and putting them in a queue that we’ll drain later on. We’re limiting the number of other users that we’ll process to 50 for now but it’s easy to change.
</p>
<p>
If we print out the first few lines of ‘tweets.csv’ this is what we’d see:
</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash">$ <span>head</span> <span>-n</span> <span>5</span> tweets.csv
userName,tweetId,contents,usersMentioned,urls
chvest,<span>575427045167071233</span>,<span>@</span>shipilev http:<span>//</span>t.co<span>/</span>WxqFIsfiSF,shipilev,
chvest,<span>575403105174552576</span>,<span>@</span>AlTobey I often use http:<span>//</span>t.co<span>/</span>G7Cdn9Udst <span>for</span> small one-off graph diagrams.,AlTobey,http:<span>//</span>www.apcjones.com<span>/</span>arrows<span>/</span>
chvest,<span>575337346687766528</span>,RT <span>@</span>theburningmonk: this is why you need composition over inheritance... :s <span>#CompositionOverInheritance http://t.co/aKRwUaZ0qo,theburningmonk,</span>
chvest,<span>575269402083459072</span>,<span>@</span>chvest except…? “Each library implementation should therefore be identical with respect to the public API”,chvest,</pre></td></tr></table></div>

<p>We’re capturing the user, tweetId, the tweet itself, any users mentioned in the tweet and any URLs shared in the tweet.</p>
<p>Next we want to get some of the tweets of the people Chris has interacted with</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python"><span># Grab the code from here too - https://gist.github.com/mneedham/3188c44b2cceb88c6de0</span>
 
<span>import</span> tweepy
<span>import</span> <span>csv</span>
<span>from</span> <span>collections</span> <span>import</span> Counter<span>,</span> deque
 
auth <span>=</span> tweepy.<span>OAuthHandler</span><span>(</span>consumer_key<span>,</span> consumer_secret<span>)</span>
auth.<span>set_access_token</span><span>(</span>access_token<span>,</span> access_token_secret<span>)</span>
 
api <span>=</span> tweepy.<span>API</span><span>(</span>auth<span>,</span> wait_on_rate_limit <span>=</span> <span>True</span><span>,</span> wait_on_rate_limit_notify <span>=</span> <span>True</span><span>)</span>
 
counter <span>=</span> Counter<span>(</span><span>)</span>
users_to_process <span>=</span> deque<span>(</span><span>)</span>
USERS_TO_PROCESS <span>=</span> <span>50</span>
 
<span>def</span> extract_tweet<span>(</span>tweet<span>)</span>:
    user_mentions <span>=</span> <span>","</span>.<span>join</span><span>(</span><span>[</span><span>user</span><span>[</span><span>"screen_name"</span><span>]</span>.<span>encode</span><span>(</span><span>"utf-8"</span><span>)</span>
                             <span>for</span> <span>user</span> <span>in</span> tweet.<span>entities</span><span>[</span><span>"user_mentions"</span><span>]</span><span>]</span><span>)</span>
    urls <span>=</span> <span>","</span>.<span>join</span><span>(</span><span>[</span>url<span>[</span><span>"expanded_url"</span><span>]</span>
                     <span>for</span> url <span>in</span> tweet.<span>entities</span><span>[</span><span>"urls"</span><span>]</span><span>]</span><span>)</span>
    <span>return</span> <span>[</span>tweet.<span>user</span>.<span>screen_name</span>.<span>encode</span><span>(</span><span>"utf-8"</span><span>)</span><span>,</span>
            tweet.<span>id</span><span>,</span>
            tweet.<span>text</span>.<span>encode</span><span>(</span><span>"utf-8"</span><span>)</span><span>,</span>
            user_mentions<span>,</span>
            urls<span>]</span>
 
starting_user <span>=</span> <span>"chvest"</span>
<span>with</span> <span>open</span><span>(</span><span>"tweets.csv"</span><span>,</span> <span>"a"</span><span>)</span> <span>as</span> tweets:
    writer <span>=</span> <span>csv</span>.<span>writer</span><span>(</span>tweets<span>,</span> delimiter<span>=</span><span>","</span><span>,</span> escapechar<span>=</span><span>"<span>\\</span>"</span><span>,</span> doublequote <span>=</span> <span>False</span><span>)</span>
    <span>for</span> tweet <span>in</span> tweepy.<span>Cursor</span><span>(</span>api.<span>user_timeline</span><span>,</span> <span>id</span><span>=</span>starting_user<span>)</span>.<span>items</span><span>(</span><span>50</span><span>)</span>:
        writer.<span>writerow</span><span>(</span>extract_tweet<span>(</span>tweet<span>)</span><span>)</span>
        tweets.<span>flush</span><span>(</span><span>)</span>
        <span>for</span> <span>user</span> <span>in</span> tweet.<span>entities</span><span>[</span><span>"user_mentions"</span><span>]</span>:
            <span>if</span> <span>not</span> <span>len</span><span>(</span>users_to_process<span>)</span> <span>&gt;</span> USERS_TO_PROCESS:
                users_to_process.<span>append</span><span>(</span><span>user</span><span>[</span><span>"screen_name"</span><span>]</span><span>)</span>
                counter<span>[</span><span>user</span><span>[</span><span>"screen_name"</span><span>]</span><span>]</span> +<span>=</span> <span>1</span>
            <span>else</span>:
                <span>break</span>
    users_processed <span>=</span> <span>set</span><span>(</span><span>[</span>starting_user<span>]</span><span>)</span>
    <span>while</span> <span>True</span>:
        <span>if</span> <span>len</span><span>(</span>users_processed<span>)</span> <span>&gt;=</span> USERS_TO_PROCESS:
            <span>break</span>
        <span>else</span>:
            <span>if</span> <span>len</span><span>(</span>users_to_process<span>)</span> <span>&gt;</span> <span>0</span>:
                next_user <span>=</span> users_to_process.<span>popleft</span><span>(</span><span>)</span>
                <span>print</span> next_user
                <span>if</span> next_user <span>in</span> users_processed:
                    <span>"-- user already processed"</span>
                <span>else</span>:
                    <span>"-- processing user"</span>
                    users_processed.<span>add</span><span>(</span>next_user<span>)</span>
                    <span>for</span> tweet <span>in</span> tweepy.<span>Cursor</span><span>(</span>api.<span>user_timeline</span><span>,</span> <span>id</span><span>=</span>next_user<span>)</span>.<span>items</span><span>(</span><span>10</span><span>)</span>:
                        writer.<span>writerow</span><span>(</span>extract_tweet<span>(</span>tweet<span>)</span><span>)</span>
                        tweets.<span>flush</span><span>(</span><span>)</span>
                        <span>for</span> user_mentioned <span>in</span> tweet.<span>entities</span><span>[</span><span>"user_mentions"</span><span>]</span>:
                            <span>if</span> <span>not</span> <span>len</span><span>(</span>users_processed<span>)</span> <span>&gt;</span> <span>50</span>:
                                users_to_process.<span>append</span><span>(</span>user_mentioned<span>[</span><span>"screen_name"</span><span>]</span><span>)</span>
                                counter<span>[</span>user_mentioned<span>[</span><span>"screen_name"</span><span>]</span><span>]</span> +<span>=</span> <span>1</span>
                            <span>else</span>:
                                <span>break</span>
            <span>else</span>:
                <span>break</span></pre></td></tr></table></div>

<p>Finally let’s take a quick look at the users who show up most frequently:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python"><span>&gt;&gt;&gt;</span> <span>for</span> user_name<span>,</span> count <span>in</span> counter.<span>most_common</span><span>(</span><span>20</span><span>)</span>:
        <span>print</span> user_name<span>,</span> count
 
neo4j <span>13</span>
devnexus <span>12</span>
AlTobey <span>11</span>
bitprophet <span>11</span>
hazelcast <span>10</span>
chvest <span>9</span>
shipilev <span>9</span>
AntoineGrondin <span>8</span>
gvsmirnov <span>8</span>
GatlingTool <span>8</span>
lagergren <span>7</span>
tomsontom <span>6</span>
dorkitude <span>5</span>
noctarius2k <span>5</span>
DanHeidinga <span>5</span>
chris_mahan <span>5</span>
coda <span>4</span>
mccv <span>4</span>
gAmUssA <span>4</span>
jmhodges <span>4</span></pre></td></tr></table></div>

<p>
A few of the people on that list are in my list which is a good start. We can explore the data set better once it’s in Neo4j though so let’s write some Cypher import statements to create our own mini Twitter graph:
</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="cypher">// add people
LOAD CSV WITH HEADERS FROM "file:///Users/markneedham/projects/neo4j-twitter/tweets.csv" AS row
MERGE (p:Person {userName: row.userName});
 
LOAD CSV WITH HEADERS FROM "file:///Users/markneedham/projects/neo4j-twitter/tweets.csv" AS row
WITH SPLIT(row.usersMentioned, ",") AS users
UNWIND users AS user
MERGE (p:Person {userName: user});
 
// add tweets
LOAD CSV WITH HEADERS FROM "file:///Users/markneedham/projects/neo4j-twitter/tweets.csv" AS row
MERGE (t:Tweet {id: row.tweetId})
ON CREATE SET t.contents = row.contents;
 
// add urls
LOAD CSV WITH HEADERS FROM "file:///Users/markneedham/projects/neo4j-twitter/tweets.csv" AS row
WITH SPLIT(row.urls, ",") AS urls
UNWIND urls AS url
MERGE (:URL {value: url});
 
// add links
LOAD CSV WITH HEADERS FROM "file:///Users/markneedham/projects/neo4j-twitter/tweets.csv" AS row
MATCH (p:Person {userName: row.userName})
MATCH (t:Tweet {id: row.tweetId})
MERGE (p)-[:TWEETED]-&gt;(t);
 
LOAD CSV WITH HEADERS FROM "file:///Users/markneedham/projects/neo4j-twitter/tweets.csv" AS row
WITH SPLIT(row.usersMentioned, ",") AS users, row
UNWIND users AS user
MATCH (p:Person {userName: user})
MATCH (t:Tweet {id: row.tweetId})
MERGE (p)-[:MENTIONED_IN]-&gt;(t);
 
LOAD CSV WITH HEADERS FROM "file:///Users/markneedham/projects/neo4j-twitter/tweets.csv" AS row
WITH SPLIT(row.urls, ",") AS urls, row
UNWIND urls AS url
MATCH (u:URL {value: url})
MATCH (t:Tweet {id: row.tweetId})
MERGE (t)-[:CONTAINS_LINK]-&gt;(u);</pre></td></tr></table></div>

<p>
We can put all those commands in a file and execute them using neo4j-shell:
</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash"><span>$ </span>.<span>/</span>neo4j-community-2.2.0-RC01<span>/</span>bin<span>/</span>neo4j-shell <span>--file</span> import.cql</pre></td></tr></table></div>

<p>
Now let’s write some queries against the graph:
</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="cypher">// Find the tweets where Chris mentioned himself
MATCH path = (n:Person {userName: "chvest"})-[:TWEETED]-&gt;()&lt;-[:MENTIONED_IN]-(n)
RETURN path</pre></td></tr></table></div>

<div>
<p><img src="http://www.markhneedham.com/blog/wp-content/uploads/2015/03/graph-5.png" alt="Graph  5" title="graph (5).png" border="0"/></p></div>

<div class="wp_syntax"><table><tr><td class="code"><pre class="cypher">// Find the most popular links shared in the network
MATCH (u:URL)&lt;-[r:CONTAINS_LINK]-&gt;()
RETURN u.value, COUNT(*) AS times
ORDER BY times DESC
LIMIT 10
 
+-------------------------------------------------------------------------------------------------+
| u.value                                                                                 | times |
+-------------------------------------------------------------------------------------------------+
| "http://www.polyglots.dk/"                                                              | 4     |
| "http://www.java-forum-nord.de/"                                                        | 4     |
| "http://hirt.se/blog/?p=646"                                                            | 3     |
| "http://wp.me/p26jdv-Ja"                                                                | 3     |
| "https://instagram.com/p/0D4I_hH77t/"                                                   | 3     |
| "https://blogs.oracle.com/java/entry/new_java_champion_tom_chindl"                      | 3     |
| "http://www.kennybastani.com/2015/03/spark-neo4j-tutorial-docker.html"                  | 2     |
| "https://firstlook.org/theintercept/2015/03/10/ispy-cia-campaign-steal-apples-secrets/" | 2     |
| "http://buff.ly/1GzZXlo"                                                                | 2     |
| "http://buff.ly/1BrgtQd"                                                                | 2     |
+-------------------------------------------------------------------------------------------------+
10 rows</pre></td></tr></table></div>

<p>
The first link is for a programming language meetup in Copenhagen, the second for a Java conference in Hanovier and the third an announcement about the latest version of Java Mission Control. So far so good!
</p>
<p>
A next step in this area would be to run the links through Prismatic’s <a href="https://github.com/Prismatic/interest-graph">interest graph</a> so we can model topics in our graph as well. For now let’s have a look at the interactions between Chris and others in the graph:
</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="cypher">// Find the people who Chris interacts with most often
MATCH path = (n:Person {userName: "chvest"})-[:TWEETED]-&gt;()&lt;-[:MENTIONED_IN]-(other)
RETURN other.userName, COUNT(*) AS times
ORDER BY times DESC
LIMIT 5
 
+------------------------+
| other.userName | times |
+------------------------+
| "gvsmirnov"    | 7     |
| "shipilev"     | 5     |
| "nitsanw"      | 4     |
| "DanHeidinga"  | 3     |
| "AlTobey"      | 3     |
+------------------------+
5 rows</pre></td></tr></table></div>

<p>
Let’s generalise that to find interactions between any pair of people:
</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="cypher">// Find the people who interact most often
MATCH (n:Person)-[:TWEETED]-&gt;()&lt;-[:MENTIONED_IN]-(other)
WHERE n &lt;&gt; other
RETURN n.userName, other.userName, COUNT(*) AS times
ORDER BY times DESC
LIMIT 5
 
+------------------------------------------+
| n.userName    | other.userName   | times |
+------------------------------------------+
| "fbogsany"    | "AntoineGrondin" | 8     |
| "chvest"      | "gvsmirnov"      | 7     |
| "chris_mahan" | "bitprophet"     | 6     |
| "maxdemarzi"  | "neo4j"          | 6     |
| "chvest"      | "shipilev"       | 5     |
+------------------------------------------+
5 rows</pre></td></tr></table></div>

<p>Let’s combine a couple of these together to come up with a score for each person:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="cypher">MATCH (n:Person)
 
// number of mentions
OPTIONAL MATCH (n)-[mention:MENTIONED_IN]-&gt;()
WITH n, COUNT(mention) AS mentions
 
// number of links shared by someone else
OPTIONAL MATCH (n)-[:TWEETED]-&gt;()-[:CONTAINS_LINK]-&gt;(link)&lt;-[:CONTAINS_LINK]-()
 
WITH n, mentions, COUNT(link) AS links
RETURN n.userName, mentions + links AS score, mentions, links
ORDER BY score DESC
LIMIT 10
 
+------------------------------------------+
| n.userName    | score | mentions | links |
+------------------------------------------+
| "chvest"      | 17    | 10       | 7     |
| "hazelcast"   | 16    | 10       | 6     |
| "neo4j"       | 15    | 13       | 2     |
| "noctarius2k" | 14    | 4        | 10    |
| "devnexus"    | 12    | 12       | 0     |
| "polyglotsdk" | 11    | 2        | 9     |
| "shipilev"    | 11    | 10       | 1     |
| "AlTobey"     | 11    | 10       | 1     |
| "bitprophet"  | 10    | 9        | 1     |
| "GatlingTool" | 10    | 8        | 2     |
+------------------------------------------+
10 rows</pre></td></tr></table></div>

<p>
Amusingly Chris is top of his own network but we also see three accounts which aren’t people, but rather products – neo4j, hazelcast and GatlingTool. The rest are legit though
</p>
<p>
That’s as far as I’ve got but to make this more useful I think we need to introduce follower/friend links as well as importing more data.
</p>
<p>
In the mean time I’ve got a bunch of links to go and read!</p>
</div>

</div></body></html>