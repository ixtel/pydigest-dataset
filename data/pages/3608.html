<html><body><div><p class="ad">
                            
                            
                            <ins class="adsbygoogle" data-ad-client="ca-pub-7993642564731324" data-ad-slot="6172324376"/>
                            
                        </p><div id="contents"><p>This article was originaly published in <a href="http://www.linuxvoice.com/download-linux-voice-issue-1-with-audio/">Linux Voice, issue 1, April 2014</a>. This issue is now available under a <a href="https://creativecommons.org/licenses/by-sa/3.0/">Creative Commons BY-SA license</a>. In a nutshell: you can modify and share all content from the magazine (apart from adverts), even for commercial purposes, providing you credit Linux Voice as the original source, and retain the same license.</p>

<p>This remix is converted manually to Markdown and HTML for ease of archiving and copy-pasting. </p>

<p>If you like this, please subscribe to Linux Voice. It is an awesome magazine with an awesome team of people. <a href="http://shop.linuxvoice.com/">Click here to subscribe</a> from just GBP 38 and get future issues straight to your door or inbox! (DRM Free PDF's and more available).</p>

<p>If you like this website and want to support it AND get $10 Digital Ocean credit (2 months free), use this link to order: <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">https://www.digitalocean.com/?refcode=7435ae6b8212</a> (referral link).</p>

<p>Other converted Linux Voice articles <a href="https://raymii.org/s/tags/linux-voice.html">can be found here</a>. </p>

<hr/>

<p>Keep your websites up to date by harnessing live data piped from Python's web services.</p>

<h3>Why do this?</h3>

<ul>
<li>Keep your websites up to date with the latest information</li>
<li>Pull data from across the web and feed it into your programs</li>
<li>Discover the powerful combination of Python and Tornado</li>
</ul>

<h3>Python: build dynamic web pages</h3>

<p>HTML is one of the greatest developments in computing. It's so simple, anyone with a text editor can knock up a simple web page with text, pictures, and links to other sites. This simplicity gives the web the potential to grow to encompass almost the whole of humanity. </p>

<p>However, its original developers intended it for content that doesn't change very often. Every change to a page of HTML needs the file to be modified and resaved, which is fine for some purposes; but sometimes you need something a little more dynamic. </p>

<p>In this tutorial we're going to look at four different methods for including constantly changing content in your website. Since we've got a lovely new magazine, we're going to create a lovely new website to help us keep track of everything that's going on. </p>

<p>The skeleton code for this website is: </p>

<pre><code>&lt;html&gt; 
  &lt;head&gt; 
    &lt;title&gt;All About Linux Voice&lt;/title&gt; 
  &lt;/head&gt; 
  &lt;body&gt; 
    &lt;h1&gt;All About Linux Voice&lt;/h1&gt; 
    &lt;table&gt;
      &lt;tr&gt;
        &lt;td&gt;Data1&lt;/td&gt; 
        &lt;td&gt;Data2&lt;/td&gt; 
      &lt;/tr&gt; 
      &lt;tr&gt; 
        &lt;td&gt;Data3&lt;/td&gt; 
        &lt;td&gt;Data4&lt;/td&gt; 
      &lt;/tr&gt; 
    &lt;/table&gt; 
</code></pre>

<p>If you haven't come across HTML before, everything is kept between pairs of angular bracketed tags that describe what the content is. For example, <code>&lt;h1&gt;</code> marks the start of heading 1 (the biggest heading), and <code>&lt;/h1&gt;</code> tells the browser that we've finished the heading. </p>

<p>The <code>&lt;table&gt;&lt;/table&gt;</code> tags describe a table, <code>&lt;tr&gt;&lt;/tr&gt;</code> describe a table row, and <code>&lt;td&gt;&lt;/td&gt;</code> describe a table cell. </p>

<p>The skeleton code can be found on the coverdisc or at <a href="http://linuxvoice.com">linuxvoice.com</a> as <code>lv-skeleton.html</code>. </p>

<p><img src="https://raymii.org/s/inc/img/linuxvoice/1/texteditor.png" alt="texteditor"/></p>

<blockquote>
<p>A good text editor will highlight different parts of the code, so you can see what part does what.</p>
</blockquote>

<p>In this skeleton, Data1 to 4 are the places we'll put four different pieces of dynamic content. </p>

<p>As a British magazine, the most important thing to us is obviously the weather, and this changes a lot. If we kept looking out of the window, and updating our website every time the weather changed, we'd have no time to make tea, let alone a magazine. Fortunately, though, we don't have to. </p>

<p>The first, and easiest, method of including dynamic content we'll look at is an iframe. These enable you to embed other websites inside yours. In this case, we'll embed a weather forecast. You can put in any website, though it's best to do it with one designed for the purpose, otherwise it's unlikely to look good. </p>

<p>For our purposes, <a href="http://openweathermap.com">openweathermap.com</a> provides exactly what we need. </p>

<p>The website <a href="http://api.openweathermap.org/data/2.5/weather?q=Bath,uk&amp;mode=html">http://api.openweathermap.org/data/2.5/weather?q=Bath,uk&amp;mode=html</a> is a compact forecast for the beautiful city of Bath, designed for embedding. </p>

<p>In the skeleton, you can change <code>Data1</code> to the following: </p>

<pre><code>&lt;h2&gt;The Weather In Bath&lt;/h2&gt; 
&lt;iframe src="http://api.openweathermap.org/data/2.5/weather?q=Bath,uk&amp;mode=html" scrolling="no" seamless="seamless"&gt;&lt;/iframe&gt; 
</code></pre>

<p>This will embed the weather forecast in our website. The scrolling value tells the browser that we don't want a scroll bar on the iframe, and seamless tells it that it should be integrated into our page seamlessly.</p>

<p>Not all browsers recognise these, so it will appear slightly different on different platforms.</p>

<h3>Keepin' Tweetin'</h3>

<p><img src="https://raymii.org/s/inc/img/linuxvoice/1/twitter.png" alt="twitter"/></p>

<blockquote>
<p>You can create Twitter widgets to show anyone's tweets, but if they post something inappropriate, it will be displayed on your site as well.</p>
</blockquote>

<p>Iframes are the most basic way to grab data and serve it in a web page. For simple things like weather forecasts they work great, but sometimes they're a bit lacking. </p>

<p>Some data providers provide 'widgets' that you can put in your page. These are generally small chunks of HTML, usually with some JavaScript to grab data and display it in a useful way. </p>

<p>For our Linux Voice website, we'll add a widget that grabs the Linux Voice Twitter feed. You can create Twitter widgets for any Twitter account. </p>

<p>On the Twitter web page, just go to the cog menu icon, then Settings &gt; Widgets &gt; Create New. </p>

<p>By default it'll set it to the currently logged-in account, but you can change this to whatever you like. We also changed ours to have a height of 300. Once you've entered the details and hit Create, the appropriate code will be displayed below the preview. You just need to copy and paste it in place of <code>Data2</code>. </p>

<p>The code we used was:</p>

<pre><code>&lt;a class="twitter-timeline" href="https://twitter.com/LinuxVoice" data-widget-id="419158898222698496"&gt;Tweets by @LinuxVoice&lt;/a&gt;&lt;script&gt;!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}} (document,"script","twitter-wjs");&lt;/script&gt;
</code></pre>

<p>Of course, you can create your own. Don't worry about trying to understand this script (unless you're a JavaScript masochist) as it's computer generated and not meant to be human readable. </p>

<p>Save the file and refresh your web browser and you should now have the weather and the latest news from Twitter all without having to handle any of it yourself. There are a few options on the Create Widget Twitter page to help you control the look and feel of this datastream, so see which settings work best with your page.</p>

<h3>Get more control</h3>

<p>The problem with the two previous methods is that they pull everything from the other website, so as well as the data you get the other site's formatting too. Sometimes this isn't a problem and the simplicity is worth it. </p>

<p>Other times you may find that you want more control over how the content is displayed, or even the ability to process it before putting it on the screen. </p>

<p>Another risk in putting content from other places on your website is that they could maliciously alter your page using JavaScript. It's unlikely that either Twitter or OpenWeatherMap would do this deliberately, but if hackers managed to break into the main system, they could use this to attack all the web pages that pull data from there. </p>

<p>Therefore, it's better if you don't just put other people's content directly into your site, but process the data and produce HTML that uses the raw data. For this we're going to use Python.</p>

<p><img src="https://raymii.org/s/inc/img/linuxvoice/1/tornado1.png" alt="tornado1.png"/></p>

<blockquote>
<p>If there's a problem with the template, the site won't load. You'll get Python errors, but they aren't usually very helpful.</p>
</blockquote>

<p>The Tornado module contains a web browser that lets you modify templates by passing more information to them. To start with, you'll need to make sure you have the appropriate Python modules installed. </p>

<p>We'll be using Tornado and Feedparser (as well as some modules from the Python standard library). These are available through the PIP (Python Install Python) package manager for Python, but it'll be easier to keep them up to date if you install them through your distro's package manager. </p>

<p>On Debian- based systems you can do this with: </p>

<pre><code>sudo apt-get install python-tornado python-feedparser 
</code></pre>

<p>Once this is done, you just need a simple Python program to serve the website. We've called this code <code>webserver-start.py</code> and it's on the DVD and website.</p>

<pre><code>import tornado.ioloop
import tornado.web
class MainHandler(tornado.web.RequestHandler):
    def get(self):
        self.render("lv.html")
application = tornado.web.Application([r"/", MainHandler),])
if __name__ == "__main__":
    application.listen(8888)
    tornado.ioloop.IOLoop.instance().start()
</code></pre>

<p>We won't go into everything that's going on here (you can learn more about Tornado from the excellent documentation at <a href="http://www.tornadoweb.org/en/stable">www.tornadoweb.org/en/stable</a>), but simply put, this starts a web server on port 8888 of <code>localhost</code>. </p>

<p>It has a class called <code>MainHandler</code>, which is used every time someone visits the root of this web server (ie <code>r"/"</code> in the above code). The method get of this class is called every time someone sends a GET HTTP request to this address, and it renders the template <code>lv.html</code>. (Make sure the HTML file you created before is called <code>lv.html</code>). </p>

<p>As long as you save this in the same directory as <code>lv.html</code>, you can run it from a terminal in the same directory with: </p>

<pre><code>python webserver-start.py 
</code></pre>

<p>Once that's running, you can point a web browser to <a href="http://localhost:8888">http://localhost:8888</a> and it'll display the same page as before. The difference is that it's now a Tornado template, which has more power than regular HTML, and you can pass it data from the Tornado server.</p>

<h3>A Yen a Mark a Buck or a Pound</h3>

<p>As Linux Voice does a lot of business in the USA, changes in the exchange rate between the Dollar and the Pound make a difference to our income. Keeping tabs on this is important, so the next bit of data we pull in will be the latest exchange rate. </p>

<p><a href="http://www.openexchangerates.org">www.openexchangerates.org</a> operates a service that enables you to grab the latest exchange rate data (you'll need to register for an API key before you can use it though). </p>

<p>There are various levels, but the free one is suitable for our needs, and you can sign up for it here: <a href="https://openexchangerates.org/signup/free">https://openexchangerates.org/signup/free</a>. </p>

<p>The data comes in JSON (JavaScript Object Notation) format. While this was designed for JavaScript, it also works really well with Python. </p>

<p>There are a couple of Python modules that help us get and access the data: urllib2 and json. The code to grab and access the data is:</p>

<pre><code>import urllib2
import json
def getRate():
    url = "https://openexchangerates.org/api/latest.json?app_id=YOUR_API_KEY"
    req = urllib2.Request(url)
    response=urllib2.urlopen(req)
    return json.loads(response.read().decode("UTF-8"))['rates']['GBP']
</code></pre>

<p>This piece of code needs to go into the <code>webserver-start.py</code> file between <code>import tornado.web</code> and <code>class MainHandler</code>. Change <code>YOUR_API_KEY</code> to the one you got when you signed up for the service. </p>

<p><code>urllib</code> grabs and opens the resource, then the json module converts it into a Python dictionary. This has the key rates, which is another dictionary, and the key GBP returns the Dollars-Pounds exchange rate. </p>

<p>You then need to pass the latest data across to the template by changing the line <code>self.render("lv.html")</code> to:</p>

<pre><code>self.render("lv.html", rate = getRate())
</code></pre>

<p>This created the global variable rate that you can access in the HTML template with <code>{{ rate }}</code>. Change <code>Data3</code> to:</p>

<pre><code>&lt;h2&gt;The Exchange Rate&lt;/h2&gt;
One dollar is {{rate}} pounds
</code></pre>

<p>After you make any changes to either the webserver code or the template, they won't take effect until you restart the web server (a simple Ctrl+C to stop it, then re-running <code>python websever.py</code> does this). You can then refresh the website in the browser. If everything's worked correctly, you should see the exchange rate displayed. </p>

<p>You can use this method to put whatever you want into the web page. This could be things you've just pulled from a database, or information about the computer that you're running on as well as data grabbed from other sources.</p>

<h3>Going Loopy</h3>

<p>Tornado templates can do far more than just display the values that are passed to them. They can also include bits of Python code that can manipulate the data. The final piece of our datastream will demonstrate this. </p>

<p>We'll pull in the latest posts from the Linux Voice website using RSS and the feedparser module. This works a bit like the json module in that it pulls in data and converts it into a Python dictionary. However, unlike in the previous example, this time we'll pass the entire dictionary to the template and process it there. </p>

<p>You'll need to add the line:</p>

<pre><code>import feedparser 
</code></pre>

<p>To the start of <code>webserver.py</code>, then change the get method of <code>MainHandler</code> to:</p>

<pre><code>lv_feed = feedparser.parse('http://www.linuxvoice.com/feed/')
self.render("lv.html", feed = lv_feed, rate = getRate())
</code></pre>

<p>You don't need to use <code>urllib2</code> to get the document with RSS, as the <code>feedparser</code> module handles everything. </p>

<p>On our page, we want to loop through every entry in the RSS file and display the post title as a link to the post on [linuxvoice.com[(http://linuxvoice.com). </p>

<p>In the template, you can include Python code inside <code>{% %}</code> brackets. </p>

<p>Indentation doesn't work; instead, blocks of code are ended using <code>{% end %}</code>. </p>

<p>This is done with the following code (in place of <code>Data4</code>):</p>

<pre><code>&lt;h2&gt; The latest news from RSS:&lt;/h2&gt;
&lt;ul&gt;
  {% for entry in feed.entries %}
    &lt;li&gt;
      &lt;a href="{{entry.link}}"&gt;{{ escape(entry.title) }} &lt;/a&gt;
    &lt;/li&gt;
  {% end %}
&lt;/ul&gt;
</code></pre>

<p>The final version of webserver.py is on the website and DVD as <code>webserver-final.py</code>. <code>&lt;ul&gt;&lt;/ul&gt;</code> creates an unordered (ie bullet pointed) list, and <code>&lt;li&gt;&lt;/li&gt;</code> tag items in the list. This for loop repeats every line between it and the end, including the HTML lines. This will then create a new list item for every item in <code>feed.entries</code>. </p>

<p>The <code>escape()</code> function just adds escape characters to the text before passing them across so they display correctly in the browser. As you can see, any data that you can access with Python, you can display on a website. Tornado templates give you complete control over how these are displayed. </p>

<p>If you're already running a website with Apache, it isn't easy to incorporate this last technique into it, though you could do something similar with PHP or even JavaScript. </p>

<p>If you're using Nginx as a web server, you could set it up to reverse-proxy a Tornado server for some pages while retaining the speed of Nginx for simpler pages.</p>

<p><img src="https://raymii.org/s/inc/img/linuxvoice/1/endresult1.png" alt="End result"/></p>

<blockquote>
<p>We focused on simplicity so it's not pretty to look at, but there are plenty of CSS and HTML tricks to sort that out.</p>
</blockquote>

<h3>Boxout 1: Useful Tornado template</h3>

<p>Tornado templates are based on Python, but they have their own simple language. Here are a few of the most useful commands: </p>

<pre><code>{% set var_x = a_value %} 
</code></pre>

<p>Sets local variable var<em>x to the value a</em>value. </p>

<pre><code>{% if condition_1 %} 
    ... 
{% elif condition_2 %} 
    ... 
{% else %} 
    ... 
{% end %} 
</code></pre>

<p>An if statement. elif and else are optional. </p>

<pre><code>{% while condition_1 %} 
    ... 
{% end %} 
</code></pre>

<p>A normal while loop. </p>

<pre><code>{% import a_module %} 
</code></pre>

<p>Import the Python module a_module. </p>

<pre><code>{% include a_template %} 
</code></pre>

<p>Copy the contents of a_template to this point in the file. </p>

<p>There are full details of the template syntax at <a href="http://www.tornadoweb.org/en/stable/template.html">www.tornadoweb.org/en/stable/template.html</a>. </p>

<p>In general, it's best to do as much of the processing as possible in the web server, and use the template just to display the data. </p>

<p>You can use the included commands to create various components that you can combine in different ways on different pages.</p>

<h3>Boxout 2: Make it more dynamic</h3>

<p>Server-side processing is great for keeping a site updated, but it has one fatal flaw: it only updates the information every time the website is loaded. Sometimes you need to keep a page's information fresh even if the user leaves it loaded. The simplest solution is simply to tell the browser to keep refreshing the page. </p>

<p>This is incredibly simple - just add the following tag inside the <code>&lt;head&gt; &lt;/head&gt;</code> tags of the template: 
    <meta http-equiv="refresh" content="60"/> </p>

<p>The content value is the number of seconds after loading you want it to refresh. This method is a little crude, but it will work. </p>

<p>A more advanced technique is to keep a connection open between the browser and the server and continue to send data between them. There are ways of doing this using HTTP, but a better solution is to use websockets. </p>

<p>These require both code on the server and JavaScript running in the browser in order to work properly, and they're a bit beyond the scope of this tutorial, but you can find out how to use them on the Tornado website at <a href="http://www.tornadoweb.org/en/stable/websocket.html">www.tornadoweb.org/en/stable/websocket.html</a>.</p>

<h3>Boxout 3: Data sources</h3>

<p><img src="https://raymii.org/s/inc/img/linuxvoice/1/datasources.png" alt="Data sources"/></p>

<blockquote>
<p>You'll find a comprehensive list of useful data sources at <a href="http://www.programmableweb.com">www.programmableweb.com</a>.</p>
</blockquote>

<p>There are loads of places you can get information for dynamic websites. OpenWeatherMaps provide JSON encoded weather data for forecasts as well as current weather. </p>

<p>Twitter also has an API that's easy to use through a module such as <code>python-twitter</code> <a href="http://code.google.com/p/python-twitter">http://code.google.com/p/python-twitter</a>. </p>

<p>In addition to the ones we've looked at here, these are some more that you may find useful: </p>



<p>These are just a few examples; there is a huge range of data sources available. Many offer free access, but some are only for paying customers.</p>

<h3>Boxout 4: XML</h3>

<p>We've looked at JSON, HTML and RSS for data sources, but they're not the only options. XML is also a common format for data on the web, though it can be a little more complex than the others. </p>

<p>It's often done using <code>ElementTree</code>. As the name suggests, this converts the XML into a tree from which you can then extract the information you need.</p>
</div></div></body></html>