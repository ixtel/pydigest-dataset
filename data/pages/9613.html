<html><body><div><article class="markdown-body entry-content" itemprop="text"><h1><a id="user-content-letsencrypt-aws" class="anchor" href="#letsencrypt-aws" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>letsencrypt-aws</h1>

<p><code>letsencrypt-aws</code> is a program that can be run in the background which
automatically provisions and updates certificates on your AWS infrastructure
using the AWS APIs and Let's Encrypt.</p>

<h2><a id="user-content-how-it-works" class="anchor" href="#how-it-works" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>How it works</h2>

<p><code>letsencrypt-aws</code> takes a list of ELBs, and which hosts you want them to be
able to serve. It runs in a loop and every day does the following:</p>

<p>It gets the certificate for that ELB. If the certificate is going to expire
soon (in less than 45 days), it generates a new private key and CSR and sends a
request to Let's Encrypt. It takes the DNS challenge and creates a record in
Route53 for that challenge. This completes the Let's Encrypt challenge and we
receive a certificate. It uploads the new certificate and private key to IAM
and updates your ELB to use the certificate.</p>

<p>In theory all you need to do is make sure this is running somewhere, and your
ELBs' certificates will be kept minty fresh.</p>

<h2><a id="user-content-how-to-run-it" class="anchor" href="#how-to-run-it" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>How to run it</h2>

<p>Before you can use <code>letsencrypt-aws</code> you need to have created an account with
the ACME server (you only need to do this the first time). You can register
using (if you already have an account you can skip this step):</p>

<div class="highlight highlight-text-shell-session"><pre>$ <span class="pl-s1"><span class="pl-c"># If you're trying to register for a server besides the Let's Encrypt</span></span>
$ <span class="pl-s1"><span class="pl-c"># production one, see the configuration documentation below.</span></span>
$ <span class="pl-s1">python letsencrypt-aws.py register email@host.com</span>
<span class="pl-mo">2016-01-09 19:56:19 [acme-register.generate-key]</span>
<span class="pl-mo">2016-01-09 19:56:20 [acme-register.register] email=u'email@host.com'</span>
<span class="pl-mo">2016-01-09 19:56:21 [acme-register.agree-to-tos]</span>
<span class="pl-mo">-----BEGIN RSA PRIVATE KEY-----</span>
<span class="pl-mo">[...]</span>
<span class="pl-mo">-----END RSA PRIVATE KEY-----</span></pre></div>

<p>You'll need to put the private key somewhere that <code>letsencrypt-aws</code> can access
it (either on the local filesystem or in S3).</p>

<p>You will also need to have your AWS credentials configured. You can use any of
the <a href="https://boto3.readthedocs.org/en/latest/guide/configuration.html">mechanisms documented by
boto3</a>, or
use IAM instance profiles (which are supported, but not mentioned by the
<code>boto3</code> documentation). See below for which AWS permissions are required.</p>

<p><code>letsencrypt-aws</code> takes it's configuration via the <code>LETSENCRYPT_AWS_CONFIG</code>
environment variable. This should be a JSON object with the following schema:</p>

<div class="highlight highlight-source-json"><pre>{
    <span class="pl-s"><span class="pl-pds">"</span>domains<span class="pl-pds">"</span></span>: [
        {
            <span class="pl-s"><span class="pl-pds">"</span>elb<span class="pl-pds">"</span></span>: {
                <span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>ELB name (string)<span class="pl-pds">"</span></span>,
                <span class="pl-s"><span class="pl-pds">"</span>port<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>optional, defaults to 443 (integer)<span class="pl-pds">"</span></span>
            },
            <span class="pl-s"><span class="pl-pds">"</span>hosts<span class="pl-pds">"</span></span>: [<span class="pl-s"><span class="pl-pds">"</span>list of hosts you want on the certificate (strings)<span class="pl-pds">"</span></span>],
            <span class="pl-s"><span class="pl-pds">"</span>key_type<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>rsa or ecdsa, optional, defaults to rsa (string)<span class="pl-pds">"</span></span>
        }
    ],
    <span class="pl-s"><span class="pl-pds">"</span>acme_account_key<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>location of the account private key (string)<span class="pl-pds">"</span></span>,
    <span class="pl-s"><span class="pl-pds">"</span>acme_directory_url<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>optional, defaults to Let's Encrypt production (string)<span class="pl-pds">"</span></span>
}</pre></div>

<p>The <code>acme_account_key</code> can either be located on the local filesystem or in S3.
To specify a local file you provide <code>"file:///path/to/key.pem"</code>, for S3 provide
<code>"s3://bucket-nam/object-name"</code>. The key should be a PEM formatted RSA private
key.</p>

<p>Then you can simply run it: <code>python letsencrypt-aws.py update-certificates</code>.</p>

<p>If you add the <code>--persistent</code> flag it will run forever, rather than just once,
sleeping for 24 hours between each check for certificate expiration. This is
useful for production environments.</p>

<p>If your certificate is not expiring soon, but you need to issue a new one
anyways, the <code>--force-issue</code> flag can be provided.</p>

<p>If you're into <a href="https://www.docker.com/">Docker</a>, there is an automatically
built image of <code>letsencrypt-aws</code> available as
<a href="https://hub.docker.com/r/alexgaynor/letsencrypt-aws/"><code>alexgaynor/letsencrypt-aws</code></a>.</p>

<h2><a id="user-content-operational-security" class="anchor" href="#operational-security" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Operational Security</h2>

<p>Keeping the source of your certificates secure is, for obvious reasons,
important. <code>letsencrypt-aws</code> relies heavily on the AWS APIs to do its
business, so we recommend running this code from EC2, so that you can use the
Metadata service for managing credentials. You can give your EC2 instance an
IAM instance profile with permissions to manage the relevant services (see
below for complete details).</p>

<p>You need to make sure that the ACME account private key is kept secure. The
best choice is probably in an S3 bucket with encryption enabled and access
limited with IAM.</p>

<p>Finally, wherever you're running <code>letsencrypt-aws</code> needs to be trusted.
<code>letsencrypt-aws</code> generates private keys in memory and uploads them to IAM
immediately, they are never stored on disk.</p>

<h3><a id="user-content-iam-policy" class="anchor" href="#iam-policy" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>IAM Policy</h3>

<p>The minimum set of permissions needed for <code>letsencrypt-aws</code> to work is:</p>

<ul>
<li><code>route53:ChangeResourceRecordSets</code></li>
<li><code>route53:GetChange</code></li>
<li><code>route53:ListHostedZones</code></li>
<li><code>elasticloadbalancing:DescribeLoadBalancers</code></li>
<li><code>elasticloadbalancing:SetLoadBalancerListenerSSLCertificate</code></li>
<li><code>iam:ListServerCertificates</code></li>
<li><code>iam:UploadServerCertificate</code></li>
</ul>

<p>If your <code>acme_account_key</code> is provided as an <code>s3://</code> URI you will also need:</p>



<p>It's likely possible to restrict these permissions by ARN, though this has not
been fully explored.</p>

<p>An example IAM policy is:</p>

<div class="highlight highlight-source-json"><pre>{
    <span class="pl-s"><span class="pl-pds">"</span>Version<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>2012-10-17<span class="pl-pds">"</span></span>,
    <span class="pl-s"><span class="pl-pds">"</span>Statement<span class="pl-pds">"</span></span>: [
        {
            <span class="pl-s"><span class="pl-pds">"</span>Sid<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>,
            <span class="pl-s"><span class="pl-pds">"</span>Effect<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>Allow<span class="pl-pds">"</span></span>,
            <span class="pl-s"><span class="pl-pds">"</span>Action<span class="pl-pds">"</span></span>: [
                <span class="pl-s"><span class="pl-pds">"</span>route53:ChangeResourceRecordSets<span class="pl-pds">"</span></span>,
                <span class="pl-s"><span class="pl-pds">"</span>route53:GetChange<span class="pl-pds">"</span></span>,
                <span class="pl-s"><span class="pl-pds">"</span>route53:GetChangeDetails<span class="pl-pds">"</span></span>,
                <span class="pl-s"><span class="pl-pds">"</span>route53:ListHostedZones<span class="pl-pds">"</span></span>
            ],
            <span class="pl-s"><span class="pl-pds">"</span>Resource<span class="pl-pds">"</span></span>: [
                <span class="pl-s"><span class="pl-pds">"</span>*<span class="pl-pds">"</span></span>
            ]
        },
        {
            <span class="pl-s"><span class="pl-pds">"</span>Sid<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>,
            <span class="pl-s"><span class="pl-pds">"</span>Effect<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>Allow<span class="pl-pds">"</span></span>,
            <span class="pl-s"><span class="pl-pds">"</span>Action<span class="pl-pds">"</span></span>: [
                <span class="pl-s"><span class="pl-pds">"</span>elasticloadbalancing:DescribeLoadBalancers<span class="pl-pds">"</span></span>,
                <span class="pl-s"><span class="pl-pds">"</span>elasticloadbalancing:SetLoadBalancerListenerSSLCertificate<span class="pl-pds">"</span></span>
            ],
            <span class="pl-s"><span class="pl-pds">"</span>Resource<span class="pl-pds">"</span></span>: [
                <span class="pl-s"><span class="pl-pds">"</span>*<span class="pl-pds">"</span></span>
            ]
        },
        {
            <span class="pl-s"><span class="pl-pds">"</span>Sid<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>,
            <span class="pl-s"><span class="pl-pds">"</span>Effect<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>Allow<span class="pl-pds">"</span></span>,
            <span class="pl-s"><span class="pl-pds">"</span>Action<span class="pl-pds">"</span></span>: [
                <span class="pl-s"><span class="pl-pds">"</span>iam:ListServerCertificates<span class="pl-pds">"</span></span>,
                <span class="pl-s"><span class="pl-pds">"</span>iam:UploadServerCertificate<span class="pl-pds">"</span></span>
            ],
            <span class="pl-s"><span class="pl-pds">"</span>Resource<span class="pl-pds">"</span></span>: [
                <span class="pl-s"><span class="pl-pds">"</span>*<span class="pl-pds">"</span></span>
            ]
        }
    ]
}</pre></div>
</article>
  </div></body></html>