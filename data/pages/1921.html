<html><body><div><div class="entry-content">
						<p>A while back I <a href="http://www.giantflyingsaucer.com/blog/?p=4450">blogged about</a> Python’s <a href="https://docs.python.org/3/library/multiprocessing.html">multiprocessing</a>. I was talking with a friend the other day and was looking over his team’s Github repos and <a href="https://github.com/stackforge/stacktach">came across</a> an interesting use of the multiprocessing package. I broke the original code down into a very small and easy to use example that you can use to power your own creations. Its not really anything somebody couldn’t figure out on their own, but my blog has always been popular with people new to programming so I think this could help new Python developers out.</p>
<p><span id="more-5008"/></p>
<p><strong>Note:</strong> The following example was tested with both Python 2.7.8 as well as Python 3.4.0.</p>
<p>The code for the <strong>start_worker.py</strong> file:</p>
<pre class="brush: python; title: ; notranslate" title="">
from __future__ import print_function

from multiprocessing import Process
import signal
import sys

import worker
import config


_PROCESSES = []


def kill_time(signal, frame):
    for proc in _PROCESSES:
        proc.terminate()
        print("Terminating pid: {0}".format(proc.pid))
    for proc in _PROCESSES:
        proc.join()
    print("System exiting")
    sys.exit(0)


if __name__ == '__main__':
    for wkr in config.workers():
        if wkr.get('enabled', True):
            process = Process(target=worker.run, args=(wkr,))
            process.daemon = True
            process.start()
            _PROCESSES.append(process)
    signal.signal(signal.SIGINT, kill_time)
    signal.signal(signal.SIGTERM, kill_time)
    signal.pause()
</pre>
<p>In the <strong>main function</strong> we iterate through the workers defined in a JSON based configuration file which I’ll show shortly. Assuming the worker is enabled (by default it’s turned on so the config needs to explicitly disable it) a process is spun up for that worker process and is daemonized. The main process waits for any signals that interrupt or terminate (<strong>SIGINT</strong> or <strong>SIGTERM</strong>) the application upon which it will call the <strong>kill_time</strong> function and then iterate the processes and terminate them and exit the application once each process had ended.</p>
<p>The JSON config file called <strong>worker_config.json</strong> looks like this:</p>
<pre class="brush: plain; title: ; notranslate" title="">
{"workers": [
    {
        "enabled": true,
        "name": "worker1"
    },
    {
        "name": "worker2"
    }]
}
</pre>
<p>The code to load the configuration is in a file called <strong>config.py</strong>:</p>
<pre class="brush: python; title: ; notranslate" title="">
import json


config = None
with open('worker_config.json', 'r') as file:
    config = json.load(file)


def workers():
    return config['workers']
</pre>
<p>Now, we will look at the actual worker code in a file named <strong>worker.py</strong>:</p>
<pre class="brush: python; title: ; notranslate" title="">
from __future__ import print_function

import os
import time


def run(worker_config):
    name = worker_config['name']

    print('Starting {0}'.format(name))

    while True:
        print('{0} is running as pid: {1}'.format(name, os.getpid()))
        time.sleep(5)
</pre>
<p>The contents of the <strong>run</strong> function don’t really do anything but print some information and sleep for 5 seconds, you could however do <a href="https://github.com/stackforge/stacktach/blob/master/worker/worker.py#L180-L231">some real work here</a> like put messages onto or fetch messages from a Queue, or numerous other tasks.</p>
<p>Running the application will have output similar to this:</p>
<pre class="brush: plain; title: ; notranslate" title="">
Starting worker1
worker1 is running as pid: 20855
Starting worker2
worker2 is running as pid: 20856
worker1 is running as pid: 20855
worker2 is running as pid: 20856
worker1 is running as pid: 20855
worker2 is running as pid: 20856
Terminating pid: 20855
Terminating pid: 20856
System exiting
</pre>
<p>This code can be easily tweaked as needed and one obvious addition would be some actual error handling which I’ve purposely left out to keep the code as small as possible.</p>


											</div>


					</div></body></html>