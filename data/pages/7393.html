<html><body><div><div class="post-content">
<header>

</header>
<p><em>A guest post by <a href="https://twitter.com/gregbrunn" target="_blank">Gregory Brunner</a></em></p>
<p>There are a lot of great blog posts out there about techniques to get and plot basketball data using the <a href="http://stats.nba.com/stats/shotchartdetail" target="_blank">NBA stats API</a>. Two that I highly recommend are <a href="http://www.gregreda.com/2015/02/15/web-scraping-finding-the-api/" target="_blank">Web Scraping 201: Finding the API</a> and <a href="http://thedatagame.com.au/2015/09/27/how-to-create-nba-shot-charts-in-r/" target="_blank">How to Create NBA Shot Charts in R</a>. Here, I want to show how you can use Python to push this data into a Geographic Information System, ArcGIS. From there, you can leverage concepts, tools, and applications that are generally reserved for geography and geographers to make some great visuals from NBA player shot chart data.</p>
<p>Accessing the NBA stats API with Python is pretty straightforward. Here I can get whole season of shots for a player given their player ID and the season.</p>
<pre class="brush: python; collapse: false; title: ; wrap-lines: false; notranslate" title="">
def get_player_season(player_id, season):
    master_shots=[]
    coords = []
    seasontype="Regular%20Season"
    seasonindicator=0
    nba_call_url='http://stats.nba.com/stats/shotchartdetail?Season=%s&amp;SeasonType=%s&amp;TeamID=0&amp;PlayerID=%s&amp;GameID=&amp;Outcome=&amp;Location=&amp;Month=0&amp;SeasonSegment=&amp;DateFrom=&amp;Dateto=&amp;OpponentTeamID=0&amp;VsConference=&amp;VsDivision=&amp;Position=&amp;RookieYear=&amp;GameSegment=&amp;Period=0&amp;LastNGames=0&amp;ContextMeasure=FGA' % (season,seasontype, player_id)
    plays=urllib2.urlopen(nba_call_url)
    data=json.load(plays)
    for row in data['resultSets'][0]['rowSet']:
        three=0
        if row[12]=='3PT Field Goal':
            three=1
        temp=(row[0], row[1], row[2], row[3], row[4], row[5], row[6], row[7],
                row[8], row[9], row[10],row[11], row[12], row[13], row[14],
                row[15], row[16], row[17],row[18], row[19], row[20], three)
        coord = ([row[17],row[18]])
        coords.append((coord,)+temp)

    return master_shots, coords
</pre>
<p>Rather than plot the data straight into ggplot (R) or matplotlib (Python) or push the data into our own SQL database, we can store the data in a ArcGIS feature class in a geodatabase. Using arcpy, we can create a feature class and add the fields from the data that we want to store.</p>
<pre class="brush: python; collapse: false; title: ; wrap-lines: false; notranslate" title="">
def create_feature_class(output_gdb, output_feature_class):
    feature_class = os.path.basename(output_feature_class)
    if not arcpy.Exists(output_gdb):
        arcpy.CreateFileGDB_management(os.path.dirname(output_gdb),os.path.basename(output_gdb))
        arcpy.CreateFeatureclass_management(output_gdb,feature_class,"POINT","#","DISABLED","DISABLED", "PROJCS['WGS_1984_Web_Mercator_Auxiliary_Sphere',GEOGCS['GCS_WGS_1984',DATUM['D_WGS_1984',SPHEROID['WGS_1984',6378137.0,298.257223563]],PRIMEM['Greenwich',0.0],UNIT['Degree',0.0174532925199433]],PROJECTION['Mercator_Auxiliary_Sphere'],PARAMETER['False_Easting',0.0],PARAMETER['False_Northing',0.0],PARAMETER['Central_Meridian',0.0],PARAMETER['Standard_Parallel_1',0.0],PARAMETER['Auxiliary_Sphere_Type',0.0],UNIT['Meter',1.0]]","#","0","0","0")
    if not arcpy.Exists(output_feature_class):
        arcpy.AddField_management(output_feature_class,"GRID_TYPE","TEXT", "", "", 100)
        arcpy.AddField_management(output_feature_class,"GAME_ID","TEXT", "", "", 100)
        arcpy.AddField_management(output_feature_class,"GAME_EVENT_ID","TEXT", "", "", 100)
        arcpy.AddField_management(output_feature_class,"PLAYER_ID","TEXT", "", "", 100)
        arcpy.AddField_management(output_feature_class,"PLAYER_NAME","TEXT", "", "", 100)
        arcpy.AddField_management(output_feature_class,"TEAM_ID","TEXT", "", "", 100)
        arcpy.AddField_management(output_feature_class,"TEAM_NAME","TEXT", "", "", 100)
        arcpy.AddField_management(output_feature_class,"PERIOD","SHORT", "", "", "")
        arcpy.AddField_management(output_feature_class,"MINUTES_REMAINING","SHORT", "", "", "")
        arcpy.AddField_management(output_feature_class,"SECONDS_REMAINING","SHORT", "", "", "")
        arcpy.AddField_management(output_feature_class,"EVENT_TYPE","TEXT", "", "", 100)
        arcpy.AddField_management(output_feature_class,"ACTION_TYPE","TEXT", "", "", 100)
        arcpy.AddField_management(output_feature_class,"SHOT_TYPE","TEXT", "", "", 100)
        arcpy.AddField_management(output_feature_class,"SHOT_ZONE_BASIC","TEXT", "", "", 100)
        arcpy.AddField_management(output_feature_class,"SHOT_ZONE_AREA","TEXT", "", "", 100)
        arcpy.AddField_management(output_feature_class,"SHOT_ZONE_RANGE","TEXT", "", "", 100)
        arcpy.AddField_management(output_feature_class,"SHOT_DISTANCE","SHORT", "", "", "")
        arcpy.AddField_management(output_feature_class,"LOC_X","DOUBLE", "", "", "")
        arcpy.AddField_management(output_feature_class,"LOC_Y","DOUBLE", "", "", "")
        arcpy.AddField_management(output_feature_class,"SHOT_ATTEMPTED_FLAG","SHORT", "", "", "")
        arcpy.AddField_management(output_feature_class,"SHOT_MADE_FLAG","SHORT", "", "", "")
        arcpy.AddField_management(output_feature_class,"THREE","SHORT", "", "", "")
</pre>
<p>Once the data is in Python and I have a feature class created, all that’s left to do is insert the data into the feature class with an arcpy InsertCursor.</p>
<pre class="brush: python; collapse: false; title: ; wrap-lines: false; notranslate" title="">
def populate_feature_class(rowValues, output_feature_class):
    c = arcpy.da.InsertCursor(output_feature_class,fc_fields)
    for row in rowValues:
        c.insertRow(row)
    del c
</pre>
<p>At this point, if we just wanted to work in ArcMap, we’d be done. We don’t want to do that. We want to share this data as a hosted feature service in <a href="http://www.arcgis.com" target="_blank">ArcGIS Online</a> so that we can use the functionality of ArcGIS Online. Here’s what <a href="http://ps-dbs.maps.arcgis.com/home/webmap/viewer.html?webmap=4a2cd28cf44141f0b923adad6252d3b4" target="_blank">Russell Westbrook’s 2014-2015 season shot chart looks like as a webmap</a>.</p>
<small><a href="http://www.arcgis.com/home/webmap/viewer.html?webmap=4a2cd28cf44141f0b923adad6252d3b4" target="_blank">View larger map</a></small>
<p>I got the OKC Thunder court image from <a href="http://grantland.com/features/nba-court-design-power-rankings/" target="_blank">Zach Lowe’s NBA Court Design Power Rankings</a> and georeferenced is to the data using:</p>
<pre class="brush: python; collapse: false; title: ; wrap-lines: false; notranslate" title="">
# Replace a layer/table view name with a path to a dataset (which can be a layer file) or create the layer/table view within the script
# The following inputs are layers or table views: "okc.jpg"
arcpy.Warp_management(in_raster="okc.jpg", source_control_points="'920.296 -92.874';'920.296 -526.033';'514.595 -526.033';'514.595 -92.874'", target_control_points="'250 -40';'-250 -40';'-250 390';'250 390'", out_raster="C:/PROJECTS/R&amp;D/NBA/OKC_Court_Scaled_39.tif", transformation_type="POLYORDER1", resampling_type="BILINEAR")
</pre>
<p>I am a few pixels off in the y-direction, so I’ll have to play around with this more to get the image to align better with the data. If you want to do this for other basketball court images, this code probably needs to be modified a little bit depending on the dimensions of the image.</p>
<p>Now we can use other ArcGIS Online capabilities to give the shot chart a heat map effect.</p>
<small><a href="http://www.arcgis.com/home/webmap/viewer.html?webmap=98db0759ae55427e97b10e78dde811e0" target="_blank">View larger map</a></small>
<p>What’s really cool is that once you have a webmap of the shot chart data, you can ‘create a web application.’ I chose to use the summary viewer to visualize the shot chart data because it dynamically calculates the shooting percentage and also allows the capability to filter on a selected attribute. Here I filter on SHOT_TYPE; however, you could choose to filter on SHOT_DISTANCE, ACTION_TYPE, PERIOD, or another attribute. Click in the search window that says “All” and you can filter the data on Russell Westbrook’s shot type.</p>
<p><br/>
<a href="http://ps-dbs.maps.arcgis.com/apps/SummaryViewer/index.html?appid=65e69468f0784d6ca173ef5700f50fe7" target="_blank">View Larger App</a></p>
<p>This is really just scratching the surface of what you can do with this data in ArcGIS. You can try using the analytics, geoprocessing services, and other app templates once you get the data into ArcGIS Online. If you need help getting started, you can find my source code at my <a href="https://github.com/gbrunner/Courtside-Geography/wiki">Github</a> page.</p>
<p id="jp-relatedposts" class="jp-relatedposts">
<h3 class="jp-relatedposts-headline"><em>Related</em></h3>
</p>
<p class="pagelink">
</p>
</div> 
</div></body></html>