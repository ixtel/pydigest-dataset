<html><body><div><div class="content html_format">
      <img src="https://habrastorage.org/files/780/5fe/19e/7805fe19e40841e590867585770397fc.jpg"/>
<p>
V-REP представляет собой среду для симулирования (sandbox) различных видов роботов, при этом пользователю нет необходимости иметь физический доступ к реальной машине, что экономит деньги и время. Среда V-REP предоставляет удобный интерфейс для визуализации действий робота в трёхмерном виртуальном пространстве намного раньше, чем реальный прототип робота будет создан. При помощи данного руководства вы убедитесь, что для того, чтобы работать в данной среде, программисту не нужно иметь большого технического опыта в области роботостроения.
</p><p>
Причиной создания данного руководства стало отсутствие (на то время) знаний языка Lua, на котором по умолчанию написаны все скрипты управления роботом, и его меньшая популярность. Цель данного руководства показать как пользоваться удалённым (Remote) API данной среды на примере языка Python.
</p><a name="habracut"/><p>
Для начала скачайте версию для Академических целей (Non-limited EDUCATIONAL) для своей ОС с </p><a href="http://www.coppeliarobotics.com/downloads.html">официального сайта</a><p>.
</p><p>
После установки и запуска программы откроется основное окно программы.

</p><img src="https://habrastorage.org/files/139/33c/d93/13933cd9305846d38fdf6b808698b27e.png"/>
<p>
Когда вы открываете среду V-REP, она инициализирует сцену по умолчанию. Пользователь может открывать несколько сцен параллельно, но отображается только текущая.
</p><p>
Панель инструментов содержит набор кнопок, основными из которых являются кнопки для запуска и остановки сцены.

</p><img src="https://habrastorage.org/files/7df/aa4/4b2/7dfaa44b2dfb4b9f87ac2df22da43921.png"/>
<p>
Также инструменты для работы с камерой. Для перемещения и изменения угла просмотра, приближение.

</p><img src="https://habrastorage.org/files/d9c/105/594/d9c105594e2b4af193e1c7299f80f1c0.png"/>
<p>
Для работы с элементами помещенными на сцену существуют следующие инструменты: “выделяемость” объекта по нажатию, перемещение и изменение угла расположения объекта. При этом у выделенного объекта появляются дополнительные оси, за которые удобно перемещать и поворачивать.

</p><img src="https://habrastorage.org/files/9a4/b33/94b/9a4b3394b21e426a8078d26bf55b9e8a.png"/>
<p>
Иерархия сцены содержит список открытых сцен. В каждую сцену входят различные объекты, которые могут состоят из целого набора подобъектов, таким образом выстраивая целую иерархию. В сцену по умолчанию входят: Камера, Источники света, Расширяемый пол. По нажатию на плюсик в дереве можно посмотреть зависимые объекты.

</p><img src="https://habrastorage.org/files/791/539/aff/791539affd1340c3ba4228f7fbe737fe.png"/>
<p>
Как вы заметили, справа от имени некоторых объектов есть различные иконки. Таким образом отображаются зависимые Lua-скрипты, которые можно просмотреть по двойному нажатию. У самой сцены есть главный скрипт, редактировать который не рекомендуется. А у других объектов собственные, которые можно добавлять, редактировать и изменять в соответсвии с вашими потребностями.
</p><p>
Давайте добавим что-нибудь на нашу сцену. V-REP содержит целую коллекцию разнообразных роботов, которых можно предварительно посмотреть в обзорщике моделей (Tools | Model browser). Для добавления нужной модели необходимо лишь перетащить её на сцену. При этом важно, чтобы сцена при перетаскивании была остановлена, иначе ваши изменения не будут сохранены.

</p><img src="https://habrastorage.org/files/cc0/4c2/b5c/cc04c2b5cab44c76a83215088aa5680f.png"/>
<p>
Также в среде доступны все основные примитивы, добавить которые можно, нажав правую кнопку мыши на сцене и выбрав соответсвующие пункты меню.
</p><p>
Например, добавим на нашу сцену куб, выбрав Add | Primitive shape | Cuboid. 

</p><img src="https://habrastorage.org/files/888/c49/1e0/888c491e05e748988dcb6d825944d76b.png"/>
<p>
И выставим в появившемся меню размеры 0.400 x 0.400 x 0.400. (Соответсвующие метрической системе).

</p><img src="https://habrastorage.org/files/20b/1f7/b52/20b1f7b525ba4591a9dc482cfd10b307.png"/>

<img src="https://habrastorage.org/files/559/089/78b/55908978b7d447258bfbc1b329e8a52e.png"/>
<p>
Давайте посмотрим как взаимодействовать с V-REP посредством предоставляемым им Remote API, который позволяет писать сценарии для среды на различных языках, среди которых C/C++, Python, Java, Matlab/Octave и Urbi. 

</p><ul>
<li>Для начала создайте папку для нашего нового проекта. </li>
<li>Затем создайте новую сцену или удалите/отмените изменения на сцене по умолчанию.</li>
<li>Сохраните сцену, например как myFirstScene. В результате создастся файл myFirstScene.ttt</li>
<li>Далее вам необходимо скопировать несколько файлов из директории с установленной программой. Зайдите в неё. В ней содержится папка programming, затем в remoteApiBindings, из которой вам нужно скопировать несколько файлов в созданную ранее папку для проекта. А именно файлы из папки python (vrep.py, vrepConst.py, simpleTest.py). И файлы из папки lib в соответсвии с разрядностью вашей ОС (это может быть remoteApi.so или remoteApi.dll).</li>
</ul><p>
Добавим на сцену модель робота </p><i>pioneer p3dx</i><p>. Для этого в обзорщике моделей в дереве robots выберите mobile и перетащите робота на сцену.

</p><img src="https://habrastorage.org/files/e82/3c0/9bc/e823c09bc7204ecba9c4c2e6c7e1ffe2.png"/>
<p>
Если сейчас нажать на кнопку Play (Старт сцены), то робот поедет в прямом направлении, логика его работы содержится в прикреплённом скрипте, который мы скоро заменим на наш Python-скрипт. 
</p><p>
Если внимательно изучить из чего состоит данная модель в Иерархии сцены (Scene hierachy), то можно заметить, что данный робот состоит из пары колёс (Pioneer_p3dx_leftWheel и Pioneer_p3dx_rightWheel), 16 сенсоров по бокам (Pioneer_p3dx_ultrasonicSensor1-16) и 11 коннекторов (Pioneer_p3dx_connection1-11).

</p><img src="https://habrastorage.org/files/b21/82b/50e/b2182b50ea954201a3481e5d2c691666.png"/>
<p>
Для начала давайте отключим скрипт, двигающий робота вперёд. Для этого нажмём на боковой панели кнопку Скрипты (Scripts).

</p><img src="https://habrastorage.org/files/a7a/34e/fb0/a7a34efb017d45d6ae1fbb26224fb977.png"/>
<p>
Появится новое окно, в котором перечислены все имеющиеся на сцене скрипты.

</p><img src="https://habrastorage.org/files/532/28e/2df/53228e2dfbce4f548fe9b03812c2995d.png"/>
<p>
Теперь выделите скрипт робота Non-threaded child script (Pioneer_p3dx) и поставьте галочку на пункте Disabled.

</p><img src="https://habrastorage.org/files/f60/110/627/f60110627b3a4987b4664a38a435c828.png"/>
<p>
Теперь закройте это окно и протестируйте Включив сцену, робот должен стоять на месте. О том что скрипт отключен также свидетельствует изменившаяся иконка в Иерархии сцены.

</p><img src="https://habrastorage.org/files/370/ecd/e5a/370ecde5a16a48bcbc7a3bf2bc59c2b5.png"/>
<p>
Теперь давайте немного разберёмся в том, как наш скрипт будет взаимодействовать со сценой при помощи Remote API.
</p><p>
V-REP предоставляет средства контроля симуляцией из внешнего приложения или внешнего устройства (например с настоящего робота, удалённого компьютера). API содержит сотни функций, которые могут быть вызваны через коммуникационные сокеты, с минимальной задержкой и нагрузкой на сеть. Всё это происходит в скрытом от пользователя виде. По средствам удалённого API можно взаимодействовать с V-REP в синхронном и асинхронных режимах (по умолчанию действует асинхронный режим), и даже удалённо управлять симулятором (удалённо загружать сцену, начинать и останавливать работу симуляции). 

</p><b>Примечание</b><p>: Синхронный режим подразумевает, что симулятор будет ждать подтверждающего сигнала от клиента для выполнения следующего шага на время t + dt.
</p><p>
Для начала работы с Remote API нужно активировать его на стороне сервера, тоесть в самой среде V-REP. Для этого нужно активировать прослушку порта в любом активном потоково зависимом скрипте (например дописав команду в имеющийся Lua-скрипт или добавив какой-нибудь примитив, тот же куб и прикрепив скрипт к нему).
</p><p>
Давайте добавим куб на сцену как описано выше, оставим размеры по умолчанию (0.100 x 0.100 x 0.100). Выделите его на сцене, нажмите правую кнопку мыши и в контекстном меню выберите Add | Associated child script | Threaded.

</p><img src="https://habrastorage.org/files/323/d81/15a/323d8115accf4fb990c0304745e19ef0.png"/>
<p>
После чего рядом с именем нашего куба появится иконка зависимого скрипта и его настроек в иерархии сцены. В панеле Скрипты (Scripts) также появится соответствующий пункт.

</p><img src="https://habrastorage.org/files/377/454/991/377454991fb143ff815fd370a44c6339.png"/>

<img src="https://habrastorage.org/files/d58/6c6/f7b/d586c6f7b30248e981092d3127a26c41.png"/>
<p>
По нажатию на иконку скрипта в текстовом редакторе выведется стандартный каркас потоковых скриптов, в него же вам следует добавить строку открытия и активации порта на языке Lua. 

</p><pre><code class="lua">simExtRemoteApiStart(19999)</code></pre>
<p>
Добавьте ее сразу после команды simSetThreadSwitchTiming(2), в результате получится следующее.

</p><img src="https://habrastorage.org/files/aea/261/565/aea261565aa546989709281cfce0b4e3.png"/>
<p>
Если на данном этапе попробовать запустить сцену, то ничего не произойдет. Осталось написать код влияющий на объекты сцены.
</p><p>
Для этого вернитесь в папку нашего проекта и обратите внимание на скрипт simpleTest.py. Давайте изучим его содержимое:

</p><pre><code class="python">import vrep

print ('Program started')
vrep.simxFinish(-1) # just in case, close all opened connections
clientID = vrep.simxStart('127.0.0.1',19999,True,True,5000,5)
if clientID != -1:
    print ('Connected to remote API server')
    res,objs=vrep.simxGetObjects(clientID,vrep.sim_handle_all,vrep.simx_opmode_oneshot_wait)
    if res == vrep.simx_return_ok:
            print ('Number of objects in the scene: ', len(objs))
    else:
            print ('Remote API function call returned with error code: ', res)
    vrep.simxFinish(clientID)
else:
    print ('Failed connecting to remote API server')
print ('Program ended')
</code></pre><p>
Попробуйте запустить его. Если сцена будет не запущенна, то вы получите соответсвующее уведомление в консоли, иначе скрипт подсчитает количество объектов на сцене.

</p><img src="https://habrastorage.org/files/960/8c2/c65/9608c2c653664b09b92701aed49fe55b.png"/>
<p>
Разберемся в содержимом данного скрипта. Если вы владеете инструментом IPython, то можете последовательно строка за строкой вводить команды и изучать, что возвращают функции V-REP.
</p><p>
Для начала импортируем модуль V-REP. Не забывайте, что он должен быть в текущей дириктории скрипта(для этого мы и копировали те файлы из папки programming), иначе Python не обнаружит его. 

</p><pre><code class="python">import vrep
</code></pre><p>
Далее остановим другие соединения со сценой чтобы они не мешали логике нашего скрипта, если они конечно существуют. Для это есть функция simxFinish c аргументом -1.

</p><pre><code class="python">vrep.simxFinish(-1)
</code></pre><p>
Далее необходимо соединиться с удалённым сервером на том порту, что мы открыли в скрипте куба. Так как V-REP запущен у нас локально, то адрес 127.0.0.1. Согласно документации по Remote Api для Python (</p><a href="http://www.coppeliarobotics.com/helpFiles/en/remoteApiFunctionsPython.htm#simxStart">ссылка</a><p>), аргументы данной функции обозначают следующее:

</p><pre><code class="python">clientID = vrep.simxStart('127.0.0.1', 19999, True, True, 5000, 5)
</code></pre>
<ul>
<li><b>connectionAddress</b>: IP адрес, где сервер находится (тоесть адрес сервера с V-REP).</li>
<li><b>connectionPort</b>: Порт, с которым происходит соединение.</li>
<li><b>waitUntilConnected</b>: Если True, тогда функция блокируется на время соединения или пока не закончится время тайм-аута.</li>
<li><b>doNotReconnectOnceDisconnected</b>: Если True, тогда коммуникационный поток не будет пытаться переподсоединиться в случае потери соединения.</li>
<li><b>timeOutInMs</b>: Тайм-аут соединения в милисекундах (для первого соединения).</li>
<li><b>commThreadCycleInMs</b>: Указывает на то, как часто должен происходить обмен пакетами данных. Уменьшение этого числа повышает чувствительность, а в роли значения по умолчанию рекомендуется 5.</li>
</ul>
<p>
В качестве возвращаемого значения clientID: идентификатор клиентского ID, или -1, если соедиение с сервером не возможно (в том числе по окончанию времени тайм-аута). 
</p><p>
Вызов simxStart всегда должен быть в паре с вызовом simxFinish, за исключением случая, когда соедиение не было выполнено (тоесть clientID = -1). Чему соответсвует следующая строка кода:

</p><pre><code class="python">vrep.simxFinish(clientID)
</code></pre><p>
После попытки установления соединения выполняется проверка на успешность, о чем сообщит соответсвующее сообщение.

</p><pre><code class="python">if clientID != -1:
    print ('Connected to remote API server')

    ...

else:
    print ('Failed connecting to remote API server')
</code></pre><p>
Дальше скрипт запрашивает все объекты на сцене через функцию vrep.simxGetObjects.
</p><p>
Согласно документации, которую вы можете изучить на официальном сайте (</p><a href="http://www.coppeliarobotics.com/helpFiles/en/remoteApiFunctionsPython.htm#simxGetObjects">ссылка</a><p>), функция получает хэндлы объектов определенного типа или, как в нашем случае, всех типов (vrep.sim_handle_all); последний аргумент означает, что после отправки команды функция будет ждать ответа от сервера и вернёт его, если не произойдет ошибки или будет превышенно время тайм-аута (vrep.simx_opmode_oneshot_wait). Остальные режимы можно посмотреть </p><a href="http://www.coppeliarobotics.com/helpFiles/en/remoteApiConstants.htm#operationModes">здесь</a><p>.

</p><pre><code class="python">res, objs = vrep.simxGetObjects(clientID, vrep.sim_handle_all, vrep.simx_opmode_oneshot_wait)
</code></pre><p>
Функция возвращает 2 значения </p><b>errorCode</b><p>: код ошибки и </p><b>objectHandles</b><p>: массив хэндлов объектов.
</p><p>
Далее следует проверка кода ошибки и в случае успеха — подсчет количества объектов на сцене:

</p><pre><code class="python">    if res == vrep.simx_return_ok:
            print ('Number of objects in the scene: ', len(objs))
    else:
            print ('Remote API function call returned with error code: ', res)
</code></pre><p>
При этом стоит заметить, что константа simx_return_ok соответсвует нулю (0).
</p><p>
Отлично! После того как мы разобрались со значением функций, давайте, наконец, оживим нашу сцену. Для этого нам потребуется выполнить следующие действия в нашем собственном скрипте:

</p><ul>
<li>Получаем clientID и закрываем остальные соединения, если таковые имеются.</li>
<li>Проверяем получилось ли соединиться, если нет, то выводим сообщение и прекращаем работу. </li>
<li>Поискав в документации, обнаруживаем функцию vrep.simxGetObjectHandle, с помощью которой можно получить хэндл нужного нам объекта (в нашем случае левого и правого колеса).</li>
</ul><p>
Задаем ускорение (vrep.simxSetJointTargetVelocity) в случае успеха, что заставит нашего робота двигаться с нужным нам ускорением.
</p><p>
В результате у вас выйдет подобный скрипт script1.py:

</p><pre><code class="python">import vrep
import sys

vrep.simxFinish(-1)

clientID = vrep.simxStart('127.0.0.1', 19999, True, True, 5000, 5)

if clientID!= -1:
    print("Connected to remote server")
else:
    print('Connection not successful')
    sys.exit('Could not connect')

errorCode,left_motor_handle=vrep.simxGetObjectHandle(clientID,'Pioneer_p3dx_leftMotor',vrep.simx_opmode_oneshot_wait)

errorCode,right_motor_handle=vrep.simxGetObjectHandle(clientID,'Pioneer_p3dx_rightMotor',vrep.simx_opmode_oneshot_wait)

if errorCode == -1:
    print('Can not find left or right motor')
    sys.exit()

errorCode=vrep.simxSetJointTargetVelocity(clientID,left_motor_handle,0.2, vrep.simx_opmode_oneshot_wait)
errorCode=vrep.simxSetJointTargetVelocity(clientID,right_motor_handle,0.2, vrep.simx_opmode_oneshot_wait)
</code></pre><p>
Для функции simxGetObjectHandle помимо clientID указывается имя объекта, которое можно посмотреть в Иерархии сцены.

</p><img src="https://habrastorage.org/files/b2d/4e0/ae5/b2d4e0ae569243ab875049add36b96de.png"/>

<pre><code class="python">errorCode, left_motor_handle = vrep.simxGetObjectHandle(clientID, 'Pioneer_p3dx_leftMotor', vrep.simx_opmode_oneshot_wait)
</code></pre><p>
Теперь если запустить сцену и активировать скрипт, наш робот начинает двигаться. Пробуя разные значения скоростей, или, например, задав скорость только одному колесу, можно заставить робота крутиться вокруг своей оси.
</p><p>
Как видите, взаимодействовать со средой V-REP при помощи Python совсем не сложно, а благодаря большому функционалу можно создавать действительно сложные сценарии взаимодействия целых групп роботов и многое многое другое. Для вдохновления можете начать с изучения их демо-примеров.
      </p><p class="clear"/>
    </div>

    
  </div></body></html>