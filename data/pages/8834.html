<html><body><div><div class="content html_format"><p>
      Сейчас уже многие используют библиотеку </p><i>numpy</i><p> в своих python-программах, поскольку она заметно ускоряет работу с данными и выполнение математических операций. Однако во многих случаях </p><i>numpy</i><p> работает в разы медленнее, чем она может… потому что использует только один процессор, хотя могла бы использовать все, что у вас есть.
</p><a name="habracut"/><p>
Дело в том, что для выполнения многих операций </p><i>numpy</i><p> вызывает функции из библиотеки линейной алгебры. Вот в ней-то обычно и кроется проблема. К счастью, все довольно легко исправимо.
</p><p>
Итак, возможно три ситуации:

</p><ul>
<li>у вас не установлены никакие библиотеки линейной алгебры и тогда numpy использует встроенную библиотеку, и она, надо сказать, весьма медленная;</li>
<li>у вас уже установлены классические библиотеки типа ATLAS и BLAS, и они умеют использовать только один процессор;</li>
<li>у вас установлена современная библиотека OpenBLAS, MKL и им подобные.</li>
</ul><p>
Проведем простой тест. Запустите вот эту программу:

</p><pre><code class="python">import numpy as np
size = 10000
a = np.random.random_sample((size, size))
b = np.random.random_sample((size, size))
n = np.dot(a,b)
</code></pre><p>
После чего, если работаете в Linux, то запустите </p><i>top</i><p>, а если вы работаете в Windows, зайдите на вкладку в “Быстродействие” в диспетчере задач (вызывается по Ctrl+Shift+Esc)… Если </p><i>top</i><p> показывает загруженность на уровне 100%, а индикатор “Загрузка ЦП” на вкладке “Быстродействие”, наоборот, показывает значение многократно ниже 100%, значит вычислениями занято лишь одно ядро — и эта статья для вас. Те, у кого задействованы все процессоры, могут радоваться — у них все в порядке — и дальше можно не читать.

</p><h5>Решение для Windows</h5><p>
Теоретически, можно, конечно, найти исходники библиотек, перекомпилировать их и пересобрать </p><i>numpy</i><p>. Я даже слышал, что кто-то писал, что он видел людей, которые говорили, что им это удалось… В общем, самый простой способ — это установить научный дистрибутив Python, например, </p><i><a href="https://www.continuum.io/why-anaconda">Anaconda</a></i><p> или </p><i><a href="https://www.enthought.com/products/canopy/">Canopy</a></i><p>. В дистрибутив входит не только </p><i>python</i><p> и </p><i>numpy</i><p>, но и целая куча полезных библиотек для расчетов и визуализации. 
</p><p>
После чего можете перезапустить начальный тест, чтобы убедиться, что скорость возросла в разы.

</p><h5>Решение для Linux</h5><p>
На самом деле вы также можете установить готовый дистрибутив </p><i>Anaconda</i><p>, </p><i>Canopy</i><p> или что-то другое сразу со всеми библиотеками. Но если предпочитаете собирать своими руками, то читайте дальше — там есть все рецепты.

</p><h3>Проверка библиотек</h3><p>
Как вы помните, возможны два варианта:

</p><ul>
<li>у вас установлены “олдскульные” (или “устаревшие”, кому как нравится) библиотеки (например, ATLAS);</li>
<li>у вас не установлены библиотеки, и numpy использует встроенную библиотеку (которая еще медленнее)</li>
</ul><p>
Если у вас стоит свежая версия </p><i>numpy</i><p> (&gt;1.10), то, зайдя в каталог, куда установлен numpy (обычно это </p><i>/usr/local/lib/python2.7/dist-packages/numpy</i><p>, но в зависимости от версии Linux и Python путь может меняться) и выполните следующие команды в консоли:

</p><pre><code class="bash">cd core
ldd multiarray.so
</code></pre><p>
В более ранних версиях </p><i>numpy</i><p> библиотеки </p><i>multiarray.so</i><p> нет, зато есть </p><i>_dotblas.so</i><p>:

</p><pre><code class="bash">ldd _dotblas.so
</code></pre><p>
Вывод команды </p><i>ldd</i><p> покажет вам, использует ли </p><i>numpy</i><p> сторонние библиотеки линейной алгебры.

</p><pre><code class="bash">linux-vdso.so.1 =&gt;  (0x00007fffe58a2000)
libm.so.6 =&gt; /lib/x86_64-linux-gnu/libm.so.6 (0x00007f8adbff4000)
libpthread.so.0 =&gt; /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007f8adbdd6000)
libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f8adba10000)
/lib64/ld-linux-x86-64.so.2 (0x00007f8adc68c000)
</code></pre><p>
Если в листинге вы не видите </p><i>libblas.so</i><p>, значит ваша </p><i>numpy</i><p> использует свою внутреннюю библиотеку. Если видите, значит у вас стоит ATLAS или BLAS.
</p><p>
В любом случае сначала вам нужна правильна библиотека линейной алгебры.

</p><h3>Установка OpenBLAS</h3><p>
OpenBLAS — хорошая библиотека алгоритмов и функций линейной алгебры, которые лежат в основе современных методов анализа данных и машинного обучения.
</p><p>
Прежде всего вам потребуется компилятор Фортрана, поскольку OpenBLAS не совместим со стандартным компилятором </p><i>g77</i><p>.

</p><pre><code class="bash">sudo apt-get install gfortran
</code></pre><p>
Загрузите OpenBLAS с github’а (предварительно вернувшись в подходящий для установки каталог):

</p><pre><code class="bash">git clone https://github.com/xianyi/OpenBLAS.git
</code></pre><p>
Теперь зайдите в каталог и запустите сборку:

</p><pre><code class="bash">cd OpenBLAS
make FC=gfortran
</code></pre><p>
Когда компиляция и сборка успешно завершатся, установите библиотеку.

</p><pre><code class="bash">sudo make install
</code></pre><p>
По умолчанию, библиотека будет установлена в </p><i>/opt/OpenBLAS</i><p>. Если вы хотите установить ее в другое место, запустите </p><i>make install</i><p> с ключом </p><i>PREFIX</i><p>:

</p><pre><code class="bash">sudo make install PREFIX=/your/preferred/location
</code></pre>
<h3>Переназначение библиотек</h3><p>
Если ранее вы выяснили, что у вас уже установлена какая-то библиотека линейной алгебры, то вам достаточно запустить команду переназначения библиотек:

</p><pre><code class="bash">sudo update-alternatives --install /usr/lib/libblas.so.3 libblas.so.3 \
	/opt/OpenBLAS/lib/libopenblas.so 50
</code></pre><p>
После этого OpenBLAS по умолчанию станет библиотекой линейной алегбры не только для </p><i>numpy</i><p>, а вообще для всех ваших программ и библиотек.
</p><p>
И снова запустите тест, чтобы увидеть, как у вас при вычислениях теперь задействованы все процессоры.

</p><h3>Собираем правильный numpy</h3><p>
Если у вас </p><i>numpy</i><p> работал на встроенной библиотеке, то вам придется его пересобрать, чтобы он подхватил только что установленный OpenBLAS.
</p><p>
Сначала избавьтесь от дефектной библиотеки:

</p><pre><code class="bash">sudo pip uninstall numpy
</code></pre><p>
После чего создайте в домашнем каталоге файл .numpy-site.cfg следующего содержания:

</p><pre><code class="bash">[default]
include_dirs = /opt/OpenBLAS/include
library_dirs = /opt/OpenBLAS/lib

[openblas]
openblas_libs = openblas
include_dirs = /opt/OpenBLAS/include
library_dirs = /opt/OpenBLAS/lib

[lapack]
lapack_libs = openblas

[atlas]
atlas_libs = openblas
libraries = openblas
</code></pre><p>
Если вы ранее выбрали нестандартное расположение для OpenBLAS, то измените пути в файле. А теперь установите </p><i>numpy</i><p> заново:

</p><pre><code class="bash">sudo pip install numpy
</code></pre><p>
Когда компиляция и установка завершатся, запустите начальный тест, чтобы убедиться, что теперь процессоры не простаивают. Вот и все.
      </p><p class="clear"/>
    </div>

    
  </div></body></html>