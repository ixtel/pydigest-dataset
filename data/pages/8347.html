<html><body><div><div class="content-body" itemprop="text articleBody">
      <img class="article-image img-responsive" alt="article header image" itemprop="image" src="http://pbpython.com/images/advanced-excel.png"/>
	<div class="section" id="introduction">
<h2>Introduction</h2>
<p>I have written several articles about using python and pandas to manipulate data and create useful
Excel output. In my experience, no matter how strong the python tools are, there are times when
you need to rely on more advanced Excel features to communicate your message or further analyze the
data. This article will walk through some additional improvements you can make to your
Excel-based output by:</p>
<ul class="simple">
<li>Adding Excel tables with <a class="reference external" href="http://xlsxwriter.readthedocs.org/">XlsxWriter</a></li>
<li>Inserting custom <span class="caps">VBA</span> into your Excel file</li>
<li>Using <span class="caps">COM</span> for merging multiple Excel worksheets</li>
</ul>
</div>
<div class="section" id="excel-tables">
<h2>Excel Tables</h2>
<p>In a <a class="reference external" href="http://pbpython.com/improve-pandas-excel-output.html">prior article</a>, I discussed how pandas works very seamlessly with XlsxWriter
to format your data and present it in a more complex manner than in the
standard pandas <code class="code">
to_excel()</code>
 format.</p>
<p>For a recent project, I wanted to add some more formatting to a fairly simple table
and discovered how useful this can be and how easy it is with XlsxWriter. I recommend reading
the <a class="reference external" href="http://xlsxwriter.readthedocs.org/working_with_tables.html">XlsxWriter documentation</a> for more background and details on all of the options.</p>
<p>For this example, I’ll be using the samples sales data I have used in the <a class="reference external" href="http://pbpython.com/pandas-release-17.html">past</a>.
This data is meant to show a simple data dump of sales to multiple customers over time.
Let’s summarize the data to see how much each customer purchased and what their
average purchase amount was:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>

<span class="n">sales_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s">'https://github.com/chris1610/pbpython/blob/master/data/sample-salesv3.xlsx?raw=true'</span><span class="p">)</span>
<span class="n">sales_summary</span> <span class="o">=</span> <span class="n">sales_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">'name'</span><span class="p">])[</span><span class="s">'ext price'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s">'sum'</span><span class="p">,</span> <span class="s">'mean'</span><span class="p">])</span>
<span class="c"># Reset the index for consistency when saving in Excel</span>
<span class="n">sales_summary</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">writer</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="s">'sales_summary.xlsx'</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s">'xlsxwriter'</span><span class="p">)</span>
<span class="n">sales_summary</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="s">'summary'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">writer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
<p>The standard Excel output looks like this:</p>

<p>This is useful but not very impressive.</p>
<p>If we want to turn this into an actual Excel Table, we can do that pretty easily using the
<code class="code">
add_table</code>
 function in XlsxWriter. I typically create a <code class="code">
format_excel</code>
 function to
keep the formatting in one place. Here is what the formatting function would look like:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">format_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">):</span>
    <span class="sd">""" Add Excel specific formatting to the workbook</span>
<span class="sd">    """</span>
    <span class="c"># Get the workbook and the summary sheet so we can add the formatting</span>
    <span class="n">workbook</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">book</span>
    <span class="n">worksheet</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">sheets</span><span class="p">[</span><span class="s">'summary'</span><span class="p">]</span>
    <span class="c"># Add currency formatting and apply it</span>
    <span class="n">money_fmt</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s">'num_format'</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span> <span class="s">'align'</span><span class="p">:</span> <span class="s">'center'</span><span class="p">})</span>
    <span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s">'A:A'</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
    <span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s">'B:C'</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">money_fmt</span><span class="p">)</span>
    <span class="n">worksheet</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span><span class="s">'A1:C22'</span><span class="p">,</span> <span class="p">{</span><span class="s">'columns'</span><span class="p">:</span> <span class="p">[{</span><span class="s">'header'</span><span class="p">:</span> <span class="s">'account'</span><span class="p">,</span>
                                                <span class="s">'total_string'</span><span class="p">:</span> <span class="s">'Total'</span><span class="p">},</span>
                                               <span class="p">{</span><span class="s">'header'</span><span class="p">:</span> <span class="s">'Total Sales'</span><span class="p">,</span>
                                                <span class="s">'total_function'</span><span class="p">:</span> <span class="s">'sum'</span><span class="p">},</span>
                                               <span class="p">{</span><span class="s">'header'</span><span class="p">:</span> <span class="s">'Average Sales'</span><span class="p">,</span>
                                                <span class="s">'total_function'</span><span class="p">:</span> <span class="s">'average'</span><span class="p">}],</span>
                                   <span class="s">'autofilter'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                                   <span class="s">'total_row'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                                   <span class="s">'style'</span><span class="p">:</span> <span class="s">'Table Style Medium 20'</span><span class="p">})</span>
</pre></div>
<p>Applying the function is straightforward:</p>
<div class="highlight"><pre><span class="n">sales_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s">'https://github.com/chris1610/pbpython/blob/master/data/sample-salesv3.xlsx?raw=true'</span><span class="p">)</span>
<span class="n">sales_summary</span> <span class="o">=</span> <span class="n">sales_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">'name'</span><span class="p">])[</span><span class="s">'ext price'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s">'sum'</span><span class="p">,</span> <span class="s">'mean'</span><span class="p">])</span>
<span class="c"># Reset the index for consistency when saving in Excel</span>
<span class="n">sales_summary</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">writer</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="s">'sales_summary.xlsx'</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s">'xlsxwriter'</span><span class="p">)</span>
<span class="n">sales_summary</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="s">'summary'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">format_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">)</span>
<span class="n">writer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
<p>Here is what the new and improved output looks like:</p>

<p>Using tables in Excel is a really good way to add totals or other summary stats
to your data. They are also a quick tool to format the output for better display.
I encourage you to read through the XlsxWriter documentation to learn about all the
options you have with table formatting. It is a very powerful option and easy to use
with pandas.</p>
<p>For reference, the <a class="reference external" href="https://github.com/chris1610/pbpython/blob/master/code/advanced_excel.py">full script</a> is on github.</p>
</div>
<div class="section" id="adding-vba-to-your-excel">
<h2>Adding <span class="caps">VBA</span> to your Excel</h2>
<p>I recently created an interactive Excel workbook via the tools I have talked
about on this blog. I wanted to add a small snippet of <span class="caps">VBA</span> to the resulting file
but was not sure exactly how to do this. Fortunately XlsxWriter saves us again with the ability
to extract <span class="caps">VBA</span> from an existing file into a standalone binary file and insert
insert in another file. The <a class="reference external" href="http://xlsxwriter.readthedocs.org/working_with_macros.html">Working with <span class="caps">VBA</span> Macros</a> documentation is pretty clear
but here is a quick sample.</p>
<p>Use the <code class="code">
vba_extract.py</code>
 file (included with XlsxWriter) to strip out the <span class="caps">VBA</span> from an existing Excel file:</p>
<div class="highlight"><pre>vba_extract.py source_file.xlsm
Extracted vbaProject.bin
</pre></div>
<p>Using similar code to the example above, here is how to add this file into your
Excel output.</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>

<span class="n">sales_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s">'https://github.com/chris1610/pbpython/blob/master/data/sample-salesv3.xlsx?raw=true'</span><span class="p">)</span>
<span class="n">sales_summary</span> <span class="o">=</span> <span class="n">sales_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">'name'</span><span class="p">])[</span><span class="s">'ext price'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s">'sum'</span><span class="p">,</span> <span class="s">'mean'</span><span class="p">])</span>
<span class="c"># Reset the index for consistency when saving in Excel</span>
<span class="n">sales_summary</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">writer</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="s">'sales_summary.xlsx'</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s">'xlsxwriter'</span><span class="p">)</span>
<span class="n">sales_summary</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="s">'summary'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">workbook</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">book</span>
<span class="n">workbook</span><span class="o">.</span><span class="n">add_vba_project</span><span class="p">(</span><span class="s">'vbaProject.bin'</span><span class="p">)</span>
<span class="n">writer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
<p>Astute readers will notice that the output is saved as a .<span class="caps">XLSX</span> file but Excel
will need the file to have an .<span class="caps">XLSM</span> extension in order for it to execute the <span class="caps">VBA</span> code.</p>
<p>Unfortunately if you try to save it as an <span class="caps">XLSM</span> like this:</p>
<div class="highlight"><pre><span class="n">writer</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="s">'sales_summary.xlsm'</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s">'xlsxwriter'</span><span class="p">)</span>
</pre></div>
<p>You get this error:</p>
<div class="highlight"><pre><span class="ne">ValueError</span><span class="p">:</span> <span class="n">Invalid</span> <span class="n">extension</span> <span class="k">for</span> <span class="n">engine</span> <span class="s">'xlsxwriter'</span><span class="p">:</span> <span class="s">'xlsm'</span>
</pre></div>
<p>One solution is to rename the file using <code class="code">
os.rename</code>
 but another (simpler)
option is to assign the desired name to the filename attribute:</p>
<div class="highlight"><pre><span class="n">writer</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="s">'sales_summary.xlsx'</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s">'xlsxwriter'</span><span class="p">)</span>
<span class="n">sales_summary</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="s">'summary'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">workbook</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">book</span>
<span class="n">workbook</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="s">'sales_summary.xlsm'</span>
<span class="n">workbook</span><span class="o">.</span><span class="n">add_vba_project</span><span class="p">(</span><span class="s">'vbaProject.bin'</span><span class="p">)</span>
<span class="n">writer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
<p>This approach feels a little hackish but is the simplest fix for this issue.
Even with this minor inconvenience, this is a really powerful feature that
will allow you to make really robust Excel-based solutions with your python scripts.</p>
</div>
<div class="section" id="copying-excel-worksheets-using-com">
<h2>Copying Excel Worksheets using <span class="caps">COM</span></h2>
<p>XlsxWriter allows you to create an Excel file from scratch but it does not support
copying data from an existing workbook and including it in a new file. The
best way to do this is to use win32com to automate that portion of Excel. The downside
to this approach is that you can only use win32com on a Windows <span class="caps">OS</span> but if you find yourself
in the situation where you want to merge two files together, at least there are options.</p>
<p>One of the main reasons I would use this approach is for when I have a sheet with
a lot of complex formatting or structure that is easy to change in Excel but difficult
to program with XlsxWriter. You can choose to created your “template” file and merge
it it with the custom work you may have done in python.</p>
<p>This example is based on this Stack Overflow <a class="reference external" href="http://stackoverflow.com/questions/26935793/python-2-7-win32com-client-move-a-worksheet-from-one-workbook-to-another">response</a>. The purpose of the code
is to copy in a standard “Instructions” sheet into the sales_summary file we created
using pandas.</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">win32com.client</span> <span class="kn">import</span> <span class="n">DispatchEx</span>

<span class="n">excel</span> <span class="o">=</span> <span class="n">DispatchEx</span><span class="p">(</span><span class="s">'Excel.Application'</span><span class="p">)</span>
<span class="n">excel</span><span class="o">.</span><span class="n">Visible</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">workbook_1</span> <span class="o">=</span> <span class="n">excel</span><span class="o">.</span><span class="n">Workbooks</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s">r'C:\full\path\to\sales_summary.xlsx'</span><span class="p">)</span>
<span class="n">workbook_2</span> <span class="o">=</span> <span class="n">excel</span><span class="o">.</span><span class="n">Workbooks</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s">r'C:\full\path\to\sales_template.xlsx'</span><span class="p">)</span>
<span class="n">workbook_2</span><span class="o">.</span><span class="n">Worksheets</span><span class="p">(</span><span class="s">"Instructions"</span><span class="p">)</span><span class="o">.</span><span class="n">Move</span><span class="p">(</span><span class="n">Before</span><span class="o">=</span><span class="n">workbook_1</span><span class="o">.</span><span class="n">Worksheets</span><span class="p">(</span><span class="s">"summary"</span><span class="p">))</span>
<span class="n">workbook_1</span><span class="o">.</span><span class="n">SaveAs</span><span class="p">(</span><span class="s">r'C:\full\path\to\sales_summary_complete.xlsx'</span><span class="p">)</span>
<span class="n">excel</span><span class="o">.</span><span class="n">Application</span><span class="o">.</span><span class="n">Quit</span><span class="p">()</span>
<span class="k">del</span> <span class="n">excel</span>
</pre></div>
<p>There are a couple of things to keep in mind with this code:</p>
<ul class="simple">
<li>You need to have pywin32 installed - I recommend using <a class="reference external" href="https://www.continuum.io/downloads">anaconda</a> for your python distribution</li>
<li>You need to use the full path to the Excel files</li>
<li>When you save the new file, Excel may pop up a dialog box asking you to verify that it can overwrite the existing file. You should handle that appropriately in your script</li>
</ul>
<p>I personally find that working with win32com is finicky so I try to minimize it but
it is a handy tool to have in your coding arsenal.</p>
</div>
<div class="section" id="summary">
<h2>Summary</h2>
<p>Like any tool, Excel can be abused and can result in some unmaintainable worksheets “from hell.”
However, just because Excel can be a problem, you should recognize when it is the right solution
for your business situation. Excel will continue to have a dominant place in the business software ecosystem.
This article should help you further improve the quality of the Excel-based solutions you
develop with python and pandas.</p>
</div>
<div class="section" id="updates">
<h2>Updates</h2>
<ul class="simple">
<li>12-7-2015 - Updated code on github so that the table size is dynamically calculated.</li>
</ul>
</div>

  </div>
  
</div></body></html>