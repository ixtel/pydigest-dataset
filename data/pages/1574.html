<html><body><div><section class="body">
        <p>Note: this post turned out to be far more complicated than I had hoped. I may write another one that deals with a less complicated type!</p>

<p><a href="http://www.postgresql.org">Postgres</a> comes with a pretty large range of column types, and the ability to use these types in an ARRAY. There’s also <a href="http://www.postgresql.org/docs/9.4/static/datatype-json.html">JSON(B)</a> and <a href="http://www.postgresql.org/docs/9.4/static/hstore.html">Hstore</a>, which are useful for storing structured (but possibly varying) data. Additionally, there are also a range of, well, <a href="http://www.postgresql.org/docs/9.4/static/rangetypes.html"><code>range</code></a> types.</p>

<p>However, sometimes you actually want to store data in a strict column, but that isn’t a simple scalar type, or one of the standard range types. Postgres allows you to define your own composite types.</p>

<p>There is a command <a href="http://www.postgresql.org/docs/9.2/static/sql-createtype.html"><code>CREATE TYPE</code></a> that can be used to create an arbitrary type. There are four forms: for now we will just look at Composite Types.</p>

<p>We will create a Composite type that represents the opening hours for a store, or more specifically, the default opening hours. For instance, a store may have the following default opening hours:</p>

<div class="highlight"><pre><code class="text">+------------+--------+---------+
|    Day     |  Open  |  Close  |
+------------+--------+---------+
|  Monday    |  9 am  |  5 pm   |
|  Tuesday   |  9 am  |  5 pm   |
|  Wednesday |  9 am  |  5 pm   |
|  Thursday  |  9 am  |  9 pm   |
|  Friday    |  9 am  |  5 pm   |
|  Saturday  | 10 am  |  5 pm   |
|  Sunday    | 11 am  |  5 pm   |
+------------+--------+---------+
</code></pre>
</div>

<p>During the Christmas season this store may be open longer (perhaps even 24 hours). There may also be differences at Easter time, or other public holidays, where the store is closed, or closes early.</p>

<p>It would be nice to be able to store the default opening hours for a store, and then, when creating a week, use these to create concrete (<code>TIMESTAMP</code>) values for each day, which could be overridden on any given day.</p>

<p>There are a few ways we could model this. Postgres has no <code>timerange</code> type, so that’s out. We could create a <code>RANGE</code> type, or we could use (<code>start-time</code>, <code>finish-time</code>). But what about when a store is open after midnight, or for 24 hours? Storing this data implicitly is a real pain, because you need to <em>always</em> check to see if the finish time is less than (or equal to) the start time whenever doing anything. Trust me, this is not the best approach.</p>

<p>An alternative I’ve been toying with is (<code>start-time</code>, <code>interval</code>). You could limit it so that the interval’s maximum is <code>'1 day'</code>, but not (from what I can tell) when you define the type. Anyway, the syntax for creating this type is:</p>

<div class="highlight"><pre><code class="sql"><span class="k">CREATE</span> <span class="k">TYPE</span> <span class="n">opening_hours</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">start</span> <span class="n">time</span><span class="p">,</span>
  <span class="k">length</span> <span class="nb">interval</span>
<span class="p">);</span>
</code></pre>
</div>

<p>As an aside, every table in the database also has an associated type (of the same name as the table).</p>

<p>Now, we have our type: we can use it in a table:</p>

<div class="highlight"><pre><code class="sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">store</span> <span class="p">(</span>
  <span class="n">store_id</span> <span class="nb">SERIAL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
  <span class="n">name</span> <span class="nb">TEXT</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">default_opening_hours</span> <span class="p">(</span>
  <span class="n">store_id</span> <span class="nb">INTEGER</span> <span class="k">REFERENCES</span> <span class="n">store</span> <span class="p">(</span><span class="n">store_id</span><span class="p">),</span>
  <span class="n">monday</span> <span class="n">opening_hours</span><span class="p">,</span>
  <span class="n">tuesday</span> <span class="n">opening_hours</span><span class="p">,</span>
  <span class="n">wednesday</span> <span class="n">opening_hours</span><span class="p">,</span>
  <span class="n">thursday</span> <span class="n">opening_hours</span><span class="p">,</span>
  <span class="n">friday</span> <span class="n">opening_hours</span><span class="p">,</span>
  <span class="n">saturday</span> <span class="n">opening_hours</span><span class="p">,</span>
  <span class="n">sunday</span> <span class="n">opening_hours</span>
<span class="p">);</span>
</code></pre>
</div>

<p>An alternative way of storing this information might be to use an array of <code>opening_hours</code>, directly on the store model. We’ll use this one instead, as it’s a little neater (and means we will look at how to use <code>opening_hours[]</code> later too).</p>

<div class="highlight"><pre><code class="sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">store</span> <span class="p">(</span>
  <span class="n">store_id</span> <span class="nb">SERIAL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
  <span class="n">name</span> <span class="nb">TEXT</span><span class="p">,</span>
  <span class="n">default_opening_hours</span> <span class="n">opening_hours</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
<span class="p">);</span>
</code></pre>
</div>

<p>Now, we can put data in there:</p>

<div class="highlight"><pre><code class="sql"><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">store</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default_opening_hours</span><span class="p">)</span> <span class="k">VALUES</span>
<span class="p">(</span>
  <span class="s1">'John Martins'</span><span class="p">,</span>
  <span class="nb">ARRAY</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">'09:00'</span><span class="p">,</span> <span class="s1">'08:00'</span><span class="p">)::</span><span class="n">opening_hours</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">'09:00'</span><span class="p">,</span> <span class="s1">'08:00'</span><span class="p">)::</span><span class="n">opening_hours</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">'09:00'</span><span class="p">,</span> <span class="s1">'08:00'</span><span class="p">)::</span><span class="n">opening_hours</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">'09:00'</span><span class="p">,</span> <span class="s1">'12:00'</span><span class="p">)::</span><span class="n">opening_hours</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">'09:00'</span><span class="p">,</span> <span class="s1">'08:00'</span><span class="p">)::</span><span class="n">opening_hours</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">'10:00'</span><span class="p">,</span> <span class="s1">'07:00'</span><span class="p">)::</span><span class="n">opening_hours</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">'11:00'</span><span class="p">,</span> <span class="s1">'06:00'</span><span class="p">)::</span><span class="n">opening_hours</span>
  <span class="p">]</span>
<span class="p">);</span>
</code></pre>
</div>

<p>Note how we need to cast all of the values from <code>record</code> to <code>opening_hours</code>.</p>

<hr/>

<p>In practice, we would probably also want to have some type of restriction where the opening time from one day, plus the default open hours is less than or equal to the starting time on the next day. I’m still not sure of the best way to do this in Postgres, but it is possible to do it in Django.</p>

<hr/>

<p>Speaking of <a href="https://www.djangoproject.com">Django</a>, we want to be able to access this data type there. We can leverage a really nice feature of Psycopg2 to have these values automatically turned into a Python namedtuple. We do this by registering the type within Psycopg2, using the Django cursor.</p>

<div class="highlight"><pre><code class="python"><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">connection</span>
<span class="kn">from</span> <span class="nn">psycopg2.extras</span> <span class="kn">import</span> <span class="n">register_composite</span>

<span class="n">register_composite</span><span class="p">(</span><span class="s">'opening_hours'</span><span class="p">,</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span><span class="o">.</span><span class="n">cursor</span><span class="p">)</span>
</code></pre>
</div>

<p>But, this is only half of the pattern. We also need to register an adapter so that values going back the other way are also automatically cast into <code>opening_hours</code>.</p>

<div class="highlight"><pre><code class="python"><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">connection</span>
<span class="kn">from</span> <span class="nn">psycopg2.extras</span> <span class="kn">import</span> <span class="n">register_composite</span>
<span class="kn">from</span> <span class="nn">psycopg2.extensions</span> <span class="kn">import</span> <span class="n">register_adapter</span><span class="p">,</span> <span class="n">adapt</span><span class="p">,</span> <span class="n">AsIs</span>

<span class="c"># Get a reference to the namedtuple class</span>
<span class="n">OpeningHours</span> <span class="o">=</span> <span class="n">register_composite</span><span class="p">(</span>
  <span class="s">'opening_hours'</span><span class="p">,</span>
  <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span><span class="o">.</span><span class="n">cursor</span><span class="p">,</span>
  <span class="n">globally</span><span class="o">=</span><span class="bp">True</span>
<span class="p">)</span><span class="o">.</span><span class="n">type</span>

<span class="k">def</span> <span class="nf">adapt_opening_hours</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">AsIs</span><span class="p">(</span><span class="s">"(</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">)::opening_hours"</span> <span class="o">%</span> <span class="p">(</span>
    <span class="n">adapt</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">getquoted</span><span class="p">(),</span>
    <span class="n">adapt</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">length</span><span class="p">)</span><span class="o">.</span><span class="n">getquoted</span><span class="p">()</span>
  <span class="p">))</span>

<span class="n">register_adapter</span><span class="p">(</span><span class="n">OpeningHours</span><span class="p">,</span> <span class="n">adapt_opening_hours</span><span class="p">)</span>
</code></pre>
</div>

<p>Now, we can fetch data from the database, and know that we will get <code>OpeningHours</code> instances, and, when passing an <code>OpeningHours</code> instance back to the database, know it will be converted into the correct type.</p>

<p>Obviously, in order to do this, the type must exist in the database. We did that manually in this case. In a real situation you would want to do that as a database migration. And that is where things get tricky. You can’t run the <code>register_adapter</code> function until the type exists in the database. I did come up with a relatively neat workaround for this when writing a framework for generic Composite fields, where the registration of the composite type attempts to execute, and if it fails, it stores the data for later registration, and then the actual migration operation fires off a signal, which is handled by a listener that actually performs the registration.</p>

<p>The final piece of the puzzle is the Django Field subclass, which is actually not that complicated. In essence, we are relying on Psycopg to handle the adaptation in both directions, so it can be a bare field (perhaps with a <code>formfield</code> method to get a custom form field). In practice, I wrote the generic CompositeField subclass, which uses some metaclass magic to handle the late registration:</p>

<div class="highlight"><pre><code class="python"><span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">fields</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">connection</span>
<span class="kn">from</span> <span class="nn">django.dispatch</span> <span class="kn">import</span> <span class="n">receiver</span><span class="p">,</span> <span class="n">Signal</span>

<span class="kn">from</span> <span class="nn">psycopg2.extras</span> <span class="kn">import</span> <span class="n">register_composite</span>
<span class="kn">from</span> <span class="nn">psycopg2.extensions</span> <span class="kn">import</span> <span class="n">register_adapter</span><span class="p">,</span> <span class="n">adapt</span><span class="p">,</span> <span class="n">AsIs</span>
<span class="kn">from</span> <span class="nn">psycopg2</span> <span class="kn">import</span> <span class="n">ProgrammingError</span>


<span class="n">_missing_types</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">class</span> <span class="nc">CompositeMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">clsdict</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CompositeMeta</span><span class="p">,</span> <span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">clsdict</span><span class="p">)</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">register_composite</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">register_composite</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="n">db_type</span> <span class="o">=</span> <span class="n">cls</span><span class="p">()</span><span class="o">.</span><span class="n">db_type</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">db_type</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cls</span><span class="o">.</span><span class="n">python_type</span> <span class="o">=</span> <span class="n">register_composite</span><span class="p">(</span>
                    <span class="n">db_type</span><span class="p">,</span>
                    <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span><span class="o">.</span><span class="n">cursor</span><span class="p">,</span>
                    <span class="n">globally</span><span class="o">=</span><span class="bp">True</span>
                <span class="p">)</span><span class="o">.</span><span class="n">type</span>
            <span class="k">except</span> <span class="n">ProgrammingError</span><span class="p">:</span>
                <span class="n">_missing_types</span><span class="p">[</span><span class="n">db_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">cls</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">adapt_composite</span><span class="p">(</span><span class="n">composite</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">AsIs</span><span class="p">(</span><span class="s">"(</span><span class="si">%s</span><span class="s">)::</span><span class="si">%s</span><span class="s">"</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="s">", "</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                            <span class="n">adapt</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">composite</span><span class="p">,</span> <span class="n">field</span><span class="p">))</span><span class="o">.</span><span class="n">getquoted</span><span class="p">()</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">composite</span><span class="o">.</span><span class="n">_fields</span>
                        <span class="p">]),</span> <span class="n">db_type</span>
                    <span class="p">))</span>

                <span class="n">register_adapter</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">python_type</span><span class="p">,</span> <span class="n">adapt_composite</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CompositeField</span><span class="p">(</span><span class="n">fields</span><span class="o">.</span><span class="n">Field</span><span class="p">):</span>
    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">CompositeMeta</span>
    <span class="sd">"""</span>
<span class="sd">    A handy base class for defining your own composite fields.</span>

<span class="sd">    It registers the composite type.</span>
<span class="sd">    """</span>


<span class="n">composite_type_created</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="n">providing_args</span><span class="o">=</span><span class="p">[</span><span class="s">'name'</span><span class="p">])</span>

<span class="nd">@receiver</span><span class="p">(</span><span class="n">composite_type_created</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">register_composite_late</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">db_type</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">_missing_types</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">db_type</span><span class="p">)</span><span class="o">.</span><span class="n">register_composite</span><span class="p">()</span>
</code></pre>
</div>

<p>We also want to have a custom migration operation:</p>

<div class="highlight"><pre><code class="python"><span class="kn">from</span> <span class="nn">django.db.migrations.operations.base</span> <span class="kn">import</span> <span class="n">Operation</span>

<span class="c"># Or wherever the code above is located.</span>
<span class="kn">from</span> <span class="nn">.fields.composite</span> <span class="kn">import</span> <span class="n">composite_type_created</span>


<span class="k">class</span> <span class="nc">CreateCompositeType</span><span class="p">(</span><span class="n">Operation</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">reversible</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">state_forwards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">database_forwards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">schema_editor</span><span class="p">,</span> <span class="n">from_state</span><span class="p">,</span> <span class="n">to_state</span><span class="p">):</span>
        <span class="n">schema_editor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'CREATE TYPE </span><span class="si">%s</span><span class="s"> AS (</span><span class="si">%s</span><span class="s">)'</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">", "</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">"</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">"</span> <span class="o">%</span> <span class="n">field</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">])</span>
        <span class="p">))</span>
        <span class="n">composite_type_created</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">db_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">state_backwards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">database_backwards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">schema_editor</span><span class="p">,</span> <span class="n">from_state</span><span class="p">,</span> <span class="n">to_state</span><span class="p">):</span>
        <span class="n">schema_editor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'DROP TYPE </span><span class="si">%s</span><span class="s">'</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</code></pre>
</div>

<p>This is a bit manual, however. You need to create your own migration that creates the composite type, and then begin to use the field.</p>

<div class="highlight"><pre><code class="python"><span class="c"># migrations/XXXX_create_opening_hours.py</span>

<span class="k">class</span> <span class="nc">Migration</span><span class="p">(</span><span class="n">migrations</span><span class="o">.</span><span class="n">Migration</span><span class="p">):</span>
    <span class="n">dependencies</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">operations</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">CreateCompositeType</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s">'opening_hours'</span><span class="p">,</span>
            <span class="n">fields</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="s">'start'</span><span class="p">,</span> <span class="s">'time'</span><span class="p">),</span>
                <span class="p">(</span><span class="s">'length'</span><span class="p">,</span> <span class="s">'interval'</span><span class="p">)</span>
            <span class="p">],</span>
        <span class="p">),</span>
    <span class="p">]</span>
</code></pre>
</div>

<p>The place this pattern falls down is that this migration must be manually created: we don’t have any way to automatically create the migration from the Field subclass, which just looks like:</p>

<div class="highlight"><pre><code class="python"><span class="k">class</span> <span class="nc">OpeningHoursField</span><span class="p">(</span><span class="n">CompositeField</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">db_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">'opening_hours'</span>

    <span class="k">def</span> <span class="nf">formfield</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'form_class'</span><span class="p">:</span> <span class="n">OpeningHoursFormField</span>
        <span class="p">}</span>
        <span class="n">defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">OpeningHoursField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">formfield</span><span class="p">(</span><span class="o">**</span><span class="n">defaults</span><span class="p">)</span>
</code></pre>
</div>

<p>I think in the future I’ll attempt to use further metaclass magic to allow defining the fields of the Composite type. This could then be used to automatically create a form field (which is a subclass of <code>forms.MultiValueField</code>).</p>

<div class="highlight"><pre><code class="python"><span class="k">class</span> <span class="nc">OpeningHoursField</span><span class="p">(</span><span class="n">CompositeField</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">()</span>
    <span class="n">length</span> <span class="o">=</span> <span class="n">IntervalField</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">db_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">'opening_hours'</span>
</code></pre>
</div>

<p>However, in the meantime, we can still get by. I’m not sure it’s going to be possible to inject extra operations into the migration based upon the field types anyway.</p>

<p>Finally, we can use this in a model:</p>

<div class="highlight"><pre><code class="python"><span class="k">class</span> <span class="nc">Store</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">store_id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">AutoField</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
    <span class="n">default_opening_hours</span> <span class="o">=</span> <span class="n">ArrayField</span><span class="p">(</span>
        <span class="n">base_field</span><span class="o">=</span><span class="n">OpeningHoursField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
        <span class="n">size</span><span class="o">=</span><span class="mi">7</span>
    <span class="p">)</span>
</code></pre>
</div>

<p>I’ve used the <code>ArrayField</code> from <a href="https://docs.djangoproject.com/en/dev/ref/contrib/postgres/">django.contrib.postgres</a>, purely for illustration purposes.</p>

<p>The <code>CompositeField</code> and associated operation are part of my <a href="https://bitbucket.org/schinckel/django-postgres/">django-postgres</a> project: once I have worked out some more kinks, I may submit a pull request to <code>django.contrib.postgres</code>, unless someone else beats me to it.</p>

<p>Oh, and a juicy little extra. Above I mentioned something about preventing overlaps. The logic I use in my form is:</p>

<div class="highlight"><pre><code class="python"><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>
<span class="kn">from</span> <span class="nn">django.utils.translation</span> <span class="kn">import</span> <span class="n">string_concat</span><span class="p">,</span> <span class="n">ugettext_lazy</span> <span class="k">as</span> <span class="n">_</span>

<span class="kn">import</span> <span class="nn">postgres.forms</span>

<span class="kn">from</span> <span class="nn">.fields</span> <span class="kn">import</span> <span class="n">OpeningHoursFormField</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Store</span>


<span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="s">"Given an OpeningHours value, get the finish time"</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="o">+</span> <span class="n">obj</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">StoreForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">ModelForm</span><span class="p">):</span>
    <span class="n">OVERLAPS_PREVIOUS</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">'Open hours overlap previous day.'</span><span class="p">)</span>

    <span class="n">default_opening_hours</span> <span class="o">=</span> <span class="n">postgres</span><span class="o">.</span><span class="n">forms</span><span class="o">.</span><span class="n">SplitArrayField</span><span class="p">(</span>
        <span class="n">base_field</span><span class="o">=</span><span class="n">OpeningHoursFormField</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
        <span class="n">size</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Store</span>

    <span class="k">def</span> <span class="nf">clean_default_opening_hours</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">opening_hours</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">'default_opening_hours'</span><span class="p">]</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s">'default_opening_hours'</span><span class="p">]</span>

        <span class="c"># Ensure consecutive days do not overlap.</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
            <span class="n">today</span> <span class="o">=</span> <span class="n">opening_hours</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">today</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">today</span><span class="o">.</span><span class="n">duration</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">yesterday</span> <span class="o">=</span> <span class="n">opening_hours</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">yesterday</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">yesterday</span><span class="o">.</span><span class="n">duration</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">finish</span><span class="p">(</span><span class="n">yesterday</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">yesterday</span><span class="o">.</span><span class="n">start</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">today</span><span class="o">.</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">finish</span><span class="p">(</span><span class="n">yesterday</span><span class="p">):</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                        <span class="n">string_concat</span><span class="p">(</span>
                          <span class="n">field</span><span class="o">.</span><span class="n">error_messages</span><span class="p">[</span><span class="s">'item_invalid'</span><span class="p">],</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">OVERLAPS_PREVIOUS</span>
                        <span class="p">),</span>
                        <span class="n">code</span><span class="o">=</span><span class="s">'item_invalid'</span><span class="p">,</span>
                        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s">'nth'</span><span class="p">:</span> <span class="n">i</span><span class="p">}</span>
                    <span class="p">))</span>

        <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">forms</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">opening_hours</span>
</code></pre>
</div>

<p>I’m currently not displaying the duration/length: I dynamically calculate it based on the entered start/finish pair, but that’s getting quite complicated.</p>

    </section>
    </div></body></html>