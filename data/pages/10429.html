<html><body><div><p>A Python port of Github's Scientist lib.</p>








<div id="but-how">
<h2>But how?</h2>
<p>Imagine you’ve implemented a complex caching strategy for some objects in your
database and a stale cache is simply not acceptable.  How could you test this
and ensure parity with your previous implementation, under load, with
production data?  Run it in production!</p>
<p>Laboratory will:</p>
<ul>
<li>Run both the new and the old code</li>
<li>Compare their results</li>
<li>Record timing information about all code</li>
<li>Swallow and record exceptions in the new code</li>
<li>Publish all of this information</li>
</ul>
<p>Of course, you’re still unsure your candidate code works correctly, so
laboratory will always return the result from the control block.</p>
<pre><span class="kn">import</span> <span class="nn">laboratory</span>

<span class="n">experiment</span> <span class="o">=</span> <span class="n">laboratory</span><span class="o">.</span><span class="n">Experiment</span><span class="p">()</span>
<span class="k">with</span> <span class="n">experiment</span><span class="o">.</span><span class="n">control</span><span class="p">()</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
    <span class="n">c</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="n">get_objects_from_database</span><span class="p">())</span>

<span class="k">with</span> <span class="n">experiment</span><span class="o">.</span><span class="n">candidate</span><span class="p">()</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
    <span class="n">c</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="n">get_objects_from_cache</span><span class="p">())</span>

<span class="n">objects</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre>
<p>Note that the <tt>Experiment</tt> class can also be used as a decorator.</p>
<pre><span class="nd">@Experiment</span><span class="p">(</span><span class="n">candidate</span><span class="o">=</span><span class="n">get_objects_from_cache</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_objects_from_database</span><span class="p">():</span>
    <span class="k">return</span> <span class="bp">True</span>
</pre>
</div>
<div id="publishing-results">
<h2>Publishing results</h2>
<p>This data is useless unless we can do something with it. Laboratory makes no
assumptions about how to do this — it’s entirely for you to implement to suit
your needs.  For example, timing data can be sent to graphite, and mismatches
can be placed in a capped collection in redis for debugging later.</p>
<p>The publish method is passed a <tt>Result</tt> instance, with control and candidate
data is available in <tt>Result.control</tt> and <tt>Result.observations</tt>
respectively.</p>
<pre><span class="k">class</span> <span class="nc">MyExperiment</span><span class="p">(</span><span class="n">laboratory</span><span class="o">.</span><span class="n">Experiment</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">publish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="n">statsd</span><span class="o">.</span><span class="n">timing</span><span class="p">(</span><span class="s1">'MyExperiment.control'</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">observations</span><span class="p">:</span>
            <span class="n">statsd</span><span class="o">.</span><span class="n">timing</span><span class="p">(</span><span class="s1">'MyExperiment.</span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="n">o</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span>
</pre>
</div>
<div id="controlling-comparison">
<h2>Controlling comparison</h2>
<p>Not all data is created equal. By default laboratory compares using <tt>==</tt>, but
sometimes you may need to tweak this to suit your needs.  It’s easy enough —
just subclass <tt>Experiment</tt> and implement the <tt>compare(control,
observation)</tt> method.</p>
<pre><span class="k">class</span> <span class="nc">MyExperiment</span><span class="p">(</span><span class="n">Experiment</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">observation</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">control</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span> <span class="o">==</span> <span class="n">observation</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span>
</pre>
</div>
<div id="adding-context">
<h2>Adding context</h2>
<p>A lot of the time there’s going to be extra context around an experiment that’s
useful to use in publishing or comparisons.  You can set this data in a few
ways.</p>
<pre><span class="c1"># The first is experiment-wide context, which will be set on every observation laboratory makes.</span>

<span class="n">experiment</span> <span class="o">=</span> <span class="n">laboratory</span><span class="o">.</span><span class="n">Experiment</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">'Object Cache Experiment'</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">'user'</span><span class="p">:</span> <span class="n">user</span><span class="p">})</span>


<span class="c1"># Observation-specific context can be updated before or as the experiment is running.</span>

<span class="k">with</span> <span class="n">experiment</span><span class="o">.</span><span class="n">control</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">'Object DB Strategy'</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">'using'</span><span class="p">:</span> <span class="s1">'db'</span><span class="p">})</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">e</span><span class="o">.</span><span class="n">update_context</span><span class="p">({</span><span class="s1">'uuid'</span><span class="p">:</span> <span class="n">uuid</span><span class="p">})</span>

    <span class="n">e</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span> <span class="c1"># ==</span>
    <span class="c1"># {</span>
    <span class="c1">#     'user': &lt;User&gt;,</span>
    <span class="c1">#     'uuid': 'c08d46f1-92a6-46e5-9185-82d90dcb5af1',</span>
    <span class="c1">#     'using': 'db',</span>
    <span class="c1"># }</span>


<span class="k">with</span> <span class="n">experiment</span><span class="o">.</span><span class="n">candidate</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">'Object Cache Strategy'</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">'using'</span><span class="p">:</span> <span class="s1">'cache'</span><span class="p">})</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">e</span><span class="o">.</span><span class="n">update_context</span><span class="p">({</span><span class="s1">'uuid'</span><span class="p">:</span> <span class="n">uuid</span><span class="p">})</span>

    <span class="n">e</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span> <span class="c1"># ==</span>
    <span class="c1"># {</span>
    <span class="c1">#     'user': &lt;User&gt;,</span>
    <span class="c1">#     'using': 'cache',</span>
    <span class="c1"># }</span>
</pre>
</div>
</div></body></html>