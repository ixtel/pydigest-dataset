<html><body><div><div id="example">
<h3>Example</h3>
<pre><span class="c1"># Server request handler</span>
<span class="n">async</span> <span class="k">def</span> <span class="nf">on_connected</span><span class="p">(</span><span class="n">proto</span><span class="p">):</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="c1"># Receive request</span>
        <span class="n">stream_id</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">await</span> <span class="n">proto</span><span class="o">.</span><span class="n">recv_request</span><span class="p">()</span>

        <span class="c1"># Send response headers</span>
        <span class="n">await</span> <span class="n">proto</span><span class="o">.</span><span class="n">send_headers</span><span class="p">(</span><span class="n">stream_id</span><span class="p">,</span> <span class="p">{</span><span class="s1">':status'</span><span class="p">:</span> <span class="s1">'200'</span><span class="p">})</span>

        <span class="c1"># Send some response</span>
        <span class="n">await</span> <span class="n">proto</span><span class="o">.</span><span class="n">send_data</span><span class="p">(</span><span class="n">stream_id</span><span class="p">,</span> <span class="n">b</span><span class="s1">'hello, '</span><span class="p">)</span>

        <span class="c1"># Read all request body</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">await</span> <span class="n">proto</span><span class="o">.</span><span class="n">read_stream</span><span class="p">(</span><span class="n">stream_id</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Send more response</span>
        <span class="n">await</span> <span class="n">proto</span><span class="o">.</span><span class="n">send_data</span><span class="p">(</span><span class="n">stream_id</span><span class="p">,</span> <span class="n">resp</span><span class="p">)</span>

        <span class="c1"># Send trailers</span>
        <span class="n">await</span> <span class="n">proto</span><span class="o">.</span><span class="n">send_headers</span><span class="p">(</span><span class="n">stream_id</span><span class="p">,</span> <span class="p">{</span><span class="s1">'len'</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">resp</span><span class="p">))},</span>
                                 <span class="n">end_stream</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># Start server on random port, with maximum concurrent requests of 3</span>
<span class="n">server</span> <span class="o">=</span> <span class="n">await</span> <span class="n">aioh2</span><span class="o">.</span><span class="n">start_server</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">on_connected</span><span class="p">(</span><span class="n">p</span><span class="p">)),</span>
    <span class="n">port</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">concurrency</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">port</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">sockets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># Open client connection</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">await</span> <span class="n">aioh2</span><span class="o">.</span><span class="n">open_connection</span><span class="p">(</span><span class="s1">'0.0.0.0'</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>

<span class="c1"># Start request with headers</span>
<span class="n">stream_id</span> <span class="o">=</span> <span class="n">await</span> <span class="n">client</span><span class="o">.</span><span class="n">start_request</span><span class="p">(</span>
    <span class="p">{</span><span class="s1">':method'</span><span class="p">:</span> <span class="s1">'GET'</span><span class="p">,</span> <span class="s1">':path'</span><span class="p">:</span> <span class="s1">'/index.html'</span><span class="p">})</span>

<span class="c1"># Send request body</span>
<span class="n">await</span> <span class="n">client</span><span class="o">.</span><span class="n">send_data</span><span class="p">(</span><span class="n">stream_id</span><span class="p">,</span> <span class="n">b</span><span class="s1">'world'</span><span class="p">,</span> <span class="n">end_stream</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># Receive response</span>
<span class="n">headers</span> <span class="o">=</span> <span class="n">await</span> <span class="n">client</span><span class="o">.</span><span class="n">recv_response</span><span class="p">(</span><span class="n">stream_id</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>

<span class="c1"># Read all response body</span>
<span class="n">resp</span> <span class="o">=</span> <span class="n">await</span> <span class="n">client</span><span class="o">.</span><span class="n">read_stream</span><span class="p">(</span><span class="n">stream_id</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>

<span class="c1"># Read response trailers</span>
<span class="n">trailers</span> <span class="o">=</span> <span class="n">await</span> <span class="n">client</span><span class="o">.</span><span class="n">recv_trailers</span><span class="p">(</span><span class="n">stream_id</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">trailers</span><span class="p">)</span>
</pre>
</div>
</div></body></html>