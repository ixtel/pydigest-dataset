<html><body><div><article class="markdown-body entry-content" itemprop="text"><h1><a id="user-content-memory_utils" class="anchor" href="#memory_utils" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>memory_utils</h1>
<p><a href="https://travis-ci.org/jtushman/memory_utils"><img alt="Build Status" src="https://camo.githubusercontent.com/f001621f1c3161f0f1cd6c75ad8ee425577f5e8e/68747470733a2f2f7472617669732d63692e6f72672f6a747573686d616e2f70726f78795f746f6f6c732e7376673f6272616e63683d6d6173746572" data-canonical-src="https://travis-ci.org/jtushman/proxy_tools.svg?branch=master"/></a></p>
<p>Yeah Memory Issues!!</p>
<p>Memory Issues happen to the best of us.  <code>memory_utils</code> will give you simple tools to quickly isolate the
cuplrit, and ideally, warn you before you run into issues.</p>
<p>From my experience, there is no silver-bullet in dealing with memory issues.  You just have to roll up your sleeve and get
dirty with print statements.  In our team's recent fight with a memory issue, we created memory_utils and we wanted to
share.</p>
<p><code>memory_utils</code> deals primarily with RSS memory (Resident Set Size).  The most important memory concept to understand
when dealing with memory constrained systems: RSS, the resident set size, is the portion of a process's memory that
is held in RAM. The rest of the memory exists in the swap of the file system.</p>
<a name="user-content-install"/>
<h2><a id="user-content-install" class="anchor" href="#install" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Install</h2>

<a name="user-content-usage"/>
<h2><a id="user-content-usage" class="anchor" href="#usage" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Usage</h2>
<a name="user-content-print-memory"/>
<h3><a id="user-content-print_memory" class="anchor" href="#print_memory" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>print_memory</h3>
<p>The workhorse of this package is <code>print_memory</code> It simply prints out 3 columns of data: the current memory, the
delta since the previous statement and an message that you pass it.  If there is additional memory used --
the line will be printed RED and if there is a decrease, the line will be printed GREEN.</p>
<p>It is a very simple approach, but it really helped us  find out where the issue was, at glance.  The output could
look like this:</p>
<pre>RSS                  Delta                Message
14,393,344           14,393,344          BEFORE BLOAT
14,397,440           4,096               DURING BLOAT (1)
14,413,824           16,384              DURING BLOAT (102)
14,417,920           4,096               DURING BLOAT (211)
14,438,400           20,480              DURING BLOAT (1002)
14,442,496           4,096               DURING BLOAT (2034)
14,462,976           20,480              DURING BLOAT (2056)
</pre>
<a name="user-content-memory-watcher-and-check-memory"/>
<h3><a id="user-content-memory_watcher-and-check_memory" class="anchor" href="#memory_watcher-and-check_memory" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>memory_watcher and check_memory</h3>
<p>We have worker processes that run in containers.  I like to fail hard and early.  So we have two helper functions
that help us with that</p>
<a name="user-content-check-memory"/>
<h4><a id="user-content-check_memory" class="anchor" href="#check_memory" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a><code>check_memory</code></h4>
<blockquote>
Will check the current rss memory against the memory_utils set memory limit.  And if it crosses that limit it will
raise a <code>MemoryTooBigException</code></blockquote>
<div class="highlight highlight-source-python"><pre>pip install memory_utils

<span class="pl-k">import</span> memory_utils
memory_utils.set_memory_limit(<span class="pl-c1">200</span> <span class="pl-k">*</span> memory_utils.<span class="pl-c1">MEGABYTES</span>)

<span class="pl-c"># .... else where</span>

memory_utils.check_memory()</pre></div>
<a name="user-content-memory-watcher"/>
<h4><a id="user-content-memory_watcher" class="anchor" href="#memory_watcher" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a><code>memory_watcher</code></h4>
<blockquote>
<p>Often you will want to do your <code>check_memory</code> at a _safe_ place.  Also memory leaks often happen within a loop.
We created <code>memory_watcher</code> with those concepts in mind</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">for</span> account <span class="pl-k">in</span> memory_watcher(Account.objects):
    account.do_something_memory_intensive()
    account.save()</pre></div>
<p>This will call <code>check_memory</code> before each iteration</p>
</blockquote>
<a name="user-content-configuration"/>
<h3><a id="user-content-configuration" class="anchor" href="#configuration" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Configuration</h3>
<a name="user-content-set-verbose"/>
<h4><a id="user-content-set_verbose" class="anchor" href="#set_verbose" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a><code>set_verbose</code></h4>
<blockquote>
<p>By default <code>print_memory</code> will only print statements that move the memory
and <code>memory_watcher</code> will not print its memory usage.
If you want additional verbosity set this to true</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">import</span> memory_utils
memory_utils.set_verbose(<span class="pl-c1">True</span>)</pre></div>
</blockquote>
<a name="user-content-set-memory-limit"/>
<h4><a id="user-content-set_memory_limit" class="anchor" href="#set_memory_limit" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a><code>set_memory_limit</code></h4>
<blockquote>
<p>By default, the memory limit at 200 MB.</p>
<p>Use this method to change the default.</p>
<p>This setting is used in <code>print_memory</code> and <code>memory_watcher</code></p>
<p>Note: you can also override this limit at the function level as well</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">import</span> memory_utils
memory_utils.set_memory_limit(<span class="pl-c1">500</span> <span class="pl-k">*</span> memory_utils.<span class="pl-c1">MEGABYTES</span>)</pre></div>
</blockquote>
<a name="user-content-set-out"/>
<h4><a id="user-content-set_out" class="anchor" href="#set_out" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a><code>set_out</code></h4>
<blockquote>
<p>By default, we will print to standard out.  Feel free to override here like so</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">import</span> memory_utils
<span class="pl-k">from</span> StringIO <span class="pl-k">import</span> StringIO

out <span class="pl-k">=</span> StringIO()
memory_utils.set_out(out)</pre></div>
</blockquote>
<a name="user-content-questions-issues"/>
<h2><a id="user-content-questions--issues" class="anchor" href="#questions--issues" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Questions / Issues</h2>
<p>Feel free to ping me on twitter: <a href="http://twitter.com/tushman">@tushman</a>
or add issues or PRs at <a href="https://github.com/jtushman/memory_utils">https://github.com/jtushman/memory_utils</a></p>

</article>
  </div></body></html>