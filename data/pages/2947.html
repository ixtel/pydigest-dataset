<html><body><div><section class="entry">
<p class="fsb-clear"/><p><a href="http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_cod_mw3.jpg"><img class="aligncenter wp-image-1799" src="http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_cod_mw3.jpg" alt="template_matching_cod_mw3" srcset="http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_cod_mw3-300x267.jpg 300w, http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_cod_mw3-1024x912.jpg 1024w, http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_cod_mw3.jpg 1296w" sizes="(max-width: 600px) 100vw, 600px"/></a></p>
<p>This past weekend I’ve been really sick with the flu. I haven’t done much besides lay on my couch, sip chicken noodle soup from a coffee mug, and marathon gaming sessions of Call of Duty.</p>
<p>It’s honestly been <em>years</em> since I’ve spent a weekend relentlessly playing Call of Duty. Getting online and playing endless rounds of Team Deathmatch and Domination brought back some great memories of my college roommate and myself gaming all night during my undergraduate years.</p>
<p><iframe src="http://www.youtube.com/embed/MfdKh0HEOBs?feature=oembed" frameborder="0" allowfullscreen="">VIDEO</iframe></p>
<p>Seriously, back in college I was a Call of Duty fanatic — I even had Call of Duty posters hanging on the walls. And I had played all the games: the original Call of Duty games set during World War II; the Modern Warfare series (my favorite); even the Black Ops games. And while I was too sick to get myself off the couch this weekend, I could no-scope my through a game of Domination without a problem.</p>
<p>But by the end of Sunday afternoon I was starting to feel a little burnt out on my gaming session. Apparently, there is a only a finite amount of gaming I can do in a single sitting now that I’m not in college anymore.</p>
<p>Anyway, I reached over to my laptop and started surfing the web. After a few minutes of browsing Facebook, I came across a <a href="http://machinelearningmastery.com/using-opencv-python-and-template-matching-to-play-wheres-waldo/" target="_blank">template matching tutorial</a> I did over at Machine Learning Mastery. In this article, I detailed how to play a game of <em>Where’s Waldo?</em> (or <em>Where’s Wally?</em>, for the international readers) using computer vision.</p>
<p>While this tutorial was pretty fun (<em>albeit</em>, very introductory), I realized there was an easy extension to make template matching more robust that needed to be covered.</p>
<p>You see, there are times when using keypoint detectors, local invariant descriptors (such as SIFT, SURF, FREAK, etc.), and keypoint matching with RANSAC or LMEDs is simply overkill — <em>and you’re better off with a more simplistic approach.</em></p>
<p>In this blog post I’ll detail how you can extend template matching to be <em>multi-scale</em> and work with images where the template and the input image are not the same size.</p>

<p><strong>OpenCV and Python versions:</strong><br/>
This example will run on<strong> Python 2.7/Python 3.4+</strong> and <strong>OpenCV 2.4.X</strong>.</p>
<h1>Multi-scale Template Matching using Python and OpenCV</h1>
<p>To start this tutorial off, let’s first understand why the standard approach to template matching using 
			<span id="crayon-56d59764c2bca778055191" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">matchTemplate</span></span></span>  is not very robust.</p>
<p>Take a look at the example image below:</p>
<div id="attachment_1796" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_bad_match.jpg"><img class="wp-image-1796" src="http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_bad_match.jpg" alt="Figure 1: Template matching fails to work when the size of the template does not match the size of the region in the image." srcset="http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_bad_match-300x293.jpg 300w, http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_bad_match-1024x1002.jpg 1024w, http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_bad_match.jpg 1096w" sizes="(max-width: 600px) 100vw, 600px"/></a><p class="wp-caption-text"><strong>Figure 1:</strong> Template matching fails to work when the size of the template image <em>(left)</em> does not match the size of the region in the image <em>(right)</em>.</p></div>
<p>In the example image above, we have the Call of Duty logo on the <em>left. </em>And on the right, we have the image that we want to detect the Call of Duty logo in.</p>
<p><em><strong>Note:</strong> Both the template and input images were matched on the edge map representations. The image on the right is simply the output of the operation after attempting to find the template using the edge map of both images.</em></p>
<p>However, when we try to apply template matching using the 
			<span id="crayon-56d59764c2bde840161369" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">matchTemplate</span></span></span>  function, we are left with a false match — this is because the size of the logo image on the <em>left</em> is <strong>substantially smaller</strong> than the Call of Duty logo on the game cover on the <em>right</em>.</p>
<p>Given that the dimensions of the Call of Duty template does not match the dimensions of the Call of Duty logo on the game cover, we are left with a false detection.</p>
<p>So what do we do now?</p>
<p>Give up? Start detecting keypoints? Extracting local invariant descriptors? And applying keypoint matching?</p>
<p><strong><em>Not so fast.</em></strong></p>
<p>While detecting keypoints, extracting local invariant descriptors, and matching keypoints <strong><em>would certainly work</em></strong>, it’s <strong><em>absolutely overkill for this problem.</em></strong></p>
<p>In fact, we can get away with a much easier solution — and with substantially less code.</p>
<h1>The cv2.matchTemplate Trick</h1>
<p>So as I hinted at in the beginning of this post, just because the dimensions of your template do not match the dimensions of the region in the image you want to match, <strong><em>does not </em></strong>mean that you cannot apply template matching.</p>
<p>In this case, all you need to do is apply a little trick:</p>
<ol>
<li>Loop over the input image at multiple scales (i.e. make the input image progressively smaller and smaller).</li>
<li>Apply template matching using 
			<span id="crayon-56d59764c2be8504798927" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">matchTemplate</span></span></span>  and keep track of the match with the largest correlation coefficient (along with the <em>x, y</em>-coordinates of the region with the largest correlation coefficient).</li>
<li>After looping over all scales, take the region with the largest correlation coefficient and use that as your “matched” region.</li>
</ol>
<p>As I said, <strong>this trick is dead simple</strong> — but in certain situations this approach can save you from writing a lot of extra code and dealing with more fancy techniques to matching objects in images.</p>
<p><strong><em>Note:</em></strong><em> By definition template matching is translation invariant. The extension we are proposing now can help make it more robust to changes in scaling (i.e. size). But template matching </em>is not ideal<em> if you are trying to match </em>rotated<em> objects or objects that exhibit non-affine transformations. If you are concerned with these types of transformations you are better of jumping right to keypoint matching.</em></p>
<p>Anyway, enough with the talking. Let’s jump into some code. Open up your favorite editor, create a new file, name it 
			<span id="crayon-56d59764c2bf1438626809" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">match</span><span class="crayon-sy">.</span><span class="crayon-v">py</span></span></span> , and let’s get started:</p>

		<div id="crayon-56d59764c2bf9569641349" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-56d59764c2bf9569641349-1">1</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59764c2bf9569641349-2">2</p><p class="crayon-num" data-line="crayon-56d59764c2bf9569641349-3">3</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59764c2bf9569641349-4">4</p><p class="crayon-num" data-line="crayon-56d59764c2bf9569641349-5">5</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59764c2bf9569641349-6">6</p><p class="crayon-num" data-line="crayon-56d59764c2bf9569641349-7">7</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59764c2bf9569641349-8">8</p><p class="crayon-num" data-line="crayon-56d59764c2bf9569641349-9">9</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59764c2bf9569641349-10">10</p><p class="crayon-num" data-line="crayon-56d59764c2bf9569641349-11">11</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59764c2bf9569641349-12">12</p><p class="crayon-num" data-line="crayon-56d59764c2bf9569641349-13">13</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59764c2bf9569641349-14">14</p><p class="crayon-num" data-line="crayon-56d59764c2bf9569641349-15">15</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59764c2bf9569641349-16">16</p><p class="crayon-num" data-line="crayon-56d59764c2bf9569641349-17">17</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59764c2bf9569641349-18">18</p><p class="crayon-num" data-line="crayon-56d59764c2bf9569641349-19">19</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59764c2bf9569641349-20">20</p><p class="crayon-num" data-line="crayon-56d59764c2bf9569641349-21">21</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59764c2bf9569641349-22">22</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d59764c2bf9569641349-1"><span class="crayon-c"># import the necessary packages</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59764c2bf9569641349-2"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">numpy </span><span class="crayon-st">as</span><span class="crayon-h"> </span><span class="crayon-e">np</span></p><p class="crayon-line" id="crayon-56d59764c2bf9569641349-3"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-k ">argparse</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59764c2bf9569641349-4"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">imutils</span></p><p class="crayon-line" id="crayon-56d59764c2bf9569641349-5"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-k ">glob</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59764c2bf9569641349-6"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span></p><p class="crayon-line" id="crayon-56d59764c2bf9569641349-7"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59764c2bf9569641349-8"><span class="crayon-c"># construct the argument parser and parse the arguments</span></p><p class="crayon-line" id="crayon-56d59764c2bf9569641349-9"><span class="crayon-v">ap</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">argparse</span><span class="crayon-sy">.</span><span class="crayon-e">ArgumentParser</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59764c2bf9569641349-10"><span class="crayon-v">ap</span><span class="crayon-sy">.</span><span class="crayon-e">add_argument</span><span class="crayon-sy">(</span><span class="crayon-s">"-t"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"--template"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">required</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-k ">help</span><span class="crayon-o">=</span><span class="crayon-s">"Path to template image"</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59764c2bf9569641349-11"><span class="crayon-v">ap</span><span class="crayon-sy">.</span><span class="crayon-e">add_argument</span><span class="crayon-sy">(</span><span class="crayon-s">"-i"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"--images"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">required</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59764c2bf9569641349-12"><span class="crayon-h">	</span><span class="crayon-k ">help</span><span class="crayon-o">=</span><span class="crayon-s">"Path to images where template will be matched"</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59764c2bf9569641349-13"><span class="crayon-v">ap</span><span class="crayon-sy">.</span><span class="crayon-e">add_argument</span><span class="crayon-sy">(</span><span class="crayon-s">"-v"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"--visualize"</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59764c2bf9569641349-14"><span class="crayon-h">	</span><span class="crayon-k ">help</span><span class="crayon-o">=</span><span class="crayon-s">"Flag indicating whether or not to visualize each iteration"</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59764c2bf9569641349-15"><span class="crayon-v">args</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">vars</span><span class="crayon-sy">(</span><span class="crayon-v">ap</span><span class="crayon-sy">.</span><span class="crayon-e">parse_args</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59764c2bf9569641349-16"> </p><p class="crayon-line" id="crayon-56d59764c2bf9569641349-17"><span class="crayon-c"># load the image image, convert it to grayscale, and detect edges</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59764c2bf9569641349-18"><span class="crayon-v">template</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">imread</span><span class="crayon-sy">(</span><span class="crayon-v">args</span><span class="crayon-sy">[</span><span class="crayon-s">"template"</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59764c2bf9569641349-19"><span class="crayon-v">template</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">cvtColor</span><span class="crayon-sy">(</span><span class="crayon-v">template</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">COLOR_BGR2GRAY</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59764c2bf9569641349-20"><span class="crayon-v">template</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">Canny</span><span class="crayon-sy">(</span><span class="crayon-v">template</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">50</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">200</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59764c2bf9569641349-21"><span class="crayon-sy">(</span><span class="crayon-v">tH</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tW</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">template</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59764c2bf9569641349-22"><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">imshow</span><span class="crayon-sy">(</span><span class="crayon-s">"Template"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">template</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>The first thing we’ll do is import the packages we’ll need. We’ll use NumPy for numerical processing, 
			<span id="crayon-56d59764c2c01060120582" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">argparse</span></span></span>  for parsing command line arguments, 
			<span id="crayon-56d59764c2c09140921601" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">imutils</span></span></span>  for some image processing convenience functions (included with the .zip of the code for this post), 
			<span id="crayon-56d59764c2c10837092862" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">glob</span></span></span>  for grabbing the paths to our input images, and 
			<span id="crayon-56d59764c2c17873256671" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">cv2</span></span></span>  for our OpenCV bindings.</p>
<p>We then parse our arguments on <strong>Lines 8-15</strong>. We’ll need three switches: 
			<span id="crayon-56d59764c2c1e837349138" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-o">--</span><span class="crayon-v">template</span></span></span> , which is the path to the template we want to match in our image (i.e. the Call of Duty logo), 
			<span id="crayon-56d59764c2c25906850167" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-o">--</span><span class="crayon-v">images</span></span></span> , the path to the directory including the images that contain the Call of Duty logo that we want to find, and an optional 
			<span id="crayon-56d59764c2c2c395056093" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-o">--</span><span class="crayon-v">visualize</span></span></span>  argument which lets us visualize the template matching search across multiple scales.</p>
<p>Next up, it’s time to load our template off disk on <strong>Line 18</strong>. We’ll also convert it to grayscale on <strong>Line 19</strong> and detect edges on <strong>Line 20</strong>. As you’ll see later in this post, applying template matching using <em>edges</em> rather than the <em>raw image</em> gives us a substantial boost in accuracy for template matching.</p>
<p>The reason for this is because the Call of Duty logo is <em>rigid </em>and <em>well defined </em>— and as we’ll see later on in this post, it allows us to discard the color and styling of the logo and instead focus solely on the outline. Doing this gives us a slightly more robust approach that we would not have otherwise.</p>
<p>Anyway, after applying edge detection our template should look like this:</p>
<div id="attachment_1810" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_edge_map.jpg"><img class="size-full wp-image-1810" src="http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_edge_map.jpg" alt="Figure 2: Extracting edges from the template image." srcset="http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_edge_map-300x150.jpg 300w, http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_edge_map.jpg 364w" sizes="(max-width: 364px) 100vw, 364px"/></a><p class="wp-caption-text"><strong>Figure 2:</strong> Extracting edges from the template image.</p></div>
<p>Now, let’s work on the multi-scale trick:</p>

		<div id="crayon-56d59764c2c35091520677" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num crayon-striped-num" data-line="crayon-56d59764c2c35091520677-24">24</p><p class="crayon-num" data-line="crayon-56d59764c2c35091520677-25">25</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59764c2c35091520677-26">26</p><p class="crayon-num" data-line="crayon-56d59764c2c35091520677-27">27</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59764c2c35091520677-28">28</p><p class="crayon-num" data-line="crayon-56d59764c2c35091520677-29">29</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59764c2c35091520677-30">30</p><p class="crayon-num" data-line="crayon-56d59764c2c35091520677-31">31</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59764c2c35091520677-32">32</p><p class="crayon-num" data-line="crayon-56d59764c2c35091520677-33">33</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59764c2c35091520677-34">34</p><p class="crayon-num" data-line="crayon-56d59764c2c35091520677-35">35</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59764c2c35091520677-36">36</p><p class="crayon-num" data-line="crayon-56d59764c2c35091520677-37">37</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59764c2c35091520677-38">38</p><p class="crayon-num" data-line="crayon-56d59764c2c35091520677-39">39</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59764c2c35091520677-40">40</p><p class="crayon-num" data-line="crayon-56d59764c2c35091520677-41">41</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59764c2c35091520677-42">42</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line crayon-striped-line" id="crayon-56d59764c2c35091520677-24"><span class="crayon-c"># loop over the images to find the template in</span></p><p class="crayon-line" id="crayon-56d59764c2c35091520677-25"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">imagePath </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-k ">glob</span><span class="crayon-sy">.</span><span class="crayon-k ">glob</span><span class="crayon-sy">(</span><span class="crayon-v">args</span><span class="crayon-sy">[</span><span class="crayon-s">"images"</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">"/*.jpg"</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59764c2c35091520677-26"><span class="crayon-h">	</span><span class="crayon-c"># load the image, convert it to grayscale, and initialize the</span></p><p class="crayon-line" id="crayon-56d59764c2c35091520677-27"><span class="crayon-h">	</span><span class="crayon-c"># bookkeeping variable to keep track of the matched region</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59764c2c35091520677-28"><span class="crayon-h">	</span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">imread</span><span class="crayon-sy">(</span><span class="crayon-v">imagePath</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59764c2c35091520677-29"><span class="crayon-h">	</span><span class="crayon-v">gray</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">cvtColor</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">COLOR_BGR2GRAY</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59764c2c35091520677-30"><span class="crayon-h">	</span><span class="crayon-v">found</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">None</span></p><p class="crayon-line" id="crayon-56d59764c2c35091520677-31"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59764c2c35091520677-32"><span class="crayon-h">	</span><span class="crayon-c"># loop over the scales of the image</span></p><p class="crayon-line" id="crayon-56d59764c2c35091520677-33"><span class="crayon-h">	</span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">scale </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">np</span><span class="crayon-sy">.</span><span class="crayon-e">linspace</span><span class="crayon-sy">(</span><span class="crayon-cn">0.2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1.0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">20</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-o">::</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59764c2c35091520677-34"><span class="crayon-h">		</span><span class="crayon-c"># resize the image according to the scale, and keep track</span></p><p class="crayon-line" id="crayon-56d59764c2c35091520677-35"><span class="crayon-h">		</span><span class="crayon-c"># of the ratio of the resizing</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59764c2c35091520677-36"><span class="crayon-h">		</span><span class="crayon-v">resized</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">imutils</span><span class="crayon-sy">.</span><span class="crayon-e">resize</span><span class="crayon-sy">(</span><span class="crayon-v">gray</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">width</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">int</span><span class="crayon-sy">(</span><span class="crayon-v">gray</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">scale</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59764c2c35091520677-37"><span class="crayon-h">		</span><span class="crayon-v">r</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">gray</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-k ">float</span><span class="crayon-sy">(</span><span class="crayon-v">resized</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59764c2c35091520677-38"> </p><p class="crayon-line" id="crayon-56d59764c2c35091520677-39"><span class="crayon-h">		</span><span class="crayon-c"># if the resized image is smaller than the template, then break</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59764c2c35091520677-40"><span class="crayon-h">		</span><span class="crayon-c"># from the loop</span></p><p class="crayon-line" id="crayon-56d59764c2c35091520677-41"><span class="crayon-h">		</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">resized</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-e">tH </span><span class="crayon-st">or</span><span class="crayon-h"> </span><span class="crayon-v">resized</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-v">tW</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59764c2c35091520677-42"><span class="crayon-h">			</span><span class="crayon-st">break</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>We start looping over our input images on <strong>Line 25</strong>. We then load the image off disk, convert it to grayscale, and initialize a bookkeeping variable 
			<span id="crayon-56d59764c2c40167583518" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">found</span></span></span>  to keep track of the region and scale of the image with the best match.</p>
<p>From there we start looping over the multiple scales of the image on <strong>Line 33</strong> using the 
			<span id="crayon-56d59764c2c47797955649" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">np</span><span class="crayon-sy">.</span><span class="crayon-v">linspace</span></span></span>  function. This function accepts three arguments, the starting value, the ending value, and the number of equal chunk slices in between. In this example, we’ll start from 100% of the original size of the image and work our way down to 20% of the original size in 20 equally sized percent chunks.</p>
<p>We then resize the image image according to the current 
			<span id="crayon-56d59764c2c4f938436530" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">scale</span></span></span>  on <strong>Line 36</strong> and compute the ratio of the old width to the new width — as you’ll see later, it’s important that we keep track of this ratio.</p>
<p>On <strong>Line 41</strong> we make a check to ensure that the input image is larger than our template matching. If the template is larger, then our 
			<span id="crayon-56d59764c2c56485520725" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">matchTemplate</span></span></span>  call will throw an error, so we just break from the loop if this is the case.</p>
<p>At this point we can apply template matching to our resized image:</p>

		<div id="crayon-56d59764c2c5d298969898" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num crayon-striped-num" data-line="crayon-56d59764c2c5d298969898-44">44</p><p class="crayon-num" data-line="crayon-56d59764c2c5d298969898-45">45</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59764c2c5d298969898-46">46</p><p class="crayon-num" data-line="crayon-56d59764c2c5d298969898-47">47</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59764c2c5d298969898-48">48</p><p class="crayon-num" data-line="crayon-56d59764c2c5d298969898-49">49</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59764c2c5d298969898-50">50</p><p class="crayon-num" data-line="crayon-56d59764c2c5d298969898-51">51</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59764c2c5d298969898-52">52</p><p class="crayon-num" data-line="crayon-56d59764c2c5d298969898-53">53</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59764c2c5d298969898-54">54</p><p class="crayon-num" data-line="crayon-56d59764c2c5d298969898-55">55</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59764c2c5d298969898-56">56</p><p class="crayon-num" data-line="crayon-56d59764c2c5d298969898-57">57</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59764c2c5d298969898-58">58</p><p class="crayon-num" data-line="crayon-56d59764c2c5d298969898-59">59</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59764c2c5d298969898-60">60</p><p class="crayon-num" data-line="crayon-56d59764c2c5d298969898-61">61</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59764c2c5d298969898-62">62</p><p class="crayon-num" data-line="crayon-56d59764c2c5d298969898-63">63</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59764c2c5d298969898-64">64</p><p class="crayon-num" data-line="crayon-56d59764c2c5d298969898-65">65</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59764c2c5d298969898-66">66</p><p class="crayon-num" data-line="crayon-56d59764c2c5d298969898-67">67</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59764c2c5d298969898-68">68</p><p class="crayon-num" data-line="crayon-56d59764c2c5d298969898-69">69</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59764c2c5d298969898-70">70</p><p class="crayon-num" data-line="crayon-56d59764c2c5d298969898-71">71</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59764c2c5d298969898-72">72</p><p class="crayon-num" data-line="crayon-56d59764c2c5d298969898-73">73</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line crayon-striped-line" id="crayon-56d59764c2c5d298969898-44"><span class="crayon-h">		</span><span class="crayon-c"># detect edges in the resized, grayscale image and apply template</span></p><p class="crayon-line" id="crayon-56d59764c2c5d298969898-45"><span class="crayon-h">		</span><span class="crayon-c"># matching to find the template in the image</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59764c2c5d298969898-46"><span class="crayon-h">		</span><span class="crayon-v">edged</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">Canny</span><span class="crayon-sy">(</span><span class="crayon-v">resized</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">50</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">200</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59764c2c5d298969898-47"><span class="crayon-h">		</span><span class="crayon-v">result</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">matchTemplate</span><span class="crayon-sy">(</span><span class="crayon-v">edged</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">template</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">TM_CCOEFF</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59764c2c5d298969898-48"><span class="crayon-h">		</span><span class="crayon-sy">(</span><span class="crayon-v">_</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">maxVal</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">_</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">maxLoc</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">minMaxLoc</span><span class="crayon-sy">(</span><span class="crayon-v">result</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59764c2c5d298969898-49"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59764c2c5d298969898-50"><span class="crayon-h">		</span><span class="crayon-c"># check to see if the iteration should be visualized</span></p><p class="crayon-line" id="crayon-56d59764c2c5d298969898-51"><span class="crayon-h">		</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">args</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-s">"visualize"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">False</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59764c2c5d298969898-52"><span class="crayon-h">			</span><span class="crayon-c"># draw a bounding box around the detected region</span></p><p class="crayon-line" id="crayon-56d59764c2c5d298969898-53"><span class="crayon-h">			</span><span class="crayon-v">clone</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">np</span><span class="crayon-sy">.</span><span class="crayon-e">dstack</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">edged</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">edged</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">edged</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59764c2c5d298969898-54"><span class="crayon-h">			</span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">rectangle</span><span class="crayon-sy">(</span><span class="crayon-v">clone</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">maxLoc</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">maxLoc</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d59764c2c5d298969898-55"><span class="crayon-h">				</span><span class="crayon-sy">(</span><span class="crayon-v">maxLoc</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">tW</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">maxLoc</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">tH</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">255</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59764c2c5d298969898-56"><span class="crayon-h">			</span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">imshow</span><span class="crayon-sy">(</span><span class="crayon-s">"Visualize"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">clone</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59764c2c5d298969898-57"><span class="crayon-h">			</span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">waitKey</span><span class="crayon-sy">(</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59764c2c5d298969898-58"> </p><p class="crayon-line" id="crayon-56d59764c2c5d298969898-59"><span class="crayon-h">		</span><span class="crayon-c"># if we have found a new maximum correlation value, then ipdate</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59764c2c5d298969898-60"><span class="crayon-h">		</span><span class="crayon-c"># the bookkeeping variable</span></p><p class="crayon-line" id="crayon-56d59764c2c5d298969898-61"><span class="crayon-h">		</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">found </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-t">None</span><span class="crayon-h"> </span><span class="crayon-st">or</span><span class="crayon-h"> </span><span class="crayon-v">maxVal</span><span class="crayon-h"> </span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">found</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59764c2c5d298969898-62"><span class="crayon-h">			</span><span class="crayon-v">found</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">maxVal</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">maxLoc</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">r</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59764c2c5d298969898-63"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59764c2c5d298969898-64"><span class="crayon-h">	</span><span class="crayon-c"># unpack the bookkeeping varaible and compute the (x, y) coordinates</span></p><p class="crayon-line" id="crayon-56d59764c2c5d298969898-65"><span class="crayon-h">	</span><span class="crayon-c"># of the bounding box based on the resized ratio</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59764c2c5d298969898-66"><span class="crayon-h">	</span><span class="crayon-sy">(</span><span class="crayon-v">_</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">maxLoc</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">r</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">found</span></p><p class="crayon-line" id="crayon-56d59764c2c5d298969898-67"><span class="crayon-h">	</span><span class="crayon-sy">(</span><span class="crayon-v">startX</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">startY</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-k ">int</span><span class="crayon-sy">(</span><span class="crayon-v">maxLoc</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">r</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-k ">int</span><span class="crayon-sy">(</span><span class="crayon-v">maxLoc</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">r</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59764c2c5d298969898-68"><span class="crayon-h">	</span><span class="crayon-sy">(</span><span class="crayon-v">endX</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">endY</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-k ">int</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">maxLoc</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">tW</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">r</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-k ">int</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">maxLoc</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">tH</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">r</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59764c2c5d298969898-69"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59764c2c5d298969898-70"><span class="crayon-h">	</span><span class="crayon-c"># draw a bounding box around the detected result and display the image</span></p><p class="crayon-line" id="crayon-56d59764c2c5d298969898-71"><span class="crayon-h">	</span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">rectangle</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">startX</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">startY</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">endX</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">endY</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">255</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59764c2c5d298969898-72"><span class="crayon-h">	</span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">imshow</span><span class="crayon-sy">(</span><span class="crayon-s">"Image"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59764c2c5d298969898-73"><span class="crayon-h">	</span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">waitKey</span><span class="crayon-sy">(</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>On <strong>Line 46</strong> we compute the Canny edge representation of the image, using the exact same parameters as in the template image.</p>
<p>We then apply template matching using 
			<span id="crayon-56d59764c2c6b029955304" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">matchTemplate</span></span></span>  on <strong>Line 47</strong>. The 
			<span id="crayon-56d59764c2c73287235329" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">matchTemplate</span></span></span>  function takes three arguments: the input image, the template we want to find in the input image, and the template matching method. In this case, we supply the 
			<span id="crayon-56d59764c2c7a516969691" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">TM_CCOEFF</span></span></span> flag, indicating we are using the correlation coefficient to match templates.</p>
<p>The 
			<span id="crayon-56d59764c2c81931141563" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">minMaxLoc</span></span></span>  function on <strong>Line 48</strong> takes our correlation result and returns a 4-tuple which includes the minimum correlation value, the maximum correlation value, the <em>(x, y)</em>-coordinate of the minimum value, and the <em>(x, y)</em>-coordinate of the maximum value, respectively. We are only interested in the maximum value and <em>(x, y)</em>-coordinate so we keep the maximums and discard the minimums.</p>
<p><strong>Line 51-57</strong> handle visualizing the multi-scale template match. This allows us to inspect the regions of the image that are getting matched at each iteration of the scale.</p>
<p>From there, we update our bookkeeping variable 
			<span id="crayon-56d59764c2c89322388560" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">found</span></span></span>  on <strong>Lines 61 and 62</strong> to keep track of the maximum correlation value found thus far, the <em>(x, y)</em>-coordinate of the maximum value, along with the ratio of the original image width to the current, resized image width.</p>
<p>At this point all the hard work is done.</p>
<p>After we have looped over all scales of the image, we unpack our bookkeeping variable on <strong>Line 66</strong>, and then compute our starting and ending <em>(x, y)</em>-coordinates of our bounding box on <strong>Line 67 and 68</strong>. Special care is taken to multiply the coordinates of the bounding box by the ratio on <strong>Line 37</strong> to ensure that the coordinates match the original dimensions of the input image.</p>
<p>Finally, we draw our bounding box and display it to our screen on <strong>Lines 71-73</strong>.</p>
<h1>Multi-scale Template Matching Results</h1>
<p>Don’t take my word for it that this method works! Let’s look at some examples.</p>
<p>Open up your terminal and execute the following command:</p>

		<div id="crayon-56d59764c2c91971698353" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d59764c2c91971698353-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">python </span><span class="crayon-v">match</span><span class="crayon-e">.py</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">template </span><span class="crayon-v">cod_logo</span><span class="crayon-e">.png</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">images </span><span class="crayon-v">images</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>Your results should look like this:</p>
<div id="attachment_1802" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_cod_blackops.jpg"><img class="wp-image-1802" src="http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_cod_blackops.jpg" alt="Figure 3: Successfully applying multi-scale template match to find the template in the image." srcset="http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_cod_blackops-283x300.jpg 283w, http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_cod_blackops-964x1024.jpg 964w, http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_cod_blackops.jpg 1051w" sizes="(max-width: 600px) 100vw, 600px"/></a><p class="wp-caption-text"><strong>Figure 3:</strong> Successfully applying multi-scale template match to find the template in the image.</p></div>
<p>As you can see, our method successfully found the Call of Duty logo, unlike the the basic template matching in <strong>Figure 1</strong> which failed to find the logo.</p>
<div id="attachment_1803" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_cod_blackops_2.jpg"><img class="wp-image-1803" src="http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_cod_blackops_2.jpg" alt="Figure 4: Another successful match using multi-scale template matching. Notice how different the logos are from this image and Figure 3." srcset="http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_cod_blackops_2-300x257.jpg 300w, http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_cod_blackops_2-1024x877.jpg 1024w, http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_cod_blackops_2.jpg 1313w" sizes="(max-width: 600px) 100vw, 600px"/></a><p class="wp-caption-text"><strong>Figure 4:</strong> Another successful match using multi-scale template matching. Notice how different the logos are from this image and Figure 3.</p></div>
<p>We then apply multi-scale template matching to another Call of Duty game cover — and again we have found the Call of Duty logo, despite the template being substantially smaller than the input image.</p>
<p>Also, take a second a examine how different the style and color of the Call of Duty logos are in <strong>Figure 3</strong> and <strong>Figure 4</strong>. Had we used the RGB or grayscale template we would have not been able to find these logos in the input images. But by applying template matching to the <em>edge map representation</em> rather than the original <em>RGB or grayscale representation</em>, we were able to obtain slightly more robust results.</p>
<p>Let’s try another image:</p>
<div id="attachment_1798" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_cod_ghosts.jpg"><img class="wp-image-1798" src="http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_cod_ghosts.jpg" alt="Figure 5: Once again, multi-scale template matching is able to find the logo (left) in the input image (right)." srcset="http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_cod_ghosts-300x253.jpg 300w, http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_cod_ghosts-1024x865.jpg 1024w, http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_cod_ghosts.jpg 1151w" sizes="(max-width: 600px) 100vw, 600px"/></a><p class="wp-caption-text"><strong>Figure 5:</strong> Once again, multi-scale template matching is able to find the logo <em>(left)</em> in the input image <em>(right)</em>.</p></div>
<p>Once again, our method was able to find the logo in the input image!</p>
<p>The same is true for <strong>Figure 6</strong> below:</p>
<div id="attachment_1804" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_cod_mw.jpg"><img class="wp-image-1804" src="http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_cod_mw.jpg" alt="Figure 6: More multi-scale template matching with OpenCV and Python. Notice how the &quot;4&quot; in the &quot;Call of Duty 4&quot; is not included in the match." srcset="http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_cod_mw-288x300.jpg 288w, http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_cod_mw-982x1024.jpg 982w, http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_cod_mw.jpg 1166w" sizes="(max-width: 600px) 100vw, 600px"/></a><p class="wp-caption-text"><strong>Figure 6:</strong> More multi-scale template matching with OpenCV and Python. Notice how the “4” in the “Call of Duty 4” is not included in the match.</p></div>
<p>And now for my favorite Call of Duty, Modern Warfare 3:</p>
<div id="attachment_1799" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_cod_mw3.jpg"><img class="wp-image-1799" src="http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_cod_mw3.jpg" alt="Figure 7: Multi-scale template matching using cv2.matchTemplate." srcset="http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_cod_mw3-300x267.jpg 300w, http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_cod_mw3-1024x912.jpg 1024w, http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_cod_mw3.jpg 1296w" sizes="(max-width: 600px) 100vw, 600px"/></a><p class="wp-caption-text"><strong>Figure 7:</strong> Multi-scale template matching using cv2.matchTemplate.</p></div>
<p>Once again, our multi-scale approach was able to successfully find the template in the input image!</p>
<p>And what’s even more impressive is that there is a very large amount of noise in the MW3 game cover above — the artists of the cover used white space to form the upper-right corner of the “Y” and the lower-left corner of the “C”, hence no edge will be detected there. Still, our method is able to find the logo in the image.</p>
<h1>Visualizing the Match</h1>
<p>In the above section we looked at the output of the match. But let’s take a second to dive into a visualization of how this algorithm actually works.</p>
<p>Open up your terminal and execute the following command:</p>

		<div id="crayon-56d59764c2c9f555234912" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d59764c2c9f555234912-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">python </span><span class="crayon-v">match</span><span class="crayon-e">.py</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">template </span><span class="crayon-v">cod_logo</span><span class="crayon-e">.png</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">images </span><span class="crayon-v">images</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-i">visualize</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>You’ll see an animation similar to the following:</p>
<div id="attachment_1805" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2015/01/cod_blackops_animated.gif"><img class="wp-image-1805" src="http://www.pyimagesearch.com/wp-content/uploads/2015/01/cod_blackops_animated.gif" alt="Figure 8: An animation of how multi-scale template matching works."/></a><p class="wp-caption-text"><strong>Figure 8:</strong> An animation of how multi-scale template matching works.</p></div>
<p>At each iteration, our image is resized and the Canny edge map computed.</p>
<p>We then apply template matching and find the <em>(x, y)</em>-coordinates of the image with the largest correlation coefficient.</p>
<p>Lastly, we store these values in a bookkeeping variable.</p>
<p>At the end of the algorithm we find the <em>(x, y)</em>-coordinates of the region with the largest correlation coefficient response <strong><em>across all scales</em></strong> and then draw our bounding box, as seen below:</p>
<div id="attachment_1802" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_cod_blackops.jpg"><img class="wp-image-1802" src="http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_cod_blackops.jpg" alt="Figure 9: The output of our multi-scale template match." srcset="http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_cod_blackops-283x300.jpg 283w, http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_cod_blackops-964x1024.jpg 964w, http://www.pyimagesearch.com/wp-content/uploads/2015/01/template_matching_cod_blackops.jpg 1051w" sizes="(max-width: 600px) 100vw, 600px"/></a><p class="wp-caption-text"><strong>Figure 9:</strong> The output of our multi-scale template match.</p></div>
<p>For completeness, here is another example of visualizing our multi-scale template matching using OpenCV and Python:</p>
<div id="attachment_1806" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2015/01/cod_mw3_animated.gif"><img class="wp-image-1806" src="http://www.pyimagesearch.com/wp-content/uploads/2015/01/cod_mw3_animated.gif" alt="Figure 10: A second example of visualizing multi-scale template matching."/></a><p class="wp-caption-text"><strong>Figure 10:</strong> A second example of visualizing multi-scale template matching.</p></div>
<h1>Limitations and Drawbacks</h1>
<p>Of course, applying simple template matching, even multi-scale template matching has some significant limitations and drawbacks.</p>
<p>While we can handle variations in translation and scaling, our approach will not be robust to changes in rotation or non-affine transformations.</p>
<p>If we are concerned about rotation on non-affine transformations we are better off taking the time to detect keypoints, extract local invariant descriptors, and apply keypoint matching.</p>
<p>But in the case where our templates are (1) fairly rigid and well-defined via an edge map and (2) we are only concerned with translation and scaling, then multi-scale template matching can provide us with very good results with little effort.</p>
<p>Lastly, it’s important to keep in mind that template matching does not do a good job of telling us if an object <em>does not</em> appear in an image. Sure, we could set thresholds on the correlation coefficient, but in practice this is not reliable and robust. If you are looking for a more robust approach, you’ll have to explore keypoint matching.</p>
<h1>Summary</h1>
<p>In this blog post we discovered how to make standard template matching more robust by extending it to work with <em>multiple scales</em>.</p>
<p>We also discovered that in cases where our template image is rigid and well-formed, that utilizing an edge map rather than the RGB or grayscale representation can yield better results when applying template matching.</p>
<p>Our method to multi-scale template matching works well if we are only concerned with translation and scaling; however, this method will not be as robust in the presence of rotation and non-affine transformations. If our template or input image exhibits these types of transformations we are better off applying keypoint detection, local invariant descriptors, and keypoint matching.</p>
<h1 id="post_downloads">Downloads:</h1>

	</section>
	</div></body></html>