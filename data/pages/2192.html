<html><body><div><div class="entry-content clearfix"><p>This post details how to write a script to automate the scaling of Heroku dynos based on the time of day. We’ll also look at how to add a fail-safe so that our application automatically scales if it’s either down completely or experiencing a heavy load.</p>

<p>Let’s take the following assumptions into account:</p>

<table>
<thead>
<tr>
<th>Use</th>
<th>Time</th>
<th>Web Dynos</th>
</tr>
</thead>
<tbody>
<tr>
<td>Heavy</td>
<td>7am to 10pm</td>
<td>3</td>
</tr>
<tr>
<td>Medium</td>
<td>10pm to 3am</td>
<td>2</td>
</tr>
<tr>
<td>Low</td>
<td>3am to 7am</td>
<td>1</td>
</tr>
</tbody>
</table>







<p>So, we need to scale out at 7am, and then scale in at 10pm, and then in again at 3am. Repeat. For simplicity’s sake, the majority of our traffic comes from only a few times zones, which we’ve taken into account. We’ll also base everything off of UTC since that’s the Heroku default time zone.</p>

<blockquote><p>If this is for your own application, make sure you leave yourself some wiggle room before scaling in or out. You may also want to look at holidays and weekends as well. Do the math. Figure out your cost savings.</p></blockquote>

<p>With that, let’s add some tasks…</p>

<a name="APScheduler"/>
<h2>APScheduler</h2>

<p>For this tutorial, let’s use the <a href="http://apscheduler.readthedocs.org/en/3.0/">Advanced Python Scheduler</a> (APScheduler), since it’s easy to use and meant to be ran along side other processes, along with the <a href="https://devcenter.heroku.com/categories/platform-api">Heroku Platform API</a>.</p>

<p>Start by installing the APScheduler:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>pip install <span class="nv">apscheduler</span><span class="o">==</span>3.0.1
</span></code></pre></td></tr></table></div></figure>


<p>Now, create a new file called <em>autoscale.py</em> and add the following code:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">apscheduler.schedulers.blocking</span> <span class="kn">import</span> <span class="n">BlockingScheduler</span>
</span><span class="line">
</span><span class="line"><span class="n">sched</span> <span class="o">=</span> <span class="n">BlockingScheduler</span><span class="p">()</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="nd">@sched.scheduled_job</span><span class="p">(</span><span class="s">'interval'</span><span class="p">,</span> <span class="n">minutes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line"><span class="k">def</span> <span class="nf">job</span><span class="p">():</span>
</span><span class="line">    <span class="k">print</span> <span class="s">'This job is run every minute.'</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="n">sched</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Yes, this just runs a task every minute. Before moving on, let’s test this out to ensure it works. Add this process to your <em>Procfile</em>. Assuming you already have a web process defined, the file should now look something like this:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">web</span><span class="p">:</span> <span class="n">gunicorn</span> <span class="n">hello</span><span class="p">:</span><span class="n">app</span>
</span><span class="line"><span class="n">clock</span><span class="p">:</span> <span class="n">python</span> <span class="n">autoscale</span><span class="o">.</span><span class="n">py</span>
</span></code></pre></td></tr></table></div></figure>


<p>Commit your changes, and then push them up to Heroku.</p>

<p>Run the following command to scale up the clock process:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>heroku ps:scale <span class="nv">clock</span><span class="o">=</span>1
</span></code></pre></td></tr></table></div></figure>


<p>Then open the Heroku logs to see the process in action:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>heroku logs --tail
</span><span class="line">2014-11-04T14:59:22.418496+00:00 heroku<span class="o">[</span>api<span class="o">]</span>: Scale to <span class="nv">clock</span><span class="o">=</span>1, <span class="nv">web</span><span class="o">=</span>1 by michael@realpython.com
</span><span class="line">2014-11-04T15:00:20.357505+00:00 heroku<span class="o">[</span>router<span class="o">]</span>: <span class="nv">at</span><span class="o">=</span>info <span class="nv">method</span><span class="o">=</span>GET <span class="nv">path</span><span class="o">=</span><span class="s2">"/"</span> <span class="nv">host</span><span class="o">=</span>autoscale.herokuapp.com <span class="nv">request_id</span><span class="o">=</span>7537ce4a-e802-4020-9b1b-10e754263957 <span class="nv">fwd</span><span class="o">=</span><span class="s2">"54.160.152.14"</span> <span class="nv">dyno</span><span class="o">=</span>web.1 <span class="nv">connect</span><span class="o">=</span>1ms <span class="nv">service</span><span class="o">=</span>3ms <span class="nv">status</span><span class="o">=</span>200 <span class="nv">bytes</span><span class="o">=</span>172
</span><span class="line">2014-11-04T15:00:27.620383+00:00 app<span class="o">[</span>clock.1<span class="o">]</span>: This job is run every minute.
</span><span class="line">2014-11-04T15:01:27.621151+00:00 app<span class="o">[</span>clock.1<span class="o">]</span>: This job is run every minute.
</span><span class="line">2014-11-04T15:02:27.620780+00:00 app<span class="o">[</span>clock.1<span class="o">]</span>: This job is run every minute.
</span><span class="line">2014-11-04T15:03:27.621276+00:00 app<span class="o">[</span>clock.1<span class="o">]</span>: This job is run every minute.
</span></code></pre></td></tr></table></div></figure>


<p>Simple, right?</p>

<p>Moving on, let’s add the scaling tasks to the script…</p>

<a name="Autoscale"/>
<h2>Autoscale</h2>

<p>Start by grabbing the API key from the Heroku <a href="https://dashboard.heroku.com/account">account</a> page, and add it to a new file called <em>config.py</em>. Along with the key, also enter the name of the app you are interested in monitoring and the process.</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">APP</span> <span class="o">=</span> <span class="s">"&lt;add your app name&gt;"</span>
</span><span class="line"><span class="n">KEY</span> <span class="o">=</span> <span class="s">"&lt;add your API key&gt;"</span>
</span><span class="line"><span class="n">PROCESS</span> <span class="o">=</span> <span class="s">"web"</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, add the following function to <em>autoscale.py</em>:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">scale</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
</span><span class="line">    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s">'quantity'</span><span class="p">:</span> <span class="n">size</span><span class="p">}</span>
</span><span class="line">    <span class="n">json_payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span><span class="line">    <span class="n">url</span> <span class="o">=</span> <span class="s">"https://api.heroku.com/apps/"</span> <span class="o">+</span> <span class="n">APP</span> <span class="o">+</span> <span class="s">"/formation/"</span> <span class="o">+</span> <span class="n">PROCESS</span>
</span><span class="line">    <span class="k">try</span><span class="p">:</span>
</span><span class="line">        <span class="n">result</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">HEADERS</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json_payload</span><span class="p">)</span>
</span><span class="line">    <span class="k">except</span><span class="p">:</span>
</span><span class="line">        <span class="k">print</span> <span class="s">"test!"</span>
</span><span class="line">        <span class="k">return</span> <span class="bp">None</span>
</span><span class="line">    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span class="line">        <span class="k">return</span> <span class="s">"Success!"</span>
</span><span class="line">    <span class="k">else</span><span class="p">:</span>
</span><span class="line">        <span class="k">return</span> <span class="s">"Failure"</span>
</span></code></pre></td></tr></table></div></figure>


<p>Update the imports and add the following configuration as well:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">import</span> <span class="nn">requests</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">base64</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">json</span>
</span><span class="line">
</span><span class="line"><span class="kn">from</span> <span class="nn">apscheduler.schedulers.blocking</span> <span class="kn">import</span> <span class="n">BlockingScheduler</span>
</span><span class="line">
</span><span class="line"><span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">APP</span><span class="p">,</span> <span class="n">KEY</span><span class="p">,</span> <span class="n">PROCESS</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="c"># Generate Base64 encoded API Key</span>
</span><span class="line"><span class="n">BASEKEY</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="s">":"</span> <span class="o">+</span> <span class="n">KEY</span><span class="p">)</span>
</span><span class="line"><span class="c"># Create headers for API call</span>
</span><span class="line"><span class="n">HEADERS</span> <span class="o">=</span> <span class="p">{</span>
</span><span class="line">    <span class="s">"Accept"</span><span class="p">:</span> <span class="s">"application/vnd.heroku+json; version=3"</span><span class="p">,</span>
</span><span class="line">    <span class="s">"Authorization"</span><span class="p">:</span> <span class="n">BASEKEY</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we handle the basic authorization by passing the API Key into the header, and then using the <code>requests</code> library, we call the API. For more information on this, check out the official Heroku <a href="https://devcenter.heroku.com/articles/platform-api-quickstart#authentication">documentation</a>. If all went well, this will scale our app appropriately.</p>

<p>Want to test this out? Update the <code>job()</code> function like so:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="nd">@sched.scheduled_job</span><span class="p">(</span><span class="s">'interval'</span><span class="p">,</span> <span class="n">minutes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line"><span class="k">def</span> <span class="nf">job</span><span class="p">():</span>
</span><span class="line">    <span class="k">print</span> <span class="s">'Scaling ...'</span>
</span><span class="line">    <span class="k">print</span> <span class="n">scale</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Commit your code, and then push to Heroku. Now if you run <code>heroku logs --tail</code>, you should see:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>heroku logs --tail
</span><span class="line">2014-11-04T20:48:12.832034+00:00 app<span class="o">[</span>clock.1<span class="o">]</span>: Scaling ...
</span><span class="line">2014-11-04T20:48:12.910837+00:00 heroku<span class="o">[</span>api<span class="o">]</span>: Scale to <span class="nv">clock</span><span class="o">=</span>1, <span class="nv">web</span><span class="o">=</span>0 by hermanmu@gmail.com
</span><span class="line">2014-11-04T20:48:12.929993+00:00 app<span class="o">[</span>clock.1<span class="o">]</span>: Success!
</span><span class="line">2014-11-04T20:48:51.113079+00:00 app<span class="o">[</span>clock.1<span class="o">]</span>: Scaling ...
</span><span class="line">2014-11-04T20:49:10.486417+00:00 heroku<span class="o">[</span>web.1<span class="o">]</span>: Stopping all processes with SIGTERM
</span><span class="line">2014-11-04T20:49:11.844089+00:00 heroku<span class="o">[</span>web.1<span class="o">]</span>: Process exited with status 0
</span><span class="line">2014-11-04T20:49:12.816363+00:00 app<span class="o">[</span>clock.1<span class="o">]</span>: Scaling ...
</span><span class="line">2014-11-04T20:49:12.936135+00:00 app<span class="o">[</span>clock.1<span class="o">]</span>: Success!
</span><span class="line">2014-11-04T20:49:12.914887+00:00 heroku<span class="o">[</span>api<span class="o">]</span>: Scale to <span class="nv">clock</span><span class="o">=</span>1, <span class="nv">web</span><span class="o">=</span>0 by hermanmu@gmail.com
</span></code></pre></td></tr></table></div></figure>


<p>With the script working, let’s update APScheduler…</p>

<a name="Scheduler"/>
<h2>Scheduler</h2>

<p>Since we want to, again, scale out at 7am, and then scale in at 10pm, and then in again at 3am, update the scheduled tasks like so:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="nd">@sched.scheduled_job</span><span class="p">(</span><span class="s">'cron'</span><span class="p">,</span> <span class="n">hour</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
</span><span class="line"><span class="k">def</span> <span class="nf">scale_out_to_three</span><span class="p">():</span>
</span><span class="line">    <span class="k">print</span> <span class="s">'Scaling out ...'</span>
</span><span class="line">    <span class="k">print</span> <span class="n">scale</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="nd">@sched.scheduled_job</span><span class="p">(</span><span class="s">'cron'</span><span class="p">,</span> <span class="n">hour</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>
</span><span class="line"><span class="k">def</span> <span class="nf">scale_in_to_two</span><span class="p">():</span>
</span><span class="line">    <span class="k">print</span> <span class="s">'Scaling in ...'</span>
</span><span class="line">    <span class="k">print</span> <span class="n">scale</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="nd">@sched.scheduled_job</span><span class="p">(</span><span class="s">'cron'</span><span class="p">,</span> <span class="n">hour</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span class="line"><span class="k">def</span> <span class="nf">scale_in_to_one</span><span class="p">():</span>
</span><span class="line">    <span class="k">print</span> <span class="s">'Scaling in ...'</span>
</span><span class="line">    <span class="k">print</span> <span class="n">scale</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let this run for at least 24 hours, then check your logs again to ensure it’s working.</p>

<a name="Fail-Safe"/>
<h2>Fail-Safe</h2>

<p>In the event that our app goes down, let’s make sure to immediately scale out, no questions asked.</p>

<p>First, add the following function to the script, which determines how many dynos are attached to the process:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">get_current_dyno_quantity</span><span class="p">():</span>
</span><span class="line">    <span class="n">url</span> <span class="o">=</span> <span class="s">"https://api.heroku.com/apps/"</span> <span class="o">+</span> <span class="n">APP</span> <span class="o">+</span> <span class="s">"/formation"</span>
</span><span class="line">    <span class="k">try</span><span class="p">:</span>
</span><span class="line">        <span class="n">result</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">HEADERS</span><span class="p">)</span>
</span><span class="line">        <span class="k">for</span> <span class="n">formation</span> <span class="ow">in</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">text</span><span class="p">):</span>
</span><span class="line">            <span class="n">current_quantity</span> <span class="o">=</span> <span class="n">formation</span><span class="p">[</span><span class="s">"quantity"</span><span class="p">]</span>
</span><span class="line">            <span class="k">return</span> <span class="n">current_quantity</span>
</span><span class="line">    <span class="k">except</span><span class="p">:</span>
</span><span class="line">        <span class="k">return</span> <span class="bp">None</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then add a new task:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="nd">@sched.scheduled_job</span><span class="p">(</span><span class="s">'interval'</span><span class="p">,</span> <span class="n">minutes</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span class="line"><span class="k">def</span> <span class="nf">fail_safe</span><span class="p">():</span>
</span><span class="line">    <span class="k">print</span> <span class="s">"pinging ..."</span>
</span><span class="line">    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://APPNAME.herokuapp.com/'</span><span class="p">)</span>
</span><span class="line">    <span class="n">current_number_of_dynos</span> <span class="o">=</span> <span class="n">get_current_dyno_quantity</span><span class="p">()</span>
</span><span class="line">    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&lt;</span> <span class="mi">200</span> <span class="ow">or</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&gt;</span> <span class="mi">299</span><span class="p">:</span>
</span><span class="line">        <span class="k">if</span> <span class="n">current_number_of_dynos</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
</span><span class="line">            <span class="k">print</span> <span class="s">'Scaling out ...'</span>
</span><span class="line">            <span class="k">print</span> <span class="n">scale</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span class="line">    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">elapsed</span><span class="o">.</span><span class="n">microseconds</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">&gt;</span> <span class="mi">5000</span><span class="p">:</span>
</span><span class="line">        <span class="k">if</span> <span class="n">current_number_of_dynos</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
</span><span class="line">            <span class="k">print</span> <span class="s">'Scaling out ...'</span>
</span><span class="line">            <span class="k">print</span> <span class="n">scale</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we send a GET request to our app (make sure to update the URL), and if the status code falls outside the 200-range or if the response takes longer than 5000 milliseconds, then we scale out (as long as the current number of dynos does not exceed 3).</p>

<p>Want to test this out? Manually remove all dynos from your app, and then open the logs:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line">heroku ps:scale <span class="nv">web</span><span class="o">=</span>0
</span><span class="line">Scaling web processes... <span class="k">done</span>, now running 0
</span><span class="line"><span class="nv">$ </span>heroku <span class="nv">ps</span>
</span><span class="line"><span class="o">===</span> clock: <span class="sb">`</span>python autoscale.py<span class="sb">`</span>
</span><span class="line">clock.1: up 2014/11/04 15:47:06 <span class="o">(</span>~ 3m ago<span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="nv">$ </span>heroku logs --tail
</span><span class="line">2014-11-04T21:53:06.633786+00:00 app<span class="o">[</span>clock.1<span class="o">]</span>: pinging ...
</span><span class="line">2014-11-04T21:53:06.738860+00:00 app<span class="o">[</span>clock.1<span class="o">]</span>: Scaling out ...
</span><span class="line">2014-11-04T21:53:06.817780+00:00 heroku<span class="o">[</span>api<span class="o">]</span>: Scale to <span class="nv">clock</span><span class="o">=</span>1, <span class="nv">web</span><span class="o">=</span>3 by michael@realpython.com
</span><span class="line">2014-11-04T21:53:10.740655+00:00 heroku<span class="o">[</span>web.1<span class="o">]</span>: Starting process with <span class="nb">command</span> <span class="sb">`</span>gunicorn hello:app<span class="sb">`</span>
</span><span class="line">2014-11-04T21:53:10.634433+00:00 heroku<span class="o">[</span>web.2<span class="o">]</span>: Starting process with <span class="nb">command</span> <span class="sb">`</span>gunicorn hello:app<span class="sb">`</span>
</span><span class="line">2014-11-04T21:53:11.338596+00:00 heroku<span class="o">[</span>web.3<span class="o">]</span>: Starting process with <span class="nb">command</span> <span class="sb">`</span>gunicorn hello:app<span class="sb">`</span>
</span><span class="line">2014-11-04T21:53:11.929276+00:00 heroku<span class="o">[</span>web.2<span class="o">]</span>: State changed from starting to up
</span><span class="line">2014-11-04T21:53:12.731831+00:00 heroku<span class="o">[</span>web.3<span class="o">]</span>: State changed from starting to up
</span><span class="line">2014-11-04T21:53:12.632277+00:00 heroku<span class="o">[</span>web.1<span class="o">]</span>: State changed from starting to up
</span><span class="line">2014-11-04T21:56:06.611123+00:00 app<span class="o">[</span>clock.1<span class="o">]</span>: pinging ...
</span><span class="line">2014-11-04T21:56:06.723760+00:00 app<span class="o">[</span>clock.1<span class="o">]</span>: ... success!
</span></code></pre></td></tr></table></div></figure>


<p>Perfect!</p>

<a name="Next.Steps"/>
<h2>Next Steps</h2>

<p>Well, we now have a script (<a href="https://gist.github.com/mjhea0/e1436b693cc56ca82277">download</a>) that automates the scaling of Heroku dynos. Hopefully this will allow you to keep your application up and running while also saving some much needed cash. You should sleep a bit sounder too knowing that your application will automatically scale out if there’s a huge influx of traffic.</p>

<p>What’s next?</p>

<ol>
<li>Autoscale In: Automatically scale in when the response takes less than, say, 1000 milliseconds.</li>
<li>Failure Emails/Text Messages: If <em>anything</em> breaks, send an email and/or text message.</li>
<li>Charts: Create some charts so you can better understand your traffic/peak periods/etc. via D3.</li>
</ol>


<p><em>Finally, our friends at <strong><a href="https://runbook.io/">Runbook</a></strong> manage autoscaling – and much more! – from the cloud! The process is much simpler. Check them out.</em></p>

<p>Cheers!</p>
</div>


      </div></body></html>