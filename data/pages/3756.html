<html><body><div><article class="markdown-body entry-content" itemprop="text"><h1><a id="user-content-cron-metrics" class="anchor" href="#cron-metrics" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>cron-metrics</h1>

<p>Implementation of a monitoring system of interval cron tasks in Python. Useful for metrics tasks that need to run every n minutes.</p>

<p>Implementation requiring Plan and Crab. </p>

<ul>
<li><a href="https://github.com/manugarri/Plan">Plan</a> to create the crontab.</li>
<li><a href="https://github.com/manugarri/crab">Crab</a> to provide a dashboard to monitor the tasks.</li>
</ul>

<h4><a id="user-content-installation" class="anchor" href="#installation" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Installation</h4>

<ol>
<li>Install <code>sqlite3</code></li>
<li><code>pip install -r requirements.txt</code></li>
<li><p>Crab specific steps:</p>

<p>2.1 Need to add a <code>crabd.ini</code> file in either <code>~/.crab</code> or <code>/etc/crab</code>. </p>

<p>2.2 <a href="http://crab.readthedocs.org/en/latest/server.html">recreate</a> <code>crabdb.db</code>:</p>

<pre><code>`% sqlite3 crab.db &lt; doc/schema.txt`
</code></pre>

<p>2.3 Download jquery and Font Awesome and install them on the <code>res</code> folder (specified in <code>crabd.ini</code>).</p>

<p>2.4 Port 8000 needs to be accesible on the machine (if using other port, need to change it in crabd.ini)</p></li>
<li><p>Modify <code>config.yml</code> (example included in <code>config.yml.example</code>).
3.1. Change the <code>plan</code> user to the user in charge of running the crontab.
3.2. Change the <code>path</code> in the <code>plan</code> section to the path where your <code>modules</code> folder will be located.</p></li>
</ol>

<h4><a id="user-content-usage" class="anchor" href="#usage" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Usage</h4>

<ol>
<li>To add a task:</li>
<li>Create a folder on the <code>/modules</code> folder. That task should have one entrypoint (one file run as <code>__main__</code>).
(preferably named <code>module_main.py</code>.</li>
<li>Add that task on the <code>task</code> section of <code>config.yml</code>.

<ul>
<li>the <code>name</code> of the task should be the name of the folder you created for it.</li>
<li>task_specs should include the <a href="http://plan.readthedocs.org/job_definition.html">plan</a> dsl for setting up a cron.</li>
<li>If you need to import some task specific variables, you can either use the <code>environment</code> paramenter on the task config, or use the <code>utils.get_task_config(task_name)</code> that returns an <code>Env</code> object with the task config as attributes.</li>
</ul></li>
<li><p>Use <code>python start_cron.py write</code> to create the crontab with all the tasks, and start the crab dashboard.
You can go to <code>localhost:8000</code> to see it in action.</p></li>
</ol>

<ul>
<li>Use <code>python start_cron.py clear</code> to empy the crontab, clean the <code>/logs</code> folder and kill <code>crabd</code></li>
</ul>

<h4><a id="user-content-screenshots" class="anchor" href="#screenshots" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Screenshots</h4>

<p><a href="https://raw.githubusercontent.com/manugarri/cron-metrics/master/metrics-collector/Screenshot%20from%202015-03-19%2021%3A04%3A28.png" target="_blank"><img src="https://raw.githubusercontent.com/manugarri/cron-metrics/master/metrics-collector/Screenshot%20from%202015-03-19%2021%3A04%3A28.png" alt=""/></a></p>

<p>By using the <code>utils.crab_task</code> context manager, every task gets sent to crab, along with their stdout and stderr.</p>

<p><a href="https://raw.githubusercontent.com/manugarri/cron-metrics/master/metrics-collector/Screenshot%20from%202015-03-19%2021%3A03%3A36.png" target="_blank"><img src="https://raw.githubusercontent.com/manugarri/cron-metrics/master/metrics-collector/Screenshot%20from%202015-03-19%2021%3A03%3A36.png" alt=""/></a></p>

<p>You can see the history of each task.</p>
</article>
  </div></body></html>