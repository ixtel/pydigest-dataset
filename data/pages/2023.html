<html><body><div><div id="article_text">
    <p>Donald Stufft, one of the core contributors to <a class="reference external" href="https://github.com/pypa/pip">pip</a>, wrote a <a class="reference external" href="https://caremad.io/blog/a-look-at-pypi-downloads/">blog post</a> last year detailing four days of traffic to PyPI's CDN provider. One of the metrics showed that pip is used for 75% of installations using PyPI. The tool has proved so useful and popular that in October 2013 <a class="reference external" href="https://mail.python.org/pipermail/python-dev/2013-October/129810.html">it was agreed</a> pip would be included alongside Python from version 3.4 onward.</p>
<p>I've been served well by pip for my entire time as a Pythonista but occasionally I require functionality that is unavailable in pip itself. Below I explore some solutions to those edge cases.</p>
<div class="section" id="running-the-latest-version-of-pip">
<h2>Running the latest version of pip</h2>
<p>Before executing any commands quoted in this post make sure your version of pip is reasonably up-to-date. As of this writing 1.5.4 is the lastest release supported by Ubuntu and 1.5.6 was the latest version on <a class="reference external" href="https://github.com/pypa/pip/releases">GitHub</a>.</p>
<div class="highlight"><pre>$ pip --version
pip 1.1 ... (python 2.7)

$ sudo apt-get update
$ sudo apt-get install --only-upgrade python-pip
$ pip --version
pip 1.5.4 ... (python 2.7)
</pre></div>
<p>If you're running Python 3.4 or higher then this is a non-issue as pip is already packaged with your Python installation.</p>
</div>
<div class="section" id="see-all-versions-available">
<h2>See all versions available</h2>
<p>Search functionality at the package name level is supported in pip but if you want to see all versions of a certain package that are available from PyPI then <a class="reference external" href="https://github.com/cakebread/yolk">yolk</a> can be useful:</p>
<div class="highlight"><pre><span class="nv">$ </span>pip install yolk
<span class="nv">$ </span>yolk -V django
Django 1.7.1
Django 1.7
Django 1.6.8
Django 1.6.7
...
</pre></div>
</div>
<div class="section" id="update-the-outdated">
<h2>Update the outdated</h2>
<p>Finding outdated packages via pip has been possible for some time:</p>
<div class="highlight"><pre>$ pip list --outdated
setuptools (Current: 2.2 Latest: 7.0)
pip (Current: 1.5.4 Latest: 1.5.6)
ansible (Current: 1.7.1 Latest: 1.7.2)
</pre></div>
<p>But if you want to update all outdated packages or pick-and-choose interactively then the <cite>pip-review</cite> tool included in <a class="reference external" href="https://github.com/nvie/pip-tools">pip-tools</a> does a good job of this.</p>
<p>For example, I'll install some older versions of Django and Ansible:</p>
<div class="highlight"><pre><span class="nv">$ </span>pip install <span class="s1">'ansible&lt;1.5'</span> <span class="s1">'Django&lt;1.5'</span>
<span class="nv">$ </span>pip freeze <span class="p">|</span> grep -i <span class="s1">'django\|ansible'</span>
<span class="nv">Django</span><span class="o">==</span>1.4.16
<span class="nv">ansible</span><span class="o">==</span>1.4.5
</pre></div>
<p>With one command I can update them to the latest, stable versions:</p>
<div class="highlight"><pre><span class="nv">$ </span>pip-review --auto
Downloading/unpacking <span class="nv">Django</span><span class="o">==</span>1.7.1
...
  Found existing installation: Django 1.4.16
    Uninstalling Django:
      Successfully uninstalled Django
Successfully installed Django
...
Downloading/unpacking <span class="nv">ansible</span><span class="o">==</span>1.7.2
...
Successfully installed ansible

<span class="nv">$ </span>pip freeze <span class="p">|</span> grep -i <span class="s1">'django\|ansible'</span>
<span class="nv">Django</span><span class="o">==</span>1.7.1
<span class="nv">ansible</span><span class="o">==</span>1.7.2
</pre></div>
<p>Keep in mind that pip-review only works with packages that following the versioning scheme outlined in <a class="reference external" href="http://legacy.python.org/dev/peps/pep-0440/">PEP 440</a>. A notable package that up until recently didn't follow this convention was <a class="reference external" href="https://pypi.python.org/pypi/pytz/">pytz</a>. It used a <cite>&lt;YEAR&gt;&lt;Revision character&gt;</cite> format so versions like <cite>2013b</cite> looked like a beta version to pip-review instead of the second, stable release of 2013. As of version <cite>2013.6</cite> they've switched to a <cite>&lt;YEAR&gt;.&lt;MONTH&gt;</cite> scheme that works well with PEP 440 and pip-review.</p>
</div>
<div class="section" id="cryptographically-guaranteeing-packages">
<h2>Cryptographically guaranteeing packages</h2>
<p>You can specify version numbers and commit IDs when freezing package requirements with pip but you can't pin package contents to a specific cryptographic hash. If a new version of a package was released to PyPI without a version increment or there was a man-in-the-middle attack between your machine and PyPI you might not know with pip alone.</p>
<p>There is a tool called <cite>peep</cite> which will hash package contents in your requirements file and generate a new one with hashes above each package. Then if you install with peep again (i.e. on a continuous integration server) every package downloaded will be checked against the hash saved in the requirements file.</p>
<div class="highlight"><pre><span class="nv">$ </span>pip install peep
<span class="nv">$ </span>peep install -r requirements.txt
Downloading/unpacking <span class="nv">Jinja2</span><span class="o">==</span>2.7.3
...
Successfully downloaded requests
Cleaning up...

The following packages had no hashes specified in the requirements file, which
leaves them open to tampering. Vet these packages to your satisfaction, <span class="k">then</span>
add these <span class="s2">"sha256"</span> lines like so:

<span class="c"># sha256: LiSsXQBNtXFJdqBKwOgMbfbkfpjDVMssDYL4h51Pj9s</span>
<span class="nv">Jinja2</span><span class="o">==</span>2.7.3

<span class="c"># sha256: pOwa_1m5WhS0XrLiN2GgF56YMZ2lp-t2tW6ozce4ccM</span>
<span class="nv">MarkupSafe</span><span class="o">==</span>0.23

<span class="c"># sha256: w2yTiocuX_SUk4szsUqqFWy0OexnVI_Ks1Nbt4sIRug</span>
<span class="nv">PyYAML</span><span class="o">==</span>3.11

<span class="c"># sha256: oXznFrR_gx6pyIvaszdT-jhwx-qKHuXowSh8pAyEmKw</span>
<span class="nv">ansible</span><span class="o">==</span>1.7.2

<span class="c"># sha256: Bx84YUW6eC21bJppfjQAY_rkIrbscuoo4Gsde5WUyVk</span>
<span class="nv">dopy</span><span class="o">==</span>0.3.0

<span class="c"># sha256: jjtsGT-R3JSy87AmHj6rvcYE94_5n9rTJKVv3QtelYw</span>
<span class="nv">ecdsa</span><span class="o">==</span>0.11

<span class="c"># sha256: mgm6flv6VZOHKXqbO8qq1wKZtedoAsXqSCn2h9urojE</span>
<span class="nv">paramiko</span><span class="o">==</span>1.15.1

<span class="c"># sha256: 8s4emJsnLPy2d2FnY-Ci5-xlnv-meoiqkrOmVSj2Cjw</span>
<span class="nv">pycrypto</span><span class="o">==</span>2.6.1

<span class="c"># sha256: EkiQ9BcjyFqoLf4IB0Mq6kbSSusNr840CWnSCJVIwsM</span>
<span class="nv">requests</span><span class="o">==</span>2.4.3

-------------------------------
Not proceeding to installation.
</pre></div>
<p>I took the pairs of hashes and packages generated above and placed them back into requirements.txt:</p>
<div class="highlight"><pre><span class="nv">$ </span>cat requirements.txt
<span class="c"># sha256: LiSsXQBNtXFJdqBKwOgMbfbkfpjDVMssDYL4h51Pj9s</span>
<span class="nv">Jinja2</span><span class="o">==</span>2.7.3

<span class="c"># sha256: pOwa_1m5WhS0XrLiN2GgF56YMZ2lp-t2tW6ozce4ccM</span>
<span class="nv">MarkupSafe</span><span class="o">==</span>0.23

<span class="c"># sha256: w2yTiocuX_SUk4szsUqqFWy0OexnVI_Ks1Nbt4sIRug</span>
<span class="nv">PyYAML</span><span class="o">==</span>3.11

<span class="c"># sha256: oXznFrR_gx6pyIvaszdT-jhwx-qKHuXowSh8pAyEmKw</span>
<span class="nv">ansible</span><span class="o">==</span>1.7.2

<span class="c"># sha256: Bx84YUW6eC21bJppfjQAY_rkIrbscuoo4Gsde5WUyVk</span>
<span class="nv">dopy</span><span class="o">==</span>0.3.0

<span class="c"># sha256: jjtsGT-R3JSy87AmHj6rvcYE94_5n9rTJKVv3QtelYw</span>
<span class="nv">ecdsa</span><span class="o">==</span>0.11

<span class="c"># sha256: mgm6flv6VZOHKXqbO8qq1wKZtedoAsXqSCn2h9urojE</span>
<span class="nv">paramiko</span><span class="o">==</span>1.15.1

<span class="c"># sha256: 8s4emJsnLPy2d2FnY-Ci5-xlnv-meoiqkrOmVSj2Cjw</span>
<span class="nv">pycrypto</span><span class="o">==</span>2.6.1

<span class="c"># sha256: EkiQ9BcjyFqoLf4IB0Mq6kbSSusNr840CWnSCJVIwsM</span>
<span class="nv">requests</span><span class="o">==</span>2.4.3
</pre></div>
<p>From then on I can just install requirements via peep to ensure I cryptographically use the same package contents each time I download them.</p>
<div class="highlight"><pre><span class="nv">$ </span>peep install -r requirements.txt
</pre></div>
</div>
<div class="section" id="dependency-graphs">
<h2>Dependency graphs</h2>
<p>You can see package dependencies using pip but if you want to see the dependences of those dependences then you need to go through each of them individually:</p>
<div class="highlight"><pre><span class="nv">$ </span>pip show ansible <span class="p">|</span> grep Requires
Requires: paramiko, jinja2, PyYAML, httplib2

<span class="nv">$ </span>pip show paramiko <span class="p">|</span> grep Requires
Requires: pycrypto, ecdsa
</pre></div>
<p>There is a tool called <a class="reference external" href="https://github.com/naiquevin/pipdeptree">pipdeptree</a> that will show the whole family tree of dependences in your environment.</p>
<div class="highlight"><pre>$ pip install pipdeptree
$ pipdeptree
...
argparse==1.2.1
wsgiref==0.1.2
peep==1.3
ansible==1.7.1
  - paramiko [installed: 1.15.1]
    - pycrypto [required: &gt;=2.1, installed: 2.6.1]
    - ecdsa [required: &gt;=0.11, installed: 0.11]
  - Jinja2 [installed: 2.7.3]
    - MarkupSafe [installed: 0.23]
  - PyYAML [installed: 3.11]
  - setuptools
  - pycrypto [required: &gt;=2.6, installed: 2.6.1]
dopy==0.3.0
  - requests [required: &gt;=1.0.4, installed: 2.4.3]
</pre></div>
<p>This can be useful on projects that have not kept well-maintained <cite>requirements.txt</cite> files or for separating development from production requirements.</p>
</div>
<div class="section" id="check-for-package-conflicts">
<h2>Check for package conflicts</h2>
<p>If you want to find dependency conflicts among requirements <a class="reference external" href="https://github.com/dracos/check-pip-dependencies">check-pip-dependencies</a> and <a class="reference external" href="https://github.com/ambitioninc/pip-conflict-checker">pip-conflict-checker</a> are two tools that can help track these down. Both projects have low commit counts and activity on GitHub so it might be worth double-checking their work afterword.</p>
</div>
<div class="section" id="excluding-packages">
<h2>Excluding packages</h2>
<p>I had problems with <cite>distribute==0.6.4</cite> appearing in requirements.txt files I was working with in 2012 and 2013 that would cause pip to deactivate when it tried to install distribute. Usually blindly running <cite>pip freeze &gt; requirements.txt</cite> would include it in the requirements.txt files I was working with.</p>
<p>I never found a way to blacklist packages by name with pip so I resorted to the following bash command to avoid installing distribute when installing package requirements:</p>
<div class="highlight"><pre><span class="nv">$ </span>grep -v distribute requirements.txt <span class="p">|</span> xargs pip install
</pre></div>
</div>
<div class="section" id="remove-unneeded-packages">
<h2>Remove unneeded packages</h2>
<p>If you want to remove unused dependencies from your environment <a class="reference external" href="https://github.com/invl/pip-autoremove">pip-autoremove</a> can do the job. The only requirement is that you list the top-level requirements you know you need and it'll remove any orphaned dependencies:</p>
<div class="highlight"><pre><span class="nv">$ </span>pip-autoremove Flask Sphinx -y
</pre></div>
</div>
<div class="section" id="separate-production-and-development-requirements">
<h2>Separate production and development requirements</h2>
<p>If you wish to keep development dependencies off production systems then splitting your requirements.txt file up into two separate files can be helpful.</p>
<p>But if you then want to run <cite>pip freeze</cite> to save updated package version pinnings it won't separate out the packages into separate production and development requirements files. There is another tool in <a class="reference external" href="https://github.com/nvie/pip-tools">pip-tools</a> called <cite>pip-dump</cite> that will do that.</p>
<p>It looks to match the package names up in files matching the <a class="reference external" href="https://github.com/nvie/pip-tools/blob/24e4b15a134e4b910db4a88026fb1dbafc84d350/bin/pip-dump#L33">following patterns</a>:</p>
<div class="highlight"><pre><span class="n">GLOB_PATTERNS</span> <span class="o">=</span> <span class="p">(</span><span class="s">u'*requirements.txt'</span><span class="p">,</span> <span class="s">u'requirements[_-]*.txt'</span><span class="p">,</span> <span class="s">u'requirements/*.txt'</span><span class="p">)</span>
</pre></div>
<p>I've added a few older packages to my requirements files here:</p>
<div class="highlight"><pre><span class="nv">$ </span>cat requirements.txt
<span class="nv">Django</span><span class="o">==</span>1.4.16
<span class="nv">ansible</span><span class="o">==</span>1.4.5
<span class="nv">requests</span><span class="o">==</span>2.4.3

<span class="nv">$ </span>cat requirements-dev.txt
<span class="nv">coverage</span><span class="o">==</span>3.7.1
<span class="nv">dopy</span><span class="o">==</span>0.3.0
<span class="nv">peep</span><span class="o">==</span>1.3
pip-tools<span class="o">==</span>0.3.5
<span class="nv">pipdeptree</span><span class="o">==</span>0.4.1
<span class="nv">pycrypto</span><span class="o">==</span>2.6.1
</pre></div>
<p>I'll install them, update them to their latest versions and then save them back into their respective requirements files:</p>
<div class="highlight"><pre><span class="nv">$ </span>pip install -r requirements.txt
<span class="nv">$ </span>pip install -r requirements-dev.txt
<span class="nv">$ </span>pip-review --auto
<span class="nv">$ </span>pip-dump
</pre></div>
<p>Packages that were in requirements.txt and requirements-dev.txt now have their respective latest version numbers:</p>
<div class="highlight"><pre><span class="nv">$ </span>cat requirements.txt
<span class="nv">ansible</span><span class="o">==</span>1.7.2
<span class="nv">Django</span><span class="o">==</span>1.7.1
<span class="nv">ecdsa</span><span class="o">==</span>0.11
<span class="nv">httplib2</span><span class="o">==</span>0.9
<span class="nv">Jinja2</span><span class="o">==</span>2.7.3
<span class="nv">MarkupSafe</span><span class="o">==</span>0.23
<span class="nv">paramiko</span><span class="o">==</span>1.15.1
<span class="nv">PyYAML</span><span class="o">==</span>3.11
<span class="nv">requests</span><span class="o">==</span>2.4.3

<span class="nv">$ </span>cat requirements-dev.txt
<span class="nv">coverage</span><span class="o">==</span>3.7.1
<span class="nv">dopy</span><span class="o">==</span>0.3.0
<span class="nv">peep</span><span class="o">==</span>1.3
pip-tools<span class="o">==</span>0.3.5
<span class="nv">pipdeptree</span><span class="o">==</span>0.4.1
<span class="nv">pycrypto</span><span class="o">==</span>2.6.1
</pre></div>
</div>
<div class="section" id="linting-your-requirements-files">
<h2>Linting your requirements files</h2>
<p>If you want to find possible issues in your requirements files then <a class="reference external" href="https://github.com/dcramer/piplint">piplint</a> can help:</p>
<div class="highlight"><pre><span class="nv">$ </span>pip install piplint
<span class="nv">$ </span>piplint requirements*

For debugging purposes, the following packages are installed but not in the requirements file<span class="o">(</span>s<span class="o">)</span>:
<span class="nv">argparse</span><span class="o">==</span>1.2.1
<span class="nv">piplint</span><span class="o">==</span>0.2.0
<span class="nv">wsgiref</span><span class="o">==</span>0.1.2
</pre></div>
</div>
<div class="section" id="speeding-up-installations">
<h2>Speeding up installations</h2>
<p><a class="reference external" href="https://caremad.io/blog/a-look-at-pypi-downloads/">PyPI uses Fastly</a> as a CDN so downloads from them should be reasonably consistent. That's not to say the installation process can't be sped up. <a class="reference external" href="https://warehouse.python.org/project/pip-accel/">pip-accel</a> will cache source code and binaries compiled during installation so that they won't need to be downloaded/re-compiled if you download the same version again.</p>
<div class="highlight"><pre><span class="nv">$ </span>cat requirements.txt
<span class="nv">pytz</span><span class="o">==</span>2013.6
</pre></div>
<div class="highlight"><pre><span class="nv">$ </span>pip-accel install -r requirements.txt
...
... Done! Took 4.94 seconds to install <span class="m">1</span> package.
</pre></div>
<div class="highlight"><pre><span class="nv">$ </span>pip uninstall pytz
...
  Successfully uninstalled pytz
</pre></div>
<div class="highlight"><pre><span class="nv">$ </span>pip-accel install -r requirements.txt
...
... Executing <span class="nb">command</span>: pip install <span class="se">\</span>
    --download-cache<span class="o">=</span>/home/mark/.pip/download-cache <span class="se">\</span>
    --find-links<span class="o">=</span>file:///home/mark/.pip-accel/sources <span class="se">\</span>
    --build-directory<span class="o">=</span>/tmp/tmpztEZvg <span class="se">\</span>
    --no-index -r requirements.txt --no-install
...
... Done! Took 1.48 second to install <span class="m">1</span> package.
</pre></div>
</div>

  </div>

   <div id="support_text"><p>
    Thank you for taking the time to read this post. If you're considering using </p><a href="https://www.digitalocean.com/?refcode=074ce6598105">Digital Ocean</a><p>, the hosting provider this blog is hosted on, please consider using </p><a href="https://www.digitalocean.com/?refcode=074ce6598105">this link to sign up</a><p>.
  </p></div>


  
</div></body></html>