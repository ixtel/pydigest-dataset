<html><body><div><div class="post-content" itemprop="articleBody">
    <p>This is the second part of the <a href="http://bits.citrusbyte.com/protecting-a-python-codebase/">Protecting a Python codebase</a>
series. This time we will be playing with Python <a href="https://docs.python.org/2/library/ast.html">Abstract Syntax Trees</a>
in order to protect the original code of a Python based project.</p>

<h2 id="python-abstract-syntax-trees">Python Abstract Syntax Trees</h2>

<p>As the <a href="https://docs.python.org/2/library/ast.html">Python Documentation</a> says:</p>

<blockquote>
  <p>The ast module helps Python applications to process trees of the
  Python abstract syntax grammar. The abstract syntax itself might
  change with each Python release; this module helps to find out
  programmatically what the current grammar looks like.</p>
</blockquote>

<p>The built-in module provides the tools to navigate, create or modify a
tree. A Python AST is tree-like representation of the python code
that’s closer to the <a href="https://docs.python.org/2/glossary.html#term-bytecode">bytecode</a> implementation than the source code
itself.</p>

<p>Take for instance the code in a little python module named <code>hello.py</code>:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="k">def</span> <span class="nf">hello_world</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'World'</span><span class="p">):</span>
<span class="lineno">2</span>     <span class="k">print</span><span class="p">(</span><span class="s">'Hello {0}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span></code></pre></div>

<p>We can get the tree representation using the <code>ast</code> module:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="kn">import</span> <span class="nn">ast</span>
<span class="lineno">2</span> 
<span class="lineno">3</span> <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'hello.py'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<span class="lineno">4</span>     <span class="n">code</span> <span class="o">=</span> <span class="s">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">())</span>
<span class="lineno">5</span>     <span class="n">root</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">code</span><span class="p">)</span></code></pre></div>

<p>We can also write a node visitor to inspect the tree structure:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="kn">import</span> <span class="nn">ast</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="k">class</span> <span class="nc">Visitor</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeVisitor</span><span class="p">):</span>
<span class="lineno"> 4</span>     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno"> 5</span>         <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="mi">0</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span>     <span class="k">def</span> <span class="nf">visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<span class="lineno"> 8</span>         <span class="k">print</span> <span class="s">"  "</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">,</span> <span class="n">node</span>
<span class="lineno"> 9</span>         <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="lineno">10</span>         <span class="nb">super</span><span class="p">(</span><span class="n">Visitor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<span class="lineno">11</span>         <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">-=</span> <span class="mi">1</span></code></pre></div>

<p>Applying the visitor to the parsed code will result in something like:</p>

<div class="highlight"><pre><code class="language-pycon" data-lang="pycon"><span class="gp">&gt;&gt;&gt; </span><span class="n">Visitor</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<span class="go">&lt;_ast.Module object at 0x7fb5200282d0&gt;</span>
<span class="go">  &lt;_ast.FunctionDef object at 0x7fb5200281d0&gt;</span>
<span class="go">    &lt;_ast.arguments object at 0x7fb520028210&gt;</span>
<span class="go">      &lt;_ast.Name object at 0x7fb520028d90&gt;</span>
<span class="go">        &lt;_ast.Param object at 0x7fb521c46810&gt;</span>
<span class="go">      &lt;_ast.Str object at 0x7fb520028550&gt;</span>
<span class="go">    &lt;_ast.Print object at 0x7fb520028dd0&gt;</span>
<span class="go">      &lt;_ast.Call object at 0x7fb520028ed0&gt;</span>
<span class="go">        &lt;_ast.Attribute object at 0x7fb520028f10&gt;</span>
<span class="go">          &lt;_ast.Str object at 0x7fb520028f50&gt;</span>
<span class="go">          &lt;_ast.Load object at 0x7fb521c46590&gt;</span>
<span class="go">        &lt;_ast.Name object at 0x7fb520028f90&gt;</span>
<span class="go">          &lt;_ast.Load object at 0x7fb521c46590&gt;</span></code></pre></div>

<p>Each element has its own set of attributes to fulfill the operation,
<code>Module</code> objects have a <code>body</code> attribute which is a list with the
different elements defined in it. <code>Call</code> have the function name to
<em>call</em> (in the example above it refers to the <code>format</code> method in
<code>String</code>). There’s a <code>_field</code> property with the list of attributes
supported by the different types.</p>

<p>Python <a href="https://docs.python.org/2/library/ast.html">Abstract Syntax Trees</a> are a
really powerful tool, we can build really neat tools with them, tools
to gather code statistics, tools to translate Python to other
languages. We will use it to write a code scrambling and unscrambling
tool, that combined with an <a href="/protecting-a-python-codebase/#extending-the-import-process">import hook</a> will serve as a
protection mechanism.</p>

<p>For that we need a <a href="https://docs.python.org/2/library/ast.html#ast.NodeTransformer">NodeTransformer</a> class:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="kn">from</span> <span class="nn">ast</span> <span class="kn">import</span> <span class="n">NodeTransformer</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> 
<span class="lineno"> 4</span> <span class="k">class</span> <span class="nc">Scrambler</span><span class="p">(</span><span class="n">NodeTransformer</span><span class="p">):</span>
<span class="lineno"> 5</span>     <span class="n">HEADER</span> <span class="o">=</span> <span class="s">'# scrambled'</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span>     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scramble</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
<span class="lineno"> 8</span>         <span class="bp">self</span><span class="o">.</span><span class="n">do_scramble</span> <span class="o">=</span> <span class="n">scramble</span>
<span class="lineno"> 9</span> 
<span class="lineno">10</span>     <span class="k">def</span> <span class="nf">visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<span class="lineno">11</span>         <span class="n">node_out</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Scrambler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<span class="lineno">12</span>         <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node_out</span><span class="p">,</span> <span class="s">'body'</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node_out</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
<span class="lineno">13</span>             <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_scramble</span><span class="p">:</span>
<span class="lineno">14</span>                 <span class="n">node_out</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scramble</span><span class="p">(</span><span class="n">node_out</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
<span class="lineno">15</span>             <span class="k">else</span><span class="p">:</span>
<span class="lineno">16</span>                 <span class="n">node_out</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unscramble</span><span class="p">(</span><span class="n">node_out</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
<span class="lineno">17</span>         <span class="k">return</span> <span class="n">node_out</span>
<span class="lineno">18</span> 
<span class="lineno">19</span>     <span class="k">def</span> <span class="nf">scramble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
<span class="lineno">20</span>         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step1</span><span class="p">(</span><span class="n">items</span><span class="p">[:]))</span>
<span class="lineno">21</span> 
<span class="lineno">22</span>     <span class="k">def</span> <span class="nf">unscramble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
<span class="lineno">23</span>         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step2</span><span class="p">(</span><span class="n">items</span><span class="p">[:]))</span>
<span class="lineno">24</span> 
<span class="lineno">25</span>     <span class="k">def</span> <span class="nf">_step1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
<span class="lineno">26</span>         <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="lineno">27</span>         <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
<span class="lineno">28</span>         <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">:</span>
<span class="lineno">29</span>             <span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">items</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="lineno">30</span>             <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span>
<span class="lineno">31</span>         <span class="k">return</span> <span class="n">items</span>
<span class="lineno">32</span> 
<span class="lineno">33</span>     <span class="k">def</span> <span class="nf">_step2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
<span class="lineno">34</span>         <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
<span class="lineno">35</span>         <span class="k">if</span> <span class="n">length</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="lineno">36</span>             <span class="n">items</span><span class="p">[:</span><span class="n">length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span> <span class="n">items</span><span class="p">[</span><span class="n">length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> \
<span class="lineno">37</span>                 <span class="n">items</span><span class="p">[</span><span class="n">length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">:],</span> <span class="n">items</span><span class="p">[:</span><span class="n">length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span>
<span class="lineno">38</span>         <span class="k">else</span><span class="p">:</span>
<span class="lineno">39</span>             <span class="n">items</span><span class="p">[:(</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span> <span class="n">items</span><span class="p">[(</span><span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> \
<span class="lineno">40</span>                 <span class="n">items</span><span class="p">[(</span><span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">:],</span> <span class="n">items</span><span class="p">[:(</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span>
<span class="lineno">41</span>         <span class="k">return</span> <span class="n">items</span></code></pre></div>

<p>This code will take a <a href="https://docs.python.org/2/library/ast.html">Python AST</a>, and
scramble it by swapping them items in those with a <code>body</code> attribute
that’s of type <code>list</code>. The transformation applied will be similar to:</p>

<div class="highlight"><pre><code class="language-pycon" data-lang="pycon"><span class="gp">&gt;&gt;&gt; </span><span class="n">original</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">after_step_1</span> <span class="o">=</span> <span class="n">step1</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>
<span class="go">[2, 1, 4, 3, 6, 5]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">after_step_2</span> <span class="o">=</span> <span class="n">step2</span><span class="p">(</span><span class="n">after_step_1</span><span class="p">)</span>
<span class="go">[3, 6, 5, 2, 1, 4]</span></code></pre></div>

<p>Which is easy to transform back, it’s enough to apply the
transformations in the reverse order to get the original object.</p>

<p>If we apply it to the following code:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="kn">import</span> <span class="nn">os</span>
<span class="lineno"> 2</span> <span class="kn">import</span> <span class="nn">pprint</span>
<span class="lineno"> 3</span> 
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span> <span class="k">def</span> <span class="nf">files_tree</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
<span class="lineno"> 6</span>     <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
<span class="lineno"> 7</span>     <span class="n">path</span> <span class="o">=</span> <span class="n">path</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
<span class="lineno"> 8</span>     <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="lineno"> 9</span>     <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
<span class="lineno">10</span>         <span class="k">if</span> <span class="nb">file</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">'.'</span><span class="p">):</span>
<span class="lineno">11</span>             <span class="k">continue</span>
<span class="lineno">12</span> 
<span class="lineno">13</span>         <span class="n">sub_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span>
<span class="lineno">14</span>         <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">sub_path</span><span class="p">):</span>
<span class="lineno">15</span>             <span class="n">value</span> <span class="o">=</span> <span class="n">files_tree</span><span class="p">(</span><span class="n">sub_path</span><span class="p">)</span>
<span class="lineno">16</span>         <span class="k">else</span><span class="p">:</span>
<span class="lineno">17</span>             <span class="n">value</span> <span class="o">=</span> <span class="n">sub_path</span>
<span class="lineno">18</span>         <span class="n">out</span><span class="p">[</span><span class="nb">file</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<span class="lineno">19</span>     <span class="k">return</span> <span class="n">out</span>
<span class="lineno">20</span> 
<span class="lineno">21</span> 
<span class="lineno">22</span> <span class="n">tree</span> <span class="o">=</span> <span class="n">files_tree</span><span class="p">()</span>
<span class="lineno">23</span> <span class="k">print</span> <span class="s">'Items in the top level: {0}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<span class="lineno">24</span> <span class="k">print</span> <span class="s">'Items in the second level: {0}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<span class="lineno">25</span>     <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
<span class="lineno">26</span>         <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">dict</span><span class="p">))</span>
<span class="lineno">27</span> <span class="p">)</span>
<span class="lineno">28</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span></code></pre></div>

<p>It will come out as:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="c"># scrambled</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="k">print</span> <span class="s">'Items in the second level: {0}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">dict</span><span class="p">))))</span>
<span class="lineno"> 4</span> <span class="k">print</span> <span class="s">'Items in the top level: {0}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<span class="lineno"> 5</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span> <span class="k">def</span> <span class="nf">files_tree</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
<span class="lineno"> 8</span>     <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="lineno"> 9</span>     <span class="k">return</span> <span class="n">out</span>
<span class="lineno">10</span>     <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
<span class="lineno">11</span>         <span class="n">out</span><span class="p">[</span><span class="nb">file</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<span class="lineno">12</span>         <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">sub_path</span><span class="p">):</span>
<span class="lineno">13</span>             <span class="n">value</span> <span class="o">=</span> <span class="n">files_tree</span><span class="p">(</span><span class="n">sub_path</span><span class="p">)</span>
<span class="lineno">14</span>         <span class="k">else</span><span class="p">:</span>
<span class="lineno">15</span>             <span class="n">value</span> <span class="o">=</span> <span class="n">sub_path</span>
<span class="lineno">16</span>         <span class="n">sub_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span>
<span class="lineno">17</span>         <span class="k">if</span> <span class="nb">file</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">'.'</span><span class="p">):</span>
<span class="lineno">18</span>             <span class="k">continue</span>
<span class="lineno">19</span>     <span class="n">path</span> <span class="o">=</span> <span class="p">(</span><span class="n">path</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
<span class="lineno">20</span>     <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
<span class="lineno">21</span> <span class="kn">import</span> <span class="nn">pprint</span>
<span class="lineno">22</span> <span class="kn">import</span> <span class="nn">os</span>
<span class="lineno">23</span> <span class="n">tree</span> <span class="o">=</span> <span class="n">files_tree</span><span class="p">()</span></code></pre></div>

<p>And this is just a simple transformation, more changes can be
implemented in order to make things a bit more interesting, some
options to take into account are:</p>

<ul>
  <li>Change parameters order in functions</li>
  <li>Change decorators order in functions</li>
  <li>Change arguments order in function calls</li>
  <li>Change arguments order in class creations</li>
  <li>Rename variable names</li>
  <li><a href="https://github.com/citrusbyte/python-obfuscation/tree/master/ast/hiding_strings">Encode strings with rot13 or similar</a></li>
</ul>

<p>This scrambler with the corresponding <a href="https://github.com/citrusbyte/python-obfuscation/blob/master/ast/scrambling_code/ihook.py">import hook</a>
are published in the <a href="https://github.com/citrusbyte/python-obfuscation/tree/master/ast/scrambling_code">companion examples repository</a>.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Python <a href="https://docs.python.org/2/library/ast.html">Abstract Syntax Trees</a> is a very
versatile tool that allows us to create a solution that better fits
the project where it’s used.</p>

<p>But, as it’s mentioned in the <a href="/protecting-a-python-codebase/#extending-the-import-process">previous article</a>, the
code can be inspected from a shell once it was imported.</p>

<p>If you plan digging more in Python AST, I recommend
<a href="https://greentreesnakes.readthedocs.org/en/latest/">Green Tree Snakes - the missing Python AST docs</a> docs.</p>


  </div>

  
  

  </div></body></html>