<html><body><div><article class="markdown-body entry-content" itemprop="text"><h1><a id="user-content-chronic---python-instrumentation" class="anchor" href="#chronic---python-instrumentation" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Chronic - Python Instrumentation</h1>

<p>Chronic is halfway between a simple timer and a profiler.  Add decorators or wrap code in with statements to get the execution time.  Chronic keeps track of the call hierarchy to tell you what timed blocks executed within other timed blocks.  Attach an event listener to log your timings however you want.</p>

<h2><a id="user-content-installation" class="anchor" href="#installation" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Installation</h2>

<pre><code>pip install chronic
</code></pre>

<h2><a id="user-content-usage" class="anchor" href="#usage" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Usage</h2>

<p>To time a block of code, you can use either the <code>@time</code> decorator or the <code>Timer</code> context manager.</p>

<div class="highlight highlight-source-python"><pre><span class="pl-k">import</span> chronic

<span class="pl-en">@chronic.time</span>
<span class="pl-k">def</span> <span class="pl-en">long_running_method</span>():
  <span class="pl-c"># Do something here</span>

<span class="pl-k">with</span> chronic.Timer(<span class="pl-s"><span class="pl-pds">'</span>crunch_numbers<span class="pl-pds">'</span></span>):
  <span class="pl-c"># Crunch numbers here</span></pre></div>

<h3><a id="user-content-chronictimings" class="anchor" href="#chronictimings" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>chronic.timings</h3>

<p>At any point, you can get the information about completed timing info from <code>chronic.timings</code>.  This is a proxy to state held in a thread local about all timed blocks captured so far.</p>

<div class="highlight highlight-source-python"><pre><span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">import</span> chronic
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> chronic.timings
{
  <span class="pl-s"><span class="pl-pds">'</span>long_running_method<span class="pl-pds">'</span></span>: {
    <span class="pl-s"><span class="pl-pds">'</span>total_elapsed<span class="pl-pds">'</span></span>: <span class="pl-c1">3.068</span>,
    <span class="pl-s"><span class="pl-pds">'</span>average_elapsed<span class="pl-pds">'</span></span>: <span class="pl-c1">3.068</span>,
    <span class="pl-s"><span class="pl-pds">'</span>count<span class="pl-pds">'</span></span>: <span class="pl-c1">1</span>
  },
  <span class="pl-s"><span class="pl-pds">'</span>crunch_numbers<span class="pl-pds">'</span></span>: {
    <span class="pl-s"><span class="pl-pds">'</span>total_elapsed<span class="pl-pds">'</span></span>: <span class="pl-c1">1.884</span>,
    <span class="pl-s"><span class="pl-pds">'</span>average_elapsed<span class="pl-pds">'</span></span>: <span class="pl-c1">1.884</span>,
    <span class="pl-s"><span class="pl-pds">'</span>count<span class="pl-pds">'</span></span>: <span class="pl-c1">1</span>
  }
}</pre></div>

<p><code>chronic.timings</code> is a dict with keys for each timed block of code.  If you use the context manager, you must specify a name.  When using the decorator, you may optionally specify the name, or chronic will use theh function name as a default.</p>

<p>Each timing is itself a dict with the following keys:</p>

<ul>
<li><code>total_elapsed</code>: the elapsed execution time of the code (including all
subtimings) for all runs of this block.  The unit is seconds by default.
If you pass in your own clock function, the unit is whatever the unit of
the clock.</li>
<li><code>count</code>: the number of times the timed block was run.</li>
<li><code>average_elapsed</code>: the average elapsed time for each run of this block.</li>
<li><code>timings</code>: a dict of all subtimings that were completed while inside this
block.</li>
</ul>

<p>So if you're using Django and want to log all timings to MongoDB, all you need to do is add middleware that looks something like this:</p>

<div class="highlight highlight-source-python"><pre><span class="pl-k">import</span> chronic
<span class="pl-k">from</span> pymongo <span class="pl-k">import</span> MongoClient

mongo_client <span class="pl-k">=</span> MongoClient()

<span class="pl-k">class</span> <span class="pl-en">ProfilingMiddleware</span>(<span class="pl-c1">object</span>):
    <span class="pl-k">def</span> <span class="pl-en">process_response</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>, <span class="pl-smi">request</span>, <span class="pl-smi">response</span>):
        mongo_client.app.timings.insert(chronic.timings)
        <span class="pl-k">return</span> response</pre></div>

<h3><a id="user-content-chronicstack" class="anchor" href="#chronicstack" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>chronic.stack</h3>

<p><code>chronic.stack</code> is a tuple of the names of all timed blocks in the call stack above the current context.</p>

<div class="highlight highlight-source-python"><pre><span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">import</span> chronic
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">@</span>chronic.time
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">def</span> <span class="pl-en">time_two</span>():
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span>     <span class="pl-k">with</span> chronic.Timer(<span class="pl-s"><span class="pl-pds">'</span>block2<span class="pl-pds">'</span></span>):
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span>         <span class="pl-c1">print</span> chronic.stack
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> time_two()
(<span class="pl-s"><span class="pl-pds">'</span>time_two<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>block2<span class="pl-pds">'</span></span>)</pre></div>

<h3><a id="user-content-chronicpost_timing" class="anchor" href="#chronicpost_timing" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>chronic.post_timing</h3>

<p>Finally, you can install signal handlers to be called on the completion of all timings.
Here's how you might send all timing data to <a href="https://github.com/etsy/statsd/">statsd</a>:</p>

<div class="highlight highlight-source-python"><pre><span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">import</span> chronic
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">from</span> statsd <span class="pl-k">import</span> StatsClient
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> statsd <span class="pl-k">=</span> StatsClient()
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">def</span> <span class="pl-en">send_to_statsd</span>(<span class="pl-smi">elapsed</span>, <span class="pl-smi">timings</span>, <span class="pl-smi">stack</span>):
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span>     statsd.timing(<span class="pl-s"><span class="pl-pds">'</span>.<span class="pl-pds">'</span></span>.join(stack), elapsed <span class="pl-k">*</span> <span class="pl-c1">1000</span>)
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> chronic.post_timing.connect(send_to_statsd)</pre></div>

<h2><a id="user-content-examples" class="anchor" href="#examples" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Examples</h2>

<div class="highlight highlight-source-python"><pre><span class="pl-k">import</span> chronic
<span class="pl-k">from</span> pprint <span class="pl-k">import</span> pprint


<span class="pl-en">@chronic.time</span>
<span class="pl-k">def</span> <span class="pl-en">time_one</span>():
    <span class="pl-k">pass</span>


<span class="pl-en">@chronic.time</span>
<span class="pl-k">def</span> <span class="pl-en">time_two</span>():
    <span class="pl-k">with</span> chronic.Timer(<span class="pl-s"><span class="pl-pds">'</span>block2<span class="pl-pds">'</span></span>):
        <span class="pl-c1">print</span> chronic.stack
        <span class="pl-c"># ('time_two', 'block2')</span>
    pprint(chronic.timings)
    <span class="pl-c"># prints local view of timings</span>
    <span class="pl-c"># {'block2': {'average_elapsed': 1.0967254638671875e-05,</span>
    <span class="pl-c">#             'count': 1,</span>
    <span class="pl-c">#             'total_elapsed': 1.0967254638671875e-05}}</span>

<span class="pl-k">with</span> chronic.Timer(<span class="pl-s"><span class="pl-pds">'</span>block1<span class="pl-pds">'</span></span>):
    time_one()

pprint(chronic.timings)


<span class="pl-k">def</span> <span class="pl-en">print_done</span>(<span class="pl-smi">elapsed</span>, <span class="pl-smi">timings</span>, <span class="pl-smi">stack</span>):
    <span class="pl-c1">print</span> stack
    pprint(timings)

time_one()
chronic.post_timing.connect(print_done)
time_one()
<span class="pl-c"># []</span>
<span class="pl-c"># 9.5367431640625e-07</span>
<span class="pl-c"># {'average_elapsed': 9.5367431640625e-07,</span>
<span class="pl-c">#  'count': 2,</span>
<span class="pl-c">#  'total_elapsed': 1.9073486328125e-06}</span>
chronic.post_timing.disconnect(print_done)


time_two()
<span class="pl-c"># ['time_two', 'block2']</span>
<span class="pl-c"># {'block2': {'average_elapsed': 5.9604644775390625e-06,</span>
<span class="pl-c">#             'count': 1,</span>
<span class="pl-c">#             'total_elapsed': 5.9604644775390625e-06}}</span></pre></div>

<p>This software is licensed under the MIT license. See the details in the file called LICENSE.</p>
</article>
  </div></body></html>