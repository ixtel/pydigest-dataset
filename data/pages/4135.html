<html><body><div><div class="entry-content">
		<p>Sometimes, moderately complex Python applications with several threads tend to hang on exit. The application refuses to quit and just idles there waiting for something. Often this is because if any of the Python threads are alive when the process tries to exit it will wait any alive thread to terminate, unless <a href="https://docs.python.org/3/library/threading.html?highlight=thread#threading.Thread.daemon">Thread.daemon</a> is set to true.</p>
<p>In the past, it use to be little painful to figure out which thread and function causes the application to hang, but no longer! Since Python 3.3 CPython interpreter comes with a <a href="https://docs.python.org/3/library/faulthandler.html">faulthandler module</a>. faulthandler is a mechanism to tell the Python interpreter to dump the stack trace of every thread upon receiving <a href="http://en.wikipedia.org/wiki/Unix_signal">an external UNIX signal</a>.</p>
<p>Here is an example how to figure out why the unit test run, executed with <a href="pytest.org/">pytest</a>, does not exit cleanly. All tests finish, but the test suite refuses to quit.</p>
<p>First we run the tests and set a special environment variable <em>PYTHONFAULTHANDLER</em> telling CPython interpreter to activate the fault handler. This environment variable works regardless how your Python application is started (you run <em>python</em> command, you run a script directly, etc.)</p>
<pre>PYTHONFAULTHANDLER=true py.test</pre>
<p>And then the test suite has finished, printing out the last dot… but nothing happens despite our ferocious sipping of coffee.</p>
<pre>dotdotdotmoredotsthenthenthedotsstopappearing 
..</pre>
<p>How to proceed:</p>
<p><a href="http://unix.stackexchange.com/q/45025/14115">Press CTRL-Z to suspend the current active process in UNIX shell</a>.</p>
<p>Use the following command to send SIGABRT signal to the suspended process.</p>
<pre>kill -SIGABRT %1</pre>
<p>Voilá – you get the traceback. In this case, it instantly tells SQLAlchemy is waiting for something and most likely the database has deadlocked due to open conflicting transactions.</p>
<pre>Fatal Python error: Aborted

Thread 0x0000000103538000 (most recent call first):
  File "/opt/local/Library/Fra%                                                                                                                                                                     meworks/Python.framework/Versions/3.4/lib/python3.4/socketserver.py", line 154 in _eintr_retry
  File "/opt/local/Library/Frameworks/Python.framework/Versions/3.4/lib/python3.4/socketserver.py", line 236 in serve_forever
  File "/Users/mikko/code/trees/pyramid_web20/pyramid_web20/tests/functional.py", line 40 in run
  File "/opt/local/Library/Frameworks/Python.framework/Versions/3.4/lib/python3.4/threading.py", line 921 in _bootstrap_inner
  File "/opt/local/Library/Frameworks/Python.framework/Versions/3.4/lib/python3.4/threading.py", line 889 in _bootstrap

Current thread 0x00007fff75128310 (most recent call first):
  File "/Users/mikko/code/trees/venv/lib/python3.4/site-packages/SQLAlchemy-1.0.0b5-py3.4-macosx-10.9-x86_64.egg/sqlalchemy/engine/default.py", line 442 in do_execute
...
  File "/Users/mikko/code/trees/venv/lib/python3.4/site-packages/SQLAlchemy-1.0.0b5-py3.4-macosx-10.9-x86_64.egg/sqlalchemy/sql/schema.py", line 3638 in drop_all
  File "/Users/mikko/code/trees/pyramid_web20/pyramid_web20/tests/conftest.py", line 124 in teardown
...
  File "/Users/mikko/code/trees/venv/lib/python3.4/site-packages/_pytest/config.py", line 41 in main
  File "/Users/mikko/code/trees/venv/bin/py.test", line 9 in &lt;module&gt;</pre>
<p class="signature">
 <a href="http://feeds.feedburner.com/OpenSourceHacker" rel="alternate" type="application/rss+xml"><img valign="middle" src="//www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt=""/></a> <a href="http://feeds.feedburner.com/OpenSourceHacker" rel="alternate" type="application/rss+xml">Subscribe to RSS feed</a> <a href="http://twitter.com/moo9000"> <img valign="middle" src="//opensourcehacker.com/wp-content/uploads/twitter-24.png"/></a> <a href="http://twitter.com/moo9000">Follow me on Twitter</a> 
 <a href="https://www.facebook.com/pages/Open-Source-Hacker/181710458567630"> <img valign="middle" src="//opensourcehacker.com/wp-content/uploads/facebook-24.png"/></a> <a href="https://www.facebook.com/pages/Open-Source-Hacker/181710458567630">Follow me on Facebook</a> <a href="https://plus.google.com/103323677227728078543/"><img valign="middle" src="//opensourcehacker.com/wp-content/uploads/googleplus.png"/></a> <a href="https://plus.google.com/103323677227728078543/">Follow me Google+</a></p>
			</div>

	</div></body></html>