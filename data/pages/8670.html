<html><body><div><div class="post-text" itemprop="text">
<p>You can also generate pillar data dynamically. Consider the following example for a pillar file:</p>

<pre><code>{% import_yaml "systems.yml" as systems %}

systems:
{% for system in systems %}
{% set name = system['name'] | default(system.project + '_' + system.customer + '_' + system.stage) %}
{% set home = system['home'] | default('/home/' + name) %}
  - name: {{ name }}
    customer: {{ system['customer'] }}
    project: {{ system['project'] }}
    stage: {{ system['stage'] }}
    home: {{ home }}
{% endfor %}
</code></pre>

<p>This pillar definition loads YAML data from a <code>systems.yml</code> file for which Salt will look in your <code>pillar_root</code> directory. This file might look like this (very similar to your initial example):</p>

<pre><code>- customer: smith
  project: cms
  stage: p
- customer: jones
  project: shop
  stage: p
  name: jones_webshop_p  # &lt;-- alternate name here!
</code></pre>

<p>Note that this example computes properties like the project name and the user's home directory dynamically, unless they are explicitly defined in your data file. For this, the Jinja <a href="http://jinja.pocoo.org/docs/dev/templates/#default" rel="nofollow"><code>default()</code> filter</a> is used in the pillar definition.</p>

<p>Using this pillar definition, you can simply use <code>name</code> and <code>home</code> in your state definitions directly from the pillar data:</p>

<pre><code>{% for system in salt['pillar.get']('systems') %}
{{ system.home }}:
  file.directory
{% endfor %}
</code></pre>

<hr/>

<p><strong>Additionally</strong>, as in my opinion these Jinja-heavy SLS files get a little hard to read, you might consider switching to the <a href="https://docs.saltstack.com/en/latest/ref/renderers/all/salt.renderers.py.html" rel="nofollow">Python renderer</a> for your pillar file:</p>

<pre><code>#!py

import yaml

def run():
  systems = []
  with open('systems.yml', 'r') as f:
    data = yaml.safe_load(f)

    for system in data:
      if not 'name' in system:
        system['name'] = "%s_%s_%s" % (system['project'], system['customer'], system['stage'])

      if not 'home' in system:
        system['home'] = "/home/%s" % name

      systems.append(system)

  return {"systems": systems}
</code></pre>
    </div>
    </div></body></html>