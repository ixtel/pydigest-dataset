<html><body><div><div class="col-md-12">
				<p dir="ltr">In 2013 <a href="http://www.statisticbrain.com/coupon-statistics/">72.3% of customers</a> reported using a coupon during a purchase. Yet consumers are increasingly digital and transient. MMS coupons instead of paper printouts provide an alternative way to engage with phone-wielding customers.</p>
<p dir="ltr">In this tutorial we’ll walk through how to build a service to distribute branded MMS coupons using Python and Flask. An MMS coupon will be a message with an image that combines the logo of your choice with a scannable barcode. The resulting text message will appear on the user’s phone as shown in the following image.</p>
<p dir="ltr"><img alt="" src="https://lh5.googleusercontent.com/gh4E8oeJcj_t6QCQdp1PTHUwP64uFvapocgFSvPrqIQNcRykEzxz4O7zG1LkAwf542oDsmPkeEbDSAly0IN8sH7sIHHQdrItakiaJkCyalTcu1ahHe0QcI3Ds7dcc-EOrQ"/></p>
<p dir="ltr">When the coupon receiver expands the message they’ll see a full image like this one below.</p>
<h1 dir="ltr"><img alt="" src="https://lh3.googleusercontent.com/O-3CG53HVQjHGkk1OSMjenQZ5avfo7gbpeq9Op1yHIQnBkZIbwT2mTPs7iTQp7QbyUs8Xu09gbMIXoTYuBKIDCU8riA9t0W_DFoF6hye5DV3mvCrRiXsgUbb6UexnLDwnQ"/></h1>
<h2 dir="ltr">What You’ll Need</h2>
<p dir="ltr">To build the branded coupons app we’ll use the three following technologies.</p>

<p dir="ltr">If you are anxious to see the results of this tutorial and want to deploy the code right now, try out the app with this Heroku deploy button. All of the code for this tutorial is also stored in an <a href="https://github.com/makaimc/branded-mms-coupons">open source GitHub repository</a>.</p>
<p dir="ltr"><a href="https://heroku.com/deploy?template=https://github.com/makaimc/branded-mms-coupons/"><img alt="Deploy on Heroku" src="https://lh5.googleusercontent.com/8pAcIQ6ceQn1776uQGXq6K-1EIIQ-jeSSHxaYXZp9ULvHHbmedqLZLwOqtypp5ZEFspvndcICOI4DxL_vczqgWxVvOO0pPi5aUVmU579q67k-EHmCyROjekIZ5MVJz4JrA"/></a></p>
<p dir="ltr">There are five sections to this coupon app tutorial.</p>
<ol>
<li>Create the structure of the coupon-creating Flask web app</li>
<li>Write code to handle user input and HTML templates</li>
<li>Use Pillow and PyBarcode to generate a branded coupon image</li>
<li>Build the code to send the coupon image to a customer via MMS</li>
<li>Deploy our coupon app to Heroku</li>
</ol>
<p>Let’s get started incrementally building our coupon generator by creating the structure of our Flask app.</p>
<h2 dir="ltr">Flask web application structure</h2>
<p dir="ltr">First set up the Flask app. If you don’t want to type up this code yourself there’s a <a href="https://github.com/makaimc/branded-mms-coupons/tree/tutorial-step-1">tutorial-step-1 tag</a> with these files already created.</p>
<p dir="ltr">In this section we’ll create the following list of files and directories.</p>
<ul>
<li><em>requirements.txt</em> – specifies necessary Python libraries</li>
<li><em>app.py</em> – runs the dev server for our Flask app locally</li>
<li><em>coupons/</em> – contains the Flask app that generates and sends coupons</li>
</ul>
<p dir="ltr">Let’s fill out the dependencies in the requirements.txt file. Each of these dependencies has several other libraries it relies upon which is why this list is shorter than the one you’ll see in the repository.</p>
<p/>

		<div id="crayon-56d5a01434847881764582" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5a01434847881764582-1"><span class="crayon-p"># web framework for our app</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a01434847881764582-2"><span class="crayon-v">Flask</span><span class="crayon-o">==</span><span class="crayon-cn">0.10.1</span></p><p class="crayon-line" id="crayon-56d5a01434847881764582-3"><span class="crayon-v">Flask</span><span class="crayon-o">-</span><span class="crayon-v">WTF</span><span class="crayon-o">==</span><span class="crayon-cn">0.10.2</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a01434847881764582-4"> </p><p class="crayon-line" id="crayon-56d5a01434847881764582-5"><span class="crayon-p"># retrieving logos and creating the coupons</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a01434847881764582-6"><span class="crayon-v">requests</span><span class="crayon-o">==</span><span class="crayon-cn">2.4.1</span></p><p class="crayon-line" id="crayon-56d5a01434847881764582-7"><span class="crayon-v">Pillow</span><span class="crayon-o">==</span><span class="crayon-cn">2.5.3</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a01434847881764582-8"><span class="crayon-v">pyBarcode</span><span class="crayon-o">==</span><span class="crayon-cn">0.7</span></p><p class="crayon-line" id="crayon-56d5a01434847881764582-9"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5a01434847881764582-10"><span class="crayon-p"># sending MMS</span></p><p class="crayon-line" id="crayon-56d5a01434847881764582-11"><span class="crayon-v">twilio</span><span class="crayon-o">==</span><span class="crayon-cn">3.6.7</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a01434847881764582-12"> </p><p class="crayon-line" id="crayon-56d5a01434847881764582-13"><span class="crayon-p"># run the app server with Gunicorn</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a01434847881764582-14"><span class="crayon-v">gunicorn</span><span class="crayon-o">==</span><span class="crayon-cn">19.1.1</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p/>
<p dir="ltr">To install these dependencies run the following <a href="https://pip.readthedocs.org/en/latest/">pip</a> command.</p>
<p/>

		<div id="crayon-56d5a0143485a947635856" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5a0143485a947635856-1"><span class="crayon-e">pip </span><span class="crayon-v">install</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">r</span><span class="crayon-h"> </span><span class="crayon-v">requirements</span><span class="crayon-sy">.</span><span class="crayon-v">txt</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p/>
<p dir="ltr">Several directories are needed to store our app code. Create a <em>coupons</em> directory in the base project directory. Two subdirectories are required within coupons: <em>templates</em> and <em>static</em>. Under <em>static</em> we also need <em>css</em> and <em>img</em> subdirectories.</p>
<p dir="ltr">The 
			<span id="crayon-56d5a01434865805419831" class="crayon-syntax crayon-syntax-inline  crayon-theme-github crayon-theme-github-inline crayon-font-consolas"><span class="crayon-pre crayon-code"><span class="crayon-v">mkdir</span></span></span> command handles the creation subdirectories on Linux or Mac OS X. On Windows you can create the folders and subfolders via Windows File Explorer. The resulting directory structure should look like the following.</p>
<p dir="ltr"><img alt="" src="https://lh5.googleusercontent.com/whA7w5_AVhujATBksovaXQB3j2lfsdgCi69ZiZAGJ9IKhaH1zfUSGZjn5GjX7Pn1CTKaNMeBgUwgmBW886_ms_U4a-rgQ57CWVTyEfWZdeS03ljNtY6QAM6xn1qBxv3zhA"/></p>
<p dir="ltr">Note that Git will not propagate empty folders when pushing to a remote repository. Every folder we just created will have a file in it except for the <em>img/</em> subdirectory. We need to remedy that for our app to work by placing a file in the folder. Download and save <a href="https://www.twilio.com/packages/company/img/logos_downloadable_logobrand.png">this Twilio logo</a> picture or any .png formatted logo of your choice into the <em>img/</em> directory.</p>
<p dir="ltr">Our app now has its dependencies in a requirements.txt file and the subdirectories for our Flask app.</p>
<p dir="ltr">Next create an <em>app.py</em> file for running our Flask dev server locally. This file will live in the base directory of our project and contain the following lines.</p>
<p/>

		<div id="crayon-56d5a01434870433092194" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5a01434870433092194-1"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-k ">os</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a01434870433092194-2"> </p><p class="crayon-line" id="crayon-56d5a01434870433092194-3"><span class="crayon-st">from</span><span class="crayon-h"> </span><span class="crayon-v">coupons</span><span class="crayon-sy">.</span><span class="crayon-e">app </span><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">app</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a01434870433092194-4"> </p><p class="crayon-line" id="crayon-56d5a01434870433092194-5"><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">__name__</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">'__main__'</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a01434870433092194-6"><span class="crayon-h">    </span><span class="crayon-v">port</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">int</span><span class="crayon-sy">(</span><span class="crayon-k ">os</span><span class="crayon-sy">.</span><span class="crayon-v">environ</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-s">"PORT"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">5000</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a01434870433092194-7"><span class="crayon-h">    </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">port</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-cn">5000</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a01434870433092194-8"><span class="crayon-h">        </span><span class="crayon-v">app</span><span class="crayon-sy">.</span><span class="crayon-v">debug</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">True</span></p><p class="crayon-line" id="crayon-56d5a01434870433092194-9"><span class="crayon-h">    </span><span class="crayon-v">app</span><span class="crayon-sy">.</span><span class="crayon-e">run</span><span class="crayon-sy">(</span><span class="crayon-v">host</span><span class="crayon-o">=</span><span class="crayon-s">'0.0.0.0'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">port</span><span class="crayon-o">=</span><span class="crayon-v">port</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p/>
<p dir="ltr">The <em>coupons/</em> subdirectory needs to be made into a Python package. Create an empty file named <em>__init__.py</em> in <em>coupons/</em>.</p>
<p dir="ltr">We also need to create a second <em>app.py</em> file under our <em>coupons/</em> subdirectory that bootstraps our Flask app. The following code with two stubbed out functions will live in this file.</p>
<p/>

		<div id="crayon-56d5a0143487a877425842" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-56d5a0143487a877425842-1">1</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a0143487a877425842-2">2</p><p class="crayon-num" data-line="crayon-56d5a0143487a877425842-3">3</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a0143487a877425842-4">4</p><p class="crayon-num" data-line="crayon-56d5a0143487a877425842-5">5</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a0143487a877425842-6">6</p><p class="crayon-num" data-line="crayon-56d5a0143487a877425842-7">7</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a0143487a877425842-8">8</p><p class="crayon-num" data-line="crayon-56d5a0143487a877425842-9">9</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a0143487a877425842-10">10</p><p class="crayon-num" data-line="crayon-56d5a0143487a877425842-11">11</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a0143487a877425842-12">12</p><p class="crayon-num" data-line="crayon-56d5a0143487a877425842-13">13</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a0143487a877425842-14">14</p><p class="crayon-num" data-line="crayon-56d5a0143487a877425842-15">15</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a0143487a877425842-16">16</p><p class="crayon-num" data-line="crayon-56d5a0143487a877425842-17">17</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a0143487a877425842-18">18</p><p class="crayon-num" data-line="crayon-56d5a0143487a877425842-19">19</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5a0143487a877425842-1"><span class="crayon-st">from</span><span class="crayon-h"> </span><span class="crayon-e">flask </span><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-v">Flask</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">request</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">render_template</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">redirect</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">url_for</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a0143487a877425842-2"> </p><p class="crayon-line" id="crayon-56d5a0143487a877425842-3"><span class="crayon-st">from</span><span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-e">forms </span><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">CouponForm</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a0143487a877425842-4"> </p><p class="crayon-line" id="crayon-56d5a0143487a877425842-5"><span class="crayon-v">twilio_logo_png_url</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'http://www.twilio.com/packages/company/'</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a0143487a877425842-6"><span class="crayon-h">                      </span><span class="crayon-s">'img/logos_downloadable_logobrand.png'</span></p><p class="crayon-line" id="crayon-56d5a0143487a877425842-7"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5a0143487a877425842-8"><span class="crayon-v">app</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Flask</span><span class="crayon-sy">(</span><span class="crayon-v">__name__</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">static_url_path</span><span class="crayon-o">=</span><span class="crayon-s">'/static'</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a0143487a877425842-9"><span class="crayon-v">app</span><span class="crayon-sy">.</span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-e">from_pyfile</span><span class="crayon-sy">(</span><span class="crayon-s">'config.py'</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a0143487a877425842-10"> </p><p class="crayon-line" id="crayon-56d5a0143487a877425842-11"><span class="crayon-sy">@</span><span class="crayon-v">app</span><span class="crayon-sy">.</span><span class="crayon-e">route</span><span class="crayon-sy">(</span><span class="crayon-s">'/'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">methods</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'GET'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'POST'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a0143487a877425842-12"><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">create_coupon</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5a0143487a877425842-13"><span class="crayon-h">    </span><span class="crayon-c"># we'll replace the following line later in the tutorial</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a0143487a877425842-14"><span class="crayon-h">    </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-s">'stub'</span></p><p class="crayon-line" id="crayon-56d5a0143487a877425842-15"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5a0143487a877425842-16"><span class="crayon-sy">@</span><span class="crayon-v">app</span><span class="crayon-sy">.</span><span class="crayon-e">route</span><span class="crayon-sy">(</span><span class="crayon-s">'/confirmation/'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">methods</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'GET'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a0143487a877425842-17"><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">coupon_confirmation</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a0143487a877425842-18"><span class="crayon-h">    </span><span class="crayon-c"># we'll replace the following line later in the tutorial</span></p><p class="crayon-line" id="crayon-56d5a0143487a877425842-19"><span class="crayon-h">    </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-s">'stub'</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p/>
<p dir="ltr">This <em>app.py</em> file imports Flask and creates a new coupons web application. The app loads Flask’s configuration from a Python file named <em>config.py</em>.</p>
<p dir="ltr">The file also contains two stubbed functions we will fill out later in this tutorial. The first function 
			<span id="crayon-56d5a01434884524166861" class="crayon-syntax crayon-syntax-inline  crayon-theme-github crayon-theme-github-inline crayon-font-consolas"><span class="crayon-pre crayon-code"><span class="crayon-v">create_coupon</span></span></span> will display the coupon creation form page as well as handle the data from POST form submissions.</p>
<p dir="ltr">The second function 
			<span id="crayon-56d5a0143488e634141102" class="crayon-syntax crayon-syntax-inline  crayon-theme-github crayon-theme-github-inline crayon-font-consolas"><span class="crayon-pre crayon-code"><span class="crayon-v">coupon_confirmation</span></span></span> will be a confirmation page after the coupon is sent properly.</p>
<p dir="ltr"><em>app.py</em> references a <em>config.py</em> file. Create the <em>config.py</em> file now under the <em>coupons/</em> subdirectory and put the following code in it to load environment variables for our app.</p>
<p/>

		<div id="crayon-56d5a01434898898780896" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5a01434898898780896-1"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-k ">os</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a01434898898780896-2"><span class="crayon-c"># General Flask app settings</span></p><p class="crayon-line" id="crayon-56d5a01434898898780896-3"><span class="crayon-v">DEBUG</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">os</span><span class="crayon-sy">.</span><span class="crayon-v">environ</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-s">'DEBUG'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">None</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a01434898898780896-4"><span class="crayon-v">SECRET_KEY</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">os</span><span class="crayon-sy">.</span><span class="crayon-v">environ</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-s">'SECRET_KEY'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">None</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a01434898898780896-5"><span class="crayon-v">COUPON_SAVE_DIR</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">os</span><span class="crayon-sy">.</span><span class="crayon-v">environ</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-s">'COUPON_SAVE_DIR'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">None</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a01434898898780896-6"><span class="crayon-v">QUALIFIED_MEDIA_URL</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">os</span><span class="crayon-sy">.</span><span class="crayon-v">environ</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-s">'QUALIFIED_MEDIA_URL'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">None</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a01434898898780896-7"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5a01434898898780896-8"><span class="crayon-c"># Twilio API credentials</span></p><p class="crayon-line" id="crayon-56d5a01434898898780896-9"><span class="crayon-v">TWILIO_ACCOUNT_SID</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">os</span><span class="crayon-sy">.</span><span class="crayon-v">environ</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-s">'TWILIO_ACCOUNT_SID'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">None</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a01434898898780896-10"><span class="crayon-v">TWILIO_AUTH_TOKEN</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">os</span><span class="crayon-sy">.</span><span class="crayon-v">environ</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-s">'TWILIO_AUTH_TOKEN'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">None</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a01434898898780896-11"><span class="crayon-v">TWILIO_NUMBER</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">os</span><span class="crayon-sy">.</span><span class="crayon-v">environ</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-s">'TWILIO_NUMBER'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">None</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p/>
<p dir="ltr">The <em>config.py</em> file looks up Flask settings and Twilio credentials from environment variables set locally on <a href="https://help.ubuntu.com/community/EnvironmentVariables">Linux</a> or <a href="http://www.computerhope.com/issues/ch000549.htm">Windows</a>, so if you’re going to run the app locally go ahead and create those variables now.</p>
<p dir="ltr">
			<span id="crayon-56d5a014348a2626357796" class="crayon-syntax crayon-syntax-inline  crayon-theme-github crayon-theme-github-inline crayon-font-consolas"><span class="crayon-pre crayon-code"><span class="crayon-v">COUPON_SAVE_DIR</span></span></span> is where coupon images should be temporarily saved. Set 
			<span id="crayon-56d5a014348ac781784189" class="crayon-syntax crayon-syntax-inline  crayon-theme-github crayon-theme-github-inline crayon-font-consolas"><span class="crayon-pre crayon-code"><span class="crayon-v">COUPON_SAVE_DIR</span></span></span> to your app’s coupons code directory plus “/static/img/”. For example, “/app/coupons/static/img/”. If you’re running the app locally, the directory is path to your Flask app plus “/coupons/static/img/”.</p>
<p dir="ltr">
			<span id="crayon-56d5a014348b6038541069" class="crayon-syntax crayon-syntax-inline  crayon-theme-github crayon-theme-github-inline crayon-font-consolas"><span class="crayon-pre crayon-code"><span class="crayon-v">QUALIFIED_MEDIA_URL</span></span></span> is the fully qualified path for saved coupons. For example, if your app is deployed to Heroku with an app named “mms-coupon-creator”, this value would be set to “http://mms-coupon-creator.herokuapp.com/static/img/”.</p>
<p>Next we need to build a web page that accepts user input so we know how to properly create the coupon.</p>
<h2 dir="ltr">Handling user input</h2>
<p dir="ltr">One more Flask-specific Python file is required that will handle user input. Input fields on the webpage will allow a user to specify what phone number to send the coupon to and optionally the logo, barcode and message text to send with the coupon. The webpage’s input fields will look like the following screenshot.</p>
<p dir="ltr"><img alt="" src="https://lh4.googleusercontent.com/AqqoSvbERfobpEaokK9MzDvcWXCGaabUiXdTPAaBCP_dr4RdlumWUr7y2GG7YUuYTwBRrwX7M0usJ6ipS4P8QgriBZHbhaqX6hD_j3_R00hl_YFJ0ciQp5tsh-ZJYmb7RQ"/></p>
<p dir="ltr">Our app uses the <a href="https://flask-wtf.readthedocs.org/en/latest/">Flask-WTF</a> library to handle form input. Create a <em>forms.py</em> file under the <em>coupons/</em> directory and put the following code inside.</p>
<p/>

		<div id="crayon-56d5a014348c1478036976" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-56d5a014348c1478036976-1">1</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a014348c1478036976-2">2</p><p class="crayon-num" data-line="crayon-56d5a014348c1478036976-3">3</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a014348c1478036976-4">4</p><p class="crayon-num" data-line="crayon-56d5a014348c1478036976-5">5</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a014348c1478036976-6">6</p><p class="crayon-num" data-line="crayon-56d5a014348c1478036976-7">7</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a014348c1478036976-8">8</p><p class="crayon-num" data-line="crayon-56d5a014348c1478036976-9">9</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a014348c1478036976-10">10</p><p class="crayon-num" data-line="crayon-56d5a014348c1478036976-11">11</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a014348c1478036976-12">12</p><p class="crayon-num" data-line="crayon-56d5a014348c1478036976-13">13</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a014348c1478036976-14">14</p><p class="crayon-num" data-line="crayon-56d5a014348c1478036976-15">15</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a014348c1478036976-16">16</p><p class="crayon-num" data-line="crayon-56d5a014348c1478036976-17">17</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a014348c1478036976-18">18</p><p class="crayon-num" data-line="crayon-56d5a014348c1478036976-19">19</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5a014348c1478036976-1"><span class="crayon-st">from</span><span class="crayon-h"> </span><span class="crayon-e">flask_wtf </span><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">Form</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014348c1478036976-2"><span class="crayon-st">from</span><span class="crayon-h"> </span><span class="crayon-e">wtforms </span><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-v">TextField</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">FileField</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">validators</span></p><p class="crayon-line" id="crayon-56d5a014348c1478036976-3"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014348c1478036976-4"><span class="crayon-t">class</span><span class="crayon-h"> </span><span class="crayon-e">CouponForm</span><span class="crayon-sy">(</span><span class="crayon-v">Form</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5a014348c1478036976-5"><span class="crayon-h">    </span><span class="crayon-v">phone_number</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">TextField</span><span class="crayon-sy">(</span><span class="crayon-s">'Recipient US Phone Number (ex: 2025551234)'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014348c1478036976-6"><span class="crayon-h">        </span><span class="crayon-v">validators</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-v">validators</span><span class="crayon-sy">.</span><span class="crayon-e">Required</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">validators</span><span class="crayon-sy">.</span><span class="crayon-e">regexp</span><span class="crayon-sy">(</span><span class="crayon-i">u</span><span class="crayon-s">'[0-9]+'</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a014348c1478036976-7"><span class="crayon-h">    </span><span class="crayon-v">logo_image_url</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">TextField</span><span class="crayon-sy">(</span><span class="crayon-s">'Logo Image URL (optional, .png file)'</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014348c1478036976-8"><span class="crayon-h">    </span><span class="crayon-v">coupon_text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">TextField</span><span class="crayon-sy">(</span><span class="crayon-s">'Coupon Text (optional, '</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></p><p class="crayon-line" id="crayon-56d5a014348c1478036976-9"><span class="crayon-h">        </span><span class="crayon-s">'example: Scan me for 20% off!)'</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014348c1478036976-10"><span class="crayon-h">    </span><span class="crayon-v">serial_number</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">TextField</span><span class="crayon-sy">(</span><span class="crayon-s">'Serial Number (optional, '</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></p><p class="crayon-line" id="crayon-56d5a014348c1478036976-11"><span class="crayon-h">        </span><span class="crayon-s">'example: 12849480412)'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">validators</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-v">validators</span><span class="crayon-sy">.</span><span class="crayon-e">regexp</span><span class="crayon-sy">(</span><span class="crayon-i">u</span><span class="crayon-s">'[0-9]*'</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014348c1478036976-12"><span class="crayon-h">    </span><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">validate</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5a014348c1478036976-13"><span class="crayon-h">        </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-v">Form</span><span class="crayon-sy">.</span><span class="crayon-e">validate</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014348c1478036976-14"><span class="crayon-h">            </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">False</span></p><p class="crayon-line" id="crayon-56d5a014348c1478036976-15"><span class="crayon-h">        </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">logo_image_url</span><span class="crayon-sy">.</span><span class="crayon-v">data</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014348c1478036976-16"><span class="crayon-h">            </span><span class="crayon-c"># ensure at least ends in .png extension if filled in</span></p><p class="crayon-line" id="crayon-56d5a014348c1478036976-17"><span class="crayon-h">            </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">logo_image_url</span><span class="crayon-sy">.</span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-cn">4</span><span class="crayon-o">:</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">lower</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">'.png'</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014348c1478036976-18"><span class="crayon-h">                </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">False</span></p><p class="crayon-line" id="crayon-56d5a014348c1478036976-19"><span class="crayon-h">        </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">True</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p/>
<p dir="ltr">In the above file we’re handling the required phone number and three optional fields, 
			<span id="crayon-56d5a014348cb138604299" class="crayon-syntax crayon-syntax-inline  crayon-theme-github crayon-theme-github-inline crayon-font-consolas"><span class="crayon-pre crayon-code"><span class="crayon-v">logo_image_url</span></span></span>, 
			<span id="crayon-56d5a014348d5637502611" class="crayon-syntax crayon-syntax-inline  crayon-theme-github crayon-theme-github-inline crayon-font-consolas"><span class="crayon-pre crayon-code"><span class="crayon-v">coupon_text</span></span></span> and 
			<span id="crayon-56d5a014348df851707150" class="crayon-syntax crayon-syntax-inline  crayon-theme-github crayon-theme-github-inline crayon-font-consolas"><span class="crayon-pre crayon-code"><span class="crayon-v">serial_number</span></span></span>. Some basic validation happens to ensure fields are correct but the validators could certainly be reinforced on an improved coupon creator.</p>
<p dir="ltr">That wraps up the Flask app structure but a few HTML templates are required under the <a href="https://github.com/makaimc/branded-mms-coupons/tree/master/coupons/templates">templates directory</a> to create the web user interface. These files come from the Bootstrap project’s <a href="http://getbootstrap.com/examples/jumbotron-narrow/">Narrow Jumbotron theme</a> customized with our input fields. Each of these files below links to the template file in the <a href="https://github.com/makaimc/branded-mms-coupons">GitHub repo</a>.</p>

<p dir="ltr">There are also two CSS files under the <a href="https://github.com/makaimc/branded-mms-coupons/tree/master/coupons/static/css/">static/css</a> directory.</p>

<p dir="ltr">We can run the app now using the 
			<span id="crayon-56d5a014348ea716049001" class="crayon-syntax crayon-syntax-inline  crayon-theme-github crayon-theme-github-inline crayon-font-consolas"><span class="crayon-pre crayon-code"><span class="crayon-e">python </span><span class="crayon-v">app</span><span class="crayon-sy">.</span><span class="crayon-v">py</span></span></span> command in the root project directory. However, the webpage will just display “stub” in the browser window. Let’s write the code for generating the coupon images so our app generates coupons and wire it up to our app’s views.</p>
<h2 dir="ltr">Branded Coupon Generation</h2>
<p dir="ltr">We wrote code for the Flask app structure in the first two sections. If you want to start with that code already written, check out the <a href="https://github.com/makaimc/branded-mms-coupons/tree/tutorial-step-1">tutorial-step-1 tag</a>.</p>
<p dir="ltr">Code in <em>coupons/app.py</em> calls functions in a file named <em>utils.py</em> file that we’ll create now. While we could write all of the code in <em>app.py</em>, it’s good practice to separate logic out into other functions for easier testing. The following code should go into this <em>utils.py</em> file.</p>
<p/>

		<div id="crayon-56d5a014348f4354251181" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-56d5a014348f4354251181-1">1</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a014348f4354251181-2">2</p><p class="crayon-num" data-line="crayon-56d5a014348f4354251181-3">3</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a014348f4354251181-4">4</p><p class="crayon-num" data-line="crayon-56d5a014348f4354251181-5">5</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a014348f4354251181-6">6</p><p class="crayon-num" data-line="crayon-56d5a014348f4354251181-7">7</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a014348f4354251181-8">8</p><p class="crayon-num" data-line="crayon-56d5a014348f4354251181-9">9</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a014348f4354251181-10">10</p><p class="crayon-num" data-line="crayon-56d5a014348f4354251181-11">11</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a014348f4354251181-12">12</p><p class="crayon-num" data-line="crayon-56d5a014348f4354251181-13">13</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a014348f4354251181-14">14</p><p class="crayon-num" data-line="crayon-56d5a014348f4354251181-15">15</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a014348f4354251181-16">16</p><p class="crayon-num" data-line="crayon-56d5a014348f4354251181-17">17</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a014348f4354251181-18">18</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5a014348f4354251181-1"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">barcode</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014348f4354251181-2"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">requests</span></p><p class="crayon-line" id="crayon-56d5a014348f4354251181-3"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-k ">uuid</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014348f4354251181-4"><span class="crayon-st">from</span><span class="crayon-h"> </span><span class="crayon-v">barcode</span><span class="crayon-sy">.</span><span class="crayon-e">writer </span><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">ImageWriter</span></p><p class="crayon-line" id="crayon-56d5a014348f4354251181-5"><span class="crayon-st">from</span><span class="crayon-h"> </span><span class="crayon-e">PIL </span><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">Image</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014348f4354251181-6"><span class="crayon-st">from</span><span class="crayon-h"> </span><span class="crayon-k ">StringIO</span><span class="crayon-h"> </span><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-k ">StringIO</span></p><p class="crayon-line" id="crayon-56d5a014348f4354251181-7"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014348f4354251181-8"><span class="crayon-st">from</span><span class="crayon-h"> </span><span class="crayon-e">config </span><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-v">COUPON_SAVE_DIR</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">QUALIFIED_MEDIA_URL</span></p><p class="crayon-line" id="crayon-56d5a014348f4354251181-9"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014348f4354251181-10"><span class="crayon-v">extra_spacing</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">50</span></p><p class="crayon-line" id="crayon-56d5a014348f4354251181-11"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014348f4354251181-12"><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">open_image_file_from_url</span><span class="crayon-sy">(</span><span class="crayon-v">image_file_url</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5a014348f4354251181-13"><span class="crayon-h">    </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-v">image_file_url</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014348f4354251181-14"><span class="crayon-h">        </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">False</span></p><p class="crayon-line" id="crayon-56d5a014348f4354251181-15"><span class="crayon-h">    </span><span class="crayon-v">image_request</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">requests</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-v">image_file_url</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014348f4354251181-16"><span class="crayon-h">    </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">image_request</span><span class="crayon-sy">.</span><span class="crayon-v">status_code</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-cn">200</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5a014348f4354251181-17"><span class="crayon-h">        </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">Image</span><span class="crayon-sy">.</span><span class="crayon-k ">open</span><span class="crayon-sy">(</span><span class="crayon-k ">StringIO</span><span class="crayon-sy">(</span><span class="crayon-v">image_request</span><span class="crayon-sy">.</span><span class="crayon-v">content</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014348f4354251181-18"><span class="crayon-h">    </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">False</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p/>
<p dir="ltr">The above function opens an image file from a URL passed in as a parameter. 
			<span id="crayon-56d5a014348fe348512517" class="crayon-syntax crayon-syntax-inline  crayon-theme-github crayon-theme-github-inline crayon-font-consolas"><span class="crayon-pre crayon-code"><span class="crayon-v">open_image_file_from_url</span></span></span> pulls in an external .png file that will be used to combine with a barcode for the branded coupon.</p>
<p dir="ltr">Within the same <em>utils.py</em> file, write a 
			<span id="crayon-56d5a01434908617651129" class="crayon-syntax crayon-syntax-inline  crayon-theme-github crayon-theme-github-inline crayon-font-consolas"><span class="crayon-pre crayon-code"><span class="crayon-v">create_background_image</span></span></span> function with the below code that return back a blank image canvas that will be used as a background for our coupon.</p>
<p/>

		<div id="crayon-56d5a01434912982315002" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5a01434912982315002-1"><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">create_background_image</span><span class="crayon-sy">(</span><span class="crayon-v">width</span><span class="crayon-o">=</span><span class="crayon-cn">640</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">height</span><span class="crayon-o">=</span><span class="crayon-cn">480</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">rgb</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">255</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">255</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">255</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a01434912982315002-2"><span class="crayon-h">    </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">Image</span><span class="crayon-sy">.</span><span class="crayon-k ">new</span><span class="crayon-sy">(</span><span class="crayon-s">'RGB'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">width</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">height</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">rgb</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p/>
<p dir="ltr">The third function to write in <em>utils.py</em> generates a barcode image. This function will be named 
			<span id="crayon-56d5a0143491c876770509" class="crayon-syntax crayon-syntax-inline  crayon-theme-github crayon-theme-github-inline crayon-font-consolas"><span class="crayon-pre crayon-code"><span class="crayon-v">generate_barcode_image</span></span></span>. It wraps the <a href="https://pythonhosted.org/pyBarcode/">PyBarcode</a> library and returns back a rendered image. With the return value from this function we have a scannable barcode image that will be pasted by another function onto the blank background image.</p>
<p/>

		<div id="crayon-56d5a01434925974874713" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5a01434925974874713-1"><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">generate_barcode_image</span><span class="crayon-sy">(</span><span class="crayon-v">serial_number</span><span class="crayon-o">=</span><span class="crayon-s">'1234567890'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a01434925974874713-2"><span class="crayon-h">    </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">barcode</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-s">'ean13'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">serial_number</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">writer</span><span class="crayon-o">=</span><span class="crayon-e">ImageWriter</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">render</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p/>
<p dir="ltr">Now we get to the meat of the <em>utils.py</em> file. The next function called 
			<span id="crayon-56d5a0143492f760872184" class="crayon-syntax crayon-syntax-inline  crayon-theme-github crayon-theme-github-inline crayon-font-consolas"><span class="crayon-pre crayon-code"><span class="crayon-v">combine_images_into_coupon</span></span></span> takes in our logo image pulled down from a URL specified on our app’s web page form along with the rendered barcode. The output is a URL to our newly created coupon file with both the logo and barcode combined in the same image.</p>
<p/>

		<div id="crayon-56d5a01434939407061811" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-56d5a01434939407061811-1">1</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a01434939407061811-2">2</p><p class="crayon-num" data-line="crayon-56d5a01434939407061811-3">3</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a01434939407061811-4">4</p><p class="crayon-num" data-line="crayon-56d5a01434939407061811-5">5</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a01434939407061811-6">6</p><p class="crayon-num" data-line="crayon-56d5a01434939407061811-7">7</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a01434939407061811-8">8</p><p class="crayon-num" data-line="crayon-56d5a01434939407061811-9">9</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a01434939407061811-10">10</p><p class="crayon-num" data-line="crayon-56d5a01434939407061811-11">11</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a01434939407061811-12">12</p><p class="crayon-num" data-line="crayon-56d5a01434939407061811-13">13</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a01434939407061811-14">14</p><p class="crayon-num" data-line="crayon-56d5a01434939407061811-15">15</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a01434939407061811-16">16</p><p class="crayon-num" data-line="crayon-56d5a01434939407061811-17">17</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a01434939407061811-18">18</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5a01434939407061811-1"><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">combine_images_into_coupon</span><span class="crayon-sy">(</span><span class="crayon-v">logo_img</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">barcode_img</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a01434939407061811-2"><span class="crayon-h">    </span><span class="crayon-v">bg_width</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">logo_img</span><span class="crayon-sy">.</span><span class="crayon-v">size</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">barcode_img</span><span class="crayon-sy">.</span><span class="crayon-v">size</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e">extra_spacing</span></p><p class="crayon-line" id="crayon-56d5a01434939407061811-3"><span class="crayon-e">    </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">logo_img</span><span class="crayon-sy">.</span><span class="crayon-v">size</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">barcode_img</span><span class="crayon-sy">.</span><span class="crayon-v">size</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a01434939407061811-4"><span class="crayon-h">        </span><span class="crayon-v">bg_height</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">logo_img</span><span class="crayon-sy">.</span><span class="crayon-v">size</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e">extra_spacing</span></p><p class="crayon-line" id="crayon-56d5a01434939407061811-5"><span class="crayon-e">    </span><span class="crayon-st">else</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a01434939407061811-6"><span class="crayon-h">        </span><span class="crayon-v">bg_height</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">barcode_img</span><span class="crayon-sy">.</span><span class="crayon-v">size</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e">extra_spacing</span></p><p class="crayon-line" id="crayon-56d5a01434939407061811-7"><span class="crayon-e">    </span><span class="crayon-v">bg_img</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">create_background_image</span><span class="crayon-sy">(</span><span class="crayon-v">bg_width</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">bg_height</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a01434939407061811-8"><span class="crayon-h">    </span><span class="crayon-v">logo_offset</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">extra_spacing</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">extra_spacing</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a01434939407061811-9"><span class="crayon-h">    </span><span class="crayon-st">try</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a01434939407061811-10"><span class="crayon-h">        </span><span class="crayon-v">bg_img</span><span class="crayon-sy">.</span><span class="crayon-e">paste</span><span class="crayon-sy">(</span><span class="crayon-v">logo_img</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">logo_offset</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">logo_img</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a01434939407061811-11"><span class="crayon-h">    </span><span class="crayon-st">except</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a01434939407061811-12"><span class="crayon-h">        </span><span class="crayon-c"># try without the mask</span></p><p class="crayon-line" id="crayon-56d5a01434939407061811-13"><span class="crayon-h">        </span><span class="crayon-v">bg_img</span><span class="crayon-sy">.</span><span class="crayon-e">paste</span><span class="crayon-sy">(</span><span class="crayon-v">logo_img</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">logo_offset</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a01434939407061811-14"> </p><p class="crayon-line" id="crayon-56d5a01434939407061811-15"><span class="crayon-h">    </span><span class="crayon-v">barcode_offset</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">logo_img</span><span class="crayon-sy">.</span><span class="crayon-v">size</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a01434939407061811-16"><span class="crayon-h">                      </span><span class="crayon-v">extra_spacing</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-cn">3</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">extra_spacing</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a01434939407061811-17"><span class="crayon-h">    </span><span class="crayon-v">bg_img</span><span class="crayon-sy">.</span><span class="crayon-e">paste</span><span class="crayon-sy">(</span><span class="crayon-v">barcode_img</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">barcode_offset</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a01434939407061811-18"><span class="crayon-h">    </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">save_image</span><span class="crayon-sy">(</span><span class="crayon-v">bg_img</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p/>
<p dir="ltr">
			<span id="crayon-56d5a01434943434528053" class="crayon-syntax crayon-syntax-inline  crayon-theme-github crayon-theme-github-inline crayon-font-consolas"><span class="crayon-pre crayon-code"><span class="crayon-v">combine_images_into_coupon</span></span></span> is where the logo and generated barcode come together in a single image. We ensure the logo or barcode is within the size of the background image. Then we paste the logo image followed by the barcode image onto the background. If there is transparency in the logo we need to add a mask but if that fails we simply do not add a mask to the image.</p>
<p dir="ltr">One more function for <em>utils.py</em> named 
			<span id="crayon-56d5a0143494d006006570" class="crayon-syntax crayon-syntax-inline  crayon-theme-github crayon-theme-github-inline crayon-font-consolas"><span class="crayon-pre crayon-code"><span class="crayon-v">save_image</span></span></span> is shown below.</p>
<p/>

		<div id="crayon-56d5a0143495b896323894" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5a0143495b896323894-1"><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">save_image</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a0143495b896323894-2"><span class="crayon-h">    </span><span class="crayon-v">unique_filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">str</span><span class="crayon-sy">(</span><span class="crayon-k ">uuid</span><span class="crayon-sy">.</span><span class="crayon-e">uuid4</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">'.png'</span></p><p class="crayon-line" id="crayon-56d5a0143495b896323894-3"><span class="crayon-h">    </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-e">save</span><span class="crayon-sy">(</span><span class="crayon-v">COUPON_SAVE_DIR</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">unique_filename</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a0143495b896323894-4"><span class="crayon-h">    </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">unique_filename</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p/>
<p dir="ltr">In 
			<span id="crayon-56d5a0143496c043629389" class="crayon-syntax crayon-syntax-inline  crayon-theme-github crayon-theme-github-inline crayon-font-consolas"><span class="crayon-pre crayon-code"><span class="crayon-v">save_image</span></span></span> we save the generated coupon to a unique filename that is created via the <a href="https://docs.python.org/2/library/uuid.html">uuid library</a> within Python. The coupon image file for our app doesn’t need to be stored long term, it just needs to be saved and served up immediately via a URL for the MMS coupon sending phase.</p>
<p dir="ltr">Barcode generation is possible with the code we wrote above but we also need to wire it into the Flask app. Within the <em>app.py</em> file add the following highlighted code within the 
			<span id="crayon-56d5a01434978043083624" class="crayon-syntax crayon-syntax-inline  crayon-theme-github crayon-theme-github-inline crayon-font-consolas"><span class="crayon-pre crayon-code"><span class="crayon-v">create_coupon</span></span></span> function and remove the 
			<span id="crayon-56d5a01434982803349040" class="crayon-syntax crayon-syntax-inline  crayon-theme-github crayon-theme-github-inline crayon-font-consolas"><span class="crayon-pre crayon-code"><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-s">'stub'</span></span></span> placeholder.</p>
<p/>

		<div id="crayon-56d5a0143498c044286128" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-56d5a0143498c044286128-1">1</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a0143498c044286128-2">2</p><p class="crayon-num" data-line="crayon-56d5a0143498c044286128-3">3</p><p class="crayon-num crayon-marked-num crayon-top crayon-striped-num" data-line="crayon-56d5a0143498c044286128-4">4</p><p class="crayon-num crayon-marked-num crayon-bottom" data-line="crayon-56d5a0143498c044286128-5">5</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a0143498c044286128-6">6</p><p class="crayon-num" data-line="crayon-56d5a0143498c044286128-7">7</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a0143498c044286128-8">8</p><p class="crayon-num" data-line="crayon-56d5a0143498c044286128-9">9</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a0143498c044286128-10">10</p><p class="crayon-num" data-line="crayon-56d5a0143498c044286128-11">11</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a0143498c044286128-12">12</p><p class="crayon-num" data-line="crayon-56d5a0143498c044286128-13">13</p><p class="crayon-num crayon-marked-num crayon-top crayon-striped-num" data-line="crayon-56d5a0143498c044286128-14">14</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d5a0143498c044286128-15">15</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d5a0143498c044286128-16">16</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d5a0143498c044286128-17">17</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d5a0143498c044286128-18">18</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d5a0143498c044286128-19">19</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d5a0143498c044286128-20">20</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d5a0143498c044286128-21">21</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d5a0143498c044286128-22">22</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d5a0143498c044286128-23">23</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d5a0143498c044286128-24">24</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d5a0143498c044286128-25">25</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d5a0143498c044286128-26">26</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d5a0143498c044286128-27">27</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d5a0143498c044286128-28">28</p><p class="crayon-num crayon-marked-num crayon-bottom" data-line="crayon-56d5a0143498c044286128-29">29</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5a0143498c044286128-1"><span class="crayon-st">from</span><span class="crayon-h"> </span><span class="crayon-e">flask </span><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-v">Flask</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">request</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">render_template</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">redirect</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">url_for</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a0143498c044286128-2"> </p><p class="crayon-line" id="crayon-56d5a0143498c044286128-3"><span class="crayon-st">from</span><span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-e">forms </span><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">CouponForm</span></p><p class="crayon-line crayon-marked-line crayon-top crayon-striped-line" id="crayon-56d5a0143498c044286128-4"><span class="crayon-st">from</span><span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-e">utils </span><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-v">generate_barcode_image</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">combine_images_into_coupon</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></p><p class="crayon-line crayon-marked-line crayon-bottom" id="crayon-56d5a0143498c044286128-5"><span class="crayon-h">                   </span><span class="crayon-e">open_image_file_from_url</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a0143498c044286128-6"> </p><p class="crayon-line" id="crayon-56d5a0143498c044286128-7"><span class="crayon-v">twilio_logo_png_url</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'http://www.twilio.com/packages/company/'</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a0143498c044286128-8"><span class="crayon-h">                      </span><span class="crayon-s">'img/logos_downloadable_logobrand.png'</span></p><p class="crayon-line" id="crayon-56d5a0143498c044286128-9"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5a0143498c044286128-10"><span class="crayon-v">app</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Flask</span><span class="crayon-sy">(</span><span class="crayon-v">__name__</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">static_url_path</span><span class="crayon-o">=</span><span class="crayon-s">'/static'</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a0143498c044286128-11"><span class="crayon-v">app</span><span class="crayon-sy">.</span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-e">from_pyfile</span><span class="crayon-sy">(</span><span class="crayon-s">'config.py'</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a0143498c044286128-12"><span class="crayon-sy">@</span><span class="crayon-v">app</span><span class="crayon-sy">.</span><span class="crayon-e">route</span><span class="crayon-sy">(</span><span class="crayon-s">'/'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">methods</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'GET'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'POST'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a0143498c044286128-13"><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">create_coupon</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-marked-line crayon-top crayon-striped-line" id="crayon-56d5a0143498c044286128-14"><span class="crayon-h">    </span><span class="crayon-v">form</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">CouponForm</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d5a0143498c044286128-15"><span class="crayon-h">    </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">form</span><span class="crayon-sy">.</span><span class="crayon-e">validate_on_submit</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d5a0143498c044286128-16"><span class="crayon-h">        </span><span class="crayon-v">serial_number</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">form</span><span class="crayon-sy">.</span><span class="crayon-v">serial_number</span><span class="crayon-sy">.</span><span class="crayon-e">data</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d5a0143498c044286128-17"><span class="crayon-e">        </span><span class="crayon-v">phone_number</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">form</span><span class="crayon-sy">.</span><span class="crayon-v">phone_number</span><span class="crayon-sy">.</span><span class="crayon-e">data</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d5a0143498c044286128-18"><span class="crayon-e">        </span><span class="crayon-v">logo_image_url</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">form</span><span class="crayon-sy">.</span><span class="crayon-v">logo_image_url</span><span class="crayon-sy">.</span><span class="crayon-e">data</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d5a0143498c044286128-19"><span class="crayon-e">        </span><span class="crayon-v">coupon_text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">form</span><span class="crayon-sy">.</span><span class="crayon-v">coupon_text</span><span class="crayon-sy">.</span><span class="crayon-e">data</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d5a0143498c044286128-20"><span class="crayon-e">        </span><span class="crayon-v">logo_img</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open_image_file_from_url</span><span class="crayon-sy">(</span><span class="crayon-v">logo_image_url</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d5a0143498c044286128-21"><span class="crayon-h">        </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-v">logo_img</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d5a0143498c044286128-22"><span class="crayon-h">            </span><span class="crayon-v">logo_img</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open_image_file_from_url</span><span class="crayon-sy">(</span><span class="crayon-v">twilio_logo_png_url</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d5a0143498c044286128-23"><span class="crayon-h">        </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">serial_number</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d5a0143498c044286128-24"><span class="crayon-h">            </span><span class="crayon-v">barcode_img</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">generate_barcode_image</span><span class="crayon-sy">(</span><span class="crayon-v">serial_number</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d5a0143498c044286128-25"><span class="crayon-h">        </span><span class="crayon-st">else</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d5a0143498c044286128-26"><span class="crayon-h">            </span><span class="crayon-v">barcode_img</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">generate_barcode_image</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d5a0143498c044286128-27"><span class="crayon-h">        </span><span class="crayon-v">coupon_url</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">combine_images_into_coupon</span><span class="crayon-sy">(</span><span class="crayon-v">logo_img</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">barcode_img</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d5a0143498c044286128-28"><span class="crayon-h">        </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">redirect</span><span class="crayon-sy">(</span><span class="crayon-e">url_for</span><span class="crayon-sy">(</span><span class="crayon-s">'coupon_confirmation'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-marked-line crayon-bottom" id="crayon-56d5a0143498c044286128-29"><span class="crayon-h">    </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">render_template</span><span class="crayon-sy">(</span><span class="crayon-s">'create_coupon.html'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">form</span><span class="crayon-o">=</span><span class="crayon-v">form</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p/>
<p dir="ltr">The above code retrieves user input from form data, downloads a logo image and generates the barcode with the assistance of the functions we wrote earlier.</p>
<p dir="ltr">For the 
			<span id="crayon-56d5a01434996229842025" class="crayon-syntax crayon-syntax-inline  crayon-theme-github crayon-theme-github-inline crayon-font-consolas"><span class="crayon-pre crayon-code"><span class="crayon-v">coupon_confirmation</span></span></span> function also within 
			<span id="crayon-56d5a014349a0102218235" class="crayon-syntax crayon-syntax-inline  crayon-theme-github crayon-theme-github-inline crayon-font-consolas"><span class="crayon-pre crayon-code"><span class="crayon-v">app</span><span class="crayon-sy">.</span><span class="crayon-v">py</span></span></span>, replace the 
			<span id="crayon-56d5a014349aa662639037" class="crayon-syntax crayon-syntax-inline  crayon-theme-github crayon-theme-github-inline crayon-font-consolas"><span class="crayon-pre crayon-code"><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-s">'stub'</span></span></span> placeholder under with the following two lines.</p>
<p/>

		<div id="crayon-56d5a014349b3316597801" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5a014349b3316597801-1"><span class="crayon-sy">@</span><span class="crayon-v">app</span><span class="crayon-sy">.</span><span class="crayon-e">route</span><span class="crayon-sy">(</span><span class="crayon-s">'/confirmation/'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">methods</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'GET'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014349b3316597801-2"><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">coupon_confirmation</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-marked-line crayon-top" id="crayon-56d5a014349b3316597801-3"><span class="crayon-h">    </span><span class="crayon-v">form</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">CouponForm</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-marked-line crayon-bottom crayon-striped-line" id="crayon-56d5a014349b3316597801-4"><span class="crayon-h">    </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">render_template</span><span class="crayon-sy">(</span><span class="crayon-s">'confirmation.html'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">form</span><span class="crayon-o">=</span><span class="crayon-v">form</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p/>
<p dir="ltr">With the above code the user is allowed to create a coupon by submitting a form either on the landing page or the confirmation page.</p>
<p dir="ltr">If we run the app now using 
			<span id="crayon-56d5a014349bd345348322" class="crayon-syntax crayon-syntax-inline  crayon-theme-github crayon-theme-github-inline crayon-font-consolas"><span class="crayon-pre crayon-code"><span class="crayon-e">python </span><span class="crayon-v">app</span><span class="crayon-sy">.</span><span class="crayon-v">py</span></span></span> we’ll generate the coupon but now we need to deliver it directly to the user, which we can do using Twilio MMS.</p>
<h2 dir="ltr">Send coupon via MMS</h2>
<p dir="ltr">We now have the code to create coupon images with barcodes. If you want to start with the code to this point in the blog post check out the <a href="https://github.com/makaimc/branded-mms-coupons/tree/tutorial-step-2">tutorial-step-2 tag</a>. Now let’s add the code for distributing those coupons via MMS.</p>
<p dir="ltr">Head back to the <em>utils.py</em> file. Add the following two imports at the top as well as an instantiation of the Twilio Python helper library.</p>
<p/>

		<div id="crayon-56d5a014349c7429267360" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5a014349c7429267360-1"><span class="crayon-e">import </span><span class="crayon-e">barcode</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014349c7429267360-2"><span class="crayon-e">import </span><span class="crayon-e">requests</span></p><p class="crayon-line" id="crayon-56d5a014349c7429267360-3"><span class="crayon-e">import </span><span class="crayon-e">uuid</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014349c7429267360-4"><span class="crayon-e">from </span><span class="crayon-v">barcode</span><span class="crayon-sy">.</span><span class="crayon-e">writer </span><span class="crayon-e">import </span><span class="crayon-e">ImageWriter</span></p><p class="crayon-line" id="crayon-56d5a014349c7429267360-5"><span class="crayon-e">from </span><span class="crayon-e">PIL </span><span class="crayon-e">import </span><span class="crayon-e">Image</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014349c7429267360-6"><span class="crayon-e">from </span><span class="crayon-e">StringIO </span><span class="crayon-e">import </span><span class="crayon-e">StringIO</span></p><p class="crayon-line crayon-marked-line crayon-top crayon-bottom" id="crayon-56d5a014349c7429267360-7"><span class="crayon-e">from </span><span class="crayon-v">twilio</span><span class="crayon-sy">.</span><span class="crayon-e">rest </span><span class="crayon-e">import </span><span class="crayon-e">TwilioRestClient</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014349c7429267360-8"> </p><p class="crayon-line" id="crayon-56d5a014349c7429267360-9"><span class="crayon-e">from </span><span class="crayon-e">config </span><span class="crayon-e">import </span><span class="crayon-v">COUPON_SAVE_DIR</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">QUALIFIED_MEDIA_URL</span></p><p class="crayon-line crayon-marked-line crayon-top crayon-bottom crayon-striped-line" id="crayon-56d5a014349c7429267360-10"><span class="crayon-e">from </span><span class="crayon-e">config </span><span class="crayon-e">import </span><span class="crayon-e">TWILIO_NUMBER</span></p><p class="crayon-line" id="crayon-56d5a014349c7429267360-11"> </p><p class="crayon-line crayon-marked-line crayon-top crayon-bottom crayon-striped-line" id="crayon-56d5a014349c7429267360-12"><span class="crayon-v">client</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">TwilioRestClient</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a014349c7429267360-13"><span class="crayon-v">extra_spacing</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">50</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p/>
<p dir="ltr">A function is required to send the MMS based on user input. Add this code at the bottom of the <em>utils.py</em> file.</p>
<p/>

		<div id="crayon-56d5a014349d1550597389" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5a014349d1550597389-1"><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">send_coupon_via_mms</span><span class="crayon-sy">(</span><span class="crayon-v">coupon_filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">recipient_number</span><span class="crayon-sy">,</span><span class="crayon-h"> </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014349d1550597389-2"><span class="crayon-h">                        </span><span class="crayon-v">msg_text</span><span class="crayon-o">=</span><span class="crayon-s">"Scan me for 20% off!"</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5a014349d1550597389-3"><span class="crayon-h">    </span><span class="crayon-v">to_number</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"+1"</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e">recipient_number</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014349d1550597389-4"><span class="crayon-e">    </span><span class="crayon-v">media_url</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">QUALIFIED_MEDIA_URL</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e">coupon_filename</span></p><p class="crayon-line" id="crayon-56d5a014349d1550597389-5"><span class="crayon-e">    </span><span class="crayon-v">client</span><span class="crayon-sy">.</span><span class="crayon-v">messages</span><span class="crayon-sy">.</span><span class="crayon-e">create</span><span class="crayon-sy">(</span><span class="crayon-v">to</span><span class="crayon-o">=</span><span class="crayon-v">to_number</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">from_</span><span class="crayon-o">=</span><span class="crayon-v">TWILIO_NUMBER</span><span class="crayon-sy">,</span><span class="crayon-h"> </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014349d1550597389-6"><span class="crayon-h">                           </span><span class="crayon-v">body</span><span class="crayon-o">=</span><span class="crayon-v">msg_text</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">media_url</span><span class="crayon-o">=</span><span class="crayon-v">media_url</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p/>
<p dir="ltr">Finally, we’ll call this new function from the end of our 
			<span id="crayon-56d5a014349db056404028" class="crayon-syntax crayon-syntax-inline  crayon-theme-github crayon-theme-github-inline crayon-font-consolas"><span class="crayon-pre crayon-code"><span class="crayon-v">create_image</span></span></span> function in <em>coupons/app.py</em>. The additional line to send MMS coupon messages is highlighted below.</p>
<p/>

		<div id="crayon-56d5a014349e4345065443" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-56d5a014349e4345065443-1">1</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a014349e4345065443-2">2</p><p class="crayon-num" data-line="crayon-56d5a014349e4345065443-3">3</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a014349e4345065443-4">4</p><p class="crayon-num" data-line="crayon-56d5a014349e4345065443-5">5</p><p class="crayon-num crayon-marked-num crayon-top crayon-bottom crayon-striped-num" data-line="crayon-56d5a014349e4345065443-6">6</p><p class="crayon-num" data-line="crayon-56d5a014349e4345065443-7">7</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a014349e4345065443-8">8</p><p class="crayon-num" data-line="crayon-56d5a014349e4345065443-9">9</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a014349e4345065443-10">10</p><p class="crayon-num" data-line="crayon-56d5a014349e4345065443-11">11</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a014349e4345065443-12">12</p><p class="crayon-num" data-line="crayon-56d5a014349e4345065443-13">13</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a014349e4345065443-14">14</p><p class="crayon-num" data-line="crayon-56d5a014349e4345065443-15">15</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a014349e4345065443-16">16</p><p class="crayon-num" data-line="crayon-56d5a014349e4345065443-17">17</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a014349e4345065443-18">18</p><p class="crayon-num" data-line="crayon-56d5a014349e4345065443-19">19</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a014349e4345065443-20">20</p><p class="crayon-num" data-line="crayon-56d5a014349e4345065443-21">21</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a014349e4345065443-22">22</p><p class="crayon-num" data-line="crayon-56d5a014349e4345065443-23">23</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a014349e4345065443-24">24</p><p class="crayon-num" data-line="crayon-56d5a014349e4345065443-25">25</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a014349e4345065443-26">26</p><p class="crayon-num" data-line="crayon-56d5a014349e4345065443-27">27</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a014349e4345065443-28">28</p><p class="crayon-num" data-line="crayon-56d5a014349e4345065443-29">29</p><p class="crayon-num crayon-marked-num crayon-top crayon-bottom crayon-striped-num" data-line="crayon-56d5a014349e4345065443-30">30</p><p class="crayon-num" data-line="crayon-56d5a014349e4345065443-31">31</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5a014349e4345065443-32">32</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5a014349e4345065443-1"><span class="crayon-st">from</span><span class="crayon-h"> </span><span class="crayon-e">flask </span><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-v">Flask</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">request</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">render_template</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">redirect</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">url_for</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014349e4345065443-2"> </p><p class="crayon-line" id="crayon-56d5a014349e4345065443-3"><span class="crayon-st">from</span><span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-e">forms </span><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">CouponForm</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014349e4345065443-4"><span class="crayon-st">from</span><span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-e">utils </span><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-v">generate_barcode_image</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">combine_images_into_coupon</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></p><p class="crayon-line" id="crayon-56d5a014349e4345065443-5"><span class="crayon-h">                   </span><span class="crayon-e">open_image_file_from_url</span></p><p class="crayon-line crayon-marked-line crayon-top crayon-bottom crayon-striped-line" id="crayon-56d5a014349e4345065443-6"><span class="crayon-st">from</span><span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-e">utils </span><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">send_coupon_via_mms</span></p><p class="crayon-line" id="crayon-56d5a014349e4345065443-7"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014349e4345065443-8"><span class="crayon-v">twilio_logo_png_url</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'http://www.twilio.com/packages/company/'</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></p><p class="crayon-line" id="crayon-56d5a014349e4345065443-9"><span class="crayon-h">                      </span><span class="crayon-s">'img/logos_downloadable_logobrand.png'</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014349e4345065443-10"> </p><p class="crayon-line" id="crayon-56d5a014349e4345065443-11"><span class="crayon-v">app</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Flask</span><span class="crayon-sy">(</span><span class="crayon-v">__name__</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">static_url_path</span><span class="crayon-o">=</span><span class="crayon-s">'/static'</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014349e4345065443-12"><span class="crayon-v">app</span><span class="crayon-sy">.</span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-e">from_pyfile</span><span class="crayon-sy">(</span><span class="crayon-s">'config.py'</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a014349e4345065443-13"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014349e4345065443-14"><span class="crayon-sy">@</span><span class="crayon-v">app</span><span class="crayon-sy">.</span><span class="crayon-e">route</span><span class="crayon-sy">(</span><span class="crayon-s">'/'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">methods</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'GET'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'POST'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a014349e4345065443-15"><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">create_coupon</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014349e4345065443-16"><span class="crayon-h">    </span><span class="crayon-v">form</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">CouponForm</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a014349e4345065443-17"><span class="crayon-h">    </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">form</span><span class="crayon-sy">.</span><span class="crayon-e">validate_on_submit</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014349e4345065443-18"><span class="crayon-h">        </span><span class="crayon-v">serial_number</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">form</span><span class="crayon-sy">.</span><span class="crayon-v">serial_number</span><span class="crayon-sy">.</span><span class="crayon-e">data</span></p><p class="crayon-line" id="crayon-56d5a014349e4345065443-19"><span class="crayon-e">        </span><span class="crayon-v">phone_number</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">form</span><span class="crayon-sy">.</span><span class="crayon-v">phone_number</span><span class="crayon-sy">.</span><span class="crayon-e">data</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014349e4345065443-20"><span class="crayon-e">        </span><span class="crayon-v">logo_image_url</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">form</span><span class="crayon-sy">.</span><span class="crayon-v">logo_image_url</span><span class="crayon-sy">.</span><span class="crayon-e">data</span></p><p class="crayon-line" id="crayon-56d5a014349e4345065443-21"><span class="crayon-e">        </span><span class="crayon-v">coupon_text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">form</span><span class="crayon-sy">.</span><span class="crayon-v">coupon_text</span><span class="crayon-sy">.</span><span class="crayon-e">data</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014349e4345065443-22"><span class="crayon-e">        </span><span class="crayon-v">logo_img</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open_image_file_from_url</span><span class="crayon-sy">(</span><span class="crayon-v">logo_image_url</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a014349e4345065443-23"><span class="crayon-h">        </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-v">logo_img</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014349e4345065443-24"><span class="crayon-h">            </span><span class="crayon-v">logo_img</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open_image_file_from_url</span><span class="crayon-sy">(</span><span class="crayon-v">twilio_logo_png_url</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a014349e4345065443-25"><span class="crayon-h">        </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">serial_number</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014349e4345065443-26"><span class="crayon-h">            </span><span class="crayon-v">barcode_img</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">generate_barcode_image</span><span class="crayon-sy">(</span><span class="crayon-v">serial_number</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a014349e4345065443-27"><span class="crayon-h">        </span><span class="crayon-st">else</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014349e4345065443-28"><span class="crayon-h">            </span><span class="crayon-v">barcode_img</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">generate_barcode_image</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a014349e4345065443-29"><span class="crayon-h">        </span><span class="crayon-v">coupon_url</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">combine_images_into_coupon</span><span class="crayon-sy">(</span><span class="crayon-v">logo_img</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">barcode_img</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-marked-line crayon-top crayon-bottom crayon-striped-line" id="crayon-56d5a014349e4345065443-30"><span class="crayon-h">        </span><span class="crayon-e">send_coupon_via_mms</span><span class="crayon-sy">(</span><span class="crayon-v">coupon_url</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">phone_number</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">coupon_text</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5a014349e4345065443-31"><span class="crayon-h">        </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">redirect</span><span class="crayon-sy">(</span><span class="crayon-e">url_for</span><span class="crayon-sy">(</span><span class="crayon-s">'coupon_confirmation'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014349e4345065443-32"><span class="crayon-h">    </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">render_template</span><span class="crayon-sy">(</span><span class="crayon-s">'create_coupon.html'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">form</span><span class="crayon-o">=</span><span class="crayon-v">form</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p/>
<p dir="ltr">Congratulations! You now you have a fully functioning digital coupon creation and distribution service. Or almost anyways.</p>
<p> </p>
<p dir="ltr">Give the app a test on your own machine and you’ll see that it will fail to send the MMS message. This is because Twilio needs a publicly accessibly URL from which it can grab the coupon images. You could use a great service like ngrok to test the app on your local machine, or even better, lets just deploy the app to Heroku.</p>
<h2 dir="ltr">Deploying the Coupon App</h2>
<p dir="ltr">Our app should have the desired functionality, but we need to deploy it otherwise the coupons’ URLs will not be accessible to Twilio. To deploy the app to Heroku we need our code committed in a Git repository and to instruct the service how to use our app with a Procfile. For more information on deploying a Python app with Gunicorn on Heroku check out <a href="https://devcenter.heroku.com/articles/python-gunicorn">their official guide</a>.</p>
<p dir="ltr">Create the Procfile in the root directory of our project with the following one-line instruction to run the app via Gunicorn.</p>
<p dir="ltr">web: gunicorn app:app</p>
<p dir="ltr">The <a href="https://github.com/makaimc/branded-mms-coupons">master branch</a> of our Git repo contains all the code at this point in our app development. Use the following commands to create a new Heroku app, push your code and set the environment variables.</p>
<p/>

		<div id="crayon-56d5a014349f0931536489" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5a014349f0931536489-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">heroku </span><span class="crayon-i">create</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014349f0931536489-2"> </p><p class="crayon-line" id="crayon-56d5a014349f0931536489-3"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">git </span><span class="crayon-e">push </span><span class="crayon-e">heroku </span><span class="crayon-i">master</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014349f0931536489-4"> </p><p class="crayon-line" id="crayon-56d5a014349f0931536489-5"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">heroku </span><span class="crayon-v">config</span><span class="crayon-o">:</span><span class="crayon-e">set </span><span class="crayon-v">SECRET_KEY</span><span class="crayon-o">=</span><span class="crayon-s">"super secret key"</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014349f0931536489-6"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">heroku </span><span class="crayon-v">config</span><span class="crayon-o">:</span><span class="crayon-e">set </span><span class="crayon-v">COUPON_SAVE_DIR</span><span class="crayon-o">=</span><span class="crayon-s">"/app/coupons/static/img/"</span></p><p class="crayon-line" id="crayon-56d5a014349f0931536489-7"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">heroku </span><span class="crayon-v">config</span><span class="crayon-o">:</span><span class="crayon-e">set </span><span class="crayon-v">QUALIFIED_MEDIA_URL</span><span class="crayon-o">=</span><span class="crayon-s">"http://heroku-app-name.herokuapp.com/static/img/"</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014349f0931536489-8"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">heroku </span><span class="crayon-v">config</span><span class="crayon-o">:</span><span class="crayon-e">set </span><span class="crayon-v">TWILIO_ACCOUNT_SID</span><span class="crayon-o">=</span><span class="crayon-s">"your account SID"</span></p><p class="crayon-line" id="crayon-56d5a014349f0931536489-9"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">heroku </span><span class="crayon-v">config</span><span class="crayon-o">:</span><span class="crayon-e">set </span><span class="crayon-v">TWILIO_AUTH_TOKEN</span><span class="crayon-o">=</span><span class="crayon-s">"your secret Twilio auth token"</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a014349f0931536489-10"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">heroku </span><span class="crayon-v">config</span><span class="crayon-o">:</span><span class="crayon-e">set </span><span class="crayon-v">TWILIO_NUMBER</span><span class="crayon-o">=</span><span class="crayon-s">"your MMS Twilio number"</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p/>
<p dir="ltr">Ensure you’ve set the 
			<span id="crayon-56d5a014349fa132777366" class="crayon-syntax crayon-syntax-inline  crayon-theme-github crayon-theme-github-inline crayon-font-consolas"><span class="crayon-pre crayon-code"><span class="crayon-v">QUALIFIED_MEDIA_URL</span></span></span> with your own Heroku app name and trailing slash on the end of the URL. 
			<span id="crayon-56d5a01434a04573205579" class="crayon-syntax crayon-syntax-inline  crayon-theme-github crayon-theme-github-inline crayon-font-consolas"><span class="crayon-pre crayon-code"><span class="crayon-v">COUPON_SAVE_DIR</span></span></span> also must have a trailing slash at the end of the path.</p>
<p> </p>
<p dir="ltr">Head to the new Heroku instance and you’ll see the following input screen.</p>
<p dir="ltr"><img alt="" src="https://lh6.googleusercontent.com/3nPWnCwZj0kPFSvlc4wCCels3rH5lp7vISDQuMVlaLYzaxgBxHbg3cNDxfY-Q4PE9L74CbszvpJpR_Gt0CKLnuhFHiv2osHebgfPQ29HmL9hFrt5gY-D4QIyMqJt25Pj-w"/></p>
<p dir="ltr">Now we can send branded coupons with text of the discount to a customer number!</p>
<p dir="ltr">Here’s one with the Twilio logo. This is also the default logo if you choose to not fill in a .png logo during the coupon generation process.</p>
<p dir="ltr"><img alt="" src="https://lh6.googleusercontent.com/2GrqxN5PxqpqqK38rY9u3Bf5U7Q-cFkhM3-fih_w0ozgBVgBVUhz0JnZiLh5AX0-Qa0xeDP_p7t7guiaqWAQHuZtGmgHvzNmbBySnKtWhJFgA6ZUdWK3x9SostwFyi_ERA"/></p>
<h2 dir="ltr">Wrapping it up</h2>
<p dir="ltr">Awesome! We’ve combined Python, Flask and Twilio to create a web application that sends digital coupons to customers. Now you’ve got the ability to send MMS coupons to your phone-wielding customers as an alternative to paper coupons that can get lost or be forgotten at home.</p>
<p dir="ltr">This web application can be enhanced in many ways so feel free to <a href="https://github.com/makaimc/branded-mms-coupons">fork it</a> and contact me at <a href="mailto:makai@twilio.com">makai@twilio.com</a> with any questions you have on our new branded MMS coupon app.</p>
			</div>
					</div></body></html>