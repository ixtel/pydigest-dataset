<html><body><div><p>Everyone knows and expects this, and it's very well documented.</p><div class="section" id="a-different-example"><span id="not-always-intuitive"/><h2>A different example<a class="headerlink" href="#a-different-example" title="Permalink to this headline"> *</a></h2><p>Suppose we want to model books that have multiple authors:</p><div class="highlight"><pre><span/><span class="k">class</span> <span class="nc">Author</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">nationality</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">sex</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">birth</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">alive</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Book</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">authors</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">Author</span><span class="p">)</span>
</pre></div><p>What if we want to get all the books that have a female French <tt class="docutils literal">Author</tt>?</p><p>If we run <tt class="docutils literal"><span class="pre">Book.objects.filter(authors__nationality='french',</span> <span class="pre">authors__sex='f')</span></tt> then we'd get roughly this query:</p><div class="highlight"><pre><span/><span class="k">SELECT</span> <span class="ss">`app_book`</span><span class="p">.</span><span class="ss">`id`</span>
<span class="k">FROM</span> <span class="ss">`app_book`</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">`app_book_authors`</span> <span class="k">ON</span> <span class="p">(</span><span class="ss">`app_book`</span><span class="p">.</span><span class="ss">`id`</span> <span class="o">=</span> <span class="ss">`app_book_authors`</span><span class="p">.</span><span class="ss">`book_id`</span><span class="p">)</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">`app_author`</span> <span class="k">ON</span> <span class="p">(</span><span class="ss">`app_book_authors`</span><span class="p">.</span><span class="ss">`author_id`</span> <span class="o">=</span> <span class="ss">`app_author`</span><span class="p">.</span><span class="ss">`id`</span><span class="p">)</span>
<span class="k">WHERE</span> <span class="p">(</span><span class="ss">`app_author`</span><span class="p">.</span><span class="ss">`nationality`</span> <span class="o">=</span> <span class="s1">'french'</span>
       <span class="k">AND</span> <span class="ss">`app_author`</span><span class="p">.</span><span class="ss">`sex`</span> <span class="o">=</span> <span class="s1">'f'</span><span class="p">)</span>
</pre></div><p>This is fine. But if we run <tt class="docutils literal"><span class="pre">Book.objects.filter(authors__nationality='french').filter(authors__sex='f')</span></tt> then we get this horrible query:</p><div class="highlight"><pre><span/><span class="k">SELECT</span> <span class="ss">`app_book`</span><span class="p">.</span><span class="ss">`id`</span>
<span class="k">FROM</span> <span class="ss">`app_book`</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">`app_book_authors`</span> <span class="k">ON</span> <span class="p">(</span><span class="ss">`app_book`</span><span class="p">.</span><span class="ss">`id`</span> <span class="o">=</span> <span class="ss">`app_book_authors`</span><span class="p">.</span><span class="ss">`book_id`</span><span class="p">)</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">`app_author`</span> <span class="k">ON</span> <span class="p">(</span><span class="ss">`app_book_authors`</span><span class="p">.</span><span class="ss">`author_id`</span> <span class="o">=</span> <span class="ss">`app_author`</span><span class="p">.</span><span class="ss">`id`</span><span class="p">)</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">`app_book_authors`</span> <span class="n">T4</span> <span class="k">ON</span> <span class="p">(</span><span class="ss">`app_book`</span><span class="p">.</span><span class="ss">`id`</span> <span class="o">=</span> <span class="n">T4</span><span class="p">.</span><span class="ss">`book_id`</span><span class="p">)</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">`app_author`</span> <span class="n">T5</span> <span class="k">ON</span> <span class="p">(</span><span class="n">T4</span><span class="p">.</span><span class="ss">`author_id`</span> <span class="o">=</span> <span class="n">T5</span><span class="p">.</span><span class="ss">`id`</span><span class="p">)</span>
<span class="k">WHERE</span> <span class="p">(</span><span class="ss">`app_author`</span><span class="p">.</span><span class="ss">`nationality`</span> <span class="o">=</span> <span class="s1">'french'</span>
       <span class="k">AND</span> <span class="n">T5</span><span class="p">.</span><span class="ss">`sex`</span> <span class="o">=</span> <span class="s1">'f'</span><span class="p">)</span>
</pre></div><p>Not to mention it's wrong it can get quite slow when you have large datasets. People have <a class="reference external" href="https://code.djangoproject.com/ticket/18437">complained</a> about this but it's not something changeable - there are large amounts of code relying on the current behavior and in simple scenarios it's fine (as it was outlined above).</p><p>However, there are some scenarios where you cannot afford using a single filter. Imagine you're using <a class="reference external" href="https://pypi.python.org/pypi/django-filter">django-filter</a>. Quite hard to collate everything in the same <tt class="docutils literal">filter</tt> call.</p><p>Turns out there's a <em>undocumented</em> QuerySet method (<tt class="docutils literal">_next_is_sticky</tt>) that can help us. It has been <a class="reference external" href="https://code.djangoproject.com/ticket/8046">there</a> <a class="reference external" href="https://github.com/django/django/commit/d4d7bc175ddd0b698e394a202f8ab6ae572d63d3">since</a> Django 1.0 and it turns out few people are actually <a class="reference external" href="https://github.com/search?q=_next_is_sticky&amp;type=Code">using it</a>.</p><p>The method mutates the QuerySet to have a <em>sticky</em> flag so that the next two filters combine. You need to call it before every pair of filters you want to be merged in (the sticky flag doesn't persist). E.g.:</p><div class="highlight"><pre><span/><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">_next_is_sticky</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="n">authors__nationality</span><span class="o">=</span><span class="s1">'french'</span>
<span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="n">authors__sex</span><span class="o">=</span><span class="s1">'f'</span>
<span class="p">)</span>
</pre></div><p>Note the <tt class="docutils literal">all()</tt> call - the <tt class="docutils literal">Manager</tt> (<tt class="docutils literal">Book.objects</tt>) doesn't have the <tt class="docutils literal">_next_is_sticky</tt> method - only the <tt class="docutils literal">QuerySet</tt> does.</p><p>Also, note that it works for <em>pairs</em>. Example, this:</p><div class="highlight"><pre><span/><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">_next_is_sticky</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="n">authors__nationality</span><span class="o">=</span><span class="s1">'french'</span>
<span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="n">authors__birth__year</span><span class="o">=</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">year</span> <span class="o">-</span> <span class="mi">50</span>
<span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="n">alive</span><span class="o">=</span><span class="bp">True</span>
<span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="n">sex</span><span class="o">=</span><span class="s1">'f'</span>
<span class="p">)</span>
</pre></div><blockquote><p>would generate:</p><div class="highlight"><pre><span/><span class="k">SELECT</span> <span class="ss">`app_book`</span><span class="p">.</span><span class="ss">`id`</span>
<span class="k">FROM</span> <span class="ss">`app_book`</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">`app_book_authors`</span> <span class="k">ON</span> <span class="p">(</span><span class="ss">`app_book`</span><span class="p">.</span><span class="ss">`id`</span> <span class="o">=</span> <span class="ss">`app_book_authors`</span><span class="p">.</span><span class="ss">`book_id`</span><span class="p">)</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">`app_author`</span> <span class="k">ON</span> <span class="p">(</span><span class="ss">`app_book_authors`</span><span class="p">.</span><span class="ss">`author_id`</span> <span class="o">=</span> <span class="ss">`app_author`</span><span class="p">.</span><span class="ss">`id`</span><span class="p">)</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">`app_book_authors`</span> <span class="n">T4</span> <span class="k">ON</span> <span class="p">(</span><span class="ss">`app_book`</span><span class="p">.</span><span class="ss">`id`</span> <span class="o">=</span> <span class="n">T4</span><span class="p">.</span><span class="ss">`book_id`</span><span class="p">)</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">`app_author`</span> <span class="n">T5</span> <span class="k">ON</span> <span class="p">(</span><span class="n">T4</span><span class="p">.</span><span class="ss">`author_id`</span> <span class="o">=</span> <span class="n">T5</span><span class="p">.</span><span class="ss">`id`</span><span class="p">)</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">`app_book_authors`</span> <span class="n">T6</span> <span class="k">ON</span> <span class="p">(</span><span class="ss">`app_book`</span><span class="p">.</span><span class="ss">`id`</span> <span class="o">=</span> <span class="n">T6</span><span class="p">.</span><span class="ss">`book_id`</span><span class="p">)</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">`app_author`</span> <span class="n">T7</span> <span class="k">ON</span> <span class="p">(</span><span class="n">T6</span><span class="p">.</span><span class="ss">`author_id`</span> <span class="o">=</span> <span class="n">T7</span><span class="p">.</span><span class="ss">`id`</span><span class="p">)</span>
<span class="k">WHERE</span> <span class="p">(</span><span class="ss">`app_author`</span><span class="p">.</span><span class="ss">`nationality`</span> <span class="o">=</span> <span class="s1">'french'</span>
       <span class="k">AND</span> <span class="ss">`app_author`</span><span class="p">.</span><span class="ss">`birth`</span> <span class="k">BETWEEN</span> <span class="s1">'1964-01-01'</span> <span class="k">and</span> <span class="s1">'1964-12-31'</span>
       <span class="k">AND</span> <span class="n">T5</span><span class="p">.</span><span class="ss">`alive`</span> <span class="o">=</span> <span class="mi">1</span>
       <span class="k">AND</span> <span class="n">T7</span><span class="p">.</span><span class="ss">`sex`</span> <span class="o">=</span> <span class="s1">'f'</span><span class="p">)</span>
</pre></div></blockquote><p>Note that neither this is correct (it would leave us with two joins):</p><div class="highlight"><pre><span/><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">_next_is_sticky</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="n">authors__nationality</span><span class="o">=</span><span class="s1">'french'</span>
<span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="n">authors__birth__year</span><span class="o">=</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">year</span> <span class="o">-</span> <span class="mi">50</span>
<span class="p">)</span><span class="o">.</span><span class="n">_next_is_sticky</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="n">authors__alive</span><span class="o">=</span><span class="bp">True</span>
<span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="n">authors__sex</span><span class="o">=</span><span class="s1">'f'</span>
<span class="p">)</span>
</pre></div><p>The best practice is to have <tt class="docutils literal">_next_is_sticky</tt> before every <tt class="docutils literal">filter</tt>, like this:</p><div class="highlight"><pre><span/><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">_next_is_sticky</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="n">authors__nationality</span><span class="o">=</span><span class="s1">'french'</span>
<span class="p">)</span><span class="o">.</span><span class="n">_next_is_sticky</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="n">authors__birth__year</span><span class="o">=</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">year</span> <span class="o">-</span> <span class="mi">50</span>
<span class="p">)</span><span class="o">.</span><span class="n">_next_is_sticky</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="n">authors__alive</span><span class="o">=</span><span class="bp">True</span>
<span class="p">)</span><span class="o">.</span><span class="n">_next_is_sticky</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="n">authors__sex</span><span class="o">=</span><span class="s1">'f'</span>
<span class="p">)</span>
</pre></div><p>When you need the normal behavior you can clear the flag with <tt class="docutils literal">.all()</tt> (e.g.: after you finish up the chain).</p></div></div></body></html>