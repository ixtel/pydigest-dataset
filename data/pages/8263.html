<html><body><div><div class="entry-content">

                

                <p>О Twitter нечего писать, проект уже взрослый и известный. Через Твиттер продают, покупают, разыгрывают призы, консультируют, оказывают поддержку проектов, да даже используют как сервис оповещений.
Twitter имеет открытый API, который сегодня и освоим. Мы научимся публиковать пост с изображением через Twitter API</p>
<h2>Начинаем работу с API - получаем APP_ID</h2>
<p>Как и с другими API, первый шаг - почитать документацию - <a href="https://dev.twitter.com/overview/documentation">https://dev.twitter.com/overview/documentation</a></p>
<p>А второй шаг - авторизоваться. Чтобы авторизоваться надо получить API Key, API Secret и access token. 
Для этого идем по ссылке <a href="https://apps.twitter.com/">https://apps.twitter.com/</a></p>
<p>Наблюдаем такую картину:</p>
<p><img alt="Image" src="http://old.pynsk.ru/images/posts/twitter_api_1.png"/></p>
<p>Создаем приложение - вводим название, описание и ссылку на сайт. Эти данные толком не важны, поэтому вводим любые</p>
<p><img alt="Image" src="http://old.pynsk.ru/images/posts/twitter_api_2.png"/></p>
<p>После того как будет создано приложение мы получим нужные данные:</p>
<p><img alt="Image" src="http://old.pynsk.ru/images/posts/twitter_api_3.png"/>
<img alt="Image" src="http://old.pynsk.ru/images/posts/twitter_api_4.png"/></p>
<p>Жмем на кнопку <code>"Create my access token"</code> и получаем все самое важное:</p>
<ul>
<li>API key (<code>TWITTER_CONSUMER_KEY</code>)</li>
<li>API Secret (<code>TWITTER_CONSUMER_SECRET</code>)</li>
<li>Access token (<code>TWITTER_TOKEN</code>)</li>
<li>Access token secret (<code>TWITTER_TOKEN_SECRET</code>)</li>
</ul>
<p>Теперь перейдем непосредственно к авторизации и нашей задачи</p>
<h2>Выбираем клиенсткую библиотеку</h2>
<p>Для API твиттера написано множество готовых клиентский библиотек - <a href="https://dev.twitter.com/overview/api/twitter-libraries">https://dev.twitter.com/overview/api/twitter-libraries</a></p>
<p>Для Python это:</p>

<p>Т.е. очень много.</p>
<p>В примерах будет использоваться <code>tweepy</code> - потому что потому.</p>
<h2>Работаем с API</h2>
<p>Объявленная задача - написать пост через API с вложением.
Для этого:</p>
<p>Напишем функцию авторизации:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">init_auth</span><span class="p">(</span><span class="n">consumer_key</span><span class="p">,</span> <span class="n">consumer_secret</span><span class="p">,</span> <span class="n">access_token</span><span class="p">,</span> <span class="n">access_token_secret</span><span class="p">):</span>
    <span class="n">auth</span> <span class="o">=</span> <span class="n">tweepy</span><span class="o">.</span><span class="n">OAuthHandler</span><span class="p">(</span><span class="n">consumer_key</span><span class="p">,</span> <span class="n">consumer_secret</span><span class="p">)</span>
    <span class="n">auth</span><span class="o">.</span><span class="n">set_access_token</span><span class="p">(</span><span class="n">access_token</span><span class="p">,</span> <span class="n">access_token_secret</span><span class="p">)</span>
    <span class="n">api</span> <span class="o">=</span> <span class="n">tweepy</span><span class="o">.</span><span class="n">API</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">api</span>
</pre></div>


<p>После этого можно дергать методы из документации.
Для публикации поста с вложением есть метод <code>update_with_media</code> в <code>tweepy</code>, который принимает путь до файла и текст.</p>
<p>Практика использования показывает, что картинки используются из Интернет, поэтому удобней указывать url до картинки и текст.
Напишем функции:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">download_image</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">url</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">except</span> <span class="n">HTTPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">file_path</span>


<span class="k">def</span> <span class="nf">send_tweet_with_media</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">'http://'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">image</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">image</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># качаем файл из сети</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">download_image</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">file_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">"Not found image (for twitter)"</span>
    <span class="n">api</span><span class="o">.</span><span class="n">update_with_media</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span> 
</pre></div>


<p>Вот и весь код. Используем его</p>
<div class="highlight"><pre><span class="n">twitter_text</span> <span class="o">=</span> <span class="s1">'#pynsk Я научился работать с twitter api"</span>
<span class="n">image</span> <span class="o">=</span> <span class="s1">'https://pp.vk.me/c624516/v624516517/31b6b/6kViWNZI6n4.jpg'</span>
<span class="n">twitter_api</span> <span class="o">=</span> <span class="n">init_auth</span><span class="p">(</span><span class="n">consumer_key</span><span class="p">,</span> <span class="n">consumer_secret</span><span class="p">,</span> <span class="n">access_token</span><span class="p">,</span> <span class="n">access_token_secret</span><span class="p">)</span>
<span class="n">send_tweet_with_media</span><span class="p">(</span><span class="n">twitter_api</span><span class="p">,</span> <span class="n">twitter_text</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
</pre></div>
            </div>
            
</div></body></html>