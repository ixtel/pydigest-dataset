<html><body><div><div class="post_text">
            <p>Примечание: в основе данной статьи лежит существенно изменённое и дополненное руководство «How To Set Up Django with Postgres, Nginx, and Gunicorn on Ubuntu 14.04» с сайта <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-django-with-postgres-nginx-and-gunicorn-on-ubuntu-14-04" rel="nofollow" target="_blank">digitalocean.com</a>.</p><p><img alt="django" src="/media/uploads/2016/02/15/lightcastle-django.png"/></p><h2>Содержание:</h2><ol><li>    <a href="#71" rel="nofollow">1. Введение.</a></li><li>    <a href="#72" rel="nofollow">2. Установка пакетов из репозиториев Ubuntu.</a></li><li>    <a href="#73" rel="nofollow">3. Создание базы данных PostgreSQL и пользователя.</a></li><li>    <a href="#74" rel="nofollow">4. Создание виртуальной среды для вашего Python-проекта.</a></li><li>    <a href="#75" rel="nofollow">5. Создание и настройка нового Django проекта.</a></li><li>    <a href="#76" rel="nofollow">6. Создание конфигурационного файла Gunicorn.</a></li><li>    <a href="#77" rel="nofollow">7. Настройка Nginx в качестве обратного прокси-сервера для предачи трафика на Gunicorn.</a></li><li>    <a href="#78" rel="nofollow">8. Заключение.</a></li></ol><p>Django — это мощный веб-фреймворк, который может помочь вам создать своё приложение на Python или веб-сайт. Django имеет в своём составе упрощённый веб-сервер для локального тестирования вашего кода при разработке, но для «боевого» развёртывания требуется более защищенный и мощный веб-сервер.</p><p>Для следования этому руководству вы должны иметь свежий экземпляр Ubuntu 14.04 с не корневым пользователем имеющим настроенные привилегии sudo (использование non-root пользователя является просто хорошей практикой). Вы можете прочесть об этом в инструкции по первоначальной настройке сервера на сайте <a href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-14-04" rel="nofollow" target="_blank">digitalocean.com</a>.</p><p>В этом руководстве мы покажем как установить и настроить некоторые компоненты на Ubuntu 14.04 для поддержки и обслуживания приложений на Django. Мы установим базу данных PostgreSQL, вместо того чтобы использовать установленную по умолчанию базу данных SQLite. Мы установим сервер Gunicorn в качестве интерфейса, и Nginx в качестве обратного прокси-сервера для Gunicorn, это позволит повысить защищённость и производительность наших приложений.</p><p>Мы будем устанавливать Django в виртуальной среде virtualenv, это позволит избежать конфликта зависимостей при использовании различных версий модулей в проектах на Django, развёрнутых на одном сервере. Руководство предполагает использование Python 3. Выделение фрагментов кода красным цветом означает, что вместо выделенного надо использовать своё значение исходя из контекста.</p><p>Давайте начнём.</p><p>В начале нам необходимо загрузить и установить все необходимые компоненты из репозиториев Ubuntu.</p><p>Обновляем репозитории и установленные пакеты Ubuntu выполнив команду в консоли:</p><pre><code>    sudo apt-get update &amp;&amp; sudo apt-get upgrade</code></pre><p>Как правило в репозитории Ubuntu находиться устаревшая версия Nginx, поэтому необходимо добавить репозиторий с актуальной версией сервера командой:</p><pre><code>    sudo add-apt-repository ppa:nginx/stable</code></pre><p>Если команда не работает выполняем:</p><pre><code>    sudo apt-get install software-properties-common</code></pre><p>И заново устанавливаем репозиторий Nginx. Теперь переходим к установке остальных необходимых пакетов. Менеджер python пакетов pip необходим для последующего развёртывания Gunicorn, для интеграции с базой данных и для установки ряда других пакетов в том числе Django.</p><pre><code>    sudo apt-get install python3-dev python3-pip libpq-dev postgresql postgresql-contrib nginx</code></pre><p>Также нам следует установить консольный текстовый редактор Nano и файловый менеджер Midnight Commander, их наличие упростит работу на сервере:</p><pre><code>    sudo apt-get install mc nano</code></pre><p>При установке PostgreSQL был создан пользователь ОС с именем postgres. Сменим пользователя и войдём как postgres:</p><pre><code>    sudo su postgres</code></pre><p>Запустим сессию PostgreSQL:</p><pre><code>    psql</code></pre><p>Создаём базу данных проекта:</p><pre><code>     CREATE DATABASE <span>myproject_db</span>;</code></pre><p>Создаём пользователя для подключения к БД, лучше использовать более надёжный пароль:</p><pre><code>     CREATE USER <span>myprojectuser</span> WITH PASSWORD '<span>password</span>';</code></pre><p>Установим кодировкой по умолчанию UTF-8:</p><pre><code>     ALTER ROLE <span>myprojectuser</span> SET client_encoding TO 'utf8';</code></pre><p>Блокируем считывание с незавершенных транзакций:</p><pre><code>     ALTER ROLE <span>myprojectuser</span> SET default_transaction_isolation TO 'read committed';</code></pre><p>Установим часовой пояс:</p><pre><code>     ALTER ROLE <span>myprojectuser</span> SET timezone TO 'UTC';</code></pre><p>Делегируем права на доступ к созданной базе данных новому пользователю:</p><pre><code>     GRANT ALL PRIVILEGES ON DATABASE <span>myproject_db</span> TO <span>myprojectuser</span>;</code></pre><p>Закрываем командную строку PostgreSQL:</p><pre><code>    \q</code></pre><p>Завершаем сессию postgres:</p><pre><code>    exit</code></pre><p>Устанавливаем Virtualenv:</p><pre><code>    sudo pip3 install virtualenv</code></pre><p>Создаём каталог нового проекта и переходим в него:</p><pre><code>    mkdir <span>myproject</span>
    cd <span>myproject</span></code></pre><p>Создаём виртуальную среду проекта:</p><pre><code>    virtualenv <span>myenv</span></code></pre><p>Данная команда создаст внутри каталога /myproject директорию /myenv, внутри которой будет установлена локальная версия pip и Python.</p><p>Прежде чем устанавливать зависимости проекта нам необходимо активировать виртуальную среду:<code/></p><pre><code>    source <span>myenv</span>/bin/activate</code></pre><p>Приглашение командная строка изменит внешний вид, примерно на такой:</p><pre><code>    (</code><code>myenv</code><code>)user@host:~/myproject$</code>.</pre><p>Это означает, что виртуальное среда успешно запущена.</p><p>Если вы используете файл зависимостей <code>requirements.txt, тогда устанавливаем необходимые зависимости из него:</code></p><pre><code>    pip install -r requirements.txt</code></pre><p>Если у вас нет файла зависимостей устанавливаем Django через pip;</p><pre><code>     pip install django</code></pre><p>Теперь установим сервер Gunicorn и Psycopg2, необходимый для использования PostgreSQL. Если на сервере разработки вы уже использовали PostgreSQL, тогда данный пакет возможно был установлен через файл requirements.txt, в таком случае устанавливаем только Gunicorn:</p><pre><code>    pip install gunicorn psycopg2</code></pre><p>Запускаем наш проект Django в директории /myproject. Это создаст дочерний каталог для хранения кода и скрипт manage.py внутри данного каталога. Обратите внимание, что команда заканчивается символом точки:</p><pre><code>    django-admin.py startproject <span>mysite</span> .</code></pre><p>Поправим настройки проекта в файле settings.py:</p><pre><code>    nano <span>mysite</span>/settings.py</code></pre><p>Выключим режим отладки:</p><pre><code>    DEBUG = False</code></pre><p>В данном файле выполним настройку базы данных Django. Найдём раздел DATABASES = {}, он по умолчанию предполагает использование SQlite, удалим этот раздел и вставим следующий код, не забываем указать свой пароль, и если меняли, то также указываем своё имя пользователя и имя БД :</p><pre><code>    . . .
    DATABASES = {
        'default': {
        'ENGINE': 'django.db.backends.postgresql_psycopg2',
        'NAME': '<span>myproject_db</span>',
        'USER': '<span>myprojectuser</span>',
        'PASSWORD': '<span>password</span>',
        'HOST': 'localhost',
        'PORT': '',
        }
    }
    . . .</code></pre><p>Проверяем наличие параметра STATIC_ROOT, если его нет,то прописываем внизу файла. Из данной папки Nginx будет раздавать статику.</p><pre><code>    STATIC_ROOT = os.path.join(BASE_DIR, "static/")</code></pre><p>Сохраняем изменения и закрываем файл.</p><pre><code>    Ctrl + O
    Ctrl + Z</code></pre><p>Теперь Django полностью настроен для взаимодействия с БД. Мигрируем данные в БД и тестируем сервер:</p><pre><code>    python manage.py makemigrations
    python manage.py migrate</code></pre><p>Cоздаём учётную запись администратора:<code/></p><pre><code>    python manage.py createsuperuser</code></pre><p>Указываем имя, адрес электронной почты и пароль.</p><p>Мы можем собрать весь статический контент в каталог /static выполнив:</p><pre><code>    ./manage.py collectstatic</code></pre><p>Подтверждаем выполнение данной операции.</p><p>Теперь вы можете проверить свой проект, запустив сервер разработки Django с помощью следующей команды:</p><pre><code>    ./manage.py runserver 0.0.0.0:8000</code></pre><p>Открываем веб-браузер и посещаем свой сервер по IP через порт :8000.</p><pre><code>     http://<span>server_IP</span>:8000</code></pre><p>Вы должны увидеть индекс-страницу Django по умолчанию:</p><p><img alt="django_index" src="/media/uploads/2016/02/10/django_index.png"/></p><p>Если добавить /admin в конце URL в адресной строке браузера, вам будет предложено войти в административный интерфейс введя имя  пользователя и пароль, созданный с помощью команды createsuperuser:</p><p><img alt="admin_login" src="/media/uploads/2016/02/10/admin_login.png"/></p><p>После аутентификации вы получите доступ к административному интерфейсу Django:</p><p><img alt="admin_interface" src="/media/uploads/2016/02/10/admin_interface.png"/></p><p>Остановим сервер по умолчанию, нажав CTRL + C в окне терминала.</p><p>Мы можем аналогично протестировать Gunicorn, выполнив:</p><pre><code>    gunicorn --bind 0.0.0.0:8000 <span>mysite</span>.wsgi:application</code></pre><p>Остановим сервер Gunicorn, нажав CTRL + C в окне терминала и деактивируем виртуальную среду.</p><pre><code>    deactivate</code></pre><p>Мы протестировали что Gunicorn может взаимодействовать с нашим приложением Django, но мы должны реализовать более надежный способ запуска и остановки сервера приложений.</p><p>Создадим и откроем скрипт конфигурации Gunicorn в текстовом редакторе:</p><pre><code>    sudo nano /etc/init/gunicorn.conf</code></pre><p>Копируем туда следующие настройки:</p><pre><code>    description "Gunicorn application server handling <span>myproject</span>"

    start on runlevel [2345]
    stop on runlevel [!2345]

    respawn
    setuid user
    setgid www-data
    chdir <span>/home/user/myproject
</span>
    exec myprojectenv/bin/gunicorn --workers 3 --bind unix:<span>/home/user/myproject/mysite</span>.sock  <span>mysite</span>.wsgi:application</code></pre><p>​Сохраняем и закрываем файл.</p><p>Запускаем сервис Gunicorn набрав:</p><pre><code>    sudo service gunicorn start</code></pre><p>Начнём с создания нового блока в директории  sites-available Nginx: <code/></p><pre><code>    sudo nano /etc/nginx/sites-available/<span>myproject</span></code></pre><p>Внутри, создим два новых блока server. С указанием для этих блоков слушать стандартный порт 80 и реагировать на доменное имя вашего сервера. Первый блок нужен для редиректа  с www на без www:</p><pre><code>   server {
       listen 80;
       server_name www.<span>example.com</span>;
       return 301 http://<span>example.com</span>$request_uri;
   }
</code><code>   server {
       listen 80;
       server_name <span>example.com</span>;
       # остальные настройки сервера
   }</code></pre><p>Для редиректа  с без www на www:</p><pre><code>    server {
        listen 80;
        server_name <span>example.com</span>;
        return 301 http://www.<span>example.com</span>$request_uri;
    }
</code><code>    server {
        listen 80;
        server_name www.<span>example.com</span>;
        # остальные настройки сервера
    }</code></pre><p>Внутри нижнего блока sever размещаем следующие блоки location:</p><pre><code>    location /favicon.ico {
        alias <span>/home/user/myproject/</span>static/images/favicon.ico;
    }
</code><code>    location /static/ {
        root <span>/home/user/myproject;</span>
    }
</code><code>    location / {
        include proxy_params;
        proxy_pass http://unix:<span>/home/user/myproject/mysite</span>.sock;
    }</code></pre><p>Сохраняем и закрываем данный файл. Теперь мы можем включить данный файл связав его с директорией /sites-enabled:</p><pre><code>    sudo ln -s /etc/nginx/sites-available/<span>myproject</span> /etc/nginx/sites-enabled</code></pre><p>Проверяем конфигурацию Nginx на наличие синтаксических ошибок, введя:</p><pre><code>    sudo nginx -t</code></pre><p>Если ошибок не обнаружено, делаем рестарт  Nginx:</p><pre><code>    sudo service nginx restart</code></pre><p>Теперь мы можете обращаться к вашему приложению по доменному имени.</p><p>Надеюсь данное руководство принесло вам пользу. Дальше вам нужно будет уделить внимание оптимизации выполнения кода и защите сервера от несанкционированного доступа. Об установке и настройке стека Python + Pip + Virtualvenv + Django + PostgreSQL для разработки на Ubuntu 15.10 вы можете прочесть в следующей <a href="http://tiv.space/post/1/" rel="follow" title="Установка и настройка стека: Python, Pip, Virtualvenv, Django, PostgreSQL для разработки на Ubuntu 15.10.">статье</a> моего блога. Удачи.</p>
            </div>

            <p class="copyright">Copyright: Пожалуйста при копировании материалов с данного сайта не забывайте оставлять на своём ресурсе кликабельную ссылку с текстом: "Материал взят с сайта tiv.space".</p>

            </div></body></html>