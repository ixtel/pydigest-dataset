<html><body><div><div class="post-text" itemprop="text">

<p>I'm using a Python script (Mechanize) to login to a proxy portal. I can login successfully. I can check that from <code>read()</code> function. </p>

<p>However, after successful login, I couldn't access the blocked sites by the proxy. So I checked the HTTP headers from FF and found that <code>Connection: Keep-alive</code>. But from <code>mechanize</code>, I found <code>Connection: close</code>. I tried to imitate the HTTP header exactly as from FF using <code>browser.addheaders</code> but this didn't work as well :(</p>

<p>After deep digging, I found a couple of suggestions that the server closes the connection because mechanize can't totally emulate a browser as the webpage contains JS which is not supported by <code>mechanize</code></p>

<p><strong>So, is there a way to emulate (make the server feel) that mechanize is a browser (supports JS), even though it doesn't?</strong></p>

<p>BTW, I don't need JS, I can login successfully as I mentioned above. And please don't suggest PhantomJS. <em>I need a Python package to do the job not a headless browser.</em></p>

<p><strong>Update:</strong></p>

<p><strong>FireFox Headers:</strong></p>

<pre><code>GET xxx HTTP/1.1
Host: xxx
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:43.0) Gecko/20100101 Firefox/43.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Cookie: DSLastAccess=1454082611
Connection: keep-alive


HTTP/1.1 200 OK
Content-Type: text/html; charset=utf-8
Set-Cookie: DSEPAgentInstalled=; path=/; expires=Tue, 31-Jan-2006 16:18:32 GMT; secure
Date: Fri, 29 Jan 2016 16:18:32 GMT
x-frame-options: SAMEORIGIN
Connection: Keep-Alive
Keep-Alive: timeout=15
Pragma: no-cache
Cache-Control: no-store
Expires: -1
Transfer-Encoding: chunked
</code></pre>

<p><strong>Mechanize addheaders:</strong></p>

<pre><code>browser.addheaders = [('Accept', 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'),\
            ('Accept-Language', 'en-US,en;q=0.5'),\
            ('Accept-Encoding', 'gzip, deflate'),\
            ('Host', 'xxx.net'),\
            ('Connection','keep-alive'),\
            ('Cookie', 'DSLastAccess=1454082611'),\
            ('User-agent', 'Mozilla/5.0 (X11; Linux x86_64; rv:43.0) Gecko/20100101 Firefox/43.0')]
</code></pre>

<p><strong>Mechanize Headers</strong></p>

<pre><code>send: 'CONNECT xxx.net:443 HTTP/1.0\r\n'
send: '\r\n'
send: 'GET xxx.cgi HTTP/1.1\r\nAccept-Language: en-US,en;q=0.5\r\nAccept-Encoding: gzip, deflate\r\nHost: xxx.net\r\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\r\nUser-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:43.0) Gecko/20100101 Firefox/43.0\r\nConnection: close\r\nCookie: DSLastAccess=1454082611\r\n\r\n'
reply: 'HTTP/1.1 200 OK\r\n'
header: Content-Type: text/html; charset=utf-8
header: Set-Cookie: DSEPAgentInstalled=; path=/; expires=Tue, 31-Jan-2006 16:31:03 GMT; secure
header: Date: Fri, 29 Jan 2016 16:31:03 GMT
header: x-frame-options: SAMEORIGIN
header: Connection: close
header: Pragma: no-cache
header: Cache-Control: no-store
header: Expires: -1
</code></pre>

<p>Another thing that drives me crazy, that the sent <code>Connection</code> from <code>mechanize</code> is <code>: close</code> even though I've set it as <code>keep-alive</code> as you can see in <code>addheaders</code></p>
    </div>
    </div></body></html>