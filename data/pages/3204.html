<html><body><div><article class="markdown-body entry-content" itemprop="text"><h1><a id="user-content-log-to-postgresql" class="anchor" href="#log-to-postgresql" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Log to PostgreSQL</h1>
<a href="https://travis-ci.org/216software/logtopg"><img alt="https://travis-ci.org/216software/logtopg.svg?branch=master" src="https://camo.githubusercontent.com/4393f525ead48fa1d24e17ff0b1f454b2d2351e8/68747470733a2f2f7472617669732d63692e6f72672f323136736f6674776172652f6c6f67746f70672e7376673f6272616e63683d6d6173746572" data-canonical-src="https://travis-ci.org/216software/logtopg.svg?branch=master"/></a>
<a href="https://camo.githubusercontent.com/04531326f907cf05ef85254061867b689df11ac8/68747470733a2f2f636972636c6563692e636f6d2f67682f323136736f6674776172652f6c6f67746f70672e706e673f636972636c652d746f6b656e3d333839666565313632343935343162346231646636653861376638656462313430316265363664653a7461726765743a68747470733a2f2f636972636c6563692e636f6d2f67682f323136736f6674776172652f6c6f67746f7067" target="_blank"><img alt="https://circleci.com/gh/216software/logtopg.png?circle-token=389fee16249541b4b1df6e8a7f8edb1401be66de:target:https://circleci.com/gh/216software/logtopg" src="https://camo.githubusercontent.com/04531326f907cf05ef85254061867b689df11ac8/68747470733a2f2f636972636c6563692e636f6d2f67682f323136736f6674776172652f6c6f67746f70672e706e673f636972636c652d746f6b656e3d333839666565313632343935343162346231646636653861376638656462313430316265363664653a7461726765743a68747470733a2f2f636972636c6563692e636f6d2f67682f323136736f6674776172652f6c6f67746f7067" data-canonical-src="https://circleci.com/gh/216software/logtopg.png?circle-token=389fee16249541b4b1df6e8a7f8edb1401be66de:target:https://circleci.com/gh/216software/logtopg"/></a>
<a name="user-content-install"/>
<h2><a id="user-content-install" class="anchor" href="#install" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Install</h2>
<p>Grab the code with pip:</p>
<pre>$ pip install logtopg
</pre>
<p>But you also have to install the ltree contrib module into your
database:</p>
<pre>$ sudo -u postgres psql -c "create extension ltree;"
</pre>
<a name="user-content-try-it-out"/>
<h2><a id="user-content-try-it-out" class="anchor" href="#try-it-out" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Try it out</h2>
<p>The code in <a href="https://github.com/216software/logtopg/blob/master/docs/example.py">docs/example.py</a> shows how to set up your logging configs
with this handler.</p>
<a name="user-content-contribute-to-logtopg"/>
<h2><a id="user-content-contribute-to-logtopg" class="anchor" href="#contribute-to-logtopg" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Contribute to logtopg</h2>
<p>Get a copy of the code:</p>
<pre>$ git clone --origin github https://github.com/216software/logtopg.git
</pre>
<p>Install it like this:</p>
<pre>$ cd logtopg
$ pip install -e .
</pre>
<p>Create test user and test database:</p>
<pre>$ sudo -u postgres createuser logtopg
$ sudo -u postgres createdb --owner logtopg logtopg_tests
$ sudo -u postgres psql -c "create extension ltree;" -d logtopg_tests
</pre>
<p>Then run the tests like this:</p>
<pre>$ python setup.py --quiet test
.....
----------------------------------------------------------------------
Ran 5 tests in 0.379s

OK
</pre>
<p>Hopefully it works!</p>
<a name="user-content-stuff-to-do"/>
<h2><a id="user-content-stuff-to-do" class="anchor" href="#stuff-to-do" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Stuff to do</h2>
<ul>
<li><p>Fill out classifiers in setup.py.</p>
</li>
<li><p>Somehow block updates to the table.  Maybe a trigger is the right
way.  Maybe there's a much simpler trick that I'm not aware of.</p>
</li>
<li><p>Create a few views for typical queries.</p>
</li>
<li><p>Test performance with many connected processes and tons of logging
messages.  Make sure that logging doesn't compete with real
application work for database resources.  Is there a way to say
something like</p>
<blockquote>
<p>"Hey postgresql, take your time with this stuff, and deal with
other stuff first!"</p>
</blockquote>
<p>In other words, a "nice" command for queries.</p>
</li>
<li><p>Allow people to easily write their own SQL to create the logging
table and to insert records to it.  The queries could be returned
from properties, so people would just need to subclass the PGHandler
and then redefine those properties.</p>
</li>
<li><p>Write some documentation:</p>
<ul>
<li>installation</li>
<li>typical queries</li>
<li>tweak log table columns or indexes</li>
<li>discuss performance issues</li>
</ul>
</li>
<li><p>Set up a readthedocs page for logtopg for that documentation.</p>
</li>
<li><p>Experiment with what happens when the emit(...) function call takes
a long time.  For example, say somebody is logging to a PG server
across the internet, will calls to log.debug(...) slow down  the
local app?  I imagine so.</p>
</li>
<li><p>I just found out that the ltree column type (that I use for logger
names) can not handle logger names like "dazzle.insert-stuff".  That
dash in there is invalid syntax.</p>
<p>I hope there is a way to raise an exception as soon as somebody uses
an invalid logger name.</p>
<p>Or, maybe I need to convert the invalid name to a valid name, by
maybe substituting any of a set of characters with something else.</p>
</li>
<li><p>Set up table partitioning so that when there are millions or logs,
they are dealt with sanely.</p>
<p>This is a query that shows logs by day and log level:</p>
<pre>select to_char(date_trunc('day', inserted), 'YYYY-MM-DD'),
log_level, count(*)

from dazzlelogs

group by 1, 2

order by 1, 2;
</pre>
</li>
</ul>

</article>
  </div></body></html>