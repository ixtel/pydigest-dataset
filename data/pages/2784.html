<html><body><div><header class="entry-header">
<h1 class="entry-title">Python 2 on Windows: how to read command line arguments containing Unicode code points</h1>
<p class="bylinemod"><time class="entry-date updated" datetime="2014-02-14T03:06:52+00:00" pubdate="">February 14, 2014</time> — by Jan-Philip Gehrcke</p> </header> 
<div class="entry-content">
<p>While in the Unix world UTF-8 is the de-facto standard for terminal input and output encoding, the situation on Windows is a bit more complex. In general, Windows is even a step ahead compared to Unix systems: Unicode code points in command line arguments are supported natively when using cmd.exe or the Powershell. The Win 32 API has corresponding functions for retrieving such strings as native Unicode data types.</p>
<p>Python 2(.7), however, does not make use of these functions. Instead, it tries to read arguments as byte sequences. Characters not included in the 7-bit ASCII range end up as <code>?</code> in the byte strings in <code>sys.argv</code>.</p>
<p>Another issue might be that by default Python does not use UTF-8 for encoding characters in the stdout stream (for me, the default stdout encoding is the more limited code page cp437).</p>
<p>I don’t want to lose too many words now, there are quite reliable workarounds for both issues. Stdout encoding can be enforced with the <code>PYTHONIOENCODING</code> environment variable. <code>chcp 65001</code> sets the console code page to an UTF-8-alike encoding, so that special characters can be used as command line arguments in an UTF-8-encoded batch file, such as this <code>test.bat</code>:</p>
<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="text"><pre class="de1">@chcp 65001 &gt; nul
@set PYTHONIOENCODING=utf-8
python test.py ☺</pre></div></div></div></div></div></div></div>
<p>This is the Python script <code>test.py</code> for printing information about the retrieved command line arguments:</p>
<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="python"><pre class="de1"><span class="kw1">import</span> <span class="kw3">sys</span>
<span class="kw3">sys</span>.<span class="me1">argv</span> <span class="sy0">=</span> win32_unicode_argv<span class="br0">(</span><span class="br0">)</span>
<span class="kw1">print</span> <span class="kw3">repr</span><span class="br0">(</span><span class="kw3">sys</span>.<span class="me1">argv</span><span class="br0">)</span>
<span class="kw1">for</span> a <span class="kw1">in</span> <span class="kw3">sys</span>.<span class="me1">argv</span>:
    <span class="kw1">print</span><span class="br0">(</span>a.<span class="me1">encode</span><span class="br0">(</span><span class="kw3">sys</span>.<span class="me1">stdout</span>.<span class="me1">encoding</span><span class="br0">)</span><span class="br0">)</span></pre></div></div></div></div></div></div></div>
<p>Open a terminal (<code>cmd.exe</code>) and execute</p>

<p>Then have a look into the file <code>out</code> in which we just redirected the stdout stream of the Python script (tell your editor/file viewer to decode the file using UTF-8 and use a proper font having special glyphs!):</p>
<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="text"><pre class="de1">c:\&gt; python test.py ☺ 
[u'test.py', u'\u263a']
test.py
☺</pre></div></div></div></div></div></div></div>
<p>As you can see, the items in argv are unicode strings. This is the magic performed by the function <code>win32_unicode_argv()</code> which I will show below. When encoding these unicode strings to <code>sys.stdout.encoding</code> (which, in fact, is UTF-8 as of the environment variable <code>PYTHONIOENCODING</code>), the special Unicode code point ☺ becomes properly encoded.</p>
<p>All in all, using <code>chcp 65001 + PYTHONIOENCODING="utf-8" + win32_unicode_argv()</code>, we got a well-behaved information stream from the UTF-8-encoded input file <code>test.bat</code> to the UTF-8-encoded output file <code>out</code>.</p>
<p>This is <code>win32_unicode_argv()</code> which is making use of the ctypes module for using the Win 32 API functions that are provided by Windows for retrieving command line arguments as native Win 32 Unicode strings:</p>
<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="python"><pre class="de1"><span class="kw1">import</span> <span class="kw3">sys</span>
<span class="kw1">def</span> win32_unicode_argv<span class="br0">(</span><span class="br0">)</span>:
    <span class="co1"># Solution copied from http://stackoverflow.com/a/846931/145400</span>
 
    <span class="kw1">from</span> ctypes <span class="kw1">import</span> POINTER<span class="sy0">,</span> byref<span class="sy0">,</span> cdll<span class="sy0">,</span> c_int<span class="sy0">,</span> windll
    <span class="kw1">from</span> ctypes.<span class="me1">wintypes</span> <span class="kw1">import</span> LPCWSTR<span class="sy0">,</span> LPWSTR
 
    GetCommandLineW <span class="sy0">=</span> cdll.<span class="me1">kernel32</span>.<span class="me1">GetCommandLineW</span>
    GetCommandLineW.<span class="me1">argtypes</span> <span class="sy0">=</span> <span class="br0">[</span><span class="br0">]</span>
    GetCommandLineW.<span class="me1">restype</span> <span class="sy0">=</span> LPCWSTR
 
    CommandLineToArgvW <span class="sy0">=</span> windll.<span class="me1">shell32</span>.<span class="me1">CommandLineToArgvW</span>
    CommandLineToArgvW.<span class="me1">argtypes</span> <span class="sy0">=</span> <span class="br0">[</span>LPCWSTR<span class="sy0">,</span> POINTER<span class="br0">(</span>c_int<span class="br0">)</span><span class="br0">]</span>
    CommandLineToArgvW.<span class="me1">restype</span> <span class="sy0">=</span> POINTER<span class="br0">(</span>LPWSTR<span class="br0">)</span>
 
    <span class="kw3">cmd</span> <span class="sy0">=</span> GetCommandLineW<span class="br0">(</span><span class="br0">)</span>
    argc <span class="sy0">=</span> c_int<span class="br0">(</span><span class="nu0">0</span><span class="br0">)</span>
    argv <span class="sy0">=</span> CommandLineToArgvW<span class="br0">(</span><span class="kw3">cmd</span><span class="sy0">,</span> byref<span class="br0">(</span>argc<span class="br0">)</span><span class="br0">)</span>
    <span class="kw1">if</span> argc.<span class="me1">value</span> <span class="sy0">&gt;</span> <span class="nu0">0</span>:
        <span class="co1"># Remove Python executable and commands if present</span>
        start <span class="sy0">=</span> argc.<span class="me1">value</span> - <span class="kw2">len</span><span class="br0">(</span><span class="kw3">sys</span>.<span class="me1">argv</span><span class="br0">)</span>
        <span class="kw1">return</span> <span class="br0">[</span>argv<span class="br0">[</span>i<span class="br0">]</span> <span class="kw1">for</span> i <span class="kw1">in</span>
                <span class="kw2">xrange</span><span class="br0">(</span>start<span class="sy0">,</span> argc.<span class="me1">value</span><span class="br0">)</span><span class="br0">]</span></pre></div></div></div></div></div></div></div>
<p>Kudos to <a href="http://stackoverflow.com/a/846931/145400">http://stackoverflow.com/a/846931/145400</a>.</p>
 </div> 
</div></body></html>