<html><body><div><div class="content-body" itemprop="text articleBody">
	<div class="section" id="introduction">
<h2>Introduction</h2>
<p><a class="reference external" href="https://www.google.com/forms/about/">Google Forms</a> is a service that allows you to collect information via simple web
forms. One of the useful features is that the forms will automatically save your
data to a Google Sheet. This article will walk through how to create a form,
authenticate using OAuth 2 and read all the responses into a pandas dataframe.
Because the initial setup and authentication process is a little time consuming,
this article will be the first in a two part series.</p>
<p>Before going too far, if you would like to take the short survey, here is the
<a class="reference external" href="http://goo.gl/forms/64PCaQN0T2">link to the survey</a> we will discuss. Thanks in advance for filling it out!</p>
<p>Why would someone want to use pandas to read a Google Sheet? The key functionality
this setup provides is a simple way to allow a large number of people to provide
you information (don’t just think of a standard survey) and collect it all in a
single place. You can then analyze the data with the full power of python and
pandas. Google takes care of making sure that all the data gets consistently
entered into one clean format - no matter how many people access the form.</p>
<p>This blog has mentioned many times about how Excel can be a great tool but is
so often abused and made to do more than it really should. One use case I have
seen is creating a simple Excel-based form which someone sends to people to fill
out, then collate into a master spreadsheet. This process is extremely manual
and error prone. Google Forms is a possible alternative to the spreadsheet
wrangling you might do with Excel.</p>
<p>The other scenario is that sometimes you need a very simple <span class="caps">UI</span> to capture
information and act on it. Once you start to play around with Google Forms you
may realize that there are other uses for it outside of the standard survey process.</p>
</div>
<div class="section" id="overview">
<h2>Overview</h2>
<p>As they say, a picture is worth a thousand words; so here is what we’ll be doing
in this article:</p>

</div>
<div class="section" id="form-creation">
<h2>Form Creation</h2>
<p>The first part of the process is creating the Form. If you haven’t used Forms
before, go to <a class="reference external" href="https://www.google.com/forms/about/">Google Forms</a>  to learn more about the service and what it can
be used for.</p>
<p>Once you decide to create your form, you’ll be shown a screen similar to this:</p>

<p>Go ahead and create a Form. It is all fairly intuitive.</p>
<p>The main thing you need to pay attention to is the name of the form. In this
case - <strong>PBPython User Survey</strong>.</p>

<p>When you are ready, you can publish the survey by clicking on the Send form button.
Here is the <a class="reference external" href="http://goo.gl/forms/64PCaQN0T2">link to the survey</a> for this site.</p>
<p>Now that you have the basic form set up, it is ready to store your data in a
Google Sheet. The next step is setting up access so that your python script
can connect to Google and download the data.</p>
</div>
<div class="section" id="authentication">
<h2>Authentication</h2>
<p>In the good old days, you could authenticate with something as simple as an
email address and password. However, this simplicity was very unsecure so one
of the attempts to make a more secure process is <a class="reference external" href="http://oauth.net/2/">OAuth 2.0</a></p>
<p>I won’t go into the details of OAuth 2.0 but the basic summary is that it is an
open standared that defines a protoccol for granting access to resources. The
key here is that it is a protoccol so there are several steps in the process to
get it set up. The other bad news is that everyone tends to implement things
slightly differently so you need to understand each provider’s setup.
The good news is that once it is setup, it should run without further intervention
and it is more secure than the old username + password combo!</p>
<p>The basic steps we will follow are:</p>
<ul class="simple">
<li>Enable the <span class="caps">API</span></li>
<li>Create our credentials</li>
<li>Enable sharing of the sheet to our email address associated with the credentials</li>
</ul>
</div>
<div class="section" id="google-developer-console">
<h2>Google Developer Console</h2>
<p>The first step in getting authentication working is to enable our google drive <span class="caps">API</span>.</p>
<p>Google has many <span class="caps">API</span>’s available to you and the Developer’s Console allows you
to selectively turn on and off the various <span class="caps">API</span>’s. For our purposes, the
Drive <span class="caps">API</span> must be enabled.</p>
<p>Go to the <a class="reference external" href="https://console.developers.google.com/project">developers console</a> and create a project (or use an existing one).
Here is mine for Pbpython:</p>

<p>Once in your project, you need to enable to Google Drive <span class="caps">API</span>. You can search
the <span class="caps">API</span> library for Drive <span class="caps">API</span> and enable it:</p>

<p>Here is what it looks like when it is enabled:</p>

<p>Once the <span class="caps">API</span>’s are enabled, you need to create your credentials.</p>
<p>One quick aside on credentials: there are three options for the types of
credentials you can use:</p>
<ul class="simple">
<li><strong>Web Applications</strong></li>
<li><strong>Native Applications</strong></li>
<li><strong>Service account</strong></li>
</ul>
<p>The <strong>Web Application</strong> would be useful if you were building a web app (shocking) and the user
could interact with the site to enable access. The problem for our case is that
this application will be run from the command line so it will not be a good fit
for our solution.</p>
<p>The <strong>Native Application</strong> <span class="caps">ID</span> looks like it might be useful but when you dive into
it some more you will learn that it does not support the roles that we need; so
it does not work.</p>
<p>The <strong>Service account</strong> <span class="caps">ID</span> is meant to be used for these types of scripts so make
sure you create one and select the <span class="caps">JSON</span> key.</p>
<p>The first step is to click “Create new Client <span class="caps">ID</span>”:</p>

<p>Then Create a client <span class="caps">ID</span> for the Service account. Make sure to select <span class="caps">JSON</span> key
for the key type.</p>

<p>You will get a prompt to download the <span class="caps">JSON</span> key:</p>

<p>Make sure to save the <span class="caps">JSON</span> key
somewhere safe and not to check it into a public version control system!</p>
<p>Finally, here is what the Service Account screen looks like:</p>

<p>Keep track of the email address. You will need it in a bit.</p>
</div>
<div class="section" id="sharing-the-google-sheet">
<h2>Sharing the Google Sheet</h2>
<p>So now that you have your key, and have enabled your <span class="caps">API</span>, you need to
allow the google sheet to be accessed by the user specified in the
email address that was created for the service account.</p>
<p>Go into your drive and enable sharing of that response sheet to the email you
have listed.</p>
<p>From your <a class="reference external" href="https://drive.google.com">Google Drive</a>, find the response sheet. In this case,
<strong>PBPython User Survey (results)</strong> and right click on it:</p>

<p>You will need to share this with the email address from your Service Account email:</p>

<p>Click ok:</p>

<p>Go ahead and click ok. There is no one to send the invites to so you should be good.</p>
<p>Ok. That’s a lot of initial setup work. However, I hope that the steps I’ve laid out are
clear enough so that you won’t stumble through it as much as I did!</p>
</div>
<div class="section" id="python-libraries">
<h2>Python Libraries</h2>
<p>We will use to two python libraries to make the authentication and data extraction simple.</p>
<p>First install <a class="reference external" href="https://github.com/burnash/gspread">gspread</a></p>

<p>This library allows us to easily access, then read and write google sheets.
The authentication documentation I show above is heavily based on the <a class="reference external" href="http://gspread.readthedocs.org/en/latest/oauth2.html">gspread docs</a>.
You should check them out to learn all about the options available to you with
this app. We will only be using a very small portion for this exercise.</p>
<p>In order to use OAuth 2 authentication I will be using google’s <a class="reference external" href="https://github.com/google/oauth2client">oauth2client</a></p>

</div>
<div class="section" id="connect-to-google">
<h2>Connect to Google</h2>
<p>We are almost there!</p>
<p>The final two pieces of the puzzle are determining the scope we need access to
and what type of OAuth 2 flow we are using. Scopes are simply a way of managing
how much information you can have access to once you authenticate. In this example,
we need to make sure we have access to the following scope: </p><pre>
https://spreadsheets.google.com/feeds</pre>

<p>OAuth 2 has multiple types of authentication methods. I won’t go into the differences
between them but for the purposes of this script, we will used
<code class="code">
SignedJwtAssertionCredentials</code>
.</p>
<p>Don’t worry if this doesn’t make sense right now. You’ll use it in a second.
Now we will piece together the script.</p>
<p>Let’s setup our imports:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">gspread</span>
<span class="kn">from</span> <span class="nn">oauth2client.client</span> <span class="kn">import</span> <span class="n">SignedJwtAssertionCredentials</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">json</span>
</pre></div>
<p>As you can see, I’ve imported the <code class="code">
print_function</code>
 to keep this python 2/3
compatible as well as the <code class="code">
gspread</code>
 module and <code class="code">
SignedJwtAssertionCredentials</code>

as described above. I am also going to use the <code class="code">
json</code>
 module to read our secret file for
the authentication handshake.</p>
<p>The next step is to define a couple of variables:</p>
<div class="highlight"><pre><span class="n">SCOPE</span> <span class="o">=</span> <span class="p">[</span><span class="s">"https://spreadsheets.google.com/feeds"</span><span class="p">]</span>
<span class="n">SECRETS_FILE</span> <span class="o">=</span> <span class="s">"Pbpython-key.json"</span>
<span class="n">SPREADSHEET</span> <span class="o">=</span> <span class="s">"PBPython User Survey (Responses)"</span>
</pre></div>
<p>As mentioned earlier, you are required to pass the <code class="code">
SCOPE</code>
 when authenticating so just
know that this allows you to access and read a google sheet. The <code class="code">
SECRETS_FILE</code>

is the name of the json file you downloaded from the google developer console.
This script will assume that the file is in the same directory as your script.</p>
<p>The <code class="code">
SPREADSHEET</code>
 variable is the name of the google sheet where the results are stored.</p>
<p>Now that everything is set up, let’s authenticate to google by reading in our
json key and using <code class="code">
SignedJwtAssertionCredentials</code>
 :</p>
<div class="highlight"><pre><span class="n">json_key</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">SECRETS_FILE</span><span class="p">))</span>
<span class="c"># Authenticate using the signed key</span>
<span class="n">credentials</span> <span class="o">=</span> <span class="n">SignedJwtAssertionCredentials</span><span class="p">(</span><span class="n">json_key</span><span class="p">[</span><span class="s">'client_email'</span><span class="p">],</span>
                                            <span class="n">json_key</span><span class="p">[</span><span class="s">'private_key'</span><span class="p">],</span> <span class="n">SCOPE</span><span class="p">)</span>
</pre></div>
<p>It was a lot of work to get to these two lines of code but this is where the
authentication magic happens.</p>
<p>To recap those two lines, we read in the <code class="code">
SECRETS_FILE</code>
 which will look
something like this:</p>
<div class="highlight"><pre><span class="p">{</span>
  <span class="nt">"private_key_id"</span><span class="p">:</span> <span class="s2">"ABCXXX"</span><span class="p">,</span>
  <span class="nt">"private_key"</span><span class="p">:</span> <span class="s2">"-----BEGIN PRIVATE KEY-----\nXXXYY\n-----END PRIVATE KEY-----\n"</span><span class="p">,</span>
  <span class="nt">"client_email"</span><span class="p">:</span> <span class="s2">"YYYYYY@developer.gserviceaccount.com"</span><span class="p">,</span>
  <span class="nt">"client_id"</span><span class="p">:</span> <span class="s2">"1233XXXXX.apps.googleusercontent.com"</span><span class="p">,</span>
  <span class="nt">"type"</span><span class="p">:</span> <span class="s2">"service_account"</span>
<span class="p">}</span>
</pre></div>
<p>We take out the email, and private key, combine it with our scope and authenticate
to google. If all works, google will give us some valid credentials.</p>
<p>Once you have the credentials, you can authenticate with google sheets using
<code class="code">
gspread.authorize</code>
:</p>
<div class="highlight"><pre><span class="n">gc</span> <span class="o">=</span> <span class="n">gspread</span><span class="o">.</span><span class="n">authorize</span><span class="p">(</span><span class="n">credentials</span><span class="p">)</span>
</pre></div>
<p>If you want to see which sheets are available, this code will return all that
you can access:</p>
<div class="highlight"><pre><span class="k">print</span><span class="p">(</span><span class="s">"The following sheets are available"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">sheet</span> <span class="ow">in</span> <span class="n">gc</span><span class="o">.</span><span class="n">openall</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"{} - {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">sheet</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
</pre></div>
<p>Here is what it looks like for my site:</p>
<div class="highlight"><pre>The following sheets are available
PBPython User Survey <span class="o">(</span>Responses<span class="o">)</span> - 1QsZXXXXXXaPjEIhI
Test Form For PBPython <span class="o">(</span>Responses<span class="o">)</span> - 1mFMXXXXQyYnXeA
</pre></div>
<p>If you can not see any sheets here, make sure you have shared them to the
correct email.</p>
<p>To access our specific sheet:</p>
<div class="highlight"><pre><span class="n">workbook</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">SPREADSHEET</span><span class="p">)</span>
<span class="c"># Get the first sheet</span>
<span class="n">sheet</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">sheet1</span>
</pre></div>
<p>Once we have the sheet, it only takes one line to read it into a DataFrame and
use all the pandas power you are used to!</p>
<div class="highlight"><pre><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">get_all_records</span><span class="p">())</span>
</pre></div>
<p>After all that work, we’re now home free.</p>
</div>
<div class="section" id="simple-pandas-manipulation">
<h2>Simple Pandas Manipulation</h2>
<p>Once you get the data into your dataframe, you can do whatever you would like.
In the follow-on article, I will go through some more details but here are
two simple steps that will make further manipulation easier.</p>
<p>First, the column names are the full text of the question. Trying to work with
this would be highly painful. I recommend renaming all the columns to
shorter names. Here is how I did it with this example:</p>
<div class="highlight"><pre><span class="n">column_names</span> <span class="o">=</span> <span class="p">{</span><span class="s">'Timestamp'</span><span class="p">:</span> <span class="s">'timestamp'</span><span class="p">,</span>
                <span class="s">'What version of python would you like to see used for the examples on the site?'</span><span class="p">:</span> <span class="s">'version'</span><span class="p">,</span>
                <span class="s">'How useful is the content on practical business python?'</span><span class="p">:</span> <span class="s">'useful'</span><span class="p">,</span>
                <span class="s">'What suggestions do you have for future content?'</span><span class="p">:</span> <span class="s">'suggestions'</span><span class="p">,</span>
                <span class="s">'How frequently do you use the following tools? [Python]'</span><span class="p">:</span> <span class="s">'freq-py'</span><span class="p">,</span>
                <span class="s">'How frequently do you use the following tools? [SQL]'</span><span class="p">:</span> <span class="s">'freq-sql'</span><span class="p">,</span>
                <span class="s">'How frequently do you use the following tools? [R]'</span><span class="p">:</span> <span class="s">'freq-r'</span><span class="p">,</span>
                <span class="s">'How frequently do you use the following tools? [Javascript]'</span><span class="p">:</span> <span class="s">'freq-js'</span><span class="p">,</span>
                <span class="s">'How frequently do you use the following tools? [VBA]'</span><span class="p">:</span> <span class="s">'freq-vba'</span><span class="p">,</span>
                <span class="s">'How frequently do you use the following tools? [Ruby]'</span><span class="p">:</span> <span class="s">'freq-ruby'</span><span class="p">,</span>
                <span class="s">'Which OS do you use most frequently?'</span><span class="p">:</span> <span class="s">'os'</span><span class="p">,</span>
                <span class="s">'Which python distribution do you primarily use?'</span><span class="p">:</span> <span class="s">'distro'</span><span class="p">,</span>
                <span class="s">'How would you like to be notified about new articles on this site?'</span><span class="p">:</span> <span class="s">'notify'</span>
                <span class="p">}</span>
<span class="n">data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">column_names</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
<p>Finally, since we have timestamps, let’s convert the timestamp column to an
actual pandas time series:</p>
<div class="highlight"><pre><span class="n">data</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="full-code-example">
<h2>Full Code Example</h2>
<p>I know it has taken a while to get to the end of this article. While the steps
may seem a bit daunting, once you do it once, it will be simple to do it again
for future forms.</p>
<p>Speaking of forms, here is the <a class="reference external" href="http://goo.gl/forms/64PCaQN0T2">link to the survey</a> please take a moment to fill
it out. Having more data will make the survey that much more useful for the
next article.</p>
<p>Here is the complete code snippet. It is also available on <a class="reference external" href="https://github.com/chris1610/pbpython/blob/master/code/panda_gform.py">github</a>:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">gspread</span>
<span class="kn">from</span> <span class="nn">oauth2client.client</span> <span class="kn">import</span> <span class="n">SignedJwtAssertionCredentials</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="n">SCOPE</span> <span class="o">=</span> <span class="p">[</span><span class="s">"https://spreadsheets.google.com/feeds"</span><span class="p">]</span>
<span class="n">SECRETS_FILE</span> <span class="o">=</span> <span class="s">"Pbpython-key.json"</span>
<span class="n">SPREADSHEET</span> <span class="o">=</span> <span class="s">"PBPython User Survey (Responses)"</span>
<span class="c"># Based on docs here - http://gspread.readthedocs.org/en/latest/oauth2.html</span>
<span class="c"># Load in the secret JSON key (must be a service account)</span>
<span class="n">json_key</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">SECRETS_FILE</span><span class="p">))</span>
<span class="c"># Authenticate using the signed key</span>
<span class="n">credentials</span> <span class="o">=</span> <span class="n">SignedJwtAssertionCredentials</span><span class="p">(</span><span class="n">json_key</span><span class="p">[</span><span class="s">'client_email'</span><span class="p">],</span>
                                            <span class="n">json_key</span><span class="p">[</span><span class="s">'private_key'</span><span class="p">],</span> <span class="n">SCOPE</span><span class="p">)</span>

<span class="n">gc</span> <span class="o">=</span> <span class="n">gspread</span><span class="o">.</span><span class="n">authorize</span><span class="p">(</span><span class="n">credentials</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"The following sheets are available"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">sheet</span> <span class="ow">in</span> <span class="n">gc</span><span class="o">.</span><span class="n">openall</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"{} - {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">sheet</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
<span class="c"># Open up the workbook based on the spreadsheet name</span>
<span class="n">workbook</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">SPREADSHEET</span><span class="p">)</span>
<span class="c"># Get the first sheet</span>
<span class="n">sheet</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">sheet1</span>
<span class="c"># Extract all data into a dataframe</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">get_all_records</span><span class="p">())</span>
<span class="c"># Do some minor cleanups on the data</span>
<span class="c"># Rename the columns to make it easier to manipulate</span>
<span class="c"># The data comes in through a dictionary so we can not assume order stays the</span>
<span class="c"># same so must name each column</span>
<span class="n">column_names</span> <span class="o">=</span> <span class="p">{</span><span class="s">'Timestamp'</span><span class="p">:</span> <span class="s">'timestamp'</span><span class="p">,</span>
                <span class="s">'What version of python would you like to see used for the examples on the site?'</span><span class="p">:</span> <span class="s">'version'</span><span class="p">,</span>
                <span class="s">'How useful is the content on practical business python?'</span><span class="p">:</span> <span class="s">'useful'</span><span class="p">,</span>
                <span class="s">'What suggestions do you have for future content?'</span><span class="p">:</span> <span class="s">'suggestions'</span><span class="p">,</span>
                <span class="s">'How frequently do you use the following tools? [Python]'</span><span class="p">:</span> <span class="s">'freq-py'</span><span class="p">,</span>
                <span class="s">'How frequently do you use the following tools? [SQL]'</span><span class="p">:</span> <span class="s">'freq-sql'</span><span class="p">,</span>
                <span class="s">'How frequently do you use the following tools? [R]'</span><span class="p">:</span> <span class="s">'freq-r'</span><span class="p">,</span>
                <span class="s">'How frequently do you use the following tools? [Javascript]'</span><span class="p">:</span> <span class="s">'freq-js'</span><span class="p">,</span>
                <span class="s">'How frequently do you use the following tools? [VBA]'</span><span class="p">:</span> <span class="s">'freq-vba'</span><span class="p">,</span>
                <span class="s">'How frequently do you use the following tools? [Ruby]'</span><span class="p">:</span> <span class="s">'freq-ruby'</span><span class="p">,</span>
                <span class="s">'Which OS do you use most frequently?'</span><span class="p">:</span> <span class="s">'os'</span><span class="p">,</span>
                <span class="s">'Which python distribution do you primarily use?'</span><span class="p">:</span> <span class="s">'distro'</span><span class="p">,</span>
                <span class="s">'How would you like to be notified about new articles on this site?'</span><span class="p">:</span> <span class="s">'notify'</span>
                <span class="p">}</span>
<span class="n">data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">column_names</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</pre></div>
<p>Thank you for reading all the way to the end. I hope this is helpful to you and
I look forward to reviewing the survey results with you.</p>
</div>

  </div>
  
</div></body></html>