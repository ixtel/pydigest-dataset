<html><body><div><div class="blog-post-content">
    <p>At TrackMaven we are big users of <a href="http://www.celeryproject.org/">Celery</a>, an asynchronous task queue written in Python. Today we're happy to release a useful package we have been using internally called <a href="https://pypi.python.org/pypi/celery_once/">Celery Once!</a></p>
<p>Celery Once allows you to specify and run unique tasks across your distributed Celery cluster. It can be used to prevent workers performing the same task when scheduled multiple times.</p>
<h2>Example usage</h2>
<p>Imagine the scenario of generating and send a PDF report to a user.
On our web app, a user could kick off this task by submitting a form to a web server, which then triggers our Celery task.</p>
<p>If generating the report is slow and our user hits submit multiple times, we don't want to queue up additional repeated tasks that end up spamming the user's inbox.</p>
<p>Here is how we could solve the scenario using Celery Once!
After <a href="https://github.com/TrackMaven/celery-once#usage">setting up</a> <code>celery</code> with <code>celery_once</code> installed, we can write a mutually exclusive task, like so...</p>
<div class="highlight"><pre><span class="c"># tasks.py</span>
<span class="kn">import</span> <span class="nn">celery</span>
<span class="kn">from</span> <span class="nn">reports</span> <span class="kn">import</span> <span class="n">generate_report</span>
<span class="kn">from</span> <span class="nn">celery_once</span> <span class="kn">import</span> <span class="n">QueueOnce</span>

<span class="nd">@celery.task</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="n">QueueOnce</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">send_pdf_report</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
    <span class="n">report</span> <span class="o">=</span> <span class="n">generate_report</span><span class="p">()</span>
    <span class="n">report</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span>
</pre></div>


<p>Behind the scenes, <code>QueueOnce</code> uses <a href="http://redis.io">Redis</a> to <a href="https://github.com/TrackMaven/celery-once/blob/c7b8902a52ee727e4e68392887d905f1e436f7ef/celery_once/tasks.py#L98">check against or set a lock</a> based on the task's name and its arguments.</p>
<p>If we try to run the same task, while it's already queued, an <code>AlreadyQueued</code> exception is raised.</p>
<div class="highlight"><pre><span class="c"># Run the initial task, not yet queued up...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">send_pdf_report</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="s">"alice@example.com"</span><span class="p">)</span>
<span class="c"># Duplicate task run before previous one completes..</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">send_pdf_report</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="s">"alice@example.com"</span><span class="p">)</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
    <span class="o">..</span>
<span class="n">AlreadyQueued</span><span class="p">()</span>
<span class="c"># Running for a different user has its own lock</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">send_pdf_report</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="s">"bob@example.com"</span><span class="p">)</span>
</pre></div>


<p>That's Celery Once in a nutshell! More documentation on how to install, set up and tweak it to your needs can be found <a href="https://github.com/TrackMaven/celery-once">here</a>.</p>


    <p class="addthis_sharing_toolbox"/>
  </div>
  </div></body></html>