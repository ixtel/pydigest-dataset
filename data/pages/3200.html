<html><body><div><p>So you see, metaclasses allow you to customize almost every part of an object life-cycle.</p><div class="section" id="the-method-signatures"><h3>The method signatures<a class="headerlink" href="#the-method-signatures" title="Permalink to this headline"> *</a></h3><p>There are still few important details missing, like the method signatures. Lets look at class and metaclass with all the important stuff implemented.</p><p>Note the extra <tt class="docutils literal">**kwargs</tt> - those are the extra <em>keywords arguments</em> you can pass in the <tt class="docutils literal">class</tt> statement. <a class="footnote-reference" href="#python-3-class-kwargs" id="id30">[22]</a></p><div class="highlight"><pre><span/><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Meta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nd">@classmethod</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">__prepare__</span><span class="p">(</span><span class="n">mcs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">print</span><span class="p">(</span><span class="s1">'  Meta.__prepare__(mcs=</span><span class="si">%s</span><span class="s1">, name=</span><span class="si">%r</span><span class="s1">, bases=</span><span class="si">%s</span><span class="s1">, **</span><span class="si">%s</span><span class="s1">)'</span> <span class="o">%</span> <span class="p">(</span>
<span class="gp">... </span>            <span class="n">mcs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">kwargs</span>
<span class="gp">... </span>        <span class="p">))</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="p">{}</span>
</pre></div><p>As mentioned before, <tt class="docutils literal">__prepare__</tt> can return objects that are not <tt class="docutils literal">dict</tt> instances, so you need to make sure your <tt class="docutils literal">__new__</tt> handles that. <a class="footnote-reference" href="#dunder-prepare-ns-type" id="id31">[21]</a></p><div class="highlight"><pre><span/><span class="gp">... </span>    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">mcs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">print</span><span class="p">(</span><span class="s1">'  Meta.__new__(mcs=</span><span class="si">%s</span><span class="s1">, name=</span><span class="si">%r</span><span class="s1">, bases=</span><span class="si">%s</span><span class="s1">, attrs=[</span><span class="si">%s</span><span class="s1">], **</span><span class="si">%s</span><span class="s1">)'</span> <span class="o">%</span> <span class="p">(</span>
<span class="gp">... </span>            <span class="n">mcs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="s1">', '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">attrs</span><span class="p">),</span> <span class="n">kwargs</span>
<span class="gp">... </span>        <span class="p">))</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">mcs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
</pre></div><p>It's uncommon to see <tt class="docutils literal">__init__</tt> being implemented in a metaclass because it's not that powerful - the class is already constructed when <tt class="docutils literal">__init__</tt> is called. It roughly equates to having a <em>class decorator</em> with the difference that <tt class="docutils literal">__init__</tt> would get run when making subclasses, while <em>class decorators</em> are not called for subclasses.</p><div class="highlight"><pre><span/><span class="gp">... </span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">print</span><span class="p">(</span><span class="s1">'  Meta.__init__(cls=</span><span class="si">%s</span><span class="s1">, name=</span><span class="si">%r</span><span class="s1">, bases=</span><span class="si">%s</span><span class="s1">, attrs=[</span><span class="si">%s</span><span class="s1">], **</span><span class="si">%s</span><span class="s1">)'</span> <span class="o">%</span> <span class="p">(</span>
<span class="gp">... </span>            <span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="s1">', '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">attrs</span><span class="p">),</span> <span class="n">kwargs</span>
<span class="gp">... </span>        <span class="p">))</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
</pre></div><p>The <tt class="docutils literal">__call__</tt> method will be called when you make instances of <tt class="docutils literal">Class</tt>.</p><div class="highlight"><pre><span/><span class="gp">... </span>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">print</span><span class="p">(</span><span class="s1">'  Meta.__call__(cls=</span><span class="si">%s</span><span class="s1">, args=</span><span class="si">%s</span><span class="s1">, kwargs=</span><span class="si">%s</span><span class="s1">)'</span> <span class="o">%</span> <span class="p">(</span>
<span class="gp">... </span>            <span class="n">cls</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span>
<span class="gp">... </span>        <span class="p">))</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="gp">...</span>
</pre></div><p>Using <tt class="docutils literal">Meta</tt>, note the <tt class="docutils literal">extra=1</tt>: <a class="footnote-reference" href="#python-3-class-kwargs" id="id32">[22]</a></p><div class="highlight"><pre><span/><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Class</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">Meta</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">myarg</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">print</span><span class="p">(</span><span class="s1">'  Class.__new__(cls=</span><span class="si">%s</span><span class="s1">, myarg=</span><span class="si">%s</span><span class="s1">)'</span> <span class="o">%</span> <span class="p">(</span>
<span class="gp">... </span>            <span class="n">cls</span><span class="p">,</span> <span class="n">myarg</span>
<span class="gp">... </span>        <span class="p">))</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">myarg</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">print</span><span class="p">(</span><span class="s1">'  Class.__init__(self=</span><span class="si">%s</span><span class="s1">, myarg=</span><span class="si">%s</span><span class="s1">)'</span> <span class="o">%</span> <span class="p">(</span>
<span class="gp">... </span>            <span class="bp">self</span><span class="p">,</span> <span class="n">myarg</span>
<span class="gp">... </span>        <span class="p">))</span>
<span class="gp">... </span>        <span class="bp">self</span><span class="o">.</span><span class="n">myarg</span> <span class="o">=</span> <span class="n">myarg</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="s2">"&lt;instance of Class; myargs=</span><span class="si">%s</span><span class="s2">&gt;"</span> <span class="o">%</span> <span class="p">(</span>
<span class="gp">... </span>            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">'myarg'</span><span class="p">,</span> <span class="s1">'MISSING'</span><span class="p">),</span>
<span class="gp">... </span>        <span class="p">)</span>
<span class="go">  Meta.__prepare__(mcs=&lt;class '__main__.Meta'&gt;, name='Class', bases=(),</span>
<span class="go">                   **{'extra': 1})</span>
<span class="go">  Meta.__new__(mcs=&lt;class '__main__.Meta'&gt;, name='Class', bases=(),</span>
<span class="go">               attrs=[__qualname__, __new__, __init__, __str__, __module__],</span>
<span class="go">               **{'extra': 1})</span>
<span class="go">  Meta.__init__(cls=&lt;class '__main__.Class'&gt;, name='Class', bases=(),</span>
<span class="go">                attrs=[__qualname__, __new__, __init__, __str__, __module__],</span>
<span class="go">                **{'extra': 1})</span>
</pre></div><p>Note that <tt class="docutils literal">Meta.__call__</tt> is called when we make instance of <tt class="docutils literal">Class</tt>:</p><div class="highlight"><pre><span/><span class="gp">&gt;&gt;&gt; </span><span class="n">Class</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">  Meta.__call__(cls=&lt;class '__main__.Class'&gt;, args=(1,), kwargs={})</span>
<span class="go">  Class.__new__(cls=&lt;class '__main__.Class'&gt;, myarg=1)</span>
<span class="go">  Class.__init__(self=&lt;instance of Class; myargs=MISSING&gt;, myarg=1)</span>
<span class="go">&lt;instance of Class; myargs=1&gt;</span>
</pre></div></div></div></body></html>