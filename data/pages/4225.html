<html><body><div><div class="blog-entry-content">
        <p>
    In this post I want to have a look at the different possible solutions to two rather simple and closely related problems.  How to group objects into a dictionary, or count them. It something that at least I have found I do every now an then in various forms.  I want to start from the simplest good solution, and work towards better and faster solutions.  As always, the code can be downloaded of <a href="https://gist.github.com/codefisher/c33da67b6c7f84398cc1">gist.github.com</a>.
</p>

<p class="content-box">
<strong>Edit: Webucator who provides <a href="https://www.webucator.com/programming/python.cfm">Python training</a> courses, turned this post into a video.  You can go check it out at <a href="http://youtu.be/dt4JCYtc1dE">youtu.be/dt4JCYtc1dE</a>.</strong>
</p>

<h2>Grouping</h2>

<p>
    So the problem that we want to solve is that we have some items that we want to group according to some criteria. So in python that is going to be turning a list or some other iterable into a dictionary of lists.  We are also going to want some function to create the value we group by, and for the sake of simplicity we will use <code>len()</code> since that is the simplest built in function that gives a key we might group on.  In your own code, you would replace that with some logic that gives you the key or tag that you want to group things by.
</p>

<p>
    Or to put that all in pseudo code (also working python), that would be the following:
</p>

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s">'mark'</span><span class="p">,</span> <span class="s">'henry'</span><span class="p">,</span> <span class="s">'matthew'</span><span class="p">,</span> <span class="s">'paul'</span><span class="p">,</span>
         <span class="s">'luke'</span><span class="p">,</span> <span class="s">'robert'</span><span class="p">,</span> <span class="s">'joseph'</span><span class="p">,</span> <span class="s">'carl'</span><span class="p">,</span> <span class="s">'michael'</span><span class="p">]</span>

<span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
    <span class="n">key</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
        <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

<span class="c"># result: d = {4: ['mark', 'paul', 'luke', 'carl'], </span>
<span class="c">#              5: ['henry'], 6: ['robert', 'joseph'], 7: ['matthew', 'michael']}</span>
</pre></div>
</td></tr></table><p>
    So that is a nice start, loop over the data, create a key value for each.  Then we do a check to see if it already there or not.  This here is the best way to check if a key is in a dictionary.  The alternatives is either doing a <code>try except</code> around a key look up, which is really ugly and slow.  Or checking the return value of <code>d.get(key)</code>, but that prevents putting <code>None</code> values in the dictionary.  
</p>

<p>
There is a down side to this, and that is there the key has to be hashed two or three times (python dictionaries are internally a kind of hash map, that gives them their almost linear lookup time).  First in the if statement, and a possible second in the assignment to a empty <code>list()</code> and finally in the lookup for the append.  That python has to hash the value has an overhead. So how might we do better?  The following is one possible better solution.
</p>

<table class="highlighttable"><tr><td class="linenos"/><td class="code"><div class="highlight"><pre><span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
	<span class="n">key</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
	<span class="n">d</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</td></tr></table><p>
    This uses the <code>setdefault()</code> method.  This is a function, that even the developers of Python admit freely is confusingly named.  The problem is any descriptive alternatives look like <code>do_a_get_lookup_but_if_not_found_assign_the_second_argument()</code>.  So more or less, the same code as we wrote ourselves before, but since it is done by the dictionary itself, the key is only hashed once. It will be faster when we have lots of values.
</p>

<p>
    This is still not the best code that we could do, there is a nicer way.  It involves using a data structure called <code>defaultdict</code> that lives in the <code>collections</code> module.  If you have not checked out the collections module recently, I recommend you <a href="https://docs.python.org/3/library/collections.html">read its docs</a>, there are a number of very useful utilities in it. With that aside, <code>defaultdict</code> lets us create a dictionary like object that is different only in that if a lookup fails, it uses the argument passed to it during creation (in our case <code>list</code>) to fill that key in.  It lets us now write code like this:
</p>

<table class="highlighttable"><tr><td class="linenos"/><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
	<span class="n">key</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
	<span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</td></tr></table><p>
    So now we can just look up the key and append to it, not worrying about if it exists or not.  If it does not, the defaultdict will create the value for us.
</p>

<h2>Counting</h2>

<p>
    Now we have mastered grouping, counting should be simple.  We just have to know that <code>int()</code> when called returns the value <code>0</code>, so that can be passed to <code>defaultdict</code>.  So here we have:
</p>

<table class="highlighttable"><tr><td class="linenos"/><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
	<span class="n">key</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
	<span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
</td></tr></table><p>
    Here a common use case is not even to use a key, but to count just the number of times something appears.  In that case, we could do the following simplified version.
</p>

<table class="highlighttable"><tr><td class="linenos"/><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s">"mark"</span><span class="p">,</span> <span class="s">"john"</span><span class="p">,</span> <span class="s">"mark"</span><span class="p">,</span> <span class="s">"fred"</span><span class="p">,</span> <span class="s">"paul"</span><span class="p">,</span> <span class="s">"john"</span><span class="p">]</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
	<span class="n">d</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="c">#result: d = {'mark': 2, 'john': 2, 'fred': 1, 'paul': 1}</span>
</pre></div>
</td></tr></table><p>
    This was considered common enough that there is even a built in way to do this using <code>Counter</code>, so the above can be reduced to this.
</p>

<table class="highlighttable"><tr><td class="linenos"/><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s">"mark"</span><span class="p">,</span> <span class="s">"john"</span><span class="p">,</span> <span class="s">"mark"</span><span class="p">,</span> <span class="s">"fred"</span><span class="p">,</span> <span class="s">"paul"</span><span class="p">,</span> <span class="s">"john"</span><span class="p">]</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
</pre></div>
</td></tr></table><p>
    Counter comes with some nice little extras, such as being able to add, or subtract results.  So we could do something like the following.
</p>

<table class="highlighttable"><tr><td class="linenos"/><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="n">boys</span> <span class="o">=</span> <span class="p">[</span><span class="s">"mark"</span><span class="p">,</span> <span class="s">"john"</span><span class="p">,</span> <span class="s">"mark"</span><span class="p">,</span> <span class="s">"fred"</span><span class="p">,</span> <span class="s">"paul"</span><span class="p">,</span> <span class="s">"john"</span><span class="p">]</span>
<span class="n">girls</span> <span class="o">=</span> <span class="p">[</span><span class="s">"mary"</span><span class="p">,</span> <span class="s">"joan"</span><span class="p">,</span> <span class="s">"joan"</span><span class="p">,</span> <span class="s">"emma"</span><span class="p">,</span> <span class="s">"mary"</span><span class="p">]</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">boys</span><span class="p">)</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">girls</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">b</span> <span class="o">+</span> <span class="n">g</span>
<span class="c">#result: c = Counter({'mark': 2, 'joan': 2, 'john': 2, 'mary': 2, 'fred': 1, 'paul': 1, 'emma': 1})</span>
</pre></div>
</td></tr></table><p>
    But what happens if you want to use <code>Counter</code> but need to pass the result though some key function first?  How would you do it?  The solution would be to put a generator inside of it like the following.
</p>

<table class="highlighttable"><tr><td class="linenos"/><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s">'mark'</span><span class="p">,</span> <span class="s">'henry'</span><span class="p">,</span> <span class="s">'matthew'</span><span class="p">,</span> <span class="s">'paul'</span><span class="p">,</span>
         <span class="s">'luke'</span><span class="p">,</span> <span class="s">'robert'</span><span class="p">,</span> <span class="s">'joseph'</span><span class="p">,</span> <span class="s">'carl'</span><span class="p">,</span> <span class="s">'michael'</span><span class="p">]</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span>
</pre></div>
</td></tr></table><h2>Useful key functions</h2>

<p>
    Some possible common cases when grouping or counting, is you might want to do so based on some item in or attribute of the items you are grouping.  So for examples, your data might be a tuple of first and last names, or a dictionaries with first and last name keys, or a class with first and last name attributes.  If that is what you group or count by, there are two built in functions that can help do this, without needing to write our own functions.  Those are <code>itemgetter()</code> and <code>attrgetter</code> from the <code>operator</code> module.  Some examples might help.
</p>

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">itemgetter</span><span class="p">,</span> <span class="n">attrgetter</span>

<span class="c"># if names used tuples</span>
<span class="n">names</span> <span class="o">=</span> <span class="p">[(</span><span class="s">'mary'</span><span class="p">,</span> <span class="s">'smith'</span><span class="p">),</span> <span class="p">(</span><span class="s">'mark'</span><span class="p">,</span> <span class="s">'davis'</span><span class="p">)]</span>
<span class="c"># the last_name function would look like</span>
<span class="n">last_name</span> <span class="o">=</span> <span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c"># if names are dictionaries</span>
<span class="n">names</span> <span class="o">=</span> <span class="p">[{</span><span class="s">'first'</span><span class="p">:</span> <span class="s">'mary'</span><span class="p">,</span> <span class="s">'last'</span><span class="p">:</span><span class="s">'smith'</span><span class="p">),</span> <span class="p">(</span><span class="s">'first'</span><span class="p">:</span> <span class="s">'mark'</span><span class="p">,</span> <span class="s">'last'</span><span class="p">:</span> <span class="s">'davis'</span><span class="p">)]</span>
<span class="c"># the last_name function would look like</span>
<span class="n">last_name</span> <span class="o">=</span> <span class="n">itemgetter</span><span class="p">(</span><span class="s">'last'</span><span class="p">)</span>

<span class="c"># if names are classes with first and last as attributes</span>
<span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">Person</span><span class="p">(</span><span class="s">'mary'</span><span class="p">,</span> <span class="s">'smith'</span><span class="p">),</span> <span class="n">Person</span><span class="p">(</span><span class="s">'mark'</span><span class="p">,</span> <span class="s">'davis'</span><span class="p">)]</span>
<span class="c"># the last_name function would look like</span>
<span class="n">last_name</span> <span class="o">=</span> <span class="n">attrgetter</span><span class="p">(</span><span class="s">'last'</span><span class="p">)</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
	<span class="n">key</span> <span class="o">=</span> <span class="n">last_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
	<span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</td></tr></table><h2>Bonus</h2>

<p>
    When I was studying Software Engineering I got a job tutoring for the first year programming course, which was in python and had 200-300 students depending on semester (hence the need for tutors to help with questions during practicals).  One the challengers some of more curious students used to ask, is how I would do certain things in one line (I ended up doing their whole first in a single 1500 character line).  Often really bad code, but also often rather interesting trying to reduce a problem to a single statement.  I had a shot at doing it for this, and this was the solution that I came up with in a few minutes.  I leave working out how it works as an exercise to the reader.  I would never use it in production code.
</p>

<table class="highlighttable"><tr><td class="linenos"/><td class="code"><div class="highlight"><pre><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s">'mark'</span><span class="p">,</span> <span class="s">'henry'</span><span class="p">,</span> <span class="s">'matthew'</span><span class="p">,</span> <span class="s">'paul'</span><span class="p">,</span>
         <span class="s">'luke'</span><span class="p">,</span> <span class="s">'robert'</span><span class="p">,</span> <span class="s">'joseph'</span><span class="p">,</span> <span class="s">'carl'</span><span class="p">,</span> <span class="s">'michael'</span><span class="p">]</span>
<span class="c"># len is our 'key' function here</span>
<span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span> 
     <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="nb">sorted</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">names</span><span class="p">),</span> 
     <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">))}</span>
</pre></div>
</td></tr></table>
    </div>
    </div></body></html>