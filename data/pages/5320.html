<html><body><div><div class="content html_format"><p>
      Проблемой распознавания котов на изображениях нельзя пренебрегать. Как вариант, для её решения можно создать и обучить свой собственный классификатор, для чего потребуются десятки тысяч пушистых фотографий и несколько месяцев работы по подготовке набора данных и, собственно, само обучение. Жаль только, что готового классификатора, обученного именно на котов, на просторах сети найти не удалось.</p>
<p>
Да и вообще, можно ли создать сервис, уверенно распознающий котов с учётом присущего последним стремления принять самую неожиданную позу? Давайте попробуем.

</p><img src="https://habrastorage.org/files/0f0/f80/8b5/0f0f808b5b4d42ebb609ea76d43d4f3e.jpg"/>
<a name="habracut"/><p>
Для решения поставленной задачи была выбрана PaaS-платформа </p><b><a href="http://bluemix.net/">IBM Bluemix</a></b><p>, которая объединяет около сотни различных сервисов на все случаи жизни. Там есть отдельная группа Watson, содержащая различные инструменты для решения задач когнитивных вычислений – очень похоже на то, что нам нужно.
</p><p>
Среди сервисов Watson обнаружилось нечто под названием AlchemyAPI, что, в свою очередь, выглядит как универсальный набор когнитивного алхимика, представленный в виде унифицированных REST API. И там есть API для Image Tagging. API очень простой. Просто передаём ему изображение либо в виде файла, либо в виде URL, а он возвращает JSON c набором тегов и коэффициентов релевантности. То есть всё, что нужно будет сделать, это написать небольшой сервис, который будет получать файл с картинкой, отправлять его AlchemyAPI и говорить нам, что в результате получилось. 
</p><p>
Разработка была на питоне, в качестве HTTP-сервера взяли Tornado. В принципе, можно взять любой другой, просто к Tornado я привык и на нём все получается просто и быстро. 
</p><p>
Теперь нам нужно создать условия для разработки нашего приложения. Сделаем это таким образом, чтобы писать и отлаживать код можно было на своём компьютере, а затем перенести то, что получилось в облако Bluemix не внося никаких дополнительных изменении. 

</p><img src="https://habrastorage.org/getpro/habr/post_images/a4c/150/34c/a4c15034cc652871a5937a3702197a81.png"/>
<p>
Начнем с того, что создадим под нашим аккаунтом на Bluemix рабочую среду на питоне. Если у вас ещё нет аккаунта, зарегистрируйтесь – это быстро, бесплатно и без СМС. Идём в раздел </p><b>Dashboard</b><p> и нажимаем </p><b>Create App</b><p>, затем выбираем тип приложения </p><b>Web</b><p> и получаем список доступных сред для работы нашего сервиса (нам нужен Python). Добавляем сервису имя (я назвал его catreco) и где-то через полминуты вы увидите, что среда создана, и там находится Hello World посмотреть на который можно по ссылке </p><a href="http://catreco.mybluemix.net/">http://catreco.mybluemix.net</a><p>. 

</p><img src="https://habrastorage.org/getpro/habr/post_images/0cf/73c/749/0cf73c749f8bfef93d4053ab4cbee7fb.png"/>
<p>
Теперь пора заняться делом. Bluemix предлагает два способа сихронизации рабочей среды между локальным компьютером и облаком: интерфейс командной строки CF и привычный большинству из нас GIT, который мы и выберем. В меню слева нажимаем на  Overview и попадаем на страницу нашего приложения. Нажимаем кнопку </p><b>Add GIT</b><p> и у нас появляется GIT URL, указывающий на только что созданный репозиторий, содержащий Hello World. 
</p><p>
Сам по себе Hello World мало интересен, однако, репозиторий содержит несколько полезных файлов, необходимых для развертывания нашего приложения в облаке.

</p><img src="https://habrastorage.org/getpro/habr/post_images/481/5e7/9d0/4815e79d0243b842a4ed9c6b14ef4236.png"/>
<p>
Склонируем этот репозиторий на наш компьютер:

</p><pre><code>git clone &lt;адрес репозитория&gt;</code></pre><p>
Нам понадобятся следующие файлы (остальное можно удалить):

</p><pre><code>manifest.yml,
Procfile,
requirements.txt.</code></pre><p>
Теперь дело за нашим сервисом-распознавателем. Его код я выложил </p><a href="https://github.com/SSoldatov/catreco.git">сюда</a><p>. Загрузите его на свой компьютер и скопируйте содержимое в папку catreco. В самом коде нет ничего заслуживающего особого внимания – лишь несколько десятков строк, поэтому я не буду его подробно комментировать. Хотя и есть несколько нюансов. 

</p><img src="https://habrastorage.org/getpro/habr/post_images/ea9/181/764/ea91817646bdfe4c9aaf69f217e54b46.png" align="left"/><p> Во-первых, нужно подключить сервис AlchemyAPI, для чего возвращаемся на Bluemix в раздел </p><b>Dashboard</b><p> и нажимаем кнопку </p><b>Use Services or APIs, </b><p>а затем выбираем сервис AlchemyAPI. На странице конфигурации сервиса указано, что нужно создать аккаунт на самом AlchemyAPI – заходим по ссылке, создаём аккаунт и получаем на почту ключ. Этот ключ нужно скопировать в переменную APIKEY в файле webserver.py. На этом конфигурацию сервиса можно считать законченной.
</p><p>
Во-вторых, при запуске HTTP-сервера в своей рабочей среде Bluemix использует специальный порт, отличный от 80-го и уже затем, с помощью внутренних механизмов маршрутизации, позволяет вам обращаться к вашему приложению по 80 порту. Нужно это предусмотреть в коде сервера webserver.py:

</p><pre><code>PORT = int(os.getenv('VCAP_APP_PORT', 8080))

…

application.listen(PORT)</code></pre>  <p>
То есть если мы находимся в среде Bluemix, то сервер будет запущен по порту, содержащемуся в переменной 'VCAP_APP_PORT', а с локальной машины по порту 8080 или тому, который будет удобен. В большинстве случаев, это единственная специфическая настройка, которую вам нужно предусмотреть при переносе вашего кода в среду Bluemix. 
</p><p>
В третьих, нужно подготовить среду на Bluemix к запуску нашего приложения. В данный момент там есть только python 2.7.8 и стандартные библиотеки, а нам нужно ещё установить Tornado и модуль requests, объяснить Bluemix какой файл должен быть запущен. За это и отвечают файлы, которые мы забрали из Hello World. 
</p><p>
Файл manifest.yml содержит конфигурацию нашей рабочей среды. Здесь мы ничего менять не будем:

</p><pre><code>applications:
- disk_quota: 1024M
  host: catreco
  name: catreco
  path: .
  domain: mybluemix.net
  instances: 1
  memory: 128M</code></pre><p>
Файл Procfile содержит информацию о том, какой командой запускать наше приложение. Наш исполняемый файл называется webserver.py, поэтому пишем:

</p><pre><code>web: python webserver.py</code></pre><p>
Файл requirements.txt содержит список модулей, которые должны быть установлены в рабочей среде. Увидев этот список, Bluemix запустит pip и установит всё необходимое: 

</p><pre><code>tornado&gt;=4.0
requests&gt;=2.7</code></pre><p>
На этом подготовка закончена. Мы сконфигурировали внешний сервис AlchemyAPI, учли особенности среды Bluemix при запуске HTTP-сервера и задали необходимые параметры для развёртывания нашего приложения в облаке. 

</p><img src="https://habrastorage.org/files/53b/228/046/53b228046df24417b2f716a9fcd668ba.jpg"/>
<p>
Попробовать запустить приложение можно на локальной машине, для чего в командной строке пишем python webserver.py и набираем в браузере заветный localhost:8080

</p><img src="https://habrastorage.org/files/f44/141/649/f441416490af4d2f99addcc1a7702fd0.png"/>
<p>
То есть то, что лежит у меня на коленях, является котом с вероятностью 91%. Я пробовал другие ракурсы, брал картинки из сети – работает! Так что дело за малым – перенестись в облака. В папке, куда мы сначала склонировали Hello World, а затем разместили код нашего проекта, уже есть всё необходимое – дальще просто обновляем локальный репозиторий:

</p><pre><code>git add .
git commit –m "first deployment"</code></pre><p>
И отправляем его обратно на Bluemix:

</p><pre><code>git push</code></pre>

<img src="https://habrastorage.org/getpro/habr/post_images/de5/082/393/de508239367de7b55f1d628ad00f5f61.png"/>
<p>
Bluemix проделает все необходимые операции по сборке нового приложения (вместо Hello World теперь будет наш код) и запустит его. Как только статус нашего приложения станет </p><b>Your app is running</b><p>, можно пойти по ссылке  </p><a href="http://catreco.mybluemix.net/">http://catreco.mybluemix.net/</a><p> и убедиться, что наш сервис работает в облаке, его можно попробовать с любого устройства. Красивый плагин для загрузки файлов взят</p><a href="http://plugins.krajee.com/file-input"> отсюда</a><p>.
</p><p>
Примеры работы:
</p><p>
Cat — 94%
</p><img src="https://habrastorage.org/files/a93/7bf/4d1/a937bf4d1df74c4ca835bb5d998d875b.jpg"/>
<p>
Cat — 48%, pet — 63%
</p><img src="https://habrastorage.org/files/4b9/9c2/c77/4b99c2c77f9b47c0bf6c7ac0d55d317b.jpg"/>
<p>
Cat — 89%, rabbit — 80%
</p><img src="https://habrastorage.org/files/0f0/f80/8b5/0f0f808b5b4d42ebb609ea76d43d4f3e.jpg"/>
<p>
Cat — 99%, kitten — 50%
</p><img src="https://habrastorage.org/files/211/992/947/211992947c4641579384b108c2e744be.jpg"/>
<p>
Cat — 71%, dog — 59%
</p><img src="https://habrastorage.org/files/b3a/246/dec/b3a246dec5fa4c41bb7186be728cadd7.jpg"/>
<p>
Предыдущая картинка похожа на тигра, при этом: tiger — 99%, cat — 75%

</p><img src="https://habrastorage.org/files/88c/0e4/1a7/88c0e41a7a3e4d508dfc1872e29556c3.jpg"/>
<p>
Dog — 99%, puppy — 68%
</p><img src="https://habrastorage.org/files/fde/eb8/b79/fdeeb8b797a84d4a95caa5fb3991d645.jpg"/>
<p>
Dog — 99%
</p><img src="https://habrastorage.org/files/8ef/010/177/8ef0101770324ba290e110d86b4df701.jpg"/>
<p>
Cat — 99%, dog — 57%
</p><img src="https://habrastorage.org/files/f2a/c0b/e0e/f2ac0be0eed2457187e87a22814a4c72.jpg"/>
<p>
Cat: 99%
</p><img src="https://habrastorage.org/files/fca/250/36c/fca25036cb4a4869b82fae84b82d7cb9.jpg"/>
<p>
Cat — 65%, eagle — 43%
</p><img src="https://habrastorage.org/files/f01/d07/216/f01d07216ddc4a4e9e03a3dcfa81affc.jpg"/>
<p>
Если вы где-то ошиблись и что-то пошло не так – don’t panic. Над статусом вашего приложения на панели Bluemix есть волшебная кнопка </p><b>Edit Code</b><p>, нажатие которой перенесёт вас в сервис DevOps, где есть редактор кода, средства управления репозиторием и построением билдов, а также доступ ко всем логам. Сервис большой и его описание займёт больше времени, чем весь наш проект – если и потребуется, то обратитесь к </p><a href="https://www.ng.bluemix.net/docs/#services/DeliveryPipeline/index.html">документации</a><p>.
</p><p>
Вместо вывода:
</p><ol>
<li>Мы научились распознавать котов с помощью простого веб-приложения и сервиса, предоставляемого платформой Bluemix;<br/>
</li>
<li>Мы теперь знаем, как подготовить приложение для размещения в облаке Bluemix и как, собственно, разместить его с помощью одной команды git;<br/>
</li>
<li>Мы знаем куда смотреть если что-то пошло не так;<br/>
</li>
<li>Как вы уже поняли, дело может не ограничиваться только лишь котами.<br/>
</li>
</ol>
<img src="https://habrastorage.org/files/5cd/491/238/5cd49123846c43e3bf30e12c5ce3eed6.jpg"/>
<p>
По-моему, неплохо для одного дождливого утра? Расчехляйте папки с котиками, </p><a href="http://catreco.mybluemix.net/">пробуйте</a><p>. Котики, мотайте на ус, как теперь лучше маскироваться.
</p><p>
UPD:</p><p>
Сервисы от пользователей (если вдруг кончился лимит):

</p><a href="http://habrahabr.ru/users/le_den/" class="user_link">le_den</a> <a href="http://catreco.eu-gb.mybluemix.net">catreco.eu-gb.mybluemix.net </a>

<a href="http://habrahabr.ru/users/inwardik/" class="user_link">inwardik</a> <a href="http://rcat.mybluemix.net/">rcat.mybluemix.net</a><p>
Петр П. (аккаунта нет, скинул в ВК) </p><a href="http://2catreco.mybluemix.net/">2catreco.mybluemix.net</a>
<p>
Спасибо вам, что не остались в стороне :) Проблема распознавания котов действительно очень важна.

      
      </p><p class="clear"/>
    </div>

    
  </div></body></html>