<html><body><div><article class="col-md-10 col-md-offset-1">
            


<p>Do you ever feel like your SQL scripts are a bit repetitive? Now that Yhat has been around for
a while, we actually have a decent amount of data to report on. Recently, I've been finding my
SQL scripts for reporting our key metrics getting more and more ridiculous (I had one query that
had 16 <code>UNION ALL</code> statements in it).</p>
<p>So to combat my ugly reports, we've added templating features to <a href="https://github.com/yhat/db.py">db.py</a>!--in particular, <a href="https://github.com/wbond/pybars3">Handlebars</a>.</p>
<p>Don't know what templating or Handlebars is? No need to worry. In this post I'll outline why building templates 
is a great way to help eliminate SQL headaches and show you the basics of Handlebars.</p>
<p/><center>
    <img src="../static/img/sql.png"/>
    <img src="../static/img/heart.png"/>
    <img src="../static/img/handlebars-logo.png"/>
</center>
<h3>Handlebars comes to town</h3>
<p><a href="http://handlebarsjs.com/">Handlebars</a> is a templating framework. It let's you write one
"base template" (for instance, the header and footer of a web page) that can be re-used by
other pages. So if you need to make a change to your site's footer, you only have to change
1 template instead of making an edit to every single page.</p>
<p>But templating isn't just something that should be relegated to Rails apps or
MVC frameworks. How many SQL scripts have you written that contain those same 20-30
lines in them? Why can't take the same principles from building web pages and apply 
them to SQL scripts.</p>
<p><img alt="" src="../static/img/rollie-fingers.jpg"/>
</p><center>Rollie Fingers, former Oakland A and handlebar mustache aficionado.</center>
<h3>Why you will love this</h3>
<p>If you have ever written a SQL script that looks like the one below, then you need to stop what you're doing
and install <code>db.py</code>.</p>


<p>We can turn that into this:</p>


<p>Hopefully the line count on those files alone is enough to sell you. Let's dig into the details and really get cranking.</p>
<h3>The Basics</h3>
<p>If you haven't already, upgrade to the latest <code>db.py</code> (<code>pip install -U db.py</code>).</p>
<p>Ok, now you're ready to get started. Handlebars + SQL (hereafter called HBSQL) let's you
write scripts that look a lot like regular SQL scripts, but have special properties that allow
you to embed expressions into them.</p>
<p>Take the following script for instance. The <code>{{ &lt;variable name&gt;  }}</code> tags
are placeholders for variables you'd like to include in your script.</p>


<p>When we pass in variables into the <code>data</code> argument, the variables are automatically inserted into
our script.</p>
<p>Ok variables are pretty trivial (not much different form <a href="https://docs.python.org/2/library/string.html">string formatting in Python</a>). But 
what if we had variables that were more complex than letters or numbers.</p>
<p>For example, let's write a query that counts the number of rows in a list of tables. For each
table name in the list, we're going to represent it as <code>{{ .  }}</code> in
our HBSQL query. the <code>{{ .  }}</code> serves as a placeholder for each
item in the list. </p>
<p>What happens next is the good part. Pass in your query along with the list
to db.py's query function. <code>db.py</code> will generate 3 SQL queries (one
for each item in my <code>data</code> list) and execute them independently. Once they've
completed, it will combine them into 1 data frame.</p>


<h3>Ending the UNION ALL blues</h3>
<p>Let's try a more complex example. In this query, I'm calculating the amount spent on a per
country basis for my fictional company. In addition, I have some custom filters setup for
each country to exclude the bottom 20% of transactions.</p>
<p>I can actually store my variables in a CSV file and then merge them into my HBSQL template
using <code>pandas</code>. This will make it super easy to add countries and modify the query even when exchange rates change.
It also let's a non-technical person update my report without interrupting my work flow.</p>
<p>These are both pretty reasonable asks by a superior when it comes
to building a report. Unfortunately if your data infrastructure isn't setup 
properly (which is typically the case), this report is a huge pain to produce.</p>
<p>Using HBSQL takes a SQL script that <strong><a href="https://gist.github.com/glamp/41069318da798b24ca7e">would be 160 lines</a>, and turns it into 16 lines of 
code</strong>. Not too shabby.</p>
<p>My threshold is dependent upon the country (for instance, maybe it's based on 
exchange rate). I could either have 10 different SQL select statements doing 
a <code>UNION ALL</code>, have a giant, nasty <code>WHERE</code> clause/<code>CASE</code> statement 
combo, or could use a template. I think you can guess what I'm going to do.</p>


<p/><center><a href="https://gist.github.com/glamp/c8c2b894c84a6b11ee71/">Full code snippets here</a></center>
<h3>Final Thoughts</h3>
<p>For more on Handlebars, <a href="http://handlebarsjs.com/">check out the docs</a>. It's language agnostic, so 
javascript documentation works just as well.</p>
<p>There's also an <a href="https://www.my2ndgeneration.com/TemplateLanguageDoc.aspx">interesting paid product</a> that actually implements helper functions using SQL/Handlebars. 
Hopefully we'll have helper functions in the 0.5 release ;).</p>

        </article>
    </div></body></html>