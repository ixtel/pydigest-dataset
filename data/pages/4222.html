<html><body><div><div class="col-lg-8 col-md-8 col-sm-12">
            <p>Securing data is hard. The methods are scattered. The vulnerabilities are a nightmare.</p>

<p>Enter Python’s <a href="https://cryptography.io/en/latest/">cryptography module</a>.</p>

<p>This post will focus on <a href="https://cryptography.io/en/latest/fernet/">Fernet</a> within the <a href="https://cryptography.io/en/latest/">cryptography module</a>. Cryptography’s Fernet classes enable us to quickly and easily setup symmetric encryption with just a few lines of code.</p>

<p>The Fernet class’s API is extremely simple. Fernet has one <code>classmethod</code> called <code>generate_key()</code> and two instance methods <code>encrypt(plaintext_binary)</code> and <code>decrypt(cipher_binary)</code>.</p>

<h5>The Setup</h5>

<p>Generate a key and save it to the OS’s environment variables:</p>
<pre class="highlight python"><code>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">cryptography.fernet</span> <span class="kn">import</span> <span class="n">Fernet</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">key</span> <span class="o">=</span> <span class="n">Fernet</span><span class="o">.</span><span class="n">generate_key</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">key</span>
<span class="s">'BP04_l7C3wByNiEaEiseNiP0ZrqZ7s3qL-mkG8eHlJY='</span>

</code></pre>

<p>This is an example key. The key generated here should be saved in a secure place. Keep it secret. Keep it safe.</p>

<p>Add the key to your environment variables:</p>
<pre class="highlight shell"><code><span class="gp">$ </span><span class="nv">SECRET_FERNET_KEY</span><span class="o">=</span><span class="s1">'BP04_l7C3wByNiEaEiseNiP0ZrqZ7s3qL-mkG8eHlJY='</span>
</code></pre>

<p>Keeping secrets as environment variables is a more secure alternative than putting them into source control. It’s not fool proof, though. Be aware of the <a href="http://stackoverflow.com/questions/12461484/is-it-secure-to-store-passwords-as-environment-variables-rather-than-as-plain-t">risks and best practices</a> and make sure to research the a method that works best for your use case..</p>

<h5>The Functions</h5>
<pre class="highlight python"><code>
<span class="kn">from</span> <span class="nn">cryptography.fernet</span> <span class="kn">import</span> <span class="n">Fernet</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">crypto</span> <span class="o">=</span> <span class="n">Fernet</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'SECRET_FERNET_KEY'</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">plain_text</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plain_text</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="n">string_text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">plain_text</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">crypto</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">string_text</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">'Only strings are allowed.'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">cipher_text</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">crypto</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">cipher_text</span><span class="p">)</span>

</code></pre>

<p>The above functions are abstractions around the Fernet instance object. The reason for enforcing strings as input to the <code>encrypt</code> function is that the <code>decrypt</code> method of the Fernet instance object (<code>crypto</code> in this case) will only ever return strings and having a consistent API for input and output is important for avoiding incorrect type issues.</p>

<h5>Try It Out</h5>
<pre class="highlight python"><code>
<span class="n">encrypted_spoiler</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="s">'Snape kills Dumbledore.'</span><span class="p">)</span>
<span class="k">print</span> <span class="n">encrypted_spoiler</span>
<span class="c"># gAAAAABVLTmsBrJWKMzjn4pDlRwtk1j3TFcF1lrRlXo8_ASbR42vEiAcagNK</span>
<span class="c"># R3cqp6ypSdPPyMozGi2T10pxqKISxwVYqMqoEIaScr310glx55vUk_l6eLc=</span>


<span class="n">plaintext_spoiler</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">encrypted_spoiler</span><span class="p">)</span>
<span class="k">print</span> <span class="n">plaintext_spoiler</span>
<span class="c"># Snape kills Dumbledore.</span>

</code></pre>

<p>That’s all for now. Next time I hope to outline the use of some of SQLAlchemy’s advanced features to use these functions to easily persist secure data to a database.</p>

          </div>
          </div></body></html>