<html><body><div><div class="entry-content">
		<h1>Non-crashing Python 3.x output in Windows</h1>
<h2>Problem</h2>
<p>The following little Python 3.x program just <b><i>crashes</i></b> with CPython 3.3.4 in a default-configured English Windows:</p>
<p><i>crash.py3</i></p>
<pre class="brush: python; title: ; notranslate" title="">
#encoding=utf-8
print( "Blåbærsyltetøy!")
</pre>
<pre>H:\personal\web\blog alf on programming at wordpress\001\test&gt;<b><i>chcp 437</i></b>
Active code page: 437

H:\personal\web\blog alf on programming at wordpress\001\test&gt;<b><i>type crash.py3 | display_utf8</i></b>
<b>#encoding=utf-8
print( "Blåbærsyltetøy!")</b>

H:\personal\web\blog alf on programming at wordpress\001\test&gt;<b><i>crash.py3</i></b>
Traceback (most recent call last):
  File "H:\personal\web\blog alf on programming at wordpress\001\test\crash.py3", line 2, in 
    print( "Blåbærsyltet\xf8y!")
  File "C:\Program Files\CPython 3_3_4\lib\encodings\cp437.py", line 19, in encode
    return codecs.charmap_encode(input,self.errors,encoding_map)[0]
UnicodeEncodeError: 'charmap' codec can't encode character '\xf8' in position 12: character maps to 

H:\personal\web\blog alf on programming at wordpress\001\test&gt;_
</pre>
<p>Here codepage 437 is the original IBM PC character set, which is the default narrow text interpretation in an English Windows console window.</p>
<p>A partial solution is to change the default console codepage to Windows ANSI, which then at least for CPython matches the encoding for output to a pipe or file, and it’s nice with consistency. But also this has a severely limited character set, with possible crash behavior for any unsupported characters.</p>
<h2>Direct console output</h2>
<p>Unicode text limited to the Basic Multilingual Plane (essentially original 16-bits Unicode) can be output to a Windows console via the <code>WriteConsoleW</code> Windows API function.</p>
<p>The standard Python <code>ctypes</code> module provides access to the API:</p>
<p><i>Direct_console_io.py</i></p>
<pre class="brush: python; title: ; notranslate" title="">
import ctypes
class Object: pass

winapi = Object()
winapi.STD_INPUT_HANDLE     = -10
winapi.STD_OUTPUT_HANDLE    = -11
winapi.STD_ERROR_HANDLE     = -12
winapi.GetStdHandle         = ctypes.windll.kernel32.GetStdHandle
winapi.CloseHandle          = ctypes.windll.kernel32.CloseHandle
winapi.WriteConsoleW        = ctypes.windll.kernel32.WriteConsoleW

class Direct_console_io:
    def write( self, s ) -&gt; int:
        n_written = ctypes.c_ulong()
        ret = winapi.WriteConsoleW(
            self.std_output_handle, s, len( s ), ctypes.byref( n_written ), 0
            )
        return n_written.value

    def __del__( self ):
        if not winapi: return       # Looks like a bug in CPython 3.x
        winapi.CloseHandle( self.std_error_handle )
        winapi.CloseHandle( self.std_output_handle )
        winapi.CloseHandle( self.std_input_handle )

    def __init__( self ):
        self.dependency = winapi
        self.std_input_handle   = winapi.GetStdHandle( winapi.STD_INPUT_HANDLE )
        self.std_output_handle  = winapi.GetStdHandle( winapi.STD_OUTPUT_HANDLE )
        self.std_error_handle   = winapi.GetStdHandle( winapi.STD_ERROR_HANDLE )
</pre>
<p>Implementing input is left as an exercise for the reader.</p>
<h2>Overriding the standard streams to use direct i/o and UTF-8.</h2>
<p>In addition to the silly crashing behavior, the standard streams in CPython 3.x, like <code>sys.stdout</code>, default to Windows ANSI for output to file or pipe. In Python 2.7 this could be reset to more useful UTF-8 by <i>reloading</i> the <code>sys</code> module in order to get back a dynamically removed method that could set the default encoding. No longer in Python 3.x, so this code just creates new stream objects:</p>
<p><i>Utf8_standard_streams.py</i></p>
<pre class="brush: python; title: ; notranslate" title="">
import io
import sys
from Direct_console_io import Direct_console_io

class Dcio_raw_iobase( io.RawIOBase ):
    def writable( self ) -&gt; bool:
        return True

    def write( self, seq_of_bytes ) -&gt; int:
        b = bytes( seq_of_bytes )
        return self.dcio.write( b.decode( 'utf-8' ) )

    def __init__( self ):
        self.dcio = Direct_console_io()

class Dcio_buffered_writer( io.BufferedWriter ):
    def write( self, seq_of_bytes ) -&gt; int:
        return self.raw_stream.write( seq_of_bytes )

    def flush( self ):
        pass

    def __init__( self, raw_iobase ):
        super().__init__( raw_iobase )
        self.raw_stream = raw_iobase

# Module initialization:
def __init__():
    using_console_input = sys.stdin.isatty()
    using_console_output = sys.stdout.isatty()
    using_console_error = sys.stderr.isatty()

    if using_console_output:
        raw_io = Dcio_raw_iobase()
        buf_io = Dcio_buffered_writer( raw_io )
        sys.stdout = io.TextIOWrapper( buf_io, encoding = 'utf-8' )
        sys.stdout.isatty = lambda: True
    else:
        sys.stdout = io.TextIOWrapper( sys.stdout.detach(), encoding = 'utf-8-sig' )

    if using_console_error:
        raw_io = Dcio_raw_iobase()
        buf_io = Dcio_buffered_writer( raw_io )
        sys.stderr = io.TextIOWrapper( buf_io, encoding = 'utf-8' )
        sys.stderr.isatty = lambda: True
    else:
        sys.stderr = io.TextIOWrapper( sys.stderr.detach(), encoding = 'utf-8-sig' )
    return

__init__()
</pre>
<p>Disclaimer: It’s been a long time since I fiddled with Python, so possibly I’m breaking a number of conventions plus doing things in some less than optimal way. But this was the first path I found through the jungle of apparently arbitrary io class derivations etc. It worked well enough for my purposes (in a little script to convert NRK’s HTML-format subtitles to SubRip format), so, I gather it can be useful also for you – at least as a <b><i>basis</i></b> for more robust and/or more general code.</p>
		<div id="jp-post-flair" class="sharedaddy sd-rating-enabled sd-like-enabled sd-sharing-enabled"><div class="sharedaddy sd-block sd-like jetpack-likes-widget-wrapper jetpack-likes-widget-unloaded" id="like-post-wrapper-13498577-522-56d5ccc24a58f" data-src="//widgets.wp.com/likes/#blog_id=13498577&amp;post_id=522&amp;origin=alfps.wordpress.com&amp;obj_id=13498577-522-56d5ccc24a58f" data-name="like-post-frame-13498577-522-56d5ccc24a58f"><h3 class="sd-title">Like this:</h3><p class="likes-widget-placeholder post-likes-widget-placeholder"><span class="button"><span>Like</span></span> <span class="loading">Loading...</span></p><span class="sd-text-color"/><a class="sd-link-color"/></div>
<p id="jp-relatedposts" class="jp-relatedposts">
	<h3 class="jp-relatedposts-headline"><em>Related</em></h3>
</p></div>			</div>
	
	</div></body></html>