<html><body><div><div class="entry-content">
		<p>Lately, here at Tryolabs, we started gaining interest in big data and search related platforms which are giving us excellent resources to create our complex web applications. One of them is <a href="http://www.elasticsearch.org/">Elasticsearch</a>.</p>
<p><a href="http://www.elasticon.com">Elastic{ON}<sup>15</sup></a>, the first ES conference is coming, and since nowadays we see a lot of interest in this technology, we are taking the opportunity to give an introduction and a simple example for Python developers out there that want to begin using it or give it a try.</p>
<h3><strong>1 – What is Elasticsearch?</strong></h3>
<p>Elasticsearch is a distributed, real-time, search and analytics platform.</p>
<h3><strong>2 – Yeah, but what IS Elasticsearch?</strong></h3>
<p>Good question! In the previous definition you can see all these hype-sounding tech terms (distributed, real-time, analytics), so let’s try to explain.</p>
<p>ES is <b>distributed</b>, it organizes information in clusters of nodes, so it will run in multiple servers if we intend it to.</p>
<p>ES is <b>real-time</b>, since data is indexed, we get responses to our queries super fast!</p>
<p>And last but not least, it does searches and analytics. The main problem we are solving with this tool is exploring our data!</p>
<p>A platform like ES is the foundation for any respectable search engine.</p>
<h3><strong>3 – How does it work?</strong></h3>
<p>Using a restful API, Elasticsearch saves data and indexes it automatically. It assigns types to fields and that way a search can be done smartly and quickly using filters and different queries.</p>
<p>It’s uses JVM in order to be as fast as possible. It distributes indexes in “shards” of data. It replicates shards in different nodes, so it’s distributed and clusters can function even if not all nodes are operational. Adding nodes is super easy and that’s what makes it so scalable.</p>
<p>ES uses <a href="http://lucene.apache.org/">Lucene</a> to solve searches. This is quite an advantage with comparing with, for example, Django query strings. A restful API call allows us to perform searches using json objects as parameters, making it much more flexible and giving each search parameter within the object a different weight, importance and or priority.</p>
<p>The final result ranks objects that comply with the search query requirements. You could even use synonyms, autocompletes, spell suggestions and correct typos. While the usual query strings provides results that follow certain logic rules, ES queries give you a ranked list of results that may fall in different criteria and its order depend on how they comply with a certain rule or filter.</p>
<p>ES can also provide answers for data analysis, like averages, how many unique terms and or statistics. This could be done using aggregations. To dig a little deeper in this feature check the documentation <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/search-aggregations.html">here.</a></p>
<h3><strong>4 – Should I use ES?</strong></h3>
<p>The main point is scalability and getting results and insights very fast. In most cases using Lucene could be enough to have all you need.</p>
<p>It seems sometimes that these tools are designed for projects with tons of data and are distributed in order to handle tons of users. Startups dream of growing to that scenario, but may start thinking small first to build a prototype and then when the data is there, start thinking about scaling problems.</p>
<p>Does it make sense and pays off to be prepared to grow A LOT? Why not? Elasticsearch has no drawback and is easy to use, so it’s just a decision of using it to be prepared for the future.</p>
<p>I’m going to give you a quick example of a dead simple project using Elasticsearch to quickly and beautifully search for some example data. It will be quick to do, Python powered and ready to scale in case we need it to, so, best of both worlds.</p>
<h3><strong>5 – Easy first steps with ES</strong></h3>
<p>For the following part it would be nice to be familiarized with concepts like Cluster, Node, Document, Index. Take a look at the official <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/_basic_concepts.html">guide</a> if you have doubts.</p>
<p>First things first, get ES from here: <a href="http://www.elasticsearch.org/overview/elkdownloads/">http://www.elasticsearch.org/overview/elkdownloads/</a></p>
<p>I followed this <a href="http://www.elasticsearch.org/webinars/getting-started-with-elasticsearch/">video tutorial</a> to get things started in just a minute. I recommend all you to check it out later.</p>
<p>Once you downloaded ES, it’s as simple as running <em>bin/elasticsearch</em> and you will have your ES cluster with one node running! You can interact with it at <a href="http://localhost:9200/">http://localhost:9200/</a></p>
<p>If you hit it you will get something like this:</p>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_subarea output_text output_stream output_stdout">
<pre>{
  "status" : 200,
  "name" : "Delphine Courtney",
  "cluster_name" : "elasticsearch",
  "version" : {
    "number" : "1.4.2",
    "build_hash" : "927caff6f05403e936c20bf4529f144f0c89fd8c",
    "build_timestamp" : "2014-12-16T14:11:12Z",
    "build_snapshot" : false,
    "lucene_version" : "4.10.2"
  },
  "tagline" : "You Know, for Search"
}
</pre>
</div>
</div>
</div>
</div>
<p>Creating another node is as simple as:</p>
<pre>bin/elasticsearch -Des.node.name=Node-2</pre>
<p>It automatically detects the old node as its master and joins our cluster. By default we will be able to communicate with this new node using the 9201 port <a href="http://localhost:9200/">http://localhost:9201</a>. Now we can talk with each node and receive the same data, they are supposed to be identical.</p>
<h3><strong>6 – Let’s Pythonize this thing!</strong></h3>
<p>To use ES with our all time favorite language; Python, it gets easier if we install elasticsearch-py package.</p>
<pre>pip install elasticsearch</pre>
<p>Now we will be able to use this package to index and search data using Python.</p>
<h3><strong>7 – Let’s add some public data to our cluster</strong></h3>
<p>So, I wanted to make this project a “real world example”, I really did, but after I found out there is a star wars API (<a href="http://swapi.co/">http://swapi.co/</a>), I couldn’t resist it and ended up being a fictional –  “galaxy far far away” example.  The API is dead simple to use, so we will get some data from there.</p>
<p>I’m using an <a href="http://ipython.org/notebook.html">IPython Notebook</a> to do this test, I started with the sample request to make sure we can hit the ES server.</p>
<pre># make sure ES is up and running
import requests
res = requests.get('http://localhost:9200')
print(res.content)</pre>
<p>Then we connect to our ES server using Python and the elasticsearch-py library:</p>
<pre>#connect to our cluster
from elasticsearch import Elasticsearch
es = Elasticsearch([{'host': 'localhost', 'port': 9200}])</pre>
<p>I added some data to test, and then deleted it. I’m skipping that part for this guide, but you can check it out in the <a href="https://github.com/ernestorx/es-swapi-test/blob/master/ES%20notebook.ipynb">notebook</a>.</p>
<p>Now, using The Force, we connect to the Star Wars API and index some fictional people.</p>
<pre>#let's iterate over swapi people documents and index them
import json
r = requests.get('http://localhost:9200') 
i = 1
while r.status_code == 200:
    r = requests.get('http://swapi.co/api/people/'+ str(i))
    es.index(index='sw', doc_type='people', id=i, body=json.loads(r.content))
    i=i+1
 
print(i)</pre>
<p>Please, notice that we automatically created an index “sw” and a “doc_type” with de indexing command.</p>
<p>We get 17 responses from swapi and index them with ES. I’m sure there are much more “people” in the swapi DB, but it seems we are getting a 404 with <a href="http://swapi.co/api/people/17">http://swapi.co/api/people/17</a>/. Bug report here! <img src="http://blog.tryolabs.com/wp-includes/images/smilies/simple-smile.png" alt=":-)" class="wp-smiley"/></p>
<p>Anyway, to see if all worked with this few results, we try to get the document with id=5.</p>
<pre>es.get(index='sw', doc_type='people', id=5)</pre>
<p>We will get Princess Leia:</p>
<pre>{u'_id': u'5',
 u'_index': u'sw',
 u'_source': {u'birth_year': u'19BBY',
  u'created': u'2014-12-10T15:20:09.791000Z',
  u'edited': u'2014-12-20T21:17:50.315000Z',
  u'eye_color': u'brown',
  u'films': [u'http://swapi.co/api/films/1/',
   u'http://swapi.co/api/films/2/',
   u'http://swapi.co/api/films/3/',
   u'http://swapi.co/api/films/6/'],
  u'gender': u'female',
  u'hair_color': u'brown',
  u'height': u'150',
  u'homeworld': u'http://swapi.co/api/planets/2/',
  u'mass': u'49',
  u'name': u'Leia Organa',
  u'skin_color': u'light',
  u'species': [u'http://swapi.co/api/species/1/'],
  u'starships': [],
  u'url': u'http://swapi.co/api/people/5/',
  u'vehicles': [u'http://swapi.co/api/vehicles/30/']},
 u'_type': u'people',
 u'_version': 1,
 u'found': True}</pre>
<p>Now, let’s add more data, this time using node 2! And let’s start at the 18th person, where we stopped.</p>
<pre>r = requests.get('http://localhost:9201')
i = 18
while r.status_code == 200:
   r = requests.get('http://swapi.co/api/people/'+ str(i))
   es.index(index='sw', doc_type='people', id=i,     body=json.loads(r.content))
   i=i+1</pre>
<p>We got the rest of the characters just fine.</p>
<h3>8 – Now, let’s try an interesting search</h3>
<p>Where is Darth Vader? Here is our search query:</p>
<pre>es.search(index="sw", body={"query": {"match": {'name':'Darth Vader'}}})</pre>
<p>This will give us both Darth Vader AND Darth Maul. Id 4 and id 44 (notice that they are in the same index, even if we use different node client call the index command). Both results have a score, although Darth Vader is much higher than Darth Maul (2.77 vs 0.60) since Vader is a exact match. Take that Darth Maul!</p>
<pre>{u'_shards': {u'failed': 0, u'successful': 5, u'total': 5},
 u'hits': {u'hits': [{u'_id': u'4',
    u'_index': u'sw',
    u'_score': 2.7754524,
    u'_source': {u'birth_year': u'41.9BBY',
     u'created': u'2014-12-10T15:18:20.704000Z',
     u'edited': u'2014-12-20T21:17:50.313000Z',
     u'eye_color': u'yellow',
     u'films': [u'http://swapi.co/api/films/1/',
      u'http://swapi.co/api/films/2/',
      u'http://swapi.co/api/films/3/',
      u'http://swapi.co/api/films/6/'],
     u'gender': u'male',
     u'hair_color': u'none',
     u'height': u'202',
     u'homeworld': u'http://swapi.co/api/planets/1/',
     u'mass': u'136',
     u'name': u'<strong>Darth Vader</strong>',
     u'skin_color': u'white',
     u'species': [u'http://swapi.co/api/species/1/'],
     u'starships': [u'http://swapi.co/api/starships/13/'],
     u'url': u'http://swapi.co/api/people/4/',
     u'vehicles': []},
    u'_type': u'people'},
   {u'_id': u'44',
    u'_index': u'sw',
    u'_score': 0.6085256,
    u'_source': {u'birth_year': u'54BBY',
     u'created': u'2014-12-19T18:00:41.929000Z',
     u'edited': u'2014-12-20T21:17:50.403000Z',
     u'eye_color': u'yellow',
     u'films': [u'http://swapi.co/api/films/4/'],
     u'gender': u'male',
     u'hair_color': u'none',
     u'height': u'175',
     u'homeworld': u'http://swapi.co/api/planets/36/',
     u'mass': u'80',
     u'name': u'<strong>Darth Maul</strong>',
     u'skin_color': u'red',
     u'species': [u'http://swapi.co/api/species/22/'],
     u'starships': [u'http://swapi.co/api/starships/41/'],
     u'url': u'http://swapi.co/api/people/44/',
     u'vehicles': [u'http://swapi.co/api/vehicles/42/']},
    u'_type': u'people'}],
  u'max_score': 2.7754524,
  u'total': 2},
 u'timed_out': False,
 u'took': 44}</pre>
<p>So, this query will give us results if the word is contained exactly in our indexed data. What if we want to build some kind of autocomplete input where we get the names that contain the characters we are typing?</p>
<p>There are many ways to do that and another great number of queries. Take a look <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/query-dsl-multi-match-query.html">here</a> to learn more. I picked this one to get all documents with prefix “lu” in their name field:</p>
<pre>es.search(index="sw", body={"query": {"prefix" : { "name" : "lu" }}})</pre>
<p>We will get Luke Skywalker and Luminara Unduli, both with the same 1.0 score, since they match with the same 2 initial characters.</p>
<pre>{u'_shards': {u'failed': 0, u'successful': 5, u'total': 5},
 u'hits': {u'hits': [{u'_id': u'1',
    u'_index': u'sw',
    u'_score': 1.0,
    u'_source': {u'birth_year': u'19BBY',
     u'created': u'2014-12-09T13:50:51.644000Z',
     u'edited': u'2014-12-20T21:17:56.891000Z',
     u'eye_color': u'blue',
     u'films': [u'http://swapi.co/api/films/1/',
      u'http://swapi.co/api/films/2/',
      u'http://swapi.co/api/films/3/',
      u'http://swapi.co/api/films/6/'],
     u'gender': u'male',
     u'hair_color': u'blond',
     u'height': u'172',
     u'homeworld': u'http://swapi.co/api/planets/1/',
     u'mass': u'77',
     u'name': u'Luke Skywalker',
     u'skin_color': u'fair',
     u'species': [u'http://swapi.co/api/species/1/'],
     u'starships': [u'http://swapi.co/api/starships/12/',
      u'http://swapi.co/api/starships/22/'],
     u'url': u'http://swapi.co/api/people/1/',
     u'vehicles': [u'http://swapi.co/api/vehicles/14/',
      u'http://swapi.co/api/vehicles/30/']},
    u'_type': u'people'},
   {u'_id': u'64',
    u'_index': u'sw',
    u'_score': 1.0,
    u'_source': {u'birth_year': u'58BBY',
     u'created': u'2014-12-20T16:45:53.668000Z',
     u'edited': u'2014-12-20T21:17:50.455000Z',
     u'eye_color': u'blue',
     u'films': [u'http://swapi.co/api/films/5/',
      u'http://swapi.co/api/films/6/'],
     u'gender': u'female',
     u'hair_color': u'black',
     u'height': u'170',
     u'homeworld': u'http://swapi.co/api/planets/51/',
     u'mass': u'56.2',
     u'name': u'Luminara Unduli',
     u'skin_color': u'yellow',
     u'species': [u'http://swapi.co/api/species/29/'],
     u'starships': [],
     u'url': u'http://swapi.co/api/people/64/',
     u'vehicles': []},
    u'_type': u'people'}],
  u'max_score': 1.0,
  u'total': 2},
 u'timed_out': False,
 u'took': 9}</pre>
<p>There are many other interesting queries we can do. If, for example, we want to get all elements similar in some way, for a related or correction search we can use something like this:</p>
<pre>es.search(index="sw", body={"query": {"fuzzy_like_this_field" : { "name" : {"like_text": "jaba", "max_query_terms":5}}}})</pre>
<p>And we got Jabba although we had a typo in our search query. That is powerful!</p>
<pre>{u'_shards': {u'failed': 0, u'successful': 5, u'total': 5},
 u'hits': {u'hits': [{u'_id': u'16',
    u'_index': u'sw',
    u'_score': 1.5700331,
    u'_source': {u'birth_year': u'600BBY',
     u'created': u'2014-12-10T17:11:31.638000Z',
     u'edited': u'2014-12-20T21:17:50.338000Z',
     u'eye_color': u'orange',
     u'films': [u'http://swapi.co/api/films/1/',
      u'http://swapi.co/api/films/3/',
      u'http://swapi.co/api/films/4/'],
     u'gender': u'hermaphrodite',
     u'hair_color': u'n/a',
     u'height': u'175',
     u'homeworld': u'http://swapi.co/api/planets/24/',
     u'mass': u'1,358',
     u'name': u'Jabba Desilijic Tiure',
     u'skin_color': u'green-tan, brown',
     u'species': [u'http://swapi.co/api/species/5/'],
     u'starships': [],
     u'url': u'http://swapi.co/api/people/16/',
     u'vehicles': []},
    u'_type': u'people'}],
  u'max_score': 1.5700331,
  u'total': 1},
 u'timed_out': False,
 u'took': 40}</pre>
<h3><strong>9 – Next Steps</strong></h3>
<p>This was just a simple overview on how to set up your Elasticsearch server and start working with some data using Python. The code used here is publicly available in this IPython notebook. <a href="https://github.com/ernestorx/es-swapi-test/blob/master/ES%20notebook.ipynb">https://github.com/ernestorx/es-swapi-test/</a></p>
<p>We encourage you to learn more about ES and specially take a look at the <a href="http://www.elasticsearch.org/overview/">ELK stack</a> where you will be able to see beautiful analytics and insights with Kibana and go through logs using Logstash.</p>
<p>In following posts we will talk about more advanced ES features and we will try to extend this simple test and use it to show a more interesting Django app powered by this data and by ES.</p>
<p>Hope this post was useful for developers trying to enter the ES world. Stay tuned!</p>
<p>Discuss this post in <a href="https://news.ycombinator.com/item?id=9068684">Hacker News</a>.</p>
			  </div>
	  </div></body></html>