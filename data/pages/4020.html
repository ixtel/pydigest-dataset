<html><body><div><div class="section" id="simple-output">
<h2>Simple Output</h2>
<p>Let’s get started by importing pandas, numpy and <code class="code">
xl_rowcol_to_cell</code>
.</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">xlsxwriter.utility</span> <span class="kn">import</span> <span class="n">xl_rowcol_to_cell</span>
</pre></div>
<p>Read in the <a class="reference external" href="http://pbpython.com/extras/excel-comp-datav2.xlsx">file</a>.</p>
<div class="highlight"><pre><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s">"excel-comp-datav2.xlsx"</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
<div>
<table border="1" class="table table-condensed">
<thead>
<tr>
<th/>
<th>account</th>
<th>name</th>
<th>street</th>
<th>city</th>
<th>state</th>
<th>post-code</th>
<th>quota</th>
<th>Jan</th>
<th>Feb</th>
<th>Mar</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>211829</td>
<td>Kerluke, Koepp and Hilpert</td>
<td>34456 Sean Highway</td>
<td>New Jaycob</td>
<td><span class="caps">TX</span></td>
<td>28752</td>
<td>110000</td>
<td>10000</td>
<td>62000</td>
<td>35000</td>
</tr>
<tr>
<th>1</th>
<td>320563</td>
<td>Walter-Trantow</td>
<td>1311 Alvis Tunnel</td>
<td>Port Khadijah</td>
<td><span class="caps">NC</span></td>
<td>38365</td>
<td>150000</td>
<td>95000</td>
<td>45000</td>
<td>35000</td>
</tr>
<tr>
<th>2</th>
<td>648336</td>
<td>Bashirian, Kunde and Price</td>
<td>62184 Schamberger Underpass Apt. 231</td>
<td>New Lilianland</td>
<td><span class="caps">IA</span></td>
<td>76517</td>
<td>300000</td>
<td>91000</td>
<td>120000</td>
<td>35000</td>
</tr>
<tr>
<th>3</th>
<td>109996</td>
<td>D’Amore, Gleichner and Bode</td>
<td>155 Fadel Crescent Apt. 144</td>
<td>Hyattburgh</td>
<td><span class="caps">ME</span></td>
<td>46021</td>
<td>180000</td>
<td>45000</td>
<td>120000</td>
<td>10000</td>
</tr>
<tr>
<th>4</th>
<td>121213</td>
<td>Bauch-Goldner</td>
<td>7274 Marissa Common</td>
<td>Shanahanchester</td>
<td><span class="caps">CA</span></td>
<td>49681</td>
<td>300000</td>
<td>162000</td>
<td>120000</td>
<td>35000</td>
</tr>
</tbody>
</table>
</div><p>This dummy data shows account sales for Jan, Feb and March as well as the quota for each
of these accounts. What we are going to do is summarize the data and see how close
each account was towards hitting its quota.</p>
<p>Get the number of rows to make it easier to add our Excel formulas a little later.</p>
<div class="highlight"><pre><span class="n">number_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</pre></div>
<p>As of pandas 0.16, there is a new function called <code class="code">
assign</code>
 that is useful here
to add some total data.</p>
<div class="highlight"><pre><span class="c"># Add some summary data using the new assign functionality in pandas 0.16</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'Jan'</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s">'Feb'</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s">'Mar'</span><span class="p">]))</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
<div>
<table border="1" class="table table-condensed">
<thead>
<tr>
<th/>
<th>account</th>
<th>name</th>
<th>street</th>
<th>city</th>
<th>state</th>
<th>post-code</th>
<th>quota</th>
<th>Jan</th>
<th>Feb</th>
<th>Mar</th>
<th>total</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>211829</td>
<td>Kerluke, Koepp and Hilpert</td>
<td>34456 Sean Highway</td>
<td>New Jaycob</td>
<td><span class="caps">TX</span></td>
<td>28752</td>
<td>110000</td>
<td>10000</td>
<td>62000</td>
<td>35000</td>
<td>107000</td>
</tr>
<tr>
<th>1</th>
<td>320563</td>
<td>Walter-Trantow</td>
<td>1311 Alvis Tunnel</td>
<td>Port Khadijah</td>
<td><span class="caps">NC</span></td>
<td>38365</td>
<td>150000</td>
<td>95000</td>
<td>45000</td>
<td>35000</td>
<td>175000</td>
</tr>
<tr>
<th>2</th>
<td>648336</td>
<td>Bashirian, Kunde and Price</td>
<td>62184 Schamberger Underpass Apt. 231</td>
<td>New Lilianland</td>
<td><span class="caps">IA</span></td>
<td>76517</td>
<td>300000</td>
<td>91000</td>
<td>120000</td>
<td>35000</td>
<td>246000</td>
</tr>
<tr>
<th>3</th>
<td>109996</td>
<td>D’Amore, Gleichner and Bode</td>
<td>155 Fadel Crescent Apt. 144</td>
<td>Hyattburgh</td>
<td><span class="caps">ME</span></td>
<td>46021</td>
<td>180000</td>
<td>45000</td>
<td>120000</td>
<td>10000</td>
<td>175000</td>
</tr>
<tr>
<th>4</th>
<td>121213</td>
<td>Bauch-Goldner</td>
<td>7274 Marissa Common</td>
<td>Shanahanchester</td>
<td><span class="caps">CA</span></td>
<td>49681</td>
<td>300000</td>
<td>162000</td>
<td>120000</td>
<td>35000</td>
<td>317000</td>
</tr>
</tbody>
</table>
</div><p>We can also use <code class="code">
assign</code>
 to show how close accounts are towards their quota.</p>
<div class="highlight"><pre><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">quota_pct</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'total'</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s">'quota'</span><span class="p">])</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s">'quota'</span><span class="p">]))</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
<div>
<table border="1" class="table table-condensed">
<thead>
<tr>
<th/>
<th>account</th>
<th>name</th>
<th>street</th>
<th>city</th>
<th>state</th>
<th>post-code</th>
<th>quota</th>
<th>Jan</th>
<th>Feb</th>
<th>Mar</th>
<th>total</th>
<th>quota_pct</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>211829</td>
<td>Kerluke, Koepp and Hilpert</td>
<td>34456 Sean Highway</td>
<td>New Jaycob</td>
<td><span class="caps">TX</span></td>
<td>28752</td>
<td>110000</td>
<td>10000</td>
<td>62000</td>
<td>35000</td>
<td>107000</td>
<td>0.972727</td>
</tr>
<tr>
<th>1</th>
<td>320563</td>
<td>Walter-Trantow</td>
<td>1311 Alvis Tunnel</td>
<td>Port Khadijah</td>
<td><span class="caps">NC</span></td>
<td>38365</td>
<td>150000</td>
<td>95000</td>
<td>45000</td>
<td>35000</td>
<td>175000</td>
<td>1.166667</td>
</tr>
<tr>
<th>2</th>
<td>648336</td>
<td>Bashirian, Kunde and Price</td>
<td>62184 Schamberger Underpass Apt. 231</td>
<td>New Lilianland</td>
<td><span class="caps">IA</span></td>
<td>76517</td>
<td>300000</td>
<td>91000</td>
<td>120000</td>
<td>35000</td>
<td>246000</td>
<td>0.820000</td>
</tr>
<tr>
<th>3</th>
<td>109996</td>
<td>D’Amore, Gleichner and Bode</td>
<td>155 Fadel Crescent Apt. 144</td>
<td>Hyattburgh</td>
<td><span class="caps">ME</span></td>
<td>46021</td>
<td>180000</td>
<td>45000</td>
<td>120000</td>
<td>10000</td>
<td>175000</td>
<td>0.972222</td>
</tr>
<tr>
<th>4</th>
<td>121213</td>
<td>Bauch-Goldner</td>
<td>7274 Marissa Common</td>
<td>Shanahanchester</td>
<td><span class="caps">CA</span></td>
<td>49681</td>
<td>300000</td>
<td>162000</td>
<td>120000</td>
<td>35000</td>
<td>317000</td>
<td>1.056667</td>
</tr>
</tbody>
</table>
</div>
<div class="panel panel-info">
<p class="panel-heading">
Thoughts on using assign</p>
<div class="panel-body">
<p>As a side note, I personally like the <code class="code">
assign</code>
 function for adding
these types of additional columns. Here is how you could add a total without assign:</p>
<div class="highlight"><pre><span class="n">df</span><span class="p">[</span><span class="s">"total"</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">"Jan"</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s">"Feb"</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s">"Mar"</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>Save this data using the simple <code class="code">
to_excel</code>
 process.</p>
<div class="highlight"><pre><span class="n">writer_orig</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="s">'simple.xlsx'</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s">'xlsxwriter'</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer_orig</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s">'report'</span><span class="p">)</span>
<span class="n">writer_orig</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
<p>Here is what the simple file looks like:</p>

<p>You will notice a couple of things that would be nice to fix:</p>
<ul class="simple">
<li>The column widths make it tough to see all the data</li>
<li>The sales and percentages are not formmatted as dollars or %’s</li>
<li>There is no total information.</li>
<li>Overall it is pretty boring.</li>
</ul>
</div>
<div class="section" id="complex-output">
<h2>Complex Output</h2>
<p>With just a little more coding, we can create a more sophisticated output.</p>
<p>We create another writer and use the <code class="code">
to_excel</code>
 to create our workbook.</p>
<div class="highlight"><pre><span class="n">writer</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="s">'fancy.xlsx'</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s">'xlsxwriter'</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s">'report'</span><span class="p">)</span>
</pre></div>
<p>The key is to get access to the worksheet which enables us to use all
the XlsxWriter capability available in that library.</p>
<div class="highlight"><pre><span class="n">workbook</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">book</span>
<span class="n">worksheet</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">sheets</span><span class="p">[</span><span class="s">'report'</span><span class="p">]</span>
</pre></div>
<p>Now that we have the worksheet, we can do anything that xlsxwriter
supports. If you have not done so yet, I encourage you to take a look
at the <a class="reference external" href="https://xlsxwriter.readthedocs.org/">XlsxWriter</a> docs. They are very well written and show you
all the capabilities available for customizing Excel output. By
accessing the worksheet as shown above, you can easily drop in all XlsxWriter’s
features into your output.</p>
<p>I’ll walk through a few of them to give you some ideas.
First, we resize the sheet by adjusting the zoom.</p>

<p>Some of our biggest improvements come through formatting the columns to make
the data more readable. <code class="code">
add_format</code>
 is very useful for
improving your standard output.</p>
<p>Here are two examples of formatting numbers:</p>
<div class="highlight"><pre><span class="c"># Add a number format for cells with money.</span>
<span class="n">money_fmt</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s">'num_format'</span><span class="p">:</span> <span class="s">'$#,##0'</span><span class="p">,</span> <span class="s">'bold'</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span>

<span class="c"># Add a percent format with 1 decimal point</span>
<span class="n">percent_fmt</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s">'num_format'</span><span class="p">:</span> <span class="s">'0.0%'</span><span class="p">,</span> <span class="s">'bold'</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span>
</pre></div>
<p>This example shows how to add additional formatting including underlines.</p>
<div class="highlight"><pre><span class="c"># Total formatting</span>
<span class="n">total_fmt</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s">'align'</span><span class="p">:</span> <span class="s">'right'</span><span class="p">,</span> <span class="s">'num_format'</span><span class="p">:</span> <span class="s">'$#,##0'</span><span class="p">,</span>
                                 <span class="s">'bold'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'bottom'</span><span class="p">:</span><span class="mi">6</span><span class="p">})</span>
<span class="c"># Total percent format</span>
<span class="n">total_percent_fmt</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s">'align'</span><span class="p">:</span> <span class="s">'right'</span><span class="p">,</span> <span class="s">'num_format'</span><span class="p">:</span> <span class="s">'0.0%'</span><span class="p">,</span>
                                         <span class="s">'bold'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'bottom'</span><span class="p">:</span><span class="mi">6</span><span class="p">})</span>
</pre></div>
<p>Change the size of several columns using <code class="code">
set_column</code>
. This can
also be used to apply formatting to a column.</p>
<p>This section changes the size of columns B-F to sizes more appropriate for the
data they store.</p>
<div class="highlight"><pre><span class="c"># Account info columns</span>
<span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s">'B:D'</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="c"># State column</span>
<span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s">'E:E'</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="c"># Post code</span>
<span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s">'F:F'</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
<p>In addition to changing the size of G-L, we also can apply the money and
percent formatting on the entire column.</p>
<div class="highlight"><pre><span class="c"># Monthly columns</span>
<span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s">'G:K'</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">money_fmt</span><span class="p">)</span>
<span class="c"># Quota percent columns</span>
<span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s">'L:L'</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">percent_fmt</span><span class="p">)</span>
</pre></div>
<p>The next section adds a total at the bottom of our data. The biggest challenge
in working with Excel is converting between numeric indices and cell labels.
This loop shows how to loop through the columns numerically but also
use <code class="code">
xl_rowcol_to_cell</code>
 to get cell locations.</p>
<div class="highlight"><pre><span class="c"># Add total rows</span>
<span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
    <span class="c"># Determine where we will place the formula</span>
    <span class="n">cell_location</span> <span class="o">=</span> <span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">number_rows</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>
    <span class="c"># Get the range to use for the sum formula</span>
    <span class="n">start_range</span> <span class="o">=</span> <span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>
    <span class="n">end_range</span> <span class="o">=</span> <span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">number_rows</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>
    <span class="c"># Construct and write the formula</span>
    <span class="n">formula</span> <span class="o">=</span> <span class="s">"=SUM({:s}:{:s})"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start_range</span><span class="p">,</span> <span class="n">end_range</span><span class="p">)</span>
    <span class="n">worksheet</span><span class="o">.</span><span class="n">write_formula</span><span class="p">(</span><span class="n">cell_location</span><span class="p">,</span> <span class="n">formula</span><span class="p">,</span> <span class="n">total_fmt</span><span class="p">)</span>
</pre></div>
<p>In addition to writing the total label, we want to see what our % to quota is in aggregate.
We construct the string to calculate the percent to quota and write it out
using <code class="code">
write_formula</code>
</p>
<div class="highlight"><pre><span class="c"># Add a total label</span>
<span class="n">worksheet</span><span class="o">.</span><span class="n">write_string</span><span class="p">(</span><span class="n">number_rows</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">"Total"</span><span class="p">,</span><span class="n">total_fmt</span><span class="p">)</span>
<span class="n">percent_formula</span> <span class="o">=</span> <span class="s">"=1+(K{0}-G{0})/G{0}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number_rows</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
<span class="n">worksheet</span><span class="o">.</span><span class="n">write_formula</span><span class="p">(</span><span class="n">number_rows</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">percent_formula</span><span class="p">,</span> <span class="n">total_percent_fmt</span><span class="p">)</span>
</pre></div>
<p>The final item to add is the capability to highlight the top 5 values and
the bottom 5 values. This gives us a nice visual representation of where we
may need to inspect further.</p>
<p>First, we define the range we want to format.</p>
<div class="highlight"><pre><span class="c"># Define our range for the color formatting</span>
<span class="n">color_range</span> <span class="o">=</span> <span class="s">"L2:L{}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number_rows</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
<p>Then, we define the colors.</p>
<div class="highlight"><pre><span class="c"># Add a format. Light red fill with dark red text.</span>
<span class="n">format1</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s">'bg_color'</span><span class="p">:</span> <span class="s">'#FFC7CE'</span><span class="p">,</span>
                               <span class="s">'font_color'</span><span class="p">:</span> <span class="s">'#9C0006'</span><span class="p">})</span>

<span class="c"># Add a format. Green fill with dark green text.</span>
<span class="n">format2</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s">'bg_color'</span><span class="p">:</span> <span class="s">'#C6EFCE'</span><span class="p">,</span>
                               <span class="s">'font_color'</span><span class="p">:</span> <span class="s">'#006100'</span><span class="p">})</span>
</pre></div>
<p>Finally, we apply the conditional formatting and save our output.</p>
<div class="highlight"><pre><span class="c"># Highlight the top 5 values in Green</span>
<span class="n">worksheet</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="n">color_range</span><span class="p">,</span> <span class="p">{</span><span class="s">'type'</span><span class="p">:</span> <span class="s">'top'</span><span class="p">,</span>
                                           <span class="s">'value'</span><span class="p">:</span> <span class="s">'5'</span><span class="p">,</span>
                                           <span class="s">'format'</span><span class="p">:</span> <span class="n">format2</span><span class="p">})</span>
</pre></div>
<div class="highlight"><pre><span class="c"># Highlight the bottom 5 values in Red</span>
<span class="n">worksheet</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="n">color_range</span><span class="p">,</span> <span class="p">{</span><span class="s">'type'</span><span class="p">:</span> <span class="s">'bottom'</span><span class="p">,</span>
                                           <span class="s">'value'</span><span class="p">:</span> <span class="s">'5'</span><span class="p">,</span>
                                           <span class="s">'format'</span><span class="p">:</span> <span class="n">format1</span><span class="p">})</span>
<span class="n">writer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
<p>Here is the final <a class="reference external" href="http://pbpython.com/extras/fancy.xlsx">output</a>.</p>

</div>
<div class="section" id="final-thoughts">
<h2>Final Thoughts</h2>
<p>To pull it all together, here is the complete code:</p>
<div class="highlight"><pre><span class="sd">"""</span>
<span class="sd">Show examples of modifying the Excel output generated by pandas</span>
<span class="sd">"""</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">xlsxwriter.utility</span> <span class="kn">import</span> <span class="n">xl_rowcol_to_cell</span>


<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s">"../in/excel-comp-datav2.xlsx"</span><span class="p">)</span>

<span class="c"># We need the number of rows in order to place the totals</span>
<span class="n">number_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

<span class="c"># Add some summary data using the new assign functionality in pandas 0.16</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'Jan'</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s">'Feb'</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s">'Mar'</span><span class="p">]))</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">quota_pct</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'total'</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s">'quota'</span><span class="p">])</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s">'quota'</span><span class="p">]))</span>

<span class="c"># Create a Pandas Excel writer using XlsxWriter as the engine.</span>
<span class="c"># Save the unformatted results</span>
<span class="n">writer_orig</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="s">'simple.xlsx'</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s">'xlsxwriter'</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer_orig</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s">'report'</span><span class="p">)</span>
<span class="n">writer_orig</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="c"># Create a Pandas Excel writer using XlsxWriter as the engine.</span>
<span class="n">writer</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="s">'fancy.xlsx'</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s">'xlsxwriter'</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s">'report'</span><span class="p">)</span>

<span class="c"># Get access to the workbook and sheet</span>
<span class="n">workbook</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">book</span>
<span class="n">worksheet</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">sheets</span><span class="p">[</span><span class="s">'report'</span><span class="p">]</span>

<span class="c"># Reduce the zoom a little</span>
<span class="n">worksheet</span><span class="o">.</span><span class="n">set_zoom</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span>

<span class="c"># Add a number format for cells with money.</span>
<span class="n">money_fmt</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s">'num_format'</span><span class="p">:</span> <span class="s">'$#,##0'</span><span class="p">,</span> <span class="s">'bold'</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span>

<span class="c"># Add a percent format with 1 decimal point</span>
<span class="n">percent_fmt</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s">'num_format'</span><span class="p">:</span> <span class="s">'0.0%'</span><span class="p">,</span> <span class="s">'bold'</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span>

<span class="c"># Total formatting</span>
<span class="n">total_fmt</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s">'align'</span><span class="p">:</span> <span class="s">'right'</span><span class="p">,</span> <span class="s">'num_format'</span><span class="p">:</span> <span class="s">'$#,##0'</span><span class="p">,</span>
                                 <span class="s">'bold'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'bottom'</span><span class="p">:</span><span class="mi">6</span><span class="p">})</span>
<span class="c"># Total percent format</span>
<span class="n">total_percent_fmt</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s">'align'</span><span class="p">:</span> <span class="s">'right'</span><span class="p">,</span> <span class="s">'num_format'</span><span class="p">:</span> <span class="s">'0.0%'</span><span class="p">,</span>
                                         <span class="s">'bold'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'bottom'</span><span class="p">:</span><span class="mi">6</span><span class="p">})</span>

<span class="c"># Format the columns by width and include number formats</span>

<span class="c"># Account info columns</span>
<span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s">'B:D'</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="c"># State column</span>
<span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s">'E:E'</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="c"># Post code</span>
<span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s">'F:F'</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

<span class="c"># Monthly columns</span>
<span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s">'G:K'</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">money_fmt</span><span class="p">)</span>
<span class="c"># Quota percent columns</span>
<span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s">'L:L'</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">percent_fmt</span><span class="p">)</span>

<span class="c"># Add total rows</span>
<span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
    <span class="c"># Determine where we will place the formula</span>
    <span class="n">cell_location</span> <span class="o">=</span> <span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">number_rows</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>
    <span class="c"># Get the range to use for the sum formula</span>
    <span class="n">start_range</span> <span class="o">=</span> <span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>
    <span class="n">end_range</span> <span class="o">=</span> <span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">number_rows</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>
    <span class="c"># Construct and write the formula</span>
    <span class="n">formula</span> <span class="o">=</span> <span class="s">"=SUM({:s}:{:s})"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start_range</span><span class="p">,</span> <span class="n">end_range</span><span class="p">)</span>
    <span class="n">worksheet</span><span class="o">.</span><span class="n">write_formula</span><span class="p">(</span><span class="n">cell_location</span><span class="p">,</span> <span class="n">formula</span><span class="p">,</span> <span class="n">total_fmt</span><span class="p">)</span>

<span class="c"># Add a total label</span>
<span class="n">worksheet</span><span class="o">.</span><span class="n">write_string</span><span class="p">(</span><span class="n">number_rows</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">"Total"</span><span class="p">,</span><span class="n">total_fmt</span><span class="p">)</span>
<span class="n">percent_formula</span> <span class="o">=</span> <span class="s">"=1+(K{0}-G{0})/G{0}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number_rows</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
<span class="n">worksheet</span><span class="o">.</span><span class="n">write_formula</span><span class="p">(</span><span class="n">number_rows</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">percent_formula</span><span class="p">,</span> <span class="n">total_percent_fmt</span><span class="p">)</span>

<span class="c"># Define our range for the color formatting</span>
<span class="n">color_range</span> <span class="o">=</span> <span class="s">"L2:L{}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number_rows</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

<span class="c"># Add a format. Light red fill with dark red text.</span>
<span class="n">format1</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s">'bg_color'</span><span class="p">:</span> <span class="s">'#FFC7CE'</span><span class="p">,</span>
                               <span class="s">'font_color'</span><span class="p">:</span> <span class="s">'#9C0006'</span><span class="p">})</span>

<span class="c"># Add a format. Green fill with dark green text.</span>
<span class="n">format2</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s">'bg_color'</span><span class="p">:</span> <span class="s">'#C6EFCE'</span><span class="p">,</span>
                               <span class="s">'font_color'</span><span class="p">:</span> <span class="s">'#006100'</span><span class="p">})</span>

<span class="c"># Highlight the top 5 values in Green</span>
<span class="n">worksheet</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="n">color_range</span><span class="p">,</span> <span class="p">{</span><span class="s">'type'</span><span class="p">:</span> <span class="s">'top'</span><span class="p">,</span>
                                           <span class="s">'value'</span><span class="p">:</span> <span class="s">'5'</span><span class="p">,</span>
                                           <span class="s">'format'</span><span class="p">:</span> <span class="n">format2</span><span class="p">})</span>

<span class="c"># Highlight the bottom 5 values in Red</span>
<span class="n">worksheet</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="n">color_range</span><span class="p">,</span> <span class="p">{</span><span class="s">'type'</span><span class="p">:</span> <span class="s">'bottom'</span><span class="p">,</span>
                                           <span class="s">'value'</span><span class="p">:</span> <span class="s">'5'</span><span class="p">,</span>
                                           <span class="s">'format'</span><span class="p">:</span> <span class="n">format1</span><span class="p">})</span>

<span class="n">writer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
<p>There is much more to explore but this quick overview should give you some
good ideas about making pandas’ Excel output that much more useful.</p>
</div>

  </div></body></html>