<html><body><div><div class="entry-content">
                
                <h1>Introduction</h1>
<p>For some of us at <a href="http://www.bartlett.ucl.ac.uk/casa"><span class="caps">CASA</span></a> (and, presumably, elsewhere), conversion from decimal longitude and latitude coordinates to <a href="https://www.ordnancesurvey.co.uk/resources/maps-and-geographic-resources/the-national-grid.html"><span class="caps">BNG</span></a> (British National Grid) coordinates is a daily occurrence. A few years ago, I was looking for a function to accomplish this in Python, and found this serendipitous <a href="http://www.hannahfry.co.uk/blog/2012/02/01/converting-british-national-grid-to-latitude-and-longitude-ii">post</a> by my splendid colleague Dr Hannah Fry, which provided an implementation. This function has subsequently found its way into several projects<sup id="sf-rust-python-ffi-bng-1-back"><a href="#sf-rust-python-ffi-bng-1" class="simple-footnote" title="Let’s pause for a moment to consider the vast amount of computational resources which were expended upon the search which returned this result to me, and how much more efficient it would have been for me to simply walk ten metres and utter the words “Has anyone implemented lon lat to BNG conversion in Python before?”. Food for thought.">1</a></sup>.  </p>
<h1>Motivation</h1>
<p>I do most of my <a href="https://github.com/urschrei/pyzotero">programming</a> and <a href="https://github.com/urschrei/Geopython">data analysis</a> in Python, and the speed conferred by e.g. Numpy means that there’s rarely any need to implement more exotic solutions. Where projection conversions are concerned, there are many excellent libraries which wrap <a href="https://en.wikipedia.org/wiki/PROJ.4"><span class="caps">PROJ</span>.4</a>, which, after 20 years, is a mature, performant library. As a result, my knowledge of C (let alone C++) is so rudimentary as to be downright dangerous<sup id="sf-rust-python-ffi-bng-2-back"><a href="#sf-rust-python-ffi-bng-2" class="simple-footnote" title="Also, the internecine schism between various factions of C adherents — with their forthright opinions on how best to learn the language — frankly make me want to lie down in a darkened room, preferably forever.">2</a></sup>.</p>
<h1>Ousterhout’s Dichotomy</h1>
<p>And yet. Sometimes curiosity trumps caution. I’ve been keeping an eye on a new programming language called <a href="http://www.rust-lang.org">Rust</a> for several years now, awaiting its stabilisation with a 1.0 release.
Rust’s inventor, Graydon Hoare, has written <a href="http://graydon2.dreamwidth.org/3186.html">at length</a> about something he refers to as “Ousterhout’s Dichotomy”. Briefly, it states that</p>
<blockquote>
<p>The cultures of batch and interactive computing are the ends of a spectrum, and most real computing systems embody a mixture of the two. Most batch systems require some degree of <strong>interactive reconfiguration</strong>; and most interactive systems have some very stable parts of their logic that benefit from going <strong>as fast as possible</strong>. [this gives rise to] Systems composed of exactly two languages, one “systems” language and one “script” language, with the former coding the inner loops and the latter coding the outer loops, and hooked up to the <span class="caps">REPL</span> to talk to the human operator.<br/>
That is, the tension between human- and machine-oriented computing is often not mediated by a single language, but two specialized languages with some (kinda gruesome) bridging device between the two that nobody much wants to think about, and everyone wishes would go away.</p>
</blockquote>
<h1>Rust</h1>
<p>Rust is a systems programming language. I’m not aware of a consensus around the term, but Wikipedia does a <a href="https://en.wikipedia.org/wiki/System_programming">reasonable job</a> of sketching out some of the features, though it also makes some outlandish claims regarding debuggers. But I digress. Systems programming languages are concerned with speed and efficiency, as a result of which the programmer usually has to concern herself with the management of memory, and be familiar with the distinction between <a href="https://doc.rust-lang.org/book/the-stack-and-the-heap.html">the heap and the stack</a>, and pointers. As a more-or-less direct consequence of this, systems languages offer many more opportunities for errors which can produce <a href="http://heartbleed.com">catastrophic</a> results due to leaking references, null or dangling pointers, and many other mistakes which occur as a direct result of their <em>design</em>.<br/>
Rust aims to change this, citing “safety, speed, and concurrency” as its primary goals.<br/>
In order to accomplish this, Rust implements something called “compile-time borrow-checking”, a mechanism composed of three related concepts:</p>
<ul>
<li><a href="https://doc.rust-lang.org/book/ownership.html#ownership">Ownership</a>: variables “own” the resources to which they are bound. When that binding goes out of scope, so does the resource</li>
<li><a href="https://doc.rust-lang.org/book/references-and-borrowing.html#borrowing">Borrowing</a>: a variable may “lend” that bound resource to another variable. This resource may be lent many times <em>immutably</em>, <strong>or</strong> once <em>mutably</em>. This is unfamiliar territory to someone who’s used to programming in Python, or Ruby, or <span class="caps">JS</span>, and yet, once grasped, the system is both relatively straightforward to use, and very <a href="https://doc.rust-lang.org/book/references-and-borrowing.html#issues-borrowing-prevents">effective</a> at preventing commonly-seen problems  </li>
<li><a href="https://doc.rust-lang.org/book/lifetimes.html#lifetimes">Lifetimes</a>: the concept of borrowing introduces additional complexity, if Rust’s primary goal (safety) is to be maintained: we have to ensure that resources aren’t freed while they’re still being borrowed. This involves some work on the part of the compiler, and some work on the part of the programmer.  </li>
</ul>
<p>In addition to these complex, interesting innovations, Rust-the-language provides many modern conveniences such as iterators, enums, and exhaustive case analysis — as well as operations from the functional programming world such as <code>map()</code> and <code>fold()</code> — which make it pleasant to use. In addition, its <a href="https://en.wikipedia.org/wiki/Algebraic_data_type">algebraic data types</a> make it <a href="http://unconj.ca/blog/expressing-l-systems-in-rust.html">well-suited for the expression of l-systems</a>, which is of particular interest to those undertaking spatial simulation and modelling.</p>
<h1>The Conversion Algorithm</h1>
<p>Let’s have a look at the conversion algorithm, implemented in Rust 1.x (I’ve split some of the longer lines):</p>
<div class="highlight"><pre><span class="k">fn</span><span class="w"> </span><span class="n">convert</span><span class="p">(</span><span class="n">input_lon</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="n">input_lat</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">input_lon</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="o">-</span><span class="mf">180.0</span><span class="p">...</span><span class="mf">180.0</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">input_lon</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">panic</span><span class="o">!</span><span class="p">(</span><span class="s">"Out of bounds! Longitude must be between -180.00 and 180.00: {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">input_lon</span><span class="p">)</span><span class="w"/>
<span class="w">    </span><span class="p">};</span><span class="w"/>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">input_lat</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="o">-</span><span class="mf">90.0</span><span class="p">...</span><span class="mf">90.0</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">input_lat</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">panic</span><span class="o">!</span><span class="p">(</span><span class="s">"Out of bounds! Latitude must be between -90.00 and 90.00: {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">input_lat</span><span class="p">)</span><span class="w"/>
<span class="w">    </span><span class="p">};</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">pi</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">consts</span><span class="o">::</span><span class="n">PI</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="c1">//Convert input to degrees</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">lat_1</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input_lat</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pi</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">180.</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">lon_1</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input_lon</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pi</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">180.</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="c1">// The GSR80 semi-major and semi-minor axes used for WGS84 (m)</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a_1</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">6378137.</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">b_1</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">6356752.3141</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="c1">// The eccentricity (squared) of the GRS80 ellipsoid</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">e2_1</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">b_1</span><span class="p">.</span><span class="n">powf</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">a_1</span><span class="p">.</span><span class="n">powf</span><span class="p">(</span><span class="mf">2.</span><span class="p">));</span><span class="w"/>
<span class="w">    </span><span class="c1">// Transverse radius of curvature</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">nu_1</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a_1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">1.</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">e2_1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lat_1</span><span class="p">.</span><span class="n">sin</span><span class="p">().</span><span class="n">powf</span><span class="p">(</span><span class="mf">2.</span><span class="p">)).</span><span class="n">sqrt</span><span class="p">();</span><span class="w"/>
<span class="w">    </span><span class="c1">// Third spherical coordinate is 0, in this case</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">H</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x_1</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">nu_1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">H</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lat_1</span><span class="p">.</span><span class="n">cos</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lon_1</span><span class="p">.</span><span class="n">cos</span><span class="p">();</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">y_1</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">nu_1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">H</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lat_1</span><span class="p">.</span><span class="n">cos</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lon_1</span><span class="p">.</span><span class="n">sin</span><span class="p">();</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">z_1</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="mf">1.</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">e2_1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">nu_1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">H</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lat_1</span><span class="p">.</span><span class="n">sin</span><span class="p">();</span><span class="w"/>
<span class="w">    </span><span class="c1">// Perform Helmert transform (to go between Airy 1830 (_1) and GRS80 (_2))</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">small</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">10.</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">cst</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">20.4894</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">s</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">cst</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">small</span><span class="p">.</span><span class="n">powf</span><span class="p">(</span><span class="o">-</span><span class="mf">6.</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="c1">// The translations along x, y, z axes respectively</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">tx</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">446.448</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">ty</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">125.157</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">tz</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">542.060</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="c1">// The rotations along x, y, z respectively, in seconds</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">rxs</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">0.1502</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">rys</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">0.2470</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">rzs</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">0.8421</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="c1">// In radians</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">rx</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rxs</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pi</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">180.</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">3600.</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">ry</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rys</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pi</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">180.</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">3600.</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">rz</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rzs</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pi</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">180.</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">3600.</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x_2</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mf">1.</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x_1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">-</span><span class="n">rz</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y_1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ry</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">z_1</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">y_2</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rz</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x_1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mf">1.</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y_1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">-</span><span class="n">rx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">z_1</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">z_2</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tz</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">-</span><span class="n">ry</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x_1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y_1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mf">1.</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">z_1</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="c1">// The GSR80 semi-major and semi-minor axes used for WGS84 (m)</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">6377563.396</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">6356256.909</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="c1">// The eccentricity of the Airy 1830 ellipsoid</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">e2</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">powf</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">powf</span><span class="p">(</span><span class="mf">2.</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">p</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">x_2</span><span class="p">.</span><span class="n">powf</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y_2</span><span class="p">.</span><span class="n">powf</span><span class="p">(</span><span class="mf">2.</span><span class="p">)).</span><span class="n">sqrt</span><span class="p">();</span><span class="w"/>
<span class="w">    </span><span class="c1">// Initial value</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">lat</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z_2</span><span class="p">.</span><span class="n">atan2</span><span class="p">((</span><span class="n">p</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">1.</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">e2</span><span class="p">)));</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">latold</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pi</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="c1">// this is cheating, but not sure how else to initialise nu</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">nu</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="c1">// Latitude is obtained by iterative procedure</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">lat</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">latold</span><span class="p">).</span><span class="n">abs</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">small</span><span class="p">.</span><span class="n">powf</span><span class="p">(</span><span class="o">-</span><span class="mf">16.</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="n">mem</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">latold</span><span class="p">);</span><span class="w"/>
<span class="w">        </span><span class="n">nu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">1.</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">e2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latold</span><span class="p">.</span><span class="n">sin</span><span class="p">().</span><span class="n">powf</span><span class="p">(</span><span class="mf">2.</span><span class="p">)).</span><span class="n">sqrt</span><span class="p">();</span><span class="w"/>
<span class="w">        </span><span class="n">lat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">z_2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">nu</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latold</span><span class="p">.</span><span class="n">sin</span><span class="p">()).</span><span class="n">atan2</span><span class="p">(</span><span class="n">p</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="p">};</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">lon</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y_2</span><span class="p">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">x_2</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="c1">// Scale factor on the central meridian</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">F0</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.9996012717</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="c1">// Latitude of true origin (radians)</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">lat0</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">49.</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pi</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">180.</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="c1">// Longtitude of true origin and central meridian (radians)</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">lon0</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">2.</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pi</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">180.</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="c1">// Northing &amp; easting of true origin (m)</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">N0</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">100000.</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">E0</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">400000.</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">n</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="c1">// Meridional radius of curvature</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">rho</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">F0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">1.</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">e2</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">1.</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">e2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lat</span><span class="p">.</span><span class="n">sin</span><span class="p">().</span><span class="n">powf</span><span class="p">(</span><span class="mf">2.</span><span class="p">)).</span><span class="n">powf</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">eta2</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nu</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">F0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">rho</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">M1</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">1.</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mf">5.</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">4.</span><span class="p">)</span><span class="w"> </span>
<span class="w">                    </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="n">powf</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span><span class="w"/>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mf">5.</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">4.</span><span class="p">)</span><span class="w"/>
<span class="w">                    </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="n">powf</span><span class="p">(</span><span class="mf">3.</span><span class="p">))</span><span class="w"/>
<span class="w">                    </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">lat</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lat0</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">M2</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">3.</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">3.</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="n">powf</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span><span class="w"> </span>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mf">21.</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">8.</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="n">powf</span><span class="p">(</span><span class="mf">3.</span><span class="p">))</span><span class="w"/>
<span class="w">                    </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">lat</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lat0</span><span class="p">).</span><span class="n">sin</span><span class="p">()</span><span class="w"/>
<span class="w">                    </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">lat</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">lat0</span><span class="p">).</span><span class="n">cos</span><span class="p">();</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">M3</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="mf">15.</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">8.</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="n">powf</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mf">15.</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">8.</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="n">powf</span><span class="p">(</span><span class="mf">3.</span><span class="p">))</span><span class="w"/>
<span class="w">                    </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">2.</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">lat</span><span class="o">-</span><span class="n">lat0</span><span class="p">)).</span><span class="n">sin</span><span class="p">()</span><span class="w"/>
<span class="w">                    </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">2.</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">lat</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">lat0</span><span class="p">)).</span><span class="n">cos</span><span class="p">();</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">M4</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">35.</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">24.</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="n">powf</span><span class="p">(</span><span class="mf">3.</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">3.</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">lat</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lat0</span><span class="p">)).</span><span class="n">sin</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">3.</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">lat</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">lat0</span><span class="p">)).</span><span class="n">cos</span><span class="p">();</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">M</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">F0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">M1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">M2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">M3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">M4</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">I</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">N0</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">II</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nu</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">F0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lat</span><span class="p">.</span><span class="n">sin</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lat</span><span class="p">.</span><span class="n">cos</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">III</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nu</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">F0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lat</span><span class="p">.</span><span class="n">sin</span><span class="p">()</span><span class="w"/>
<span class="w">                    </span><span class="o">*</span><span class="w"> </span><span class="n">lat</span><span class="p">.</span><span class="n">cos</span><span class="p">().</span><span class="n">powf</span><span class="p">(</span><span class="mf">3.</span><span class="p">)</span><span class="w"/>
<span class="w">                    </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">5.</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lat</span><span class="p">.</span><span class="n">tan</span><span class="p">().</span><span class="n">powf</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span><span class="w"/>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="mf">9.</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">eta2</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">24.</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">IIIA</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nu</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">F0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lat</span><span class="p">.</span><span class="n">sin</span><span class="p">()</span><span class="w"/>
<span class="w">                    </span><span class="o">*</span><span class="w"> </span><span class="n">lat</span><span class="p">.</span><span class="n">cos</span><span class="p">().</span><span class="n">powf</span><span class="p">(</span><span class="mf">5.</span><span class="p">)</span><span class="w"/>
<span class="w">                    </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">61.</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">58.</span><span class="w"/>
<span class="w">                    </span><span class="o">*</span><span class="w"> </span><span class="n">lat</span><span class="p">.</span><span class="n">tan</span><span class="p">().</span><span class="n">powf</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span><span class="w"/>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">lat</span><span class="p">.</span><span class="n">tan</span><span class="p">().</span><span class="n">powf</span><span class="p">(</span><span class="mf">4.</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">720.</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">IV</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nu</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">F0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lat</span><span class="p">.</span><span class="n">cos</span><span class="p">();</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">V</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nu</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">F0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lat</span><span class="p">.</span><span class="n">cos</span><span class="p">().</span><span class="n">powf</span><span class="p">(</span><span class="mf">3.</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">nu</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">rho</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lat</span><span class="p">.</span><span class="n">tan</span><span class="p">().</span><span class="n">powf</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">6.</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">VI</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nu</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">F0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lat</span><span class="p">.</span><span class="n">cos</span><span class="p">().</span><span class="n">powf</span><span class="p">(</span><span class="mf">5.</span><span class="p">)</span><span class="w"/>
<span class="w">                    </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">5.</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">18.</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lat</span><span class="p">.</span><span class="n">tan</span><span class="p">().</span><span class="n">powf</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span><span class="w"/>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">lat</span><span class="p">.</span><span class="n">tan</span><span class="p">().</span><span class="n">powf</span><span class="p">(</span><span class="mf">4.</span><span class="p">)</span><span class="w"/>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="mf">14.</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">eta2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">58.</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">eta2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lat</span><span class="p">.</span><span class="n">tan</span><span class="p">().</span><span class="n">powf</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">120.</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">N</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">II</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">lon</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lon0</span><span class="p">).</span><span class="n">powf</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span><span class="w"/>
<span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">III</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">lon</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lon0</span><span class="p">).</span><span class="n">powf</span><span class="p">(</span><span class="mf">4.</span><span class="p">)</span><span class="w"/>
<span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">IIIA</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">lon</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lon0</span><span class="p">).</span><span class="n">powf</span><span class="p">(</span><span class="mf">6.</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">E</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">E0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">IV</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">lon</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lon0</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">lon</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lon0</span><span class="p">).</span><span class="n">powf</span><span class="p">(</span><span class="mf">3.</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">VI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">lon</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lon0</span><span class="p">).</span><span class="n">powf</span><span class="p">(</span><span class="mf">5.</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="p">(</span><span class="n">round</span><span class="p">(</span><span class="n">E</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">round</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</pre></div>


<p>As can be seen from the function signature, it accepts two 32-bit floating-point numbers (longitude and latitude), and returns a tuple of two 32-bit integers (the rounded <span class="caps">BNG</span> Eastings and Northings). Broadly speaking, this looks like any function in any other (modern) programming language; no strange notation or symbols, function names hint at functionality (e.g. <code>powf()</code> raises a floating-point number to a floating-point power).<br/>
Only three things stand out: the two <code>match()</code> expressions, which are used for bounds checking, the distinction between <code>let</code> and <code>let mut</code>, and the type annotations. The latter isn’t always necessary (the compiler can often infer the correct type), but in this case, I’ve been explicit.<br/>
So far, so good. We have a working conversion function. But how much faster is it? The Python version runs in about 6.89 <a href="https://en.wikipedia.org/wiki/Microsecond">µs</a> on my machine. The rust version runs about 15x faster, in 0.45 µs. These numbers are so small (6 <em>millionths</em> of a second) that an order-of-magnitude improvement is essentially meaningless. Let’s use a somewhat more realistic test: converting ten million pairs of lon, lat points to <span class="caps">BNG</span> Eastings and Northings.</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="c"># UK bounding box</span>
<span class="n">N</span> <span class="o">=</span> <span class="mf">55.811741</span>
<span class="n">E</span> <span class="o">=</span> <span class="mf">1.768960</span>
<span class="n">S</span> <span class="o">=</span> <span class="mf">49.871159</span>
<span class="n">W</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.379880</span>

<span class="n">lon_ls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="p">[</span><span class="mi">1000000</span><span class="p">]))</span>
<span class="n">lat_ls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="p">[</span><span class="mi">1000000</span><span class="p">]))</span>

<span class="o">%</span><span class="n">timeit</span>
<span class="p">[</span><span class="n">bng</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">)</span> <span class="k">for</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lat_ls</span><span class="p">,</span> <span class="n">lon_ls</span><span class="p">)]</span>

<span class="mi">1</span> <span class="n">loops</span><span class="p">,</span> <span class="n">best</span> <span class="n">of</span> <span class="mi">3</span><span class="p">:</span> <span class="mf">5.26</span> <span class="n">s</span> <span class="n">per</span> <span class="n">loop</span>
</pre></div>


<p>This is pretty fast in wall-clock terms, which is to be expected, considering that Python’s core mathematical functions are mostly C-based anyway, but I think Rust can do better. But wait, isn’t there a trade-off? If I use the Python version, I have the convenience of working in a <a href="https://jupyter.org">Jupyter</a> (formerly IPython) notebook, with separately-executable cells, interactive visualisation tools, and built-in debugging. Cast your mind back to Graydon’s discussion of Ousterhout’s Dichotomy. Recall him mentioning “some (kinda gruesome) bridging device between the two that nobody much wants to think about, and everyone wishes would go away”. That bridging device is <span class="caps">FFI</span>.</p>
<h1><span class="caps">FFI</span></h1>
<p>A foreign function interface (<span class="caps">FFI</span>) is “a mechanism by which a program written in one programming language can call routines or make use of services written in another”<sup id="sf-rust-python-ffi-bng-3-back"><a href="#sf-rust-python-ffi-bng-3" class="simple-footnote" title="https://en.wikipedia.org/wiki/Foreign_function_interface">3</a></sup>.<br/>
The mechanism, in this case, is a library called <a href="https://docs.python.org/2/library/ctypes.html">ctypes</a>. Let’s define a link to our Rust library:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="n">cdll</span><span class="p">,</span> <span class="n">c_float</span><span class="p">,</span> <span class="n">Structure</span><span class="p">,</span> <span class="n">ARRAY</span><span class="p">,</span> <span class="n">POINTER</span><span class="p">,</span> <span class="n">c_int32</span><span class="p">,</span> <span class="n">c_uint32</span><span class="p">,</span> <span class="n">c_size_t</span><span class="p">,</span> <span class="n">c_void_p</span><span class="p">,</span> <span class="n">cast</span>

<span class="n">lib</span> <span class="o">=</span> <span class="n">cdll</span><span class="o">.</span><span class="n">LoadLibrary</span><span class="p">(</span><span class="s">'target/release/liblonlat_bng.dylib'</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FFITuple</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[(</span><span class="s">"a"</span><span class="p">,</span> <span class="n">c_uint32</span><span class="p">),</span>
                <span class="p">(</span><span class="s">"b"</span><span class="p">,</span> <span class="n">c_uint32</span><span class="p">)]</span>

<span class="k">class</span> <span class="nc">FFIArray</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[(</span><span class="s">"data"</span><span class="p">,</span> <span class="n">c_void_p</span><span class="p">),</span>
                <span class="p">(</span><span class="s">"len"</span><span class="p">,</span> <span class="n">c_size_t</span><span class="p">)]</span>

    <span class="c"># Allow implicit conversions from a sequence of 32-bit unsigned</span>
    <span class="c"># integers.</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_param</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">seq</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">seq</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">cls</span><span class="p">)</span> <span class="k">else</span> <span class="n">cls</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>

    <span class="c"># Wrap sequence of values. You can specify another type besides a</span>
    <span class="c"># 32-bit unsigned integer.</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">data_type</span> <span class="o">=</span> <span class="n">c_float</span><span class="p">):</span>
        <span class="n">array_type</span> <span class="o">=</span> <span class="n">data_type</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
        <span class="n">raw_seq</span> <span class="o">=</span> <span class="n">array_type</span><span class="p">(</span><span class="o">*</span><span class="n">seq</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">raw_seq</span><span class="p">,</span> <span class="n">c_void_p</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>

<span class="c"># A conversion function that cleans up the result value to make it</span>
<span class="c"># nicer to consume.</span>
<span class="k">def</span> <span class="nf">void_array_to_tuple_list</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">_func</span><span class="p">,</span> <span class="n">_args</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">POINTER</span><span class="p">(</span><span class="n">FFITuple</span> <span class="o">*</span> <span class="n">array</span><span class="o">.</span><span class="n">len</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

<span class="c"># Single-threaded</span>
<span class="n">convert_vec</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">convert_vec_c</span>
<span class="n">convert_vec</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">(</span><span class="n">FFIArray</span><span class="p">,</span> <span class="n">FFIArray</span><span class="p">)</span>
<span class="n">convert_vec</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">FFIArray</span>
<span class="n">convert_vec</span><span class="o">.</span><span class="n">errcheck</span> <span class="o">=</span> <span class="n">void_array_to_tuple_list</span>
</pre></div>


<p>This code requires a little explanation: because <code>ctypes</code> was originally written to interface with C, it expects and provides C-like data structures. Note the definition of <code>FFITuple</code> and <code>FFIArray</code>. In an ideal world, the module would be aware of Rust’s vector and tuple types, but alas, it isn’t. However, all is not lost, since it’s relatively straightforward to implement the corresponding types in our Rust library in a safe manner:</p>
<div class="highlight"><pre><span class="k">extern</span><span class="w"> </span><span class="n">crate</span><span class="w"> </span><span class="n">libc</span><span class="p">;</span><span class="w"/>
<span class="kn">use</span><span class="w"> </span><span class="n">libc</span><span class="o">::</span><span class="p">{</span><span class="n">size_t</span><span class="p">,</span><span class="w"> </span><span class="n">c_void</span><span class="p">,</span><span class="w"> </span><span class="n">uint32_t</span><span class="p">};</span><span class="w"/>

<span class="cp">#[repr(C)]</span><span class="w"/>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="n">Tuple</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="n">a</span><span class="o">:</span><span class="w"> </span><span class="n">uint32_t</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="n">uint32_t</span><span class="p">,</span><span class="w"/>
<span class="p">}</span><span class="w"/>

<span class="cp">#[repr(C)]</span><span class="w"/>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="n">Array</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="n">data</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="kr">const</span><span class="w"> </span><span class="n">c_void</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="n">len</span><span class="o">:</span><span class="w"> </span><span class="n">libc</span><span class="o">::</span><span class="n">size_t</span><span class="p">,</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</pre></div>


<p>Next, we provide some mechanisms for the conversion between these primitive structures and Rust’s richer structures:</p>
<div class="highlight"><pre><span class="k">impl</span><span class="w"> </span><span class="n">Array</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">as_f32_slice</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="kt">f32</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="n">assert</span><span class="o">!</span><span class="p">(</span><span class="o">!</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">is_null</span><span class="p">());</span><span class="w"/>
<span class="w">        </span><span class="n">slice</span><span class="o">::</span><span class="n">from_raw_parts</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="kr">const</span><span class="w"> </span><span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">usize</span><span class="p">)</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">as_i32_slice</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="kt">i32</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="n">assert</span><span class="o">!</span><span class="p">(</span><span class="o">!</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">is_null</span><span class="p">());</span><span class="w"/>
<span class="w">        </span><span class="n">slice</span><span class="o">::</span><span class="n">from_raw_parts</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="kr">const</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">usize</span><span class="p">)</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="n">from_vec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">vec</span><span class="o">:</span><span class="w"> </span><span class="n">Vec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Array</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="c1">// ensure that length and capacity match</span>
<span class="w">        </span><span class="n">vec</span><span class="p">.</span><span class="n">shrink_to_fit</span><span class="p">();</span><span class="w"/>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Array</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">            </span><span class="n">data</span><span class="o">:</span><span class="w"> </span><span class="n">vec</span><span class="p">.</span><span class="n">as_ptr</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="kr">const</span><span class="w"> </span><span class="n">libc</span><span class="o">::</span><span class="n">c_void</span><span class="p">,</span><span class="w"/>
<span class="w">            </span><span class="n">len</span><span class="o">:</span><span class="w"> </span><span class="n">vec</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">libc</span><span class="o">::</span><span class="n">size_t</span><span class="w"/>
<span class="w">        </span><span class="p">};</span><span class="w"/>

<span class="w">        </span><span class="n">mem</span><span class="o">::</span><span class="n">forget</span><span class="p">(</span><span class="n">vec</span><span class="p">);</span><span class="w"/>
<span class="w">        </span><span class="n">array</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</pre></div>


<p>Let’s define our wrapper and interface function:</p>
<div class="highlight"><pre><span class="cp">#[no_mangle]</span><span class="w"/>
<span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">convert_vec_c</span><span class="p">(</span><span class="n">lon</span><span class="o">:</span><span class="w"> </span><span class="n">Array</span><span class="p">,</span><span class="w"> </span><span class="n">lat</span><span class="o">:</span><span class="w"> </span><span class="n">Array</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Array</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="c1">// we're receiving floats</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">lon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">lon</span><span class="p">.</span><span class="n">as_f32_slice</span><span class="p">()</span><span class="w"> </span><span class="p">};</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">lat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">lat</span><span class="p">.</span><span class="n">as_f32_slice</span><span class="p">()</span><span class="w"> </span><span class="p">};</span><span class="w"/>
<span class="w">    </span><span class="c1">// copy values and combine</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">orig</span><span class="o">:</span><span class="w"> </span><span class="n">Vec</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="kt">f32</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lon</span><span class="w"/>
<span class="w">        </span><span class="p">.</span><span class="n">iter</span><span class="p">()</span><span class="w"/>
<span class="w">        </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">i</span><span class="o">|</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">clone</span><span class="p">())</span><span class="w"/>
<span class="w">        </span><span class="p">.</span><span class="n">collect</span><span class="o">::&lt;</span><span class="n">Vec</span><span class="o">&lt;</span><span class="kt">f32</span><span class="o">&gt;&gt;</span><span class="p">()</span><span class="w"/>
<span class="w">        </span><span class="p">.</span><span class="n">into_iter</span><span class="p">()</span><span class="w"/>
<span class="w">    </span><span class="p">.</span><span class="n">zip</span><span class="p">(</span><span class="n">lat</span><span class="w"/>
<span class="w">        </span><span class="p">.</span><span class="n">iter</span><span class="p">()</span><span class="w"/>
<span class="w">        </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">i</span><span class="o">|</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">clone</span><span class="p">())</span><span class="w"/>
<span class="w">        </span><span class="p">.</span><span class="n">collect</span><span class="o">::&lt;</span><span class="n">Vec</span><span class="o">&lt;</span><span class="kt">f32</span><span class="o">&gt;&gt;</span><span class="p">()</span><span class="w"/>
<span class="w">    </span><span class="p">.</span><span class="n">into_iter</span><span class="p">()).</span><span class="n">collect</span><span class="p">();</span><span class="w"/>
<span class="w">    </span><span class="c1">// carry out the conversion </span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="o">:</span><span class="w"> </span><span class="n">Vec</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="p">.</span><span class="n">iter</span><span class="p">()</span><span class="w"/>
<span class="w">        </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">elem</span><span class="o">|</span><span class="w"> </span><span class="n">convert</span><span class="p">(</span><span class="n">elem</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">elem</span><span class="p">.</span><span class="mi">1</span><span class="p">))</span><span class="w"/>
<span class="w">        </span><span class="p">.</span><span class="n">collect</span><span class="p">();</span><span class="w"/>
<span class="w">    </span><span class="c1">// convert back to vector of unsigned integer Tuples</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">nvec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">iter</span><span class="p">()</span><span class="w"/>
<span class="w">        </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">ints</span><span class="o">|</span><span class="w"> </span><span class="n">Tuple</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">a</span><span class="o">:</span><span class="w"> </span><span class="n">ints</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="n">ints</span><span class="p">.</span><span class="mi">1</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="p">})</span><span class="w"/>
<span class="w">        </span><span class="p">.</span><span class="n">collect</span><span class="p">();</span><span class="w"/>
<span class="w">    </span><span class="n">Array</span><span class="o">::</span><span class="n">from_vec</span><span class="p">(</span><span class="n">nvec</span><span class="p">)</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</pre></div>


<p>Note the <code>no-mangle</code> and <code>extern</code> directives. These ensure that the function can be called using the name defined in the source code, and that it is to be externally accessible.<br/>
The function:</p>
<ul>
<li>Accepts two <code>Array</code>s of longitude and latitude values across the <span class="caps">FFI</span> boundary</li>
<li>Converts them to <code>slice</code>s</li>
<li>Combines the <code>slice</code>s into a <code>vector</code> of lon, lat tuples</li>
<li>Maps our previously-defined <code>convert()</code> function over the <code>vector</code>, returning a <code>vector</code> of integer tuples</li>
<li>converts that vector back to an <code>Array</code> of <code>Tuple</code>s</li>
<li>returns the <code>Array</code> back across the <span class="caps">FFI</span> boundary.</li>
</ul>
<p>But how fast does it run?</p>
<div class="highlight"><pre><span class="c">%%timeit </span>
<span class="n">convertbng</span><span class="p">(</span><span class="n">lon_ls</span><span class="p">,</span> <span class="n">lat_ls</span><span class="p">)</span>
<span class="mi">1</span> <span class="n">loops</span><span class="p">,</span> <span class="n">best</span> <span class="n">of</span> <span class="mi">3</span><span class="p">:</span> <span class="mf">1.41</span> <span class="n">s</span> <span class="n">per</span> <span class="n">loop</span>
</pre></div>


<p>A 3.7x speedup. Pretty good, but still over one second. Bear in mind that <code>ctypes</code> adds some overhead. If I weren’t so lazy, I’d benchmark the million-point conversion in Rust directly, but that wouldn’t be a particularly meaningful comparison; we’ve already proved that Rust is faster, using science and charts. Nevertheless, the question remains: can we do better? Perhaps.</p>
<h2>Threading</h2>
<p>It turns out that a side-effect (<a href="http://graydon2.dreamwidth.org/201806.html">entirely intentional</a>, according to Graydon) of Rust’s safety guarantees is that concurrent programs can be written without a great deal of the uncertainty and morbid fear which usually attends such endeavours. The benefits of concurrency are beyond the scope of this already-exhausting exposition, and their elucidation is left as an exercise for the reader. Suffice to say that safe, easy, concurrent programming is of great benefit to us. But enough exposition:</p>
<div class="highlight"><pre><span class="kr">const</span><span class="w"> </span><span class="n">NUMTHREADS</span><span class="o">:</span><span class="w"> </span><span class="n">usize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span><span class="w"/>
<span class="kn">use</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">thread</span><span class="o">::</span><span class="p">{</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">JoinHandle</span><span class="p">};</span><span class="w"/>

<span class="cp">#[no_mangle]</span><span class="w"/>
<span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">convert_vec_c_threaded</span><span class="p">(</span><span class="n">lon</span><span class="o">:</span><span class="w"> </span><span class="n">Array</span><span class="p">,</span><span class="w"> </span><span class="n">lat</span><span class="o">:</span><span class="w"> </span><span class="n">Array</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Array</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="c1">// we're receiving floats</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">lon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">lon</span><span class="p">.</span><span class="n">as_f32_slice</span><span class="p">()</span><span class="w"> </span><span class="p">};</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">lat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">lat</span><span class="p">.</span><span class="n">as_f32_slice</span><span class="p">()</span><span class="w"> </span><span class="p">};</span><span class="w"/>
<span class="w">    </span><span class="c1">// copy values and combine</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">orig</span><span class="o">:</span><span class="w"> </span><span class="n">Vec</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="kt">f32</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lon</span><span class="w"/>
<span class="w">        </span><span class="p">.</span><span class="n">iter</span><span class="p">()</span><span class="w"/>
<span class="w">        </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">i</span><span class="o">|</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">clone</span><span class="p">())</span><span class="w"/>
<span class="w">        </span><span class="p">.</span><span class="n">collect</span><span class="o">::&lt;</span><span class="n">Vec</span><span class="o">&lt;</span><span class="kt">f32</span><span class="o">&gt;&gt;</span><span class="p">()</span><span class="w"/>
<span class="w">        </span><span class="p">.</span><span class="n">into_iter</span><span class="p">()</span><span class="w"/>
<span class="w">    </span><span class="p">.</span><span class="n">zip</span><span class="p">(</span><span class="n">lat</span><span class="w"/>
<span class="w">        </span><span class="p">.</span><span class="n">iter</span><span class="p">()</span><span class="w"/>
<span class="w">        </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">i</span><span class="o">|</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">clone</span><span class="p">())</span><span class="w"/>
<span class="w">        </span><span class="p">.</span><span class="n">collect</span><span class="o">::&lt;</span><span class="n">Vec</span><span class="o">&lt;</span><span class="kt">f32</span><span class="o">&gt;&gt;</span><span class="p">()</span><span class="w"/>
<span class="w">    </span><span class="p">.</span><span class="n">into_iter</span><span class="p">()).</span><span class="n">collect</span><span class="p">();</span><span class="w"/>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">guards</span><span class="o">:</span><span class="w"> </span><span class="n">Vec</span><span class="o">&lt;</span><span class="n">JoinHandle</span><span class="o">&lt;</span><span class="n">Vec</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vec</span><span class="o">!</span><span class="p">();</span><span class="w"/>
<span class="w">    </span><span class="c1">// split into slices</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">NUMTHREADS</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">orig</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">NUMTHREADS</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="c1">// if orig.len() == 0, we need another adjustment</span>
<span class="w">    </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">cmp</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">chunk</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">orig</span><span class="p">.</span><span class="n">chunks</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">chunk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunk</span><span class="p">.</span><span class="n">to_owned</span><span class="p">();</span><span class="w"/>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thread</span><span class="o">::</span><span class="nb">spawn</span><span class="p">(</span><span class="n">move</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">chunk</span><span class="w"/>
<span class="w">            </span><span class="p">.</span><span class="n">into_iter</span><span class="p">()</span><span class="w"/>
<span class="w">            </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">elem</span><span class="o">|</span><span class="w"> </span><span class="n">convert</span><span class="p">(</span><span class="n">elem</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">elem</span><span class="p">.</span><span class="mi">1</span><span class="p">))</span><span class="w"/>
<span class="w">            </span><span class="p">.</span><span class="n">collect</span><span class="p">());</span><span class="w"/>
<span class="w">        </span><span class="n">guards</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">g</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">result</span><span class="o">:</span><span class="w"> </span><span class="n">Vec</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Vec</span><span class="o">::</span><span class="n">with_capacity</span><span class="p">(</span><span class="n">orig</span><span class="p">.</span><span class="n">len</span><span class="p">());</span><span class="w"/>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">g</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">guards</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="n">result</span><span class="p">.</span><span class="n">extend</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">join</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">into_iter</span><span class="p">());</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="c1">// convert back to vector of unsigned integer Tuples</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">nvec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">iter</span><span class="p">()</span><span class="w"/>
<span class="w">        </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">ints</span><span class="o">|</span><span class="w"> </span><span class="n">Tuple</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">a</span><span class="o">:</span><span class="w"> </span><span class="n">ints</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="n">ints</span><span class="p">.</span><span class="mi">1</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="p">})</span><span class="w"/>
<span class="w">        </span><span class="p">.</span><span class="n">collect</span><span class="p">();</span><span class="w"/>
<span class="w">    </span><span class="n">Array</span><span class="o">::</span><span class="n">from_vec</span><span class="p">(</span><span class="n">nvec</span><span class="p">)</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</pre></div>


<p>This function is extremely similar to <code>convert_vec_c</code>, but note what happens after we’ve created <code>orig</code>:</p>
<ul>
<li>define a mutable <a href="https://doc.rust-lang.org/std/thread/struct.JoinHandle.html"><code>JoinHandle</code></a> vector, which will hold the results of our threaded computations</li>
<li>determine the size of the chunks into which <code>orig</code> will be split, according to the number of threads we’d like to spawn</li>
<li>split <code>orig</code> into chunks, and for each chunk:<ul>
<li>spawn a thread, and in it:<ul>
<li>clone the chunk</li>
<li>map our <code>convert</code> function over it</li>
</ul>
</li>
<li>push the resulting vector into our <code>JoinHandle</code> vector</li>
</ul>
</li>
<li>create a result vector, and flatten the contents of our <code>JoinHandle</code> vector into it</li>
<li>convert back to an <code>Array</code> of <code>Tuples</code>.</li>
</ul>
<h2>How much faster?</h2>
<p>Our threaded function runs in <strong>965ms</strong>. A 1.4x speedup.
That’s pretty good, but consider:</p>
<ul>
<li>Rust has been 1.0 for <em>six weeks</em>. Considerable scope for improvement remains w/r/t optimisations</li>
<li>I have no idea what I’m doing, really</li>
<li>The threading mechanism is itself quite new, and may yet evolve to become more efficient</li>
<li>There are other concurrency strategies such as channels and locks, which may offer a more efficient approach</li>
</ul>
<h1>Etc.</h1>
<ul>
<li>The complete working source, as well as an example notebook, and compilation instructions are available on <a href="https://github.com/urschrei/rust_bng">Github</a></li>
<li>I’ve created a library, <code>convertbng</code>, which includes pip-installable <span class="caps">OS</span> X binaries. It’s available from <a href="https://pypi.python.org/pypi/convertbng">PyPI</a></li>
<li>A comprehensive suite of examples using <span class="caps">FFI</span> to interact with Rust can be found <a href="http://jakegoulding.com/rust-ffi-omnibus/">here</a>.</li>
<li>A fully correct implementation would accept the returned <code>Array</code> pointer back from the Python callee, and allow Rust to drop the value. As it stands, the <span class="caps">FFI</span> process now owns the memory. It’s incredibly hypocritical of me to extol the virtues of Rust’s memory-safety features and then abuse them like this, but here we are.</li>
<li>I should implement the reverse operation </li>
</ul>
<p><small>Thanks to Jake Goulding for explaining much of the C-compatible structure and <span class="caps">FFI</span> interaction detail to me.</small>  </p><ol class="simple-footnotes"><li id="sf-rust-python-ffi-bng-1">Let’s pause for a moment to consider the vast amount of computational resources which were expended upon the search which returned this result to me, and how much more efficient it would have been for me to simply walk ten metres and utter the words “Has anyone implemented lon lat to <span class="caps">BNG</span> conversion in Python before?”. Food for thought. <a href="#sf-rust-python-ffi-bng-1-back" class="simple-footnote-back">↩</a></li><li id="sf-rust-python-ffi-bng-2">Also, the internecine schism between various factions of C adherents — with their forthright opinions on how best to learn the language — frankly make me want to lie down in a darkened room, preferably forever. <a href="#sf-rust-python-ffi-bng-2-back" class="simple-footnote-back">↩</a></li><li id="sf-rust-python-ffi-bng-3"><a href="https://en.wikipedia.org/wiki/Foreign_function_interface">https://en.wikipedia.org/wiki/Foreign_function_interface</a> <a href="#sf-rust-python-ffi-bng-3-back" class="simple-footnote-back">↩</a></li></ol>
            </div>
            
    </div></body></html>