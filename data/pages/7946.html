<html><body><div><div class="content html_format"><p>
      Все началось с того, что Минкомсвязи разрешило использовать портал госуслуг для идентификации и аутентификации пользователей на негосударственных веб-узлах. Это реализуется с помощью службы ЕСИА (Единая Система Идентификации и Аутентификации — </p><a href="https://esia.gosuslugi.ru">esia.gosuslugi.ru</a><p>). Заказчик нашего проекта входил в число первых 5 участников, которые подали заявки на интеграцию с ЕСИА, что выразилось для нас задачей эту интеграцию поддержать. 
</p><p>
В свободном доступе мы не нашли открытого бесплатного решения подходящего для своего стека технологий, поэтому после разработки, с благословления заказчика, решили поделиться собственным (BSD license).
</p><p>
Итак, представляем вам проект esia-connector, написан на Python 3, использует утилиту openssl, проверялся в работе только в Debian-based системах.
</p><p>
Пакет: </p><a href="https://pypi.python.org/pypi/esia-connector/">pypi.python.org/pypi/esia-connector</a><p>
Проект: </p><a href="https://github.com/eigenmethod/esia-connector">github.com/eigenmethod/esia-connector</a>
<a name="habracut"/>
<p>
Что такое ЕСИА, какие она возможности предоставляет рассказывать не стану, только о возможностях текущей реализации нашей библиотеки.</p><p>
esia-connector позволяет:
</p><ul>
<li>аутентифицироваться в ЕСИА, получить в ответ токен (который затем можно использовать для идентификации пользователя), проверить его;</li>
<li>получить личные данные пользователя: ФИО, данные удостоверяющих личность документов (паспорта, водительские права), контактные данные (номера телефонов, адрес электронной почты), ИНН, СНИЛС, адреса (проживания и регистрации).</li>
</ul>

<h2>Использование</h2><p>
Для того, чтобы подключиться к ЕСИА с помощью библиотеки вам нужно иметь на руках:
</p><ol>
<li>Сертификат, выданный, либо самоподписанный в формате описанном в методических рекомендациях, загруженный на тестовый и боевой сервер ЕСИА.<br/>
<div class="spoiler"><b class="spoiler_title">Выдержка из методических рекомендаций</b><p class="spoiler_text">Выпустить ключевой контейнер и сертификат ключа квалифицированной электронной подписи для подключаемой информационной системы (должен содержать ОГРН ЮЛ, являющегося оператором информационной системы). Дополнительно поддерживается работа с ключевым контейнером и сертификатом ключа неквалифицированной электронной подписи в формате X.509 версии 3. В этом случае является допустимым самостоятельно сгенерировать (например, с помощью утилиты keytool из состава Java Development Kit) для своей системы ключевой контейнер и самоподписанный сертификат. Сертификат требуется для идентификации ИС при взаимодействии с ЕСИА. ЕСИА поддерживает алгоритмы формирования электронной подписи RSA с длиной ключа 2048 бит и алгоритмом криптографического хэширования SHA-256, а также алгоритм электронной подписи ГОСТ Р 34.10-2001 и алгоритм криптографического хэширования ГОСТ Р 34.11-94.<br/>
</p></div></li>
<li>Выданную службой поддержки ЕСИА учетную запись компании на боевом и тестовом серверах. Она, затем, должна быть указана при создании объекта EsiaSettings вместо строки “YOUR_SYSTEM_ID”.</li>
<li>Учетные записи пользователей на тестовом и боевом серверах ЕСИА для отладки и тестирования.</li>
<li>Публичные ключи ЕСИА (тестовый и боевой) для верификации полученного токена. В открытом доступе этих ключей нет, техподдержка высылает их электронной почтой по требованию.</li>
</ol>
<p>
Чтобы запустить тестовый пример (минимальное веб-приложение на Flask доступно в репозитории библиотеки) нужно</p><p>
предварительно загруженный на сервер ЕСИА сертификат разместить в файле “esia-connector/examples/res/test.crt”. В этом же каталоге следует разместить ваш приватный ключ под именем “test.key”, а упомянутый выше публичный ключ разместить под именем “esia_pub.key”.</p><p>
Затем запустить приложение Flask, из каталога examples выполнить:
</p><pre><code class="python">python flask_app.py
</code></pre>
<p>
На главной странице мы увидим правильно сформированную ссылку для обращения к ЕСИА, при переходе по ней сервер ЕСИА обработает данные в GET-запросе, запросит у пользователя логин и пароль к ЕСИА, затем после удачного введения запросит разрешение на доступ нашего приложения к ЕСИА и, в случае выдачи разрешения, редиректит на заданную в тестовом примере страницу, где мы с уже полученным токеном сделаем еще пару запросов на получение персональных данных пользователя от лица которого производим запрос, и отобразим эти данные на этой же странице.

</p><div class="spoiler"><b class="spoiler_title">Пример использования esia-connector</b><div class="spoiler_text"><pre><code class="python">import os

from flask import Flask, request

from esia_connector.client import EsiaSettings, EsiaAuth


def get_test_file(name):
    return os.path.join(os.path.dirname(__file__), 'res', name)


TEST_SETTINGS = EsiaSettings(esia_client_id='YOUR SYSTEM ID',
                             redirect_uri='http://localhost:5000/info',
                             certificate_file=get_test_file('test.crt'),
                             private_key_file=get_test_file('test.key'),
                             esia_token_check_key=get_test_file('esia_pub.key'),
                             esia_service_url='https://esia-portal1.test.gosuslugi.ru',
                             esia_scope='openid http://esia.gosuslugi.ru/usr_inf')

assert TEST_SETTINGS.esia_client_id != 'YOUR SYSTEM ID', "Please specify real system id!"

assert os.path.exists(TEST_SETTINGS.certificate_file), "Please place your certificate in res/test.crt !"
assert os.path.exists(TEST_SETTINGS.private_key_file), "Please place your private key in res/test.key!"
assert os.path.exists(TEST_SETTINGS.esia_token_check_key), "Please place ESIA public key in res/esia_pub.key !"


app = Flask(__name__)

esia_auth = EsiaAuth(TEST_SETTINGS)


@app.route("/")
def hello():
    url = esia_auth.get_auth_url()
    return 'Start here: &lt;a href="{0}"&gt;{0}&lt;/a&gt;'.format(url)


@app.route("/info")
def process():
    code = request.args.get('code')
    state = request.args.get('state')
    esia_connector = esia_auth.complete_authorization(code, state)
    inf = esia_connector.get_person_main_info()
    return "%s" % inf


if __name__ == "__main__":
    app.run()
</code></pre>
</div></div>

<h2>Реализация</h2><p>
Устройство библиотеки тривиальное, комментариев не требует, после написания стало понятно, что можно было бы спроектировать и лучше, чтобы пользователю библиотеки требовалось выполнять меньше действий с ее интерфейсом.</p><p>
Стоит отметить, что используется утилита openssl для подписи, в связи с этим есть лишняя операция создания временного файла.</p><p>
Нас устраивает текущая реализация, но лучше было бы использовать pyopenssl.
</p><p>
У нас нет планов развития библиотеки, пока не будет требований в проекте, а их в ближайшей перспективе нет.</p><p>
Если используете esia-connector в ваших проектах и попутно что-то добавите/исправите — PR-те, будем рады включить.
</p><p>
Что можно было бы сделать:
</p><ol>
<li>Реорганизовать интерфейс библиотеки для упрощения использования.</li>
<li>Заменить использование openssl на pyopenssl.</li>
<li>Разработать функционал по получению других данных из ЕСИА.</li>
<li>Поддержать альтернативный протокол обмена данных реализованный в ЕСИА (SAML).</li>
<li>Реализовать обертки для популярных фреймворков, например: Django, Flask, возможно в рамках отдельных проектов.</li>
</ol>

<h2>Ссылки</h2>
<ol>
<li>Методические рекомендации по использованию ЕСИА: <a href="http://minsvyaz.ru/ru/documents/4243/">minsvyaz.ru/ru/documents/4243</a></li>
<li>Регламент информационного взаимодействия: <a href="http://www.minsvyaz.ru/ru/documents/4244/">www.minsvyaz.ru/ru/documents/4244</a></li>
<li>Новость о возможности интеграции с ЕСИА: <a href="http://www.kommersant.ru/doc/2832483">www.kommersant.ru/doc/2832483</a></li>
<li>Открытая реализация на PHP: <a href="https://github.com/fr05t1k/esia">github.com/fr05t1k/esia</a></li>
</ol>

      
      <p class="clear"/>
    </div>

    
  </div></body></html>