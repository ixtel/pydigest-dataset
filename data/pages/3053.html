<html><body><div><div class="entry-content"><p>В <a href="http://pythonworld.ru/web/cgi-1.html" target="_blank">первой части</a> мы написали Hello world. Сегодня мы рассмотрим несколько более сложные вещи: обработку данных форм и cookies.</p><div class="section" id="id1"><h2>Получение данных из форм</h2><p>Итак, во-первых разберёмся с формами. В модуле CGI есть полезный класс: FieldStorage, который содержит в себе переданную в форме информацию. По сути дела этот класс представляет из себя словарь, обладающий теми же свойствами, что и обычный <a href="http://pythonworld.ru/tipy-dannyx-v-python/slovari-dict-funkcii-i-metody-slovarej.html" target="_blank">словарь в python</a>.</p><p>У класса FieldStorage есть 2 метода получения значений данных формы:</p><p><b>FieldStorage.getfirst</b>(name, default=None) - всегда возвращает только одно значение, связанное с именем поля формы. Метод возвращает только первое значение в том случае, если нехороший пользователь послал более одного значения. Обратите внимание, что порядок, в котором будут получены значения, могут отличаться от браузера к браузеру. Если нет такого поля формы или значение не существует, то метод возвращает default.</p><p><b>FieldStorage.getlist</b>(name) - возвращает список значений, связанных с именем поля формы.</p><p>Разберём на примере: создадим в нашей папке файл <b>index.html</b> со следующим содержимым (это будет наша форма, данные из которой мы будем обрабатывать):</p><pre class="code html literal-block">
<span class="cp">&lt;!DOCTYPE HTML&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">"utf-8"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Обработка данных форм<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">"/cgi-bin/form.py"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">name</span><span class="o">=</span><span class="s">"TEXT_1"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">name</span><span class="o">=</span><span class="s">"TEXT_2"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span></pre><p>А в папке cgi-bin/ - файл <b>form.py</b> (обработчик формы)</p><pre class="code python3"><span class="ch">#!/usr/bin/env python3</span>
<span class="kn">import</span> <span class="nn">cgi</span>

<span class="n">form</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">FieldStorage</span><span class="p">()</span>
<span class="n">text1</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">getfirst</span><span class="p">(</span><span class="s2">"TEXT_1"</span><span class="p">,</span> <span class="s2">"не задано"</span><span class="p">)</span>
<span class="n">text2</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">getfirst</span><span class="p">(</span><span class="s2">"TEXT_2"</span><span class="p">,</span> <span class="s2">"не задано"</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Content-type: text/html</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"""&lt;!DOCTYPE HTML&gt;
        &lt;html&gt;
        &lt;head&gt;
            &lt;meta charset="utf-8"&gt;
            &lt;title&gt;Обработка данных форм&lt;/title&gt;
        &lt;/head&gt;
        &lt;body&gt;"""</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"&lt;h1&gt;Обработка данных форм!&lt;/h1&gt;"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"&lt;p&gt;TEXT_1: {}&lt;/p&gt;"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">text1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"&lt;p&gt;TEXT_2: {}&lt;/p&gt;"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">text2</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"""&lt;/body&gt;
        &lt;/html&gt;"""</span><span class="p">)</span></pre><p>Попробуем это в действии (кто сидит на linux, не забудьте поставить права на выполнение).</p><p><a href="http://pythonworld.ru/web/cgi-1.html" target="_blank">Запускаем локальный сервер</a>, и переходим на <b>localhost:8000</b>:</p><p><img alt="Форма" src="/uploads/python-cgi/form.png"/></p><p><img alt="Результат обработки формы" src="/uploads/python-cgi/form-result.png"/></p></div><div class="section" id="id2"><h2>Но есть нюанс...</h2><p>А если попробовать так?</p><p><img alt="Форма, дающая некорректный результат" src="/uploads/python-cgi/form-problem.png"/></p><p><img alt="Некорректный результат обработки формы" src="/uploads/python-cgi/form-result-problem.png"/></p><p>Это серьёзная уязвимость, поэтому от неё нужно избавляться. Для этого нужно (в самом простом случае) экранировать все опасные символы. Это можно сделать с помощью функции escape из модуля html.</p><p>Перепишем form.py:</p><pre class="code python3"><span class="ch">#!/usr/bin/env python3</span>
<span class="kn">import</span> <span class="nn">cgi</span>
<span class="kn">import</span> <span class="nn">html</span>

<span class="n">form</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">FieldStorage</span><span class="p">()</span>
<span class="n">text1</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">getfirst</span><span class="p">(</span><span class="s2">"TEXT_1"</span><span class="p">,</span> <span class="s2">"не задано"</span><span class="p">)</span>
<span class="n">text2</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">getfirst</span><span class="p">(</span><span class="s2">"TEXT_2"</span><span class="p">,</span> <span class="s2">"не задано"</span><span class="p">)</span>
<span class="n">text1</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">text1</span><span class="p">)</span>
<span class="n">text2</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">text2</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Content-type: text/html</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"""&lt;!DOCTYPE HTML&gt;
        &lt;html&gt;
        &lt;head&gt;
            &lt;meta charset="utf-8"&gt;
            &lt;title&gt;Обработка данных форм&lt;/title&gt;
        &lt;/head&gt;
        &lt;body&gt;"""</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"&lt;h1&gt;Обработка данных форм!&lt;/h1&gt;"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"&lt;p&gt;TEXT_1: {}&lt;/p&gt;"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">text1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"&lt;p&gt;TEXT_2: {}&lt;/p&gt;"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">text2</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"""&lt;/body&gt;
        &lt;/html&gt;"""</span><span class="p">)</span></pre><p>Результат можете проверить сами.</p><p>Вообще говоря, экранирование нежелательных символов везде, где нужно - очень большая проблема безопасности веб-приложений. Помните об этом.</p></div><div class="section" id="cookies"><h2>Cookies</h2><p>Cookies (печеньки) — небольшой фрагмент данных, отправленный веб-сервером и сохраняемый на компьютере пользователя. Браузер всякий раз при попытке открыть страницу соответствующего сайта пересылает этот фрагмент данных веб-серверу в составе HTTP-запроса.</p><p>Собственно, cookies - хороший способ сохранить некоторые данные о пользователях.</p><p>Отправка печенек осуществляется заголовком Set-cookie:</p><pre class="code python3"><span class="ch">#!/usr/bin/env python3</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Set-cookie: name=value; expires=Wed May 18 03:33:20 2033; path=/cgi-bin/; httponly"</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Content-type: text/html</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Cookies!!!"</span><span class="p">)</span></pre><p>Например, если сохранить этот скрипт в /cgi-bin/cookie.py и зайти на localhost:8000/cgi-bin/cookie.py, то вам поставится печенька с именем <i>name</i> и значением <i>value</i>. Срок её хранения до мая 2033 года, отправляется повторно на сервер только к скриптам, которые расположены в /cgi-bin/, и передается только http-запросами (её нельзя получить из браузера пользователя с помощью javascript).</p><p>Все эти параметры не являются обязательными. Можно написать так:</p><pre class="code python3"><span class="ch">#!/usr/bin/env python3</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Set-cookie: name=value"</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Content-type: text/html</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Cookies!!!"</span><span class="p">)</span></pre><p>Тогда храниться она будет до того момента, когда закроется браузер, будет отправляться на сервер для любых документов (и для /index.html тоже, в отличие от предыдущего случая). Также её можно будет получить средствами javascript (поскольку не был установлен флаг httponly).</p></div><div class="section" id="id3"><h2>Обработка Cookies</h2><p>Теперь научимся получать cookies. Они передаются на сервер и доступны в переменной os.environ (словарь, cookies хранятся по ключу HTTP_COOKIE). Они передаются в виде пар ключ=значение, что не очень удобно при обработке. Для упрощения работы можно использовать модуль http.cookies.</p><p>Напишем простой скрипт (/cgi-bin/cookie.py), проверяющий, установлена ли кука, и если нет, устанавливает:</p><pre class="code python3"><span class="ch">#!/usr/bin/env python3</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">http.cookies</span>

<span class="n">cookie</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">SimpleCookie</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"HTTP_COOKIE"</span><span class="p">))</span>
<span class="n">name</span> <span class="o">=</span> <span class="n">cookie</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"name"</span><span class="p">)</span>
<span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Set-cookie: name=value"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Content-type: text/html</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Cookies!!!"</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Content-type: text/html</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Cookies:"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">value</span><span class="p">)</span></pre><p>Так страница выглядит после первого запроса:</p><p><img alt="Cookies - первый запрос" src="/uploads/python-cgi/cookies-1.png"/></p><p>И после обновления страницы:</p><p><img alt="Cookies - второй запрос" src="/uploads/python-cgi/cookies-2.png"/></p><p>Не следует хранить в cookies важные данные, и не полагайтесь на выставленный вами срок хранения. Cookies можно удалить или изменить вручную в браузере.</p></div></div></div></body></html>