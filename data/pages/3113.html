<html><body><div><div class="body"><div itemscope="" itemtype="http://schema.org/Article"><h1 class="title" itemprop="name">Tweaks for making django admin faster</h1><p class="date"> Thu 19 January 2012</p><div itemprop="articleBody"><p>Here follow a number of tricks I've employed in the past to make django admin faster.</p><div class="section" id="editable-foreign-keys-in-the-changelist"><h2>Editable foreign keys in the changelist<a class="headerlink" href="#editable-foreign-keys-in-the-changelist" title="Permalink to this headline"> *</a></h2><p>If you have foreign keys in <tt class="docutils literal">list_editable</tt> django will make 1 database query for each item in the changelist. Quite a lot for a changelist of 100 items. The trick is to cache the choices for that formfield:</p><div class="highlight"><pre><span/><span class="k">class</span> <span class="nc">MyAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">list_editable</span> <span class="o">=</span> <span class="s1">'myfield'</span><span class="p">,</span>
    <span class="k">def</span> <span class="nf">formfield_for_dbfield</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_field</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'request'</span><span class="p">]</span>
        <span class="n">formfield</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">MyAdmin</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">formfield_for_dbfield</span><span class="p">(</span><span class="n">db_field</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">db_field</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">'myfield'</span><span class="p">:</span>
            <span class="n">choices</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">'_myfield_choices_cache'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">choices</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">request</span><span class="o">.</span><span class="n">_myfield_choices_cache</span> <span class="o">=</span> <span class="n">choices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">formfield</span><span class="o">.</span><span class="n">choices</span><span class="p">)</span>
            <span class="n">formfield</span><span class="o">.</span><span class="n">choices</span> <span class="o">=</span> <span class="n">choices</span>

        <span class="k">return</span> <span class="n">formfield</span>
</pre></div></div><div class="section" id="foreign-keys-or-many-to-many-fields-in-admin-inlines"><h2>Foreign keys or many to many fields in admin inlines<a class="headerlink" href="#foreign-keys-or-many-to-many-fields-in-admin-inlines" title="Permalink to this headline"> *</a></h2><p>If you have fk of m2m fields on InlineModelAdmin for every object in the formset you'll get a database hit. You can avoid this by having something like:</p><div class="highlight"><pre><span/><span class="k">class</span> <span class="nc">MyAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">TabularInline</span><span class="p">):</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="s1">'myfield'</span><span class="p">,</span>
    <span class="k">def</span> <span class="nf">formfield_for_dbfield</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_field</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">formfield</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">MyAdmin</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">formfield_for_dbfield</span><span class="p">(</span><span class="n">db_field</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">db_field</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">'myfield'</span><span class="p">:</span>
            <span class="c1"># dirty trick so queryset is evaluated and cached in .choices</span>
            <span class="n">formfield</span><span class="o">.</span><span class="n">choices</span> <span class="o">=</span> <span class="n">formfield</span><span class="o">.</span><span class="n">choices</span>
        <span class="k">return</span> <span class="n">formfield</span>
</pre></div></div><div class="section" id="enable-template-caching"><h2>Enable template caching<a class="headerlink" href="#enable-template-caching" title="Permalink to this headline"> *</a></h2><p>It's amazing how easy it is to forget to add this in your settings:</p><div class="highlight"><pre><span/><span class="n">TEMPLATE_LOADERS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="s1">'django.template.loaders.cached.Loader'</span><span class="p">,</span> <span class="p">(</span>
        <span class="s1">'django.template.loaders.filesystem.Loader'</span><span class="p">,</span>
        <span class="s1">'django.template.loaders.app_directories.Loader'</span><span class="p">,</span>
    <span class="p">)),</span>
<span class="p">)</span>
</pre></div></div><div class="section" id="use-annotations-if-possible-for-function-entries-list-display-instead-of-making-additional-queries"><h2>Use annotations if possible for function entries list_display instead of making additional queries<a class="headerlink" href="#use-annotations-if-possible-for-function-entries-list-display-instead-of-making-additional-queries" title="Permalink to this headline"> *</a></h2><p>Check the <a class="reference external" href="https://docs.djangoproject.com/en/dev/topics/db/aggregation/">aggregation api</a> to see if you can use this. Here's the typical example:</p><div class="highlight"><pre><span/><span class="k">class</span> <span class="nc">AuthorAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="s1">'books_count'</span><span class="p">,</span>

    <span class="k">def</span> <span class="nf">books_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">books_count</span>

    <span class="k">def</span> <span class="nf">queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">AuthorAdmin</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">queryset</span><span class="p">(</span>
            <span class="n">request</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">books_count</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s1">'books'</span><span class="p">))</span>
</pre></div><p>The models would look like this:</p><div class="highlight"><pre><span/><span class="k">class</span> <span class="nc">Author</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Book</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Author</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s2">"books"</span><span class="p">)</span>
</pre></div></div><div class="section" id="cache-the-filters-from-the-admin-changelist"><h2>Cache the filters from the admin changelist<a class="headerlink" href="#cache-the-filters-from-the-admin-changelist" title="Permalink to this headline"> *</a></h2><p>This has the obvious tradeoff that you'll have stale data in the list of filter but if they don't change that often and those distinct queries are killing your database then this will help a lot. Just add a custom change_list.html template in your project (eg: <tt class="docutils literal"><span class="pre">templates/&lt;myapp&gt;/change_list.html</span></tt>):</p><div class="highlight"><pre><span/><span class="cp">{%</span> <span class="k">extends</span> <span class="s2">"admin/change_list.html"</span> <span class="cp">%}</span><span class="x"/>
<span class="cp">{%</span> <span class="k">load</span> <span class="nv">admin_list</span> <span class="nv">i18n</span> <span class="nv">cache</span> <span class="cp">%}</span><span class="x"/>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">filters</span> <span class="cp">%}</span><span class="x"/>
<span class="x">    </span><span class="cp">{%</span> <span class="k">cache</span> <span class="m">300</span> <span class="nv">admin_filters</span> <span class="nv">request.GET.items</span> <span class="nv">request.path</span> <span class="nv">request.user.username</span> <span class="cp">%}</span><span class="x"/>
<span class="x">        </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">cl.has_filters</span> <span class="cp">%}</span><span class="x"/>
<span class="x">          &lt;div id="changelist-filter"&gt;</span>
<span class="x">            &lt;h2&gt;</span><span class="cp">{%</span> <span class="k">trans</span> <span class="s1">'Filter'</span> <span class="cp">%}</span><span class="x">&lt;/h2&gt;</span>
<span class="x">            </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">spec</span> <span class="k">in</span> <span class="nv">cl.filter_specs</span> <span class="cp">%}{%</span> <span class="k">admin_list_filter</span> <span class="nv">cl</span> <span class="nv">spec</span> <span class="cp">%}{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"/>
<span class="x">          &lt;/div&gt;</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"/>
<span class="x">    </span><span class="cp">{%</span> <span class="k">endcache</span> <span class="cp">%}</span><span class="x"/>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"/>
</pre></div></div><div class="section" id="bonus-trick"><h2>Bonus trick<a class="headerlink" href="#bonus-trick" title="Permalink to this headline"> *</a></h2><div class="highlight"><pre><span/><span class="n">frame</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">while</span> <span class="n">frame</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span> <span class="o">==</span> <span class="s1">'render_change_form'</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">'request'</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">:</span>
            <span class="n">request</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="s1">'request'</span><span class="p">]</span>
            <span class="k">break</span>
    <span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_back</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">"Could not find request object."</span><span class="p">)</span>

<span class="c1"># do stuff with request</span>
</pre></div><p>This could be used in some specific cases (eg: you need the request in a widget's render method), as a last resort ofcourse ;)</p><p>--</p><p>What did you do to make django admin faster?</p></div></div><p class="tags">This entry was tagged as <a href="https://blog.ionelmc.ro/tag/django/"><span itemprop="keywords">django</span></a><a href="https://blog.ionelmc.ro/tag/django-admin/"><span itemprop="keywords">django admin</span></a><a href="https://blog.ionelmc.ro/tag/python/"><span itemprop="keywords">python</span></a></p></div><p id="disqus_thread"/><noscript> Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </div></div></body></html>