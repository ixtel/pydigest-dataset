<html><body><div><div class="entry-content">
		<p>I recently thought of a idea to write an <code>apt-file</code> (<code>yum whatprovides</code>) that works across multiple distros. If you’ve never used a utility like this, they’ll tell you which package provides a certain file. This would help when writing README files to work out what dependencies are needed in each distro.</p>
<p>After a couple of hours of fiddling around (read: procrastinating), I had a working import from the repository Contents.gz file that’s on every Debian mirror. The thing that struck me was the file sizes:</p>
<table>
<thead>
<tr>
<th>File</th>
<th>Size</th>
</tr>
</thead>
<tbody>
<tr>
<td>Contents-amd64.gz</td>
<td>26,721kb</td>
</tr>
<tr>
<td>Contents-amd64</td>
<td>378,971kb</td>
</tr>
<tr>
<td>Contents-amd64.sqlite (naive import with lots of duplication)</td>
<td>452,146kb</td>
</tr>
<tr>
<td>Contents-amd64.sqlite (de-normalised)</td>
<td>330,274kb</td>
</tr>
<tr>
<td>Contents-amd64.sqlite.gz*</td>
<td>55,858kb</td>
</tr>
</tbody>
</table>
<p>Then I got side tracked…</p>
<p>Contents-amd64.gz is what’s downloaded when you run <code>apt-file update</code>. First off I basically ran a <code>for each line in file</code>, split it into package name and file name, then inserted it straight into SQLite.</p>
<p>I then remembered some introductory database theory and ‘de-normalised’ the data – each package becomes an integer and then each row only stores a reference to that integer.</p>
<p>The downside to this is that I needed to run two imports. Once to get the list of packages and files, and then again to link the packages to the list of files. In SQLite, this means creating copies of tables, dropping the duplicate one and then running <code>VACUUM</code> to reclaim the space. The result of this is that I (barely) beat the original file for storage efficiency.</p>
<p>Next, what about search? Could I really beat <code>grep</code>?</p>
<p>I think caching and load affected some of the results – a couple of runs a few hours apart produced wildly different results. All of my tests were run on a 512mb <a href="https://www.digitalocean.com/?refcode=46001ab2f581" target="_blank">DigitalOcean</a> instance.</p>
<pre class="brush: plain; title: ; notranslate" title="">
$ time zgrep bash /var/cache/apt/apt-file/mirrors.digitalocean.com_debian_dists_jessie_main_Contents-amd64.gz | head
bin/bash                                                shells/bash
bin/bash-static                                         shells/bash-static
bin/rbash                                               shells/bash
etc/apparmor.d/abstractions/bash                        admin/apparmor
etc/bash.bashrc                                         shells/bash
etc/bash_completion                                     shells/bash-completion
etc/bash_completion.d/R                                 gnu-r/r-base-core
etc/bash_completion.d/_publican                         perl/publican
etc/bash_completion.d/aapt                              devel/aapt
etc/bash_completion.d/adb                               devel/android-tools-adb

real    0m0.013s
user    0m0.000s
sys     0m0.000s

</pre>
<pre class="brush: plain; title: ; notranslate" title="">
$ time apt-file search bash | head
0install-core: /usr/share/bash-completion/completions/0install
0install-core: /usr/share/bash-completion/completions/0launch
aapt: /etc/bash_completion.d/aapt
acheck: /usr/share/doc/acheck/bash_completion
acl2-books: /usr/lib/acl2-6.5/books/misc/bash-bsd.o
acl2-books: /usr/lib/acl2-6.5/books/misc/bash.o
acl2-books: /usr/share/acl2-6.5/books/misc/bash-bsd.o
acl2-books: /usr/share/acl2-6.5/books/misc/bash.o
acl2-books-certs: /usr/share/acl2-6.5/books/misc/bash-bsd.cert
acl2-books-certs: /usr/share/acl2-6.5/books/misc/bash.cert

real    0m3.631s
user    0m3.268s
sys     0m0.280s
</pre>
<pre class="brush: plain; title: ; notranslate" title="">
$ time python search.py bash | head
shells/bash: bin/rbash
admin/apparmor: etc/apparmor.d/abstractions/bash
shells/bash: etc/bash.bashrc
shells/bash-completion: etc/bash_completion
gnu-r/r-base-core: etc/bash_completion.d/R
perl/publican: etc/bash_completion.d/_publican
devel/aapt: etc/bash_completion.d/aapt
devel/android-tools-adb: etc/bash_completion.d/adb
science/libadios-bin: etc/bash_completion.d/adios
utils/silversearcher-ag: etc/bash_completion.d/ag

real    0m2.375s
user    0m1.732s
sys     0m0.540s

</pre>
<p>Not too bad, I’m competitive with <code>apt-file</code>. Now of course, I’m missing some features but it’s a good result for a little experiment.</p>
<p>The code is <a href="https://github.com/voltagex/junkcode/tree/master/Python/pywhatprovides" target="_blank">on my GitHub</a>, if you’re interested.</p>
<p>I’ll keep working on this and add support for yum/dnf’s formats and probably migrate to a real database backend.</p>
<h3>Sidenotes</h3>
<ul>
<li>The code initially worked, but then would crash when piped to <code>head</code>. The answer? You have to handle SIGPIPE on UNIX-like systems. See <a href="http://stackoverflow.com/questions/26692284/brokenpipeerror-in-python" target="_blank">this StackOverflow post</a> for more info
</li>
<li>
<p>gzipping the database on a i5-based laptop took nearly 20 minutes. A more sane level of compression is a lot quicker, but the compressed size is about 64 megabytes</p>
</li>
<li>
<p>SQLite can read gzipped files with a proprietary extension. It’s a pity the <code>sqlite3</code> Python module doesn’t accept file handles to database files, otherwise I could just wrap it in a gzipstream and I’d be good to go</p>
</li>
<li>
<p>Someone with better SQL skills could probably make the database import a lot faster. On my DigitalOcean instance, the initial import takes a few minutes.</p>
</li>
</ul>
<p><b><i>Like what I do? <a href="https://blog.voltagex.org/support-me/" target="_blank">Support me here</a></i></b></p>
<p><b><i>Need a drink? Try a <a href="http://thecinnamonscrolls.com/2015/08/30/whiskey-sweet-n-sour/" target="_blank">Whiskey Sweet n’ Sour</a> from <a href="http://thecinnamonscrolls.com/" target="_blank">The Cinnamon Scrolls</a></i></b></p>
			</div>

	</div></body></html>