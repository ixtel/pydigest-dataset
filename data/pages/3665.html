<html><body><div><div class="content html_format">
      <img src="https://habrastorage.org/files/0f7/ada/02e/0f7ada02ee2c4bf4937a0636892aaef7.jpg"/>
<p>
Привет Хабр.
</p><blockquote>Я люблю, когда все лежит на своих местах, все в чистоте и порядке. <br/>
Поэтому раз в квартал разгребаю творческий беспорядок. </blockquote><p>Для меня важно иметь стабильную ОС с уверенностью в том, что после очередного ежедневного обновления ничего не сломается. Многие разработчики выбирают ОС исходя из наличия актуальных версий софта. Я умею готовить Centos и в "</p><i>yum -y install yum-cron</i><p>" уверен на 99.98%.
</p><p>
Расскажу, как при этом можно использовать последние версии ruby и python для web-разработки. Так же по результатам на сервере будут установлены 4 веб-приложения от одного регулярного пользователя: </p><i>djangocms</i><p> (python 3.4.3 ), </p><i>quokka</i><p> (python 2.7.9 ), </p><i>redmine</i><p> (ruby 2.2.1 ), </p><i>refinerycms</i><p> (ruby 2.0.0). На тонкие параметры запуска приложения внимание обращено не будет (выбор БД, количество веркеров, соединений, логи и т.д.). Хотел описать LocomotiveCMS, но </p><u>оно</u><p> оказалось паровозом с кучей ручных правок для сетапа.
</p><p>
Для комфорта и удобства будем использовать панель управления VestaCP. Потому что она просто великолепна и идеологически родная.
</p><a name="habracut"/>
<h4>Подготовка системы</h4><p>
Итак, у нас есть тестовая VPS с Centos 6, root доступ. Вопреки официальному руководству будем ставить панель с опцией "-d".

</p><pre><code class="bash">curl -O http://vestacp.com/pub/vst-install.sh
bash vst-install.sh -d</code></pre><p>
Таким образом, мы ограничим установку только «epel» репозиторием, без «remi» (т.е. без последних версий mysql и php).</p><p>
Добавляем темплейты доменов для nginx:

</p><div class="spoiler"><b class="spoiler_title">cat &gt; /usr/local/vesta/data/templates/web/nginx/socket.tpl...</b><div class="spoiler_text"><pre><code class="bash">cat &gt; /usr/local/vesta/data/templates/web/nginx/socket.tpl &lt;&lt; EOF
upstream %domain%_app_server {
  server unix:/tmp/%domain%.sock fail_timeout=0;
}
server {
    listen      %ip%:%proxy_port%;
    server_name %domain_idn% %alias_idn%;
    error_log  /var/log/httpd/domains/%domain%.error.log error;
    access_log  /var/log/httpd/domains/%domain%.access.log;

    location /static/ {
        alias   %docroot%/static/;
    }

    location /media/ {
        alias   %docroot%/media/;
    }

    location / {
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header Host \$http_host;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_redirect off;
        if (!-f \$request_filename) {
            proxy_pass http://%domain%_app_server;
            break;
        }
    }
    include %home%/%user%/conf/web/nginx.%domain%.conf*;
}
EOF
cat &gt; /usr/local/vesta/data/templates/web/nginx/socket.stpl &lt;&lt; EOF
server {
    listen      %ip%:%proxy_ssl_port%;
    server_name %domain_idn% %alias_idn%;
    ssl         on;
    ssl_certificate      %ssl_pem%;
    ssl_certificate_key  %ssl_key%;
    error_log  /var/log/httpd/domains/%domain%.error.log error;
    access_log  /var/log/httpd/domains/%domain%.access.log;

    location /static/ {
        alias   %sdocroot%/static/;
    }

    location /media/ {
        alias   %sdocroot%/media/;
    }

    location / {
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header Host \$http_host;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_redirect off;
        if (!-f \$request_filename) {
            proxy_pass http://%domain%_app_server;
            break;
        }
    }
    include %home%/%user%/conf/web/snginx.%domain%.conf*;
}
EOF
chown admin.admin /usr/local/vesta/data/templates/web/nginx/socket*
</code></pre>
</div></div><p>
Далее установка пакетов: mongodb для quokka, supervisor третьей ветки, и dev-пакеты:

</p><div class="spoiler"><b class="spoiler_title">yum install ...</b><div class="spoiler_text"><pre><code class="bash">yum install mongodb-server -y
chkconfig mongod on
service mongod start

yum install http://mirror.symnds.com/distributions/gf/el/6/gf/i386/gf-release-6-6.gf.el6.noarch.rpm -y
yum --enablerepo=gf-plus install supervisor -y
chkconfig supervisord on
service supervisord start

yum groupinstall "Development tools" -y
yum install ImageMagick-devel mysql-devel zlib-devel bzip2-devel openssl-devel ncurses-devel \
    sqlite-devel readline-devel tk-devel gdbm-devel db4-devel libpcap-devel xz-devel libjpeg-devel \
    libyaml-devel libffi-devel -y
yum install git mercurial nodejs -y</code></pre>
</div></div><p>
И последнее, что потребуется от root-а, это настройка supervisor-а:

</p><div class="spoiler"><b class="spoiler_title">cat /etc/supervisord.d/reguser.ini</b><div class="spoiler_text"><pre><code>[program:djangocms.test.site]
directory=/home/reguser/web/%(program_name)s/public_html
command=/home/reguser/.pyenv/shims/gunicorn -b unix:/tmp/%(program_name)s.sock project.wsgi:application
user=reguser
autostart=true
autorestart=true
redirect_stderr=true
[program:quokka.test.site]
directory=/home/reguser/web/%(program_name)s/public_html
command=/home/reguser/.pyenv/shims/gunicorn -b unix:/tmp/%(program_name)s.sock manage:app
user=reguser
autostart=true
autorestart=true
redirect_stderr=true
[program:redmine.test.site]
directory=/home/reguser/web/%(program_name)s/public_html/
#command=/home/reguser/.rbenv/shims/unicorn         -l /tmp/%(program_name)s.sock -E production
command=/home/reguser/.rbenv/shims/thin start --socket /tmp/%(program_name)s.sock -e production 
user=reguser
autostart=true
autorestart=true
redirect_stderr=true
[program:refinerycms.test.site]
directory=/home/reguser/web/%(program_name)s/public_html/
command=/home/reguser/.rbenv/shims/unicorn  -l /tmp/%(program_name)s.sock
user=reguser
autostart=true
autorestart=true
redirect_stderr=true</code></pre>
</div></div><p>
Вот и все, что требуется от супер-пользователя.
</p><p>
В Vesta добавляем пользователя (reguser), разрешаем SSH Access в bash и создаем 4 домена:
</p><i>djangocms.test.site</i><p>, </p><i>quokka.test.site</i><p>, </p><i>redmine.test.site</i><p>, </p><i>refinerycms.test.site</i><p>.</p><p>
В настройках каждого домена указываем добавленный ранее профиль nginx под названием «socket».</p><p>
Таким образом, nginx будет слушать unix-сокеты, которые будут создаваться супервайзером, с правами регулярного пользователя.
</p><p>
На страничках каждого домена будет отображаться неприятное «502 Bad Gateway» — значит, идем по правильному пути.

</p><h4>Настройка пользовательского окружения</h4><p>
Если в «системе» у нас все аккуратно, то в «хомяке» у нас будет много-много самосборного мусора.</p><p>
Однако мы ничего не увидим. Для нас всю грязную работу сделают PyEnv и RbEnv.

</p><pre><code class="bash">su - reguser</code></pre><p>
Первым решим вопрос RbEnv. Многозначительная страничка </p><a href="http://rbenv.org">rbenv.org</a><p> отправит нас на гитхаб, где мы самостоятельно осознаем философию shims.

</p><pre><code class="bash">git clone https://github.com/sstephenson/rbenv.git ~/.rbenv 
echo 'export PATH="$HOME/.rbenv/bin:$PATH"' &gt;&gt; ~/.bash_profile
echo 'eval "$(rbenv init -)"' &gt;&gt; ~/.bash_profile
. ~/.bash_profile
type rbenv
git clone https://github.com/sstephenson/ruby-build.git ~/.rbenv/plugins/ruby-build</code></pre><p>
Смотрим доступные версии и собираем последние версии ветки 2.0 и 2.2:

</p><pre><code class="bash">rbenv install -l
rbenv install 2.0.0-p643
rbenv install 2.2.1</code></pre><p>
Как ни странно, но PyEnv — это форк RbEnv, подробнее </p><a href="https://github.com/yyuu/pyenv">тут</a><p>. Выполняем почти тоже самое:

</p><pre><code class="bash">curl -L https://raw.githubusercontent.com/yyuu/pyenv-installer/master/bin/pyenv-installer | bash
echo 'export PATH="$HOME/.pyenv/bin:$PATH"
eval "$(pyenv init -)"
eval "$(pyenv virtualenv-init -)"' &gt;&gt; ~/.bash_profile
. ~/.bash_profile
pyenv install -l
pyenv install 2.7.9
pyenv install 3.4.3</code></pre>
<h4>Установка Redmine</h4><p>
Предварительно необходимо создать mysql БД в Vesta:

</p><pre><code class="bash">cd ~/web/redmine.test.site/public_html
rm -rf *
hg clone --updaterev 3.0-stable https://bitbucket.org/redmine/redmine-all .
echo 'production:
  adapter: mysql2
  database: reguser_redmine
  host: localhost
  username: reguser_redmine
  password: "password"
  encoding: utf8
' &gt; config/database.yml</code></pre><p>
Далее очень важная строчка, она создает файл .ruby-version в текущем каталоге, тем самым указывает нужную версию shims. Тоже самое происходит и с версиями python при </p><i>pyenv local x.x.x</i><p>.

</p><pre><code class="bash">rbenv local 2.2.1
gem install bundler
bundle install --without development test
rake generate_secret_token
RAILS_ENV=production rake db:migrate
RAILS_ENV=production rake redmine:load_default_data</code></pre><p>На выбор thin или unicorn (что указано в супервайзере):
</p><pre><code class="bash">gem install thin
echo 'gem "thin"' &gt;&gt; Gemfile
gem install unicorn
echo 'gem "unicorn"' &gt;&gt; Gemfile</code></pre><p>
Первый пошел. Осталось передернуть супервайзер из консоли '</p><i>supervisorctl restart redmine.test.site</i><p>', или через веб морду… и редмайн готов к работе </p><a href="http://redmine.test.site">redmine.test.site</a><p>:

</p><img src="https://habrastorage.org/files/2d2/796/013/2d2796013e4a4347b4093b6901694b3f.png"/>

<h4>Установка RefineryCMS</h4><p>
Все аналогично, с учетом официального руководства:

</p><pre><code class="bash">cd ~/web/refinerycms.test.site/public_html/
rbenv local 2.0.0-p643
gem install rails --version 4.1.8
gem install execjs
rails new . -m http://refinerycms.com/t/edge
gem install unicorn</code></pre><p>
Страница с приглашением создать администратора ждет, </p><a href="http://refinerycms.test.site/refinery">refinerycms.test.site/refinery</a><p>:

</p><img src="https://habrastorage.org/files/785/3fb/288/7853fb2888364a44b341fff44a50d13b.png"/>

<h4>Установка DjangoCMS</h4>
<pre><code class="bash">cd ~/web/djangocms.test.site/public_html
pyenv local 3.4.3
pip install djangocms-installer</code></pre><p>
Далее последует диалог. Выберите «Languages» = «en, ru», «Twitter Theme» = «yes», «with examples» = «yes». Остальное по умолчанию.

</p><pre><code class="bash">djangocms -p . project</code></pre><p>
По окончании попросят указать логин пароль и почтовый адрес.

</p><pre><code class="bash">python manage.py cms  check  # check cms
pip install gunicorn</code></pre><p>
И вот она </p><a href="http://djangocms.test.site">djangocms.test.site</a><p>:
</p><img src="https://habrastorage.org/files/34e/15c/e57/34e15ce577ae4beda1e5235a8ee5cc25.png"/>

<h4>Установка QUOKKA</h4>
<pre><code class="bash">cd ~/web/quokka.test.site/public_html
git clone https://github.com/quokkaproject/quokka .
pyenv local 2.7.9
pip install -r requirements.txt
sed -i "s|^GRAVATAR.*$|&amp;\n    'use_ssl': True,|" quokka/settings.py
python manage.py populate
python manage.py createsuperuser
ln -s quokka/static static
pip install gunicorn</code></pre><p>
А вот и последний зверь </p><a href="http://quokka.test.site">quokka.test.site</a><p>: 

</p><img src="https://habrastorage.org/files/580/bde/384/580bde3848eb4cf9b0fcefd738ccc3c5.png"/>
<p>
Стоит отметить, что в отличии от RbEnv/RVM, в PyEnv вы можете создать virtualenv. Эти вещи не взаимоисключающие.</p><p>
Надеюсь, мой гайд с установками различных веб-приложений был интересен.
</p><p>
Спасибо.

</p>
      <p class="clear"/>
    </div>

    
  </div></body></html>