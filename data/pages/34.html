<html><body><div><div class="post shortcuts_item" id="post_199440">
    <p class="published">29 октября 2013 в 03:34</p>
    <h1 class="title">
      

        <span class="post_title">Получаем тип и размеры изображения без скачивания его целиком, используя Python</span>

      

      

    </h1>

      


    <div class="content html_format"><p>
      Возникла задача профильтровать базу данных ссылок на изображения и удалить большие. В результате было найдено решение на Python, которым я поделюсь под хабракатом:</p>

<img src="https://habrastorage.org/getpro/habr/post_images/fcc/114/4c0/fcc1144c00d2de0f2795c3c29033e715.png" alt="image"/>
<a name="habracut"/>
<a href="http://pastebin.com/raw.php?i=iAHrXyLg">Сам скрипт</a><p> + необходимая для работы библиотека </p><a href="http://dalkescientific.com/Python/ReseekFile.py">ReseekFile</a>
<p>
Вся прелесть решения в том, что для получения информации о типе и размерах изображения(jpg, png, gif) достаточно скачать первых 24 байта файла. 
</p><p>
Код анализа этих 24 байт:

</p><pre><code class="python">    # handle GIFs
    if (size &gt;= 10) and data[:6] in ('GIF87a', 'GIF89a'):
        # Check to see if content_type is correct
        content_type = 'image/gif'
        w, h = struct.unpack("&lt;HH", data[6:10])
        width = int(w)
        height = int(h)

    # See PNG 2. Edition spec (http://www.w3.org/TR/PNG/)
    # Bytes 0-7 are below, 4-byte chunk length, then 'IHDR'
    # and finally the 4-byte width, height
    elif ((size &gt;= 24) and data.startswith('\211PNG\r\n\032\n')
          and (data[12:16] == 'IHDR')):
        content_type = 'image/png'
        w, h = struct.unpack("&gt;LL", data[16:24])
        width = int(w)
        height = int(h)

    # Maybe this is for an older PNG version.
    elif (size &gt;= 16) and data.startswith('\211PNG\r\n\032\n'):
        # Check to see if we have the right content type
        content_type = 'image/png'
        w, h = struct.unpack("&gt;LL", data[8:16])
        width = int(w)
        height = int(h)

    # handle JPEGs
    elif (size &gt;= 2) and data.startswith('\377\330'):
        content_type = 'image/jpeg'
        datastream.seek(0)
        datastream.read(2)
        b = datastream.read(1)
        try:
            while (b and ord(b) != 0xDA):
                while (ord(b) != 0xFF): b = datastream.read(1)
                while (ord(b) == 0xFF): b = datastream.read(1)
                if (ord(b) &gt;= 0xC0 and ord(b) &lt;= 0xC3):
                    datastream.read(3)
                    h, w = struct.unpack("&gt;HH", datastream.read(4))
                    break
                else:
                    datastream.read(int(struct.unpack("&gt;H", datastream.read(2))[0])-2)
                b = datastream.read(1)
            width = int(w)
            height = int(h)
        except struct.error:
            pass
        except ValueError:
            pass
</code></pre>
<p>
Надеюсь, что этот скрипт найдет себе место в избранном хабраюзеров и послужит когда это будет необходимо :)

      
      </p><p class="clear"/>
    </div>

    
  


      <div class="infopanel_wrapper js-user_96915">
    <ul class="postinfo-panel postinfo-panel_post" id="infopanel_post_199440">

          <li class="postinfo-panel__item">
            
          </li>

      <li class="postinfo-panel__item">
        <p class="views-count_post" title="Просмотры публикации">11,2k</p>
      </li>

      <li class="postinfo-panel__item">
        <p class="favorite-wjt favorite">
            <button type="button" disabled="disabled" class="favorite-wjt__button favorite-wjt__button_disabled" title="Только зарегистрированные пользователи могут добавлять публикации в избранное">
              <span>Добавить в избранное</span>
            </button>
          <span class="favorite-wjt__counter js-favs_count" title="Количество пользователей, добавивших публикацию в избранное">239</span>
        </p>
      </li>




      
        <li class="postinfo-panel__item postinfo-panel__item_socials  postinfo-panel__item_socials_right ">
          
        </li>

      
    </ul>
  </div>


        

  <div class="author-info ">
    <a href="/users/limonte" class="author-info__image">
        <img src="//habrastorage.org/getpro/habr/avatars/5f8/e20/625/5f8e20625990e5f8232082b6465a0f11.png" class="author-info__image-pic"/>
    </a>

    <div class="author-info__desc js-user_96915">
      

        <p class="author-info__specialization">
          Full stack PHP/JS developer
        </p>

    </div>
  </div>


  </div>

      </div></body></html>