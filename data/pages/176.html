<html><body><div><div class="content html_format">
      <img src="https://habrastorage.org/getpro/habr/post_images/9d7/1d9/bbf/9d71d9bbfc17842e7aa998c44178625a.jpg" align="right"/><p>После поста про </p><a href="http://habrahabr.ru/post/204134/">смотрелку сериалов</a><p> пришло пожелание добавить </p><a href="https://github.com/Diaoul/subliminal">subliminal</a><p> для загрузки субтитров. Увидев его </p><a href="https://github.com/Diaoul/subliminal/blob/master/requirements.txt">зависимости</a><p>, из которых в репозитории присутствуют только два пакета, и то не подходящих версий. Я понял, что жизнь боль и мне придётся создать пять debian/control, сделать пять changelog'ов и создать 20 тасков в jenkins.
</p><p>
Но зачем тратить на всё это целых два часа, если можно потратить </p><i>всего несколько дней</i><p> на автоматизацию этого процесса. В результате появился </p><a href="https://github.com/nvbn/pytoppa">pytoppa</a><p>, он:
</p><ul>
<li>формирует changelog из истории между изменениями version в setup.py;</li>
<li>автоматически добавляет обязательные зависимости;</li>
<li>имеет простой конфиг в yaml.</li>
</ul>
<a name="habracut"/>
<h3>Установка</h3>
<h4>Ubuntu</h4><p>
В ubuntu пакет можно поставить из ppa:
</p><pre><code class="bash">sudo add-apt-repository ppa:nvbn-rm/ppa
sudo apt-get update
sudo apt-get install pytoppa
</code></pre>
<h4>Другие дистрибутивы</h4><p>
Нужно вручную установить </p><code>dh-make</code><p> и </p><code>cdbs</code><p>, а после этого поставить pytoppa через pip:
</p><pre><code class="bash">pip install pytoppa
</code></pre>
<h3>Использование</h3><p>
В корне репозитория с проектом нужно создать .pytoppa.yml, его формат:
</p><pre><code>section: секция  # по умолчанию python, можно не указывать
dependencies:
 - зависимость-1
 - зависимость-2
releases:
 - релиз-1
 - релиз-2
</code></pre><p>
Например, для приложения series_list:
</p><pre><code>section: net
dependencies:
  - python-requests
  - python-beautifulsoup
  - python-gevent
  - python-decorator
  - python-libtorrent
  - python-pyside
  - subliminal
releases:
  - saucy
  - precise
  - quantal
  - raring
</code></pre>
<img src="https://habrastorage.org/getpro/habr/post_images/034/aac/918/034aac918b5763fd8df5c28ed54f0b98.png" align="right"/><p>
И запустить:
</p><pre><code class="bash">pytoppa ключ-зарегистрированный-на-launchpad ppa
</code></pre><p>
Например, я запускаю:
</p><pre><code class="bash">pytoppa 'Vladimir Iakovlev &lt;nvbn.rm@gmail.com&gt;' 'ppa:nvbn-rm/ppa'
</code></pre>
<h3>Как оно работает</h3><p>
Немного нетривиальным оказалось считывание параметров из setup.py. Самым простым способом оказалось заменить </p><code>setuptools.setup</code><p> и </p><code>distutils.core.setup</code><p> на свой метод, просто сохраняющий параметры.
</p><p>
И </p><a href="https://github.com/nvbn/pytoppa/blob/develop/pytoppa/parsers/git_parser.py">формирование changelog</a><p>, для него пришлось:
</p><ol>
<li>получить все коммиты, в которых присутствует setup.py;</li>
<li>для каждого из коммитов скопировать репозиторий во временную папку и переключиться на коммит. Изначально приложение проходило только по коммитам, где менялся setup.py, но часто версия импортируется из другого файла;</li>
<li>считать версию из setup.py;</li>
<li>взять изменения из лога коммитов между разными версиями.</li>
</ol><p>
На остальных этапах происходит просто копирование или запуск команд.

</p><h3>Ссылки</h3>
<a href="https://github.com/nvbn/pytoppa">github проекта</a><p>;
</p><a href="https://launchpad.net/~nvbn-rm/+archive/ppa">ppa с проектом</a><p>.

      
      </p><p class="clear"/>
    </div>

    
  </div></body></html>