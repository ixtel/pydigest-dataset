<html><body><div><div class=" highlight hl-ipython2"><pre><span class="c"># generate linear time-domain filter coefficients, common to both H1 and L1.</span>
<span class="c"># First, define some functions:</span>

<span class="c"># This function will generate digital filter coefficients for bandstops (notches).</span>
<span class="c"># Understanding it requires some signal processing expertise, which we won't get into here.</span>
<span class="k">def</span> <span class="nf">iir_bandstops</span><span class="p">(</span><span class="n">fstops</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="sd">"""ellip notch filter</span>
<span class="sd">    fstops is a list of entries of the form [frequency (Hz), df, df2]                           </span>
<span class="sd">    where df is the pass width and df2 is the stop width (narrower                              </span>
<span class="sd">    than the pass width). Use caution if passing more than one freq at a time,                  </span>
<span class="sd">    because the filter response might behave in ways you don't expect.</span>
<span class="sd">    """</span>
    <span class="n">nyq</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">fs</span>

    <span class="c"># Zeros zd, poles pd, and gain kd for the digital filter</span>
    <span class="n">zd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">pd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">kd</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c"># Notches</span>
    <span class="k">for</span> <span class="n">fstopData</span> <span class="ow">in</span> <span class="n">fstops</span><span class="p">:</span>
        <span class="n">fstop</span> <span class="o">=</span> <span class="n">fstopData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">fstopData</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">fstopData</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">low</span> <span class="o">=</span> <span class="p">(</span><span class="n">fstop</span> <span class="o">-</span> <span class="n">df</span><span class="p">)</span> <span class="o">/</span> <span class="n">nyq</span>
        <span class="n">high</span> <span class="o">=</span> <span class="p">(</span><span class="n">fstop</span> <span class="o">+</span> <span class="n">df</span><span class="p">)</span> <span class="o">/</span> <span class="n">nyq</span>
        <span class="n">low2</span> <span class="o">=</span> <span class="p">(</span><span class="n">fstop</span> <span class="o">-</span> <span class="n">df2</span><span class="p">)</span> <span class="o">/</span> <span class="n">nyq</span>
        <span class="n">high2</span> <span class="o">=</span> <span class="p">(</span><span class="n">fstop</span> <span class="o">+</span> <span class="n">df2</span><span class="p">)</span> <span class="o">/</span> <span class="n">nyq</span>
        <span class="n">z</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">iirdesign</span><span class="p">([</span><span class="n">low</span><span class="p">,</span><span class="n">high</span><span class="p">],</span> <span class="p">[</span><span class="n">low2</span><span class="p">,</span><span class="n">high2</span><span class="p">],</span> <span class="n">gpass</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">gstop</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
                            <span class="n">ftype</span><span class="o">=</span><span class="s">'ellip'</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s">'zpk'</span><span class="p">)</span>
        <span class="n">zd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zd</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
        <span class="n">pd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>

    <span class="c"># Set gain to one at 100 Hz...better not notch there                                        </span>
    <span class="n">bPrelim</span><span class="p">,</span><span class="n">aPrelim</span> <span class="o">=</span> <span class="n">zpk2tf</span><span class="p">(</span><span class="n">zd</span><span class="p">,</span> <span class="n">pd</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">outFreq</span><span class="p">,</span> <span class="n">outg0</span> <span class="o">=</span> <span class="n">freqz</span><span class="p">(</span><span class="n">bPrelim</span><span class="p">,</span> <span class="n">aPrelim</span><span class="p">,</span> <span class="mi">100</span><span class="o">/</span><span class="n">nyq</span><span class="p">)</span>

    <span class="c"># Return the numerator and denominator of the digital filter                                </span>
    <span class="n">b</span><span class="p">,</span><span class="n">a</span> <span class="o">=</span> <span class="n">zpk2tf</span><span class="p">(</span><span class="n">zd</span><span class="p">,</span><span class="n">pd</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span>

<span class="k">def</span> <span class="nf">get_filter_coefs</span><span class="p">(</span><span class="n">fs</span><span class="p">):</span>
    
    <span class="c"># assemble the filter b,a coefficients:</span>
    <span class="n">coefs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c"># bandpass filter parameters</span>
    <span class="n">lowcut</span><span class="o">=</span><span class="mi">43</span>
    <span class="n">highcut</span><span class="o">=</span><span class="mi">260</span>
    <span class="n">order</span> <span class="o">=</span> <span class="mi">4</span>

    <span class="c"># bandpass filter coefficients </span>
    <span class="n">nyq</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">fs</span>
    <span class="n">low</span> <span class="o">=</span> <span class="n">lowcut</span> <span class="o">/</span> <span class="n">nyq</span>
    <span class="n">high</span> <span class="o">=</span> <span class="n">highcut</span> <span class="o">/</span> <span class="n">nyq</span>
    <span class="n">bb</span><span class="p">,</span> <span class="n">ab</span> <span class="o">=</span> <span class="n">butter</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="p">[</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">],</span> <span class="n">btype</span><span class="o">=</span><span class="s">'band'</span><span class="p">)</span>
    <span class="n">coefs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">bb</span><span class="p">,</span><span class="n">ab</span><span class="p">))</span>

    <span class="c"># Frequencies of notches at known instrumental spectral line frequencies.</span>
    <span class="c"># You can see these lines in the ASD above, so it is straightforward to make this list.</span>
    <span class="n">notchesAbsolute</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span><span class="mf">14.0</span><span class="p">,</span><span class="mf">34.70</span><span class="p">,</span> <span class="mf">35.30</span><span class="p">,</span> <span class="mf">35.90</span><span class="p">,</span> <span class="mf">36.70</span><span class="p">,</span> <span class="mf">37.30</span><span class="p">,</span> <span class="mf">40.95</span><span class="p">,</span> <span class="mf">60.00</span><span class="p">,</span> 
         <span class="mf">120.00</span><span class="p">,</span> <span class="mf">179.99</span><span class="p">,</span> <span class="mf">304.99</span><span class="p">,</span> <span class="mf">331.49</span><span class="p">,</span> <span class="mf">510.02</span><span class="p">,</span> <span class="mf">1009.99</span><span class="p">])</span>

    <span class="c"># notch filter coefficients:</span>
    <span class="k">for</span> <span class="n">notchf</span> <span class="ow">in</span> <span class="n">notchesAbsolute</span><span class="p">:</span>                      
        <span class="n">bn</span><span class="p">,</span> <span class="n">an</span> <span class="o">=</span> <span class="n">iir_bandstops</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">notchf</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.1</span><span class="p">]]),</span> <span class="n">fs</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">coefs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">bn</span><span class="p">,</span><span class="n">an</span><span class="p">))</span>

    <span class="c"># Manually do a wider notch filter around 510 Hz etc.          </span>
    <span class="n">bn</span><span class="p">,</span> <span class="n">an</span> <span class="o">=</span> <span class="n">iir_bandstops</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">510</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">20</span><span class="p">]]),</span> <span class="n">fs</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">coefs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">bn</span><span class="p">,</span> <span class="n">an</span><span class="p">))</span>

    <span class="c"># also notch out the forest of lines around 331.5 Hz</span>
    <span class="n">bn</span><span class="p">,</span> <span class="n">an</span> <span class="o">=</span> <span class="n">iir_bandstops</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">331.5</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">1</span><span class="p">]]),</span> <span class="n">fs</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">coefs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">bn</span><span class="p">,</span> <span class="n">an</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">coefs</span>

<span class="c"># and then define the filter function:</span>
<span class="k">def</span> <span class="nf">filter_data</span><span class="p">(</span><span class="n">data_in</span><span class="p">,</span><span class="n">coefs</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data_in</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">coef</span> <span class="ow">in</span> <span class="n">coefs</span><span class="p">:</span>
        <span class="n">b</span><span class="p">,</span><span class="n">a</span> <span class="o">=</span> <span class="n">coef</span>
        <span class="c"># filtfilt applies a linear filter twice, once forward and once backwards.</span>
        <span class="c"># The combined filter has linear phase.</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">filtfilt</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span>
</pre></div>

</div></body></html>