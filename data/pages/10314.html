<html><body><div><article class="post-content">
  <p>I have <a href="https://micropython.org/">pyboard</a>, OLED display (SSD1306) and joystick (Keyes_SJoys),
so I decided to try to make breakout clone. First of all I decided to create
something like a little framework, that will be a bit similar to React, and all game
can be formalized just in two functions:</p>

<ul>
  <li><code class="highlighter-rouge">(state) → new-state</code> – controller that updates state;</li>
  <li><code class="highlighter-rouge">(state) → primitives</code> – view that converts state to generator of primitives.</li>
</ul>

<p>For example, code that draws chess cells and invert it on click, will be like:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">lib.ssd1306</span> <span class="kn">import</span> <span class="n">Display</span>
<span class="kn">from</span> <span class="nn">lib.keyes</span> <span class="kn">import</span> <span class="n">Joystick</span>
<span class="kn">from</span> <span class="nn">lib.engine</span> <span class="kn">import</span> <span class="n">Game</span><span class="p">,</span> <span class="n">rectangle</span><span class="p">,</span> <span class="n">text</span>


<span class="k">def</span> <span class="nf">is_filled</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">inverted</span><span class="p">):</span>
    <span class="n">fill</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span> <span class="o">%</span> <span class="mi">40</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">inverted</span><span class="p">:</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">fill</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fill</span>


<span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
    <span class="c"># Display data available in state['display']</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">state</span><span class="p">[</span><span class="s">'display'</span><span class="p">][</span><span class="s">'width'</span><span class="p">],</span> <span class="mi">20</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">state</span><span class="p">[</span><span class="s">'display'</span><span class="p">][</span><span class="s">'height'</span><span class="p">],</span> <span class="mi">20</span><span class="p">):</span>
            <span class="c"># rectangle is bundled view that yields points</span>
            <span class="k">yield</span> <span class="kn">from</span> <span class="nn">rectangle</span><span class="err">(</span><span class="nn">x</span><span class="err">=</span><span class="nn">x</span><span class="err">,</span> <span class="nn">y</span><span class="err">=</span><span class="nn">y</span><span class="err">,</span> <span class="nn">w</span><span class="err">=20,</span> <span class="nn">h</span><span class="err">=20,
</span>                                 <span class="nn">fill</span><span class="err">=</span><span class="nn">is_filled</span><span class="err">(</span><span class="nn">x</span><span class="err">,</span> <span class="nn">y</span><span class="err">,</span> <span class="nn">state</span><span class="err">['</span><span class="nn">inverted</span><span class="err">']))


</span><span class="nn">def</span> <span class="nn">controller</span><span class="err">(</span><span class="nn">state</span><span class="err">):
</span>    <span class="err">#</span> <span class="nn">Joystick</span> <span class="nn">data</span> <span class="nn">available</span> <span class="nn">in</span> <span class="nn">state</span><span class="err">['</span><span class="nn">display</span><span class="err">']
</span>    <span class="nn">if</span> <span class="nn">state</span><span class="err">['</span><span class="nn">joystick</span><span class="err">']['</span><span class="nn">clicked</span><span class="err">']:
</span>        <span class="nn">return</span> <span class="nn">dict</span><span class="err">(</span><span class="nn">state</span><span class="err">,</span> <span class="nn">inverted</span><span class="err">=</span><span class="nn">not</span> <span class="nn">state</span><span class="err">['</span><span class="nn">inverted</span><span class="err">'])
</span>    <span class="nn">else</span><span class="err">:
</span>        <span class="nn">return</span> <span class="nn">state</span><span class="err">

</span><span class="nn">initial_state</span> <span class="err">=</span> <span class="err">{'</span><span class="nn">inverted</span><span class="err">':</span> <span class="nn">False</span><span class="err">}
</span><span class="nn">chess_deck</span> <span class="err">=</span> <span class="nn">Game</span><span class="err">(</span><span class="nn">display</span><span class="err">=</span><span class="nn">Display</span><span class="err">(</span><span class="nn">pinout</span><span class="err">={'</span><span class="nn">sda</span><span class="err">':</span> <span class="err">'</span><span class="nn">Y10</span><span class="err">',
</span>                                          <span class="err">'</span><span class="nn">scl</span><span class="err">':</span> <span class="err">'</span><span class="nn">Y9</span><span class="err">'},
</span>                                  <span class="nn">height</span><span class="err">=64,
</span>                                  <span class="nn">external_vcc</span><span class="err">=</span><span class="nn">False</span><span class="err">),
</span>                  <span class="nn">joystick</span><span class="err">=</span><span class="nn">Joystick</span><span class="err">('</span><span class="nn">X1</span><span class="err">',</span> <span class="err">'</span><span class="nn">X2</span><span class="err">',</span> <span class="err">'</span><span class="nn">X3</span><span class="err">'),
</span>                  <span class="nn">initial_state</span><span class="err">=</span><span class="nn">initial_state</span><span class="err">,
</span>                  <span class="nn">view</span><span class="err">=</span><span class="nn">view</span><span class="err">,
</span>                  <span class="nn">controller</span><span class="err">=</span><span class="nn">controller</span><span class="err">)

</span><span class="nn">if</span> <span class="nn">__name__</span> <span class="err">==</span> <span class="err">'</span><span class="nn">__main__</span><span class="err">':
</span>    <span class="nn">chess_deck.run</span><span class="err">()
</span></code></pre>
</div>

<p>In action:</p>

<p><img src="/assets/micropgame/chess.png" alt="Chess photo"/></p>

<p>From the code you can see, that views can be easily nested with <code class="highlighter-rouge">yield from</code>. So if we want to move
cell to separate view:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">cell</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">inverted</span><span class="p">):</span>
    <span class="k">yield</span> <span class="kn">from</span> <span class="nn">rectangle</span><span class="err">(</span><span class="nn">x</span><span class="err">=</span><span class="nn">x</span><span class="err">,</span> <span class="nn">y</span><span class="err">=</span><span class="nn">y</span><span class="err">,</span> <span class="nn">w</span><span class="err">=20,</span> <span class="nn">h</span><span class="err">=20,
</span>                         <span class="nn">fill</span><span class="err">=</span><span class="nn">is_filled</span><span class="err">(</span><span class="nn">x</span><span class="err">,</span> <span class="nn">y</span><span class="err">,</span> <span class="nn">inverted</span><span class="err">))


</span><span class="nn">def</span> <span class="nn">view</span><span class="err">(</span><span class="nn">state</span><span class="err">):
</span>    <span class="nn">for</span> <span class="nn">x</span> <span class="nn">in</span> <span class="nn">range</span><span class="err">(0,</span> <span class="nn">state</span><span class="err">['</span><span class="nn">display</span><span class="err">']['</span><span class="nn">width</span><span class="err">'],</span> <span class="err">20):
</span>        <span class="nn">for</span> <span class="nn">y</span> <span class="nn">in</span> <span class="nn">range</span><span class="err">(0,</span> <span class="nn">state</span><span class="err">['</span><span class="nn">display</span><span class="err">']['</span><span class="nn">height</span><span class="err">'],</span> <span class="err">20):
</span>            <span class="nn">yield</span> <span class="nn">from</span> <span class="nn">cell</span><span class="err">(</span><span class="nn">x</span><span class="err">,</span> <span class="nn">y</span><span class="err">,</span> <span class="nn">state</span><span class="err">['</span><span class="nn">inverted</span><span class="err">'])
</span></code></pre>
</div>

<p>And another nice thing about this approach, is that because of generators we consume not a lot of memory,
if we’ll make it eager, we’ll fail with <code class="highlighter-rouge">MemoryError: memory allocation failed</code> soon.</p>

<p>Back to breakout, let’s start with views, first of all implement splash screen:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">splash</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mi">20</span><span class="p">):</span>
        <span class="k">yield</span> <span class="kn">from</span> <span class="nn">rectangle</span><span class="err">(</span><span class="nn">x</span><span class="err">=</span><span class="nn">n</span><span class="err">,</span> <span class="nn">y</span><span class="err">=0,</span> <span class="nn">w</span><span class="err">=10,</span> <span class="nn">h</span><span class="err">=</span><span class="nn">h</span><span class="err">,</span> <span class="nn">fill</span><span class="err">=</span><span class="nn">True</span><span class="err">)

</span>    <span class="nn">yield</span> <span class="nn">from</span> <span class="nn">rectangle</span><span class="err">(</span><span class="nn">x</span><span class="err">=0,</span> <span class="nn">y</span><span class="err">=17,</span> <span class="nn">w</span><span class="err">=</span><span class="nn">w</span><span class="err">,</span> <span class="nn">h</span><span class="err">=30,</span> <span class="nn">fill</span><span class="err">=</span><span class="nn">False</span><span class="err">)
</span>    <span class="err">#</span> <span class="nn">text</span> <span class="nn">is</span> <span class="nn">bundled</span> <span class="nn">view</span><span class="err">
</span>    <span class="nn">yield</span> <span class="nn">from</span> <span class="nn">text</span><span class="err">(</span><span class="nn">x</span><span class="err">=0,</span> <span class="nn">y</span><span class="err">=20,</span> <span class="nn">string</span><span class="err">='</span><span class="nn">BREAKOUT</span><span class="err">',</span> <span class="nn">size</span><span class="err">=3)


</span><span class="nn">def</span> <span class="nn">view</span><span class="err">(</span><span class="nn">state</span><span class="err">):
</span>    <span class="nn">yield</span> <span class="nn">from</span> <span class="nn">splash</span><span class="err">(</span><span class="nn">state</span><span class="err">['</span><span class="nn">display</span><span class="err">']['</span><span class="nn">width</span><span class="err">'],
</span>                      <span class="nn">state</span><span class="err">['</span><span class="nn">display</span><span class="err">']['</span><span class="nn">height</span><span class="err">'])
</span></code></pre>
</div>

<p>It will draw a nice splash screen:</p>

<p><img src="/assets/micropgame/splash.jpg" alt="Splash screen"/></p>

<p>On splash screen game should be started when user press joystick, so we should update code a bit:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">GAME_NOT_STARTED</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">GAME_ACTIVE</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">GAME_OVER</span> <span class="o">=</span> <span class="mi">2</span>

<span class="k">def</span> <span class="nf">controller</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s">'status'</span><span class="p">]</span> <span class="o">==</span> <span class="n">GAME_NOT_STARTED</span> <span class="ow">and</span> <span class="n">state</span><span class="p">[</span><span class="s">'joystick'</span><span class="p">][</span><span class="s">'clicked'</span><span class="p">]:</span>
        <span class="n">state</span><span class="p">[</span><span class="s">'status'</span><span class="p">]</span> <span class="o">=</span> <span class="n">GAME_ACTIVE</span>
    <span class="k">return</span> <span class="n">state</span>


<span class="n">initial_state</span> <span class="o">=</span> <span class="p">{</span><span class="s">'status'</span><span class="p">:</span> <span class="n">GAME_NOT_STARTED</span><span class="p">}</span>
</code></pre>
</div>

<p>Now when joystick is pressed, game changes <code class="highlighter-rouge">status</code> to <code class="highlighter-rouge">GAME_ACTIVE</code>. And now it’s time to create view
for game screen:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">BRICK_W</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">BRICK_H</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">BRICK_BORDER</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">BRICK_ROWS</span> <span class="o">=</span> <span class="mi">4</span>

<span class="n">PADDLE_W</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">PADDLE_H</span> <span class="o">=</span> <span class="mi">4</span>

<span class="n">BALL_W</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">BALL_H</span> <span class="o">=</span> <span class="mi">3</span>


<span class="k">def</span> <span class="nf">brick</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">yield</span> <span class="kn">from</span> <span class="nn">rectangle</span><span class="err">(</span><span class="nn">x</span><span class="err">=</span><span class="nn">data</span><span class="err">['</span><span class="nn">x</span><span class="err">']</span> <span class="err">+</span> <span class="nn">BRICK_BORDER</span><span class="err">,
</span>                         <span class="nn">y</span><span class="err">=</span><span class="nn">data</span><span class="err">['</span><span class="nn">y</span><span class="err">']</span> <span class="err">+</span> <span class="nn">BRICK_BORDER</span><span class="err">,
</span>                         <span class="nn">w</span><span class="err">=</span><span class="nn">BRICK_W</span> <span class="err">-</span> <span class="nn">BRICK_BORDER</span><span class="err">,
</span>                         <span class="nn">h</span><span class="err">=</span><span class="nn">BRICK_H</span> <span class="err">-</span> <span class="nn">BRICK_BORDER</span><span class="err">,
</span>                         <span class="nn">fill</span><span class="err">=</span><span class="nn">True</span><span class="err">)


</span><span class="nn">def</span> <span class="nn">paddle</span><span class="err">(</span><span class="nn">data</span><span class="err">):
</span>    <span class="nn">yield</span> <span class="nn">from</span> <span class="nn">rectangle</span><span class="err">(</span><span class="nn">x</span><span class="err">=</span><span class="nn">data</span><span class="err">['</span><span class="nn">x</span><span class="err">'],</span> <span class="nn">y</span><span class="err">=</span><span class="nn">data</span><span class="err">['</span><span class="nn">y</span><span class="err">'],
</span>                         <span class="nn">w</span><span class="err">=</span><span class="nn">PADDLE_W</span><span class="err">,</span> <span class="nn">h</span><span class="err">=</span><span class="nn">PADDLE_H</span><span class="err">,
</span>                         <span class="nn">fill</span><span class="err">=</span><span class="nn">True</span><span class="err">)


</span><span class="nn">def</span> <span class="nn">ball</span><span class="err">(</span><span class="nn">data</span><span class="err">):
</span>    <span class="nn">yield</span> <span class="nn">from</span> <span class="nn">rectangle</span><span class="err">(</span><span class="nn">x</span><span class="err">=</span><span class="nn">data</span><span class="err">['</span><span class="nn">x</span><span class="err">'],</span> <span class="nn">y</span><span class="err">=</span><span class="nn">data</span><span class="err">['</span><span class="nn">y</span><span class="err">'],
</span>                         <span class="nn">w</span><span class="err">=</span><span class="nn">BALL_W</span><span class="err">,</span> <span class="nn">h</span><span class="err">=</span><span class="nn">BALL_H</span><span class="err">,</span> <span class="nn">fill</span><span class="err">=</span><span class="nn">True</span><span class="err">)


</span><span class="nn">def</span> <span class="nn">deck</span><span class="err">(</span><span class="nn">state</span><span class="err">):
</span>    <span class="nn">for</span> <span class="nn">brick_data</span> <span class="nn">in</span> <span class="nn">state</span><span class="err">['</span><span class="nn">bricks</span><span class="err">']:
</span>        <span class="nn">yield</span> <span class="nn">from</span> <span class="nn">brick</span><span class="err">(</span><span class="nn">brick_data</span><span class="err">)

</span>    <span class="nn">yield</span> <span class="nn">from</span> <span class="nn">paddle</span><span class="err">(</span><span class="nn">state</span><span class="err">['</span><span class="nn">paddle</span><span class="err">'])
</span>    <span class="nn">yield</span> <span class="nn">from</span> <span class="nn">ball</span><span class="err">(</span><span class="nn">state</span><span class="err">['</span><span class="nn">ball</span><span class="err">'])


</span><span class="nn">def</span> <span class="nn">view</span><span class="err">(</span><span class="nn">state</span><span class="err">):
</span>    <span class="nn">if</span> <span class="nn">state</span><span class="err">['</span><span class="nn">status</span><span class="err">']</span> <span class="err">==</span> <span class="nn">GAME_NOT_STARTED</span><span class="err">:
</span>        <span class="nn">yield</span> <span class="nn">from</span> <span class="nn">splash</span><span class="err">(</span><span class="nn">state</span><span class="err">['</span><span class="nn">display</span><span class="err">']['</span><span class="nn">width</span><span class="err">'],
</span>                          <span class="nn">state</span><span class="err">['</span><span class="nn">display</span><span class="err">']['</span><span class="nn">height</span><span class="err">'])
</span>    <span class="nn">else</span><span class="err">:
</span>        <span class="nn">yield</span> <span class="nn">from</span> <span class="nn">deck</span><span class="err">(</span><span class="nn">state</span><span class="err">)


</span><span class="nn">def</span> <span class="nn">get_initial_game_state</span><span class="err">(</span><span class="nn">state</span><span class="err">):
</span>    <span class="nn">state</span><span class="err">['</span><span class="nn">status</span><span class="err">']</span> <span class="err">=</span> <span class="nn">GAME_ACTIVE</span><span class="err">
</span>    <span class="nn">state</span><span class="err">['</span><span class="nn">bricks</span><span class="err">']</span> <span class="err">=</span> <span class="err">[{'</span><span class="nn">x</span><span class="err">':</span> <span class="nn">x</span><span class="err">,</span> <span class="err">'</span><span class="nn">y</span><span class="err">':</span> <span class="nn">yn</span> <span class="err">*</span> <span class="nn">BRICK_H</span><span class="err">}
</span>                       <span class="nn">for</span> <span class="nn">x</span> <span class="nn">in</span> <span class="nn">range</span><span class="err">(0,</span> <span class="nn">state</span><span class="err">['</span><span class="nn">display</span><span class="err">']['</span><span class="nn">width</span><span class="err">'],</span> <span class="nn">BRICK_W</span><span class="err">)
</span>                       <span class="nn">for</span> <span class="nn">yn</span> <span class="nn">in</span> <span class="nn">range</span><span class="err">(</span><span class="nn">BRICK_ROWS</span><span class="err">)]
</span>    <span class="nn">state</span><span class="err">['</span><span class="nn">paddle</span><span class="err">']</span> <span class="err">=</span> <span class="err">{'</span><span class="nn">x</span><span class="err">':</span> <span class="err">(</span><span class="nn">state</span><span class="err">['</span><span class="nn">display</span><span class="err">']['</span><span class="nn">width</span><span class="err">']</span> <span class="err">-</span> <span class="nn">PADDLE_W</span><span class="err">)</span> <span class="err">/</span> <span class="err">2,
</span>                       <span class="err">'</span><span class="nn">y</span><span class="err">':</span> <span class="nn">state</span><span class="err">['</span><span class="nn">display</span><span class="err">']['</span><span class="nn">height</span><span class="err">']</span> <span class="err">-</span> <span class="nn">PADDLE_H</span><span class="err">}
</span>    <span class="nn">state</span><span class="err">['</span><span class="nn">ball</span><span class="err">']</span> <span class="err">=</span> <span class="err">{'</span><span class="nn">x</span><span class="err">':</span> <span class="err">(</span><span class="nn">state</span><span class="err">['</span><span class="nn">display</span><span class="err">']['</span><span class="nn">width</span><span class="err">']</span> <span class="err">-</span> <span class="nn">BALL_W</span><span class="err">)</span> <span class="err">/</span> <span class="err">2,
</span>                     <span class="err">'</span><span class="nn">y</span><span class="err">':</span> <span class="nn">state</span><span class="err">['</span><span class="nn">display</span><span class="err">']['</span><span class="nn">height</span><span class="err">']</span> <span class="err">-</span> <span class="nn">PADDLE_H</span> <span class="err">*</span> <span class="err">2</span> <span class="err">-</span> <span class="nn">BALL_W</span><span class="err">}
</span>    <span class="nn">return</span> <span class="nn">state</span><span class="err">


</span><span class="nn">def</span> <span class="nn">controller</span><span class="err">(</span><span class="nn">state</span><span class="err">):
</span>    <span class="nn">if</span> <span class="nn">state</span><span class="err">['</span><span class="nn">status</span><span class="err">']</span> <span class="err">==</span> <span class="nn">GAME_NOT_STARTED</span> <span class="nn">and</span> <span class="nn">state</span><span class="err">['</span><span class="nn">joystick</span><span class="err">']['</span><span class="nn">clicked</span><span class="err">']:
</span>        <span class="nn">state</span> <span class="err">=</span> <span class="nn">get_initial_game_state</span><span class="err">(</span><span class="nn">state</span><span class="err">)
</span>    <span class="nn">return</span> <span class="nn">state</span><span class="err">
</span></code></pre>
</div>

<p><img src="/assets/micropgame/deck.jpg" alt="Game screen"/></p>

<p>And last part of views – game over screen:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">game_over</span><span class="p">():</span>
    <span class="k">yield</span> <span class="kn">from</span> <span class="nn">text</span><span class="err">(</span><span class="nn">x</span><span class="err">=0,</span> <span class="nn">y</span><span class="err">=20,</span> <span class="nn">string</span><span class="err">='</span><span class="nn">GAMEOVER</span><span class="err">',</span> <span class="nn">size</span><span class="err">=3)


</span><span class="nn">def</span> <span class="nn">view</span><span class="err">(</span><span class="nn">state</span><span class="err">):
</span>    <span class="nn">if</span> <span class="nn">state</span><span class="err">['</span><span class="nn">status</span><span class="err">']</span> <span class="err">==</span> <span class="nn">GAME_NOT_STARTED</span><span class="err">:
</span>        <span class="nn">yield</span> <span class="nn">from</span> <span class="nn">splash</span><span class="err">(</span><span class="nn">state</span><span class="err">['</span><span class="nn">display</span><span class="err">']['</span><span class="nn">width</span><span class="err">'],
</span>                          <span class="nn">state</span><span class="err">['</span><span class="nn">display</span><span class="err">']['</span><span class="nn">height</span><span class="err">'])
</span>    <span class="nn">else</span><span class="err">:
</span>        <span class="nn">yield</span> <span class="nn">from</span> <span class="nn">deck</span><span class="err">(</span><span class="nn">state</span><span class="err">)
</span>        <span class="nn">if</span> <span class="nn">state</span><span class="err">['</span><span class="nn">status</span><span class="err">']</span> <span class="err">==</span> <span class="nn">GAME_OVER</span><span class="err">:
</span>            <span class="nn">yield</span> <span class="nn">from</span> <span class="nn">game_over</span><span class="err">()
</span></code></pre>
</div>

<p><img src="/assets/micropgame/game_over.jpg" alt="Game screen"/></p>

<p>So we ended up with views, now we should add ability to move paddle with joystick:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">update_paddle</span><span class="p">(</span><span class="n">paddle</span><span class="p">,</span> <span class="n">joystick</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
    <span class="n">paddle</span><span class="p">[</span><span class="s">'x'</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">joystick</span><span class="p">[</span><span class="s">'x'</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">paddle</span><span class="p">[</span><span class="s">'x'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">paddle</span><span class="p">[</span><span class="s">'x'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">paddle</span><span class="p">[</span><span class="s">'x'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">w</span> <span class="o">-</span> <span class="n">PADDLE_W</span><span class="p">):</span>
        <span class="n">paddle</span><span class="p">[</span><span class="s">'x'</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span> <span class="o">-</span> <span class="n">PADDLE_W</span>
    <span class="k">return</span> <span class="n">paddle</span>


<span class="k">def</span> <span class="nf">controller</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s">'status'</span><span class="p">]</span> <span class="o">==</span> <span class="n">GAME_NOT_STARTED</span> <span class="ow">and</span> <span class="n">state</span><span class="p">[</span><span class="s">'joystick'</span><span class="p">][</span><span class="s">'clicked'</span><span class="p">]:</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">get_initial_game_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">state</span><span class="p">[</span><span class="s">'status'</span><span class="p">]</span> <span class="o">==</span> <span class="n">GAME_ACTIVE</span><span class="p">:</span>
        <span class="n">state</span><span class="p">[</span><span class="s">'paddle'</span><span class="p">]</span> <span class="o">=</span> <span class="n">update_paddle</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s">'paddle'</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="s">'joystick'</span><span class="p">],</span>
                                        <span class="n">state</span><span class="p">[</span><span class="s">'display'</span><span class="p">][</span><span class="s">'width'</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">state</span>
</code></pre>
</div>

<p>Never mind performance, it’ll be fixed in the end of the article:</p>

<iframe class="gifify" src="https://www.youtube.com/embed/gnGoaE76TPM?enablejsapi=1&amp;showinfo=0&amp;controls=0" frameborder="0" allowfullscreen="">VIDEO</iframe>

<p>Now it’s time for teh hardest thing – moving and bouncing ball, so there’s no real physics, for simplification
ball movements will be represented as <code class="highlighter-rouge">vx</code> and <code class="highlighter-rouge">vy</code>, so when ball:</p>

<ul>
  <li>initialised: <code class="highlighter-rouge">vx = rand(SPEED)</code>, <code class="highlighter-rouge">vy = √SPEED^2 - vx^2</code>;</li>
  <li>hits the top wall: <code class="highlighter-rouge">vy = -vy</code>;</li>
  <li>hits the left or right wall: <code class="highlighter-rouge">vx = -vx</code>:</li>
  <li>hits the brick or paddle: <code class="highlighter-rouge">vx = vx + (0.5 - intersection) * SPEED</code>, where intersection is between <code class="highlighter-rouge">0</code> and <code class="highlighter-rouge">1</code>;
<code class="highlighter-rouge">vy = √SPEED^2 - vx^2</code>.</li>
</ul>

<p>And I implemented something like this with a few hacks:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">BALL_SPEED</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">BALL_SPEED_BORDER</span> <span class="o">=</span> <span class="mf">0.5</span>


<span class="k">def</span> <span class="nf">get_initial_game_state</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
    <span class="n">state</span><span class="p">[</span><span class="s">'status'</span><span class="p">]</span> <span class="o">=</span> <span class="n">GAME_ACTIVE</span>
    <span class="n">state</span><span class="p">[</span><span class="s">'bricks'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s">'x'</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s">'y'</span><span class="p">:</span> <span class="n">yn</span> <span class="o">*</span> <span class="n">BRICK_H</span><span class="p">}</span>
                       <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">state</span><span class="p">[</span><span class="s">'display'</span><span class="p">][</span><span class="s">'width'</span><span class="p">],</span> <span class="n">BRICK_W</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">yn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">BRICK_ROWS</span><span class="p">)]</span>
    <span class="n">state</span><span class="p">[</span><span class="s">'paddle'</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">'x'</span><span class="p">:</span> <span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s">'display'</span><span class="p">][</span><span class="s">'width'</span><span class="p">]</span> <span class="o">-</span> <span class="n">PADDLE_W</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                       <span class="s">'y'</span><span class="p">:</span> <span class="n">state</span><span class="p">[</span><span class="s">'display'</span><span class="p">][</span><span class="s">'height'</span><span class="p">]</span> <span class="o">-</span> <span class="n">PADDLE_H</span><span class="p">}</span>

    <span class="c"># Initial velocity for ball:</span>
    <span class="n">ball_vx</span> <span class="o">=</span> <span class="n">BALL_SPEED_BORDER</span> <span class="o">+</span> <span class="n">pyb</span><span class="o">.</span><span class="n">rng</span><span class="p">()</span> <span class="o">%</span> <span class="p">(</span><span class="n">BALL_SPEED</span> <span class="o">-</span> <span class="n">BALL_SPEED_BORDER</span><span class="p">)</span>
    <span class="n">ball_vy</span> <span class="o">=</span> <span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">BALL_SPEED</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">ball_vx</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">state</span><span class="p">[</span><span class="s">'ball'</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">'x'</span><span class="p">:</span> <span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s">'display'</span><span class="p">][</span><span class="s">'width'</span><span class="p">]</span> <span class="o">-</span> <span class="n">BALL_W</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                     <span class="s">'y'</span><span class="p">:</span> <span class="n">state</span><span class="p">[</span><span class="s">'display'</span><span class="p">][</span><span class="s">'height'</span><span class="p">]</span> <span class="o">-</span> <span class="n">PADDLE_H</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">BALL_W</span><span class="p">,</span>
                     <span class="s">'vx'</span><span class="p">:</span> <span class="n">ball_vx</span><span class="p">,</span>
                     <span class="s">'vy'</span><span class="p">:</span> <span class="n">ball_vy</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">state</span>


<span class="k">def</span> <span class="nf">calculate_velocity</span><span class="p">(</span><span class="n">ball</span><span class="p">,</span> <span class="n">item_x</span><span class="p">,</span> <span class="n">item_w</span><span class="p">):</span>
    <span class="s">"""Calculates velocity for collision."""</span>
    <span class="n">intersection</span> <span class="o">=</span> <span class="p">(</span><span class="n">item_x</span> <span class="o">+</span> <span class="n">item_w</span> <span class="o">-</span> <span class="n">ball</span><span class="p">[</span><span class="s">'x'</span><span class="p">])</span> <span class="o">/</span> <span class="n">item_w</span>
    <span class="n">vx</span> <span class="o">=</span> <span class="n">ball</span><span class="p">[</span><span class="s">'vx'</span><span class="p">]</span> <span class="o">+</span> <span class="n">BALL_SPEED</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">intersection</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">vx</span> <span class="o">&gt;</span> <span class="n">BALL_SPEED</span> <span class="o">-</span> <span class="n">BALL_SPEED_BORDER</span><span class="p">:</span>
        <span class="n">vx</span> <span class="o">=</span> <span class="n">BALL_SPEED</span> <span class="o">-</span> <span class="n">BALL_SPEED_BORDER</span>
    <span class="k">elif</span> <span class="n">vx</span> <span class="o">&lt;</span> <span class="n">BALL_SPEED_BORDER</span> <span class="o">-</span> <span class="n">BALL_SPEED</span><span class="p">:</span>
        <span class="n">vx</span> <span class="o">=</span> <span class="n">BALL_SPEED_BORDER</span> <span class="o">-</span> <span class="n">BALL_SPEED</span>

    <span class="n">vy</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">BALL_SPEED</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">vx</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ball</span><span class="p">[</span><span class="s">'vy'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">vy</span> <span class="o">=</span> <span class="o">-</span> <span class="n">vy</span>
    <span class="k">return</span> <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span>


<span class="k">def</span> <span class="nf">collide</span><span class="p">(</span><span class="n">ball</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">item_w</span><span class="p">,</span> <span class="n">item_h</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">item</span><span class="p">[</span><span class="s">'x'</span><span class="p">]</span> <span class="o">-</span> <span class="n">BALL_W</span> <span class="o">&lt;</span> <span class="n">ball</span><span class="p">[</span><span class="s">'x'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">item</span><span class="p">[</span><span class="s">'x'</span><span class="p">]</span> <span class="o">+</span> <span class="n">item_w</span> \
           <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="s">'y'</span><span class="p">]</span> <span class="o">-</span> <span class="n">BALL_H</span> <span class="o">&lt;</span> <span class="n">ball</span><span class="p">[</span><span class="s">'y'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">item</span><span class="p">[</span><span class="s">'y'</span><span class="p">]</span> <span class="o">+</span> <span class="n">item_h</span>


<span class="k">def</span> <span class="nf">update_ball</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
    <span class="n">state</span><span class="p">[</span><span class="s">'ball'</span><span class="p">][</span><span class="s">'x'</span><span class="p">]</span> <span class="o">+=</span> <span class="n">state</span><span class="p">[</span><span class="s">'ball'</span><span class="p">][</span><span class="s">'vx'</span><span class="p">]</span>
    <span class="n">state</span><span class="p">[</span><span class="s">'ball'</span><span class="p">][</span><span class="s">'y'</span><span class="p">]</span> <span class="o">+=</span> <span class="n">state</span><span class="p">[</span><span class="s">'ball'</span><span class="p">][</span><span class="s">'vy'</span><span class="p">]</span>

    <span class="c"># Collide with left/right wall</span>
    <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s">'ball'</span><span class="p">][</span><span class="s">'x'</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">state</span><span class="p">[</span><span class="s">'ball'</span><span class="p">][</span><span class="s">'x'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">state</span><span class="p">[</span><span class="s">'display'</span><span class="p">][</span><span class="s">'width'</span><span class="p">]:</span>
        <span class="n">state</span><span class="p">[</span><span class="s">'ball'</span><span class="p">][</span><span class="s">'vx'</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">state</span><span class="p">[</span><span class="s">'ball'</span><span class="p">][</span><span class="s">'vx'</span><span class="p">]</span>

    <span class="c"># Collide with top wall</span>
    <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s">'ball'</span><span class="p">][</span><span class="s">'y'</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">state</span><span class="p">[</span><span class="s">'ball'</span><span class="p">][</span><span class="s">'vy'</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">state</span><span class="p">[</span><span class="s">'ball'</span><span class="p">][</span><span class="s">'vy'</span><span class="p">]</span>

    <span class="c"># Collide with paddle</span>
    <span class="k">if</span> <span class="n">collide</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s">'ball'</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="s">'paddle'</span><span class="p">],</span> <span class="n">PADDLE_W</span><span class="p">,</span> <span class="n">PADDLE_H</span><span class="p">):</span>
        <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span> <span class="o">=</span> <span class="n">calculate_velocity</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s">'ball'</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="s">'paddle'</span><span class="p">][</span><span class="s">'x'</span><span class="p">],</span> <span class="n">PADDLE_W</span><span class="p">)</span>
        <span class="n">state</span><span class="p">[</span><span class="s">'ball'</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">vx</span><span class="o">=</span><span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="o">=</span><span class="n">vy</span><span class="p">)</span>

    <span class="c"># Collide with brick</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">brick</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s">'bricks'</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">collide</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s">'ball'</span><span class="p">],</span> <span class="n">brick</span><span class="p">,</span> <span class="n">BRICK_W</span><span class="p">,</span> <span class="n">BRICK_H</span><span class="p">):</span>
            <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span> <span class="o">=</span> <span class="n">calculate_velocity</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s">'ball'</span><span class="p">],</span> <span class="n">brick</span><span class="p">[</span><span class="s">'x'</span><span class="p">],</span> <span class="n">BRICK_W</span><span class="p">)</span>
            <span class="n">state</span><span class="p">[</span><span class="s">'ball'</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">vx</span><span class="o">=</span><span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="o">=</span><span class="n">vy</span><span class="p">)</span>
            <span class="n">state</span><span class="p">[</span><span class="s">'bricks'</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">state</span>


<span class="k">def</span> <span class="nf">controller</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s">'status'</span><span class="p">]</span> <span class="o">==</span> <span class="n">GAME_NOT_STARTED</span> <span class="ow">and</span> <span class="n">state</span><span class="p">[</span><span class="s">'joystick'</span><span class="p">][</span><span class="s">'clicked'</span><span class="p">]:</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">get_initial_game_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">state</span><span class="p">[</span><span class="s">'status'</span><span class="p">]</span> <span class="o">==</span> <span class="n">GAME_ACTIVE</span><span class="p">:</span>
        <span class="n">state</span><span class="p">[</span><span class="s">'paddle'</span><span class="p">]</span> <span class="o">=</span> <span class="n">update_paddle</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s">'paddle'</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="s">'joystick'</span><span class="p">],</span>
                                        <span class="n">state</span><span class="p">[</span><span class="s">'display'</span><span class="p">][</span><span class="s">'width'</span><span class="p">])</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">update_ball</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">state</span>
</code></pre>
</div>

<p>And it seems to be wroking:</p>

<iframe class="gifify" src="https://www.youtube.com/embed/_MrHGfwHi-k?enablejsapi=1&amp;showinfo=0&amp;controls=0" frameborder="0" allowfullscreen="">VIDEO</iframe>

<p>So now the last part, we should show “Game Over” when ball hits the bottom wall or when all bricks destroyed,
and then start game again if user clicks joystick:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">is_game_over</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="n">state</span><span class="p">[</span><span class="s">'bricks'</span><span class="p">]</span> <span class="ow">or</span> <span class="n">state</span><span class="p">[</span><span class="s">'ball'</span><span class="p">][</span><span class="s">'y'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">state</span><span class="p">[</span><span class="s">'display'</span><span class="p">][</span><span class="s">'height'</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">controller</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s">'status'</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="n">GAME_NOT_STARTED</span><span class="p">,</span> <span class="n">GAME_OVER</span><span class="p">)</span>\
            <span class="ow">and</span> <span class="n">state</span><span class="p">[</span><span class="s">'joystick'</span><span class="p">][</span><span class="s">'clicked'</span><span class="p">]:</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">get_initial_game_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">state</span><span class="p">[</span><span class="s">'status'</span><span class="p">]</span> <span class="o">==</span> <span class="n">GAME_ACTIVE</span><span class="p">:</span>
        <span class="n">state</span><span class="p">[</span><span class="s">'paddle'</span><span class="p">]</span> <span class="o">=</span> <span class="n">update_paddle</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s">'paddle'</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="s">'joystick'</span><span class="p">],</span>
                                        <span class="n">state</span><span class="p">[</span><span class="s">'display'</span><span class="p">][</span><span class="s">'width'</span><span class="p">])</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">update_ball</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_game_over</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
            <span class="n">state</span><span class="p">[</span><span class="s">'status'</span><span class="p">]</span> <span class="o">=</span> <span class="n">GAME_OVER</span>
    <span class="k">return</span> <span class="n">state</span>
</code></pre>
</div>

<p>And it works too:</p>

<iframe class="gifify" src="https://www.youtube.com/embed/2oZOWgoKTnI?enablejsapi=1&amp;showinfo=0&amp;controls=0" frameborder="0" allowfullscreen="">VIDEO</iframe>

<p>Performance so bad because drawing pixel on the screen is relatively time consuming operation, 
and we can easily fix performance by just decreasing count of bricks:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">BRICK_W</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">BRICK_H</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">BRICK_BORDER</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">BRICK_ROWS</span> <span class="o">=</span> <span class="mi">3</span>
</code></pre>
</div>

<p>And now it’s smooth:</p>

<iframe class="gifify" src="https://www.youtube.com/embed/4YKx9z6j1aA?enablejsapi=1&amp;showinfo=0&amp;controls=0" frameborder="0" allowfullscreen="">VIDEO</iframe>

<p><a href="https://github.com/nvbn/pyboard-play">Source code.</a></p>

</article>


</div></body></html>