<html><body><div><div id="content">

            

            
        


            <div class="section">
              <h1>Torrelque 0.1.2</h1>

              


<p>Asynchronous Tornado Redis-based reliable queue package</p>








<a href="https://drone.io/bitbucket.org/saaj/torrelque/latest" rel="nofollow"><img src="https://drone.io/bitbucket.org/saaj/torrelque/status.png"/></a>
<a href="https://codecov.io/bitbucket/saaj/torrelque?branch=default" rel="nofollow"><img src="https://codecov.io/bitbucket/saaj/torrelque/coverage.svg?branch=default"/></a>
<a href="https://pypi.python.org/pypi/Torrelque" rel="nofollow"><img src="https://badge.fury.io/py/Torrelque.png"/></a>
<div id="torrelque">
<h2>Torrelque</h2>
<p>Torrelque is a Python3 package that provides a reliable Redis-backed queues and runs on
Tornado IO-loop.</p>
<p>Without further ado it’s easy to say the package is an implementation of the queue described
in <a href="http://blog.bronto.com/engineering/reliable-queueing-in-redis-part-1/" rel="nofollow">this blog post</a>
with some required changes and improvements.</p>
<p>There’s also a related, synchronous queue package called <a href="https://pypi.python.org/pypi/saferedisqueue" rel="nofollow">saferedisqueue</a>.</p>
<div id="install">
<h3>Install</h3>
<pre>pip install Torrelque
</pre>
</div>
<div id="use">
<h3>Use</h3>
<pre><span class="ch">#!/usr/bin/env python3</span>


<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">tornadoredis</span>
<span class="kn">from</span> <span class="nn">tornado</span> <span class="kn">import</span> <span class="n">gen</span><span class="p">,</span> <span class="n">ioloop</span>
<span class="kn">from</span> <span class="nn">torrelque</span> <span class="kn">import</span> <span class="n">Torrelque</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>


<span class="nd">@gen.coroutine</span>
<span class="k">def</span> <span class="nf">produce</span><span class="p">():</span>
    <span class="n">redis</span> <span class="o">=</span> <span class="n">tornadoredis</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="n">Torrelque</span><span class="p">(</span><span class="n">redis</span><span class="p">,</span> <span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">current</span><span class="p">())</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="n">task</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'value'</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">99</span><span class="p">)}</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">'Produced task </span><span class="si">%s</span><span class="s1">'</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">queue</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">gen</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>


<span class="nd">@gen.coroutine</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">task_data</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">'Consmed task </span><span class="si">%s</span><span class="s1">'</span><span class="p">,</span> <span class="n">task_data</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">gen</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="nd">@gen.coroutine</span>
<span class="k">def</span> <span class="nf">consume</span><span class="p">():</span>
    <span class="n">redis</span> <span class="o">=</span> <span class="n">tornadoredis</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="n">Torrelque</span><span class="p">(</span><span class="n">redis</span><span class="p">,</span> <span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">current</span><span class="p">())</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">task_id</span><span class="p">,</span> <span class="n">task_data</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">queue</span><span class="o">.</span><span class="n">dequeue</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">task_id</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">process</span><span class="p">(</span><span class="n">task_data</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">queue</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">'Job processing has failed'</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">queue</span><span class="o">.</span><span class="n">requeue</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">delay</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>

<span class="nd">@gen.coroutine</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">current</span><span class="p">()</span><span class="o">.</span><span class="n">spawn_callback</span><span class="p">(</span><span class="n">consume</span><span class="p">)</span>

    <span class="k">yield</span> <span class="n">produce</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="n">format</span> <span class="o">=</span> <span class="s1">'</span><span class="si">%(asctime)s</span><span class="s1"> </span><span class="si">%(message)s</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre>
</div>
</div>


<a name="downloads"> </a>


<ul class="nodot">
  <li><strong>Downloads (All Versions):</strong></li>
  <li>
    <span>0</span> downloads in the last day
  </li>
  <li>
    <span>22</span> downloads in the last week
  </li>
  <li>
    <span>128</span> downloads in the last month
  </li>
</ul>









            </div>


          </div>
          </div></body></html>