<html><body><div><div class="section" id="why-should-you-use-tox"><h2>Why should you use tox?<a class="headerlink" href="#why-should-you-use-tox" title="Permalink to this headline"> *</a></h2><p>There are several advantages of using <a class="reference external" href="https://testrun.org/tox/">tox</a>:</p><ul class="simple"><li>It simplifies contributor ramp-up. Just run <tt class="docutils literal">tox</tt> and you're set - no more reading dozen install, setup and testing instructions just to run the tests.</li><li>It's portable on Linux, OS X and Windows.</li><li>Reduces that ugly shell script boilerplate.</li></ul><p>There are some alternatives to <a class="reference external" href="https://testrun.org/tox/">tox</a>, however, they have some disadvantages:</p><ul class="simple"><li><a class="reference external" href="https://www.gnu.org/software/make/">Make</a>: tricky to install on Windows and it's not really designed for testing python packages. You'd still need to do lots of shell scripting to achieve what <a class="reference external" href="https://testrun.org/tox/">tox</a> does out of the box.</li><li><a class="reference external" href="http://www.pyinvoke.org/">Invoke</a> (or its <a class="reference external" href="http://www.pyinvoke.org/prior_art.html">alternatives</a>): again, this is not designed for testing python packages - it's something way more generic and you'd have to either write everything yourself or use a 3rd party task libraries. <a class="footnote-reference" href="#invoke-libs" id="id3">[4]</a></li><li>Shell scripts: this is the worst of the lot. Besides them being unportable and hard to read, I'm pretty tired of seeing people doing accidental <tt class="docutils literal">rm <span class="pre">-rf</span> /</tt> (because shell scripts don't error or uninitialized variables by default) or having some other obscure bugs. Read this terrifying <a class="reference external" href="http://mywiki.wooledge.org/BashPitfalls">list of Bash pitfalls</a>.</li></ul><p>There are probably other tools I haven't considered, feel free to comment, if you still think there's something better than <a class="reference external" href="https://testrun.org/tox/">tox</a>. :-)</p></div><div class="section" id="effective-use"><h2>Effective use<a class="headerlink" href="#effective-use" title="Permalink to this headline"> *</a></h2><p>Because <a class="reference external" href="https://testrun.org/tox/">tox</a> was designed for the aforementioned workflow some things are hard to do, or the best way is unclear. I'm going to go over few less known tricks and patterns.</p><div class="section" id="command-overriding"><h3>Command overriding<a class="headerlink" href="#command-overriding" title="Permalink to this headline"> *</a></h3><p>I usually allow overriding the test command <a class="footnote-reference" href="#command-substitution" id="id4">[2]</a>. This allows me to use <a class="reference external" href="https://testrun.org/tox/">tox</a> for ad-hoc development.</p><div class="highlight"><pre><span/><span class="k">[testenv]</span>
<span class="na">deps</span> <span class="o">=</span> <span class="s">pytest</span>
<span class="na">commands</span> <span class="o">=</span> <span class="s">{posargs:py.test}</span>
</pre></div><p>With that you can conveniently do any of:</p><ul class="simple"><li><tt class="docutils literal">tox <span class="pre">--</span> py.test <span class="pre">-k</span> test_something</tt> to run tests matching <tt class="docutils literal">test_something</tt> in all the environments.</li><li><tt class="docutils literal">tox <span class="pre">-e</span> py34 <span class="pre">--</span> python</tt> to get the python REPL in that environment.</li><li><tt class="docutils literal">tox <span class="pre">-e</span> py27 <span class="pre">--</span> <span class="pre">django-admin</span> runserver</tt> to run the Django development server in that environment.</li></ul><p>And that would be run over all the available environments.</p></div><div class="section" id="lack-of-packaging"><h3>Lack of packaging<a class="headerlink" href="#lack-of-packaging" title="Permalink to this headline"> *</a></h3><p>Sometimes you lack a <tt class="docutils literal">setup.py</tt> and it doesn't make sense to have one. But you still want to use <a class="reference external" href="https://testrun.org/tox/">tox</a> because you want to use virtualenvs and run something in them. To make that work have this in your <tt class="docutils literal">tox.ini</tt>:</p><p>Note that this applies to all environments you use.</p></div><div class="section" id="compact-configuration"><h3>Compact configuration<a class="headerlink" href="#compact-configuration" title="Permalink to this headline"> *</a></h3><p>Using <a class="reference external" href="https://testrun.org/tox/latest/config.html#generating-environments-conditional-settings">conditional settings</a> you can make <tt class="docutils literal">tox.ini</tt> a lot more brief.</p><p>Compare this:</p><div class="highlight"><pre><span/><span class="k">[tox]</span>
<span class="na">envlist</span> <span class="o">=</span> <span class="s">py2.7-A,py3.4-A,py2.7-B,py3.4-B</span>

<span class="k">[testenv:py2.7-A]</span>
<span class="na">commands</span> <span class="o">=</span> <span class="s">&lt;do some stuff with A&gt;</span>

<span class="k">[testenv:py2.7-B]</span>
<span class="na">commands</span> <span class="o">=</span> <span class="s">&lt;do some stuff with B&gt;</span>

<span class="k">[testenv:py3.4-A]</span>
<span class="na">commands</span> <span class="o">=</span> <span class="s">&lt;do some stuff with A&gt;</span>

<span class="k">[testenv:py3.4-B]</span>
<span class="na">commands</span> <span class="o">=</span> <span class="s">&lt;do some stuff with B&gt;</span>
</pre></div><div class="highlight"><pre><span/><span class="k">[tox]</span>
<span class="na">envlist</span> <span class="o">=</span> <span class="s">py{2.7,3.4}-{A,B}</span>

<span class="k">[testenv]</span>
<span class="na">commands</span> <span class="o">=</span><span class="s"/>
<span class="s">    A: &lt;do some stuff with A&gt;</span>
<span class="s">    B: &lt;do some stuff with A&gt;</span>
</pre></div><p>Way more brief :-)</p></div><div class="section" id="environment-reuse"><h3>Environment reuse<a class="headerlink" href="#environment-reuse" title="Permalink to this headline"> *</a></h3><p>Sometimes you want to run several commands. Now you have two choices:</p><ul class="simple"><li>Have one environment with all the commands. This makes it hard to select an individual command.</li><li>Have a environment for each command. This makes command line selection very neat. However, now you have a virtualenv for each environment, which makes everything very slow unless ...</li></ul><p>... you have all the environments use the same virtualenv directory! As seen <a class="reference external" href="http://ronnypfannschmidt.de/posts/2015/my-pelican-setup/">here</a>, you can use a specific directory that doesn't need to be unique:</p><div class="highlight"><pre><span/><span class="k">[tox]</span>
<span class="na">skipsdist</span> <span class="o">=</span> <span class="s">true</span>
<span class="na">envlist</span> <span class="o">=</span> <span class="s">build</span>

<span class="k">[testenv]</span>
<span class="na">envdir</span> <span class="o">=</span> <span class="s">{toxinidir}/.env</span>

<span class="na">commands</span> <span class="o">=</span><span class="s"/>
<span class="s">    build: pelican --output output --settings settings.py --delete-output-directory []</span>
<span class="s">    watch: pelican --output output --settings settings.py --delete-output-directory --autoreload []</span>
<span class="s">    run: twistd -n web --path=.</span>
<span class="s">    publish: python ghp-import.py -m "Update gh-pages." output</span>
<span class="s">    publish: git push origin master</span>
<span class="s">    publish: git push origin gh-pages</span>
<span class="na">deps</span> <span class="o">=</span><span class="s"/>
<span class="s">    pelican==3.5.0</span>
<span class="s">    twisted==15.0.0</span>
</pre></div><p>With such an configuration you can do any of:</p><ul class="simple"><li><tt class="docutils literal">tox <span class="pre">-e</span> build,publish</tt> to build and deploy</li><li><tt class="docutils literal">tox <span class="pre">-e</span> watch</tt> to build and rebuild on file changes</li><li><tt class="docutils literal">tox <span class="pre">-e</span> run</tt> to just run a webserver</li></ul><p>Note the <tt class="docutils literal">[]</tt> in the build command allows adding extra arguments. Example:</p><ul class="simple"><li><tt class="docutils literal">tox <span class="pre">-e</span> build <span class="pre">--</span> <span class="pre">--debug</span></tt> to get some verbose logging.</li></ul></div><div class="section" id="when-it-inevitably-leads-to-shell-scripts"><h3>When it inevitably leads to shell scripts<a class="headerlink" href="#when-it-inevitably-leads-to-shell-scripts" title="Permalink to this headline"> *</a></h3><p>This is one thing that's annoying to do in <a class="reference external" href="https://testrun.org/tox/">Tox</a> - sometimes you do want to run some shell scripts, as bad as they are. <a class="footnote-reference" href="#terrible-shell-scripting" id="id5">[6]</a></p><p>Suppose you have a <tt class="docutils literal">test.sh</tt> in your project's root:</p><div class="highlight"><pre><span/><span class="k">[testenv]</span>
<span class="na">commands</span> <span class="o">=</span> <span class="s">test.sh</span>
</pre></div><p>This will work fine, however, on Windows you need a different shell script. Currently <a class="reference external" href="https://testrun.org/tox/">tox</a> doesn't have <a class="reference external" href="https://testrun.org/tox/latest/config.html#generating-environments-conditional-settings">conditional settings</a> for the platform so you need to have a script that can run both as Shell and Batch (for Windows). A way to solve this is to have something like this in <tt class="docutils literal">tox.ini</tt>:</p><div class="highlight"><pre><span/><span class="k">[testenv]</span>
<span class="na">commands</span> <span class="o">=</span> <span class="s">test.cmd</span>
</pre></div><p>Then you make <tt class="docutils literal">test.cmd</tt> executable and have this peculiar mash-up of <cite>heredocs</cite> (<tt class="docutils literal">&lt;&lt;END ... END</tt>), labels (<tt class="docutils literal">:end</tt>) and <tt class="docutils literal">goto</tt>:</p><div class="highlight"><pre><span/>#!/bin/bash -eE
<span class="p">:</span><span class="c1">&lt;&lt;"::batch"</span>
<span class="p">@</span><span class="k">echo</span> off
powershell -ExecutionPolicy ByPass -File test.ps1 <span class="nv">%*</span>
<span class="k">goto</span> <span class="p">:</span><span class="nl">end</span>
<span class="p">:</span><span class="c1">:batch</span>
test.sh $*
<span class="k">exit</span> $?
<span class="p">:</span><span class="c1">&lt;&lt;"::done"</span>
<span class="p">:</span><span class="nl">end</span>
<span class="p">:</span><span class="c1">:done</span>
</pre></div><p>And then you write regular Bash code in <tt class="docutils literal">test.sh</tt> and PowerShell (on Windows) in <tt class="docutils literal">test.ps1</tt>. The <tt class="docutils literal">ExecutionPolicy ByPass</tt> is required because PowerShell doesn't allow external scripts to run by default (the default is a sort of "interactive only" mode) <a class="footnote-reference" href="#execution-policy" id="id6">[5]</a>.</p></div><div class="section" id="partial-environment-reuse"><h3>Partial environment reuse<a class="headerlink" href="#partial-environment-reuse" title="Permalink to this headline"> *</a></h3><p>Suppose you want to test a set of configurations. Using a <a class="reference external" href="https://testrun.org/tox/latest/config.html#generating-environments-conditional-settings">conditional settings</a> you can have something like this:</p><div class="highlight"><pre><span/><span class="k">[tox]</span>
<span class="na">envlist</span> <span class="o">=</span> <span class="s">{2.7,3.4}-{A,B,C}</span>

<span class="k">[testenv]</span>
<span class="na">basepython</span> <span class="o">=</span><span class="s"/>
<span class="s">    2.7: python2.7</span>
<span class="s">    3.4: python3.4</span>

<span class="c1"># {toxworkdir} defaults to .tox</span>
<span class="na">envdir</span> <span class="o">=</span><span class="s"/>
<span class="s">    2.7: {toxworkdir}/2.7</span>
<span class="s">    3.4: {toxworkdir}/3.4</span>

<span class="c1"># I'm building here on the previous example but we could have any other command here ...</span>
<span class="na">commands</span> <span class="o">=</span><span class="s"/>
<span class="s">    {2.7,3.4}-A: {toxinidir}/test.cmd A</span>
<span class="s">    {2.7,3.4}-B: {toxinidir}/test.cmd B</span>
<span class="s">    {2.7,3.4}-C: {toxinidir}/test.cmd C</span>
</pre></div><p>With that you'll have only 2 environments and that will significantly reduce environment rebuild time.</p></div><div class="section" id="dependency-caching"><h3>Dependency caching<a class="headerlink" href="#dependency-caching" title="Permalink to this headline"> *</a></h3><p>This is not necessarily <a class="reference external" href="https://testrun.org/tox/">tox</a> specific but I'm mentioning it because it can make installing some dependencies so much faster: <a class="reference external" href="https://blog.ionelmc.ro/2015/01/02/speedup-pip-install/">use wheelhouses preloaded with the deps</a>.</p><hr class="docutils"/><p>Know other tricks? Comment below!</p></div></div></div></body></html>