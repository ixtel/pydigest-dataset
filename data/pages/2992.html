<html><body><div><div class="entry-content clearfix"><p>The following is a soup to nuts walkthrough of how to setup and deploy a Django application to <a href="http://aws.amazon.com">Amazon Web Services</a> (AWS) all while remaining sane.</p>

<p>Tools/technologies used:</p>

<ol>
<li><a href="https://www.python.org/download/releases/2.7.8/">Python v2.7.8</a></li>
<li><a href="https://www.djangoproject.com">Django v1.7</a></li>
<li><a href="http://aws.amazon.com/elasticbeanstalk/">Amazon Elastic Beanstalk</a>, <a href="http://aws.amazon.com/ec2/">EC2</a>, <a href="http://aws.amazon.com/s3/">S3</a>, and <a href="http://aws.amazon.com/rds/">RDS</a></li>
<li><a href="http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/eb3-cmd-commands.html">EB CLI 3.x</a></li>
<li><a href="http://www.postgresql.org">PostgreSQL</a></li>
</ol>


<blockquote><p><strong>Why not Python 3?</strong> As of writing, Elastic Beanstalk doesn’t support it natively. You can get it to work with Docker, though – which we may cover in a future blog post.</p></blockquote>

<a name="Elastic.Beanstalk.vs.EC2"/>
<h2>Elastic Beanstalk vs EC2</h2>

<p>Elastic Beanstalk is a Platform As A Service (PaaS) that streamlines the setup, deployment, and maintenance of your app on Amazon AWS. It’s a managed service, coupling the server (EC2), database (RDS), and your static files (S3). You can quickly deploy and manage your application, which automatically scales as your site grows. Check out the <a href="http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/Welcome.html">official documentation</a> for more information.</p>




<a name="Getting.Started"/>
<h2>Getting Started</h2>

<p>We’ll be using a simple “Image of the Day” app, which you can grab from this <a href="https://github.com/realpython/image-of-the-day/">repository</a>:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>git clone https://github.com/realpython/image-of-the-day.git
</span><span class="line"><span class="nv">$ </span><span class="nb">cd </span>image-of-the-day/
</span><span class="line"><span class="nv">$ </span>git checkout tags/start_here
</span></code></pre></td></tr></table></div></figure>


<p>After you download the code, create a virtualenv and install the requirements via pip:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>pip install -r requirements.txt
</span></code></pre></td></tr></table></div></figure>


<p>Next, with PostgreSQL running locally, setup a new database named <code>iotd</code>. Also, depending upon your local Postgres configuration, you may need to update the <code>DATABASES</code> configuration in <em>settings.py</em>.</p>

<p>For example, I updated the config to:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
</span><span class="line">    <span class="s">'default'</span><span class="p">:</span> <span class="p">{</span>
</span><span class="line">        <span class="s">'ENGINE'</span><span class="p">:</span> <span class="s">'django.db.backends.postgresql_psycopg2'</span><span class="p">,</span>
</span><span class="line">        <span class="s">'NAME'</span><span class="p">:</span> <span class="s">'iotd'</span><span class="p">,</span>
</span><span class="line">        <span class="s">'USER'</span><span class="p">:</span> <span class="s">''</span><span class="p">,</span>
</span><span class="line">        <span class="s">'PASSWORD'</span><span class="p">:</span> <span class="s">''</span><span class="p">,</span>
</span><span class="line">        <span class="s">'HOST'</span><span class="p">:</span> <span class="s">'localhost'</span><span class="p">,</span>
</span><span class="line">        <span class="s">'PORT'</span><span class="p">:</span> <span class="s">'5432'</span><span class="p">,</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now you can setup the database schema, create a superuser, and run the app:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>python manage.py migrate
</span><span class="line"><span class="nv">$ </span>python manage.py createsuperuser
</span><span class="line"><span class="nv">$ </span>python manage.py runserver
</span></code></pre></td></tr></table></div></figure>


<p>Navigate to the admin page in your browser at <a href="http://localhost:8000/admin">http://localhost:8000/admin</a> and add a new image, which will then be displayed on the main page.</p>

<p>The application isn’t meant to be very exciting; we’re just using it for demo purposes. All it does is let you upload an image via the admin interface and display that image full screen on the main page. That said, although this is a relatively basic app, it will still allow us to explore a number of “gotchas” that exist when deploying to Amazon Beanstalk and RDS.</p>

<p>Now that we have the site up and running on our local machine, let’s start the Amazon deployment process.</p>

<a name="CLI.for.AWS.Elastic.Beanstalk"/>
<h2>CLI for AWS Elastic Beanstalk</h2>

<p>To work with a Amazon Elastic Beanstalk, we can use a package called <a href="https://pypi.python.org/pypi/awsebcli/3.0.10">awsebcli</a>. As of this writing the latest version of is 3.0.10 and the recommended way to install it is with pip:</p>

<figure class="code"><figcaption><span/></figcaption></figure>


<blockquote><p>Do not use brew to install this package. As of this writing, it installs v2.6.3 which is broken in subtle ways that will lead to serious frustration.</p></blockquote>

<p>Now test the installation to make sure it’s working:</p>

<figure class="code"><figcaption><span/></figcaption></figure>


<p>This should give you a nice 3.x version number:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line">EB CLI 3.0.10 <span class="o">(</span>Python 2.7.8<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>To actually start using Elastic Beanstalk you will need an <a href="https://portal.aws.amazon.com/gp/aws/developer/registration/index.html">account</a> with AWS (surprise!). Sign up (or log in).</p>









<a name="Configure.EB.-.initialize.your.app"/>
<h2>Configure EB – initialize your app</h2>

<p>With the AWS Elastic Beanstalk CLI working, the first thing we want to do is create a Beanstalk environment to host the application on. Run this from the project directory (“image-of-the-day”):</p>

<figure class="code"><figcaption><span/></figcaption></figure>


<p>This will prompt you with a number of questions to help you configure your environment.</p>

<p><strong>Default region</strong></p>

<p>Choosing the region closest to your end users will generally provide the best performance. Check out <a href="http://www.turnkeylinux.org/blog/aws-datacenters">this map</a> if you’re unsure which to choose.</p>

<p><strong>Credentials</strong></p>

<p>Next, it’s going to ask for your AWS credentials.</p>

<p>Here, you will most likely want to set up an IAM User. See <a href="http://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSGettingStartedGuide/AWSCredentials.html">this guide</a> for how to set one up. If you do set up a new user you will need to ensure the user has the appropriate permissions. The simplest way to do this is to just add “Administrator Access” to the User. (This is probably not a great choice for security reasons, though.) For the specific policies/roles that a user needs in order to create/manage an Elastic Beanstalk application, see the link <a href="http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/AWSHowTo.iam.roles.aeb.html">here</a>.</p>

<p><strong>Application name</strong></p>

<p>This will default to the directory name. Just go with that.</p>

<p><strong>Python version</strong></p>

<p>Next, the CLI should automagically detect that you are using Python and just ask for confirmation. Say yes. Then you need to select a platform version. Select <code>Python 2.7</code>.</p>

<p><strong>SSH</strong></p>

<p>Say yes to setting up SSH for your instances.</p>

<p><strong>RSA Keypair</strong></p>

<p>Next, you need to generate an RSA keypair, which will be added to your <em>~/.ssh</em> folder. This keypair will also be uploaded to the EC2 public key for the region you specified in step one. This will allow you to SSH into your EC2 instance later in this tutorial.</p>

<a name="What.did.we.accomplish."/>
<h3>What did we accomplish?</h3>

<p>Once <code>eb init</code> is finished, you will see a new hidden folder called <em>.elasticbeanstalk</em> in your project directory:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line">├── .elasticbeanstalk
</span><span class="line">│   └── config.yml
</span><span class="line">├── .gitignore
</span><span class="line">├── README.md
</span><span class="line">├── iotd
</span><span class="line">│   ├── images
</span><span class="line">│   │   ├── __init__.py
</span><span class="line">│   │   ├── admin.py
</span><span class="line">│   │   ├── migrations
</span><span class="line">│   │   │   ├── 0001_initial.py
</span><span class="line">│   │   │   └── __init__.py
</span><span class="line">│   │   ├── models.py
</span><span class="line">│   │   ├── tests.py
</span><span class="line">│   │   └── views.py
</span><span class="line">│   ├── iotd
</span><span class="line">│   │   ├── __init__.py
</span><span class="line">│   │   ├── settings.py
</span><span class="line">│   │   ├── urls.py
</span><span class="line">│   │   └── wsgi.py
</span><span class="line">│   ├── manage.py
</span><span class="line">│   ├── static
</span><span class="line">│   │   ├── css
</span><span class="line">│   │   │   └── bootstrap.min.css
</span><span class="line">│   │   └── js
</span><span class="line">│   │       ├── bootstrap.min.js
</span><span class="line">│   │       └── jquery-1.11.0.min.js
</span><span class="line">│   └── templates
</span><span class="line">│       ├── base.html
</span><span class="line">│       └── images
</span><span class="line">│           └── home.html
</span><span class="line">├── requirements.txt
</span><span class="line">└── www
</span><span class="line">    └── media
</span><span class="line">        └── sitelogo.png
</span></code></pre></td></tr></table></div></figure>


<p>Inside that directory is a <code>config.yml</code> file, which is a configuration file that is used to define certain parameters for your newly minted Beanstalk application.</p>

<p>At this point, if you type <code>eb console</code> it will open up your default browser and navigate to the Elastic Beanstalk console. On the page, you should see one application (called <code>image-of-the-day</code> if you’re following along exactly), but no environments.</p>









<p>An application represents your code application and is what <code>eb init</code> created for us. With Elastic Beanstalk, an application can have multiple environments (i.e., development, testing, staging, production). It is completely up to you how you want to configure/manage these environments. For simple Django applications I like to have the development environment on my laptop, then create a test and a production environment on Beanstalk.</p>

<p>Let’s get a test environment set up…</p>

<a name="Configure.EB.-.create.an.environment"/>
<h2>Configure EB – create an environment</h2>

<p>Coming back to the terminal, in your project directory type:</p>

<figure class="code"><figcaption><span/></figcaption></figure>


<p>Just like <code>eb init</code>, this command will prompt you with a series of questions.</p>

<p><strong>Environment Name</strong></p>

<p>You should use a similar naming convention to what Amazon suggest – e.g., application_name-env_name – especially when/if you start hosing multiple applications with AWS. I used – <code>iod-test</code>.</p>

<p><strong>DNS CNAME prefix</strong></p>

<p>When you deploy an app to Elastic Beanstalk you will automatically get a domain name like xxx.elasticbeanstalk.com. <code>DNS CNAME prefix</code> is what you want to be used in place of <code>xxx</code>. Just go with the default.</p>

<a name="What.happens.now."/>
<h3>What happens now?</h3>

<p>At this point <code>eb</code> will actually create your environment for you. Be patient as this can take some time.</p>

<blockquote><p>If you do get an error creating the environment, like – <code>aws.auth.client.error.ARCInstanceIdentityProfileNotFoundException</code>– check that that the credentials you are using have appropriate permissions to create the Beanstalk environment, as discussed earlier in this post.</p></blockquote>

<p>Immediately after the environment is created, <code>eb</code> will attempt to deploy your application, by copying all the code in your project directory to the new EC2 instance, running <code>pip install -r requirements.txt</code> in the process.</p>

<p>You should see a bunch of information about the environment being set up displayed to your screen, as well as information about <code>eb</code> trying to deploy. You will also see some errors. In particular you should see these lines buried somewhere in the output:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line">ERROR: Your requirements.txt is invalid. Snapshot your logs <span class="k">for </span>details.
</span></code></pre></td></tr></table></div></figure>


<p>Don’t worry – It’s not really invalid. Check the logs for details:</p>

<figure class="code"><figcaption><span/></figcaption></figure>


<p>This will grab all the recent log files from the EC2 instance and output them to your terminal. It’s a lot of information so you may want to redirect the output to a file (<code>eb logs -z</code>). Looking through the logs, you’ll see one log file named <em>eb-activity.log</em>:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line">Error: pg_config executable not found.
</span></code></pre></td></tr></table></div></figure>


<p>The problem is that we tried to install <code>psycopy2</code> (the Postgres Python bindings), but we need the Postgres client drivers to be installed as well. Since they are not installed by default we need to install them first. Let’s fix that…</p>

<a name="Customizing.the.Deployment.Process"/>
<h2>Customizing the Deployment Process</h2>

<p><code>eb</code> will read custom <code>.config</code> files from a folder called “.ebextensions” at the root level of your project (“image-of-the-day” directory). These <code>.config</code> files allow you to install packages, run arbitrary commands and/or set environment variables. Files in the “.ebextensions” directory should conform to either <code>JSON</code> or <code>YAML</code> syntax and are executed in alphabetical order.</p>

<a name="Installing.packages"/>
<h3>Installing packages</h3>

<p>The first thing we need to do is install some packages so that our <code>pip install</code> command will complete successfully. To do this, let’s first create a file called <em>.ebextensions/01_packages.config</em>:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="yaml"><span class="line"><span class="l-Scalar-Plain">packages</span><span class="p-Indicator">:</span>
</span><span class="line">  <span class="l-Scalar-Plain">yum</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="l-Scalar-Plain">git</span><span class="p-Indicator">:</span> <span class="p-Indicator">[]</span>
</span><span class="line">    <span class="l-Scalar-Plain">postgresql93-devel</span><span class="p-Indicator">:</span> <span class="p-Indicator">[]</span>
</span></code></pre></td></tr></table></div></figure>


<p>EC2 instances run Amazon Linux, which is a Redhat flavor, so we can use <a href="http://en.wikipedia.org/wiki/Yellowdog_Updater,_Modified">yum</a> to install the packages that we need. For now, we are just going to install two packages – git and the Postgres client.</p>

<p>After creating that file to redeploy the application, we need to do the following:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>git add .ebextensions/
</span><span class="line"><span class="nv">$ </span>git commit -m <span class="s2">"added eb package configuration"</span>
</span></code></pre></td></tr></table></div></figure>


<p>We have to commit the changes because the deployment command <code>eb deploy</code> works off the latest commit, and will thus only be aware of our file changes after we commit them to git. (Do note though that we don’t have to push; we are working from our local copy…)</p>

<p>As you probably guessed, the next command is:</p>

<figure class="code"><figcaption><span/></figcaption></figure>


<p>You should now see only one error:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line">INFO: Environment update is starting.
</span><span class="line">INFO: Deploying new version to instance<span class="o">(</span>s<span class="o">)</span>.
</span><span class="line">ERROR: Your WSGIPath refers to a file that does not exist.
</span><span class="line">INFO: New application version was deployed to running EC2 instances.
</span><span class="line">INFO: Environment update completed successfully.
</span></code></pre></td></tr></table></div></figure>


<p>Let’s find out what’s happening…</p>

<a name="Configuring.our.Python.environment"/>
<h3>Configuring our Python environment</h3>

<p>EC2 instances in Beanstalk run Apache, and Apache will find our Python app according to the WSGIPATH that we have set. By default <code>eb</code> assumes our wsgi file is called <em>application.py</em>. There are two ways of correcting this-</p>

<p><strong>Option 1: Using environment-specific configuration settings</strong></p>

<figure class="code"><figcaption><span/></figcaption></figure>


<p>This command will open your <a href="http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/eb3-config.html">default editor</a>, editing a configuration file called <em>.elasticbeanstalk/iod-test.env.yml</em>. This file doesn’t actually exist locally; <code>eb</code> pulled it down from the AWS servers and presented it to you so that you can change settings in it. If you make any changes to this pseudo-file and then save and exit, <code>eb</code> will update the corresponding settings in your Beanstalk environment.</p>

<p>If you search for the terms ‘WSGI’ in the file, and you should find a configuration section that looks like this:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line">aws:elasticbeanstalk:container:python:
</span><span class="line">  NumProcesses: <span class="s1">'1'</span>
</span><span class="line">  NumThreads: <span class="s1">'15'</span>
</span><span class="line">  StaticFiles: /static/<span class="o">=</span>static/
</span><span class="line">  WSGIPath: application.py
</span></code></pre></td></tr></table></div></figure>


<p>Update the WSGIPath:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"> aws:elasticbeanstalk:container:python:
</span><span class="line">   NumProcesses: <span class="s1">'1'</span>
</span><span class="line">   NumThreads: <span class="s1">'15'</span>
</span><span class="line">   StaticFiles: /static/<span class="o">=</span>static/
</span><span class="line">   WSGIPath: iotd/iotd/wsgi.py
</span></code></pre></td></tr></table></div></figure>


<p>And then you will have you WSGIPath set up correctly. If you then save the file and exit, <code>eb</code> will update the environment configuration automatically:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line">Printing Status:
</span><span class="line">INFO: Environment update is starting.
</span><span class="line">INFO: Updating environment iod-test<span class="err">'</span>s configuration settings.
</span><span class="line">INFO: Successfully deployed new configuration to environment.
</span><span class="line">INFO: Environment update completed successfully.
</span></code></pre></td></tr></table></div></figure>


<p>The advantage to using the <code>eb config</code> method to change settings is that you can specify different settings per environment. But you can also update settings using the same <code>.config</code> files that we were using before. This will use the same settings for each environment, as the <code>.config</code> files will be applied on deployment (after the settings from <code>eb config</code> have been applied).</p>

<p><strong>Option 2: Using global configuration settings</strong></p>

<p>To use the <code>.config</code> file option, let’s create a new file called <em>/.ebextensions/02_python.config</em>:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="yaml"><span class="line"><span class="l-Scalar-Plain">option_settings</span><span class="p-Indicator">:</span>
</span><span class="line">  <span class="s">"aws:elasticbeanstalk:application:environment"</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="l-Scalar-Plain">DJANGO_SETTINGS_MODULE</span><span class="p-Indicator">:</span> <span class="s">"iotd.settings"</span>
</span><span class="line">    <span class="s">"PYTHONPATH"</span><span class="p-Indicator">:</span> <span class="s">"/opt/python/current/app/iotd:$PYTHONPATH"</span>
</span><span class="line">  <span class="s">"aws:elasticbeanstalk:container:python"</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="l-Scalar-Plain">WSGIPath</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">iotd/iotd/wsgi.py</span>
</span><span class="line">    <span class="l-Scalar-Plain">NumProcesses</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3</span>
</span><span class="line">    <span class="l-Scalar-Plain">NumThreads</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">20</span>
</span><span class="line">  <span class="s">"aws:elasticbeanstalk:container:python:staticfiles"</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="s">"/static/"</span><span class="p-Indicator">:</span> <span class="s">"www/static/"</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>What’s happening?</em></p>

<ul>
<li><code>DJANGO_SETTINGS_MODULE: "iotd.settings"</code> – adds the path to the settings module.</li>
<li><code>"PYTHONPATH": "/opt/python/current/app/iotd:$PYTHONPATH"</code> – updates our <code>PYTHONPATH</code> so Python can find the modules in our application. (Note that the use of the full path is necessary.)</li>
<li><code>WSGIPath: iotd/iotd/wsgi.py</code> sets our WSGI Path.</li>
<li><code>NumProcesses: 3</code> and <code>NumThreads: 20</code> – updates the number of processes and threads used to run our WSGI application.</li>
<li><code>"/static/": "www/static/"</code> sets our static files path.</li>
</ul>


<p>Again, we can do a <code>git commit</code> then an <code>eb deploy</code> to update these settings.</p>

<p>Next let’s add a database.</p>

<a name="Configuring.a.Database"/>
<h2>Configuring a Database</h2>

<p>Try to view the deployed website:</p>

<figure class="code"><figcaption><span/></figcaption></figure>


<p>This command will show the deployed application in your default browser. You should see a connection refused error:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="yaml"><span class="line"><span class="l-Scalar-Plain">OperationalError at /</span>
</span><span class="line"><span class="l-Scalar-Plain">could not connect to server</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Connection refused</span>
</span><span class="line">    <span class="l-Scalar-Plain">Is the server running on host "localhost" (127.0.0.1) and accepting</span>
</span><span class="line">    <span class="l-Scalar-Plain">TCP/IP connections on port 5432?</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is because we haven’t set up a database yet. At this point <code>eb</code> will set up your Beanstalk environment, but it doesn’t set up RDS (the database tier). We have to set that up manually.</p>

<a name="Database.setup"/>
<h3>Database setup</h3>

<p>Again, use <code>eb console</code> to open up the Beanstalk configuration page.</p>









<p>From there, do the following:</p>

<ol>
<li>Click the “Configuration” link.</li>
<li>Scroll all the way to the bottom of the page, and then under the “Data Tier” section, click the link “create a new RDS database”.</li>
<li>On the RDS setup page change the “DB Engine” to “postgres”.</li>
<li>Add a “Master Username” and “Master Password”.</li>
<li>Save the changes.</li>
</ol>










<p>Beanstalk will create the RDS for you. Now we need to get our Django app to connect to the RDS. Beanstalk will help us out here by exposing a number of environment variables on the EC2 instances for us that detail how to connect to the Postgres server. So all we need to do is update our <em>settings.py</em> file to take advantage of those environment variables. Confirm that the <code>DATABASES</code> configuration parameter reflects the following in <em>settings.py</em>:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">if</span> <span class="s">'RDS_DB_NAME'</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
</span><span class="line">    <span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
</span><span class="line">        <span class="s">'default'</span><span class="p">:</span> <span class="p">{</span>
</span><span class="line">            <span class="s">'ENGINE'</span><span class="p">:</span> <span class="s">'django.db.backends.postgresql_psycopg2'</span><span class="p">,</span>
</span><span class="line">            <span class="s">'NAME'</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'RDS_DB_NAME'</span><span class="p">],</span>
</span><span class="line">            <span class="s">'USER'</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'RDS_USERNAME'</span><span class="p">],</span>
</span><span class="line">            <span class="s">'PASSWORD'</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'RDS_PASSWORD'</span><span class="p">],</span>
</span><span class="line">            <span class="s">'HOST'</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'RDS_HOSTNAME'</span><span class="p">],</span>
</span><span class="line">            <span class="s">'PORT'</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'RDS_PORT'</span><span class="p">],</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line"><span class="k">else</span><span class="p">:</span>
</span><span class="line">    <span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
</span><span class="line">        <span class="s">'default'</span><span class="p">:</span> <span class="p">{</span>
</span><span class="line">            <span class="s">'ENGINE'</span><span class="p">:</span> <span class="s">'django.db.backends.postgresql_psycopg2'</span><span class="p">,</span>
</span><span class="line">            <span class="s">'NAME'</span><span class="p">:</span> <span class="s">'iotd'</span><span class="p">,</span>
</span><span class="line">            <span class="s">'USER'</span><span class="p">:</span> <span class="s">'iotd'</span><span class="p">,</span>
</span><span class="line">            <span class="s">'PASSWORD'</span><span class="p">:</span> <span class="s">'iotd'</span><span class="p">,</span>
</span><span class="line">            <span class="s">'HOST'</span><span class="p">:</span> <span class="s">'localhost'</span><span class="p">,</span>
</span><span class="line">            <span class="s">'PORT'</span><span class="p">:</span> <span class="s">'5432'</span><span class="p">,</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This simply says, “Use the environment variable settings if present, otherwise use our default development settings”. Simple.</p>

<a name="Handling.database.migrations"/>
<h3>Handling database migrations</h3>

<p>With our database setup, we still need to make sure that migrations are ran so that the database table structure is correct. We can do that by modifying <em>.ebextensions/02_python.config</em> and adding the following lines at the top of the file:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="yaml"><span class="line"><span class="l-Scalar-Plain">container_commands</span><span class="p-Indicator">:</span>
</span><span class="line">  <span class="l-Scalar-Plain">01_migrate</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="s">"source</span><span class="nv"> </span><span class="s">/opt/python/run/venv/bin/activate</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">python</span><span class="nv"> </span><span class="s">iotd/manage.py</span><span class="nv"> </span><span class="s">migrate</span><span class="nv"> </span><span class="s">--noinput"</span>
</span><span class="line">    <span class="l-Scalar-Plain">leader_only</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>container_commands</code> allow you to run arbitrary commands after the application has been deployed on the EC2 instance. Because the EC2 instance is set up using a virtual environment, we must first activate that virtual environment before running our migrate command. Also the <code>leader_only: true</code> setting means, “Only run this command on the first instance when deploying to multiple instances”.</p>

<p>Don’t forget that our application makes use of Django’s admin, so we are going to need a superuser…</p>

<a name="Create.the.Admin.User"/>
<h3>Create the Admin User</h3>

<p>Unfortunately <code>createsuperuser</code> doesn’t allow you to specify a password when using the <code>--noinput</code> option, so we will have to write our own command. Fortunately, Django makes it very easy to create <a href="https://docs.djangoproject.com/en/1.7/howto/custom-management-commands/">custom commands</a>.</p>

<p>Create the file <em>iotd/images/management/commands/createsu.py</em>:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">django.core.management.base</span> <span class="kn">import</span> <span class="n">BaseCommand</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">Command</span><span class="p">(</span><span class="n">BaseCommand</span><span class="p">):</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
</span><span class="line">        <span class="k">if</span> <span class="ow">not</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s">"admin"</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span class="line">            <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_superuser</span><span class="p">(</span><span class="s">"admin"</span><span class="p">,</span> <span class="s">"admin@admin.com"</span><span class="p">,</span> <span class="s">"admin"</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Make sure you add the appropriate <code>__init__.py</code> files as well:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line">└─ management
</span><span class="line">    ├── __init__.py
</span><span class="line">    └── commands
</span><span class="line">        ├── __init__.py
</span><span class="line">        └── createsu.py
</span></code></pre></td></tr></table></div></figure>


<p>This file will allow you to run <code>python manage.py createsu</code>, and it will create a superuser without prompting for a password. Feel free to expand the command to use environment variables or another means to allow you to change the password.</p>

<p>Once you have the command created, we can just add another command to our <code>container_commands</code> section in <em>.ebextensions/02_python.config</em>:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="yaml"><span class="line"><span class="l-Scalar-Plain">02_createsu</span><span class="p-Indicator">:</span>
</span><span class="line">  <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="s">"source</span><span class="nv"> </span><span class="s">/opt/python/run/venv/bin/activate</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">python</span><span class="nv"> </span><span class="s">iotd/manage.py</span><span class="nv"> </span><span class="s">createsu"</span>
</span><span class="line">  <span class="l-Scalar-Plain">leader_only</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>Before you test this out, let’s make sure our static files are all put in the correct place…</p>

<a name="Static.Files"/>
<h2>Static Files</h2>

<p>Add one more command under <code>container_commands</code>:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="yaml"><span class="line"><span class="l-Scalar-Plain">03_collectstatic</span><span class="p-Indicator">:</span>
</span><span class="line">  <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="s">"source</span><span class="nv"> </span><span class="s">/opt/python/run/venv/bin/activate</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">python</span><span class="nv"> </span><span class="s">iotd/manage.py</span><span class="nv"> </span><span class="s">collectstatic</span><span class="nv"> </span><span class="s">--noinput"</span>
</span></code></pre></td></tr></table></div></figure>


<p>So the entire file looks like this:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
</pre></td><td class="code"><pre><code class="yaml"><span class="line"><span class="l-Scalar-Plain">container_commands</span><span class="p-Indicator">:</span>
</span><span class="line">  <span class="l-Scalar-Plain">01_migrate</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="s">"source</span><span class="nv"> </span><span class="s">/opt/python/run/venv/bin/activate</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">python</span><span class="nv"> </span><span class="s">iotd/manage.py</span><span class="nv"> </span><span class="s">migrate</span><span class="nv"> </span><span class="s">--noinput"</span>
</span><span class="line">    <span class="l-Scalar-Plain">leader_only</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class="line">  <span class="l-Scalar-Plain">02_createsu</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="s">"source</span><span class="nv"> </span><span class="s">/opt/python/run/venv/bin/activate</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">python</span><span class="nv"> </span><span class="s">iotd/manage.py</span><span class="nv"> </span><span class="s">createsu"</span>
</span><span class="line">    <span class="l-Scalar-Plain">leader_only</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class="line">  <span class="l-Scalar-Plain">03_collectstatic</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="s">"source</span><span class="nv"> </span><span class="s">/opt/python/run/venv/bin/activate</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">python</span><span class="nv"> </span><span class="s">iotd/manage.py</span><span class="nv"> </span><span class="s">collectstatic</span><span class="nv"> </span><span class="s">--noinput"</span>
</span><span class="line">
</span><span class="line"><span class="l-Scalar-Plain">option_settings</span><span class="p-Indicator">:</span>
</span><span class="line">  <span class="s">"aws:elasticbeanstalk:application:environment"</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="l-Scalar-Plain">DJANGO_SETTINGS_MODULE</span><span class="p-Indicator">:</span> <span class="s">"iotd.settings"</span>
</span><span class="line">    <span class="s">"PYTHONPATH"</span><span class="p-Indicator">:</span> <span class="s">"/opt/python/current/app/iotd:$PYTHONPATH"</span>
</span><span class="line">    <span class="s">"ALLOWED_HOSTS"</span><span class="p-Indicator">:</span> <span class="s">".elasticbeanstalk.com"</span>
</span><span class="line">  <span class="s">"aws:elasticbeanstalk:container:python"</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="l-Scalar-Plain">WSGIPath</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">iotd/iotd/wsgi.py</span>
</span><span class="line">    <span class="l-Scalar-Plain">NumProcesses</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3</span>
</span><span class="line">    <span class="l-Scalar-Plain">NumThreads</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">20</span>
</span><span class="line">  <span class="s">"aws:elasticbeanstalk:container:python:staticfiles"</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="s">"/static/"</span><span class="p-Indicator">:</span> <span class="s">"www/static/"</span>
</span></code></pre></td></tr></table></div></figure>


<p>We now need to ensure that the <code>STATIC_ROOT</code> is set correctly in the <em>settings.py</em> file:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">STATIC_ROOT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s">".."</span><span class="p">,</span> <span class="s">"www"</span><span class="p">,</span> <span class="s">"static"</span><span class="p">)</span>
</span><span class="line"><span class="n">STATIC_URL</span> <span class="o">=</span> <span class="s">'/static/'</span>
</span></code></pre></td></tr></table></div></figure>


<p>Make sure you commit the <code>www</code> directory to git so the static dir can be created. Then run <code>eb deploy</code> again, and you should now be in business:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line">INFO: Environment update is starting.
</span><span class="line">INFO: Deploying new version to instance<span class="o">(</span>s<span class="o">)</span>.
</span><span class="line">INFO: New application version was deployed to running EC2 instances.
</span><span class="line">INFO: Environment update completed successfully.
</span></code></pre></td></tr></table></div></figure>


<p>At this point you should be able to go to <a href="http://your_app_url/admin">http://your_app_url/admin</a>, log in, add an image, and then see that image displayed on the main page of your application.</p>

<p>Success!</p>

<a name="Using.S3.for.Media.Storage"/>
<h2>Using S3 for Media Storage</h2>

<p>With this setup, each time we deploy again, we will lose all of our uploaded images. Why? Well, when you run <code>eb deploy</code>, a fresh instance is spun up for you. This is not what we want since we will then have entries in the database for the images, but no associated images. The solution is to store the media files in Amazon Simple Storage Service (Amazon S3) instead of on the EC2 instance itself.</p>

<p>You will need to:</p>

<ol>
<li><a href="http://docs.aws.amazon.com/AmazonS3/latest/UG/CreatingaBucket.html">Create a bucket</a></li>
<li><a href="http://docs.aws.amazon.com/general/latest/gr/aws-arns-and-namespaces.html">Grab your user’s ARN (Amazon Resource Name)</a></li>
<li><a href="http://docs.aws.amazon.com/AmazonS3/latest/UG/EditingBucketPermissions.html">Add bucket permissions</a></li>
<li><a href="https://docs.djangoproject.com/en/1.7/howto/static-files/">Configure your Django app to use S3 to serve your static files</a></li>
</ol>


<p>Since there are good write ups on this already, I’ll just point you to my favorite: <a href="http://www.caktusgroup.com/blog/2014/11/10/Using-Amazon-S3-to-store-your-Django-sites-static-and-media-files/">Using Amazon S3 to store you Django Static and Media Files</a></p>

<a name="Apache.Config"/>
<h2>Apache Config</h2>

<p>Since we are using Apache with Beanstalk, we probably want to set up Apache to (among other things) enable gzip compression so files are downloaded faster by the clients. That can be done with <code>container_commands</code>. Create a new file <em>.ebextensions/03_apache.config</em> and add the following:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="yaml"><span class="line"><span class="l-Scalar-Plain">container_commands</span><span class="p-Indicator">:</span>
</span><span class="line">  <span class="l-Scalar-Plain">01_setup_apache</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="s">"cp</span><span class="nv"> </span><span class="s">.ebextensions/enable_mod_deflate.conf</span><span class="nv"> </span><span class="s">/etc/httpd/conf.d/enable_mod_deflate.conf"</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then you need to create the file <code>.ebextensions/enable_mod_deflate.conf</code>:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
</pre></td><td class="code"><pre><code class="yaml"><span class="line"><span class="c1"># mod_deflate configuration</span>
</span><span class="line"><span class="l-Scalar-Plain">&lt;IfModule mod_deflate.c&gt;</span>
</span><span class="line">  <span class="l-Scalar-Plain"># Restrict compression to these MIME types</span>
</span><span class="line">  <span class="l-Scalar-Plain">AddOutputFilterByType DEFLATE text/plain</span>
</span><span class="line">  <span class="l-Scalar-Plain">AddOutputFilterByType DEFLATE text/html</span>
</span><span class="line">  <span class="l-Scalar-Plain">AddOutputFilterByType DEFLATE application/xhtml+xml</span>
</span><span class="line">  <span class="l-Scalar-Plain">AddOutputFilterByType DEFLATE text/xml</span>
</span><span class="line">  <span class="l-Scalar-Plain">AddOutputFilterByType DEFLATE application/xml</span>
</span><span class="line">  <span class="l-Scalar-Plain">AddOutputFilterByType DEFLATE application/xml+rss</span>
</span><span class="line">  <span class="l-Scalar-Plain">AddOutputFilterByType DEFLATE application/x-javascript</span>
</span><span class="line">  <span class="l-Scalar-Plain">AddOutputFilterByType DEFLATE text/javascript</span>
</span><span class="line">  <span class="l-Scalar-Plain">AddOutputFilterByType DEFLATE text/css</span>
</span><span class="line">  <span class="l-Scalar-Plain"># Level of compression (Highest 9 - Lowest 1)</span>
</span><span class="line">  <span class="l-Scalar-Plain">DeflateCompressionLevel 9</span>
</span><span class="line">  <span class="l-Scalar-Plain"># Netscape 4.x has some problems.</span>
</span><span class="line">  <span class="l-Scalar-Plain">BrowserMatch ^Mozilla/4 gzip-only-text/html</span>
</span><span class="line">  <span class="l-Scalar-Plain"># Netscape 4.06-4.08 have some more problems</span>
</span><span class="line">  <span class="l-Scalar-Plain">BrowserMatch ^Mozilla/4\.0[678] no-gzip</span>
</span><span class="line">  <span class="l-Scalar-Plain"># MSIE masquerades as Netscape, but it is fine</span>
</span><span class="line">  <span class="l-Scalar-Plain">BrowserMatch \bMSI[E] !no-gzip !gzip-only-text/html</span>
</span><span class="line"><span class="l-Scalar-Plain">&lt;IfModule mod_headers.c&gt;</span>
</span><span class="line">  <span class="l-Scalar-Plain"># Make sure proxies don't deliver the wrong content</span>
</span><span class="line">  <span class="l-Scalar-Plain">Header append Vary User-Agent env=!dont-vary</span>
</span><span class="line"><span class="l-Scalar-Plain">&lt;/IfModule&gt;</span>
</span><span class="line"><span class="l-Scalar-Plain">&lt;/IfModule&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Doing this will enable gzip compression, which should help with the size of the files you’re downloading. You could also use the same strategy to automatically minify and combine your CSS/JS and do any other preprocessing you need to do.</p>

<a name="Troubleshooting"/>
<h2>Troubleshooting</h2>

<p>Don’t forget the very helpful <code>eb ssh</code> command, which will get you into the EC2 instance so you can poke around and see what’s going on. When troubleshooting, there are a couple of directories you should be aware of:</p>

<ul>
<li><code>/opt/python</code> – Root of where you application will end up.</li>
<li><code>/opt/python/current/app</code> – The current application that is hosted in the environment.</li>
<li><code>/opt/python/on-deck/app</code> – The app is initially put in on-deck and then, after all the deployment is complete, it will be moved to <code>current</code>. If you are getting failures in your <code>container_commands</code>, check out out the <code>on-deck</code> folder and not the <code>current</code> folder.</li>
<li><code>/opt/python/current/env</code> – All the env variables that <code>eb</code> will set up for you. If you are trying to reproduce an error, you may first need to <code>source /opt/python/current/env</code> to get things set up as they would be when eb deploy is running.</li>
<li><code>opt/python/run/venv</code> – The virtual env used by your application; you will also need to run <code>source /opt/python/run/venv/bin/activate</code> if you are trying to reproduce an error</li>
</ul>


<a name="Conclusion"/>
<h2>Conclusion</h2>

<p>Deploying to Elastic beanstalk can be a bit daunting at first, but once you understand where all the parts are and how things work, it’s actually pretty easy and extremely flexible. It also gives you an environment that will scale automatically as your usage grows. Hopefully by now you have enough to be dangerous! Good luck on your next Beanstalk deployment.</p>

<p>Did we miss anything? Have any other tips or tricks? Please comment below.</p>






<p>
  <em>Edits made by <a href="https://twitter.com/diek007">Derrick Kearney</a>. Thank you!</em>
</p>

</div>


      </div></body></html>