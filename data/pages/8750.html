<html><body><div><div id="usage">

<div id="basic-functionality">

<p>The most significant component provided by this package is the class
<tt>Signal</tt>:</p>
<pre><span class="kn">from</span> <span class="nn">metapensiero.signal</span> <span class="kn">import</span> <span class="n">Signal</span>

<span class="n">signal</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
<span class="n">called1</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">called2</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">handler1</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">kw</span><span class="p">):</span>
    <span class="n">nonlocal</span> <span class="n">called1</span>
    <span class="n">called1</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">kw</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">handler2</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">kw</span><span class="p">):</span>
    <span class="n">nonlocal</span> <span class="n">called2</span>
    <span class="n">called2</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">kw</span><span class="p">)</span>

<span class="n">signal</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">handler1</span><span class="p">)</span>
<span class="n">signal</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">handler2</span><span class="p">)</span>

<span class="n">signal</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">kw</span><span class="o">=</span><span class="s1">'a'</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">called1</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'a'</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">called2</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'a'</span><span class="p">)</span>
</pre>
<p>As you can see, to have a function or method called when a signal is
<em>fired</em> you just have to call the <tt>connect()</tt> method of the signal
instance. To remove that same method you can use the <tt>disconnect()</tt>
method.</p>
<p>As you can see above, the way to fire an event is by calling the
<tt>notify()</tt> method and any argument or keyword argument passed to
that function will be added to the handlers call.</p>
<p>It’s possible to remove all the connected handlers by invoking the
<tt>clear()</tt> method.</p>
</div>
<div id="asynchronous-signal-handlers">

<p>Not only you can have synchronous handlers, but you can have
asynchronous handlers as well:</p>
<pre><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">metapensiero.signal</span> <span class="kn">import</span> <span class="n">Signal</span>

<span class="nd">@asyncio.coroutine</span>
<span class="k">def</span> <span class="nf">test_with_mixed_handlers</span><span class="p">():</span>
    <span class="n">signal</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
    <span class="n">called1</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">called2</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">h1</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

    <span class="nd">@asyncio.coroutine</span>
    <span class="k">def</span> <span class="nf">handler1</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">kw</span><span class="p">):</span>
        <span class="n">nonlocal</span> <span class="n">called1</span>
        <span class="n">called1</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">kw</span><span class="p">)</span>
        <span class="n">h1</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">handler2</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">kw</span><span class="p">):</span>
        <span class="n">nonlocal</span> <span class="n">called2</span>
        <span class="n">called2</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">kw</span><span class="p">)</span>

    <span class="n">signal</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">handler1</span><span class="p">)</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">handler2</span><span class="p">)</span>

    <span class="n">signal</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">kw</span><span class="o">=</span><span class="s1">'a'</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">called2</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'a'</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">called1</span> <span class="o">==</span> <span class="bp">False</span>
    <span class="k">yield from</span> <span class="n">h1</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">called1</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'a'</span><span class="p">)</span>

<span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">test_with_mixed_handlers</span><span class="p">())</span>
</pre>
<p>As you can see in this example the var <tt>called2</tt> immediately after
the notify has the expected value but the value of the var <tt>called1</tt>
hasn’t. To have it the code has to suspend itself and wait for the
flag event to be set. This is because <tt>handler1()</tt> is scheduled to
be executed with <tt>asyncio.ensure_future()</tt> but it isn’t waited for a
result by the <tt>notify()</tt> method.</p>
<p>The usage of a flag to synchronize is a bit silly, what if we have
more than one async handler? Do we have to create an <tt>asyncio.Event</tt>
instance for all of them and then wait for everyone of those? And if
the actual amount of async handlers isn’t known in advance, what
should we do?</p>
</div>
<div id="transaction-support">

<p>This is exactly where the sister package
<a href="https://pypi.python.org/pypi/metapensiero.asyncio.transaction" rel="nofollow">metapensiero.asyncio.transaction</a> comes handy. The <tt>Signal</tt> class
works with it to ensure that two coroutines (the one calling
<tt>notify()</tt> and <tt>handler1()</tt>) can be synchronized.</p>
<p>To do that the <em>outer</em> code has just to start a  <em>transaction</em> and
if it is in place, the <tt>Signal</tt> class’ code will automatically add
any async event handler to it.</p>
<p>To summarize this feature the previous example can be written also
as:</p>
<pre><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">metapensiero.signal</span> <span class="kn">import</span> <span class="n">Signal</span>
<span class="kn">from</span> <span class="nn">metapensiero.asyncio</span> <span class="kn">import</span> <span class="n">transaction</span>

<span class="nd">@asyncio.coroutine</span>
<span class="k">def</span> <span class="nf">test_with_mixed_handlers</span><span class="p">():</span>
    <span class="n">signal</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
    <span class="n">called1</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">called2</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="nd">@asyncio.coroutine</span>
    <span class="k">def</span> <span class="nf">handler1</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">kw</span><span class="p">):</span>
        <span class="n">nonlocal</span> <span class="n">called1</span>
        <span class="n">called1</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">kw</span><span class="p">)</span>
        <span class="n">h1</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">handler2</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">kw</span><span class="p">):</span>
        <span class="n">nonlocal</span> <span class="n">called2</span>
        <span class="n">called2</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">kw</span><span class="p">)</span>

    <span class="n">signal</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">handler1</span><span class="p">)</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">handler2</span><span class="p">)</span>

    <span class="n">trans</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">kw</span><span class="o">=</span><span class="s1">'a'</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">called2</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'a'</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">called1</span> <span class="o">==</span> <span class="bp">False</span>
    <span class="k">yield from</span> <span class="n">trans</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">called1</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'a'</span><span class="p">)</span>

<span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">test_with_mixed_handlers</span><span class="p">())</span>
</pre>
<p>Or, with python 3.5, we can use async context managers, so it becomes:</p>
<pre><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">metapensiero.signal</span> <span class="kn">import</span> <span class="n">Signal</span>
<span class="kn">from</span> <span class="nn">metapensiero.asyncio</span> <span class="kn">import</span> <span class="n">transaction</span>

<span class="n">async</span> <span class="k">def</span> <span class="nf">test_with_mixed_handlers</span><span class="p">():</span>
    <span class="n">signal</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
    <span class="n">called1</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">called2</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">handler1</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">kw</span><span class="p">):</span>
        <span class="n">nonlocal</span> <span class="n">called1</span>
        <span class="n">called1</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">kw</span><span class="p">)</span>
        <span class="n">h1</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">handler2</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">kw</span><span class="p">):</span>
        <span class="n">nonlocal</span> <span class="n">called2</span>
        <span class="n">called2</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">kw</span><span class="p">)</span>

    <span class="n">signal</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">handler1</span><span class="p">)</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">handler2</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">begin</span><span class="p">():</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">kw</span><span class="o">=</span><span class="s1">'a'</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">called2</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'a'</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">called1</span> <span class="o">==</span> <span class="bp">False</span>
    <span class="k">assert</span> <span class="n">called1</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'a'</span><span class="p">)</span>

<span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">test_with_mixed_handlers</span><span class="p">())</span>
</pre>
<p>This way the calling context has a generic and scalable way of
synchronize the block of code that runs <tt>notify()</tt> with the side effects,
even when they are async and their number is unknown.</p>
</div>
<div id="use-signals-with-classes">

<p>A <tt>Signal</tt> instance class can also be used as a member of a
class. When this is the case a decorator is provided to declare
class-level handlers. To let this feature work, the user class has to
have a specific metaclass:</p>
<pre><span class="kn">from</span> <span class="nn">metapensiero.signal</span> <span class="kn">import</span> <span class="n">Signal</span><span class="p">,</span> <span class="n">SignalAndHandlerInitMeta</span><span class="p">,</span> <span class="n">handler</span>

<span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">SignalAndHandlerInitMeta</span><span class="p">):</span>

    <span class="n">click</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">called</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="nd">@handler</span><span class="p">(</span><span class="s1">'click'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">onclick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">kw</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">called</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">kw</span><span class="p">)</span>

<span class="n">a1</span> <span class="o">=</span> <span class="n">A</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">a1</span><span class="o">.</span><span class="n">called</span> <span class="o">==</span> <span class="bp">False</span>
<span class="n">a1</span><span class="o">.</span><span class="n">click</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">kw</span><span class="o">=</span><span class="s1">'a'</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">a1</span><span class="o">.</span><span class="n">called</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'a'</span><span class="p">)</span>
</pre>
<p>Of course a class-level handler can be async:</p>
<pre><span class="kn">import</span> <span class="nn">asyncio</span>

<span class="kn">from</span> <span class="nn">metapensiero.asyncio</span> <span class="kn">import</span> <span class="n">transaction</span>
<span class="kn">from</span> <span class="nn">metapensiero.signal</span> <span class="kn">import</span> <span class="n">Signal</span><span class="p">,</span> <span class="n">SignalAndHandlerInitMeta</span><span class="p">,</span> <span class="n">handler</span>

<span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">SignalAndHandlerInitMeta</span><span class="p">):</span>

    <span class="n">click</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">called</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">called2</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="nd">@handler</span><span class="p">(</span><span class="s1">'click'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">onclick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">kw</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">called</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">kw</span><span class="p">)</span>

    <span class="nd">@handler</span><span class="p">(</span><span class="s1">'click'</span><span class="p">)</span>
    <span class="nd">@asyncio.coroutine</span>
    <span class="k">def</span> <span class="nf">click2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">kw</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">called2</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">kw</span><span class="p">)</span>

<span class="n">a1</span> <span class="o">=</span> <span class="n">A</span><span class="p">()</span>

<span class="nd">@asyncio.coroutine</span>
<span class="k">def</span> <span class="nf">runner</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">a1</span><span class="o">.</span><span class="n">called</span> <span class="o">==</span> <span class="bp">False</span>
    <span class="k">assert</span> <span class="n">a1</span><span class="o">.</span><span class="n">called2</span> <span class="o">==</span> <span class="bp">False</span>

    <span class="n">trans</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
    <span class="n">a1</span><span class="o">.</span><span class="n">click</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">kw</span><span class="o">=</span><span class="s1">'a'</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">a1</span><span class="o">.</span><span class="n">called</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'a'</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">a1</span><span class="o">.</span><span class="n">called2</span> <span class="o">==</span> <span class="bp">False</span>
    <span class="k">yield from</span> <span class="n">trans</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">a1</span><span class="o">.</span><span class="n">called2</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'a'</span><span class="p">)</span>

<span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">runner</span><span class="p">())</span>
</pre>
<p>Of course, you can use the <tt>Signal</tt> class without user class
instrumentation, but you will have to do per-instance subscriptions by
yourself:</p>
<pre><span class="k">class</span> <span class="nc">B</span><span class="p">:</span>

    <span class="c1"># the name here is needed for classes that don't explicitly support</span>
    <span class="c1"># signals</span>
    <span class="n">click</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="s1">'click'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">called</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">click</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">onclick</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">onclick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">kw</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">called</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">kw</span><span class="p">)</span>

<span class="n">b</span> <span class="o">=</span> <span class="n">B</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">b</span><span class="o">.</span><span class="n">called</span> <span class="o">==</span> <span class="bp">False</span>
<span class="n">b</span><span class="o">.</span><span class="n">onclick</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">kw</span><span class="o">=</span><span class="s1">'b'</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">b</span><span class="o">.</span><span class="n">called</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">)</span>
</pre>
</div>
<div id="extensibility">

<p>Signals support two way to extend their functionality. The first is
global and is intended as a way to plug in signals into other event
systems. Please have a look at the code in <tt>external.py</tt> and the
corrisponding tests to learn how to use those abstract classes, they
give you a way to tap into signal’s machinery do your stuff.</p>
<p>The second way is per-signal and allows you to define three functions
to wrap around <tt>notify()</tt>, <tt>connect()</tt>, <tt>disconnect()</tt> and
attach them to each instance of signal via decorators, much like with
builtins properties.</p>
<p>Each of these functions will receive all the relevant arguments to
customize the behavior of the internal signal methods and will receive
another argument that every function has to call in order to trigger
the default behavior. The return value of your wrapper function will
be returned to the calling context instead of default return values.</p>
<p>Here is an example, pay attention to the signature of each wrapper
beacuse you have to respect that:</p>
<pre><span class="kn">from</span> <span class="nn">metapensiero.signal</span> <span class="kn">import</span> <span class="n">Signal</span><span class="p">,</span> <span class="n">SignalAndHandlerInitMeta</span><span class="p">,</span> <span class="n">handler</span>

<span class="n">c</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">called</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">connnect_handler</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">handler_called</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">handler_args</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
         <span class="n">disconnnect_handler</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">handler2_called</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">handler2_args</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">SignalAndHandlerInitMeta</span><span class="p">):</span>

     <span class="nd">@Signal</span>
     <span class="k">def</span> <span class="nf">click</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subscribers</span><span class="p">,</span> <span class="n">notify</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
         <span class="n">c</span><span class="p">[</span><span class="s1">'called'</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
         <span class="n">c</span><span class="p">[</span><span class="s1">'wrap_args'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
         <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">subscribers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
         <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
         <span class="n">notify</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
         <span class="k">return</span> <span class="s1">'mynotify'</span>

     <span class="nd">@click.on_connect</span>
     <span class="k">def</span> <span class="nf">click</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">subscribers</span><span class="p">,</span> <span class="n">connect</span><span class="p">):</span>
         <span class="n">c</span><span class="p">[</span><span class="s1">'called'</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
         <span class="n">c</span><span class="p">[</span><span class="s1">'connect_handler'</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span>
         <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">subscribers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
         <span class="n">connect</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
         <span class="k">return</span> <span class="s1">'myconnect'</span>

     <span class="nd">@click.on_disconnect</span>
     <span class="k">def</span> <span class="nf">click</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">subscribers</span><span class="p">,</span> <span class="n">disconnect</span><span class="p">):</span>
         <span class="n">c</span><span class="p">[</span><span class="s1">'called'</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
         <span class="n">c</span><span class="p">[</span><span class="s1">'disconnect_handler'</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span>
         <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">subscribers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
         <span class="n">disconnect</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
         <span class="k">return</span> <span class="s1">'mydisconnect'</span>

     <span class="nd">@handler</span><span class="p">(</span><span class="s1">'click'</span><span class="p">)</span>
     <span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
         <span class="n">c</span><span class="p">[</span><span class="s1">'handler_called'</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
         <span class="n">c</span><span class="p">[</span><span class="s1">'handler_args'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">A</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">handler2</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">c</span><span class="p">[</span><span class="s1">'handler2_called'</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">c</span><span class="p">[</span><span class="s1">'handler2_args'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">click</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">handler2</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">res</span> <span class="o">==</span> <span class="s1">'myconnect'</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">click</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="s1">'bar'</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">res</span> <span class="o">==</span> <span class="s1">'mynotify'</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">click</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="n">handler2</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">res</span> <span class="o">==</span> <span class="s1">'mydisconnect'</span>
<span class="k">assert</span> <span class="n">c</span><span class="p">[</span><span class="s1">'called'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span>
<span class="k">assert</span> <span class="n">c</span><span class="p">[</span><span class="s1">'wrap_args'</span><span class="p">]</span> <span class="o">==</span> <span class="p">((</span><span class="s1">'bar'</span><span class="p">,),</span> <span class="p">{</span><span class="s1">'k'</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="k">assert</span> <span class="n">c</span><span class="p">[</span><span class="s1">'handler_called'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
<span class="k">assert</span> <span class="n">c</span><span class="p">[</span><span class="s1">'handler_args'</span><span class="p">]</span> <span class="o">==</span> <span class="p">((</span><span class="s1">'foo'</span><span class="p">,),</span> <span class="p">{</span><span class="s1">'k'</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
<span class="k">assert</span> <span class="n">c</span><span class="p">[</span><span class="s1">'handler2_called'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
<span class="k">assert</span> <span class="n">c</span><span class="p">[</span><span class="s1">'handler2_args'</span><span class="p">]</span> <span class="o">==</span> <span class="p">((</span><span class="s1">'foo'</span><span class="p">,),</span> <span class="p">{</span><span class="s1">'k'</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
<span class="k">assert</span> <span class="n">c</span><span class="p">[</span><span class="s1">'disconnect_handler'</span><span class="p">]</span> <span class="o">==</span> <span class="n">handler2</span>
<span class="k">assert</span> <span class="n">c</span><span class="p">[</span><span class="s1">'connect_handler'</span><span class="p">]</span> <span class="o">==</span> <span class="n">handler2</span>
</pre>
<p>As you can see, with this way of managing wrappers to default
behaviors, you can modify arguments, return customized values or even
avoid triggering the default behavior.</p>
</div>
</div>
</div></body></html>