<html><body><div><article class="markdown-body entry-content" itemprop="text"><p><a href="https://travis-ci.org/zalando/patroni"><img alt="Build Status" src="https://camo.githubusercontent.com/d8a19468047a00218681f69696db16446f82c710/68747470733a2f2f7472617669732d63692e6f72672f7a616c616e646f2f706174726f6e692e7376673f6272616e63683d6d6173746572" data-canonical-src="https://travis-ci.org/zalando/patroni.svg?branch=master"/></a> <a href="https://coveralls.io/r/zalando/patroni?branch=master"><img alt="Coverage Status" src="https://camo.githubusercontent.com/eca9363f77fa1c5edb7e099fd81f1f276d7ed125/68747470733a2f2f636f766572616c6c732e696f2f7265706f732f7a616c616e646f2f706174726f6e692f62616467652e7376673f6272616e63683d6d6173746572" data-canonical-src="https://coveralls.io/repos/zalando/patroni/badge.svg?branch=master"/></a></p>
<a name="user-content-patroni-a-template-for-postgresql-ha-with-zookeeper-or-etcd"/>
<h2><a id="user-content-patroni-a-template-for-postgresql-ha-with-zookeeper-or-etcd" class="anchor" href="#patroni-a-template-for-postgresql-ha-with-zookeeper-or-etcd" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Patroni: A Template for PostgreSQL HA with ZooKeeper or etcd</h2>
<p>Patroni was previously known as Governor.</p>
<p><em>There are many ways to run high availability with PostgreSQL. Here, we
present a template for you to create your own customized, high-availability
solution using Python and — for maximum accessibility — a distributed
configuration store like ZooKeeper or etcd.</em></p>
<a name="user-content-getting-started"/>
<h2><a id="user-content-getting-started" class="anchor" href="#getting-started" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Getting Started</h2>
<p>To get started, do the following from different terminals:</p>
<pre>&gt; etcd --data-dir=data/etcd
&gt; ./patroni.py postgres0.yml
&gt; ./patroni.py postgres1.yml
</pre>
<p>From there, you will see a high-availability cluster start up. Test
different settings in the YAML files to see how its behavior changes. Kill
some of the components to see how the system behaves.</p>
<p>Add more <code>postgres*.yml</code> files to create an even larger cluster.</p>
<p>We provide a haproxy configuration, which will give your application a
single endpoint for connecting to the cluster's leader. To configure,
run:</p>
<pre>&gt; haproxy -f haproxy.cfg
</pre>
<pre>&gt; psql --host 127.0.0.1 --port 5000 postgres
</pre>
<a name="user-content-how-patroni-works"/>
<h2><a id="user-content-how-patroni-works" class="anchor" href="#how-patroni-works" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>How Patroni Works</h2>
<p>For a diagram of the high availability decision loop, review this PDF:
<a href="https://github.com/zalando/patroni/blob/master/postgres-ha.pdf">postgres-ha.pdf</a></p>
<a name="user-content-yaml-configuration"/>
<h2><a id="user-content-yaml-configuration" class="anchor" href="#yaml-configuration" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>YAML Configuration</h2>
<p>For an example file, see <code>postgres0.yml</code>. Regarding settings:</p>

<a name="user-content-replication-choices"/>
<h2><a id="user-content-replication-choices" class="anchor" href="#replication-choices" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Replication Choices</h2>
<p>Patroni uses Postgres' streaming replication. By default, this
replication is asynchronous. For more information, see the <a href="http://www.postgresql.org/docs/current/static/warm-standby.html#STREAMING-REPLICATION">Postgres
documentation on streaming
replication</a>.</p>
<p>Patroni's asynchronous replication configuration allows for
<code>maximum_lag_on_failover</code> settings. This setting ensures failover will
not occur if a follower is more than a certain number of bytes behind
the follower. This setting should be increased or decreased based on
business requirements.</p>
<p>When asynchronous replication is not optimal for your use case, investigate
how Postgres's <a href="http://www.postgresql.org/docs/current/static/warm-standby.html#SYNCHRONOUS-REPLICATION">synchronous
replication</a>
works. Synchronous replication ensures consistency across a cluster by
confirming that writes are written to a secondary before returning to
the connecting client with a success. The cost of synchronous
replication: reduced throughput on writes. This throughput will
be entirely based on network performance. In hosted datacenter
environments (like AWS, Rackspace, or any network you do not control),
synchrous replication significantly increases the variability of write
performance. If followers become inaccessible from the leader, the
leader effectively becomes readonly.</p>
<p>To enable a simple synchronous replication test, add the follow lines to
the <code>parameters</code> section of your YAML configuration files:</p>
<div class="highlight highlight-source-yaml"><pre><span class="pl-s"><span class="pl-ent">synchronous_commit:</span> <span class="pl-s"><span class="pl-pds">"</span>on<span class="pl-pds">"</span></span></span>
<span class="pl-s"><span class="pl-ent">synchronous_standby_names:</span> <span class="pl-s"><span class="pl-pds">"</span>*<span class="pl-pds">"</span></span></span></pre></div>
<p>When using synchronous replication, use at least three Postgres data nodes
to ensure write availability if one host fails.</p>
<p>Choosing your replication schema is dependent on your business
considerations. Investigate both async and sync replication, as well as other
HA solutions, to determine which solution is best for you.</p>
<a name="user-content-applications-should-not-use-superusers"/>
<h2><a id="user-content-applications-should-not-use-superusers" class="anchor" href="#applications-should-not-use-superusers" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Applications Should Not Use Superusers</h2>
<p>When connecting from an application, always use a non-superuser. Patroni
requires access to the database to function properly. By using a
superuser from an application, you can potentially use the entire
connection pool, including the connections reserved for superusers with
the <code>superuser_reserved_connections</code> setting. If Patroni cannot access
the Primary because the connection pool is full, behavior will be
undesireable.</p>
<a name="user-content-requirements-on-a-mac"/>
<h2><a id="user-content-requirements-on-a-mac" class="anchor" href="#requirements-on-a-mac" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Requirements on a Mac</h2>
<p>Run the following on a Mac to install requirements:</p>
<pre>brew install postgresql etcd haproxy libyaml python
pip install psycopg2 pyyaml
</pre>
<a name="user-content-notice"/>
<h2><a id="user-content-notice" class="anchor" href="#notice" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Notice</h2>
<p>There are many different ways to do HA with PostgreSQL: See <a href="https://wiki.postgresql.org/wiki/Replication,_Clustering,_and_Connection_Pooling">the
PostgreSQL
documentation</a>
for a complete list.</p>
<p>We call Patroni a "template" because it is far from being a one-size-fits-all
or plug-and-play replication system. It will have its own caveats. Use wisely.</p>

</article>
  </div></body></html>