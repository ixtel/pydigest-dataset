<html><body><div><div itemprop="articleBody"><p>I usually need to run more than 1 command for some project and got tired of searching through those putty windows for the session I want. So I thought of using a terminal multiplexer like <a class="reference external" href="http://tmux.sourceforge.net/">Tmux</a>.</p><p>I'm using celery with two queues and I need to run this:</p><ul class="simple"><li>manage.py celeryd -Q queueA</li><li>manage.py celeryd -Q queueB</li><li>manage.py celerycam -E</li></ul><p>I need celerycam because it will get those <a class="reference external" href="http://ask.github.com/celery/userguide/monitoring.html?highlight=celerycam#starting-the-monitor">stats in djcelery</a> up to date.</p><p>It's also a good idea to tail the postgresql log - when you break your models or database in some cases Django isn't very helpful so this helps a lot:</p><ul class="simple"><li>tail -f /var/log/postgresql/postgresql-8.4-main.log</li></ul><p>I use a wide screen so I want a layout like this:</p><div class="term container"><pre class="literal-block">
+------------------------------------+-------------------+
|                                    |                   |
|              runserver             |                   |
|                                    |     celerycam     |
+------------------------------------+                   |
|                                    |                   |
|               celeryd              +-------------------+
|                                    |                   |
+------------------------------------+                   |
|                                    |   postgresql log  |
|               celeryd              |                   |
|                                    |                   |
+------------------------------------+-------------------+
</pre></div><p>I also want to start a new tmux session from the same command so I can close everything easily - those celeryd's don't reload automatically :(</p><p>You'd usually run something like:</p><div class="highlight"><pre><span/>tmux new-session <span class="s2">"tmux splitw 'command1';  tmux splitw 'command3'; tmux splitw 'command3'; command4"</span>
</pre></div><p>But that gets rather long and you need to quote and escape, calculate the panel sizes manually (I want equal height) and for the layout above you also need to select the right panels before splitting.</p><p>The commands vary across projects (some have more and some have less) - so how about we make a script:</p><div class="highlight"><pre><span/><span class="kn">import</span> <span class="nn">subprocess</span>

<span class="n">left_commands</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">"python manage.py runserver"</span><span class="p">,</span>
    <span class="s2">"python manage.py celeryd -Q queueA -c 2 -E -n worker1"</span><span class="p">,</span>
    <span class="s2">"python manage.py celeryd -Q queueB -c 2 -E -n worker2"</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">right_commands</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">"python manage.py celerycam"</span><span class="p">,</span>
    <span class="s2">"tail -f /var/log/postgresql/postgresql-8.4-main.log"</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">session</span> <span class="o">=</span> <span class="s1">''</span>

<span class="k">if</span> <span class="n">right_commands</span><span class="p">:</span>
    <span class="n">session</span> <span class="o">+=</span> <span class="s1">'tmux selectp -t 0; tmux splitw -hd -p 35 </span><span class="se">\"</span><span class="si">%s</span><span class="se">\"</span><span class="s1">; '</span> <span class="o">%</span> <span class="n">right_commands</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">command</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">right_commands</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">session</span> <span class="o">+=</span> <span class="s1">'tmux selectp -t 1; tmux splitw -d -p </span><span class="si">%i</span><span class="s1"> </span><span class="se">\"</span><span class="si">%s</span><span class="se">\"</span><span class="s1">; '</span> <span class="o">%</span> <span class="p">(</span>
        <span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">right_commands</span><span class="p">)</span> <span class="o">-</span> <span class="n">index</span><span class="p">),</span>
        <span class="n">command</span>
    <span class="p">)</span>

<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">command</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">left_commands</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
    <span class="n">session</span> <span class="o">+=</span> <span class="s1">'tmux selectp -t 0; tmux splitw -d -p </span><span class="si">%i</span><span class="s1"> </span><span class="se">\"</span><span class="si">%s</span><span class="se">\"</span><span class="s1">; '</span> <span class="o">%</span> <span class="p">(</span>
        <span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">left_commands</span><span class="p">)</span> <span class="o">-</span> <span class="n">index</span><span class="p">),</span>
        <span class="n">command</span>
    <span class="p">)</span>
<span class="k">if</span> <span class="n">left_commands</span><span class="p">:</span>
    <span class="n">session</span> <span class="o">+=</span> <span class="n">left_commands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">args</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'tmux'</span><span class="p">,</span>
    <span class="s1">'new-session'</span><span class="p">,</span>
    <span class="n">session</span><span class="p">,</span>
<span class="p">]</span>
<span class="k">print</span> <span class="s1">'Running '</span><span class="p">,</span> <span class="n">args</span>
<span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</pre></div></div></div></body></html>