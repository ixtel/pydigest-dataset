<html><body><div><div class="entry-content"><p>With the end of support for Python 2 on the horizon
(<a href="https://www.python.org/dev/peps/pep-0373/">in 2020</a>), many package developers
have made their packages compatible with both Python 2 and Python 3 by using
constructs such as:</p>
<div class="highlight"><pre><span class="k">if</span> <span class="n">sys</span><span class="p">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="o">:</span>
    <span class="err">#</span> <span class="n">Python</span> <span class="mi">2</span> <span class="n">code</span>
<span class="nl">else:</span>
    <span class="err">#</span> <span class="n">Python</span> <span class="mi">3</span> <span class="n">code</span>
</pre></div>


<p>in places where things have changed between Python 2 and 3.</p>


<p>The <a href="https://pythonhosted.org/six/">six</a> package simplifies many of the
differences by providing wrappers that behave the same on Python 2 and 3. For
instance, iterating over dictionary keys is normally done with:</p>
<div class="highlight"><pre><span class="k">for</span> <span class="n">item</span> <span class="n">in</span> <span class="n">dictionary</span><span class="p">.</span><span class="n">iteritems</span><span class="p">()</span><span class="o">:</span>
    <span class="err">#</span> <span class="n">code</span> <span class="n">here</span>
</pre></div>


<p>in Python 2 and:</p>
<div class="highlight"><pre><span class="k">for</span> <span class="n">item</span> <span class="n">in</span> <span class="n">dictionary</span><span class="p">.</span><span class="n">items</span><span class="p">()</span><span class="o">:</span>
    <span class="err">#</span> <span class="n">code</span> <span class="n">here</span>
</pre></div>


<p>in Python 3. With <a href="https://pythonhosted.org/six/">six</a>, one can simply do:</p>
<div class="highlight"><pre><span class="n">import</span> <span class="n">six</span>

<span class="k">for</span> <span class="n">item</span> <span class="n">in</span> <span class="n">six</span><span class="p">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">dictionary</span><span class="p">)</span><span class="o">:</span>
    <span class="err">#</span> <span class="n">code</span> <span class="n">here</span>
</pre></div>


<p>and this will work seamlessly both with Python 2 and 3. However, there are some
more complex cases where one has to resort to the type of <code>if</code> statement shown at
the top of this post. The <a href="https://pythonhosted.org/six/">six</a> package again
makes this slightly easier by providing <code>PY2</code> and <code>PY3</code> boolean constants:</p>
<div class="highlight"><pre><span class="k">if</span> <span class="n">six</span><span class="p">.</span><span class="n">PY2</span><span class="o">:</span>
    <span class="err">#</span> <span class="n">Python</span> <span class="mi">2</span> <span class="n">code</span>
<span class="nl">else:</span>
    <span class="err">#</span> <span class="n">Python</span> <span class="mi">3</span> <span class="n">code</span>
</pre></div>


<p>So far so good.</p>
<p>This brings me to the main point of this post. We don't
really know yet what Python 4 will look like, but we can be pretty sure that
the transition from Python 3 to Python 4 will be a lot smoother and will likely
<a href="https://opensource.com/life/14/9/why-python-4-wont-be-python-3">not be backward-incompatible in the same way as Python 3 was</a>. If that's
the case, we should be able to use packages developed for Python 2 and 3
seamlessly with Python 4. Right?...</p>
<p>Not quite! By searching on GitHub, I found almost 300,000 matches for the
following kind of syntax:</p>
<div class="highlight"><pre><span class="k">if</span> <span class="n">six</span><span class="p">.</span><span class="n">PY3</span><span class="o">:</span>
    <span class="err">#</span> <span class="n">Python</span> <span class="mi">3</span> <span class="n">code</span>
<span class="nl">else:</span>
    <span class="err">#</span> <span class="n">Python</span> <span class="mi">2</span> <span class="n">code</span>
</pre></div>


<p>See the problem? In <code>six</code>, <code>PY3</code> is defined as:</p>
<div class="highlight"><pre><span class="n">PY3</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span>
</pre></div>


<p>so that once Python 4 is used, both <code>PY2</code> and <code>PY3</code> will be (correctly)
<code>False</code> and the above <code>if</code> statement will execute the <code>else</code> statement for
Python 2 code. Oops!</p>
<p>Another example of problematic code is the following:</p>
<div class="highlight"><pre><span class="k">if</span> <span class="n">six</span><span class="p">.</span><span class="n">PY2</span><span class="o">:</span>
    <span class="err">#</span> <span class="n">Python</span> <span class="mi">2</span> <span class="n">code</span>
<span class="n">elif</span> <span class="n">six</span><span class="p">.</span><span class="n">PY3</span><span class="o">:</span>
    <span class="err">#</span> <span class="n">Python</span> <span class="mi">3</span> <span class="n">code</span>
</pre></div>


<p>In this case, no code will get executed on Python 4 at all!</p>
<p>To avoid this, it's critical that we avoid treating Python 3 as a special case
in these kinds of <code>if</code> statements and instead treat Python <strong>2</strong> as the
special case, and default to Python 3 code otherwise:</p>
<div class="highlight"><pre><span class="k">if</span> <span class="n">six</span><span class="p">.</span><span class="n">PY2</span><span class="o">:</span>
    <span class="err">#</span> <span class="n">Python</span> <span class="mi">2</span> <span class="n">code</span>
<span class="nl">else:</span>
    <span class="err">#</span> <span class="n">Python</span> <span class="mi">3</span> <span class="n">code</span>
</pre></div>


<p>It's a small change, but it will save a lot of headaches down the road. So if
you develop a Python package, please check now to make sure that your code will
be Python 4-compatible!</p>
<p><strong>Update:</strong> of course, the same logic applies even if not using the six
package. If doing version comparisons using <code>sys.version_info</code>, make sure you
<strong>don't</strong> do:</p>
<div class="highlight"><pre><span class="k">if</span> <span class="n">sys</span><span class="p">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="o">:</span>
    <span class="err">#</span> <span class="n">Python</span> <span class="mi">3</span> <span class="n">code</span>
<span class="nl">else:</span>
    <span class="err">#</span> <span class="n">Python</span> <span class="mi">2</span> <span class="n">code</span>
</pre></div>


<p>Either swap the if statement and check for Python 2, or make sure you use
<code>&gt;=</code>.</p></div>
    </div></body></html>