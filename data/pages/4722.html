<html><body><div><div class="content html_format">
      <img src="https://habrastorage.org/files/c50/9cb/942/c509cb942c48414489e664239685954f.jpg"/>
<p>
Привет, Хабр!</p><p>
Историй о разработке игр было немало, сегодня я попробую вкратце рассказать нашу. 

</p><i>Мир есть текст — Жак Деррида<br/>
Игра есть словарь —  <a href="http://habrahabr.ru/users/a11aud/" class="user_link">a11aud</a></i>
<a name="habracut"/>
<h2>Идея</h2><p>
Началось все с выдвинутой  </p><a href="http://habrahabr.ru/users/a11aud/" class="user_link">a11aud</a><p> идеи что состояние большинства процессов можно представить конечным автоматом, который управляется командами. Состояние этого конечного автомата представляется в виде словаря, работа с которым производится на языке высокого уровня, в нашем случае на Python. Такой подход сулил много преимуществ при должном выборе технологий. Антон запилил тестовый мессенджер на tornado и все об этом благополучно забыли.
</p><p>
К концу прошлого года экономическая обстановка заставила вернуться к идее и был рожден концепт. Хотя придуманная архитектура позволяла натянуть на механику практически любую стратегическую игры, окончательным решением стал командный tower defence 4х4 в фэнтезийном сеттинге.

</p><h2>Их было четверо</h2><p>
И разработчиками были только двое. И все работали на основных работах по 8 часов в день. И выдержали в таком темпе полгода.
</p><p>
В соответствии с принципами демократического централизма все решения по архитектуре принимаются архитектором, а решения по игровой механике гейм-дизайнером после совместного обсуждения.
</p><p>
Процесс был организован итеративно: на каждую неделю намечался список фич к реализации с ответственными. Независимо от результатов итерации функционал должен был расти от итерации к итерации. Каждую неделю по возможности проводился совместный сбор, демонстрация достижений, раздача слонов, поедание еды и иногда даже выпивание пива. 
</p><p>
Планировалось плавно наращивать программный функционал и начиная с играбельной версии параллельно начинать работу над моделями существ и дизайном интерфейса.

</p><h2>Технологии</h2><p>
Для сервера было решено продолжать использовать tornado. Это сделало разработку доступной «для самых маленьких» и позволило легко масштабировать серверное решение. Сервер с самого начала задумывался авторитарным. Игрок может взаимодействовать с ним только строго определенными игровыми действиями и никак на механику повлиять не может. Извиняйте, читеры. То есть клиент по сути просто “телевизор с пультом”, который показывает игровой процесс.
</p><p>
Для клиентского приложения был выбран Unity: кроссплатформенность, прекрасная поддержка, легкость вхождения сделали этот движок единственным разумным решением в условиях нашего коллектива.
</p><p>
Взаимодействие между сервером и клиентом было решено осуществлять по сырому протоколу websocket. Подкупила простота работы в </p><a href="http://www.tornadoweb.org/en/stable/">tornado</a><p>, но потом это аукнулось.</p><p>
Но обо всем по порядку.

</p><h2>Немного азов</h2><p>
Что такое любая игра? Это цикл расчета игрового мира с неким шагом расчета, продолжающийся до победы/поражения. Ровно так же на клиент прилетают состояния игры, которые он отрисовывает, попутно отсылая на сервер действия игроков. Игровых данных может быть очень много поэтому для того, чтобы на одном сервере могло быть запущено около 5000 игровых приложений, нам пришлось пройти следующий путь:
</p><ol>
<li>Первоначально мы гоняли json-сериализованное состояние игрового мира.</li>
<li>Когда стало ясно, что 10 инстансов это маловато, был реализован diff-алгоритм, который позволил слать только дельта-состояние. Жить стало лучше.</li>
<li>Спецификация websocket’ предполагает возможность сжатия трафика алгоритмом deflate. Но к сожалению в той реализации, которую мы выбрали, сжатие зависело от системных библиотек и разнилось на Windows и MacOS. Пришлось лезть в исходники и делать свое сжатие с орлянкой и гоблиншами. Это дало выигрыш еще в 40 раз. Жить стало веселее.</li>
</ol>
<img src="https://habrastorage.org/files/9db/13c/a82/9db13ca82fc0413d8fdfecadf9f22daf.jpeg"/>

<h2>Игровая механика</h2>
<iframe src="https://www.youtube.com/embed/huQePwzpcns?feature=oembed" frameborder="0" allowfullscreen="">VIDEO</iframe>
<p>
Расчет боя происходит по очевидной схеме: юниты сближаются, если расстояние до ближайшего врага позволяет провести атаку, завязывается драка с расчетом повреждений. Звучит просто, но в реале это алгоритм квадратичной сложности и на массовом замесе серьезно сказывается скорость работы python. Было применено комплексное решение:
</p><ol>
<li>Юниты стали храниться в <a href="https://ru.wikipedia.org/wiki/R-%D0%B4%D0%B5%D1%80%D0%B5%D0%B2%D0%BE">R-дереве</a>. Это снизило длину цикла расчета целей для атаки.</li>
<li>При помощи Cython компонент боя компилируется в сишный код. Выигрыш в производительности около 10 раз.</li>
</ol>

<h2>Атака лисят</h2>
<img src="https://habrastorage.org/files/175/22a/61c/17522a61cfbb463984ee232525cdaa47.png"/>
<p>
А теперь вернемся к вопросу, вынесенному в заглавию. Конечно никак. Если игра сложнее крестиков-ноликов, у вас ничего не выйдет. На начальных этапах мы вели отладку на кубиках, потом перешли на бесплатные модели из Unity Asset Store. Когда мы чуть не травмировались от вида атаки щенят и лисят, мы призвали на помощь варяга. На наш призыв откликнулся один замечательный дизайнер из Кишинева. Дизайн, который вы видите на видео, выполнен им, но жизненные обстоятельства наложили на наше сотрудничество некоторые ограничения. Димыч, если ты это читаешь, спасибо огромное за гоблина, скорейшего новоселья, мы тебя ждем.
</p><p>
В общем, если решите пойти по нашим стопам, не начинайте без художников. Несмотря на все мы с оптимизмом смотрим в будущее и продолжаем поиски готовых к сотрудничеству людей.

      	</p><div class="polling">
		

	

    <p class="for_users_only_msg">Только зарегистрированные пользователи могут участвовать в опросе. <a href="https://habrahabr.ru/auth/login/">Войдите</a>, пожалуйста.</p>
	</div>

      <p class="clear"/>
    </div>

    
  </div></body></html>