<html><body><div><div class="body"><div itemscope="" itemtype="http://schema.org/Article"><h1 class="title" itemprop="name">lxml's element builder and CDATA objects</h1><p class="date"> Sun 15 June 2014</p><div itemprop="articleBody"><p><a class="reference external" href="https://pypi.python.org/pypi/lxml/">lxml</a> has a very nice <a class="reference external" href="http://lxml.de/tutorial.html#the-e-factory">element builder</a> though it doesn't seem to work with <a class="reference external" href="http://lxml.de/api.html#cdata">CDATA objects</a>:</p><div class="highlight"><pre><span/><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">lxml.builder</span> <span class="kn">import</span> <span class="n">E</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">lxml.etree</span> <span class="kn">import</span> <span class="n">CDATA</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">E</span><span class="o">.</span><span class="n">stuff</span><span class="p">(</span><span class="n">CDATA</span><span class="p">(</span><span class="s1">'Some stuff that needs to be in a CDATA section'</span><span class="p">))</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">"&lt;ipython-input-4-40103024e8d8&gt;"</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
    <span class="n">E</span><span class="o">.</span><span class="n">stuff</span><span class="p">(</span><span class="n">CDATA</span><span class="p">(</span><span class="s1">'Some stuff that needs to be in a CDATA section'</span><span class="p">))</span>
  File <span class="nb">"/usr/lib/python2.7/dist-packages/lxml/builder.py"</span>, line <span class="m">220</span>, in <span class="n">__call__</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"bad argument type: </span><span class="si">%r</span><span class="s2">"</span> <span class="o">%</span> <span class="n">item</span><span class="p">)</span>
<span class="gr">TypeError</span>: <span class="n">bad argument type: &lt;lxml.etree.CDATA object at 0x238a130&gt;</span>
</pre></div><p>To fix it, do this:</p><div class="highlight"><pre><span/><span class="kn">from</span> <span class="nn">lxml.builder</span> <span class="kn">import</span> <span class="n">ElementMaker</span>
<span class="kn">from</span> <span class="nn">lxml.etree</span> <span class="kn">import</span> <span class="n">CDATA</span>

<span class="k">def</span> <span class="nf">add_cdata</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">cdata</span><span class="p">):</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s2">"Can't add a CDATA section. Element already has some text: </span><span class="si">%r</span><span class="s2">"</span> <span class="o">%</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span>
    <span class="n">element</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">cdata</span>

<span class="n">E</span> <span class="o">=</span> <span class="n">ElementMaker</span><span class="p">(</span><span class="n">typemap</span><span class="o">=</span><span class="p">{</span>
    <span class="n">CDATA</span><span class="p">:</span> <span class="n">add_cdata</span>
<span class="p">})</span>
</pre></div><p>Then everything works as expected:</p><div class="highlight"><pre><span/><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">stuff</span><span class="p">(</span><span class="n">CDATA</span><span class="p">(</span><span class="s1">'Some stuff that needs to be in a CDATA section'</span><span class="p">)))</span>
<span class="go">'&lt;stuff&gt;&lt;![CDATA[Some stuff that needs to be in a CDATA section]]&gt;&lt;/stuff&gt;'</span>
</pre></div></div><p class="tags">This entry was tagged as <a href="https://blog.ionelmc.ro/tag/python/"><span itemprop="keywords">python</span></a></p></div><p id="disqus_thread"/><noscript> Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </div></div></body></html>