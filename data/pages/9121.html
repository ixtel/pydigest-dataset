<html><body><div><p>Deduplicate mails from a set of maildir folders.</p>








<div id="maildir-deduplicate">
<h2>Maildir Deduplicate</h2>
<p>Command-line tool to deduplicate mails from a set of maildir folders.</p>
<p>Stable release: <a href="https://pypi.python.org/pypi/maildir-deduplicate" rel="nofollow"><img src="https://img.shields.io/pypi/v/maildir-deduplicate.svg?style=flat"/></a> <a href="https://www.gnu.org/licenses/gpl-2.0.html" rel="nofollow"><img src="https://img.shields.io/pypi/l/maildir-deduplicate.svg?style=flat"/></a> <a href="https://requires.io/github/kdeldycke/maildir-deduplicate/requirements/?branch=master" rel="nofollow"><img src="https://img.shields.io/requires/github/kdeldycke/maildir-deduplicate/master.svg?style=flat"/></a> <a href="https://pypi.python.org/pypi/maildir-deduplicate#downloads" rel="nofollow"><img src="https://img.shields.io/pypi/dm/maildir-deduplicate.svg?style=flat"/></a></p>
<p>Development: <a href="https://travis-ci.org/kdeldycke/maildir-deduplicate" rel="nofollow"><img src="https://img.shields.io/travis/kdeldycke/maildir-deduplicate/develop.svg?style=flat"/></a> <a href="https://codecov.io/github/kdeldycke/maildir-deduplicate?branch=develop" rel="nofollow"><img src="https://codecov.io/github/kdeldycke/maildir-deduplicate/coverage.svg?branch=develop"/></a> <a href="https://scrutinizer-ci.com/g/kdeldycke/maildir-deduplicate/?branch=develop" rel="nofollow"><img src="https://img.shields.io/scrutinizer/g/kdeldycke/maildir-deduplicate.svg?style=flat"/></a></p>

<div id="usage">
<h3>Usage</h3>
<p>List global options and commands:</p>
<pre>$ mdedup --help
Usage: mdedup [OPTIONS] COMMAND [ARGS]...

  CLI for maildirs content analysis and deletion.

Options:
  --version      Show the version and exit.
  -v, --verbose  Print much more debug statements.
  --help         Show this message and exit.

Commands:
  deduplicate  Deduplicate maildirs content.
  hash         Hash a single mail.
</pre>
<p>Deduplication command specific options:</p>
<pre>$ mdedup deduplicate --help
Usage: mdedup deduplicate <span class="o">[</span>OPTIONS<span class="o">]</span> <span class="o">[</span>MAILDIRS<span class="o">]</span>...

  Deduplicate mails from a <span class="nb">set</span> of maildir folders.

  Removal strategies <span class="k">for</span> each <span class="nb">set</span> of mail duplicates:
      - older: remove all but the newest message <span class="o">(</span>determined by ctime<span class="o">)</span>.
      - newer: remove all but the oldest message <span class="o">(</span>determined by ctime<span class="o">)</span>.
      - smaller: Remove all but largest message.
      - matching: Remove duplicates whose file path matches the regular
        expression provided via the --regexp parameter.
      - not-matching: Remove duplicates whose file path does not match the
        regular expression provided via the --regexp parameter.

Options:
  --strategy <span class="o">[</span>not-matching<span class="p">|</span>smaller<span class="p">|</span>matching<span class="p">|</span>newer<span class="p">|</span>older<span class="o">]</span>
                                  Removal strategy to apply on found
                                  duplicates.
  -r, --regexp REGEXP             Regular expression <span class="k">for</span> file path. Required
                                  in matching and not-matching strategies.
  -n, --dry-run                   Do not actually remove anything<span class="p">;</span> just show
                                  what would be removed.
  -s, --show-diffs                Show diffs between duplicates even <span class="k">if</span> they
                                  are within the thresholds.
  -i, --message-id                Use Message-ID header as <span class="nb">hash</span> key. This is
                                  not recommended: the default is to compute a
                                  digest of the whole header with selected
                                  headers removed.
  -S, --size-threshold BYTES      Specify maximum allowed difference between
                                  size of duplicates. Set to -1 <span class="k">for</span> no
                                  threshold.
  -D, --diff-threshold BYTES      Specify maximum allowed difference between
                                  size of duplicates. Set to -1 <span class="k">for</span> no
                                  threshold.
  --help                          Show this message and exit.
</pre>
<p>Hashing command specific options:</p>
<pre>$ mdedup <span class="nb">hash</span> --help
Usage: mdedup <span class="nb">hash</span> <span class="o">[</span>OPTIONS<span class="o">]</span> MESSAGE

  Take a single mail message and show its canonicalised form and hash.

  This is essentially provided <span class="k">for</span> debugging why two messages <span class="k">do</span> not have
  the same <span class="nb">hash</span> when you expect them to <span class="o">(</span>or vice-versa<span class="o">)</span>.

  To get the message from STDIN, use a dash in place of the filename:
      cat mail.txt <span class="p">|</span> mdedup <span class="nb">hash</span> -

Options:
  -i, --message-id  Use Message-ID header as <span class="nb">hash</span> key. This is not
                    recommended: the default is to compute a digest of the
                    whole header with selected headers removed.
  --help            Show this message and exit.
</pre>
</div>
<div id="details">
<h3>Details</h3>
<p>This script reads all mails in a given list of maildir folders and subfolders,
then automatically detects, lists, and optionally deletes any duplicate mails.</p>
<p>Duplicate detection is done by cherry-picking certain headers, in some cases
doing some minor tweaking of the values to reduce them to a canonical form, and
then computing a digest of those headers concatenated together.</p>
<p>Note that we deliberately limit this to certain headers due to the effects that
mailing list software can have on not only the mail header but the body; it can
potentially:</p>
<ul>
<li>append a footer to a list body, thus changing the <tt><span class="pre">Content-Length</span></tt> header;</li>
<li>create a new path described by the <tt>Received</tt> headers which would not be
contained in any copy of the mail saved locally at the time it was sent to
the list;</li>
<li>munge the <tt><span class="pre">Reply-To</span></tt> header even though it’s a bad idea;</li>
<li>add plenty of other random headers which a copy saved locally at sending-time
would not have, such as <tt><span class="pre">X-Mailman-Version</span></tt>, <tt>Precedence</tt>,
<tt><span class="pre">X-BeenThere</span></tt>, <tt><span class="pre">List-*</span></tt>, <tt>Sender</tt>, <tt><span class="pre">Errors-To</span></tt>, and so on;</li>
<li>add a prefix to the <tt>Subject</tt> header.</li>
</ul>
<p>Another difficulty is the lack of guarantee that <tt><span class="pre">Message-ID</span></tt> is unique or
even present.  Yes, certain broken mail servers which must remain nameless are
guilty of this :-(</p>
<p>For added protection against accidentally removing mails due to false
positives, duplicates are verified by comparing body sizes and also diff’ing
the contents.  If the sizes or contents differ by more than a threshold, they
are not counted as duplicates.</p>
</div>
<div id="development">
<h3>Development</h3>
<p>Check out latest development branch:</p>
<pre>$ git clone git@github.com:kdeldycke/maildir-deduplicate.git
$ <span class="nb">cd</span> ./maildir-deduplicate
$ python ./setup.py develop
</pre>
<p>Run unit-tests:</p>
<pre>$ python ./setup.py nosetests
</pre>
<p>Run <a href="https://pep8.readthedocs.org" rel="nofollow">isort</a> utility to sort Python imports:</p>
<pre>$ pip install isort
$ isort --apply
</pre>
<p>Run <a href="https://pep8.readthedocs.org" rel="nofollow">PEP8</a> and <a href="http://docs.pylint.org" rel="nofollow">Pylint</a> code style checks:</p>
<pre>$ pip install pep8 pylint
$ pep8 maildir-deduplicate
$ pylint --rcfile<span class="o">=</span>setup.cfg maildir-deduplicate
</pre>
</div>
<div id="stability-policy">
<h3>Stability policy</h3>
<p>Here is a bunch of rules we’re trying to follow regarding stability:</p>
<ul>
<li>Patch releases (<tt>0.x.n</tt> → <tt><span class="pre">0.x.(n+1)</span></tt> upgrades) are bug-fix only. These
releases must not break anything and keeps backward-compatibility with
<tt>0.x.*</tt> and <tt><span class="pre">0.(x-1).*</span></tt> series.</li>
<li>Minor releases (<tt>0.n.*</tt> → <tt><span class="pre">0.(n+1).0</span></tt> upgrades) includes any non-bugfix
changes. These releases must be backward-compatible with any <tt>0.n.*</tt>
version but are allowed to drop compatibility with the <tt><span class="pre">0.(n-1).*</span></tt> series
and below.</li>
<li>Major releases (<tt><span class="pre">n.*.*</span></tt> → <tt><span class="pre">(n+1).0.0</span></tt> upgrades) are not planned yet,
unless we introduce huge changes to the project.</li>
</ul>
</div>
<div id="release-process">
<h3>Release process</h3>
<p>Start from the <tt>develop</tt> branch:</p>
<pre>$ git clone git@github.com:kdeldycke/maildir-deduplicate.git
$ git checkout develop
</pre>
<p>Revision should already be set to the next version, so we just need to set the
released date in the changelog:</p>
<pre>$ vi ./CHANGES.rst
</pre>
<p>Create a release commit, tag it and merge it back to <tt>master</tt> branch:</p>
<pre>$ git add ./maildir-deduplicate/__init__.py ./CHANGES.rst
$ git commit -m <span class="s2">"Release vX.Y.Z"</span>
$ git tag <span class="s2">"vX.Y.Z"</span>
$ git push
$ git push --tags
$ git checkout master
$ git pull
$ git merge <span class="s2">"vX.Y.Z"</span>
$ git push
</pre>
<p>Push packaging to the <a href="https://wiki.python.org/moin/TestPyPI" rel="nofollow">test cheeseshop</a>:</p>
<pre>$ pip install wheel
$ python ./setup.py register -r testpypi
$ python ./setup.py clean
$ rm -rf ./build ./dist
$ python ./setup.py sdist bdist_egg bdist_wheel upload -r testpypi
</pre>
<p>Publish packaging to <a href="https://pypi.python.org" rel="nofollow">PyPi</a>:</p>
<pre>$ python ./setup.py register -r pypi
$ python ./setup.py clean
$ rm -rf ./build ./dist
$ python ./setup.py sdist bdist_egg bdist_wheel upload -r pypi
</pre>
<p>Bump revision back to its development state:</p>
<pre>$ pip install bumpversion
$ git checkout develop
$ bumpversion --verbose patch
$ git add ./maildir-deduplicate/__init__.py ./CHANGES.rst
$ git commit -m <span class="s2">"Post release version bump."</span>
$ git push
</pre>
<p>Now if the next revision is no longer bug-fix only:</p>
<pre>$ bumpversion --verbose minor
$ git add ./maildir-deduplicate/__init__.py ./CHANGES.rst
$ git commit -m <span class="s2">"Next release no longer bug-fix only. Bump revision."</span>
$ git push
</pre>
</div>

<div id="history">
<h3>History</h3>
<p>This script was <a href="http://kevin.deldycke.com/2010/08/maildir-deduplication-script-python/" rel="nofollow">initially released in 2010</a>, and
was living in a <a href="https://github.com/kdeldycke/scripts" rel="nofollow">messy GitHub repository</a>.</p>
<p>After some years, the script basically outgrew its initial intent, and <a href="http://kevin.deldycke.com/2013/06/maildir-deduplicate-moved/" rel="nofollow">moved
in 2013 to its own repository</a>.</p>
<p>It then continued to be updated as a stand-alone script before being properly
packaged into the current form. The last known working version of the
stand-alone script is available in the <a href="https://github.com/kdeldycke/maildir-deduplicate/tree/legacy" rel="nofollow">legacy branch</a>.</p>
</div>

</div>
</div></body></html>