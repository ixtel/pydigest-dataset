<html><body><div><div class="col-md-12">
				<p>Looking for a new apartment in your city? Is it election day and you want to remind people to get out and vote? Want to poll residents for the best restaurant in their neighborhood?</p>
<p>In this blog post, we’ll build a messaging application where messages are broadcast to recipients based on the city reported by their browser location. Having everyone in your city join together in a chat application may seem crazy, but buckle up, because we’re going to give it a try. By combining Python, Django, <a href="https://www.twilio.com/ip-messaging">Twilio IP Messaging</a> and the Google Maps API we’ll take our best shot at making it easier to find an apartment, remind your neighbors to vote or poll your fellow city residents.</p>
<h2 class="c1 c12"><a name="h.vnfgfe2ksv6z"/>Tools We’ll Need</h2>
<p>Before we dive into building our neighborhood-based chat application, let’s take a look at the tools we’ll be using throughout this blog post.</p>
<ol class="c15 lst-kix_9wupemaggod9-0 start" start="1">
<li>The <a href="https://docs.djangoproject.com/en/1.9/releases/1.9/">1.9 version</a> of the <a href="http://www.fullstackpython.com/django.html">Django web framework</a></li>
<li><a href="https://github.com/twilio/twilio-python">Twilio Python helper library</a> &gt;= version 5.0.0</li>
<li>A <a href="https://www.twilio.com/try-twilio">free Twilio account</a> and the <a href="https://www.twilio.com/docs/api/ip-messaging">Twilio IP Messaging public beta API</a></li>
<li><a href="https://developers.google.com/maps/">Google’s Maps API</a> for determining what city a user is located in</li>
</ol>
<p>Don’t worry about installing these tools just yet – we’ll handle that in the sections below as we go through this tutorial. If you want to see the completed code from this blog post at any time check out the <a href="https://github.com/makaimc/neighborhood-chat">GitHub repository with the finished project</a>. Before we start writing our code though let’s walk through preparing our Python environment for development.</p>
<h2 class="c1 c12"><a name="h.dmc547h4rd0m"/>Python Environment Setup</h2>
<p>Our prep work starts with getting our Python development environment ready to build our neighborhood-based chat application. In this section we’ll handle the following steps to make sure you’re ready to run the code:</p>
<ol class="c15 lst-kix_a7bo3no3ezmk-0 start" start="1">
<li>Check that Python is installed correctly</li>
<li>Set up and activate a new <a href="https://virtualenv.pypa.io/en/latest/">virtualenv</a></li>
<li>Install required Python dependencies into our virtualenv using <a href="https://pypi.python.org/pypi/pip">pip</a></li>
</ol>
<h3 class="c1 c12"><a name="h.q5t4lhzgy856"/>Setup Step 1: Check the Python installation</h3>
<p>If you’re on Mac OS X or Linux, you’ve already got Python installed on your system. Check the version by going into the terminal and typing <code>python —version</code>. You’ll see the precise version number, something like Python 2.7.6. If you’re on Python 2.6 or greater, you’re good to go.</p>
<p>For Windows, make sure you <a href="https://www.python.org/downloads/">download and install the Python .exe installation package</a>. Either Python 2 or 3 is fine. If you want further information about the 2 versus 3 version debate, there’s <a href="http://www.fullstackpython.com/python-2-or-3.html">plenty more information written</a> by experienced Python developers on the topic. My recommendation is to use Python 3.5 unless you have a pressing reason to use an earlier version, because the Python community is now migrating to Python 3.<br/>
Once Python is installed on your system and you can run it with the python command, we’re ready to set up a virtualenv.</p>
<h3 class="c1 c12"><a name="h.245cpwieclkk"/>Setup Step 2: Set up a new virtualenv and activate it</h3>
<p><a href="https://virtualenv.pypa.io/en/latest/">Virtualenv</a> is a dependency isolation library that makes it much easier to switch between Python versions and various code packages you’re using on different projects. Create a virtualenv in a location you’ll remember using the following command. In my case, I have a folder called <code>Envs</code> under my home directory that keeps my virtualenvs organized.</p>

		<div id="crayon-56d59bbe42253900070363" class="crayon-syntax crayon-theme-solarized-dark crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d59bbe42253900070363-1"><span class="crayon-v">virtualenv</span><span class="crayon-h"> </span><span class="crayon-o">~</span><span class="crayon-o">/</span><span class="crayon-v">Envs</span><span class="crayon-o">/</span><span class="crayon-e">citychat</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42253900070363-2"><span class="crayon-v">source</span><span class="crayon-h"> </span><span class="crayon-o">~</span><span class="crayon-o">/</span><span class="crayon-v">Envs</span><span class="crayon-o">/</span><span class="crayon-v">citychat</span><span class="crayon-o">/</span><span class="crayon-v">bin</span><span class="crayon-o">/</span><span class="crayon-v">activate</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>We have our virtualenv activated and we should see our command prompt show the name of our virtualenv, such as <code>(citychat)$</code>. With the virtualenv in place and activated, we can use pip to install our dependencies.</p>
<h3 class="c1 c12"><a name="h.z9p980d2anx6"/>Setup Step 3: Install dependencies with pip</h3>
<p><code>pip</code> handles Python library installations. With your virtualenv still activated, run the following command to install our Django and Twilio library dependencies.</p>

		<div id="crayon-56d59bbe4226f027117755" class="crayon-syntax crayon-theme-solarized-dark crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d59bbe4226f027117755-1"><span class="crayon-sy">(</span><span class="crayon-v">citychat</span><span class="crayon-sy">)</span><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">pip </span><span class="crayon-e">install </span><span class="crayon-v">django</span><span class="crayon-o">==</span><span class="crayon-cn">1.9</span> <span class="crayon-v">twilio</span><span class="crayon-o">==</span><span class="crayon-cn">5.0.0</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>You may be able to install the very latest versions of the Django and Twilio packages but it’s preferable to peg dependencies to specific version numbers just in case there are future backwards-incompatible modifications. With those libraries installed, we can start building our Django project that will run the chat application.</p>
<h2 class="c1 c12"><a name="h.46wkv2i0l2os"/>Starting Our Django Project</h2>
<p>We now have Django installed along with the <code>django-admin</code> command. <code>django-admin</code> helps get the boilerplate directories and code created for our project. Run the following two commands to start the project and change into the newly created directory.</p>

		<div id="crayon-56d59bbe4227f342865996" class="crayon-syntax crayon-theme-solarized-dark crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d59bbe4227f342865996-1"><span class="crayon-sy">(</span><span class="crayon-v">neighborchat</span><span class="crayon-sy">)</span><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-v">django</span><span class="crayon-o">-</span><span class="crayon-e">admin </span><span class="crayon-e">startproject </span><span class="crayon-e">citychat</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4227f342865996-2"><span class="crayon-sy">(</span><span class="crayon-v">neighborchat</span><span class="crayon-sy">)</span><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-r">cd</span><span class="crayon-h"> </span><span class="crayon-v">citychat</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>We also need to create an app within the project with the following command.</p>

		<div id="crayon-56d59bbe42290044563168" class="crayon-syntax crayon-theme-solarized-dark crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d59bbe42290044563168-1"><span class="crayon-sy">(</span><span class="crayon-v">neighborchat</span><span class="crayon-sy">)</span><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">python </span><span class="crayon-v">manage</span><span class="crayon-e">.py</span><span class="crayon-h"> </span><span class="crayon-e">startapp </span><span class="crayon-v">chat</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>Django’s just created a whole bunch of files for us. To make sure we’ve got the right set up, ensure the created folders look like the directory and subdirectories in the following image.</p>
<p><img class="&quot; aligncenter" title="" src="https://www.twilio.com/blog/wp-content/uploads/2015/12/TX-tsiPcHKe6nZbfb1rk6bini3riNqkZp5ORrT75mKSz-PLs2ZbcduDklYZetmr2JofMU89vKtd0v5439QdhYMrrFBZGQkZyhV8kfKm7UjQbRa9V4zMzS5NpDnL10tIueHfiLHrr.png" alt="citychat.png"/></p>
<p>We’ll also have <code>__init__.py</code>, <code>settings.py</code>, <code>urls.py</code> and <code>wsgi.py</code> files created for us in the <code>citychat/citychat</code> subdirectory. Our tutorial will modify most of these files along the way. If you’re unfamiliar with why Django created these folders and files be sure to go through the <a href="https://www.djangoproject.com/start/">Django quickstart</a> for more context.</p>
<p>We need to modify a few lines in <code>settings.py</code> and set up our environment variables to connect our Django project to our Twilio settings.</p>
<p>Add the following line to the <code>INSTALLED_APPS</code> list in <code>settings.py</code> to add the <code>chat</code> app to our Django project.</p>

		<div id="crayon-56d59bbe422a2575569640" class="crayon-syntax crayon-theme-solarized-dark crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d59bbe422a2575569640-1"><span class="crayon-v">INSTALLED_APPS</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe422a2575569640-2"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-s">'django.contrib.admin'</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d59bbe422a2575569640-3"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-s">'django.contrib.auth'</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe422a2575569640-4"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-s">'django.contrib.contenttypes'</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d59bbe422a2575569640-5"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-s">'django.contrib.sessions'</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe422a2575569640-6"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-s">'django.contrib.messages'</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d59bbe422a2575569640-7"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-s">'django.contrib.staticfiles'</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-marked-line crayon-top crayon-bottom crayon-striped-line" id="crayon-56d59bbe422a2575569640-8"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-s">'chat'</span></p><p class="crayon-line" id="crayon-56d59bbe422a2575569640-9"><span class="crayon-sy">]</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>Before you close <code>settings.py</code>, append the following lines to the file so we can establish the necessary Twilio IP Messaging settings we’ll use a bit later in the post.</p>

		<div id="crayon-56d59bbe422b5485378400" class="crayon-syntax crayon-theme-solarized-dark crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d59bbe422b5485378400-1"><span class="crayon-v">TWILIO_ACCOUNT_SID</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">os</span><span class="crayon-sy">.</span><span class="crayon-v">environ</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-s">'TWILIO_ACCOUNT_SID'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">None</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe422b5485378400-2"><span class="crayon-v">TWILIO_API_KEY</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">os</span><span class="crayon-sy">.</span><span class="crayon-v">environ</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-s">'TWILIO_API_KEY'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">None</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59bbe422b5485378400-3"><span class="crayon-v">TWILIO_API_SECRET</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">os</span><span class="crayon-sy">.</span><span class="crayon-v">environ</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-s">'TWILIO_API_SECRET'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">None</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe422b5485378400-4"><span class="crayon-v">TWILIO_IPM_SERVICE_SID</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">os</span><span class="crayon-sy">.</span><span class="crayon-v">environ</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-s">'TWILIO_IPM_SERVICE_SID'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">None</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>Next we need to set up our environment variables so the <code>os</code> module can get them when our Django project starts up. How to set environment variables depends on your operating system. Here are some handy guides if you’re on <a href="http://www.computerhope.com/issues/ch000549.htm">Windows</a>, <a href="http://stackoverflow.com/questions/135688/setting-environment-variables-in-os-x">Mac OS X</a> or <a href="https://help.ubuntu.com/community/EnvironmentVariables">Ubuntu Linux</a> that’ll help with the specific steps.</p>
<p>Five environment variables will need to be set:</p>
<ul>
<li>TWILIO_ACCOUNT_SID – found on your <a href="https://www.twilio.com/user/account">Twilio account dashboard</a></li>
<li>TWILIO_AUTH_TOKEN – also found on your Twilio account dashboard; not required by our Django app but will be used to create the IP Messaging Service SID later</li>
<li>TWILIO_API_KEY – an API key created specifically for this application</li>
<li>TWILIO_API_SECRET – a secret string just for this API key</li>
<li>TWILIO_IPM_SERVICE_SID – a unique identifier registered with Twilio for our IP Messaging application</li>
</ul>
<p>On Mac OS X and Linux, you can set environment variables with the export shell command. Typically, I store these environment variables in a <code>.env</code> file at the root directory of the project during development. We haven’t yet created the <code>TWILIO_API_KEY</code>, <code>TWILIO_API_SECRET</code> or <code>TWILIO_IPM_SERVICE_SID</code> credentials yet though, so let’s walk through how to create those now.<br/>
In order to get chat working we have to handle our remaining environment variables.</p>
<p>Let’s create and then set the TWILIO_API_KEY and TWILIO_API_SECRET now. Head into the Twilio portal and click on Dev Tools in the navigation bar.<br/>
<img class="&quot; aligncenter" title="" src="https://www.twilio.com/blog/wp-content/uploads/2015/12/AXL9KzOcAf3HVwDcK_4Y17150NNm_0zMAVOMjKNZjE27l4jhQG_PbPdo62rMk0ztN6AgUlCSNGmipl6_33BQZVI9gOUmqrtt58wi0lKyHbSWfBfeAQvqD3HyTDzx_TcKuL8KIeAK.png" alt="click-dev-tools.jpg"/><br/>
Click the Dev Tools link in the top navigation bar. We’re taken to the API Explorer but we want to go to the <a href="https://www.twilio.com/user/account/voice/dev-tools/api-keys">API Keys page</a>. Click the API Keys link in the secondary nav bar.</p>
<p><img class="&quot; aligncenter" title="" src="https://www.twilio.com/blog/wp-content/uploads/2015/12/Zgtbne9HaqTdXg7H7TOEUJiXIFNa-ITqL2NmIKMVPKhYRvLX-HqlGQOrNcaUHsczquSvhr14dagwVJw-pzt2LezhR3-znIzSBpyyTIdeLMVSP0rZTqct-mh1IiRi5ltRxp49VpCz.png" alt="api-key-nav.jpg"/></p>
<p>Click the “Create an API Key” button. We’re taken to the following page where we can given our new API key a friendly name. Call it “City Chat” and click the “Create API Key” button.</p>
<p><img class="&quot; aligncenter" title="" src="https://www.twilio.com/blog/wp-content/uploads/2015/12/goVyfbHDdbougK3rptW0TIb6SLUdE2A019AFmmS_5oQavIkAcld2V5GssQ5F0n4j79GjUx2XZbQFVKtfqITcy_dLRadbUBKcTd0u2JDpHvgeXwlnOeNwQQj9XTMt4mEO_29zYxzP.png" alt="new-api-key.jpg"/></p>
<p>After pressing the “Create API Key” button you’ll be taken to a page with the new Sid and Secret tokens are presented. Make sure to copy the Secret token as it will not be displayed again after you exit from this page.<br/>
<img class="&quot; aligncenter" title="" src="https://www.twilio.com/blog/wp-content/uploads/2015/12/oouEOemhlizOsR2kMY9hxCT3PbI-X6yoTMwqdcsVTeRPT2WMQtfsDOqXollxlAQhQISyj4NNO2e3GW7WpY1ujRvio_nTcf76j3VusRjb6g7_bmpPtReFDEKmCpxJ2CISqwSc8C_H.png" alt="save-api-key.png"/></p>
<p>There’s one more environment variable called <code>TWILIO_IPM_SERVICE_SID</code> that we’ll need to create via the command line before we have everything ready to modify our <code>.env</code> file.</p>
<p>There are two ways to create this IPM Service and grab the SID. One way is to go to <a href="https://www.twilio.com/user/account/ip-messaging/services">the IP Messaging Services page</a>, click the “<a href="https://www.twilio.com/user/account/ip-messaging/services/modals/create">Create an IP Messaging Service</a>” button, enter a friendly name and let Twilio produce the new service. The second way is to programmatically generate the service via an API call. Let’s use the second method and create the IPM Service from the command line using the following cURL command. The IPM Service we create will include a SID value we need to specify in our <code>TWILIO_IPM_SERVICE_SID</code> environment variable.</p>

		<div id="crayon-56d59bbe422cb237795304" class="crayon-syntax crayon-theme-solarized-dark crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d59bbe422cb237795304-1"><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-v">citychat</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-v">curl</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">XPOST </span><span class="crayon-v">https</span><span class="crayon-o">:</span><span class="crayon-o">/</span><span class="crayon-o">/</span><span class="crayon-v">ip</span><span class="crayon-o">-</span><span class="crayon-v">messaging</span><span class="crayon-e">.twilio</span><span class="crayon-e">.com</span><span class="crayon-o">/</span><span class="crayon-v">v1</span><span class="crayon-o">/</span><span class="crayon-v">Services</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">d</span><span class="crayon-h"> </span><span class="crayon-s">"FriendlyName=CityChat"</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">u</span><span class="crayon-h"> </span><span class="crayon-v">$TWILIO_ACCOUNT_SID</span><span class="crayon-o">:</span><span class="crayon-v">$TWILIO_AUTH_TOKEN</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>Make sure your $TWILIO_ACCOUNT_SID and $TWILIO_AUTH_TOKEN environment variables are still set if you receive an error. If not, your response should look something like the following JSON string.</p>

		<div id="crayon-56d59bbe422de227149470" class="crayon-syntax crayon-theme-solarized-dark crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d59bbe422de227149470-1"><span class="crayon-sy">{</span><span class="crayon-s">"sid"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"IS0beb86d261a0918jl123b00476d5e5e43"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe422de227149470-2"><span class="crayon-s">"account_sid"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"friendly_name"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"CityChat"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span></p><p class="crayon-line" id="crayon-56d59bbe422de227149470-3"><span class="crayon-s">"date_created"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"2015-11-25T06:19:17Z"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"date_updated"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"2015-11-25T06:19:17Z"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe422de227149470-4"><span class="crayon-s">"default_service_role_sid"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"RLffcd09f7df674bcd82cdcbbc4362e257"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span></p><p class="crayon-line" id="crayon-56d59bbe422de227149470-5"><span class="crayon-s">"default_channel_role_sid"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"RL2f13b41du1i2ohoi12412iu40a3d98"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe422de227149470-6"><span class="crayon-s">"default_channel_creator_role_sid"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"RL2f4b001l2k3jl21kj3lk12k123lfc1"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span></p><p class="crayon-line" id="crayon-56d59bbe422de227149470-7"><span class="crayon-s">"typing_indicator_timeout"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">5</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"webhooks"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span><span class="crayon-h"> </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe422de227149470-8"><span class="crayon-s">"url"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"https://ip-messaging.twilio.com/v1/Services/IS0beb86d261a0918jl123b00476d5e5e43"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span></p><p class="crayon-line" id="crayon-56d59bbe422de227149470-9"><span class="crayon-s">"links"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-s">"channels"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"https://ip-messaging.twilio.com/v1/Services/IS0beb86d261a0918jl123b00476d5e5e43/Channels"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe422de227149470-10"><span class="crayon-s">"roles"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"https://ip-messaging.twilio.com/v1/Services/IS0beb86d261a0918jl123b00476d5e5e43/Roles"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span></p><p class="crayon-line" id="crayon-56d59bbe422de227149470-11"><span class="crayon-s">"users"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"https://ip-messaging.twilio.com/v1/Services/IS0beb86d261a0918jl123b00476d5e5e43/Users"</span><span class="crayon-sy">}</span><span class="crayon-sy">}</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>We need the string that is the value to the “sid” key for our TWILIO_IPM_SERVICE_SID environment variable. With the final value created, we can set all of the environment variables for our application.</p>

		<div id="crayon-56d59bbe422f0386687251" class="crayon-syntax crayon-theme-solarized-dark crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d59bbe422f0386687251-1"><span class="crayon-e">export </span><span class="crayon-v">TWILIO_ACCOUNT_SID</span><span class="crayon-o">=</span><span class="crayon-s">'ACxxxxxxxxxxxxxxxxxxxxxx'</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe422f0386687251-2"><span class="crayon-e">export </span><span class="crayon-v">TWILIO_AUTH_TOKEN</span><span class="crayon-o">=</span><span class="crayon-s">'yyyyyyyyyyyyyyyyyyyy'</span></p><p class="crayon-line" id="crayon-56d59bbe422f0386687251-3"><span class="crayon-e">export </span><span class="crayon-v">TWILIO_API_KEY</span><span class="crayon-o">=</span><span class="crayon-s">'{ your new API key }'</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe422f0386687251-4"><span class="crayon-e">export </span><span class="crayon-v">TWILIO_API_SECRET</span><span class="crayon-o">=</span><span class="crayon-s">'{ your new API secret }'</span></p><p class="crayon-line" id="crayon-56d59bbe422f0386687251-5"><span class="crayon-e">export </span><span class="crayon-v">TWILIO_IPM_SERVICE_SID</span><span class="crayon-o">=</span><span class="crayon-s">'{ sid passed back from curl request }'</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>It’s time to test out our application to make sure our environment settings are in place and that we’re on a solid foundation to keep coding. From the root directory of our project where <code>manage.py</code> is located, run the Django development server.</p>

		<div id="crayon-56d59bbe422fb533680992" class="crayon-syntax crayon-theme-solarized-dark crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d59bbe422fb533680992-1"><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-v">neighborchat</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">python </span><span class="crayon-v">manage</span><span class="crayon-e">.py</span><span class="crayon-h"> </span><span class="crayon-v">runserver</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>With your favorite web browser go to <a href="http://127.0.0.1:8000">http://127.0.0.1:8000</a> and you should see the following default success page.<br/>
<img class="&quot; aligncenter" title="" src="https://www.twilio.com/blog/wp-content/uploads/2015/12/DGbtYjyucFRql0tniQSBD6Xp7sdVozilL-UeQNRLNqlMCMc2f8w4EqQoY1_1II5bCzlj-V3Co-vR7VE_C6IxfTwQsCJfQr-LR7Vr3jFrdIRm2S7JSeZseSuPutAbW6LupUGXq47C.png" alt="django-it-worked.jpg"/><br/>
Our basic application files and environment variables are set up. Now let’s build a web page with a map that’ll serve our chat application.</p>
<h2 class="c1 c12"><a name="h.gwdfua4ba06i"/>Mapping Our Location</h2>
<p>Now we can flesh out the code for our <code>chat</code> app within the <code>citychat</code> Django project. Start by updating the <code>chat/views.py</code> file with the following two highlighted lines. This function will look for the <code>chat.html</code> template and render the template after we create the file.</p>

		<div id="crayon-56d59bbe42306532222239" class="crayon-syntax crayon-theme-solarized-dark crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d59bbe42306532222239-1"><span class="crayon-e">from </span><span class="crayon-v">django</span><span class="crayon-sy">.</span><span class="crayon-e">shortcuts </span><span class="crayon-e">import </span><span class="crayon-e">render</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42306532222239-2"> </p><p class="crayon-line" id="crayon-56d59bbe42306532222239-3"> </p><p class="crayon-line crayon-marked-line crayon-top crayon-striped-line" id="crayon-56d59bbe42306532222239-4"><span class="crayon-e">def </span><span class="crayon-e">chat</span><span class="crayon-sy">(</span><span class="crayon-v">request</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-marked-line crayon-bottom" id="crayon-56d59bbe42306532222239-5"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">render</span><span class="crayon-sy">(</span><span class="crayon-v">request</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'chat.html'</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>Create a new file named <code>chat/urls.py</code> with the following code to route our application’s default endpoint to the <code>chat</code> view function we just wrote.</p>

		<div id="crayon-56d59bbe42313202636504" class="crayon-syntax crayon-theme-solarized-dark crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d59bbe42313202636504-1"><span class="crayon-e">from </span><span class="crayon-v">django</span><span class="crayon-sy">.</span><span class="crayon-v">conf</span><span class="crayon-sy">.</span><span class="crayon-e">urls </span><span class="crayon-e">import </span><span class="crayon-e">url</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42313202636504-2"><span class="crayon-i">from</span><span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-h"> </span><span class="crayon-e">import </span><span class="crayon-e">views</span></p><p class="crayon-line" id="crayon-56d59bbe42313202636504-3"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42313202636504-4"> </p><p class="crayon-line" id="crayon-56d59bbe42313202636504-5"><span class="crayon-v">urlpatterns</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42313202636504-6"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-e">url</span><span class="crayon-sy">(</span><span class="crayon-i">r</span><span class="crayon-s">'$'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">views</span><span class="crayon-sy">.</span><span class="crayon-v">chat</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-o">=</span><span class="crayon-s">"chat"</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d59bbe42313202636504-7"><span class="crayon-sy">]</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>The <code>urls.py</code> file maps routes for our application to views in the <code>views.py</code> file. In our case, there is a single url for the <code>chat</code> function that matches the root url for the server.</p>
<p>In order for the <code>chat/urls.py</code> to be found, we need to update the <code>citychat/citychat/urls.py</code> file, which handles url mappings for every app in a Django project. Update the following two lines so this <code>urls.py</code> file can match with the <code>chat/urls.py</code> routes.</p>

		<div id="crayon-56d59bbe42323872738930" class="crayon-syntax crayon-theme-solarized-dark crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d59bbe42323872738930-1"><span class="crayon-e">from </span><span class="crayon-v">django</span><span class="crayon-sy">.</span><span class="crayon-v">conf</span><span class="crayon-sy">.</span><span class="crayon-e">urls </span><span class="crayon-e">import </span><span class="crayon-e">url</span></p><p class="crayon-line crayon-marked-line crayon-top crayon-bottom crayon-striped-line" id="crayon-56d59bbe42323872738930-2"><span class="crayon-e">from </span><span class="crayon-v">django</span><span class="crayon-sy">.</span><span class="crayon-v">conf</span><span class="crayon-sy">.</span><span class="crayon-e">urls </span><span class="crayon-e">import </span><span class="crayon-e">include</span></p><p class="crayon-line" id="crayon-56d59bbe42323872738930-3"><span class="crayon-e">from </span><span class="crayon-v">django</span><span class="crayon-sy">.</span><span class="crayon-e">contrib </span><span class="crayon-e">import </span><span class="crayon-e">admin</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42323872738930-4"> </p><p class="crayon-line" id="crayon-56d59bbe42323872738930-5"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42323872738930-6"><span class="crayon-v">urlpatterns</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span></p><p class="crayon-line" id="crayon-56d59bbe42323872738930-7"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-e">url</span><span class="crayon-sy">(</span><span class="crayon-i">r</span><span class="crayon-s">'^admin/'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">admin</span><span class="crayon-sy">.</span><span class="crayon-v">site</span><span class="crayon-sy">.</span><span class="crayon-v">urls</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-marked-line crayon-top crayon-bottom crayon-striped-line" id="crayon-56d59bbe42323872738930-8"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-e">url</span><span class="crayon-sy">(</span><span class="crayon-i">r</span><span class="crayon-s">'^'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">include</span><span class="crayon-sy">(</span><span class="crayon-s">'chat.urls'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">namespace</span><span class="crayon-o">=</span><span class="crayon-s">'chat'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d59bbe42323872738930-9"><span class="crayon-sy">]</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>One more file needs to be created then we can give our application a quick test. Create a directory under <code>citychat/chat</code> named <code>templates</code>. Under <code>templates</code> create a file that matches up with the name of the Django template used in the <code>chat</code> function, which in our case is <code>chat.html</code>. Write or copy the following markup into the new <code>chat.html</code> file.</p>

		<div id="crayon-56d59bbe4232f197875871" class="crayon-syntax crayon-theme-solarized-dark crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-56d59bbe4232f197875871-1">1</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4232f197875871-2">2</p><p class="crayon-num" data-line="crayon-56d59bbe4232f197875871-3">3</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4232f197875871-4">4</p><p class="crayon-num" data-line="crayon-56d59bbe4232f197875871-5">5</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4232f197875871-6">6</p><p class="crayon-num" data-line="crayon-56d59bbe4232f197875871-7">7</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4232f197875871-8">8</p><p class="crayon-num" data-line="crayon-56d59bbe4232f197875871-9">9</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4232f197875871-10">10</p><p class="crayon-num" data-line="crayon-56d59bbe4232f197875871-11">11</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4232f197875871-12">12</p><p class="crayon-num" data-line="crayon-56d59bbe4232f197875871-13">13</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4232f197875871-14">14</p><p class="crayon-num" data-line="crayon-56d59bbe4232f197875871-15">15</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4232f197875871-16">16</p><p class="crayon-num" data-line="crayon-56d59bbe4232f197875871-17">17</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4232f197875871-18">18</p><p class="crayon-num" data-line="crayon-56d59bbe4232f197875871-19">19</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4232f197875871-20">20</p><p class="crayon-num" data-line="crayon-56d59bbe4232f197875871-21">21</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4232f197875871-22">22</p><p class="crayon-num" data-line="crayon-56d59bbe4232f197875871-23">23</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4232f197875871-24">24</p><p class="crayon-num" data-line="crayon-56d59bbe4232f197875871-25">25</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4232f197875871-26">26</p><p class="crayon-num" data-line="crayon-56d59bbe4232f197875871-27">27</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4232f197875871-28">28</p><p class="crayon-num" data-line="crayon-56d59bbe4232f197875871-29">29</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4232f197875871-30">30</p><p class="crayon-num" data-line="crayon-56d59bbe4232f197875871-31">31</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4232f197875871-32">32</p><p class="crayon-num" data-line="crayon-56d59bbe4232f197875871-33">33</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4232f197875871-34">34</p><p class="crayon-num" data-line="crayon-56d59bbe4232f197875871-35">35</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4232f197875871-36">36</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d59bbe4232f197875871-1"><span class="crayon-sy">{</span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">load </span><span class="crayon-v">staticfiles</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4232f197875871-2"><span class="crayon-o">&lt;</span><span class="crayon-o">!</span><span class="crayon-e">DOCTYPE </span><span class="crayon-v">html</span><span class="crayon-o">&gt;</span></p><p class="crayon-line" id="crayon-56d59bbe4232f197875871-3"><span class="crayon-o">&lt;</span><span class="crayon-e">html </span><span class="crayon-v">lang</span><span class="crayon-o">=</span><span class="crayon-s">"en"</span><span class="crayon-o">&gt;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4232f197875871-4"> <span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-v">head</span><span class="crayon-o">&gt;</span></p><p class="crayon-line" id="crayon-56d59bbe4232f197875871-5"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-e">meta </span><span class="crayon-v">charset</span><span class="crayon-o">=</span><span class="crayon-s">"utf-8"</span><span class="crayon-o">&gt;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4232f197875871-6"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-e">meta </span><span class="crayon-v">http</span><span class="crayon-o">-</span><span class="crayon-v">equiv</span><span class="crayon-o">=</span><span class="crayon-s">"X-UA-Compatible"</span><span class="crayon-h"> </span><span class="crayon-v">content</span><span class="crayon-o">=</span><span class="crayon-s">"IE=edge"</span><span class="crayon-o">&gt;</span></p><p class="crayon-line" id="crayon-56d59bbe4232f197875871-7"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-e">meta </span><span class="crayon-v">name</span><span class="crayon-o">=</span><span class="crayon-s">"viewport"</span><span class="crayon-h"> </span><span class="crayon-v">content</span><span class="crayon-o">=</span><span class="crayon-s">"width=device-width, initial-scale=1"</span><span class="crayon-o">&gt;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4232f197875871-8"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-v">title</span><span class="crayon-o">&gt;</span><span class="crayon-e">City </span><span class="crayon-v">Chat</span><span class="crayon-o">&lt;</span><span class="crayon-o">/</span><span class="crayon-v">title</span><span class="crayon-o">&gt;</span></p><p class="crayon-line" id="crayon-56d59bbe4232f197875871-9"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-e">link </span><span class="crayon-v">href</span><span class="crayon-o">=</span><span class="crayon-s">"//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"</span><span class="crayon-h"> </span><span class="crayon-v">rel</span><span class="crayon-o">=</span><span class="crayon-s">"stylesheet"</span><span class="crayon-o">&gt;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4232f197875871-10"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-ta">&lt;style&gt;</span></p><p class="crayon-line" id="crayon-56d59bbe4232f197875871-11"><span class="crayon-k ">      #map </span><span class="crayon-sy">{</span><span class="crayon-e ">width</span><span class="crayon-sy">:</span><span class="crayon-h"> </span><span class="crayon-i ">100%</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-e ">height</span><span class="crayon-sy">:</span><span class="crayon-h"> </span><span class="crayon-i ">400px</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-e ">background</span><span class="crayon-sy">:</span><span class="crayon-h"> </span><span class="crayon-i ">#eee</span><span class="crayon-sy">;</span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4232f197875871-12"><span class="crayon-i "> </span><span class="crayon-h"> </span><span class="crayon-i "> </span><span class="crayon-h"> </span><span class="crayon-ta">&lt;/style&gt;</span></p><p class="crayon-line" id="crayon-56d59bbe4232f197875871-13"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-ta">&lt;script </span><span class="crayon-e ">src</span><span class="crayon-o">=</span><span class="crayon-s">"//maps.googleapis.com/maps/api/js"</span><span class="crayon-o">&gt;</span><span class="crayon-ta">&lt;/script&gt;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4232f197875871-14"> <span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-o">/</span><span class="crayon-v">head</span><span class="crayon-o">&gt;</span></p><p class="crayon-line" id="crayon-56d59bbe4232f197875871-15"> <span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-v">body</span><span class="crayon-o">&gt;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4232f197875871-16"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-e">div </span><span class="crayon-t">class</span><span class="crayon-o">=</span><span class="crayon-s">"container"</span><span class="crayon-o">&gt;</span></p><p class="crayon-line" id="crayon-56d59bbe4232f197875871-17"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-v">h1</span><span class="crayon-o">&gt;</span><span class="crayon-e">City </span><span class="crayon-v">Chat</span><span class="crayon-o">&lt;</span><span class="crayon-o">/</span><span class="crayon-v">h1</span><span class="crayon-o">&gt;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4232f197875871-18"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-e">div </span><span class="crayon-v">id</span><span class="crayon-o">=</span><span class="crayon-s">"map"</span><span class="crayon-o">&gt;</span><span class="crayon-o">&lt;</span><span class="crayon-o">/</span><span class="crayon-v">div</span><span class="crayon-o">&gt;</span></p><p class="crayon-line" id="crayon-56d59bbe4232f197875871-19"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-v">p</span><span class="crayon-o">&gt;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4232f197875871-20"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-v">Latitude</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-e">input </span><span class="crayon-v">type</span><span class="crayon-o">=</span><span class="crayon-s">"text"</span><span class="crayon-h"> </span><span class="crayon-v">id</span><span class="crayon-o">=</span><span class="crayon-s">"lat"</span><span class="crayon-h"> </span><span class="crayon-v">readonly</span><span class="crayon-o">=</span><span class="crayon-t">true</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-o">&gt;</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d59bbe4232f197875871-21"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-v">Longitude</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-e">input </span><span class="crayon-v">type</span><span class="crayon-o">=</span><span class="crayon-s">"text"</span><span class="crayon-h"> </span><span class="crayon-v">id</span><span class="crayon-o">=</span><span class="crayon-s">"long"</span><span class="crayon-h"> </span><span class="crayon-v">readonly</span><span class="crayon-o">=</span><span class="crayon-t">true</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-o">&gt;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4232f197875871-22"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-o">/</span><span class="crayon-v">p</span><span class="crayon-o">&gt;</span></p><p class="crayon-line" id="crayon-56d59bbe4232f197875871-23"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-v">section</span><span class="crayon-o">&gt;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4232f197875871-24"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-e">div </span><span class="crayon-v">id</span><span class="crayon-o">=</span><span class="crayon-s">"messages"</span><span class="crayon-o">&gt;</span><span class="crayon-o">&lt;</span><span class="crayon-o">/</span><span class="crayon-v">div</span><span class="crayon-o">&gt;</span></p><p class="crayon-line" id="crayon-56d59bbe4232f197875871-25"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-e">input </span><span class="crayon-v">id</span><span class="crayon-o">=</span><span class="crayon-s">"chat-input"</span><span class="crayon-h"> </span><span class="crayon-v">type</span><span class="crayon-o">=</span><span class="crayon-s">"text"</span><span class="crayon-h"> </span><span class="crayon-v">placeholder</span><span class="crayon-o">=</span><span class="crayon-s">"say anything"</span><span class="crayon-h"> </span><span class="crayon-e">autofocus </span><span class="crayon-t">class</span><span class="crayon-o">=</span><span class="crayon-s">"form-control"</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-o">&gt;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4232f197875871-26"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-o">/</span><span class="crayon-e">section</span><span class="crayon-o">&gt;</span></p><p class="crayon-line" id="crayon-56d59bbe4232f197875871-27"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-o">/</span><span class="crayon-e">div</span><span class="crayon-o">&gt;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4232f197875871-28"> </p><p class="crayon-line" id="crayon-56d59bbe4232f197875871-29"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-ta">&lt;script </span><span class="crayon-e ">src</span><span class="crayon-o">=</span><span class="crayon-s">"//ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"</span><span class="crayon-o">&gt;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4232f197875871-30"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-ta">&lt;/script&gt;</span></p><p class="crayon-line" id="crayon-56d59bbe4232f197875871-31"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-ta">&lt;script </span><span class="crayon-e ">src</span><span class="crayon-o">=</span><span class="crayon-s">"//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"</span><span class="crayon-o">&gt;</span><span class="crayon-ta">&lt;/script&gt;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4232f197875871-32"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-ta">&lt;script </span><span class="crayon-e ">src</span><span class="crayon-o">=</span><span class="crayon-s">"//media.twiliocdn.com/sdk/rtc/js/ip-messaging/v0.8/twilio-ip-messaging.min.js"</span><span class="crayon-o">&gt;</span><span class="crayon-ta">&lt;/script&gt;</span></p><p class="crayon-line" id="crayon-56d59bbe4232f197875871-33"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-o">/</span><span class="crayon-e">script</span><span class="crayon-o">&gt;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4232f197875871-34"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-ta">&lt;script </span><span class="crayon-e ">src</span><span class="crayon-o">=</span><span class="crayon-s">"{% static 'js/chat.js' %}"</span><span class="crayon-o">&gt;</span><span class="crayon-ta">&lt;/script&gt;</span></p><p class="crayon-line" id="crayon-56d59bbe4232f197875871-35"> <span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-o">/</span><span class="crayon-v">body</span><span class="crayon-o">&gt;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4232f197875871-36"><span class="crayon-o">&lt;</span><span class="crayon-o">/</span><span class="crayon-v">html</span><span class="crayon-o">&gt;</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>In the above template, we’re setting the stage to display a map showing our current location with a chat box below the map.</p>
<p>There is a referenced JavaScript file, <code>chat.js</code>, that is not hosted externally so it doesn’t exist yet in our Django project. Since that file won’t load our page would look like the screenshot below if we accessed it now. If you pull up <a href="http://localhost:8000">http://localhost:8000</a> in Chrome you can see in the Chrome DevTools that a couple of files are not loading.<br/>
<img class="&quot; aligncenter" title="" src="https://www.twilio.com/blog/wp-content/uploads/2015/12/Jp2ssv5LiOSjkCvT5Cmc5njBBbUCy3DNzqcaUE65Sws4ywWa4wOX0ZD5E9iQrWf9uOAMOYBxNl7TJnpEj-_brAjOCPaNlPxMyQIR5Qas4V-SkaF2JXUufNWMr4newV37Y5IrcTOS.png" alt="city-chat-first-loaded.png"/></p>
<p>We need to fix that missing file to get our map displayed and determine the city in which we should be chatting.</p>
<p>Create a directory under <code>citychat/chat</code> named <code>static</code> that will hold our static files. Under <code>citychat/chat/static</code> create one more subdirectory named <code>js</code>. Create the file named <code>chat.js</code> under <code>citychat/chat/static/js</code> with the following code.</p>

		<div id="crayon-56d59bbe4233b372935169" class="crayon-syntax crayon-theme-solarized-dark crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d59bbe4233b372935169-1"><span class="crayon-t">function</span><span class="crayon-h"> </span><span class="crayon-e">positionFound</span><span class="crayon-sy">(</span><span class="crayon-v">position</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4233b372935169-2"> <span class="crayon-h"> </span><span class="crayon-v">document</span><span class="crayon-sy">.</span><span class="crayon-e">getElementById</span><span class="crayon-sy">(</span><span class="crayon-s">'lat'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-v">value</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">position</span><span class="crayon-sy">.</span><span class="crayon-v">coords</span><span class="crayon-sy">.</span><span class="crayon-v">latitude</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe4233b372935169-3"> <span class="crayon-h"> </span><span class="crayon-v">document</span><span class="crayon-sy">.</span><span class="crayon-e">getElementById</span><span class="crayon-sy">(</span><span class="crayon-s">'long'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-v">value</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">position</span><span class="crayon-sy">.</span><span class="crayon-v">coords</span><span class="crayon-sy">.</span><span class="crayon-v">longitude</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4233b372935169-4"><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-56d59bbe4233b372935169-5"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4233b372935169-6"><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">navigator</span><span class="crayon-sy">.</span><span class="crayon-v">geolocation</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-56d59bbe4233b372935169-7"> <span class="crayon-h"> </span><span class="crayon-v">navigator</span><span class="crayon-sy">.</span><span class="crayon-v">geolocation</span><span class="crayon-sy">.</span><span class="crayon-e">getCurrentPosition</span><span class="crayon-sy">(</span><span class="crayon-v">positionFound</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4233b372935169-8"><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-56d59bbe4233b372935169-9"> <span class="crayon-h"> </span><span class="crayon-e">alert</span><span class="crayon-sy">(</span><span class="crayon-s">'It appears that required geolocation is not enabled in your browser.'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4233b372935169-10"><span class="crayon-sy">}</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>Head back to your web browser and refresh <a href="http://localhost:8000/">http://localhost:8000/</a>. Make sure to click “Allow” or “Accept” when asked by the browser whether or not you want to share your current location. For example, in Chrome you’d click accept to the little dropdown from the URL bar.</p>
<p><img class="&quot; aligncenter" title="" src="https://www.twilio.com/blog/wp-content/uploads/2015/12/faNK2Sr7_IdsSZNAmdiTRh1NGHawg0F_JsHTYKRYCsBFlBy8oYqp2bO6b9Q-4cnfcH55zCpvIyU8a1dhMgd4d-lIOuwGGmiqbMpSYJTBGSl-z5x7fv1RYLcvymcaVBJkGg2wfvap.png" alt="click-allow.jpg"/></p>
<p>Okay, now we’ve got the user’s latitude and longitude displayed on the page! However, there’s still that ugly gray box taking up space where our map should be.<br/>
<img class="&quot; aligncenter" title="" src="https://www.twilio.com/blog/wp-content/uploads/2015/12/qstVM4Lho_DYJPArTdaFQR4PG9ch2RGbdd3KiJ9HV50aW5mBrWecT0wZoDoe9T1uT7ZuiCmZTB7JNrCgCMat9hAjt78MR8n6ltav5drZMjv7gRKSVERpygn1-RFA27C7LrB_s3cc.png" alt="lat-long-browser.png"/><br/>
Let’s initialize a map using the user’s location and translate the latitude and longitude into a marker on our page. Modify the <code>citychat/chat/static/js/chat.js</code> JavaScript file we were just working on that obtained the user’s browser location.</p>

		<div id="crayon-56d59bbe42346979960340" class="crayon-syntax crayon-theme-solarized-dark crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-56d59bbe42346979960340-1">1</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42346979960340-2">2</p><p class="crayon-num" data-line="crayon-56d59bbe42346979960340-3">3</p><p class="crayon-num crayon-marked-num crayon-top crayon-bottom crayon-striped-num" data-line="crayon-56d59bbe42346979960340-4">4</p><p class="crayon-num" data-line="crayon-56d59bbe42346979960340-5">5</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42346979960340-6">6</p><p class="crayon-num crayon-marked-num crayon-top" data-line="crayon-56d59bbe42346979960340-7">7</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42346979960340-8">8</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42346979960340-9">9</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42346979960340-10">10</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42346979960340-11">11</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42346979960340-12">12</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42346979960340-13">13</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42346979960340-14">14</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42346979960340-15">15</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42346979960340-16">16</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42346979960340-17">17</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42346979960340-18">18</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42346979960340-19">19</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42346979960340-20">20</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42346979960340-21">21</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42346979960340-22">22</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42346979960340-23">23</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42346979960340-24">24</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42346979960340-25">25</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42346979960340-26">26</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42346979960340-27">27</p><p class="crayon-num crayon-marked-num crayon-bottom crayon-striped-num" data-line="crayon-56d59bbe42346979960340-28">28</p><p class="crayon-num" data-line="crayon-56d59bbe42346979960340-29">29</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42346979960340-30">30</p><p class="crayon-num" data-line="crayon-56d59bbe42346979960340-31">31</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42346979960340-32">32</p><p class="crayon-num" data-line="crayon-56d59bbe42346979960340-33">33</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42346979960340-34">34</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d59bbe42346979960340-1"><span class="crayon-t">function</span><span class="crayon-h"> </span><span class="crayon-e">positionFound</span><span class="crayon-sy">(</span><span class="crayon-v">position</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42346979960340-2"><span class="crayon-h">  </span><span class="crayon-v">document</span><span class="crayon-sy">.</span><span class="crayon-e">getElementById</span><span class="crayon-sy">(</span><span class="crayon-s">'lat'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-v">value</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">position</span><span class="crayon-sy">.</span><span class="crayon-v">coords</span><span class="crayon-sy">.</span><span class="crayon-v">latitude</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe42346979960340-3"><span class="crayon-h">  </span><span class="crayon-v">document</span><span class="crayon-sy">.</span><span class="crayon-e">getElementById</span><span class="crayon-sy">(</span><span class="crayon-s">'long'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-v">value</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">position</span><span class="crayon-sy">.</span><span class="crayon-v">coords</span><span class="crayon-sy">.</span><span class="crayon-v">longitude</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line crayon-top crayon-bottom crayon-striped-line" id="crayon-56d59bbe42346979960340-4"><span class="crayon-h">  </span><span class="crayon-e">mapAndChat</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe42346979960340-5"><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42346979960340-6"> </p><p class="crayon-line crayon-marked-line crayon-top" id="crayon-56d59bbe42346979960340-7"><span class="crayon-c">// creates the map based on user's browser location </span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42346979960340-8"><span class="crayon-t">function</span><span class="crayon-h"> </span><span class="crayon-e">drawMap</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42346979960340-9"><span class="crayon-h">  </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">mapCanvas</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">document</span><span class="crayon-sy">.</span><span class="crayon-e">getElementById</span><span class="crayon-sy">(</span><span class="crayon-s">'map'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42346979960340-10"><span class="crayon-h">  </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">latLng</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-v">google</span><span class="crayon-sy">.</span><span class="crayon-v">maps</span><span class="crayon-sy">.</span><span class="crayon-e">LatLng</span><span class="crayon-sy">(</span><span class="crayon-v">document</span><span class="crayon-sy">.</span><span class="crayon-e">getElementById</span><span class="crayon-sy">(</span><span class="crayon-s">'lat'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-v">value</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">document</span><span class="crayon-sy">.</span><span class="crayon-e">getElementById</span><span class="crayon-sy">(</span><span class="crayon-s">'long'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-v">value</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42346979960340-11"> </p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42346979960340-12"><span class="crayon-h">  </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">mapOptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42346979960340-13"><span class="crayon-h">    </span><span class="crayon-v">center</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">latLng</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42346979960340-14"><span class="crayon-h">    </span><span class="crayon-v">zoom</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">12</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42346979960340-15"><span class="crayon-h">    </span><span class="crayon-v">mapTypeId</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">google</span><span class="crayon-sy">.</span><span class="crayon-v">maps</span><span class="crayon-sy">.</span><span class="crayon-v">MapTypeId</span><span class="crayon-sy">.</span><span class="crayon-i">ROADMAP</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42346979960340-16"><span class="crayon-h">  </span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42346979960340-17"><span class="crayon-h">  </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">map</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-v">google</span><span class="crayon-sy">.</span><span class="crayon-v">maps</span><span class="crayon-sy">.</span><span class="crayon-e">Map</span><span class="crayon-sy">(</span><span class="crayon-v">mapCanvas</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">mapOptions</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42346979960340-18"><span class="crayon-h">  </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">marker</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-v">google</span><span class="crayon-sy">.</span><span class="crayon-v">maps</span><span class="crayon-sy">.</span><span class="crayon-e">Marker</span><span class="crayon-sy">(</span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42346979960340-19"><span class="crayon-h">    </span><span class="crayon-v">position</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">latLng</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42346979960340-20"><span class="crayon-h">    </span><span class="crayon-v">map</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">map</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42346979960340-21"><span class="crayon-h">    </span><span class="crayon-v">title</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">'Your location'</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42346979960340-22"><span class="crayon-h">  </span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42346979960340-23"><span class="crayon-sy">}</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42346979960340-24"> </p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42346979960340-25"><span class="crayon-t">function</span><span class="crayon-h"> </span><span class="crayon-e">mapAndChat</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42346979960340-26"><span class="crayon-h">  </span><span class="crayon-e">drawMap</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42346979960340-27"><span class="crayon-h">  </span><span class="crayon-c">// chat initialization will go here</span></p><p class="crayon-line crayon-marked-line crayon-bottom crayon-striped-line" id="crayon-56d59bbe42346979960340-28"><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-56d59bbe42346979960340-29"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42346979960340-30"><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">navigator</span><span class="crayon-sy">.</span><span class="crayon-v">geolocation</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-56d59bbe42346979960340-31"><span class="crayon-h">  </span><span class="crayon-v">navigator</span><span class="crayon-sy">.</span><span class="crayon-v">geolocation</span><span class="crayon-sy">.</span><span class="crayon-e">getCurrentPosition</span><span class="crayon-sy">(</span><span class="crayon-v">positionFound</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42346979960340-32"><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-56d59bbe42346979960340-33"><span class="crayon-h">  </span><span class="crayon-e">alert</span><span class="crayon-sy">(</span><span class="crayon-s">'It appears that required browser geolocation is not enabled.'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42346979960340-34"><span class="crayon-sy">}</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p><img class="&quot; aligncenter" title="" src="https://www.twilio.com/blog/wp-content/uploads/2015/12/Uj5ygxVXxKVwDGNdLIDdprNWN0KJj719HV4-FL32qIkAAJEAVgJk_zdCjobyvdZYHCGrPuT3cuoTF8hAVt82eFTeRazZpB_jPpQNIt9u8cDy8VZ3op36MZ_C7ffk_Qn99ccYJN6u.png" alt="city-chat-second-loaded.jpg"/></p>
<p>Hey now, that looks a little bit better! Unfortunately, chat is still not yet working.</p>
<h2 class="c1 c12"><a name="h.lc6ef9mbpob4"/>Adding Chat via IP Messaging</h2>
<p>Our embedded map may look slick but chat has yet to land in our app. Earlier in this post we set all the environment variables we need to hook Twilio IP Messaging into our application. With those credentials in place we can now create JSON Web Tokens (JWT) on the server that will be requested by the browser and sent as soon as they are generated. Our application will need a new endpoint though for the browser to request the token by so open up <code>citychat/chat/urls.py</code> and add the single line highlighted below.</p>

		<div id="crayon-56d59bbe42351161901579" class="crayon-syntax crayon-theme-solarized-dark crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d59bbe42351161901579-1"><span class="crayon-e">from </span><span class="crayon-v">django</span><span class="crayon-sy">.</span><span class="crayon-v">conf</span><span class="crayon-sy">.</span><span class="crayon-e">urls </span><span class="crayon-e">import </span><span class="crayon-e">url</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42351161901579-2"><span class="crayon-i">from</span><span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-h"> </span><span class="crayon-e">import </span><span class="crayon-e">views</span></p><p class="crayon-line" id="crayon-56d59bbe42351161901579-3"> </p><p class="crayon-line crayon-marked-line crayon-top crayon-bottom crayon-striped-line" id="crayon-56d59bbe42351161901579-4"><span class="crayon-v">urlpatterns</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span></p><p class="crayon-line" id="crayon-56d59bbe42351161901579-5"> <span class="crayon-h"> </span>  <span class="crayon-e">url</span><span class="crayon-sy">(</span><span class="crayon-i">r</span><span class="crayon-s">'token$'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">views</span><span class="crayon-sy">.</span><span class="crayon-v">token</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-o">=</span><span class="crayon-s">"token"</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42351161901579-6"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-e">url</span><span class="crayon-sy">(</span><span class="crayon-i">r</span><span class="crayon-s">'$'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">views</span><span class="crayon-sy">.</span><span class="crayon-v">chat</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-o">=</span><span class="crayon-s">"chat"</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d59bbe42351161901579-7"><span class="crayon-sy">]</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>The new line added to <code>urls.py</code> creates a <code>/token</code> endpoint for our application and references a <code>views.token</code> function. We need to write that <code>token</code> function in the <code>citychat/chat/views.py</code> file as highlighted below.</p>

		<div id="crayon-56d59bbe4235b676490375" class="crayon-syntax crayon-theme-solarized-dark crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num crayon-marked-num crayon-top" data-line="crayon-56d59bbe4235b676490375-1">1</p><p class="crayon-num crayon-marked-num crayon-bottom crayon-striped-num" data-line="crayon-56d59bbe4235b676490375-2">2</p><p class="crayon-num" data-line="crayon-56d59bbe4235b676490375-3">3</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4235b676490375-4">4</p><p class="crayon-num crayon-marked-num crayon-top crayon-bottom" data-line="crayon-56d59bbe4235b676490375-5">5</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4235b676490375-6">6</p><p class="crayon-num" data-line="crayon-56d59bbe4235b676490375-7">7</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4235b676490375-8">8</p><p class="crayon-num" data-line="crayon-56d59bbe4235b676490375-9">9</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4235b676490375-10">10</p><p class="crayon-num" data-line="crayon-56d59bbe4235b676490375-11">11</p><p class="crayon-num crayon-marked-num crayon-top crayon-striped-num" data-line="crayon-56d59bbe4235b676490375-12">12</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe4235b676490375-13">13</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe4235b676490375-14">14</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe4235b676490375-15">15</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe4235b676490375-16">16</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe4235b676490375-17">17</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe4235b676490375-18">18</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe4235b676490375-19">19</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe4235b676490375-20">20</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe4235b676490375-21">21</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe4235b676490375-22">22</p><p class="crayon-num crayon-marked-num crayon-bottom" data-line="crayon-56d59bbe4235b676490375-23">23</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line crayon-marked-line crayon-top" id="crayon-56d59bbe4235b676490375-1"><span class="crayon-e">from </span><span class="crayon-v">django</span><span class="crayon-sy">.</span><span class="crayon-e">conf </span><span class="crayon-e">import </span><span class="crayon-e">settings</span></p><p class="crayon-line crayon-marked-line crayon-bottom crayon-striped-line" id="crayon-56d59bbe4235b676490375-2"><span class="crayon-e">from </span><span class="crayon-v">django</span><span class="crayon-sy">.</span><span class="crayon-e">http </span><span class="crayon-e">import </span><span class="crayon-e">JsonResponse</span></p><p class="crayon-line" id="crayon-56d59bbe4235b676490375-3"><span class="crayon-e">from </span><span class="crayon-v">django</span><span class="crayon-sy">.</span><span class="crayon-e">shortcuts </span><span class="crayon-e">import </span><span class="crayon-e">render</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4235b676490375-4"> </p><p class="crayon-line crayon-marked-line crayon-top crayon-bottom" id="crayon-56d59bbe4235b676490375-5"><span class="crayon-e">from </span><span class="crayon-v">twilio</span><span class="crayon-sy">.</span><span class="crayon-e">access_token </span><span class="crayon-e">import </span><span class="crayon-v">AccessToken</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">IpMessagingGrant</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4235b676490375-6"> </p><p class="crayon-line" id="crayon-56d59bbe4235b676490375-7"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4235b676490375-8"><span class="crayon-e">def </span><span class="crayon-e">chat</span><span class="crayon-sy">(</span><span class="crayon-v">request</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d59bbe4235b676490375-9"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">render</span><span class="crayon-sy">(</span><span class="crayon-v">request</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'chat.html'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4235b676490375-10"> </p><p class="crayon-line" id="crayon-56d59bbe4235b676490375-11"> </p><p class="crayon-line crayon-marked-line crayon-top crayon-striped-line" id="crayon-56d59bbe4235b676490375-12"><span class="crayon-e">def </span><span class="crayon-e">token</span><span class="crayon-sy">(</span><span class="crayon-v">request</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe4235b676490375-13"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-v">device_id</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">request</span><span class="crayon-sy">.</span><span class="crayon-v">GET</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-s">'device'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'unknown'</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe4235b676490375-14"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-v">identity</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">request</span><span class="crayon-sy">.</span><span class="crayon-v">GET</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-s">'identity'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'guest'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">encode</span><span class="crayon-sy">(</span><span class="crayon-s">'utf-8'</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe4235b676490375-15"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-v">endpoint_id</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"NeighborChat:{0}:{1}"</span><span class="crayon-sy">.</span><span class="crayon-e">format</span><span class="crayon-sy">(</span><span class="crayon-v">device_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">identity</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe4235b676490375-16"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-v">token</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">AccessToken</span><span class="crayon-sy">(</span><span class="crayon-v">settings</span><span class="crayon-sy">.</span><span class="crayon-v">TWILIO_ACCOUNT_SID</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">settings</span><span class="crayon-sy">.</span><span class="crayon-v">TWILIO_API_KEY</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe4235b676490375-17"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-v">settings</span><span class="crayon-sy">.</span><span class="crayon-v">TWILIO_API_SECRET</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">identity</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe4235b676490375-18"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-v">grant</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">IpMessagingGrant</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe4235b676490375-19"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-v">grant</span><span class="crayon-sy">.</span><span class="crayon-v">service_sid</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">settings</span><span class="crayon-sy">.</span><span class="crayon-v">TWILIO_IPM_SERVICE</span><span class="crayon-sy">_</span>SID</p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe4235b676490375-20"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-v">grant</span><span class="crayon-sy">.</span><span class="crayon-v">endpoint_id</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">endpoint</span><span class="crayon-sy">_</span>id</p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe4235b676490375-21"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-v">token</span><span class="crayon-sy">.</span><span class="crayon-e">add_grant</span><span class="crayon-sy">(</span><span class="crayon-v">grant</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe4235b676490375-22"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-v">response</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-s">'identity'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">identity</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'token'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">token</span><span class="crayon-sy">.</span><span class="crayon-e">to_jwt</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-marked-line crayon-bottom" id="crayon-56d59bbe4235b676490375-23"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">JsonResponse</span><span class="crayon-sy">(</span><span class="crayon-v">response</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>In the above code, we include a few new imports for our project’s settings and the <code>JsonResponse</code> from the Django library. The <code>AccessToken</code> and <code>IpMesssagingGrant</code> are specific to Twilio IP Messaging. They allow us to create the appropriate JWT token to return to the requesting client based on our Twilio account credentials stored in our environment variables.</p>
<p>What about the front end browser code that calls for the access token? We need to take care of that now by modifying <code>citychat/chat/static/js/chat.js</code> with the following highlighted lines. These two functions, <code>print</code> and <code>printMessage</code> are just to help us attach the information messages and chat messages that need to be displayed on the page.</p>

		<div id="crayon-56d59bbe42366608030509" class="crayon-syntax crayon-theme-solarized-dark crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num crayon-marked-num crayon-top" data-line="crayon-56d59bbe42366608030509-1">1</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42366608030509-2">2</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42366608030509-3">3</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42366608030509-4">4</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42366608030509-5">5</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42366608030509-6">6</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42366608030509-7">7</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42366608030509-8">8</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42366608030509-9">9</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42366608030509-10">10</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42366608030509-11">11</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42366608030509-12">12</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42366608030509-13">13</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42366608030509-14">14</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42366608030509-15">15</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42366608030509-16">16</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42366608030509-17">17</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42366608030509-18">18</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42366608030509-19">19</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42366608030509-20">20</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42366608030509-21">21</p><p class="crayon-num crayon-marked-num crayon-bottom crayon-striped-num" data-line="crayon-56d59bbe42366608030509-22">22</p><p class="crayon-num" data-line="crayon-56d59bbe42366608030509-23">23</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42366608030509-24">24</p><p class="crayon-num" data-line="crayon-56d59bbe42366608030509-25">25</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42366608030509-26">26</p><p class="crayon-num" data-line="crayon-56d59bbe42366608030509-27">27</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42366608030509-28">28</p><p class="crayon-num" data-line="crayon-56d59bbe42366608030509-29">29</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42366608030509-30">30</p><p class="crayon-num" data-line="crayon-56d59bbe42366608030509-31">31</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42366608030509-32">32</p><p class="crayon-num" data-line="crayon-56d59bbe42366608030509-33">33</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42366608030509-34">34</p><p class="crayon-num" data-line="crayon-56d59bbe42366608030509-35">35</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42366608030509-36">36</p><p class="crayon-num" data-line="crayon-56d59bbe42366608030509-37">37</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42366608030509-38">38</p><p class="crayon-num" data-line="crayon-56d59bbe42366608030509-39">39</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42366608030509-40">40</p><p class="crayon-num" data-line="crayon-56d59bbe42366608030509-41">41</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42366608030509-42">42</p><p class="crayon-num" data-line="crayon-56d59bbe42366608030509-43">43</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42366608030509-44">44</p><p class="crayon-num" data-line="crayon-56d59bbe42366608030509-45">45</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42366608030509-46">46</p><p class="crayon-num" data-line="crayon-56d59bbe42366608030509-47">47</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42366608030509-48">48</p><p class="crayon-num" data-line="crayon-56d59bbe42366608030509-49">49</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42366608030509-50">50</p><p class="crayon-num" data-line="crayon-56d59bbe42366608030509-51">51</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42366608030509-52">52</p><p class="crayon-num" data-line="crayon-56d59bbe42366608030509-53">53</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42366608030509-54">54</p><p class="crayon-num" data-line="crayon-56d59bbe42366608030509-55">55</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42366608030509-56">56</p><p class="crayon-num" data-line="crayon-56d59bbe42366608030509-57">57</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line crayon-marked-line crayon-top" id="crayon-56d59bbe42366608030509-1"><span class="crayon-c">// Helper function to print info messages to the chat window</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42366608030509-2"><span class="crayon-t">function</span><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">infoMessage</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">asHtml</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42366608030509-3"><span class="crayon-h">    </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">msg</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-s">'&lt;div class="info"&gt;'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42366608030509-4"><span class="crayon-h">    </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">asHtml</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42366608030509-5"><span class="crayon-h">        </span><span class="crayon-sy">$</span><span class="crayon-v">msg</span><span class="crayon-sy">.</span><span class="crayon-e">html</span><span class="crayon-sy">(</span><span class="crayon-v">infoMessage</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42366608030509-6"><span class="crayon-h">    </span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42366608030509-7"><span class="crayon-h">        </span><span class="crayon-sy">$</span><span class="crayon-v">msg</span><span class="crayon-sy">.</span><span class="crayon-e">text</span><span class="crayon-sy">(</span><span class="crayon-v">infoMessage</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42366608030509-8"><span class="crayon-h">    </span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42366608030509-9"><span class="crayon-h">    </span><span class="crayon-sy">$</span><span class="crayon-v">chatWindow</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">msg</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42366608030509-10"><span class="crayon-sy">}</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42366608030509-11"> </p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42366608030509-12"><span class="crayon-c">// Helper function to print chat message to the chat window</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42366608030509-13"><span class="crayon-t">function</span><span class="crayon-h"> </span><span class="crayon-e">printMessage</span><span class="crayon-sy">(</span><span class="crayon-v">fromUser</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">message</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42366608030509-14"><span class="crayon-h">    </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">user</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-s">'&lt;span class="username"&gt;'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">text</span><span class="crayon-sy">(</span><span class="crayon-v">fromUser</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">': '</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42366608030509-15"><span class="crayon-h">    </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">fromUser</span><span class="crayon-h"> </span><span class="crayon-o">===</span><span class="crayon-h"> </span><span class="crayon-v">username</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42366608030509-16"><span class="crayon-h">        </span><span class="crayon-sy">$</span><span class="crayon-v">user</span><span class="crayon-sy">.</span><span class="crayon-e">addClass</span><span class="crayon-sy">(</span><span class="crayon-s">'me'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42366608030509-17"><span class="crayon-h">    </span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42366608030509-18"><span class="crayon-h">    </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">message</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-s">'&lt;span class="message"&gt;'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">text</span><span class="crayon-sy">(</span><span class="crayon-v">message</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42366608030509-19"><span class="crayon-h">    </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">container</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-s">'&lt;div class="message-container"&gt;'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42366608030509-20"><span class="crayon-h">    </span><span class="crayon-sy">$</span><span class="crayon-v">container</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">user</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">message</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42366608030509-21"><span class="crayon-h">    </span><span class="crayon-sy">$</span><span class="crayon-v">chatWindow</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">container</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line crayon-bottom crayon-striped-line" id="crayon-56d59bbe42366608030509-22"><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-56d59bbe42366608030509-23"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42366608030509-24"><span class="crayon-t">function</span><span class="crayon-h"> </span><span class="crayon-e">positionFound</span><span class="crayon-sy">(</span><span class="crayon-v">position</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-56d59bbe42366608030509-25"><span class="crayon-h">  </span><span class="crayon-v">document</span><span class="crayon-sy">.</span><span class="crayon-e">getElementById</span><span class="crayon-sy">(</span><span class="crayon-s">'lat'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-v">value</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">position</span><span class="crayon-sy">.</span><span class="crayon-v">coords</span><span class="crayon-sy">.</span><span class="crayon-v">latitude</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42366608030509-26"><span class="crayon-h">  </span><span class="crayon-v">document</span><span class="crayon-sy">.</span><span class="crayon-e">getElementById</span><span class="crayon-sy">(</span><span class="crayon-s">'long'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-v">value</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">position</span><span class="crayon-sy">.</span><span class="crayon-v">coords</span><span class="crayon-sy">.</span><span class="crayon-v">longitude</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe42366608030509-27"><span class="crayon-h">  </span><span class="crayon-e">mapAndChat</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42366608030509-28"><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-56d59bbe42366608030509-29"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42366608030509-30"><span class="crayon-c">// creates the map based on user's browser location </span></p><p class="crayon-line" id="crayon-56d59bbe42366608030509-31"><span class="crayon-t">function</span><span class="crayon-h"> </span><span class="crayon-e">drawMap</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42366608030509-32"><span class="crayon-h">  </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">mapCanvas</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">document</span><span class="crayon-sy">.</span><span class="crayon-e">getElementById</span><span class="crayon-sy">(</span><span class="crayon-s">'map'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe42366608030509-33"><span class="crayon-h">  </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">latLng</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-v">google</span><span class="crayon-sy">.</span><span class="crayon-v">maps</span><span class="crayon-sy">.</span><span class="crayon-e">LatLng</span><span class="crayon-sy">(</span><span class="crayon-v">document</span><span class="crayon-sy">.</span><span class="crayon-e">getElementById</span><span class="crayon-sy">(</span><span class="crayon-s">'lat'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-v">value</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">document</span><span class="crayon-sy">.</span><span class="crayon-e">getElementById</span><span class="crayon-sy">(</span><span class="crayon-s">'long'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-v">value</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42366608030509-34"> </p><p class="crayon-line" id="crayon-56d59bbe42366608030509-35"><span class="crayon-h">  </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">mapOptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42366608030509-36"><span class="crayon-h">    </span><span class="crayon-v">center</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">latLng</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d59bbe42366608030509-37"><span class="crayon-h">    </span><span class="crayon-v">zoom</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">12</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42366608030509-38"><span class="crayon-h">    </span><span class="crayon-v">mapTypeId</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">google</span><span class="crayon-sy">.</span><span class="crayon-v">maps</span><span class="crayon-sy">.</span><span class="crayon-v">MapTypeId</span><span class="crayon-sy">.</span><span class="crayon-i">ROADMAP</span></p><p class="crayon-line" id="crayon-56d59bbe42366608030509-39"><span class="crayon-h">  </span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42366608030509-40"><span class="crayon-h">  </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">map</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-v">google</span><span class="crayon-sy">.</span><span class="crayon-v">maps</span><span class="crayon-sy">.</span><span class="crayon-e">Map</span><span class="crayon-sy">(</span><span class="crayon-v">mapCanvas</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">mapOptions</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe42366608030509-41"><span class="crayon-h">  </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">marker</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-v">google</span><span class="crayon-sy">.</span><span class="crayon-v">maps</span><span class="crayon-sy">.</span><span class="crayon-e">Marker</span><span class="crayon-sy">(</span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42366608030509-42"><span class="crayon-h">    </span><span class="crayon-v">position</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">latLng</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d59bbe42366608030509-43"><span class="crayon-h">    </span><span class="crayon-v">map</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">map</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42366608030509-44"><span class="crayon-h">    </span><span class="crayon-v">title</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">'Your location'</span></p><p class="crayon-line" id="crayon-56d59bbe42366608030509-45"><span class="crayon-h">  </span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42366608030509-46"><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-56d59bbe42366608030509-47"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42366608030509-48"><span class="crayon-t">function</span><span class="crayon-h"> </span><span class="crayon-e">mapAndChat</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-56d59bbe42366608030509-49"><span class="crayon-h">  </span><span class="crayon-e">drawMap</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42366608030509-50"><span class="crayon-h">  </span><span class="crayon-c">// chat initialization will go here</span></p><p class="crayon-line" id="crayon-56d59bbe42366608030509-51"><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42366608030509-52"> </p><p class="crayon-line" id="crayon-56d59bbe42366608030509-53"><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">navigator</span><span class="crayon-sy">.</span><span class="crayon-v">geolocation</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42366608030509-54"><span class="crayon-h">  </span><span class="crayon-v">navigator</span><span class="crayon-sy">.</span><span class="crayon-v">geolocation</span><span class="crayon-sy">.</span><span class="crayon-e">getCurrentPosition</span><span class="crayon-sy">(</span><span class="crayon-v">positionFound</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe42366608030509-55"><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42366608030509-56"><span class="crayon-h">  </span><span class="crayon-e">alert</span><span class="crayon-sy">(</span><span class="crayon-s">'It appears that required browser geolocation is not enabled.'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe42366608030509-57"><span class="crayon-sy">}</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>With our helper printing functions in place, let’s begin adding the JavaScript chat code that connects our application with the IP Messaging service. Begin by adding several variables to store a reference to the chat window, the Twilio IP Messaging service, the messaging channel for our city, the user’s location and the name of the city based on the latitude and longitude from the user’s browser.</p>
<p>Make these changes by continuing to add the following highlighted lines of JavaScript to <code>citychat/chat/static/js/chat.js</code>.</p>

		<div id="crayon-56d59bbe42372261293394" class="crayon-syntax crayon-theme-solarized-dark crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num crayon-marked-num crayon-top" data-line="crayon-56d59bbe42372261293394-1">1</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-2">2</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42372261293394-3">3</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-4">4</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42372261293394-5">5</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-6">6</p><p class="crayon-num crayon-marked-num crayon-bottom" data-line="crayon-56d59bbe42372261293394-7">7</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-8">8</p><p class="crayon-num" data-line="crayon-56d59bbe42372261293394-9">9</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-10">10</p><p class="crayon-num" data-line="crayon-56d59bbe42372261293394-11">11</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-12">12</p><p class="crayon-num" data-line="crayon-56d59bbe42372261293394-13">13</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-14">14</p><p class="crayon-num" data-line="crayon-56d59bbe42372261293394-15">15</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-16">16</p><p class="crayon-num" data-line="crayon-56d59bbe42372261293394-17">17</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-18">18</p><p class="crayon-num" data-line="crayon-56d59bbe42372261293394-19">19</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-20">20</p><p class="crayon-num" data-line="crayon-56d59bbe42372261293394-21">21</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-22">22</p><p class="crayon-num" data-line="crayon-56d59bbe42372261293394-23">23</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-24">24</p><p class="crayon-num" data-line="crayon-56d59bbe42372261293394-25">25</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-26">26</p><p class="crayon-num" data-line="crayon-56d59bbe42372261293394-27">27</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-28">28</p><p class="crayon-num" data-line="crayon-56d59bbe42372261293394-29">29</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-30">30</p><p class="crayon-num" data-line="crayon-56d59bbe42372261293394-31">31</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-32">32</p><p class="crayon-num" data-line="crayon-56d59bbe42372261293394-33">33</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-34">34</p><p class="crayon-num" data-line="crayon-56d59bbe42372261293394-35">35</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-36">36</p><p class="crayon-num" data-line="crayon-56d59bbe42372261293394-37">37</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-38">38</p><p class="crayon-num" data-line="crayon-56d59bbe42372261293394-39">39</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-40">40</p><p class="crayon-num" data-line="crayon-56d59bbe42372261293394-41">41</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-42">42</p><p class="crayon-num" data-line="crayon-56d59bbe42372261293394-43">43</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-44">44</p><p class="crayon-num" data-line="crayon-56d59bbe42372261293394-45">45</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-46">46</p><p class="crayon-num" data-line="crayon-56d59bbe42372261293394-47">47</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-48">48</p><p class="crayon-num" data-line="crayon-56d59bbe42372261293394-49">49</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-50">50</p><p class="crayon-num" data-line="crayon-56d59bbe42372261293394-51">51</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-52">52</p><p class="crayon-num" data-line="crayon-56d59bbe42372261293394-53">53</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-54">54</p><p class="crayon-num" data-line="crayon-56d59bbe42372261293394-55">55</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-56">56</p><p class="crayon-num" data-line="crayon-56d59bbe42372261293394-57">57</p><p class="crayon-num crayon-marked-num crayon-top crayon-bottom crayon-striped-num" data-line="crayon-56d59bbe42372261293394-58">58</p><p class="crayon-num" data-line="crayon-56d59bbe42372261293394-59">59</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-60">60</p><p class="crayon-num crayon-marked-num crayon-top" data-line="crayon-56d59bbe42372261293394-61">61</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-62">62</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42372261293394-63">63</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-64">64</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42372261293394-65">65</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-66">66</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42372261293394-67">67</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-68">68</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42372261293394-69">69</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-70">70</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42372261293394-71">71</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-72">72</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42372261293394-73">73</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-74">74</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42372261293394-75">75</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-76">76</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42372261293394-77">77</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-78">78</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42372261293394-79">79</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-80">80</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42372261293394-81">81</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-82">82</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42372261293394-83">83</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-84">84</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42372261293394-85">85</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-86">86</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42372261293394-87">87</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-88">88</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42372261293394-89">89</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-90">90</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42372261293394-91">91</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-92">92</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42372261293394-93">93</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-94">94</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42372261293394-95">95</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-96">96</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42372261293394-97">97</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-98">98</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe42372261293394-99">99</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-100">100</p><p class="crayon-num crayon-marked-num crayon-bottom" data-line="crayon-56d59bbe42372261293394-101">101</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-102">102</p><p class="crayon-num" data-line="crayon-56d59bbe42372261293394-103">103</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-104">104</p><p class="crayon-num" data-line="crayon-56d59bbe42372261293394-105">105</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe42372261293394-106">106</p><p class="crayon-num" data-line="crayon-56d59bbe42372261293394-107">107</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line crayon-marked-line crayon-top" id="crayon-56d59bbe42372261293394-1"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">chatWindow</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-s">'#messages'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42372261293394-2"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">accessManager</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42372261293394-3"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">messagingClient</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42372261293394-4"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">cityChannel</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42372261293394-5"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">username</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42372261293394-6"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">userLocation</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line crayon-bottom" id="crayon-56d59bbe42372261293394-7"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">city</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42372261293394-8"> </p><p class="crayon-line" id="crayon-56d59bbe42372261293394-9"><span class="crayon-c">// Helper function to print info messages to the chat window</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42372261293394-10"><span class="crayon-t">function</span><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">infoMessage</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">asHtml</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-56d59bbe42372261293394-11"><span class="crayon-h">    </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">msg</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-s">'&lt;div class="info"&gt;'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42372261293394-12"><span class="crayon-h">    </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">asHtml</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-56d59bbe42372261293394-13"><span class="crayon-h">        </span><span class="crayon-sy">$</span><span class="crayon-v">msg</span><span class="crayon-sy">.</span><span class="crayon-e">html</span><span class="crayon-sy">(</span><span class="crayon-v">infoMessage</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42372261293394-14"><span class="crayon-h">    </span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-56d59bbe42372261293394-15"><span class="crayon-h">        </span><span class="crayon-sy">$</span><span class="crayon-v">msg</span><span class="crayon-sy">.</span><span class="crayon-e">text</span><span class="crayon-sy">(</span><span class="crayon-v">infoMessage</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42372261293394-16"><span class="crayon-h">    </span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-56d59bbe42372261293394-17"><span class="crayon-h">    </span><span class="crayon-sy">$</span><span class="crayon-v">chatWindow</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">msg</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42372261293394-18"><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-56d59bbe42372261293394-19"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42372261293394-20"><span class="crayon-c">// Helper function to print chat message to the chat window</span></p><p class="crayon-line" id="crayon-56d59bbe42372261293394-21"><span class="crayon-t">function</span><span class="crayon-h"> </span><span class="crayon-e">printMessage</span><span class="crayon-sy">(</span><span class="crayon-v">fromUser</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">message</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42372261293394-22"><span class="crayon-h">    </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">user</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-s">'&lt;span class="username"&gt;'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">text</span><span class="crayon-sy">(</span><span class="crayon-v">fromUser</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">': '</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe42372261293394-23"><span class="crayon-h">    </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">fromUser</span><span class="crayon-h"> </span><span class="crayon-o">===</span><span class="crayon-h"> </span><span class="crayon-v">username</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42372261293394-24"><span class="crayon-h">        </span><span class="crayon-sy">$</span><span class="crayon-v">user</span><span class="crayon-sy">.</span><span class="crayon-e">addClass</span><span class="crayon-sy">(</span><span class="crayon-s">'me'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe42372261293394-25"><span class="crayon-h">    </span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42372261293394-26"><span class="crayon-h">    </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">message</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-s">'&lt;span class="message"&gt;'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">text</span><span class="crayon-sy">(</span><span class="crayon-v">message</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe42372261293394-27"><span class="crayon-h">    </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">container</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-s">'&lt;div class="message-container"&gt;'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42372261293394-28"><span class="crayon-h">    </span><span class="crayon-sy">$</span><span class="crayon-v">container</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">user</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">message</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe42372261293394-29"><span class="crayon-h">    </span><span class="crayon-sy">$</span><span class="crayon-v">chatWindow</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">container</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42372261293394-30"><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-56d59bbe42372261293394-31"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42372261293394-32"><span class="crayon-t">function</span><span class="crayon-h"> </span><span class="crayon-e">positionFound</span><span class="crayon-sy">(</span><span class="crayon-v">position</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-56d59bbe42372261293394-33"><span class="crayon-h">  </span><span class="crayon-v">document</span><span class="crayon-sy">.</span><span class="crayon-e">getElementById</span><span class="crayon-sy">(</span><span class="crayon-s">'lat'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-v">value</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">position</span><span class="crayon-sy">.</span><span class="crayon-v">coords</span><span class="crayon-sy">.</span><span class="crayon-v">latitude</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42372261293394-34"><span class="crayon-h">  </span><span class="crayon-v">document</span><span class="crayon-sy">.</span><span class="crayon-e">getElementById</span><span class="crayon-sy">(</span><span class="crayon-s">'long'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-v">value</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">position</span><span class="crayon-sy">.</span><span class="crayon-v">coords</span><span class="crayon-sy">.</span><span class="crayon-v">longitude</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe42372261293394-35"><span class="crayon-h">  </span><span class="crayon-e">mapAndChat</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42372261293394-36"><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-56d59bbe42372261293394-37"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42372261293394-38"><span class="crayon-c">// creates the map based on user's browser location </span></p><p class="crayon-line" id="crayon-56d59bbe42372261293394-39"><span class="crayon-t">function</span><span class="crayon-h"> </span><span class="crayon-e">drawMap</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42372261293394-40"><span class="crayon-h">  </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">mapCanvas</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">document</span><span class="crayon-sy">.</span><span class="crayon-e">getElementById</span><span class="crayon-sy">(</span><span class="crayon-s">'map'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe42372261293394-41"><span class="crayon-h">  </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">latLng</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-v">google</span><span class="crayon-sy">.</span><span class="crayon-v">maps</span><span class="crayon-sy">.</span><span class="crayon-e">LatLng</span><span class="crayon-sy">(</span><span class="crayon-v">document</span><span class="crayon-sy">.</span><span class="crayon-e">getElementById</span><span class="crayon-sy">(</span><span class="crayon-s">'lat'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-v">value</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">document</span><span class="crayon-sy">.</span><span class="crayon-e">getElementById</span><span class="crayon-sy">(</span><span class="crayon-s">'long'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-v">value</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42372261293394-42"> </p><p class="crayon-line" id="crayon-56d59bbe42372261293394-43"><span class="crayon-h">  </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">mapOptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42372261293394-44"><span class="crayon-h">    </span><span class="crayon-v">center</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">latLng</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d59bbe42372261293394-45"><span class="crayon-h">    </span><span class="crayon-v">zoom</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">12</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42372261293394-46"><span class="crayon-h">    </span><span class="crayon-v">mapTypeId</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">google</span><span class="crayon-sy">.</span><span class="crayon-v">maps</span><span class="crayon-sy">.</span><span class="crayon-v">MapTypeId</span><span class="crayon-sy">.</span><span class="crayon-i">ROADMAP</span></p><p class="crayon-line" id="crayon-56d59bbe42372261293394-47"><span class="crayon-h">  </span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42372261293394-48"><span class="crayon-h">  </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">map</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-v">google</span><span class="crayon-sy">.</span><span class="crayon-v">maps</span><span class="crayon-sy">.</span><span class="crayon-e">Map</span><span class="crayon-sy">(</span><span class="crayon-v">mapCanvas</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">mapOptions</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe42372261293394-49"><span class="crayon-h">  </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">marker</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-v">google</span><span class="crayon-sy">.</span><span class="crayon-v">maps</span><span class="crayon-sy">.</span><span class="crayon-e">Marker</span><span class="crayon-sy">(</span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42372261293394-50"><span class="crayon-h">    </span><span class="crayon-v">position</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">latLng</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d59bbe42372261293394-51"><span class="crayon-h">    </span><span class="crayon-v">map</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">map</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42372261293394-52"><span class="crayon-h">    </span><span class="crayon-v">title</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">'Your location'</span></p><p class="crayon-line" id="crayon-56d59bbe42372261293394-53"><span class="crayon-h">  </span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42372261293394-54"><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-56d59bbe42372261293394-55"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42372261293394-56"><span class="crayon-t">function</span><span class="crayon-h"> </span><span class="crayon-e">mapAndChat</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-56d59bbe42372261293394-57"><span class="crayon-h">  </span><span class="crayon-e">drawMap</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line crayon-top crayon-bottom crayon-striped-line" id="crayon-56d59bbe42372261293394-58"><span class="crayon-h">  </span><span class="crayon-e">chatBasedOnCity</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe42372261293394-59"><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42372261293394-60"> </p><p class="crayon-line crayon-marked-line crayon-top" id="crayon-56d59bbe42372261293394-61"><span class="crayon-t">function</span><span class="crayon-h"> </span><span class="crayon-e">chatBasedOnCity</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42372261293394-62"><span class="crayon-h">  </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">latitude</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-s">'#lat'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">val</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42372261293394-63"><span class="crayon-h">  </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">longitude</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-s">'#long'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">val</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42372261293394-64"><span class="crayon-h">  </span><span class="crayon-sy">$</span><span class="crayon-sy">.</span><span class="crayon-e">getJSON</span><span class="crayon-sy">(</span><span class="crayon-s">'http://maps.googleapis.com/maps/api/geocode/json?latlng='</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">latitude</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">','</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">longitude</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">'&amp;sensor=true'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-v">locationData</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42372261293394-65"><span class="crayon-h">    </span><span class="crayon-v">userLocation</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">locationData</span><span class="crayon-sy">.</span><span class="crayon-v">results</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-s">"formatted_address"</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42372261293394-66"><span class="crayon-h">    </span><span class="crayon-v">username</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">userLocation</span><span class="crayon-sy">.</span><span class="crayon-e">replace</span><span class="crayon-sy">(</span><span class="crayon-o">/</span><span class="crayon-sy">\</span><span class="crayon-v">s</span><span class="crayon-o">/</span><span class="crayon-v">g</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'_'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42372261293394-67"><span class="crayon-h">    </span><span class="crayon-v">city</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">locationData</span><span class="crayon-sy">.</span><span class="crayon-v">results</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">address_components</span><span class="crayon-sy">[</span><span class="crayon-cn">3</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">long_name</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42372261293394-68"><span class="crayon-h">    </span><span class="crayon-e">createChat</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42372261293394-69"><span class="crayon-h">  </span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42372261293394-70"><span class="crayon-sy">}</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42372261293394-71"> </p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42372261293394-72"> </p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42372261293394-73"><span class="crayon-t">function</span><span class="crayon-h"> </span><span class="crayon-e">createChat</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42372261293394-74"><span class="crayon-h">  </span><span class="crayon-sy">$</span><span class="crayon-sy">.</span><span class="crayon-e">getJSON</span><span class="crayon-sy">(</span><span class="crayon-s">'/token'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-v">identity</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">username</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">device</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">'browser'</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42372261293394-75"><span class="crayon-h">    </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'It looks like you are near: '</span><span class="crayon-h"> </span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42372261293394-76"><span class="crayon-h">        </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">'&lt;span class="me"&gt;&lt;strong&gt;'</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">userLocation</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">'&lt;/strong&gt;&lt;/span&gt;'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">true</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42372261293394-77"> </p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42372261293394-78"><span class="crayon-h">    </span><span class="crayon-v">accessManager</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-v">Twilio</span><span class="crayon-sy">.</span><span class="crayon-e">AccessManager</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-v">token</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42372261293394-79"><span class="crayon-h">    </span><span class="crayon-v">messagingClient</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-v">Twilio</span><span class="crayon-sy">.</span><span class="crayon-v">IPMessaging</span><span class="crayon-sy">.</span><span class="crayon-e">Client</span><span class="crayon-sy">(</span><span class="crayon-v">accessManager</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42372261293394-80"> </p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42372261293394-81"><span class="crayon-h">    </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">promise</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">messagingClient</span><span class="crayon-sy">.</span><span class="crayon-e">getChannelByUniqueName</span><span class="crayon-sy">(</span><span class="crayon-v">city</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42372261293394-82"><span class="crayon-h">    </span><span class="crayon-v">promise</span><span class="crayon-sy">.</span><span class="crayon-st">then</span><span class="crayon-sy">(</span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-v">channel</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42372261293394-83"><span class="crayon-h">        </span><span class="crayon-v">cityChannel</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">channel</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42372261293394-84"><span class="crayon-h">        </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-o">!</span><span class="crayon-v">cityChannel</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42372261293394-85"><span class="crayon-h">            </span><span class="crayon-c">// If channel does not exist then create it</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42372261293394-86"><span class="crayon-h">            </span><span class="crayon-v">messagingClient</span><span class="crayon-sy">.</span><span class="crayon-e">createChannel</span><span class="crayon-sy">(</span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42372261293394-87"><span class="crayon-h">                </span><span class="crayon-v">uniqueName</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">city</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42372261293394-88"><span class="crayon-h">                </span><span class="crayon-v">friendlyName</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-i">city</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42372261293394-89"><span class="crayon-h">            </span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-st">then</span><span class="crayon-sy">(</span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-v">channel</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42372261293394-90"><span class="crayon-h">                </span><span class="crayon-v">console</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-s">'Created channel:'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42372261293394-91"><span class="crayon-h">                </span><span class="crayon-v">console</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-v">channel</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42372261293394-92"><span class="crayon-h">                </span><span class="crayon-v">cityChannel</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">channel</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42372261293394-93"><span class="crayon-h">            </span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42372261293394-94"><span class="crayon-h">        </span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42372261293394-95"><span class="crayon-h">            </span><span class="crayon-v">console</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-s">'Found channel:'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42372261293394-96"><span class="crayon-h">            </span><span class="crayon-v">console</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-v">cityChannel</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42372261293394-97"><span class="crayon-h">        </span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42372261293394-98"><span class="crayon-h">    </span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe42372261293394-99"> </p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe42372261293394-100"><span class="crayon-h">  </span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line crayon-bottom" id="crayon-56d59bbe42372261293394-101"><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42372261293394-102"> </p><p class="crayon-line" id="crayon-56d59bbe42372261293394-103"><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">navigator</span><span class="crayon-sy">.</span><span class="crayon-v">geolocation</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42372261293394-104"><span class="crayon-h">  </span><span class="crayon-v">navigator</span><span class="crayon-sy">.</span><span class="crayon-v">geolocation</span><span class="crayon-sy">.</span><span class="crayon-e">getCurrentPosition</span><span class="crayon-sy">(</span><span class="crayon-v">positionFound</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe42372261293394-105"><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe42372261293394-106"><span class="crayon-h">  </span><span class="crayon-e">alert</span><span class="crayon-sy">(</span><span class="crayon-s">'It appears that required browser geolocation is not enabled.'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe42372261293394-107"><span class="crayon-sy">}</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>The new function <code>chatBasedOnCity</code> takes the latitude and longitude of the user’s browser and looks up the location with the Google Maps API. Google Maps returns JSON with an approximate address for the latitude and longitude along with the city name. We use the city name and the address in the <code>createChat</code> function. <code>createChat</code> obtains the a JWT access token created by our <code>/token</code> endpoint then uses that to authenticate with Twilio IP Messaging. We then try to create create a channel for our city, but if one already exists we don’t need to create a new channel, we simply log that it exists.</p>
<p>We can test out the above code, but it won’t yet join us to the city messaging channel we need to chat with other users in the same city. Time to finish our JavaScript by joining the new or existent chat channel. Add the highlighted lines below that join our city chat channel and listen for new messages that are sent on it.</p>

		<div id="crayon-56d59bbe4237f759031391" class="crayon-syntax crayon-theme-solarized-dark crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-1">1</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-2">2</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-3">3</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-4">4</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-5">5</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-6">6</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-7">7</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-8">8</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-9">9</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-10">10</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-11">11</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-12">12</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-13">13</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-14">14</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-15">15</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-16">16</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-17">17</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-18">18</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-19">19</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-20">20</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-21">21</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-22">22</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-23">23</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-24">24</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-25">25</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-26">26</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-27">27</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-28">28</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-29">29</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-30">30</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-31">31</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-32">32</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-33">33</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-34">34</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-35">35</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-36">36</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-37">37</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-38">38</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-39">39</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-40">40</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-41">41</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-42">42</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-43">43</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-44">44</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-45">45</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-46">46</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-47">47</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-48">48</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-49">49</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-50">50</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-51">51</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-52">52</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-53">53</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-54">54</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-55">55</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-56">56</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-57">57</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-58">58</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-59">59</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-60">60</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-61">61</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-62">62</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-63">63</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-64">64</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-65">65</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-66">66</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-67">67</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-68">68</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-69">69</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-70">70</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-71">71</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-72">72</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-73">73</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-74">74</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-75">75</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-76">76</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-77">77</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-78">78</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-79">79</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-80">80</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-81">81</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-82">82</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-83">83</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-84">84</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-85">85</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-86">86</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-87">87</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-88">88</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-89">89</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-90">90</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-91">91</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-92">92</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-93">93</p><p class="crayon-num crayon-marked-num crayon-top crayon-bottom crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-94">94</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-95">95</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-96">96</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-97">97</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-98">98</p><p class="crayon-num crayon-marked-num crayon-top crayon-bottom" data-line="crayon-56d59bbe4237f759031391-99">99</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-100">100</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-101">101</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-102">102</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-103">103</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-104">104</p><p class="crayon-num crayon-marked-num crayon-top" data-line="crayon-56d59bbe4237f759031391-105">105</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-106">106</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe4237f759031391-107">107</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-108">108</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe4237f759031391-109">109</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-110">110</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe4237f759031391-111">111</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-112">112</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe4237f759031391-113">113</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-114">114</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe4237f759031391-115">115</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-116">116</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe4237f759031391-117">117</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-118">118</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe4237f759031391-119">119</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-120">120</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe4237f759031391-121">121</p><p class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-122">122</p><p class="crayon-num crayon-marked-num" data-line="crayon-56d59bbe4237f759031391-123">123</p><p class="crayon-num crayon-marked-num crayon-bottom crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-124">124</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-125">125</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-126">126</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-127">127</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-128">128</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-129">129</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59bbe4237f759031391-130">130</p><p class="crayon-num" data-line="crayon-56d59bbe4237f759031391-131">131</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d59bbe4237f759031391-1"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">chatWindow</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-s">'#messages'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-2"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">accessManager</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-3"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">messagingClient</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-4"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">cityChannel</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-5"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">username</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-6"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">userLocation</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-7"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">city</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-8"> </p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-9"><span class="crayon-c">// Helper function to print info messages to the chat window</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-10"><span class="crayon-t">function</span><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">infoMessage</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">asHtml</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-11"><span class="crayon-h">    </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">msg</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-s">'&lt;div class="info"&gt;'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-12"><span class="crayon-h">    </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">asHtml</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-13"><span class="crayon-h">        </span><span class="crayon-sy">$</span><span class="crayon-v">msg</span><span class="crayon-sy">.</span><span class="crayon-e">html</span><span class="crayon-sy">(</span><span class="crayon-v">infoMessage</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-14"><span class="crayon-h">    </span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-15"><span class="crayon-h">        </span><span class="crayon-sy">$</span><span class="crayon-v">msg</span><span class="crayon-sy">.</span><span class="crayon-e">text</span><span class="crayon-sy">(</span><span class="crayon-v">infoMessage</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-16"><span class="crayon-h">    </span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-17"><span class="crayon-h">    </span><span class="crayon-sy">$</span><span class="crayon-v">chatWindow</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">msg</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-18"><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-19"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-20"><span class="crayon-c">// Helper function to print chat message to the chat window</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-21"><span class="crayon-t">function</span><span class="crayon-h"> </span><span class="crayon-e">printMessage</span><span class="crayon-sy">(</span><span class="crayon-v">fromUser</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">message</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-22"><span class="crayon-h">    </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">user</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-s">'&lt;span class="username"&gt;'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">text</span><span class="crayon-sy">(</span><span class="crayon-v">fromUser</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">': '</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-23"><span class="crayon-h">    </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">fromUser</span><span class="crayon-h"> </span><span class="crayon-o">===</span><span class="crayon-h"> </span><span class="crayon-v">username</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-24"><span class="crayon-h">        </span><span class="crayon-sy">$</span><span class="crayon-v">user</span><span class="crayon-sy">.</span><span class="crayon-e">addClass</span><span class="crayon-sy">(</span><span class="crayon-s">'me'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-25"><span class="crayon-h">    </span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-26"><span class="crayon-h">    </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">message</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-s">'&lt;span class="message"&gt;'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">text</span><span class="crayon-sy">(</span><span class="crayon-v">message</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-27"><span class="crayon-h">    </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">container</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-s">'&lt;div class="message-container"&gt;'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-28"><span class="crayon-h">    </span><span class="crayon-sy">$</span><span class="crayon-v">container</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">user</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">message</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-29"><span class="crayon-h">    </span><span class="crayon-sy">$</span><span class="crayon-v">chatWindow</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">container</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-30"><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-31"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-32"><span class="crayon-c">// creates the map based on user's browser location </span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-33"><span class="crayon-t">function</span><span class="crayon-h"> </span><span class="crayon-e">drawMap</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-34"><span class="crayon-h">  </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">mapCanvas</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">document</span><span class="crayon-sy">.</span><span class="crayon-e">getElementById</span><span class="crayon-sy">(</span><span class="crayon-s">'map'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-35"><span class="crayon-h">  </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">latLng</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-v">google</span><span class="crayon-sy">.</span><span class="crayon-v">maps</span><span class="crayon-sy">.</span><span class="crayon-e">LatLng</span><span class="crayon-sy">(</span><span class="crayon-v">document</span><span class="crayon-sy">.</span><span class="crayon-e">getElementById</span><span class="crayon-sy">(</span><span class="crayon-s">'lat'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-v">value</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">document</span><span class="crayon-sy">.</span><span class="crayon-e">getElementById</span><span class="crayon-sy">(</span><span class="crayon-s">'long'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-v">value</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-36"> </p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-37"><span class="crayon-h">  </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">mapOptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-38"><span class="crayon-h">    </span><span class="crayon-v">center</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">latLng</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-39"><span class="crayon-h">    </span><span class="crayon-v">zoom</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">12</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-40"><span class="crayon-h">    </span><span class="crayon-v">mapTypeId</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">google</span><span class="crayon-sy">.</span><span class="crayon-v">maps</span><span class="crayon-sy">.</span><span class="crayon-v">MapTypeId</span><span class="crayon-sy">.</span><span class="crayon-i">ROADMAP</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-41"><span class="crayon-h">  </span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-42"><span class="crayon-h">  </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">map</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-v">google</span><span class="crayon-sy">.</span><span class="crayon-v">maps</span><span class="crayon-sy">.</span><span class="crayon-e">Map</span><span class="crayon-sy">(</span><span class="crayon-v">mapCanvas</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">mapOptions</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-43"><span class="crayon-h">  </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">marker</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-v">google</span><span class="crayon-sy">.</span><span class="crayon-v">maps</span><span class="crayon-sy">.</span><span class="crayon-e">Marker</span><span class="crayon-sy">(</span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-44"><span class="crayon-h">    </span><span class="crayon-v">position</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">latLng</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-45"><span class="crayon-h">    </span><span class="crayon-v">map</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">map</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-46"><span class="crayon-h">    </span><span class="crayon-v">title</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">'Your location'</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-47"><span class="crayon-h">  </span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-48"><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-49"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-50"><span class="crayon-t">function</span><span class="crayon-h"> </span><span class="crayon-e">positionFound</span><span class="crayon-sy">(</span><span class="crayon-v">position</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-51"><span class="crayon-h">  </span><span class="crayon-v">document</span><span class="crayon-sy">.</span><span class="crayon-e">getElementById</span><span class="crayon-sy">(</span><span class="crayon-s">'lat'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-v">value</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">position</span><span class="crayon-sy">.</span><span class="crayon-v">coords</span><span class="crayon-sy">.</span><span class="crayon-v">latitude</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-52"><span class="crayon-h">  </span><span class="crayon-v">document</span><span class="crayon-sy">.</span><span class="crayon-e">getElementById</span><span class="crayon-sy">(</span><span class="crayon-s">'long'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-v">value</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">position</span><span class="crayon-sy">.</span><span class="crayon-v">coords</span><span class="crayon-sy">.</span><span class="crayon-v">longitude</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-53"><span class="crayon-h">  </span><span class="crayon-e">mapAndChat</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-54"><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-55"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-56"><span class="crayon-t">function</span><span class="crayon-h"> </span><span class="crayon-e">mapAndChat</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-57"><span class="crayon-h">  </span><span class="crayon-e">drawMap</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-58"><span class="crayon-h">  </span><span class="crayon-e">chatBasedOnCity</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-59"><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-60"> </p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-61"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-62"><span class="crayon-t">function</span><span class="crayon-h"> </span><span class="crayon-e">chatBasedOnCity</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-63"><span class="crayon-h">  </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">latitude</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-s">'#lat'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">val</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-64"><span class="crayon-h">  </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">longitude</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-s">'#long'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">val</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-65"><span class="crayon-h">  </span><span class="crayon-sy">$</span><span class="crayon-sy">.</span><span class="crayon-e">getJSON</span><span class="crayon-sy">(</span><span class="crayon-s">'http://maps.googleapis.com/maps/api/geocode/json?latlng='</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">latitude</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">','</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">longitude</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">'&amp;sensor=true'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-v">locationData</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-66"><span class="crayon-h">    </span><span class="crayon-v">userLocation</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">locationData</span><span class="crayon-sy">.</span><span class="crayon-v">results</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-s">"formatted_address"</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-67"><span class="crayon-h">    </span><span class="crayon-v">username</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">userLocation</span><span class="crayon-sy">.</span><span class="crayon-e">replace</span><span class="crayon-sy">(</span><span class="crayon-o">/</span><span class="crayon-sy">\</span><span class="crayon-v">s</span><span class="crayon-o">/</span><span class="crayon-v">g</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'_'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-68"><span class="crayon-h">    </span><span class="crayon-v">city</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">locationData</span><span class="crayon-sy">.</span><span class="crayon-v">results</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">address_components</span><span class="crayon-sy">[</span><span class="crayon-cn">3</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">long_name</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-69"><span class="crayon-h">    </span><span class="crayon-e">createChat</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-70"><span class="crayon-h">  </span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-71"><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-72"> </p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-73"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-74"><span class="crayon-t">function</span><span class="crayon-h"> </span><span class="crayon-e">createChat</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-75"><span class="crayon-h">  </span><span class="crayon-sy">$</span><span class="crayon-sy">.</span><span class="crayon-e">getJSON</span><span class="crayon-sy">(</span><span class="crayon-s">'/token'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-v">identity</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">username</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">device</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">'browser'</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-76"><span class="crayon-h">    </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'It looks like you are near: '</span><span class="crayon-h"> </span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-77"><span class="crayon-h">        </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">'&lt;span class="me"&gt;&lt;strong&gt;'</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">userLocation</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">'&lt;/strong&gt;&lt;/span&gt;'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">true</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-78"> </p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-79"><span class="crayon-h">    </span><span class="crayon-v">accessManager</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-v">Twilio</span><span class="crayon-sy">.</span><span class="crayon-e">AccessManager</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-v">token</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-80"><span class="crayon-h">    </span><span class="crayon-v">messagingClient</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-v">Twilio</span><span class="crayon-sy">.</span><span class="crayon-v">IPMessaging</span><span class="crayon-sy">.</span><span class="crayon-e">Client</span><span class="crayon-sy">(</span><span class="crayon-v">accessManager</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-81"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-82"><span class="crayon-h">    </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">promise</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">messagingClient</span><span class="crayon-sy">.</span><span class="crayon-e">getChannelByUniqueName</span><span class="crayon-sy">(</span><span class="crayon-v">city</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-83"><span class="crayon-h">    </span><span class="crayon-v">promise</span><span class="crayon-sy">.</span><span class="crayon-st">then</span><span class="crayon-sy">(</span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-v">channel</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-84"><span class="crayon-h">        </span><span class="crayon-v">cityChannel</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">channel</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-85"><span class="crayon-h">        </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-o">!</span><span class="crayon-v">cityChannel</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-86"><span class="crayon-h">            </span><span class="crayon-c">// If channel does not exist then create it</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-87"><span class="crayon-h">            </span><span class="crayon-v">messagingClient</span><span class="crayon-sy">.</span><span class="crayon-e">createChannel</span><span class="crayon-sy">(</span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-88"><span class="crayon-h">                </span><span class="crayon-v">uniqueName</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">city</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-89"><span class="crayon-h">                </span><span class="crayon-v">friendlyName</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-i">city</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-90"><span class="crayon-h">            </span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-st">then</span><span class="crayon-sy">(</span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-v">channel</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-91"><span class="crayon-h">                </span><span class="crayon-v">console</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-s">'Created channel:'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-92"><span class="crayon-h">                </span><span class="crayon-v">console</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-v">channel</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-93"><span class="crayon-h">                </span><span class="crayon-v">cityChannel</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">channel</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line crayon-top crayon-bottom crayon-striped-line" id="crayon-56d59bbe4237f759031391-94"><span class="crayon-h">                </span><span class="crayon-e">setupChannel</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-95"><span class="crayon-h">            </span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-96"><span class="crayon-h">        </span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-97"><span class="crayon-h">            </span><span class="crayon-v">console</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-s">'Found channel:'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-98"><span class="crayon-h">            </span><span class="crayon-v">console</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-v">cityChannel</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line crayon-top crayon-bottom" id="crayon-56d59bbe4237f759031391-99"><span class="crayon-h">            </span><span class="crayon-e">setupChannel</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-100"><span class="crayon-h">        </span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-101"><span class="crayon-h">    </span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-102"> </p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-103"><span class="crayon-h">  </span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-104"> </p><p class="crayon-line crayon-marked-line crayon-top" id="crayon-56d59bbe4237f759031391-105"><span class="crayon-h">  </span><span class="crayon-t">function</span><span class="crayon-h"> </span><span class="crayon-e">setupChannel</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-106"><span class="crayon-h">      </span><span class="crayon-c">// Join the general channel</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe4237f759031391-107"><span class="crayon-h">      </span><span class="crayon-v">cityChannel</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-st">then</span><span class="crayon-sy">(</span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-v">channel</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-108"><span class="crayon-h">          </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Joined channel "'</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">channel</span><span class="crayon-sy">.</span><span class="crayon-v">uniqueName</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">'" as '</span><span class="crayon-h"> </span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe4237f759031391-109"><span class="crayon-h">              </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">'&lt;span class="me"&gt;'</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">username</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">'&lt;/span&gt;.'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">true</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-110"><span class="crayon-h">      </span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe4237f759031391-111"><span class="crayon-h">      </span><span class="crayon-c">// Listen for new messages sent to the channel</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-112"><span class="crayon-h">      </span><span class="crayon-v">cityChannel</span><span class="crayon-sy">.</span><span class="crayon-e">on</span><span class="crayon-sy">(</span><span class="crayon-s">'messageAdded'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-v">message</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe4237f759031391-113"><span class="crayon-h">          </span><span class="crayon-e">printMessage</span><span class="crayon-sy">(</span><span class="crayon-v">message</span><span class="crayon-sy">.</span><span class="crayon-v">author</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">message</span><span class="crayon-sy">.</span><span class="crayon-v">body</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-114"><span class="crayon-h">      </span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe4237f759031391-115"><span class="crayon-h">  </span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-116"> </p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe4237f759031391-117"><span class="crayon-h">  </span><span class="crayon-c">// Send a new message to the general channel</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-118"><span class="crayon-h">  </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">input</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-s">'#chat-input'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe4237f759031391-119"><span class="crayon-h">  </span><span class="crayon-sy">$</span><span class="crayon-v">input</span><span class="crayon-sy">.</span><span class="crayon-e">on</span><span class="crayon-sy">(</span><span class="crayon-s">'keydown'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-v">e</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-120"><span class="crayon-h">      </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">e</span><span class="crayon-sy">.</span><span class="crayon-v">keyCode</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-cn">13</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe4237f759031391-121"><span class="crayon-h">          </span><span class="crayon-v">cityChannel</span><span class="crayon-sy">.</span><span class="crayon-e">sendMessage</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">input</span><span class="crayon-sy">.</span><span class="crayon-e">val</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-122"><span class="crayon-h">          </span><span class="crayon-sy">$</span><span class="crayon-v">input</span><span class="crayon-sy">.</span><span class="crayon-e">val</span><span class="crayon-sy">(</span><span class="crayon-s">''</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-marked-line" id="crayon-56d59bbe4237f759031391-123"><span class="crayon-h">      </span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-marked-line crayon-bottom crayon-striped-line" id="crayon-56d59bbe4237f759031391-124"><span class="crayon-h">  </span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-125"><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-126"> </p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-127"><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">navigator</span><span class="crayon-sy">.</span><span class="crayon-v">geolocation</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-128"><span class="crayon-h">  </span><span class="crayon-v">navigator</span><span class="crayon-sy">.</span><span class="crayon-v">geolocation</span><span class="crayon-sy">.</span><span class="crayon-e">getCurrentPosition</span><span class="crayon-sy">(</span><span class="crayon-v">positionFound</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-129"><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59bbe4237f759031391-130"><span class="crayon-h">  </span><span class="crayon-e">alert</span><span class="crayon-sy">(</span><span class="crayon-s">'It appears that required browser geolocation is not enabled.'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d59bbe4237f759031391-131"><span class="crayon-sy">}</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>The above <code>setupChannel</code> function joins the channel based on our current city’s name and listens for new messages sent on the channel. We also enable chat input to send messages on our channel so other clients listening for messages on the channel will see and display them on the screen.</p>
<p>Go ahead and refresh the <a href="http://localhost:8000">localhost:8000</a> page in your browser to test out the results.</p>
<h2 class="c1 c14 c12"><a name="h.tkjcq82zrj8p"/>City Chatting Away</h2>
<p>Congratulations!  Our application is now running on our localhost machine on port 8000. When you want to open up the app to other folks without access to your system, you can use a <a href="https://www.twilio.com/blog/2013/10/test-your-webhooks-locally-with-ngrok.html">localhost tunneling tool like Ngrok</a> or deploy it to a server with a fixed IP address.</p>
<p>If you’re looking for more Python code to implement IP messaging into your application, check out the <a href="https://www.twilio.com/docs/api/ip-messaging/guides/quickstart-js">IP Messaging JavaScript Quickstart</a> that includes a Python with Flask web application tutorial.</p>
<p>We can now use our application to chat with other residents that join in the same IP Messaging channel based on the city name gleaned from our browser location. Have a few folks from your city join the app and try it out to find an apartment, get out the vote or poll fellow city residents. What other situations do you think IP messaging could be applied to? I’d like to hear from you if you run into any issues throughout the post so feel free to drop a comment below or contact me via:</p>

			</div>
					</div></body></html>