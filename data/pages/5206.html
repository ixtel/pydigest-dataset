<html><body><div><div class="post-content" itemprop="articleBody">
    <p>Over the years, Beautiful Soup has probably saved us more hours on scraping, data collection, and other projects than we can count. <a href="http://www.crummy.com/software/BeautifulSoup/" target="_blank">Crummy's landing page</a> for the library even says:</p>
<blockquote><p>Beautiful Soup is here to help. Since 2004, it's been saving programmers hours or days of work on quick-turnaround screen scraping projects.</p></blockquote>

<p>You can plot me directly in the "days" column. When I'm starting a Python project that requires me to parse through HTML data, the first dependency I'll pull is BeautifulSoup. It makes what would normally be a nasty Perl-esque mess into a something nice and Pythonic, keeping sanity intact. But what about structured data other than HTML? I've also learned that BS can be a huge boon for XML data, but not without a couple of speed bumps.</p>
<p>Enter data from the client (not real data, but play along for a moment):</p>
<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;xml&gt;</span>
  <span class="nt">&lt;sport</span> <span class="na">name=</span><span class="s">"baseball"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;team</span> <span class="na">name=</span><span class="s">"Braves"</span> <span class="na">city=</span><span class="s">"Atlanta"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;link&gt;</span>
          <span class="nt">&lt;url&gt;</span>http://atlanta.braves.mlb.com<span class="nt">&lt;/url&gt;</span>
        <span class="nt">&lt;/link&gt;</span>
    <span class="nt">&lt;/team&gt;</span>
  <span class="nt">&lt;/sport&gt;</span>
<span class="nt">&lt;/xml&gt;</span></code></pre></figure>
<p>Seems well-structured! Our customer just needs all the links that we have in the data. We fire up our editor of choice and roll up our sleeves.</p>
<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="c"># Make our soup</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'data.xml'</span><span class="p">)</span> <span class="k">as</span> <span class="n">infile</span><span class="p">:</span>
    <span class="n">blob</span> <span class="o">=</span> <span class="n">infile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="c"># Use LXML for blazing speed</span>
<span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">blob</span><span class="p">,</span> <span class="s">'lxml'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">soup</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s">'link'</span><span class="p">))</span></code></pre></figure>
<p>We get in return:</p>
<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;link&gt;</span></code></pre></figure>
<p>Wait, what? What happened to our content? This is a pretty basic BS use case, but something strange is happening. Well, I'll come back to this and start working with their other very hypothetical data sets where <strong>tags become</strong> tags, but the rest of the data is structured exactly the same. This time around:</p>
<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;xml&gt;</span>
  <span class="nt">&lt;sport</span> <span class="na">name=</span><span class="s">"baseball"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;team</span> <span class="na">name=</span><span class="s">"Braves"</span> <span class="na">city=</span><span class="s">"Atlanta"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;resource&gt;</span><span class="c">&lt;!-- Changed to resouce --&gt;</span>
          <span class="nt">&lt;url&gt;</span>http://atlanta.braves.mlb.com<span class="nt">&lt;/url&gt;</span>
        <span class="nt">&lt;/resource&gt;</span><span class="c">&lt;!-- Corresponding close --&gt;</span>
    <span class="nt">&lt;/team&gt;</span>
  <span class="nt">&lt;/sport&gt;</span>
<span class="nt">&lt;/xml&gt;</span></code></pre></figure>
<p>...and corresponding result...</p>
<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">soup</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s">'resource'</span><span class="p">))</span></code></pre></figure>
<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;resource&gt;</span>
    <span class="nt">&lt;url&gt;</span>http://atlanta.braves.mlb.com/index.jsp?c_id=atl<span class="nt">&lt;/url&gt;</span>
<span class="nt">&lt;/resource&gt;</span></code></pre></figure>
<p><a href="http://i.stack.imgur.com/KJCqX.jpg"><img class="alignright" src="/assets/KJCqX.jpg" alt=""/></a>Interesting! To compound our problem, we're on a customer site where we don't have internet access to grab that sweet, sweet documentation we crave. After toiling on a Stack Overflow dump in all the wrong places, I was reminded of one of my <a href="http://blog.codinghorror.com/learn-to-read-the-source-luke/" target="_blank">favorite blog posts</a> by SO's founder, Jeff Atwood. <em>Read the Source</em>. But what was I looking for? Well, let's dig around for <strong>&lt;link&gt;</strong> tags and see what turns up.</p>
<p>Sure enough, after some quick searches, we find what I believe to be the smoking gun (<em>for those following along at home, bs4.builder.__init__.py, lines 228/229 in v4.3.2</em>).</p>
<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">empty_element_tags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s">'br'</span> <span class="p">,</span> <span class="s">'hr'</span><span class="p">,</span> <span class="s">'input'</span><span class="p">,</span> <span class="s">'img'</span><span class="p">,</span> <span class="s">'meta'</span><span class="p">,</span>
                          <span class="s">'spacer'</span><span class="p">,</span> <span class="s">'link'</span><span class="p">,</span> <span class="s">'frame'</span><span class="p">,</span> <span class="s">'base'</span><span class="p">])</span></code></pre></figure>
<p>We have a seemingly harmless word with "link" in our XML, but it means something <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/link">very different in HTML</a> and more specifically, the TreeBuilder implementation that LXML is using. As a test, if I change our <strong>&lt;link&gt;</strong> turned <strong>&lt;resource&gt;</strong> tags into <strong>&lt;base&gt;</strong> tags we get the same result - no content. It also turns out that if you have LXML installed, BeautifulSoup4 will fall back to that for parsing. Uninstalling it grants us the results we want - tags with content. The stricter (but faster) TreeBuilder implementations from LXML take precedence over the built-in HTMLParser or html5lib (if you have it installed). How do we know that? Back to the source code!</p>
<p><em>bs4/builder/__init__.py, lines 304:321</em></p>
<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># Builders are registered in reverse order of priority, so that custom</span>
<span class="c"># builder registrations will take precedence. In general, we want lxml</span>
<span class="c"># to take precedence over html5lib, because it's faster. And we only</span>
<span class="c"># want to use HTMLParser as a last result.</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_htmlparser</span>
<span class="n">register_treebuilders_from</span><span class="p">(</span><span class="n">_htmlparser</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_html5lib</span>
    <span class="n">register_treebuilders_from</span><span class="p">(</span><span class="n">_html5lib</span><span class="p">)</span>
<span class="k">except</span> <span class="nb">ImportError</span><span class="p">:</span>
    <span class="c"># They don't have html5lib installed.</span>
    <span class="k">pass</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_lxml</span>
    <span class="n">register_treebuilders_from</span><span class="p">(</span><span class="n">_lxml</span><span class="p">)</span>
<span class="k">except</span> <span class="nb">ImportError</span><span class="p">:</span>
    <span class="c"># They don't have lxml installed.</span>
    <span class="k">pass</span></code></pre></figure>
<p>As it turns out, when creating your soup, 'lxml' != 'xml'. Changing the soup creation gets us the results we're looking for (UPDATE: corresponding doc "helpfully" pointed out by a Reddit commenter <a href="http://www.crummy.com/software/BeautifulSoup/bs4/doc/#parsing-xml">here</a>). BeautifulSoup was still falling back to HTML builders, thus why we were seeing the results we were when specifying 'lxml'.</p>
<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># Use HTML for sanity</span>
<span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">blob</span><span class="p">,</span> <span class="s">'xml'</span><span class="p">)</span></code></pre></figure>
<p><del>While I didn't find that magic code snippet to fix everything,</del>  (UPDATE: Thanks Reddit). We found our problem, but went really roundabout to get there. Understanding <em>why </em>it was happening made me a feel a lot better in the end. It's easy to get frustrated when coding, but always remember, read the docs and - <em>Read the Source, Luke. </em>It might help you understand the problem.</p>
<p><em>We’re hiring!  If you’re interested in geospatial, big data, social media analytics, Amazon Web Services (AWS), visualization, and/or the latest UI and server technologies, drop us an e-mail at <a href="mailto:info@thehumangeo.com">info@thehumangeo.com</a>.</em></p>

  </div>

</div></body></html>