<html><body><div><div class="content html_format">
      <img src="https://habrastorage.org/files/4f9/1d9/79e/4f91d979e8354ba496dd7ab0f925e557.png" align="right"/><p>Некоторое время назад решил я освежить знания и почитать что-нибудь о графах. «Ну конечно же, на Хабре должны быть хорошие статьи!» — подумал я, и оказался прав. Статьи есть и их много. Но выглядит они преимущественно вот так: </p><a href="http://habrahabr.ru/post/61884/">раз</a><p>, </p><a href="http://habrahabr.ru/post/65617/">два</a><p>, </p><a href="http://habrahabr.ru/post/63982/">три</a><p>. Откройте и догадайтесь с одной попытки почему что-то понять из этих статей совершенно невозможно, хотя написано вполне понятным языком. Нет картинок! Ну а как изучать графы без картинок? Никак.
</p><p>
Новичок на Хабре недоуменно спросит: «Как так — нет картинок? Есть же habrastorage.org!». Да, есть. Но был он не всегда, а автоматически на него перезаливаться картинки и вовсе стали </p><a href="http://habrahabr.ru/post/188436/">только в июле 2013-го</a><p>. А до этого картинки хостились где-попало — на всяких радикалах, имейджхаках, даже на дропбокс, бывало, люди наивно пытались что-то выкладывать. В итоге мы имеем на Хабре кучу статей 2006-2013 года с отсутствующими картинками.
</p><p>
Давайте это пофиксим!
</p><a name="habracut"/>

<h4>План</h4><p>
Перед нами на первом этапе стоят следующие задачи:
</p><ul>
<li>Скачать все статьи от возникновения Хабра и до вышеупомянутого поста 188436, примерно обозначающую начало принудительной перезаливки картинок на habrastorage.org</li>
<li>Найти в тексте статей ссылки на все картинки, размещённые не на Хабре, Гиктаймсе, Мегамозге или Хабрасторадже</li>
<li>Проверить доступность этих картинок(GET делать не обязательно, достаточно запроса HEAD с проверкой кода возврата и типа контента)</li>
<li>Экспорт списка недоступных картинок в файл</li>
</ul>

<h4>Реализация</h4><p>
В общем, только ленивый ещё не парсил Хабр, ну а мы же не ленивые. Тем более, что там на Python + requests писать:

</p>
<p>
Заливаем код на виртуалку в облаке, запускаем, возвращаемся через 2 дня (можно было бы, конечно, парсить в несколько потоков — но мне помнится, где-то в FAQ Хабр просил не дёргать его ботами чаще чем 2 раза в секунду).

</p><h4>Результаты</h4><p>
Всего в статьях «До Пришествия Хабрастораджа» было найдено </p><a href="https://github.com/ezhikus/HabraImagesFixer/blob/master/img_info/all_images.txt">157601 картинок</a><p>, размещённых на «левых» хостингах изображений. Из них </p><a href="https://github.com/ezhikus/HabraImagesFixer/blob/master/img_info/good_images.txt">92549 ссылок</a><p> всё ещё валидны, а </p><a href="https://github.com/ezhikus/HabraImagesFixer/blob/master/img_info/bad_images.txt">65052 ссылок</a><p> — уже нет.

</p><img src="https://habrastorage.org/files/d0d/69d/197/d0d69d19772e4a50993cd06c52de6687.png"/>
<p>
Ну ок, у нас есть ссылки на 65052 недоступных картинок в статьях на Хабре. Что с этим делать? Достать их из кеша </p><a href="http://archive.org">archive.org</a><p>, конечно же! Он для того и придумывался!
</p><p>
Проверить наличие картинки в веб-архиве можно нехитрым запросом:
</p><pre><code class="bash">http://archive.org/wayback/available?url=%image_url%
</code></pre>
<p>
Например, отсутствующая в статье </p><a href="http://habrahabr.ru/post/63982/">habrahabr.ru/post/63982</a><p> ссылка на картинку </p><a href="http://img513.imageshack.us/img513/3580/pic1e.jpg">img513.imageshack.us/img513/3580/pic1e.jpg</a><p> вполне доступна по ссылке </p><a href="http://web.archive.org/web/20131103061340/http://img513.imageshack.us/img513/3580/pic1e.jpg">http://web.archive.org/web/20131103061340/http://img513.imageshack.us/img513/3580/pic1e.jpg</a>
<p>
Есть, правда, одна беда. Иногда интернет-архив утверждает, что у него имеется ссылка на закешированную картинку, а на самом деле её нет. Врёт, в общем. Т.е. нам придётся проверять и каждую ссылку на закешированную картинку. Ну, ничего, </p><a href="https://github.com/ezhikus/HabraImagesFixer/blob/master/check_webarchive.py">проверим</a><p>. 
</p><p>
Заливаем, запускаем, ждём полдня.

</p><h4>Результаты</h4><p>
В веб-архиве оказалось доступно </p><a href="https://github.com/ezhikus/HabraImagesFixer/blob/master/img_info/fixable_images.txt">13863 картинки</a><p> из тех, которые больше недоступны по оригинальным ссылкам в статьях на Хабре. 

</p><img src="https://habrastorage.org/files/2a8/759/1c7/2a87591c71b54d6b8371bec219994133.png"/>
<p>
Весь этот эксперимент дал нам неплохую «среднюю температуру по больнице»: мы теперь знаем, что у залитой на случайный хостинг картинки есть шанс около 58% уцелеть в течение следующих 2-9 лет. Ещё мы знаем, что </p><a href="https://archive.org">archive.org</a><p> штука полезная и иногда помогает, но шансы восстановить с его помощью битую ссылку на картинку на Хабре — 21.3%.

</p><h4>Выводы к первой части статьи</h4><p>
Итак, теперь у нас есть </p><a href="https://github.com/ezhikus/HabraImagesFixer/blob/master/img_info/good_images.txt">массив с ещё валидными ссылками</a><p> на картинки и </p><a href="https://github.com/ezhikus/HabraImagesFixer/blob/master/img_info/fixable_images.txt">второй массив</a><p>, с битыми ссылками и соответствующими им ссылками на доступные картинки в веб-архиве. В этом месте можно было бы попросить администрацию Хабра взять эти данные и написать 4 строки кода, чтобы перезалить это всё на habrastorage.org и обновить ссылки в имеющихся статьях, но я не знаю, будут ли они этим заниматься. А читать-то статьи в нормальном виде хочется! И поэтому мы пойдём своим путём. Можно, конечно, сказать «Читайте статьи прямо с веб-архива!», но это как-то не особо поучительно и к чему бы был весь этот сбор данных.
</p><p>
Вторым порывом может стать желание написать расширение для Хрома, подменяющие плохие ссылки на хорошие, но делать этого мне не хочется по целому ряду причин: 
</p><ul>
<li>Это не очень интересно, на Хабре уже была сотня статей о написании расширений к Хрому</li>
<li>Расширения теперь вроде бы обязательно размещать в маркете</li>
<li>Для Firefox придётся писать отдельное расширение, а с IE вообще непонятно что делать (BHO писать? Бр-р-р-р!). Ну и плюс всякие там Оперы, Вивальди, Сафари, Яндекс.браузеры и остальной зоопарк.</li>
<li>Совершенно непонятно, как это поможет в чтении с мобильного телефона или планшета</li>
</ul>
<p>
Поэтому мы пойдём другим путём и напишем кое-что, решающее все вышеуказанные проблемы. Что именно? А об этом вы узнаете из </p><a href="http://habrahabr.ru/company/infopulse/blog/251363/">следующей статьи</a><p>. 

</p><b>P.S.</b><p> Логическое разделение на две статьи добавлено для удобства чтения, поскольку использованный во второй статье метод не имеет никакого отношения к картинкам на Хабре, ну и наоборот.

</p><b>UPD.</b><p> Как верно подсказали в комментариях — нужно проверять и редиректы. Скрипт поправлен (спасибо </p><b>encyclopedist</b><p>) и прогнан заново. В результате получено ещё 10683 валидных ссылок на картинки. Файлы с новыми данными залиты на GitHub (см. ссылки в статье).

      
      </p><p class="clear"/>
    </div>

    
  </div></body></html>