<html><body><div><div class="content">
      
        <h1 class="content-title">Using peewee to explore CSV files</h1>
      
      
      
  <div class="post-info"><p>
    
    
      November 07, 2013 06:19
      </p><span class="separator">/</span>
      <a href="#comments">3 comments</a>
      <span class="separator">/</span>
      
        <a href="/blog/tags/peewee/">peewee</a>
      
        <a href="/blog/tags/python/">python</a>
      
    
  </div>
  
  
    <p>I recently heard a talk from a <a href="http://vimeo.com/79532571">coworker</a>
wherein one of the things he discussed was automatically converting CSV data
for use with a SQLite database. I thought this would be a great thing to add to
peewee, especially as lately I've found myself on several occasions working with
CSV and battling with it in a spreadsheet.  It would be much easier to load it
into a database and then query it using a tool I'm familiar with.</p>
<p>Which brings me to <code>playhouse.csv_loader</code>, a new module I've added to the
<code>playhouse</code> package of extras. It's hopefully really easy to use. Here is an
example of how you might use it:</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">playhouse.csv_loader</span> <span class="kn">import</span> <span class="o">*</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span> <span class="o">=</span> <span class="n">SqliteDatabase</span><span class="p">(</span><span class="s1">':memory:'</span><span class="p">)</span>  <span class="c1"># Create an in-memory sqlite database</span>

<span class="go"># Load the CSV file into the in-memory database and return a Model suitable</span>
<span class="go"># for querying the data.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ZipToTZ</span> <span class="o">=</span> <span class="n">load_csv</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">'zipcode_to_timezone.csv'</span><span class="p">)</span>

<span class="go"># Get the timezone for a zipcode.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ZipToTZ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ZipToTZ</span><span class="o">.</span><span class="n">zip</span> <span class="o">==</span> <span class="mi">66047</span><span class="p">)</span><span class="o">.</span><span class="n">timezone</span>
<span class="go">'US/Central'</span>

<span class="go"># Get all the zipcodes for my town.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">zip</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">ZipToTZ</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
<span class="gp">... </span>    <span class="p">(</span><span class="n">ZipToTZ</span><span class="o">.</span><span class="n">city</span> <span class="o">==</span> <span class="s1">'Lawrence'</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ZipToTZ</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s1">'KS'</span><span class="p">))]</span>
<span class="go">[66044, 66045, 66046, 66047, 66049]</span>
</pre></div>
<h3>Exploring Reddit data</h3>
<p>Chris Dary crawled reddit and grabbed the top 1,000 posts from the top 2,500
subreddits by subscriber and dumped them into CSV files.  The data can be obtained
on his GitHub page: <a href="https://github.com/umbrae/reddit-top-2.5-million">https://github.com/umbrae/reddit-top-2.5-million</a></p>
<div class="highlight"><pre>$ git clone https://github.com/umbrae/reddit-top-2.5-million reddit-data
</pre></div>
<p>Let's load up <em>all</em> the files and run some queries!  All the files are about 1.6GB
of CSV data (~2.3M rows) so it takes a few minutes to load.  I'm passing in a
parameter <code>sample_size=0</code> so that the introspector doesn't try to "introspect"
all 1000 files.  I'm also specifying <code>db_table='reddit'</code> so that all the CSV files
are read into the same table (otherwise they would be read into tables based on
their filename).  Immediately after loading the data, I'm going to print out
all the field names so we know what we're looking at:</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span> <span class="o">=</span> <span class="n">SqliteDatabase</span><span class="p">(</span><span class="s1">':memory:'</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">glob</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">csv_file</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">'reddit-data/data/*.csv'</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="s1">'Loading'</span><span class="p">,</span> <span class="n">csv_file</span>
<span class="gp">... </span>    <span class="n">R</span> <span class="o">=</span> <span class="n">load_csv</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">csv_file</span><span class="p">,</span> <span class="n">sample_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">db_table</span><span class="o">=</span><span class="s1">'reddit'</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">R</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field_names</span><span class="p">()</span>  <span class="c1"># What are the columns?</span>
<span class="go">['_auto_pk',</span>
<span class="go"> 'created_utc',</span>
<span class="go"> 'score',</span>
<span class="go"> 'domain',</span>
<span class="go"> 'id',</span>
<span class="go"> 'title',</span>
<span class="go"> 'author',</span>
<span class="go"> 'ups',</span>
<span class="go"> 'downs',</span>
<span class="go"> 'num_comments',</span>
<span class="go"> 'permalink',</span>
<span class="go"> 'selftext',</span>
<span class="go"> 'link_flair_text',</span>
<span class="go"> 'over_18',</span>
<span class="go"> 'thumbnail',</span>
<span class="go"> 'subreddit_id',</span>
<span class="go"> 'edited',</span>
<span class="go"> 'link_flair_css_class',</span>
<span class="go"> 'author_flair_css_class',</span>
<span class="go"> 'is_self',</span>
<span class="go"> 'name',</span>
<span class="go"> 'url',</span>
<span class="go"> 'distinguished']</span>
</pre></div>
<p>Here are some example queries:</p>
<div class="highlight"><pre>&gt;&gt;&gt; R.select(fn.Avg(R.ups / R.downs)).scalar()  # What is the average ratio of upvotes to downvotes?
7.438

&gt;&gt;&gt; R.select(fn.Avg(R.num_comments)).scalar()  # Average number of comments?
42.189

&gt;&gt;&gt; list(R
...     .select(R.domain, fn.Count(R.id))
...     .group_by(R.domain)
...     .order_by(fn.Count(R.id).desc())
...     .limit(10)
...     .tuples())  # Top 10 domains for links?
[(u'i.imgur.com', 478656),
 (u'imgur.com', 295313),
 (u'youtube.com', 172186),
 (u'reddit.com', 25445),
 (u'flickr.com', 17854),
 (u'youtu.be', 16340),
 (u'soundcloud.com', 10397),
 (u'quickmeme.com', 9561),
 (u'i.minus.com', 8549),
 (u'twitter.com', 7611)]
</pre></div>
<p>As I hope you see, it is very easy to start exploring the data if you're familiar
with SQL.  If you're not very familiar with SQL, there are <em>tons</em> of resources
online for learning.</p>
<h3>Check it out</h3>
<p>This is a very new feature so there may be some rough edges, but I hope that
this may help your work with CSV go more smoothly.  For details check out the <a href="http://docs.peewee-orm.com/en/latest/peewee/playhouse.html#csv-loader">documentation</a>.</p>
<p>If you're new to peewee, I hope this has piqued your interest!  There are a lot of
interesting free data-sets out there, here are some links to get you started:</p>

<p>Happy hacking, please feel free to leave any questions or comments <a href="#comments">below</a>!
If you're interested in learning more about peewee check the docs:  <a href="http://docs.peewee-orm.com/">http://docs.peewee-orm.com/</a></p>
<p>Lastly, if you're really interested in exploring data with python, I would highly
suggest looking into the <a href="http://pandas.pydata.org/">pandas</a> library.  I'd also
suggest <a href="http://ipython.org/notebook.html">iPython notebook</a>, which is a web
frontend for iPython (the improved python shell) that has integrated support
for matplotlib and markdown-formatted text.</p>
<p>Thanks for reading!  As a reward for making it this far, here's a picture of my cat Huey:</p>
<p><a href="http://media.charlesleifer.com/blog/photos/2013-10-13_15.41.11.jpg" title="Huey nap"><img alt="Huey nap" class="img-responsive" src="http://m.charlesleifer.com/t/800x-/blog/photos/2013-10-13_15.41.11.jpg?key=lBmrtNBVX1cUWDPUW32etQ"/></a></p>
  
  

  
  
  

  
  
  

  
  
  


<hr/>

  <p>Commenting has been closed, but please feel free to <a href="/contact/">contact me</a></p>


    </div>

    </div></body></html>