<html><body><div><div class="entry-content clearfix"><p><img src="https://raw.githubusercontent.com/realpython/twitter-sentiment-elasticsearch/master/images/overall-pie-chart.png" alt="kibana-pie-chart"/></p>

<p>In this example, we’ll connect to the Twitter Streaming API, gather tweets (based on a keyword), calculate the sentiment of each tweet, and build a real-time dashboard using the Elasticsearch DB and Kibana to visualize the results.</p>

<blockquote><p>Tools: <a href="https://www.docker.com/">Docker</a> v1.3.0, <a href="http://boot2docker.io/">boot2docker</a> v1.3.0, <a href="http://www.tweepy.org/">Tweepy</a> v2.3.0, <a href="http://textblob.readthedocs.org/en/dev/">TextBlob</a> v0.9.0, <a href="http://www.elasticsearch.org/">Elasticsearch</a> v1.3.5, <a href="http://www.elasticsearch.org/overview/kibana/">Kibana</a> v3.1.2</p></blockquote>

<a name="Docker.Environment"/>
<h2>Docker Environment</h2>

<p>Follow the <a href="https://docs.docker.com/installation/mac/">official Docker documentation</a> to install both Docker and boot2docker. Then with boot2docker up and running, run <code>docker version</code> to test the Docker installation. Create a directory to house your project, grab the Dockerfile from the <a href="https://github.com/realpython/twitter-sentiment-elasticsearch">repository</a>, and build the image:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>docker build -rm -t<span class="o">=</span>elasticsearch-kibana .
</span></code></pre></td></tr></table></div></figure>


<p>Once built, run the container:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>docker run -d -p 8000:8000 -p 9200:9200 elasticsearch-kibana
</span></code></pre></td></tr></table></div></figure>


<p>Finally, run the next two commands in new terminal windows to map the IP address/port combo used by the boot2docker VM to your localhost:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>boot2docker ssh -L8000:localhost:8000
</span><span class="line"><span class="nv">$ </span>boot2docker ssh -L9200:localhost:9200
</span></code></pre></td></tr></table></div></figure>


<p>Now you can access Elasticsearch at <a href="http://localhost:9200">http://localhost:9200</a> and Kibana at <a href="http://localhost:8000">http://localhost:8000</a>.</p>

<a name="Twitter.Streaming.API"/>
<h2>Twitter Streaming API</h2>

<p>In order to access the <a href="https://dev.twitter.com/streaming/overview">Twitter Streaming API</a>, you need to register an application at <a href="http://apps.twitter.com">http://apps.twitter.com</a>. Once created, you should be redirected to your app’s page, where you can get the consumer key and consumer secret and create an access token under the “Keys and Access Tokens” tab. Add these to a new file called <em>config.py</em>:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">consumer_key</span> <span class="o">=</span> <span class="s">"add_your_consumer_key"</span>
</span><span class="line"><span class="n">consumer_secret</span> <span class="o">=</span> <span class="s">"add_your_consumer_secret"</span>
</span><span class="line"><span class="n">access_token</span> <span class="o">=</span> <span class="s">"add_your_access_token"</span>
</span><span class="line"><span class="n">access_token_secret</span> <span class="o">=</span> <span class="s">"add_your_access_token_secret"</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Since this file contains sensitive information do <strong>not</strong> add it to your Git repository.</p></blockquote>

<p>According to the Twitter Streaming <a href="https://dev.twitter.com/streaming/overview/connecting">documentation</a>, “establishing a connection to the streaming APIs means making a very long lived HTTP request, and parsing the response incrementally. Conceptually, you can think of it as downloading an infinitely long file over HTTP.”</p>

<p>So, you make a request, filter it by a specific keyword, user, and/or geographic area and then leave the connection open, collecting as many tweets as possible.</p>

<p>This sounds complicated, but <a href="http://www.tweepy.org/">Tweepy</a> makes it easy.</p>

<a name="Tweepy.Listener"/>
<h2>Tweepy Listener</h2>

<p>Tweepy uses a “listener” to not only grab the streaming tweets, but filter them as well.</p>

<a name="The.code"/>
<h3>The code</h3>

<p>Save the following code as <em>sentiment.py</em>:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">import</span> <span class="nn">json</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">tweepy.streaming</span> <span class="kn">import</span> <span class="n">StreamListener</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">tweepy</span> <span class="kn">import</span> <span class="n">OAuthHandler</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">tweepy</span> <span class="kn">import</span> <span class="n">Stream</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">textblob</span> <span class="kn">import</span> <span class="n">TextBlob</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">elasticsearch</span> <span class="kn">import</span> <span class="n">Elasticsearch</span>
</span><span class="line">
</span><span class="line"><span class="c"># import twitter keys and tokens</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class="line">
</span><span class="line"><span class="c"># create instance of elasticsearch</span>
</span><span class="line"><span class="n">es</span> <span class="o">=</span> <span class="n">Elasticsearch</span><span class="p">()</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">TweetStreamListener</span><span class="p">(</span><span class="n">StreamListener</span><span class="p">):</span>
</span><span class="line">
</span><span class="line">    <span class="c"># on success</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">on_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span class="line">
</span><span class="line">        <span class="c"># decode json</span>
</span><span class="line">        <span class="n">dict_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">        <span class="c"># pass tweet into TextBlob</span>
</span><span class="line">        <span class="n">tweet</span> <span class="o">=</span> <span class="n">TextBlob</span><span class="p">(</span><span class="n">dict_data</span><span class="p">[</span><span class="s">"text"</span><span class="p">])</span>
</span><span class="line">
</span><span class="line">        <span class="c"># output sentiment polarity</span>
</span><span class="line">        <span class="k">print</span> <span class="n">tweet</span><span class="o">.</span><span class="n">sentiment</span><span class="o">.</span><span class="n">polarity</span>
</span><span class="line">
</span><span class="line">        <span class="c"># determine if sentiment is positive, negative, or neutral</span>
</span><span class="line">        <span class="k">if</span> <span class="n">tweet</span><span class="o">.</span><span class="n">sentiment</span><span class="o">.</span><span class="n">polarity</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span class="line">            <span class="n">sentiment</span> <span class="o">=</span> <span class="s">"negative"</span>
</span><span class="line">        <span class="k">elif</span> <span class="n">tweet</span><span class="o">.</span><span class="n">sentiment</span><span class="o">.</span><span class="n">polarity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span class="line">            <span class="n">sentiment</span> <span class="o">=</span> <span class="s">"neutral"</span>
</span><span class="line">        <span class="k">else</span><span class="p">:</span>
</span><span class="line">            <span class="n">sentiment</span> <span class="o">=</span> <span class="s">"positive"</span>
</span><span class="line">
</span><span class="line">        <span class="c"># output sentiment</span>
</span><span class="line">        <span class="k">print</span> <span class="n">sentiment</span>
</span><span class="line">
</span><span class="line">        <span class="c"># add text and sentiment info to elasticsearch</span>
</span><span class="line">        <span class="n">es</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s">"sentiment"</span><span class="p">,</span>
</span><span class="line">                 <span class="n">doc_type</span><span class="o">=</span><span class="s">"test-type"</span><span class="p">,</span>
</span><span class="line">                 <span class="n">body</span><span class="o">=</span><span class="p">{</span><span class="s">"author"</span><span class="p">:</span> <span class="n">dict_data</span><span class="p">[</span><span class="s">"user"</span><span class="p">][</span><span class="s">"screen_name"</span><span class="p">],</span>
</span><span class="line">                       <span class="s">"date"</span><span class="p">:</span> <span class="n">dict_data</span><span class="p">[</span><span class="s">"created_at"</span><span class="p">],</span>
</span><span class="line">                       <span class="s">"message"</span><span class="p">:</span> <span class="n">dict_data</span><span class="p">[</span><span class="s">"text"</span><span class="p">],</span>
</span><span class="line">                       <span class="s">"polarity"</span><span class="p">:</span> <span class="n">tweet</span><span class="o">.</span><span class="n">sentiment</span><span class="o">.</span><span class="n">polarity</span><span class="p">,</span>
</span><span class="line">                       <span class="s">"subjectivity"</span><span class="p">:</span> <span class="n">tweet</span><span class="o">.</span><span class="n">sentiment</span><span class="o">.</span><span class="n">subjectivity</span><span class="p">,</span>
</span><span class="line">                       <span class="s">"sentiment"</span><span class="p">:</span> <span class="n">sentiment</span><span class="p">})</span>
</span><span class="line">        <span class="k">return</span> <span class="bp">True</span>
</span><span class="line">
</span><span class="line">    <span class="c"># on failure</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">on_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
</span><span class="line">        <span class="k">print</span> <span class="n">status</span>
</span><span class="line">
</span><span class="line"><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
</span><span class="line">
</span><span class="line">    <span class="c"># create instance of the tweepy tweet stream listener</span>
</span><span class="line">    <span class="n">listener</span> <span class="o">=</span> <span class="n">TweetStreamListener</span><span class="p">()</span>
</span><span class="line">
</span><span class="line">    <span class="c"># set twitter keys/tokens</span>
</span><span class="line">    <span class="n">auth</span> <span class="o">=</span> <span class="n">OAuthHandler</span><span class="p">(</span><span class="n">consumer_key</span><span class="p">,</span> <span class="n">consumer_secret</span><span class="p">)</span>
</span><span class="line">    <span class="n">auth</span><span class="o">.</span><span class="n">set_access_token</span><span class="p">(</span><span class="n">access_token</span><span class="p">,</span> <span class="n">access_token_secret</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="c"># create instance of the tweepy stream</span>
</span><span class="line">    <span class="n">stream</span> <span class="o">=</span> <span class="n">Stream</span><span class="p">(</span><span class="n">auth</span><span class="p">,</span> <span class="n">listener</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="c"># search twitter for "congress" keyword</span>
</span><span class="line">    <span class="n">stream</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">track</span><span class="o">=</span><span class="p">[</span><span class="s">'congress'</span><span class="p">])</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>What’s happening?</strong>:</p>

<ol>
<li>We connect to the Twitter Streaming API;</li>
<li>Filter the data by the keyword <code>"congress"</code>;</li>
<li>Decode the results (the tweets);</li>
<li>Calculate sentiment analysis via <a href="http://textblob.readthedocs.org/en/dev/">TextBlob</a>;</li>
<li>Determine if the overall sentiment is positive, negative, or neutral; and,</li>
<li>Finally the relevant sentiment and tweet data is added to the Elasticsearch DB.</li>
</ol>


<p>Follow the inline comments for further details.</p>

<a name="TextBlob.sentiment.basics"/>
<h3>TextBlob sentiment basics</h3>

<p>To calculate the overall sentiment, we look at the <a href="http://textblob.readthedocs.org/en/latest/_modules/textblob/blob.html#BaseBlob.polarity">polarity</a> score:</p>

<ol>
<li>Positive – <em>from .01 to 1</em></li>
<li>Neutral – <em>0</em></li>
<li>Negative – <em>from –.01 to -1</em></li>
</ol>


<blockquote><p>Refer to the <a href="http://textblob.readthedocs.org/en/dev/">official documentation</a> for more information on how TextBlob calculates sentiment.</p></blockquote>

<a name="Elasticsearch.Analysis"/>
<h2>Elasticsearch Analysis</h2>

<p>Over a two hour period, as I wrote this blog post, I pulled over 9,500 tweets with the keyword “congress”. At this point go ahead and perform a search of your own, on a subject of interest to you. Once you have a sizable number of tweets, stop the script. Now you can perform some quick searches/analysis…</p>

<p>Using the index (<code>"sentiment"</code>) from the <em>sentiment.py</em> script, you can use the <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/search-search.html">Elasticsearch search API</a> to gather some basic insights.</p>

<p>For example:</p>




<p>There’s much, <em>much</em> more you can do with Elasticsearch besides just searching and filtering results. Check out the <a href="http://www.elasticsearch.org/guide/en/elasticsearch/guide/current/analysis-intro.html">Analyze API</a> as well as the <a href="http://www.elasticsearch.org/guide/en/elasticsearch/guide/current/index.html">Elasticsearch – The Definitive Guide</a> for more ideas on how to analyze and model your data.</p>

<a name="Kibana.Visualizer"/>
<h2>Kibana Visualizer</h2>

<p><a href="http://www.elasticsearch.org/overview/kibana/">Kibana</a> lets “you see and interact with your data” in realtime, as you’re gathering data. Since it’s written in JavaScript, you access it directly from your browser. Check out the basics from the <a href="http://www.elasticsearch.org/guide/en/kibana/current/_introduction.html">official introduction</a> to quickly get started.</p>

<p>The pie chart at the top of this post came direct from Kibana, which shows the proportion of each sentiment – positive, neutral, and negative – to the whole from the tweets I pulled. Here’s a few more graphs from Kibana…</p>

<p><em>All tweets filtered by the word “obama”</em></p>

<p><img src="https://raw.githubusercontent.com/realpython/twitter-sentiment-elasticsearch/master/images/obama-pie-chart.png" alt="kibana-obama-pie-chart"/></p>

<p><em>Top twitter users by tweet count</em></p>

<p><img src="https://raw.githubusercontent.com/realpython/twitter-sentiment-elasticsearch/master/images/top-authors.png" alt="top-authors"/></p>

<blockquote><p>Notice how the top author as 76 tweets. That’s definitely worthy of a deeper look since that’s a lot of tweets in a two hour period. Anyway, that author basically tweeted the same tweet 76 times – so you would want to filter out 75 of these since the overall results are currently skewed.</p></blockquote>

<p>Aside for these charts, it’s worth visualizing sentiment by location. Try this on your own. You’ll have to alter the data you are grabbing from each tweet. You may also want to try visualizing the data with a histogram as well.</p>

<p>Finally –</p>

<ol>
<li>Grab the code from the <a href="https://github.com/realpython/twitter-sentiment-elasticsearch">repository</a>.</li>
<li>Leave comments/questions below.</li>
</ol>


<p><strong>Cheers!</strong></p>
</div>


      </div></body></html>