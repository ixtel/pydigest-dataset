<html><body><div><div itemprop="articleBody">
      <p>When you write a blog post, people of Internet will point out any mistakes
they find. It’s a great opportunity to improve existing code and look into other
solutions. After posting <a href="/2014/11/04/the-tale-of-dry-with-django-crispy-forms/">The tale of DRY with django-crispy-forms</a>
I found out about <a href="https://github.com/funkybob/formulation">formulation</a> -
a template-based solution for rendering forms, in contrast to crispy-forms that
builds the form structure in code.</p>

<p>Also <a href="https://twitter.com/maraujop">@maraujop</a> – crispy-forms developer – made
several very helpful suggestions in the comments area, which brings us to Part II.</p>

<h3 id="mistakes-of-the-past">Mistakes of the past</h3>

<p>The story of Foo people can be found in this <a href="/2014/11/04/the-tale-of-dry-with-django-crispy-forms/">archive</a>.
Their end was tragic. They knew truth was somewhere close, but they were unable
to grasp it to its fullest and failed to survive this cruel software world.</p>

<p><code class="highlighter-rouge">FooForm</code>s had their <code class="highlighter-rouge">__init__</code> cluttered with the initialization
of a <code class="highlighter-rouge">FormHelper</code> object and the attachment of  the <code class="highlighter-rouge">SubmitCancelFormActions</code>.
Nothing bad with <code class="highlighter-rouge">SubmitCancelFormActions</code> itself, but as they grew in number
overriding the initialization started to look silly.</p>

<p>Decline of Foo marked the birth of powerful Bar people.</p>



<figure>
	<a href="/assets/img/dry-tale-2/laputa.jpg">
		<img src="/assets/img/dry-tale-2/laputa.jpg" alt="Laputa: Castle in the Sky (Ghibli Studio) - How I imagine the fairy tale kingdoms"/>
	</a>
<figcaption>
    Laputa: Castle in the Sky (Ghibli Studio) - How I imagine the fairy tale kingdoms
</figcaption>
</figure>

<h3 id="reforms">Reforms</h3>

<p>Assume that Bar model, view and template are similar to Foo. Bar people knew
they should start with the API, and so they shaped their dreams first.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># fairytale/characters/forms.py</span>
<span class="kn">from</span> <span class="nn">characters.models</span> <span class="kn">import</span> <span class="n">Bar</span>
<span class="kn">from</span> <span class="nn">common.forms</span> <span class="kn">import</span> <span class="n">ModelFormWithHelper</span>
<span class="kn">from</span> <span class="nn">common.helpers</span> <span class="kn">import</span> <span class="n">SubmitCancelFormHelper</span>


<span class="k">class</span> <span class="nc">BarForm</span><span class="p">(</span><span class="n">ModelFormWithHelper</span><span class="p">):</span>
    <span class="s">"""Model Bar form"""</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Bar</span>
        <span class="n">helper_class</span> <span class="o">=</span> <span class="n">SubmitCancelFormHelper</span>
        <span class="n">helper_cancel_href</span> <span class="o">=</span> <span class="s">"{</span><span class="si">% </span><span class="s">url 'some_cancel_url' </span><span class="si">%</span><span class="s">}"</span></code></pre></figure>

<p>What Bar wants is to declare an alternative <code class="highlighter-rouge">FormHelper</code>, which is responsible
for customizing the form. Also it wants to provide helper attributes, that are different
for each form - the cancel URL, for example.</p>

<p>There are 2 unknown creatures here - <code class="highlighter-rouge">SubmitCancelFormHelper</code> and <code class="highlighter-rouge">ModelFormWithHelper</code>.</p>

<p><code class="highlighter-rouge">SubmitCancelFormHelper</code> as you might have guessed is of <code class="highlighter-rouge">FormHelper</code> breed. It
tells you right to the face that it appends to the layout submit and cancel buttons.
See for yourself.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># fairytale/common/helpers.py</span>
<span class="kn">from</span> <span class="nn">crispy_forms.bootstrap</span> <span class="kn">import</span> <span class="n">FormActions</span>
<span class="kn">from</span> <span class="nn">crispy_forms.helper</span> <span class="kn">import</span> <span class="n">FormHelper</span><span class="p">,</span> <span class="n">Layout</span>
<span class="kn">from</span> <span class="nn">crispy_forms.layout</span> <span class="kn">import</span> <span class="n">Submit</span><span class="p">,</span> <span class="n">HTML</span>


<span class="k">class</span> <span class="nc">SubmitCancelFormHelper</span><span class="p">(</span><span class="n">FormHelper</span><span class="p">):</span>
    <span class="s">"""Custom FormHelper that appends to the layout cancel and submit
    buttons (works only with bootstrap crispy-forms pack). It expects a
    `cancel_href` attribute to be used as cancel button URL.

    Example::

        SubmitCancelFormHelper(self, cancel_href="/some/url/")
    """</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">cancel_href</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">'cancel_href'</span><span class="p">,</span> <span class="s">'#'</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SubmitCancelFormHelper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">Layout</span><span class="p">(</span>
                <span class="n">FormActions</span><span class="p">(</span>
                    <span class="n">HTML</span><span class="p">(</span><span class="s">"""&lt;a role="button" class="btn btn-default mr4"
                            href="{0}"&gt;Cancel&lt;/a&gt;"""</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cancel_href</span><span class="p">)),</span>
                    <span class="n">Submit</span><span class="p">(</span><span class="s">'save'</span><span class="p">,</span> <span class="s">'Submit'</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span></code></pre></figure>

<p>This class expects a <code class="highlighter-rouge">cancel_href</code> named parameter. Afterwards it takes
advantage of the power it was given by <code class="highlighter-rouge">FormHelper</code> and modifies the layout by
appending a button that we represent using HTML widget and a Submit widget.
<code class="highlighter-rouge">SubmitCancelFormHelper</code> serves us well.</p>

<p>What about <code class="highlighter-rouge">ModelFormWithHelper</code> mystery. This base class is a bit more tricky,
but still nothing out of this world.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># fairytale/common/helpers.py</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">ImproperlyConfigured</span>
<span class="kn">from</span> <span class="nn">django.forms</span> <span class="kn">import</span> <span class="n">ModelForm</span>


<span class="k">class</span> <span class="nc">ModelFormWithHelper</span><span class="p">(</span><span class="n">ModelForm</span><span class="p">):</span>
    <span class="s">"""Custom ModelForm that allows to attach a crispy-forms FormHelper class,
    that will modify in some way the rendering of the layout.

    Example::

        FooForm(ModelFormWithHelper):
            class Meta:
                model = FooModel
                helper_class = FooFormHelper
    """</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ModelFormWithHelper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Meta</span><span class="p">,</span> <span class="s">"helper_class"</span><span class="p">):</span>
            <span class="n">helper_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Meta</span><span class="p">,</span> <span class="s">"helper_class"</span><span class="p">)</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_helper_kwargs</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">helper</span> <span class="o">=</span> <span class="n">helper_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span>
                <span class="s">"{0} is missing a 'helper_class' meta attribute."</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_helper_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Get all helper attributes from class Meta by stripping them of
        `helper_` part of attribute string

        :return: dict with helper kwargs
        """</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Meta</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">"helper_"</span><span class="p">)</span> <span class="ow">and</span> <span class="n">attr</span> <span class="o">!=</span> <span class="s">"helper_class"</span><span class="p">:</span>
                <span class="n">new_attr</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">"_"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">new_attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">kwargs</span></code></pre></figure>

<p>Ohh, that’s a lot of code. Well, docstrings make it 1/3 of the listing. Let’s
see what <code class="highlighter-rouge">ModelFormWithHelper</code> is trying to tell us.</p>

<p>In the initialization phase it checks if the class
has a <code class="highlighter-rouge">helper_class</code> attribute. It’s mandatory to be there, otherwise there’s
no point in using this class at all. If there isn’t, <code class="highlighter-rouge">ModelFormWithHelper</code> will
throw an exception to remind you, <em>Hey, you forgot that attribute - helper_class!</em>
Otherwise, it will initialize the form helper class and attach it
to <code class="highlighter-rouge">self.helper</code>. But before that it extracts the helper kwargs.</p>

<p>Look at the dream <code class="highlighter-rouge">BarForm</code> class. Bar people wanted to have a custom cancel URL
and used a meta attribute <code class="highlighter-rouge">helper_cancel_href</code>. Method <code class="highlighter-rouge">get_helper_kwargs()</code> deals
with all the <code class="highlighter-rouge">helper_</code> attributes and strips them of that prefix to ultimately
feed them to the helper.</p>

<p>The class is not tied to any specific form helper, so you can create as many custom
form helpers as your kingdom needs.</p>

<p>That’s it. Now forms will become more compact and readable due to the new meta
attributes.</p>


    </div>
    </div></body></html>