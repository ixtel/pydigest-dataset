<html><body><div><div class="clearfix entry-content">
		<p>In a previous post I showed you how to <a href="http://willmcginnis.com/2015/11/08/getting-started-with-python-and-apache-flink/">get started with pyflink</a>, but now that the proper release is out, I thought I would do a follow up post with v0.10.1, and some more complicated examples.</p>
<p>To start out with, as before, pull down and build flink from github.</p>
<pre class="EnlighterJSRAW" data-enlighter-language="shell"> git clone https://github.com/apache/flink
 cd flink
 mvn clean install -DskipTests</pre>
<p>At this point the bleeding edge Flink build will be symlinked at build-target in the flink directory.  You can start up Flink with the commands.</p>
<pre class="EnlighterJSRAW" data-enlighter-language="shell">./build-target/bin/start-local.sh</pre>
<p>You can right away see a difference from the older versions by checking out the new jobmanager UI at localhost:8081, which is much more fully featured and overall pretty than before.  It will dynamically update, without having to manually refresh, and also seems to keep the data for completed jobs out of the box.  If you've ever debugged a spark issue through their UI, you'll probably appreciate these two little features.</p>
<p>Anyway, in the first post we started with a really simple <a href="https://github.com/wdm0006/flink-python-examples/blob/master/word_count/word_count.py">word count example</a>. In this post, I am going to present a few more complicated examples, and talk a little bit about how to run them in a more programatic way.</p>
<h4>Runner</h4>
<p>Pyflink functions are required to be of a certain format. They have to be set up in a main block, and can have some arguments passed in as runtime parameters.  This differs from how you would setup a SparkContext, for instance, where you can instantiate it pretty much anywhere.  As an example:</p>
<pre class="EnlighterJSRAW" data-enlighter-language="python">import os
import sys
from flink.plan.Environment import get_environment
from flink.plan.Constants import INT, STRING, WriteMode
from flink.functions.GroupReduceFunction import GroupReduceFunction

if __name__ == "__main__":
# get the base path out of the runtime params
args = sys.argv[1:]

# set up the environment with a source (in this case from a text file
env = get_environment()
data = env.read_text('foo')

# build the job flow
data
.map(lambda x: x, STRING)
.write_csv('bar', line_delimiter='n', field_delimiter=',')

# execute
env.execute(local=True)</pre>
<p>This code must then be called using the pyflink{2 or 3}.sh script, and the arguments must be passed in there:</p>
<pre class="EnlighterJSRAW" data-enlighter-language="shell">pyflink3.sh example.py foo bar baz</pre>
<p>So to integrate the pyflink job into a larger python system, we need to invoke this call via python. On top of this, the job itself is passed into flink in such a way that it's location on the drive is changed.  So any file reading or writing that uses os.path to find a relative directory will fail, so we need to at a minimum pass in a base path as an argument.</p>
<p>To solve these two issues, I've added a runner.py script into my <a href="https://github.com/wdm0006/flink-python-examples">examples repository</a>.  In that, we encapsulate the systems calls into python functions and pass in the base path for the project so that the input and output files can actually be found by flink.</p>
<h4>Examples</h4>
<p>As for examples, we have 4 new ones.  After a quick explanation, we will look at the resulting Flink plan generated in the UI.</p>
<h6>Trending Hashtags</h6>
<p>A very similar example to word count, but includes a filter step to only include hashtags, and different source/sinks. The input data in this case is read off of disk, and the output is written as a csv. The file is generated dynamically at run time, so you can play with different volumes of tweets to get an idea of Flink's scalability and performance.</p>
<h6><a href="http://i0.wp.com/www.willmcginnis.com/wp-content/uploads/2015/12/trending_hashtags_plan.png" rel="attachment wp-att-171"><img class="aligncenter size-full wp-image-171" src="http://i0.wp.com/www.willmcginnis.com/wp-content/uploads/2015/12/trending_hashtags_plan.png?resize=640%2C145" alt="trending_hashtags_plan" srcset="http://i0.wp.com/www.willmcginnis.com/wp-content/uploads/2015/12/trending_hashtags_plan.png?resize=300%2C68 300w, http://i0.wp.com/www.willmcginnis.com/wp-content/uploads/2015/12/trending_hashtags_plan.png?resize=768%2C174 768w, http://i0.wp.com/www.willmcginnis.com/wp-content/uploads/2015/12/trending_hashtags_plan.png?w=929 929w" sizes="(max-width: 730px) 100vw, 730px" data-recalc-dims="1"/></a></h6>
<h6>Data Enrichment</h6>
<p>In this example, we have row-wise json in one file, with an attribute field that refers to a csv dimension table with colors. So we load both datasets in, convert the json data into a ordered and typed tuple, and join then two together to get a nice dataset of cars and their colors.</p>
<p><a href="http://i2.wp.com/www.willmcginnis.com/wp-content/uploads/2015/12/data_enrichment_plan.png" rel="attachment wp-att-172"><img class="aligncenter size-full wp-image-172" src="http://i2.wp.com/www.willmcginnis.com/wp-content/uploads/2015/12/data_enrichment_plan.png?resize=640%2C219" alt="data_enrichment_plan" srcset="http://i2.wp.com/www.willmcginnis.com/wp-content/uploads/2015/12/data_enrichment_plan.png?resize=300%2C103 300w, http://i2.wp.com/www.willmcginnis.com/wp-content/uploads/2015/12/data_enrichment_plan.png?resize=768%2C263 768w, http://i2.wp.com/www.willmcginnis.com/wp-content/uploads/2015/12/data_enrichment_plan.png?w=819 819w" sizes="(max-width: 730px) 100vw, 730px" data-recalc-dims="1"/></a></p>
<h6>Mean Values</h6>
<p>Takes in a csv with two columns and finds the mean of each column, using a custom reducer function. Afterwards, it formats a string nicely with the output and dumps that onto disk.</p>
<h6><a href="http://i2.wp.com/www.willmcginnis.com/wp-content/uploads/2015/12/mean_values_plan.png" rel="attachment wp-att-173"><img class="aligncenter size-full wp-image-173" src="http://i2.wp.com/www.willmcginnis.com/wp-content/uploads/2015/12/mean_values_plan.png?resize=640%2C120" alt="mean_values_plan" srcset="http://i2.wp.com/www.willmcginnis.com/wp-content/uploads/2015/12/mean_values_plan.png?resize=300%2C56 300w, http://i2.wp.com/www.willmcginnis.com/wp-content/uploads/2015/12/mean_values_plan.png?resize=768%2C144 768w, http://i2.wp.com/www.willmcginnis.com/wp-content/uploads/2015/12/mean_values_plan.png?w=883 883w" sizes="(max-width: 730px) 100vw, 730px" data-recalc-dims="1"/></a></h6>
<h6>Mandelbrot Set</h6>
<p>Creates a Mandelbrot set from a set of candidates. Inspired by <a href="http://1oclockbuzz.com/2015/11/24/pyspark-and-the-mandelbrot-set-overkill-indeed/">this post</a>.</p>
<p><a href="http://i2.wp.com/www.willmcginnis.com/wp-content/uploads/2015/12/mandelbrot_plan.png" rel="attachment wp-att-174"><img class="aligncenter size-full wp-image-174" src="http://i2.wp.com/www.willmcginnis.com/wp-content/uploads/2015/12/mandelbrot_plan.png?resize=440%2C152" alt="mandelbrot_plan" srcset="http://i2.wp.com/www.willmcginnis.com/wp-content/uploads/2015/12/mandelbrot_plan.png?resize=300%2C104 300w, http://i2.wp.com/www.willmcginnis.com/wp-content/uploads/2015/12/mandelbrot_plan.png?w=440 440w" sizes="(max-width: 440px) 100vw, 440px" data-recalc-dims="1"/></a></p>
<p>So there you have it, with a little bit of tooling, and the new release, you can use python to do some pretty cool things on huge datasets, very fast.  If you'd like to see the source or contribute, this is all at:</p>
<p><a href="https://github.com/wdm0006/flink-python-examples">https://github.com/wdm0006/flink-python-examples</a></p>
<p> </p>
<p> </p>
<p> </p>
<p> </p>
<div class="sharedaddy sd-block sd-like jetpack-likes-widget-wrapper jetpack-likes-widget-unloaded" id="like-post-wrapper-104419944-169-56d5a03326981" data-src="//widgets.wp.com/likes/#blog_id=104419944&amp;post_id=169&amp;origin=www.willmcginnis.com&amp;obj_id=104419944-169-56d5a03326981" data-name="like-post-frame-104419944-169-56d5a03326981"><h3 class="sd-title">Like this:</h3><p class="likes-widget-placeholder post-likes-widget-placeholder"><span class="button"><span>Like</span></span> <span class="loading">Loading...</span></p><span class="sd-text-color"/><a class="sd-link-color"/></div>
<p id="jp-relatedposts" class="jp-relatedposts">
	<h3 class="jp-relatedposts-headline"><em>Related</em></h3>
</p>			</div>

	</div></body></html>