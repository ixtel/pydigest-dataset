<html><body><div><div class="section" id="introduction">
<h2>Introduction</h2>
<p>Waterfall charts can be a really useful tool to for certain types of data plotting.
Not surprisingly, we can use pandas and matplotlib to create a repeatable waterfall chart.</p>
<p>Before I go any further, I want to level set with everyone about which type of chart I’m referring to.
I will be building a 2-D waterfall chart described in this <a class="reference external" href="http://en.wikipedia.org/wiki/Waterfall_chart">wikipedia article</a>.</p>
<p>A fairly typical use for a chart such as this is to show what the + and - values
are that “bridge” between a start and end value. For this reason, finance folks will sometimes refer to this as a bridge.
Like the other examples I’ve used, this type of plot is not easy to generate in Excel. There
are certainly ways to do it but it is not easy to remember.</p>
<p>The key thing to keep in mind with a waterfall chart is: at its heart it is
a stacked bar chart. The “special sauce” is that you have a blank bottom bar so the top bar “floats”
in space. Let’s get started.</p>
</div>
<div class="section" id="creating-the-chart">
<h2>Creating the Chart</h2>
<p>Execute the standard imports and make sure IPython will display matplot plots.</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
</pre></div>

<p>Setup the data we want to waterfall chart and load it into a dataframe.</p>
<p>The data needs to start with your starting value but you leave out the final total. We will calculate it.</p>
<div class="highlight"><pre><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s">'sales'</span><span class="p">,</span><span class="s">'returns'</span><span class="p">,</span><span class="s">'credit fees'</span><span class="p">,</span><span class="s">'rebates'</span><span class="p">,</span><span class="s">'late charges'</span><span class="p">,</span><span class="s">'shipping'</span><span class="p">]</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">'amount'</span><span class="p">:</span> <span class="p">[</span><span class="mi">350000</span><span class="p">,</span><span class="o">-</span><span class="mi">30000</span><span class="p">,</span><span class="o">-</span><span class="mi">7500</span><span class="p">,</span><span class="o">-</span><span class="mi">25000</span><span class="p">,</span><span class="mi">95000</span><span class="p">,</span><span class="o">-</span><span class="mi">7000</span><span class="p">]}</span>
<span class="n">trans</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
</pre></div>
<p>I am using the handy <code class="code">
display</code>
 function in IPython to make it easier to control what I want to display.</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>
<span class="n">display</span><span class="p">(</span><span class="n">trans</span><span class="p">)</span>
</pre></div>
<div>
<table border="1" class="dataframe">
<thead>
<tr>
<th/>
<th>amount</th>
</tr>
</thead>
<tbody>
<tr>
<th>sales</th>
<td> 350000</td>
</tr>
<tr>
<th>returns</th>
<td> -30000</td>
</tr>
<tr>
<th>credit fees</th>
<td>  -7500</td>
</tr>
<tr>
<th>rebates</th>
<td> -25000</td>
</tr>
<tr>
<th>late charges</th>
<td>  95000</td>
</tr>
<tr>
<th>shipping</th>
<td>  -7000</td>
</tr>
</tbody>
</table>
</div><p>The biggest trick with a waterfall plot is figuring out what the bottom
stacked bar chart should be. I learned a lot from this <a class="reference external" href="http://stackoverflow.com/questions/11209646/waterfall-plot-python">stackoverflow discussion</a></p>
<p>First, let’s get the cumulative sum.</p>
<div class="highlight"><pre><span class="n">display</span><span class="p">(</span><span class="n">trans</span><span class="o">.</span><span class="n">amount</span><span class="o">.</span><span class="n">cumsum</span><span class="p">())</span>
</pre></div>
<pre class="literal-block">
sales           350000
returns         320000
credit fees     312500
rebates         287500
late charges    382500
shipping        375500
Name: amount, dtype: int64
</pre>
<p>This looks good but we need to shift the data one place to the right.</p>
<div class="highlight"><pre><span class="n">blank</span><span class="o">=</span><span class="n">trans</span><span class="o">.</span><span class="n">amount</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">blank</span><span class="p">)</span>
</pre></div>
<pre class="literal-block">
sales                0
returns         350000
credit fees     320000
rebates         312500
late charges    287500
shipping        382500
Name: amount, dtype: float64
</pre>
<p>We need to add a net total amount to the <code class="code">
trans</code>
 and <code class="code">
blank</code>
 dataframe.</p>
<div class="highlight"><pre><span class="n">total</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">amount</span>
<span class="n">trans</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s">"net"</span><span class="p">]</span> <span class="o">=</span> <span class="n">total</span>
<span class="n">blank</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s">"net"</span><span class="p">]</span> <span class="o">=</span> <span class="n">total</span>
<span class="n">display</span><span class="p">(</span><span class="n">trans</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">blank</span><span class="p">)</span>
</pre></div>
<div>
<table border="1" class="dataframe">
<thead>
<tr>
<th/>
<th>amount</th>
</tr>
</thead>
<tbody>
<tr>
<th>sales</th>
<td> 350000</td>
</tr>
<tr>
<th>returns</th>
<td> -30000</td>
</tr>
<tr>
<th>credit fees</th>
<td>  -7500</td>
</tr>
<tr>
<th>rebates</th>
<td> -25000</td>
</tr>
<tr>
<th>late charges</th>
<td>  95000</td>
</tr>
<tr>
<th>shipping</th>
<td>  -7000</td>
</tr>
<tr>
<th>net</th>
<td> 375500</td>
</tr>
</tbody>
</table>
</div><pre class="literal-block">
sales                0
returns         350000
credit fees     320000
rebates         312500
late charges    287500
shipping        382500
net             375500
Name: amount, dtype: float64
</pre>
<p>Create the steps we use to show the changes.</p>
<div class="highlight"><pre><span class="n">step</span> <span class="o">=</span> <span class="n">blank</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">step</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="n">display</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
</pre></div>
<pre class="literal-block">
0         0
0       NaN
0    350000
1    350000
1       NaN
1    320000
2    320000
2       NaN
2    312500
3    312500
3       NaN
3    287500
4    287500
4       NaN
4    382500
5    382500
5       NaN
5    375500
6    375500
6       NaN
6       NaN
Name: amount, dtype: float64
</pre>
<p>For the net row, we need to make sure the blank value is 0 so we don’t double stack.</p>

<p>Plot it and see what it looks like</p>
<div class="highlight"><pre><span class="n">my_plot</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">'bar'</span><span class="p">,</span> <span class="n">stacked</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="n">blank</span><span class="p">,</span><span class="n">legend</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">"2014 Sales Waterfall"</span><span class="p">)</span>
<span class="n">my_plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">step</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="s">'k'</span><span class="p">)</span>
</pre></div>

<p>That looks pretty good but let’s try formatting the y-axis to make it
more readable. We use <code class="code">
FuncFormatter</code>
 and some of the python 2.7+ syntax
to truncate decimals and add a comma to the format.</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">money</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
    <span class="s">'The two args are the value and tick position'</span>
    <span class="k">return</span> <span class="s">"${:,.0f}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">FuncFormatter</span>
<span class="n">formatter</span> <span class="o">=</span> <span class="n">FuncFormatter</span><span class="p">(</span><span class="n">money</span><span class="p">)</span>
</pre></div>
<p>Pull it all together</p>
<div class="highlight"><pre><span class="n">my_plot</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">'bar'</span><span class="p">,</span> <span class="n">stacked</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="n">blank</span><span class="p">,</span><span class="n">legend</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">"2014 Sales Waterfall"</span><span class="p">)</span>
<span class="n">my_plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">step</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="s">'k'</span><span class="p">)</span>
<span class="n">my_plot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">"Transaction Types"</span><span class="p">)</span>
<span class="n">my_plot</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
</pre></div>

</div>
<div class="section" id="full-script">
<h2>Full Script</h2>
<p>The basic graph works but I wanted to add labels and make some minor formatting changes.
Here is my final script:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">FuncFormatter</span>

<span class="c">#Use python 2.7+ syntax to format currency</span>
<span class="k">def</span> <span class="nf">money</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
    <span class="s">'The two args are the value and tick position'</span>
    <span class="k">return</span> <span class="s">"${:,.0f}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">formatter</span> <span class="o">=</span> <span class="n">FuncFormatter</span><span class="p">(</span><span class="n">money</span><span class="p">)</span>

<span class="c">#Data to plot. Do not include a total, it will be calculated</span>
<span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s">'sales'</span><span class="p">,</span><span class="s">'returns'</span><span class="p">,</span><span class="s">'credit fees'</span><span class="p">,</span><span class="s">'rebates'</span><span class="p">,</span><span class="s">'late charges'</span><span class="p">,</span><span class="s">'shipping'</span><span class="p">]</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">'amount'</span><span class="p">:</span> <span class="p">[</span><span class="mi">350000</span><span class="p">,</span><span class="o">-</span><span class="mi">30000</span><span class="p">,</span><span class="o">-</span><span class="mi">7500</span><span class="p">,</span><span class="o">-</span><span class="mi">25000</span><span class="p">,</span><span class="mi">95000</span><span class="p">,</span><span class="o">-</span><span class="mi">7000</span><span class="p">]}</span>

<span class="c">#Store data and create a blank series to use for the waterfall</span>
<span class="n">trans</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
<span class="n">blank</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">amount</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c">#Get the net total number for the final element in the waterfall</span>
<span class="n">total</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">amount</span>
<span class="n">trans</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s">"net"</span><span class="p">]</span><span class="o">=</span> <span class="n">total</span>
<span class="n">blank</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s">"net"</span><span class="p">]</span> <span class="o">=</span> <span class="n">total</span>

<span class="c">#The steps graphically show the levels as well as used for label placement</span>
<span class="n">step</span> <span class="o">=</span> <span class="n">blank</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">step</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

<span class="c">#When plotting the last element, we want to show the full bar,</span>
<span class="c">#Set the blank to 0</span>
<span class="n">blank</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s">"net"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c">#Plot and label</span>
<span class="n">my_plot</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">'bar'</span><span class="p">,</span> <span class="n">stacked</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="n">blank</span><span class="p">,</span><span class="n">legend</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="s">"2014 Sales Waterfall"</span><span class="p">)</span>
<span class="n">my_plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">step</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="s">'k'</span><span class="p">)</span>
<span class="n">my_plot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">"Transaction Types"</span><span class="p">)</span>

<span class="c">#Format the axis for dollars</span>
<span class="n">my_plot</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>

<span class="c">#Get the y-axis position for the labels</span>
<span class="n">y_height</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">amount</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c">#Get an offset so labels don't sit right on top of the bar</span>
<span class="nb">max</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">neg_offset</span> <span class="o">=</span> <span class="nb">max</span> <span class="o">/</span> <span class="mi">25</span>
<span class="n">pos_offset</span> <span class="o">=</span> <span class="nb">max</span> <span class="o">/</span> <span class="mi">50</span>
<span class="n">plot_offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span> <span class="o">/</span> <span class="mi">15</span><span class="p">)</span>

<span class="c">#Start label loop</span>
<span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">trans</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="c"># For the last item in the list, we don't want to double count</span>
    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s">'amount'</span><span class="p">]</span> <span class="o">==</span> <span class="n">total</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y_height</span><span class="p">[</span><span class="n">loop</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y_height</span><span class="p">[</span><span class="n">loop</span><span class="p">]</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s">'amount'</span><span class="p">]</span>
    <span class="c"># Determine if we want a neg or pos offset</span>
    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s">'amount'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">+=</span> <span class="n">pos_offset</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">-=</span> <span class="n">neg_offset</span>
    <span class="n">my_plot</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s">"{:,.0f}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s">'amount'</span><span class="p">]),(</span><span class="n">loop</span><span class="p">,</span><span class="n">y</span><span class="p">),</span><span class="n">ha</span><span class="o">=</span><span class="s">"center"</span><span class="p">)</span>
    <span class="n">loop</span><span class="o">+=</span><span class="mi">1</span>

<span class="c">#Scale up the y axis so there is room for the labels</span>
<span class="n">my_plot</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">blank</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">plot_offset</span><span class="p">))</span>
<span class="c">#Rotate the labels</span>
<span class="n">my_plot</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">trans</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">my_plot</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">"waterfall.png"</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s">'tight'</span><span class="p">)</span>
</pre></div>
<p>Running the script will generate this nice looking chart:</p>

</div>
<div class="section" id="final-thoughts">
<h2>Final Thoughts</h2>
<p>If you were not familiar with waterfall charts, hopefully this example will show
you how useful they can be. I imagine that some people may think that this is an
awful lot of scripting for one chart. I agree - in some respects. If you will only
do one waterfall chart and never touch it again - stick with an Excel solution.</p>
<p>However, what if the chart is really useful and now you need to replicate it
for 100 customer? What would you do next? Using Excel would be a challenge.
Using this script to create 100 different charts would be fairly easy. Once again,
the real value of this process is building an easily repeatable process when
you need to scale the solution.</p>
<p>I am really enjoying learning more about pandas, matplotlib and IPython. I am pretty
happy with how this solution has turned out and I hope others can learn a little bit too
and apply this lessons to their daily jobs.</p>
</div>

  </div></body></html>