<html><body><div><div class="post-body entry-content" id="post-body-8229274632704757710" itemprop="description articleBody">
<p>Есть такой популярный microframework: <a href="http://flask.pocoo.org">Flask</a>.</p>
<p>Многим нравится: легкий и простой для изучения, то да сё.</p>
<p>А мне --- категорически нет.</p>
<p>Нелюбовь началась с элементарного: <code>request</code> --- это <code>thread local variable</code>:</p>
<pre><code>import flask
from myapp import app

@app.route('/')
def handler():
    req = flask.request
    if 'arg' in req.args:
        process_arg(req.args['arg'])
    ###
</code></pre>
<p>Т.е. для для того чтобы узнать с какими <em>GET</em> или <em>POST</em> параметрами
вызвали мой код -- я должен обращаться к глобальной переменной!</p>
<p>Я знаю разницу между <em>global variable</em> и <em>thread local variable</em> если
что -- но это не избавляет от неприятного послевкусия.</p>
<p>Ага, есть еще и <code>flask.g</code>!</p>
<p>Если уж мне потребуются <em>context local variables</em> -- я их буду
использовать по <strong>моему</strong> выбору, морщась от осознания собственного
несовершенства. Зачем <em>flask</em> их мне навязывает?</p>
<p>Дальше -- больше.</p>
<p>Смотрим еще раз:</p>
<pre><code>from myapp import app

@app.route('/')
def handler():
    ###
</code></pre>
<p>Имеем наполовину сконфигурированный импортированный откуда-то <em>app</em>, к
которому добавляем обработчик.</p>
<p>Мне это не нравится. Я хочу сделать <em>app</em> и добавить в него <em>route table</em>.</p>
<p><em>Flask</em> это позволяет, но документация провоцирует делать ровно наоборот.</p>
<p>Исполнять код на этапе <em>импорта модуля</em> не выглядит хорошей идеей,
сейчас в этом я полностью уверен.</p>
<p>Идем дальше.</p>
<p>Параметры в <em>route</em>:</p>
<pre><code>@app.route('/user/&lt;username&gt;')
def handler(username):
    pass
</code></pre>
<p>Весной это казалось мне удачным. Даже сделал что-то похожее в
<a href="https://github.com/aio-libs/aiorest">aiorest</a>.</p>
<p>Потом понял, что штука абсолютно бесполезная: нам <strong>всегда</strong>
требовалось что-то из <em>HTTP HEADERS</em>, <em>COOKIES</em> и <em>GET/POST parameres</em> в
обработчике запроста.</p>
<p>Чтобы проверить -- авторизирован ли пользователь, например.</p>
<p><em>Выпилил</em>.</p>
<p>С другой стороны проблема <strong>правильных</strong> параметров для <em>обработчика</em> не
имеет красивого решения.</p>
<p><em>route args</em>, <em>GET</em>, <em>POST</em>, <em>COOKIES</em> -- каждый <em>dict</em> может иметь
 <strong>перекрывающиеся</strong> имена-названия.</p>
<p>Паша Коломиец в <a href="https://github.com/tailhook/zorro">zorro</a> попытался
решить проблему через <em>аннотации</em>:</p>
<pre><code>def handler(self, request: Request):
    pass
</code></pre>
<p>Т.е. <em>handler</em> имеет параметр с аннотацией <code>Request</code> -- он получит в
него <em>request object</em>.</p>
<p>В <em>zorro</em> можно регистрировать свои аннотации для получения
дополнительной информации.</p>
<p>Симпатично и элегантно -- но слишком сложно для <strong>библиотеки для чайников</strong>.</p>
<p>Это путь <strong>настоящих джедаев</strong> -- я же в последние годы пропагандирую
применять <strong>метапрограммирование</strong> как можно реже: когда без трюка совсем
не обойтись и его применение настолько простое и очевидное, что
ошибиться просто невозможно.</p>
<h2 id="_1">Заключение</h2>
<p>Я не призываю <em>не использовать</em> <em>flask</em>, у меня нет такой цели. Хотите
граблей -- получайте.</p>
<p>Просто сейчас я занялся добавлением в
<a href="http://aiohttp.readthedocs.org/">aiohttp</a> WEB-сервера, пригодного для
использования <em>простым программистом</em>.</p>
<p>И я точно знаю, чего не будет в <em>aiohttp</em> -- <em>контекстных переменных</em>
и зависимостей <em>на этапе импорта</em>.</p>
<p><em>aiohttp.web</em> должен быть <em>прост насколько это возможно, но не проще</em>.</p>
<p>Желающие выстрелить себе в ногу пусть делают это в библиотеках,
построенных на основе <em>aiohttp.web</em> -- мы дадим им такую возможность.</p>
<p>Базис должен быть <em>простым и дуракоустойчивым</em> -- даже если для этого
придётся написать несколько лишних строк кода.</p>
<p/>
</div>
</div></body></html>