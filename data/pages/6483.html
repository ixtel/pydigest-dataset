<html><body><div><section class="post-content">
<p>StackHut is a way to deploy functions to the cloud: your classes are turned into scalable APIs which you can call through HTTP or quasi-natively through the StackHut client-libraries.</p>
<p>In this example, I'm going to deploy a Python function and will call it through HTTP. Let's do something Python is good at: compressing a PDF!</p>
<p>[Note: this tutorial presumes you've signed up for a Stackhut account and installed the StackHut toolkit.]</p>
<p>Firstly, I'm going to create a new Python project with StackHut. I'm going to choose Fedora as my OS, because it's got a nice ghostscript package which we can use to compress our PDF. </p>
<pre><code class="language-bash">bash-3.2$ mkdir pdf-compressor; cd pdf-compressor  
bash-3.2$ stackhut init fedora python  
</code></pre>
<p>StackHut will create a skeleton for my project. Firstly, it created a file called app.py. This is the core of our application, and is where we're going to put our function.</p>
<p>Our function is pretty simple. I'm actually cheating a bit and shelling out to ghostscript (gs) to compress the PDF. The function takes a single argument, which is a URL of a pdf. We download it, compress it with ghostscript, and then upload the compressed one and return a URL to it.</p>
<pre><code class="language-python">#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
pdf-compress Service  
"""
import stackhut

class Default(stackhut.Service):  
    def compress(self, pdfUrl) :
        in_file = stackhut.download_file(pdfUrl)
        out_file = "out_{}".format(in_file)
        output = sh.gs("-sDEVICE=pdfwrite", "-dCompatibilityLevel=1.4", "-dPDFSETTINGS=/ebook", "-dNOPAUSE", "-dQUIET", "-dBATCH", "-sOutputFile={}".format(out_file), in_file)

        return stackhut.put_file(out_file)


# export the services
SERVICES = {"Default": Default()}‚èé  
</code></pre>
<p>There are two special functions here. They should be pretty self-explanatory:</p>
<p><b>stackhut.download_file</b> downloads a file and return its location on the file-system. <br/>
<b>stackhut.put_file</b> uploads a file and return a URL to it.</p>
<p>Now we need to add the dependency on ghostscript to our service. In the same directory as app.py, you'll find Hutfile.yaml. This is the configuration file for your StackHut service.</p>
<pre><code class="language-yaml">name: pdf-compress

# Service description
description: compress a PDF

# The service dependencies, in terms of the base OS and language runtime

baseos: fedora  
stack: python

# Persist the service between requests
persistent: True

# Restrict service access to authenticated users
private: False

os_deps :  
    - ghostscript
</code></pre>
<p><b>persistent</b> just means we aren't going to make the service totally ephemeral (it will keep running after multiple requests. The alternative is that we reset the state after each request, which can be useful, but is overkill for our example.)</p>
<p><b>private</b> means we won't require authentication to run this service.</p>
<p><b>os_deps</b> is a list of dependencies for the operating system of our service. We need ghostscript!</p>
<p>Now we can test our service. We have two options: we can run it with our local operating system, or we can run it with Docker (which will recreate the exact environment that will be on the server when we deploy the function.)</p>
<p>Let's presume you don't have Docker so don't want to do the latter, and that you have ghostscript installed on your operating system. You just need to run:</p>
<pre><code class="language-bash">bash-3.2$ stackhut runhost  
14:01:18 [INFO ] Starting StackHut Toolkit  
14:01:18 [INFO ] Started StackHut Request Server - press Ctrl-C to quit  
14:01:18 [INFO ] Running service 'lanthias/pdf-compress:latest' on http://127.0.0.1:4001
</code></pre>
<p>This will run a local HTTP server on port 4001 where we can test our function by sending a JSON payload to /add with method and params for our function. Remember to replace 'lanthias' with your username. Let's do it with curl:</p>
<pre><code class="language-bash">bash-3.2$ cat &lt;&lt;EOF &gt; request.json  
{
    "service" : "lanthias/pdf-compress",
    "request" : {
        "method" : "compress",
        "params" : ["http://stackhut.com/scalagp.pdf"]
    }
}
EOF  
bash-3.2$ curl -H "Content-Type: application/json" -X POST -d @request.json http://localhost:4001/run  
</code></pre>
<p><i>Note: we could also call this function quasi-natively in Python or ES6 JavaScript with the <a href="https://stackhut.readthedocs.org/en/latest/using_service/client_libs.html">StackHut client libraries</a></i></p>
<p>If all went well, we'll get a reply with a url to our new, compressed PDF. Note: pdf compression can take a couple of seconds! </p>
<pre><code class="language-json">{
  "response": {
    "result": "http://stackhut-files.s3.amazonaws.com/lanthias/downloads/bdf2a21e-c867-4a88-83c1-ee9190f037f0/e7a5139e-0c27-445f-970d-ee076ff42ac7/out_scalagp.pdf",
    "jsonrpc": "2.0",
    "id": "e7a5139e-0c27-445f-970d-ee076ff42ac7"
  },
  "taskId": "bdf2a21e-c867-4a88-83c1-ee9190f037f0"
}
</code></pre>
<p>The next step is deploying our service to StackHut. This is pretty simple: </p>
<pre><code class="language-bash">bash-3.2$ stackhut deploy  
18:32:34 [INFO ] Starting StackHut Toolkit  
18:32:34 [INFO ] Starting Remote build, this may take a while (especially the first time), please wait...  
18:35:33 [INFO ] ...completed Remote build  
18:35:33 [INFO ] Deploying image 'lanthias/pdf-compress:latest' to StackHut  
18:35:34 [INFO ] Service lanthias/pdf-compress:latest has been CREATED and is live  
18:35:34 [INFO ] You can now call this service with our client-libs or directly over JSON+HTTP  
</code></pre>
<p>When this is finished, we can call our compression function from anywhere by requesting it at <a href="https://api.stackhut.com">https://api.stackhut.com</a></p>
<pre><code class="language-bash">bash-3.2$ curl -H "Content-Type: application/json" -X POST -d @request.json https://api.stackhut.com/run  
{
  "response": {
    "id": "9804ac92-e7c6-4d38-a6ca-286f4b92d5cf",
    "result": "http://stackhut-files.s3.amazonaws.com/lanthias/downloads/191cca71-695b-4abd-a2ee-d0c276e96706/9804ac92-e7c6-4d38-a6ca-286f4b92d5cf/out_scalagp.pdf",
    "jsonrpc": "2.0"
  },
  "taskId": "191cca71-695b-4abd-a2ee-d0c276e96706"
}
</code></pre>
<p>StackHut uses containers to scale our function so you can call it as many times as you like.</p>
<p><a href="https://stackhut.com"><i class="fa fa-github"/> Sign-up to Beta!</a></p>
<p>Enjoy! </p>
</section>
</div></body></html>