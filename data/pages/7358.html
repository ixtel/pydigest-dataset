<html><body><div><article class="markdown-body entry-content" itemprop="text"><h1><a id="user-content-continuous-deployment-with-docker" class="anchor" href="#continuous-deployment-with-docker" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Continuous Deployment with Docker</h1>

<h2><a id="user-content-description" class="anchor" href="#description" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Description</h2>

<p>This project shows a web application built using a microservices architecture.</p>

<p>There are two microservices:</p>

<ul>
<li><strong>rest-count</strong> implemented in Python (Flask microframework) using a Redis database</li>
<li><strong>rest-ip</strong> implemented in Node.js (Express framework) using a MongoDB database</li>
</ul>

<p>Using consul-template you can generate a dynamic Nginx configuration so that you can deploy new microservices version with no downtime.</p>

<p>You can find additional information on my <a href="http://www.slideshare.net/francescou/always-be-shipping">Slideshare presentation "Always be shipping"</a></p>

<p><a href="/francescou/docker-continuous-deployment/blob/master/docs/diagram.png" target="_blank"><img src="/francescou/docker-continuous-deployment/raw/master/docs/diagram.png" alt="Diagram"/></a></p>

<h2><a id="user-content-prerequisites" class="anchor" href="#prerequisites" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Prerequisites</h2>

<p>Docker 1.9.1</p>

<p>docker-compose 1.5.2</p>

<h2><a id="user-content-getting-started" class="anchor" href="#getting-started" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Getting started</h2>

<p>Run the following commands in terminal (the first time you have to wait for a few minutes to download the Docker base images):</p>

<pre><code>docker build -t rest-count rest-count/

docker build -t rest-ip rest-ip/

docker-compose -f application/docker-compose.yml up -d
</code></pre>

<p>open your browser to http://localhost:8080/</p>

<p>you can check the Consul state on http://localhost:8500/ui/</p>

<p>now edit <code>rest-count/main.py</code> (for example, you can increase the version to 1.1)</p>

<pre><code>docker build -t rest-count rest-count/

docker-compose -f application/docker-compose.yml up -d restcountprimary

sleep 15

docker-compose -f application/docker-compose.yml up -d restcountbackup
</code></pre>

<p>the updated microservice will be deployed with no downtime.</p>

<p>You can also modify the <em>rest-ip</em> microservice in the same way (see <code>rest-ip/app.js</code>).</p>

<h2><a id="user-content-scaling-microservices" class="anchor" href="#scaling-microservices" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Scaling microservices</h2>

<p>this section will explain how to can scale up and down <em>docker-compose</em> services.</p>

<p>open your browser to <code>http://localhost:8500/ui/</code>. There you will find a <em>rest-count</em> service, running on two nodes (one primary and one backup). Note that each node is a Docker container. Execute</p>

<pre><code>docker-compose -f application/docker-compose.yml scale restcountprimary=3
</code></pre>

<p>check again <code>http://localhost:8500/ui</code> to ensure that there are now four <em>rest-count</em> instance (three primary and one backup).</p>

<p>Make a few requests to <code>http://localhost:8080/api/v1/count</code> and then run <code>docker-compose -f application/docker-compose.yml logs</code> to see how requests are processed by different <em>rest-count</em> instances.</p>

<p>You can now scale down the <em>rest-count</em> service without having any down time, e.g.:</p>

<pre><code>docker-compose -f application/docker-compose.yml scale restcountprimary=2
</code></pre>

<p>Again, you can check <code>http://localhost:8500/ui</code> to see that there are now only two primary instances.</p>
</article>
  </div></body></html>