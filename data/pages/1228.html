<html><body><div><div class="col-xs-12 single-content">
                <p class="meta">
                    
                    <i class="fa fa-bookmark"/> 19 августа 2014 г.
                    <i class="link-spacer"/>
                    
                        <a href="/tag/ci/">CI</a>
                        
                        <i class="link-spacer"/>
                        
                    
                        <a href="/tag/bdd/">BDD</a>
                        
                        <i class="link-spacer"/>
                        
                    
                        <a href="/tag/jenkins/">Jenkins</a>
                        
                        <i class="link-spacer"/>
                        
                    
                        <a href="/tag/lettuce/">Lettuce</a>
                        
                        <i class="link-spacer"/>
                        
                    
                        <a href="/tag/splinter/">Splinter</a>
                        
                    
                    
                </p>

                <h1>Jenkins. Запуск BDD тестов c поддержкой WebDriver</h1>
                

                <p><img src="http://adw0rd.com/media/uploads/jenkinsci-cool.png" class="alignright"/></p>

<p>Эта статья является продолжением <a href="http://adw0rd.com/2013/05/25/jenkins/">Debian. Continuous Integration сервер Jenkins для непрерывного тестирования Django-проектов</a>, только сегодня я расскажу как запускать BDD-тесты в связке Lettuce/Selenium/WebDriver для Django-проектов. Будем все также использовать Debian-based дистрибутив.</p>

<p><a name="more"/></p>

<h3>Установка Virtual Framebuffer 'fake' X server</h3>

<p>Для того, чтобы запустить <strong>WebDriver</strong> нам понадобится FireFox (или IceWeasel), либо Chrome (или Chromium). Но на сервере обычно не устанавливается графический сервер X11, поэтому нам понадобится установить <strong>xvfb</strong>.</p>

<blockquote>Xvfb or X virtual framebuffer is a display server implementing the X11 display server protocol. In contrast to other display servers Xvfb performs all graphical operations in memory without showing any screen output.<br/><noindex><a href="http://en.wikipedia.org/wiki/Xvfb" rel="nofollow">http://en.wikipedia.org/wiki/Xvfb</a></noindex><br/></blockquote>

<p>Это можно сделать так:</p>

<pre><pre><code>sudo apt-get install xvfb
</code></pre></pre>

<blockquote class="info">Во <b>FreeBSD</b> можно установить из порта:<br/><pre><pre><code>cd /usr/ports/x11-servers/xorg-vfbserver
make install clean
</code></pre></pre>И вам может пригодиться мой модифицированный скрипт для запуска xvfb, его можно посмотреть тут <noindex><a href="https://github.com/adw0rd/xvfb-run/blob/master/freebsd/xvfb-run" rel="nofollow">https://github.com/adw0rd/xvfb-run/blob/master/freebsd/xvfb-run</a></noindex><br/></blockquote>

<p>Можно также почитать <a href="http://habrahabr.ru/post/113928/">Linux: запуск графических приложений в фоне</a>.</p>

<p>Рекомендую также обратить внимание на <a href="https://pypi.python.org/pypi/xvfbwrapper/0.2.4">xvfbwrapper</a> на python. Он нам не понадобится, но пакет полезный.</p>

<h3>Установка FireFox</h3>

<p>Теперь установим <strong>FireFox</strong>, на странице <noindex><a href="http://mozilla-russia.org/products/firefox/linux.html" rel="nofollow">http://mozilla-russia.org/products/firefox/linux.html</a></noindex> есть инструкции для различных дистрибутивов <strong>Linux</strong>, но нас интересует раздел для <a href="http://mozilla.debian.net/">Debian</a> , где вы найдете необходимые инструкции:</p>

<p>Добавьте в <tt>/etc/apt/sources.list</tt> или создайте файл в <tt>/etc/apt/sources.list.d/</tt> и добавьте туда следующие репозитории:</p>

<pre><pre><code>deb <noindex><a href="http://backports.debian.org/debian-backports" rel="nofollow">http://backports.debian.org/debian-backports</a></noindex> squeeze-backports main
deb <noindex><a href="http://mozilla.debian.net/" rel="nofollow">http://mozilla.debian.net/</a></noindex> squeeze-backports iceweasel-release
</code></pre></pre>

<p>Теперь выполните обновления базы пакетов и установите <a href="http://ru.wikipedia.org/wiki/Iceweasel">IceWeasel</a>:</p>

<pre><pre><code>apt-get update
apt-get install -t squeeze-backports iceweasel
</code></pre></pre>

<p>В Ubuntu я просто ставлю Firefox:</p>

<pre><pre><code>apt-get install firefox
</code></pre></pre>

<h3>Установка Chrome</h3>

<p>Лично я сам пользуюсь только этим браузером, в силу того что он работает быстрее, поддерживает современные технологии и на мой вгляд у него лучше сделан <strong>Developer Tools</strong>.</p>

<p>Добавим в "/etc/apt/sources.list" следующее:</p>

<pre><pre><code>deb <noindex><a href="http://dl.google.com/linux/chrome/deb/" rel="nofollow">http://dl.google.com/linux/chrome/deb/</a></noindex> stable main
</code></pre></pre>

<p>Применяем ключи и устанавливаем <tt>google-chrome-stable</tt>:</p>

<pre><pre><code>wget -q -O - <noindex><a href="https://dl-ssl.google.com/linux/linux_signing_key.pub" rel="nofollow">https://dl-ssl.google.com/linux/linux_signing_key.pub</a></noindex> | sudo apt-key add -
sudo apt-get update
sudo apt-get install google-chrome-stable
</code></pre></pre>

<p>Можно почитать <a href="http://worm.org.ua/2011/12/google-chrome-debian/">Установка Google Chrome в Debian</a></p>

<h3>Установка ChromeDriver</h3>

<p>Идем на страницу <noindex><a href="http://chromedriver.storage.googleapis.com/index.html" rel="nofollow">http://chromedriver.storage.googleapis.com/index.html</a></noindex> (сюда ведет оф. ссылка с <noindex><a href="https://code.google.com/p/chromedriver/wiki/WheredAllTheDownloadsGo)" rel="nofollow">https://code.google.com/p/chromedriver/wiki/WheredAllTheDownloadsGo)</a></noindex> и выбираем подходящую версию.</p>

<p>Я выбрал "2.10" (это последняя на момент написания статьи), теперь ее установим:</p>

<pre><pre><code>sudo su - jenkins
cd ~
wget <noindex><a href="http://chromedriver.storage.googleapis.com/2.10/chromedriver_linux64.zip" rel="nofollow">http://chromedriver.storage.googleapis.com/2.10/chromedriver_linux64.zip</a></noindex>
unzip chromedriver_linux64.zip
</code></pre></pre>

<p>Теперь можно переместить бинарник "chromedriver" в <tt>/usr/local/bin</tt> (и не забыть наделить правами на запуск для всех остальных "o+x"), либо положить в домашнюю директорию пользователя от которого будете запускать тесты (например, jenkins):</p>

<pre><pre><code>mkdir ~/bin
mv chromedriver ~/bin
echo "export PATH=$PATH:$HOME/bin" &gt;&gt; ~/.bash_profile
</code></pre></pre>

<p>Также есть инструкции на страничке Splinter - <a href="http://splinter.cobrateam.info/docs/drivers/chrome.html">Chrome WebDriver</a></p>

<p>Запускаем <tt>chromedriver</tt>, проверяем что он работает:</p>

<pre><pre><code>chromedriver
Starting ChromeDriver (v2.10.267518) on port 9515
Only local connections are allowed.
</code></pre></pre>

<p>Жмем <tt>Ctrl+C</tt>.</p>

<h3>Добавление и настройка задачи для Jenkins</h3>

<p>Нажимаем <tt>New Job</tt> (или "New Item" в более новых версиях <strong>Jenkins</strong>), выбираем <tt>Build a free-style software project</tt>, называем задачу как хочется, например "Testing_Project".</p>

<p>В секции "Source Code Management" выбрать чекбокс на "Git Repositories". В "Repository URL" вставляем <tt>git@git.example.org:repo-name.git</tt>, а в "Branches to build" указываем нужную ветку, например "master".</p>

<p>Теперь настроим <tt>"Poll SCM" &gt; "Schedule"</tt>. Будем каждые 2 минуты проверять изменения в репозитории, если появились изменения, то запускается новый билд с тестами:</p>

<pre><pre><code>H/2 * * * *
</code></pre></pre>

<p>В секции <tt>Build Environment</tt>, выбираем:</p>

<ul>
<li>"Add timestamps to the Console Output"</li>
<li>"Color ANSI Console Output" (в появившемся селекте я выбираю "xterm")</li>
</ul>

<p>Переходим к самому главному, добавляем секцию для запуска тестов <tt>"Build" &gt; "Add build step" &gt; "Execute shell"</tt>:</p>

<pre><pre><code>virtualenv --no-site-packages --distribute venv
# Устанавливаем зависимости для проекта и тестов
venv/bin/pip install --upgrade -r requirements/base.txt
venv/bin/pip install --upgrade -r requirements/tests.txt
# Запускаем тесты с использованием lettuce
venv/bin/python ./manage.py harvest -d --apps=tests --verbosity=4 --settings=test_settings
mkdir -p reports
xvfb-run -l -s '-screen 0 1280x1024x16 -ac' venv/bin/python ./manage.py harvest --apps=example.tests --verbosity=3 --settings=test_settings --with-xunit --xunit-file=./reports/junit-lettuce.xml example/tests/features/*.feature
</code></pre></pre>

<p>Вот собственно и все, теперь мы можем запускать полноценные функциональные BDD тесты!</p>



                

            </div>
        </div></body></html>