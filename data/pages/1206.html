<html><body><div><div class="entry-content">
            <p>Здравствуй, дорогой друг!</p>
<p>Затрону тему, которая не раз обсуждалась на <a href="http://djbook.ru/forum/topic/2283/">форуме</a>. Здесь же можете найти ссылки на многие туториалы по тому, как развернуть свой сайт на сервере.</p>
<p>Также есть уже готовый <a href="http://djbook.ru/examples/43/">рецепт</a>.</p>
<p>Я захотел написать вариант немножко в другой связке: Python3 (уж простите, но вот так мне приятнее), в качестве веб-сервера Nginx, в качестве http-сервера Gunicorn, размещаемся на digitalocean.com.</p>
<p>Внимание! Статейка моя адресована больше тем, кто делает первые шаги в разворачивании боевого сервера, она достаточно подробная и может вызвать приступы скуки и, возможно, тошноты у "бывалых".</p>
<p>Почему решил написать свой вариант, несмотря на то, что есть уже рецепты и на самом digitalocean.com? 4 пункта:</p>
<p>просто по их рецепту у меня ничего не вышло, в итоге я слепил картину из трех источников;
потому что кому-то, только начавшему, мой вариант может и помочь. Чтоб не натыкались на те же грабли. Я просидел за решением проблем 3 вечера, а знал бы как правильно, сделал бы быстрее;
вдруг кто-нибудь увидит в моих шагах сложность и предложит более правильное решение (я буду только рад, т.к. сам еще далеко не гуру);
ну и также я оставлю это здесь, чтоб самому в перспективе обращаться.
Итак! Пользоваться будем сервисом digitalocean.com (далее DO). Если еще кто-то не знаком, попробуйте. Это провайдер облачного хостинга. Для пробы используйте промо-код "radio-t" и вам на аккаунт упадет 10$ (сейчас июль 2014. Если читаете позже, код может не действовать). На минималке с одним инстансом 10$ хватит на 2 месяца.</p>
<p>Предположу, что вы уже зарегистрировались и денежки у вас на аккаунте уже есть.</p>
<p>1) Первое, что сразу посоветую сделать - создайте пару SSH и закиньте публичный на DO, для этого у них есть вкладка "SSH Keys". Далее это вам сильно облегчит жизнь.</p>
<p>2) Создадим инстанс (у них это называется "droplet"). Очень просто все: Нажимаете "Create" -&gt; В поле ввода вносите имя дроплета (in english, please) -&gt; выбираете размер -&gt; выбираете регион (Для сайтов, которые ориентированы на Евразию, лучше выбрать Амстердам или Лондон) -&gt; Затем выбираете дистрибутив (я ставил Ubuntu 12.04) -&gt; жмакаете на свой ssh key (если создавали, под выбором дистрибутива должен появится пункт по этому поводу) -&gt; и жмакаете "Create droplet". Ждете минтку.</p>
<p>3) Далее, если создавали ssh, заходите в терминал и коннектитесь с вашим дроплетом. Предположим, что ваш IP <code>111.222.333.44</code> (можете его найти под именем дроплета).</p>
<pre><code>ssh root@111.222.333.44
</code></pre>
<p>Если все сделали правильно, то должно все сработать. При первом заходе, спросит вашего подтверждения, что вы хотите законнектится по этому ключу, это стандартное поведение при работе через ssh. Подтверждайте.</p>
<p>Если вы не захотели заморачиваться с ключами, то можете зайти в дроплет на сайте DO и кликнуть на большую синюю кнопку "Console Access". Т.е. вы будете все то же самое делать через браузер, но для входа нужен будет пароль, который DO вышлют вам на почту.</p>
<p>Ну, это была только прелюдия</p>
<p>Вот вы в консоли. Давайте установим все необходимые программы.</p>
<p>4) Для начала нужно сделать апгрейд</p>
<pre><code>sudo apt-get update

sudo apt-get upgrade
</code></pre>
<p>5) Если вы следуете за мной по пятам и поставили Ubuntu 12.04, то вам следует поставить python3 (напомню, что описание для определенной связки. Если работаете на 2.х-версии, то вы молодец, вам это не нужно делать).</p>
<pre><code>sudo apt-get install python3
</code></pre>
<p>6) Поставим nginx</p>
<pre><code>sudo apt-get install nginx
</code></pre>
<p>7) Ставим третий pip.</p>
<pre><code>sudo apt-get install python3-setuptools

sudo easy_install3 pip
</code></pre>
<p>8) Virtualenv</p>
<p>установим само виртуальное окружение</p>
<pre><code>pip3 install virtualenv #если pip не хочет, можете поставить командой easy_install3 virtualenv

virtualenv /opt/myenv   # myenv можете заменить на любое другое имя

source /opt/myenv/bin/activate  # активируем виртуальное окружение. После этого в начале строки консоли должен появиться маркер (myenv)
</code></pre>
<p>Далее внутри виртуального окружения ставим необходимый пакет программ</p>
<p>9) Ставим django и gunicorn.</p>
<pre><code>pip install django gunicorn
</code></pre>
<p>На этом все установки закончились. Теперь перейдем к тестам и запуску.</p>
<p>10) Создадим проект</p>
<p>Все стандартно: перейдем в окружение, если еще не там</p>
<pre><code>cd /opt/myenv
source bin/activate
</code></pre>
<p>и</p>
<pre><code>django-admin.py startproject myproject
</code></pre>
<p>перейдем в папку проекта</p>
<pre><code>cd myproject
</code></pre>
<p>11) Тест gunicorn</p>
<p>теперь именно из папки проекта (там, где лежит manage.py) запускаем gunicorn</p>
<pre><code>gunicorn myproject.wsgi:application --bind 111.222.333.44:8000  #пишете ваш ip
</code></pre>
<p>Теперь в строке вашего браузера наберите <code>111.222.333.44:8000</code> #пишете ваш ip</p>
<p>Должна появиться стартовая страница django "It worked!"</p>
<p>Если работает, я радуюсь вместе с вами.</p>
<p>"Матрица пытается разговаривать с тобой, Нео!" (с)</p>
<p>12) Статика</p>
<p>К сожалению, статика к нашему проекту еще не подключена. И вы можете в этом убедиться, сделав <code>python manage.py syncdb</code>, затем перезапустить gunicorn и зайти в админку (ваш_ip:8000/admin). Будет все без стилей.</p>
<p>Разместим статику в папке проекта.</p>
<p>Открываем settings.py либо в вашем любимом редакторе, либо через nano.</p>
<pre><code>nano settings.py
</code></pre>
<p>и прописываем static_root</p>
<pre><code>STATIC_ROOT = '/opt/myenv/myproject/static/'
</code></pre>
<p>сохраняем и выходим</p>
<p>из папки проекта запускаем</p>
<pre><code>python manage.py collectstatic
</code></pre>
<p>в папке проекта появится папка с именем <code>static</code></p>
<p>13) Настроим nginx</p>
<p>перейдем по следующему пути</p>
<pre><code>cd /etc/nginx/sites-available/
</code></pre>
<p>открываем файлик <code>default</code></p>
<pre><code>nano default
</code></pre>
<p>Удаляем оттуда все и пишем</p>
<pre><code>server {
    listen 80;
    server_name 111.222.333.44; #либо ip, либо доменное имя
    access_log  /var/log/nginx/example.log;

    location /static/ {
        root /opt/myenv/myproject/;
        expires 30d;
    }

    location / {
        proxy_pass http://127.0.0.1:8000; 
        proxy_set_header Host $server_name;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
  }
</code></pre>
<p>Сохраняем, выходим.</p>
<p>14) "Поехали!" (с)</p>
<p>возвращаемся в папку проекта</p>
<pre><code>cd /opt/myenv/myproject
</code></pre>
<p>Перезапустим nginx</p>
<pre><code>sudo service nginx restart
</code></pre>
<p>Запустим gunicorn</p>
<pre><code>gunicorn myproject.wsgi:application
</code></pre>
<p>В браузере набираем <code>111.222.333.44</code></p>
<p>It worked!</p>
<p>15) Supervisor. </p>
<p>Чтобы наше приложение стратовало после любого непредвиденного ребута или сбоя, нам нужно обзавестись supervisor-ом.</p>
<p>Установим supervisor</p>
<pre><code>apt-get install supervisor
</code></pre>
<p>Создадим конфиг файл для gunicorn</p>
<pre><code>cd /opt/myenv/myproject/myproject #лучше делать именно в каталоге с settings.py
touch gunicorn.conf.py
</code></pre>
<p>Открываем на редактирование</p>
<pre><code>nano gunicorn.conf.py
</code></pre>
<p>Вносим</p>
<pre><code>bind = '127.0.0.1:8000'
workers = 3
user = "nobody"
</code></pre>
<p>создадим конфиг файл для супервизора</p>
<pre><code>cd /etc/supervisor/conf.d/
touch myproject.conf
</code></pre>
<p>Откроем</p>
<pre><code>nano myproject.conf
</code></pre>
<p>Внутрь внесем</p>
<pre><code>[program:myproject]
command=/opt/myenv/bin/gunicorn myproject.wsgi:application -c /opt/myenv/myproject/myproject/gunicorn.conf.py
directory=/opt/myenv/myproject
user=nobody
autorestart=true
redirect_stderr=true
</code></pre>
<p>Команды для supervisor</p>
<pre><code>supervisorctl reread
supervisorctl update
supervisorctl status myproject
supervisor restart myproject
</code></pre>
<p>После старта роверяем свой сайт в браузере. Должен работать.</p>
<p>Останавливаем машину</p>
<pre><code>shutdown -r now
</code></pre>
<p>Или можно просто вырубить инстанс</p>
<p>Заводим и проверяем. Все должно работать.</p>
<p>=======================================================</p>
<p>=======================================================</p>
<p>Обязательные правки для боевого.</p>
<p>1) в settings.py</p>
<pre><code>DEBUG = False  #так должно быть
</code></pre>
<p>2) Но при <code>debug = False</code> обязательно нужно указать <code>ALLOWED_HOSTS</code>­. Это, по идее, должен быть ваш домен</p>
<p>3) если вы просто скопировали проект из другого места, то лучше заменить <code>SECRET_KEY</code></p>
<p>=======================================================</p>
<p>Какие еще могут появиться проблемы?</p>
<p>Невероятные кейсы</p>
<p>Кейс 1</p>
<p>Если вы запустили gunicorn, а после этого вышли из терминала, вспомнили, что хотели еще небольшие правки внести. Зашли снова в терминал. Внесли правки. Перезапустили nginx. Запускаете gunicorn, а он выдет вам следующее:</p>
<pre><code>Retrying in 1 second… # несколько раз
Can't connect to ваш_IP
</code></pre>
<p>Есть вероятность, что просто ваш процесс gunicorn уже запущен.</p>
<p>Проверяем.</p>
<pre><code>ps xa | grep gunicorn
</code></pre>
<p>если появилась портянка с гоникорнами, то так и есть</p>
<p>убиваем процесс</p>
<pre><code>killall gunicorn
</code></pre>
<p>затем запускаем.</p>
<p>Кейс 2</p>
<p>Если вы создали дроплет и зашли по ключу, а потом этот дроплет кикнули, а потом снова создали ))))), есть вероятность, что вам дадут тот же IP. В этом случае при коннекте по ssh может ругнуться на ошибку. Не беспокойтесь! Откройте <code>known_hosts</code> (данный файл содержит список адресов и соответствующих им публичных ключей. лежит в .ssh на вашем компьютере) и почистите его. (Не самый лучший способ, если у вас несколько уже "настроенных" пар ключей).</p>
<p>UPD: Похожий <a href="http://michal.karzynski.pl/blog/2013/06/09/django-nginx-gunicorn-virtualenv-supervisor/">гайд на английском</a>.</p>
        </div>
        

        

        </div></body></html>