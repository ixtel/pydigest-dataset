<html><body><div><div class="entry-content">
      <p>A new version of <code>pip-tools</code> was recently released and it brings with it a much cleaner work-flow to manage your Python virtual environments.</p>

<p>I’m assuming you are using virtual environments for your Python and Django projects. If not you should look up some of the excellent guides on the Internet on how to get started with <a href="https://virtualenv.pypa.io/en/latest/">virtualenv</a>, <a href="https://virtualenvwrapper.readthedocs.org/en/latest/">virtualenvwrapper</a> or my personal favorite <a href="https://github.com/adambrenecki/virtualfish/">virtualfish</a> for <a href="http://fishshell.com/">Fish</a>.</p>

<h3 id="package-management">Package management</h3>
<p>One of the problems you encounter with Python development is always package management, especially when you use Django and you keep adding cool new apps to your project. Those applications will install dependencies and those in turn install their own. So at some point you won’t be able to tell or remember what those were anymore. Each of those packages adds up to the size of your virtual environment. This is not a big deal if you are just developing locally, but once you start using hosting platforms you quickly find out that every megabyte of your project counts. For example when you run a wsgi server that uses forking, chances are that each fork will load your Django environment in memory. Now multiply that by the amount of workers you have set up and you see how a few megabytes more or less can make a big difference. If you author open-source projects, and you should, it’s also nice to not inadvertently list a bunch of unnecessary packages.</p>


<p><a href="https://github.com/nvie/">Vincent Driessen</a>’s <a href="https://github.com/nvie/pip-tools">pip-tools</a> package has been a long time favorite of many Python developer. The <code>pip-dump</code> and <code>pip-review</code> commands are a great way of creating requirement files and updating them. Now with version 1 finally released, it introduces two new commands <code>pip-compile</code> and <code>pip-sync</code> which previously were only available as a preview in the future branch of the repository.
These two commands bring a new, and in my opinion a much improved, work-flow with them. I’ll take you through how I’ve been using it, so let’s start with installing <a href="https://github.com/nvie/pip-tools">pip-tools</a> using pip:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>pip install pip-tools --upgrade</code></pre></div>

<h3 id="pip-compile">Pip compile</h3>

<p>First we create a <code>requirements.in</code> file which will list all the basic package requirements for our projects. I will not insult you by explaining how to create and edit a file, but take care you use the correct extension <code>.in</code> instead of <code>.ini</code> or <code>.txt</code>. Here I’m just listing some standard packages I would use for most Django projects:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># requirements.in</span>
<span class="n">django</span>
<span class="n">django</span><span class="o">-</span><span class="n">extensions</span>
<span class="n">django</span><span class="o">-</span><span class="n">debug</span><span class="o">-</span><span class="n">toolbar</span>
<span class="n">django</span><span class="o">-</span><span class="n">redis</span>
<span class="n">psycopg2</span></code></pre></div>

<p>Now we run <code>$ pip-compile</code> and it creates a <code>requirements.txt</code> file for us:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># requirements.txt</span>
<span class="c">#</span>
<span class="c"># This file is autogenerated by pip-compile</span>
<span class="c"># Make changes in requirements.in, then run this to update:</span>
<span class="c">#</span>
<span class="c">#    pip-compile requirements.in</span>
<span class="c">#</span>
<span class="n">django</span><span class="o">-</span><span class="n">debug</span><span class="o">-</span><span class="n">toolbar</span><span class="o">==</span><span class="mf">1.3</span><span class="o">.</span><span class="mi">2</span>
<span class="n">django</span><span class="o">-</span><span class="n">extensions</span><span class="o">==</span><span class="mf">1.5</span><span class="o">.</span><span class="mi">5</span>
<span class="n">django</span><span class="o">-</span><span class="n">redis</span><span class="o">==</span><span class="mf">4.2</span><span class="o">.</span><span class="mi">0</span>
<span class="n">django</span><span class="o">==</span><span class="mf">1.8</span><span class="o">.</span><span class="mi">3</span>
<span class="n">msgpack</span><span class="o">-</span><span class="n">python</span><span class="o">==</span><span class="mf">0.4</span><span class="o">.</span><span class="mi">6</span>     <span class="c"># via django-redis</span>
<span class="n">psycopg2</span><span class="o">==</span><span class="mf">2.6</span><span class="o">.</span><span class="mi">1</span>
<span class="n">redis</span><span class="o">==</span><span class="mf">2.10</span><span class="o">.</span><span class="mi">3</span>             <span class="c"># via django-redis</span>
<span class="n">six</span><span class="o">==</span><span class="mf">1.9</span><span class="o">.</span><span class="mi">0</span>                <span class="c"># via django-extensions</span>
<span class="n">sqlparse</span><span class="o">==</span><span class="mf">0.1</span><span class="o">.</span><span class="mi">16</span>          <span class="c"># via django-debug-toolbar</span></code></pre></div>

<p>As you can see <code>pip-compile</code> neatly pinned all the packages and their own requirements. Marking all the child dependencies with their parents where needed. Now you know exactly why e.g.<code>sqlparse</code> is installed or <code>six</code> and by which package. If you still wonder why you should be pinning your requirements like this, you can read about it in this <a href="http://nvie.com/posts/better-package-management/">article</a> by the pip-tools author himself.</p>

<h3 id="development-requirements">Development requirements</h3>
<p>Often I’ll use some extra packages for development that I don’t want included in the <code>requirements.txt</code> file cause they will neither be used in staging or production. However I do switch working environments a lot, so it’s nice to not have to install all the stuff I need to start work from memory. So let’s create a <code>dev-requirements.in</code> file:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># dev-requirements.in</span>
<span class="n">pytest</span>
<span class="n">pytest</span><span class="o">-</span><span class="n">django</span>
<span class="n">bpython</span></code></pre></div>

<p>Executing <code>$ pip-compile dev-requirements.in</code> will create our <code>dev-requirements.txt</code>:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># dev-requirements.txt</span>
<span class="c">#</span>
<span class="c"># This file is autogenerated by pip-compile</span>
<span class="c"># Make changes in dev-requirements.in, then run this to update:</span>
<span class="c">#</span>
<span class="c">#    pip-compile dev-requirements.in</span>
<span class="c">#</span>
<span class="n">blessings</span><span class="o">==</span><span class="mf">1.6</span>            <span class="c"># via curtsies</span>
<span class="n">bpython</span><span class="o">==</span><span class="mf">0.14</span><span class="o">.</span><span class="mi">2</span>
<span class="n">curtsies</span><span class="o">==</span><span class="mf">0.1</span><span class="o">.</span><span class="mi">19</span>          <span class="c"># via bpython</span>
<span class="n">greenlet</span><span class="o">==</span><span class="mf">0.4</span><span class="o">.</span><span class="mi">7</span>           <span class="c"># via bpython</span>
<span class="n">py</span><span class="o">==</span><span class="mf">1.4</span><span class="o">.</span><span class="mi">30</span>                <span class="c"># via pytest</span>
<span class="n">pygments</span><span class="o">==</span><span class="mf">2.0</span><span class="o">.</span><span class="mi">2</span>           <span class="c"># via bpython</span>
<span class="n">pytest</span><span class="o">-</span><span class="n">django</span><span class="o">==</span><span class="mf">2.8</span><span class="o">.</span><span class="mi">0</span>
<span class="n">pytest</span><span class="o">==</span><span class="mf">2.7</span><span class="o">.</span><span class="mi">2</span>
<span class="n">requests</span><span class="o">==</span><span class="mf">2.7</span><span class="o">.</span><span class="mi">0</span>           <span class="c"># via bpython</span>
<span class="n">six</span><span class="o">==</span><span class="mf">1.9</span><span class="o">.</span><span class="mi">0</span>                <span class="c"># via bpython</span></code></pre></div>

<p>Most software will only look for a <code>requirements.txt</code> file to install dependencies, so this is a great way of keeping these packages out of your Heroku dynos or similar platforms while still managing your development environment.</p>

<h3 id="pip-sync">Pip sync</h3>
<p>Until now we haven’t installed anything yet in our virtualenv. We could simpy do <code>$ pip install -r requirements.txt</code> but what if there are already packages previously installed? The new <code>pip-sync</code> command takes care of this. It not only installs your dependencies, it also removes anything that is not defined in your requirement files. You’ll soon find out if you forgot to list a crucial package in the <code>.in</code> files.</p>

<p>Let’s run:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>pip-sync requirements.txt dev-requirements.txt</code></pre></div>

<p>You’ll see pip-tools make your environment reflect exactly what you defined in your requirements. No more extraneous mystery packages.</p>

<h3 id="dependency-management">Dependency management</h3>

<p>Let us assume I’ve decided that <code>django-debug-toolbar</code> is a great development package but I don’t want to use it on my servers. Normally you would run <code>$ pip uninstall djang-debug-toolbar</code> and remove the entry from your <code>requirements.txt</code> file manually. Unfortunately this doesn’t remove the <code>sqlparse</code> package, unless you remembered, and months later you’ll be wondering why it is in your requirements file.
With <code>pip-tools</code> this process is a lot cleaner. All we do is remove the <code>django-debug-toolbar</code> entry from the <code>requirements.in</code> file and run <code>$ pip-compile</code> again.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># requirements.txt</span>
<span class="c">#</span>
<span class="c"># This file is autogenerated by pip-compile</span>
<span class="c"># Make changes in requirements.in, then run this to update:</span>
<span class="c">#</span>
<span class="c">#    pip-compile requirements.in</span>
<span class="c">#</span>
<span class="n">django</span><span class="o">-</span><span class="n">extensions</span><span class="o">==</span><span class="mf">1.5</span><span class="o">.</span><span class="mi">5</span>
<span class="n">django</span><span class="o">-</span><span class="n">redis</span><span class="o">==</span><span class="mf">4.2</span><span class="o">.</span><span class="mi">0</span>
<span class="n">django</span><span class="o">==</span><span class="mf">1.8</span><span class="o">.</span><span class="mi">3</span>
<span class="n">msgpack</span><span class="o">-</span><span class="n">python</span><span class="o">==</span><span class="mf">0.4</span><span class="o">.</span><span class="mi">6</span>     <span class="c"># via django-redis</span>
<span class="n">psycopg2</span><span class="o">==</span><span class="mf">2.6</span><span class="o">.</span><span class="mi">1</span>
<span class="n">redis</span><span class="o">==</span><span class="mf">2.10</span><span class="o">.</span><span class="mi">3</span>             <span class="c"># via django-redis</span>
<span class="n">six</span><span class="o">==</span><span class="mf">1.9</span><span class="o">.</span><span class="mi">0</span>                <span class="c"># via django-extensions</span></code></pre></div>

<p>As you can see both the toolbar and its sqlparse dependency are gone.
Now we run <code>$ pip-sync requirements.txt dev-requirements.txt</code> to actually un-install those packages from our environment. That’s really all there is to it.</p>

<h3 id="package-updates">Package updates</h3>
<p>Once every while I will run <code>$ pip-compile</code> again so it will pick up any updated packages that have since been released. The same way I used to run <code>pip-review</code>, except I’ll use <code>$ git diff</code> to show me if any packages have been updated or not. This is the only part that probably still needs a little love from the developers. If you’re not using version control to show you something has changed, it can be very hard to tell if any of your requirements have had an update. Especially if all you wanted to do is remove a dependency. A little change report after a compile would make this a lot easier. It is still very early days for this new version though and updates have been coming out frequently.</p>

<h3 id="finally">Finally</h3>
<p>Personally I’m very excited that <a href="https://twitter.com/nvie">@nvie</a> released these new commands. I think they should be the standard tool for anyone who does any kind of Python development and needs reproducible environments. Utilizing this work-flow has enabled me to reduce my project sizes by 10 to 20 percent. That’s quite significant in itself, but more importantly it makes me feel I’m in control of my Python environments again.</p>

      <footer class="entry-meta">
        <span class="entry-tags"><a href="https://koed00.github.io/tags/#django" title="Pages tagged django" class="tag"><span class="term">django</span></a><a href="https://koed00.github.io/tags/#virtualenv" title="Pages tagged virtualenv" class="tag"><span class="term">virtualenv</span></a><a href="https://koed00.github.io/tags/#pip" title="Pages tagged pip" class="tag"><span class="term">pip</span></a><a href="https://koed00.github.io/tags/#python" title="Pages tagged python" class="tag"><span class="term">python</span></a><a href="https://koed00.github.io/tags/#pip-tools" title="Pages tagged pip-tools" class="tag"><span class="term">pip-tools</span></a></span>
        
        

      </footer>
    </div>
    </div></body></html>