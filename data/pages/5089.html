<html><body><div><div id="wikitext">
<p/> 

<p class="vspace"/><h3>Оглавление</h3>
<p class="vspace"/><h3><a name="intro" id="intro"/> Введение</h3>
<p>Как известно, то, что обычный пользователь делает мышкой, повторяя одни и те же действия по 10 раз, программисты и, особенно, админы, делают скриптами. Инструментов и языков для написания скриптов существует огромное количество. Некоторые из них предназначены для определенных задач, например, на сборку и компиляцию программ, как Makefile и его последователи, другие являются более низкоуровневыми, например тот же bash. Промежуточное место я бы отвел для таких скриптовых языков как Python, Perl, Ruby. Преимущество последних в первую очередь в читаемости кода, когда нужно писать что-то большое, но в то же время, например, для работы с файлами, при работе с этими языками приходится писать больше кода, чем на том же bash.
</p>
<p class="vspace">В этой статье мы поговорим о <a class="urllink" href="http://www.fabfile.org/">Fabric</a> - библиотеке для Python (в данный момент поддерживаются версии 2.5 - 2.7), которую можно использовать для многих задач автоматизации, при этом она позволяет легко вызывать команды того же bash, где это необходимо или оправдано.
</p>
<p class="vspace">Если мельком взглянуть на документацию Fabric, то складывается впечатление, что эта библиотека предназначена в первую очередь для работы на удаленном сервере при подключении к нему через SSH, однако, ее можно использовать и для локальных задач.
</p>
<p class="vspace">Лично я на данный момент Fabric использую для трех типов задач:
</p>
<p class="vspace"/><ol><li>В качестве замены Makefile для сборки программы <a class="urllink" href="http://jenyay.net/Soft/Outwiker">OutWiker</a>.
</li><li>Для создания резервных копий на сетевом хранилище.
</li><li>Для управления сайтами через SSH (развертывание, создание резервных копий, перезапуск сервера и т.д.)
</li></ol><p class="vspace">Разбираться с Fabric мы начнем с самого начала, т.е. с установки.
</p>
<p class="vspace"/><h3><a name="install" id="install"/> Установка</h3>
<p>Установка под Linux не должна вызывать никаких затруднений. Достаточно написать в консоли
</p>
<p class="vspace"/>


<p class="vspace">или
</p>
<p class="vspace"/>


<p class="vspace">кому что больше нравится. И Fabric будет установлен вместе с необходимыми зависимостями.
</p>
<p class="vspace">А вот под Windows с установкой зависимостей могут возникнуть затруднения. Fabric использует библиотеку шифрования PyCrypto, которая, как правило, распространяется в исходных кодах и компилируется на месте при установке. Компиляция ее под Linux проблем не возникает, потому что редкая Linux-система (особенно система админа или программиста) не имеет компилятора C/C++.
</p>
<p class="vspace">Под Windows его может и не быть. Но, к счастью, можно найти готовые <a class="urllink" href="http://www.voidspace.org.uk/python/modules.shtml#pycrypto">сборки PyCrypto под Windows</a>. Доверять им или нет - ваше дело. Однако, если PyCrypto установить, то затем установка Fabric завершится без проблем.
</p>
<p class="vspace">Чтобы убедиться, что Fabric установлен, наберем в консоли команду
</p>
<p class="vspace"/>


<p class="vspace">Если вы получите сообщение вида:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock4">
  <div class="sourceblocktext"><p class="text">Fatal error: Couldn't find any fabfiles!<br/>
<br/>
Remember that -f can be used to specify fabfile path, and use -h for help.<br/>
<br/>
Aborting.<br/>
Couldn't find any fabfiles!<br/>
<br/>
Remember that -f can be used to specify fabfile path, and use -h for help.</p></div>
  
</div>

<p class="vspace">То значит, что все нормально и можно двигаться дальше.
</p>
<p class="vspace">Если вы пользуетесь Windows и вы получите сообщение о том, что команда <em>fab</em> не найдена, то убедитесь, что у вас добавлен путь до папки C:\Python27\Scripts\ или ее аналога для той версии Python, который вы используете, в переменную окружения PATH. В крайнем случае, вы всегда можете писать команду в виде
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock5">
  <div class="sourceblocktext"><p class="text">&gt; C:\Python27\Scripts\fab</p></div>
  
</div>

<p class="vspace">но просто <em>fab</em> писать удобнее.
</p>
<p class="vspace"/><h3><a name="using" id="using"/> Использование Fabric</h3>
<p>Использование Fabric во многом напоминает использование Makefile, т.е. вы создаете в какой-то папке файл <em>fabfile.py</em>, в котором описываете задачи (как они описываются, мы рассмотрим чуть позже). Например, там может быть задача backup (для создания резервной копии) или deploy (для развертывания сайта) и т.д.
</p>
<p class="vspace">Затем в консоли вы запускаете команду
</p>
<p class="vspace"/>


<p class="vspace">или 
</p>
<p class="vspace"/>


<p class="vspace">И Fabric выполняет нужные задачи. Можно указать несколько задач, тогда они будут выполнены последовательно, например, сначала создать резервную копию, а потом развернуть приложение:
</p>
<p class="vspace"/>


<p class="vspace">В задачи можно передавать параметры. Параметры передаются после символа ":" после имени задачи. Пусть, например, мы можем указать путь до папки, куда делать резервную копию:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock9">
  <div class="sourceblocktext"><p class="text">$ fab backup:"~/backups/mycoolsite"</p></div>
  
</div>

<p class="vspace">Если в параметрах нет пробелов, то кавычки можно не писать. Если параметров несколько, то они перечисляются через запятую. Но про передачу параметров мы еще поговорим.
</p>
<p class="vspace"/><h3><a name="fabfile" id="fabfile"/> Файл fabfile.py</h3>
<h4><a name="struct" id="struct"/> Структура файла</h4>
<p>Библиотека Fabric замечательна тем, что для ее использования не нужно разбираться с новым языком описания задач или каким-то новым синтаксисом, все задачи описываются на языке Python, возможно, с использованием вспомогательных средств Fabric. Так, например, для создания двух задач, которые были приведены выше в качестве примера, достаточно создать файл с именем <em>fabfile.py</em> (имя важно, хотя при желании его можно изменить, о чем будет сказано ниже) со следующим содержимым:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock10">
  <div class="sourceblocktext"><p class="python"><span class="co1"># -*- coding: UTF-8 -*-</span><br/>
<br/>
<br/>
<span class="kw1">def</span> backup <span class="br0">(</span><span class="br0">)</span>:<br/>
    <span class="kw1">print</span> u<span class="st0">'Run backup...'</span><br/>
    <span class="kw1">print</span> u<span class="st0">'Ok'</span><br/>
<br/>
<br/>
<span class="kw1">def</span> deploy <span class="br0">(</span><span class="br0">)</span>:<br/>
    <span class="kw1">print</span> u<span class="st0">'Run deploy...'</span><br/>
    <span class="kw1">print</span> u<span class="st0">'Ok'</span></p></div>
  
</div>

<p class="vspace">В данном случае у нас задачи backup и deploy не принимают никаких параметров. Как вы видите, описание задачи - это просто функция на языке Python. Мы можем выполнить описанные выше команды в консоли (в качестве рабочей папки у нас должна быть папка с файлом <em>fabfile.py</em>):
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock11">
  <div class="sourceblocktext"><p class="text">$ fab backup<br/>
<br/>
Run backup...<br/>
Ok<br/>
<br/>
Done.<br/>
<br/>
$ fab deploy<br/>
<br/>
Run deploy...<br/>
Ok<br/>
<br/>
Done.</p></div>
  
</div>

<p class="vspace">По умолчанию Fabric ищет задачи в файле с именем <em>fabfile.py</em>, но при желании вы можете назвать этот файл по-другому, но в этом случае вам надо будет явно указывать имя файла с задачами с помощью с помощью одного из параметров -f или --fabfile. Например, если наш файл с задачами имеет имя <em>my_fabfile.py</em>, то мы можем запустить задачи так, как показано ниже:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock12">
  <div class="sourceblocktext"><p class="text">$ fab -f my_fabfile.py backup</p></div>
  
</div>

<p class="vspace">или
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock13">
  <div class="sourceblocktext"><p class="text">$ fab --fabfile=my_fabfile.py backup</p></div>
  
</div>

<p class="vspace">Кроме того, в файле профиля пользователя можно создать файл <em>.fabricrc</em> (под Linux путь будет выглядеть как <em>~/.fabricrc</em>), в котором задаются различные настройки по умолчанию. Если в этот файл добавить строку
</p>
<p class="vspace"/>


<p class="vspace">то по умолчанию Fabric будет искать не файл <em>fabfile.py</em>, а файл <em>my_fabfile.py</em>.
</p>
<p class="vspace"/><h4><a name="doc" id="doc"/> Документирование задач</h4>
<p>Команда <em>fab</em> имеет множество параметров, один из самых полезных параметров - это параметр <em>-l</em> или <em>--list</em>. Этот параметр показывает, какие задачи есть в fabfile.py. Вот, например, результат работы параметра <em>--list</em> для приведенного выше <em>fabfile.py</em>.
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock15">
  <div class="sourceblocktext"><p class="text">$ fab --list<br/>
<br/>
Available commands:<br/>
<br/>
    backup<br/>
    deploy</p></div>
  
</div>

<p class="vspace">В таком виде подсказка уже полезна, но лучше все-таки еще добавить комментарии к каждой задаче. Чтобы их добавить, достаточно для каждой функции добавить описание в виде docstring:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock16">
  <div class="sourceblocktext"><p class="python"><span class="co1"># -*- coding: UTF-8 -*-</span><br/>
<br/>
<br/>
<span class="kw1">def</span> backup <span class="br0">(</span><span class="br0">)</span>:<br/>
    <span class="st0">"""<br/>
    Создание резервной копии<br/>
    """</span><br/>
    <span class="kw1">print</span> u<span class="st0">'Run backup...'</span><br/>
    <span class="kw1">print</span> u<span class="st0">'Ok'</span><br/>
<br/>
<br/>
<span class="kw1">def</span> deploy <span class="br0">(</span><span class="br0">)</span>:<br/>
    <span class="st0">"""<br/>
    Развертывание сайта mycoolsite.com<br/>
    """</span><br/>
    <span class="kw1">print</span> u<span class="st0">'Run deploy...'</span><br/>
    <span class="kw1">print</span> u<span class="st0">'Ok'</span></p></div>
  
</div>

<p class="vspace">В этом случае параметр <em>--list</em> выведет список задач следующим образом:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock17">
  <div class="sourceblocktext"><p class="text">$ fab --list<br/>
<br/>
Available commands:<br/>
<br/>
    backup  Создание резервной копии<br/>
    deploy  Развертывание сайта mycoolsite.com</p></div>
  
</div>

<p class="vspace">На самом деле лучше не использовать в описаниях русские символы, поскольку в консоли под Windows они превратятся в кракозяблы (под Linux все будет работать нормально). Кроме того, не стоит писать очень длинные описания, поскольку они будут обрезаны до чуть больше чем 70 символов.
</p>
<p class="vspace">Понятно, что одни задачи могут вызывать другие задачи, кроме того внутри <em>fabfile.py</em> могут быть функции для внутреннего использования, попадание которых в список задач, выводимых с помощью параметра <em>--list</em>, нежелательно. Такие "внутренние" функции должны начинаться с символа "_". Так, например, функция <em>_internal()</em> из следующего прмиера <em>fabfile.py</em> не будет видна как задача:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock18">
  <div class="sourceblocktext"><p class="python"><span class="co1"># -*- coding: UTF-8 -*-</span><br/>
<br/>
<br/>
<span class="kw1">def</span> backup <span class="br0">(</span><span class="br0">)</span>:<br/>
    <span class="st0">"""<br/>
    Создание резервной копии<br/>
    """</span><br/>
    <span class="kw1">print</span> u<span class="st0">'Run backup...'</span><br/>
    <span class="kw1">print</span> u<span class="st0">'Ok'</span><br/>
<br/>
<br/>
<span class="kw1">def</span> deploy <span class="br0">(</span><span class="br0">)</span>:<br/>
    <span class="st0">"""<br/>
    Развертывание сайта mycoolsite.com<br/>
    """</span><br/>
    <span class="kw1">print</span> u<span class="st0">'Run deploy...'</span><br/>
    <span class="kw1">print</span> u<span class="st0">'Ok'</span><br/>
<br/>
<br/>
<span class="kw1">def</span> _internal <span class="br0">(</span><span class="br0">)</span>:<br/>
    <span class="kw1">pass</span></p></div>
  
</div>

<p class="vspace"/>
<div class="sourceblock " id="sourceblock19">
  <div class="sourceblocktext"><p class="text">$ fab --list<br/>
<br/>
Available commands:<br/>
<br/>
    backup  Создание резервной копии<br/>
    deploy  Развертывание сайта mycoolsite.com</p></div>
  
</div>

<p class="vspace"/><h4><a name="params" id="params"/> Передача параметров</h4>
<p>Выше мы уже говорили о том, что в задачи для Fabric мы можем передавать параметры, приведем несколько примеров. Для демонстрации мы будем использовать простую функцию, которая просто выводит переданный параметр:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock20">
  <div class="sourceblocktext"><p class="python"><span class="co1"># -*- coding: UTF-8 -*-</span><br/>
<br/>
<span class="kw1">def</span> task <span class="br0">(</span>param<span class="br0">)</span>:<br/>
    <span class="kw1">print</span> param</p></div>
  
</div>

<p class="vspace">Если мы забудем передать параметр, то вызов команды <em>fab task</em> приведет к ошибке:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock21">
  <div class="sourceblocktext"><p class="text">$ fab task<br/>
<br/>
Traceback (most recent call last):<br/>
  File "/usr/local/lib/python2.7/dist-packages/Fabric-1.10.1-py2.7.egg/fabric/main.py", line 743, in main<br/>
    *args, **kwargs<br/>
  File "/usr/local/lib/python2.7/dist-packages/Fabric-1.10.1-py2.7.egg/fabric/tasks.py", line 424, in execute<br/>
    results['&lt;local-only&gt;'] = task.run(*args, **new_kwargs)<br/>
  File "/usr/local/lib/python2.7/dist-packages/Fabric-1.10.1-py2.7.egg/fabric/tasks.py", line 174, in run<br/>
    return self.wrapped(*args, **kwargs)<br/>
TypeError: task() takes exactly 1 argument (0 given)</p></div>
  
</div>

<p class="vspace">Если мы укажем значение параметра, то все будет работать, как положено:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock22">
  <div class="sourceblocktext"><p class="text">$ fab task:"Hello world!"<br/>
<br/>
Hello world!<br/>
<br/>
Done.</p></div>
  
</div>

<p class="vspace">Аналогичного результата мы добьемся, если будем указывать имя параметра:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock23">
  <div class="sourceblocktext"><p class="text">$ fab task:param="Hello world!"<br/>
<br/>
Hello world!<br/>
<br/>
Done.</p></div>
  
</div>

<p class="vspace">Как и везде в языке Python, можно использовать значения параметров по умолчанию:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock24">
  <div class="sourceblocktext"><p class="python"><span class="co1"># -*- coding: UTF-8 -*-</span><br/>
<br/>
<span class="kw1">def</span> task <span class="br0">(</span>param=<span class="kw2">False</span><span class="br0">)</span>:<br/>
    <span class="kw1">print</span> param</p></div>
  
</div>

<p class="vspace">В этом случае значение параметра можно не передавать:
</p>
<p class="vspace"/>


<p class="vspace">Если же задача функция принимает два и более значений, то параметры передаются через запятую. Например:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock26">
  <div class="sourceblocktext"><p class="python"><span class="co1"># -*- coding: UTF-8 -*-</span><br/>
<br/>
<span class="kw1">def</span> task <span class="br0">(</span>param1, param2<span class="br0">)</span>:<br/>
    <span class="kw1">print</span> param1<br/>
    <span class="kw1">print</span> param2</p></div>
  
</div>

<p class="vspace"/>
<div class="sourceblock " id="sourceblock27">
  <div class="sourceblocktext"><p class="text">$ fab task:"Hello","World"<br/>
<br/>
Hello<br/>
World<br/>
<br/>
Done.</p></div>
  
</div>

<p class="vspace">Главное тут не ошибиться и не добавить после запятой пробел, иначе второй параметр будет воспринят, как имя другой команды:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock28">
  <div class="sourceblocktext"><p class="text">$ fab task:"Hello", "World"<br/>
<br/>
Warning: Command(s) not found:<br/>
    World<br/>
<br/>
Available commands:<br/>
<br/>
    task</p></div>
  
</div>

<p class="vspace">Как видно из предыдущей ошибки, Fabric позволяет одной командой запускать сразу несколько задач, которые будут выполняться последовательно.
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock29">
  <div class="sourceblocktext"><p class="python"><span class="co1"># -*- coding: UTF-8 -*-</span><br/>
<br/>
<span class="kw1">def</span> task1 <span class="br0">(</span><span class="br0">)</span>:<br/>
    <span class="kw1">print</span> <span class="st0">"Task 1"</span><br/>
<br/>
<br/>
<span class="kw1">def</span> task2 <span class="br0">(</span><span class="br0">)</span>:<br/>
    <span class="kw1">print</span> <span class="st0">"Task 2"</span></p></div>
  
</div>

<p class="vspace"/>
<div class="sourceblock " id="sourceblock30">
  <div class="sourceblocktext"><p class="text">$ fab task1 task2<br/>
<br/>
Task 1<br/>
Task 2<br/>
<br/>
Done.</p></div>
  
</div>

<p class="vspace">Но если одна из них завершится с ошибкой, то следующая задача выполнена не будет.
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock31">
  <div class="sourceblocktext"><p class="python"><span class="co1"># -*- coding: UTF-8 -*-</span><br/>
<br/>
<span class="kw1">def</span> task1 <span class="br0">(</span><span class="br0">)</span>:<br/>
    <span class="kw1">raise</span> <span class="kw2">Exception</span><br/>
<br/>
<br/>
<span class="kw1">def</span> task2 <span class="br0">(</span><span class="br0">)</span>:<br/>
    <span class="kw1">print</span> <span class="st0">"Task 2"</span></p></div>
  
</div>

<p class="vspace"/>
<div class="sourceblock " id="sourceblock32">
  <div class="sourceblocktext"><p class="text">$ fab task1 task2<br/>
<br/>
Task 1<br/>
Traceback (most recent call last):<br/>
  File "/usr/local/lib/python2.7/dist-packages/Fabric-1.10.1-py2.7.egg/fabric/main.py", line 743, in main<br/>
    *args, **kwargs<br/>
  File "/usr/local/lib/python2.7/dist-packages/Fabric-1.10.1-py2.7.egg/fabric/tasks.py", line 424, in execute<br/>
    results['&lt;local-only&gt;'] = task.run(*args, **new_kwargs)<br/>
  File "/usr/local/lib/python2.7/dist-packages/Fabric-1.10.1-py2.7.egg/fabric/tasks.py", line 174, in run<br/>
    return self.wrapped(*args, **kwargs)<br/>
  File "/media/Data/Workdir/Черновики/В процессе/Fabric/__attach/examples/03/fabfile.py", line 5, in task1<br/>
    raise Exception<br/>
Exception</p></div>
  
</div>

<p class="vspace">Теперь, когда мы рассмотрели способы запуска задач, перейдем к рассмотрению того, какие возможности нам предоставляет библиотека Fabric и ее модули. Внутри функций-задач мы можем использовать любые функции Python, в том числе и для копирования, удаления, переименования файлов и т.д. Также в Python есть средства для запуска программ. Но давайте посмотрим, какие функции нам предоставляет Fabric для облегчения работы на локальной компьютере и на удаленном сервере. 
</p>
<p class="vspace"/><h3><a name="local" id="local"/> Использование Fabric на локальном компьютере</h3>
<p>Знакомство с Fabric у меня началось с того, что я начал использовать эту библиотеку в качестве замены команды make и Makefile. Когда-то давно для сборки <a class="urllink" href="http://jenyay.net/Soft/Outwiker">OutWiker</a> использовался обычный Makefile. Например, команда <em>make win</em> собирала версию под Windows, а команда <em>make deb</em> делала deb-пакет под Linux'ы на основе Debian. 
</p>
<p class="vspace">В целом такая система работала, но была одна вещь, которая ужасно раздражала - это плохая переносимость Makefile между  Windows и Linux. Как известно, под Windows команды make могут выполнены различными версиями интерпретатора (например, той версией, что прилагается к cygwin или отдельно скачанной сборкой make или make, идущий вместе с Visual Studio). Я уже даже не помню, какие версии у меня стояли, но внезапно после установки какого-то софта make по-другому стал воспринимать переводы строк и то ли вместо написания команд на разных строках пришлось писать команды через &amp;&amp;, то ли наоборот, не суть важно. Главное, что Makefile не работал под разными сборками make. Тогда я понял, что надо искать замену, причем желательно, чтобы сборщик описывал бы задачи на любимом языке, т.е. на Python. Путем поверхностного осмотра кандидатов (одним из них был <a class="urllink" href="https://github.com/waf-project/waf">waf</a>), я остановился на Fabric. В первую очередь на это решение повлияло то, что Fabric позволяет писать не только на Python, но и где нужно, вставлять команды bash, благодаря чему makefile был переписан под Fabric буквально за час. После этого уже можно было его доводить до ума заменой некоторых команд bash на Python, где это улучшало читаемость кода.
</p>
<p class="vspace">В результате Makefile по-прежнему используется, но только как часть сборки deb-пакетов под Linux, в остальном везде используется Fabric.
</p>
<p class="vspace">Многие полезные функции из Fabric содержатся в модуле <em>fabric api</em>. Первые две функции, которые мы рассмотрим будут <em>lcd</em> и <em>local</em>. Первая из них - аналог команды <em>cd</em> консоли, вторая позволяет выполнять произвольные команды, как будто мы их запускаем в консоли. Главное удобство команды <em>lcd</em> перед стандартной для Python функции <em>os.chdir()</em>, которая выполняет, на первый взгляд, аналогичные действия (т.е. устанавливает рабочую директорию) в том, что функцию <em>lcd</em> можно использовать вместе с оператором <em>with</em>, при выходе из которого рабочая директория будет изменена на прежнее значение. Если рассмотреть работу функции <em>lcd</em> подробнее, то окажется, что она на самом деле не изменяет текущую рабочую директорию с точки зрения скрипта Python.
</p>
<p class="vspace">Рассмотрим пример, в котором будут выводиться рабочие директории с помощью функции стандартной библиотеки <em>os.getpwd()</em> и с помощью команды <em>pwd</em> консоли (для выполнения команды <em>pwd</em> будет использоваться вышеупомянутая функция <em>local</em>:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock33">
  <div class="sourceblocktext"><p class="python"><span class="co1"># -*- coding: UTF-8 -*-</span><br/>
<br/>
<span class="kw1">import</span> <span class="kw3">os</span><br/>
<br/>
<span class="kw1">from</span> fabric.<span class="me1">api</span> <span class="kw1">import</span> lcd, local<br/>
<br/>
<br/>
<span class="kw1">def</span> task <span class="br0">(</span><span class="br0">)</span>:<br/>
    <span class="co1"># Выведем исходные рабочие директории</span><br/>
    <span class="kw1">print</span> <span class="st0">"**** Before 'with' operator"</span><br/>
    <span class="kw1">print</span> <span class="kw3">os</span>.<span class="me1">getcwd</span><span class="br0">(</span><span class="br0">)</span><br/>
    local <span class="br0">(</span><span class="st0">"pwd"</span><span class="br0">)</span><br/>
    <span class="kw1">print</span><br/>
<br/>
    with lcd <span class="br0">(</span><span class="st0">"~"</span><span class="br0">)</span>:<br/>
        <span class="kw1">print</span> <span class="st0">"**** Inside 'with' operator"</span><br/>
        <span class="co1"># Выведем рабочие директории внутри оператора with</span><br/>
        <span class="kw1">print</span> <span class="kw3">os</span>.<span class="me1">getcwd</span><span class="br0">(</span><span class="br0">)</span><br/>
        local <span class="br0">(</span><span class="st0">"pwd"</span><span class="br0">)</span><br/>
        <span class="kw1">print</span><br/>
<br/>
    <span class="co1"># Выведем рабочие директории после оператора with</span><br/>
    <span class="kw1">print</span> <span class="st0">"**** After 'with' operator"</span><br/>
    <span class="kw1">print</span> <span class="kw3">os</span>.<span class="me1">getcwd</span><span class="br0">(</span><span class="br0">)</span><br/>
    local <span class="br0">(</span><span class="st0">"pwd"</span><span class="br0">)</span><br/>
    <span class="kw1">print</span></p></div>
  
</div>

<p class="vspace">Результат в моем случае выглядит так (понятно, что у вас директории будут называться иначе):
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock34">
  <div class="sourceblocktext"><p class="text">jenyay@jenyay-desktop:/media/Data/Workdir/Черновики/В процессе/Fabric/__attach/examples/04$ fab task<br/>
<br/>
**** Before 'with' operator<br/>
/media/Data/Workdir/Черновики/В процессе/Fabric/__attach/examples/04<br/>
[localhost] local: pwd<br/>
/media/Data/Workdir/Черновики/В процессе/Fabric/__attach/examples/04<br/>
<br/>
**** Inside 'with' operator<br/>
/media/Data/Workdir/Черновики/В процессе/Fabric/__attach/examples/04<br/>
[localhost] local: pwd<br/>
/home/jenyay<br/>
<br/>
**** After 'with' operator<br/>
/media/Data/Workdir/Черновики/В процессе/Fabric/__attach/examples/04<br/>
[localhost] local: pwd<br/>
/media/Data/Workdir/Черновики/В процессе/Fabric/__attach/examples/04<br/>
<br/>
<br/>
Done.</p></div>
  
</div>

<p class="vspace">Разумеется, внутри функции <em>local</em> можно выполнять что-то более полезное. Например, в fabfile проекта OutWiker в задаче <em>win</em>, с помощью которой создается сборка OutWiker под Windows, можно найти такие строки:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock35">
  <div class="sourceblocktext"><p class="python"><span class="kw1">def</span> win <span class="br0">(</span><span class="br0">)</span>:<br/>
...<br/>
    <span class="me1">with</span> lcd <span class="br0">(</span><span class="st0">"src"</span><span class="br0">)</span>:<br/>
            local <span class="br0">(</span><span class="st0">"python setup_win.py build"</span><span class="br0">)</span><br/>
...<br/>
    <span class="me1">with</span> lcd <span class="br0">(</span><span class="st0">"build/outwiker_win"</span><span class="br0">)</span>:<br/>
            local <span class="br0">(</span><span class="st0">"7z a ..<span class="es0">\o</span>utwiker_win_unstable.zip .<span class="es0">\*</span> .<span class="es0">\p</span>lugins -r -aoa"</span><span class="br0">)</span><br/>
...</p></div>
  
</div>

<p class="vspace">На момент написания этих строк fabfile проекта OutWiker из модуля <em>fabric.api</em> используются только функции <em>lcd</em> и <em>local</em>.
</p>
<p class="vspace"/><h3><a name="remote" id="remote"/> Использование Fabric для взаимодействия с удаленным сервером</h3>
<h4><a name="remotesettings" id="remotesettings"/> Настройка удаленного интерпретатора</h4>
<p>Fabric удобно использовать на локальном компьютере, но больше всего возможностей эта библиотека предоставляет для работы по сети на удаленных серверах. Все возможности библиотеки в этой статье мы не рассмотрим, но, чтобы понять принцип работы, поговорим о некоторых из них.
</p>
<p class="vspace">Для работы на удаленном сервере существуют аналоги локальных функций <em>lcd</em> и <em>local</em>, это функции <em>cd</em> и <em>run</em> соответственно. Чтобы научиться подключаться к серверу, сделаем fabfile с одной задачей, которая просто выполняет команду <em>ls</em> на сервере, чтобы вывести список файлов в домашней директории.
</p>
<p class="vspace">В простейшем случае скрипт будет такой, но нужно заранее предупредить, что он может не сработать:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock36">
  <div class="sourceblocktext"><p class="python"><span class="co1"># -*- coding: UTF-8 -*-</span><br/>
<br/>
<span class="kw1">from</span> fabric.<span class="me1">api</span> <span class="kw1">import</span> run<br/>
<br/>
<br/>
<span class="kw1">def</span> runls <span class="br0">(</span><span class="br0">)</span>:<br/>
    run <span class="br0">(</span><span class="st0">"ls"</span><span class="br0">)</span></p></div>
  
</div>

<p class="vspace">Как видите, в скрипте мы не задаем никакого адреса (хотя мы может это сделать, и воспользуемся этой возможностью позже). Если мы теперь выполним команду <em>fab runls</em>, то Fabric сначала попросит ввести адрес, куда мы должны подключиться, а затем результат уже будет зависеть от настроек удаленного сервера. Далее приведен вывод команды <em>fab runls</em> при подключении к удаленному хранилищу по локальной сети:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock37">
  <div class="sourceblocktext"><p class="text">$ fab runls<br/>
<br/>
No hosts found. Please specify (single) host string for connection: 192.168.100.10<br/>
[192.168.100.10] run: ls<br/>
[192.168.100.10] Passphrase for private key: <br/>
[192.168.100.10] out: Distrib         VirtualBox VMs  music           projects        Кино        Фото<br/>
[192.168.100.10] out: Downloads       backup          photo           temp            Книги<br/>
[192.168.100.10] out: <br/>
<br/>
<br/>
Done.<br/>
Disconnecting from 192.168.100.10... done.</p></div>
  
</div>

<p class="vspace">Но вполне может случиться и такая ошибка:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock38">
  <div class="sourceblocktext"><p class="text">$ fab runls<br/>
<br/>
No hosts found. Please specify (single) host string for connection: 192.168.100.10<br/>
[192.168.100.10] run: ls<br/>
[192.168.100.10] Passphrase for private key: <br/>
[192.168.100.10] Login password for 'jenyay': <br/>
[192.168.100.10] out: sh: /bin/bash: not found<br/>
[192.168.100.10] out: <br/>
<br/>
<br/>
Fatal error: run() received nonzero return code 127 while executing!<br/>
<br/>
Requested: ls<br/>
Executed: /bin/bash -l -c "ls"<br/>
<br/>
Aborting.<br/>
Disconnecting from 192.168.100.10... done.<br/>
run() received nonzero return code 127 while executing!<br/>
<br/>
Requested: ls<br/>
Executed: /bin/bash -l -c "ls"</p></div>
  
</div>

<p class="vspace">Здесь нет ничего страшного, это довольно частая ошибка, возникающая из-за того, что по умолчанию команда <em>run</em> на удаленном сервере пытается выполнить команду с помощью строки "/bin/bash -l -c "&lt;Команда&gt;"". Здесь можно обратить внимание на то, что явно указан путь до интерпретатора bash и то, что используется параметр <em>-c</em>, говорящий о том, что команды передаются далее в качестве строкового параметра. На удаленном сервере может не быть интерпретатора bash или он может быть расположен в другом месте. 
</p>
<p class="vspace">Указать путь до интерпретатора можно разными способами. Во-первых, можно воспользоваться параметром командной строки <em>--shell</em>:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock39">
  <div class="sourceblocktext"><p class="text">$ fab runls --shell="sh -c"<br/>
<br/>
No hosts found. Please specify (single) host string for connection: 192.168.100.10<br/>
[192.168.100.10] run: ls<br/>
[192.168.100.10] Passphrase for private key: <br/>
[192.168.100.10] out: Distrib         VirtualBox VMs  music           projects        Кино        Фото<br/>
[192.168.100.10] out: Downloads       backup          photo           temp            Книги<br/>
[192.168.100.10] out: <br/>
<br/>
<br/>
Done.<br/>
Disconnecting from 192.168.100.10... done.</p></div>
  
</div>

<p class="vspace">Поскольку на данном сервере не установлен интерпретатор bash, я воспользовался интерпретатором sh.
</p>
<p class="vspace">Второй способ задания параметров подключения состоит в том, чтобы воспользоваться классом <em>env</em> из <em>fabric.api</em>. Класс <em>env</em> содержит различные настройки, в том числе и для подключения к удаленному серверу. Для этого нам надо изменить скрипт:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock40">
  <div class="sourceblocktext"><p class="python"><span class="co1"># -*- coding: UTF-8 -*-</span><br/>
<br/>
<span class="kw1">from</span> fabric.<span class="me1">api</span> <span class="kw1">import</span> run, env<br/>
<br/>
env.<span class="me1">shell</span> = <span class="st0">"sh -c"</span><br/>
<br/>
<br/>
<span class="kw1">def</span> runls <span class="br0">(</span><span class="br0">)</span>:<br/>
    run <span class="br0">(</span><span class="st0">"ls"</span><span class="br0">)</span></p></div>
  
</div>

<p class="vspace">Теперь нам не нужно использовать параметр <em>--shell</em>:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock41">
  <div class="sourceblocktext"><p class="text">$ fab runls<br/>
<br/>
No hosts found. Please specify (single) host string for connection: 192.168.100.10<br/>
[192.168.100.10] run: ls<br/>
[192.168.100.10] Passphrase for private key: <br/>
[192.168.100.10] out: Distrib         VirtualBox VMs  music           projects        Кино        Фото<br/>
[192.168.100.10] out: Downloads       backup          photo           temp            Книги<br/>
[192.168.100.10] out: <br/>
<br/>
<br/>
Done.<br/>
Disconnecting from 192.168.100.10... done.</p></div>
  
</div>

<p class="vspace"/><h4><a name="hosts" id="hosts"/> Способы ввода адресов удаленных хостов</h4>
<p>Теперь сделаем так, чтобы нам не нужно было каждый раз вводить адрес сервера. Эту проблему можно решить также двумя способами: воспользоваться параметром командной строки <em>-H</em> или <em>--hosts</em> или добавить хосты с помощью свойства <em>env.hosts</em>. Для начала воспользуемся параметром командной строки. Обратите внимание, что параметр (как и свойство в классе <em>env</em>) называется <em>hosts</em> во множественном числе. Дело в том, что одну и ту же задачу можно одновременно запускать сразу на нескольких серверах (последовательно или параллельно). Поэтому при использовании параметра <em>--hosts</em> мы можем задать список хостов, разделенных запятой, а свойство <em>env.hosts</em> - это список строк.
</p>
<p class="vspace">Сначала воспользуемся предыдущим примером с использованием параметра <em>--hosts</em>:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock42">
  <div class="sourceblocktext"><p class="text">$ fab runls --hosts="192.168.100.10"<br/>
<br/>
[192.168.100.10] Executing task 'runls'<br/>
[192.168.100.10] run: ls<br/>
[192.168.100.10] Passphrase for private key: <br/>
[192.168.100.10] out: Distrib         VirtualBox VMs  music           projects        Кино        Фото<br/>
[192.168.100.10] out: Downloads       backup          photo           temp            Книги<br/>
[192.168.100.10] out: <br/>
<br/>
<br/>
Done.<br/>
Disconnecting from 192.168.100.10... done.</p></div>
  
</div>

<p class="vspace">Теперь изменим скрипт, чтобы адрес хоста задавался в нем:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock43">
  <div class="sourceblocktext"><p class="python"><span class="co1"># -*- coding: UTF-8 -*-</span><br/>
<br/>
<span class="kw1">from</span> fabric.<span class="me1">api</span> <span class="kw1">import</span> run, env<br/>
<br/>
env.<span class="me1">shell</span> = <span class="st0">'sh -c'</span><br/>
env.<span class="me1">hosts</span> = <span class="br0">[</span><span class="st0">'192.168.100.10'</span><span class="br0">]</span><br/>
<br/>
<br/>
<span class="kw1">def</span> runls <span class="br0">(</span><span class="br0">)</span>:<br/>
    run <span class="br0">(</span><span class="st0">'ls'</span><span class="br0">)</span></p></div>
  
</div>

<p class="vspace">Теперь мы можем запускать эту задачу без дополнительных параметров:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock44">
  <div class="sourceblocktext"><p class="text">$ fab runls<br/>
<br/>
[192.168.100.10] Executing task 'runls'<br/>
[192.168.100.10] run: ls<br/>
[192.168.100.10] Passphrase for private key: <br/>
[192.168.100.10] out: Distrib         VirtualBox VMs  music           projects        Кино        Фото<br/>
[192.168.100.10] out: Downloads       backup          photo           temp            Книги<br/>
[192.168.100.10] out: <br/>
<br/>
<br/>
Done.<br/>
Disconnecting from 192.168.100.10... done.</p></div>
  
</div>

<p class="vspace">Чтобы продемонстировать работу сразу с несколькими хостами, добавлю в <em>env.hosts</em> адрес еще одного сервера:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock45">
  <div class="sourceblocktext"><p class="python"><span class="co1"># -*- coding: UTF-8 -*-</span><br/>
<br/>
<span class="kw1">from</span> fabric.<span class="me1">api</span> <span class="kw1">import</span> run, env<br/>
<br/>
env.<span class="me1">shell</span> = <span class="st0">'sh -c'</span><br/>
env.<span class="me1">hosts</span> = <span class="br0">[</span><span class="st0">'192.168.100.10'</span>,<br/>
             <span class="st0">'192.168.100.20'</span><span class="br0">]</span><br/>
<br/>
<br/>
<span class="kw1">def</span> runls <span class="br0">(</span><span class="br0">)</span>:<br/>
    run <span class="br0">(</span><span class="st0">'ls'</span><span class="br0">)</span></p></div>
  
</div>

<p class="vspace">Результат работы будет выглядеть следующим образом:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock46">
  <div class="sourceblocktext"><p class="text">$ fab runls<br/>
<br/>
[192.168.100.10] Executing task 'runls'<br/>
[192.168.100.10] run: ls<br/>
[192.168.100.10] Passphrase for private key: <br/>
[192.168.100.10] out: Distrib         VirtualBox VMs  music           projects        Кино        Фото<br/>
[192.168.100.10] out: Downloads       backup          photo           temp            Книги<br/>
[192.168.100.10] out: <br/>
<br/>
[192.168.100.20] Executing task 'runls'<br/>
[192.168.100.20] run: ls<br/>
[192.168.100.20] Passphrase for private key: <br/>
[192.168.100.20] out: Maildir           backups         domains         imap            public_html     tmp<br/>
[192.168.100.20] out: <br/>
<br/>
<br/>
Done.<br/>
Disconnecting from 192.168.100.20... done.<br/>
Disconnecting from 192.168.100.10... done.</p></div>
  
</div>

<p class="vspace"/><h4><a name="passwords" id="passwords"/> Избавляемся от ввода пароля</h4>
<p>В приведенных выше примерах при каждом запуске приходилось вводить пароли. Это сравнительно безопасно, но не удобно, особенно если вы используете Fabric для запуска скриптов сразу на нескольких серверах. С помощью класса <em>env</em> мы можем записать пароли в скрипт, воспользовавшись словарем <em>env.passwords</em>. В этом словаре ключ - полный адрес сервера, <strong>обязательно включающий имя пользователя и порт</strong>, а значение - пароль. Например, предыдущий скрипт может выглядеть следующим образом (разумеется, все пароли вымышленные, любые совпадения случайны :) ):
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock47">
  <div class="sourceblocktext"><p class="python"><span class="co1"># -*- coding: UTF-8 -*-</span><br/>
<br/>
<span class="kw1">from</span> fabric.<span class="me1">api</span> <span class="kw1">import</span> run, env<br/>
<br/>
env.<span class="me1">shell</span> = <span class="st0">'sh -c'</span><br/>
env.<span class="me1">hosts</span> = <span class="br0">[</span><span class="st0">'192.168.100.10'</span>,<br/>
             <span class="st0">'192.168.100.20'</span><span class="br0">]</span><br/>
<br/>
env.<span class="me1">passwords</span> = <span class="br0">{</span><br/>
    <span class="st0">'jenyay@192.168.100.10:22'</span>: <span class="st0">'123456'</span>,<br/>
    <span class="st0">'jenyay@192.168.100.20:22'</span>: <span class="st0">'111111'</span>,<br/>
<span class="br0">}</span><br/>
<br/>
<br/>
<span class="kw1">def</span> runls <span class="br0">(</span><span class="br0">)</span>:<br/>
    run <span class="br0">(</span><span class="st0">'ls'</span><span class="br0">)</span></p></div>
  
</div>

<p class="vspace">Теперь, если все задано правильно, то вводить пароль просить не будут:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock48">
  <div class="sourceblocktext"><p class="text">$ fab runls<br/>
<br/>
[192.168.100.10] Executing task 'runls'<br/>
[192.168.100.10] run: ls<br/>
[192.168.100.10] out: Distrib         VirtualBox VMs  music           projects        Кино        Фото<br/>
[192.168.100.10] out: Downloads       backup          photo           temp            Книги<br/>
[192.168.100.10] out: <br/>
<br/>
[192.168.100.20] Executing task 'runls'<br/>
[192.168.100.20] run: ls<br/>
[192.168.100.20] out: Maildir           backups         domains         imap            public_html     tmp<br/>
[192.168.100.20] out: <br/>
<br/>
<br/>
Done.<br/>
Disconnecting from 192.168.100.20... done.<br/>
Disconnecting from 192.168.100.10... done.</p></div>
  
</div>

<p class="vspace"/><h4><a name="parallel" id="parallel"/> Параллельное выполнение задач</h4>
<p>Поскольку мы полностью избавились от ввода текста в консоль, теперь мы можем воспользоваться еще одной особенностью Fabric - мы можем запустить задачу на двух серверах параллельно. Для этого достаточно добавить параметр <em>--parallel</em> или <em>-P</em>. Результат будет выглядеть примерно таким образом:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock49">
  <div class="sourceblocktext"><p class="text">$ fab runls --parallel<br/>
<br/>
[192.168.100.10] Executing task 'runls'<br/>
[192.168.100.20] Executing task 'runls'<br/>
[192.168.100.10] run: ls<br/>
[192.168.100.20] run: ls<br/>
[192.168.100.20] out: Maildir           backups         domains         imap            public_html     tmp<br/>
[192.168.100.20] out: <br/>
<br/>
[192.168.100.10] out: Distrib         VirtualBox VMs  music           projects        Кино        Фото<br/>
[192.168.100.10] out: Downloads       backup          photo           temp            Книги<br/>
[192.168.100.10] out: <br/>
<br/>
<br/>
Done.</p></div>
  
</div>

<p class="vspace">Подобного результата мы можем добиться без использования параметров командной строки, для этого нужно обернуть функцию <em>runls</em> в <em>fabfile.py</em> декоратором <em>paralell</em> из <em>fabric.api</em>:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock50">
  <div class="sourceblocktext"><p class="python"><span class="co1"># -*- coding: UTF-8 -*-</span><br/>
<br/>
<span class="kw1">from</span> fabric.<span class="me1">api</span> <span class="kw1">import</span> run, env, parallel<br/>
<br/>
env.<span class="me1">shell</span> = <span class="st0">'sh -c'</span><br/>
env.<span class="me1">hosts</span> = <span class="br0">[</span><span class="st0">'192.168.100.10'</span>,<br/>
             <span class="st0">'192.168.100.20'</span><span class="br0">]</span><br/>
<br/>
env.<span class="me1">passwords</span> = <span class="br0">{</span><br/>
    <span class="st0">'jenyay@192.168.100.10:22'</span>: <span class="st0">'123456'</span>,<br/>
    <span class="st0">'jenyay@192.168.100.20:22'</span>: <span class="st0">'111111'</span>,<br/>
<span class="br0">}</span><br/>
<br/>
<br/>
@parallel<br/>
<span class="kw1">def</span> runls <span class="br0">(</span><span class="br0">)</span>:<br/>
    run <span class="br0">(</span><span class="st0">'ls'</span><span class="br0">)</span></p></div>
  
</div>

<p class="vspace">Запускаем и проверяем результат:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock51">
  <div class="sourceblocktext"><p class="text">$ fab runls<br/>
<br/>
[192.168.100.10] Executing task 'runls'<br/>
[192.168.100.20] Executing task 'runls'<br/>
[192.168.100.10] run: ls<br/>
[192.168.100.20] run: ls<br/>
[192.168.100.20] out: Maildir           backups         domains         imap            public_html     tmp<br/>
[192.168.100.20] out: <br/>
<br/>
[192.168.100.10] out: Distrib         VirtualBox VMs  music           projects        Кино        Фото<br/>
[192.168.100.10] out: Downloads       backup          photo           temp            Книги<br/>
[192.168.100.10] out: <br/>
<br/>
<br/>
Done.</p></div>
  
</div>

<p class="vspace">Еще раз отмечу, что задачи можно запускать параллельно только если они не требуют ввода текста в консоли. В противном случае возникнет ошибка.
</p>
<p class="vspace"/><h3><a name="errors" id="errors"/> Обработка ошибок</h3>
<p>Теперь посмотрим, как мы можем отслеживать ошибки, возникающие на удаленном сервере во время выполнения команды. Для демонстрации мы изменим предыдущий пример, чтобы команда <em>ls</em> выводила содержимое не домашней директории, а директории, имя которой будет передаваться в качестве параметра:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock52">
  <div class="sourceblocktext"><p class="python"><span class="co1"># -*- coding: UTF-8 -*-</span><br/>
<br/>
<span class="kw1">from</span> fabric.<span class="me1">api</span> <span class="kw1">import</span> run, env<br/>
<br/>
env.<span class="me1">shell</span> = <span class="st0">'sh -c'</span><br/>
env.<span class="me1">hosts</span> = <span class="br0">[</span><span class="st0">'192.168.100.10'</span><span class="br0">]</span><br/>
<br/>
env.<span class="me1">passwords</span> = <span class="br0">{</span><br/>
    <span class="st0">'jenyay@192.168.100.10:22'</span>: <span class="st0">'12345'</span>,<br/>
<span class="br0">}</span><br/>
<br/>
<br/>
<span class="kw1">def</span> runls <span class="br0">(</span>dirname<span class="br0">)</span>:<br/>
    command = <span class="st0">'ls {}'</span>.<span class="me1">format</span> <span class="br0">(</span>dirname<span class="br0">)</span><br/>
    run <span class="br0">(</span>command<span class="br0">)</span><br/>
<br/>
    <span class="kw1">print</span> <span class="st0">"**** Task is completed"</span></p></div>
  
</div>

<p class="vspace">Если мы передадим существующую на удаленном хосте директорию, то все будет работать хорошо, и мы увидим сообщение о том, что выполнение задачи доведено до конца:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock53">
  <div class="sourceblocktext"><p class="text">$ fab runls:projects<br/>
<br/>
[192.168.100.10] Executing task 'runls'<br/>
[192.168.100.10] run: ls projects<br/>
[192.168.100.10] out: LJournalist_old  drawspectrum     ljournalist      ljwatcher        training_site<br/>
[192.168.100.10] out: Scripts          exercise_maker   ljournalist_web  outwiker<br/>
[192.168.100.10] out: <br/>
<br/>
**** Task is completed<br/>
<br/>
Done.<br/>
Disconnecting from 192.168.100.10... done.</p></div>
  
</div>

<p class="vspace">Если же возникнет какая-то ошибка, то сразу после нее выполнение скрипта прервется, даже если мы могли бы обработать возникшую ошибку:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock54">
  <div class="sourceblocktext"><p class="text">$ fab runls:abyrvalg<br/>
<br/>
[192.168.100.10] Executing task 'runls'<br/>
[192.168.100.10] run: ls abyrvalg<br/>
[192.168.100.10] out: ls: abyrvalg: No such file or directory<br/>
[192.168.100.10] out: <br/>
<br/>
<br/>
Fatal error: run() received nonzero return code 1 while executing!<br/>
<br/>
Requested: ls abyrvalg<br/>
Executed: sh -c "ls abyrvalg"<br/>
<br/>
Aborting.<br/>
Disconnecting from 192.168.100.10... done.<br/>
run() received nonzero return code 1 while executing!<br/>
<br/>
Requested: ls abyrvalg<br/>
Executed: sh -c "ls abyrvalg"</p></div>
  
</div>

<p class="vspace">Как быть? Мы можем указать Fabric, чтобы при возникновении ошибки, выполнение скрипта не прерывалось, а, например, только выводился текст ошибки, после чего выполнение скрипта продолжалось. Это можно сделать глобально, установив <em>env.warn_only=True</em>, но можно сделать более красиво, обернув команду, которая может ожидаемо вызвать ошибку, в блок with. Для этого мы воспользуемся функцией <em>settings</em>. Эта функция может принимать большое количество параметров, мы пока воспользуемся только одним - <em>warn_only</em>. Также мы воспользуемся тем, что функция <em>run</em>, возвращает объект, из которого можно извлечь код ошибки и текст, который команда выводила в консоль:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock55">
  <div class="sourceblocktext"><p class="python"><span class="co1"># -*- coding: UTF-8 -*-</span><br/>
<br/>
<span class="kw1">from</span> fabric.<span class="me1">api</span> <span class="kw1">import</span> run, env, settings<br/>
<br/>
env.<span class="me1">shell</span> = <span class="st0">'sh -c'</span><br/>
env.<span class="me1">hosts</span> = <span class="br0">[</span><span class="st0">'192.168.100.10'</span><span class="br0">]</span><br/>
<br/>
env.<span class="me1">passwords</span> = <span class="br0">{</span><br/>
    <span class="st0">'jenyay@192.168.100.10:22'</span>: <span class="st0">'12345'</span>,<br/>
<span class="br0">}</span><br/>
<br/>
<br/>
<span class="kw1">def</span> runls <span class="br0">(</span>dirname<span class="br0">)</span>:<br/>
    with settings <span class="br0">(</span>warn_only=<span class="kw2">True</span><span class="br0">)</span>:<br/>
        command = <span class="st0">'ls {}'</span>.<span class="me1">format</span> <span class="br0">(</span>dirname<span class="br0">)</span><br/>
        result = run <span class="br0">(</span>command<span class="br0">)</span><br/>
<br/>
    <span class="kw1">print</span> <span class="st0">'result: {}'</span>.<span class="me1">format</span> <span class="br0">(</span>result.<span class="me1">return_code</span><span class="br0">)</span><br/>
<br/>
    <span class="kw1">print</span> <span class="st0">"**** Task is completed"</span></p></div>
  
</div>

<p class="vspace">Если мы передадим в задачу существующую директорию, то результат будет напоминать предыдущий, с той лишь разницей, что еще будет выведен нулевой код ошибки:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock56">
  <div class="sourceblocktext"><p class="text">$ fab runls:projects<br/>
<br/>
[192.168.100.10] Executing task 'runls'<br/>
[192.168.100.10] run: ls projects<br/>
[192.168.100.10] out: LJournalist_old  drawspectrum     ljournalist      ljwatcher        training_site<br/>
[192.168.100.10] out: Scripts          exercise_maker   ljournalist_web  outwiker<br/>
[192.168.100.10] out: <br/>
<br/>
result: 0<br/>
**** Task is completed<br/>
<br/>
Done.<br/>
Disconnecting from 192.168.100.10... done.</p></div>
  
</div>

<p class="vspace">Если же переданной директории не существует, то выполнение задачи все равно будет доведено до конца. Мы могли бы как-то обработать ошибку, но в данном случае мы ее просто проигнорируем:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock57">
  <div class="sourceblocktext"><p class="text">$ fab runls:abyrvalg<br/>
<br/>
[192.168.100.10] Executing task 'runls'<br/>
[192.168.100.10] run: ls abyrvalg<br/>
[192.168.100.10] out: ls: abyrvalg: No such file or directory<br/>
[192.168.100.10] out: <br/>
<br/>
<br/>
Warning: run() received nonzero return code 1 while executing 'ls abyrvalg'!<br/>
<br/>
result: 1<br/>
**** Task is completed<br/>
<br/>
Done.<br/>
Disconnecting from 192.168.100.10... done.</p></div>
  
</div>

<p class="vspace">Мы могли бы указать, что не нужно писать даже предупреждения. Для этого в качестве первого параметра функции <em>settings</em> нужно передать менеджер контекста, который можно создать с помощью функции <em>hide</em>. Эта функция принимает текстовые параметры, описывающие, что именно нужно скрыть, это могут быть строки вида 'running', 'stdout', 'stderr', 'warnings'. Мы скроем только предупреждения:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock58">
  <div class="sourceblocktext"><p class="python"><span class="co1"># -*- coding: UTF-8 -*-</span><br/>
<br/>
<span class="kw1">from</span> fabric.<span class="me1">api</span> <span class="kw1">import</span> run, env, settings, hide<br/>
<br/>
env.<span class="me1">shell</span> = <span class="st0">'sh -c'</span><br/>
env.<span class="me1">hosts</span> = <span class="br0">[</span><span class="st0">'192.168.100.10'</span><span class="br0">]</span><br/>
<br/>
env.<span class="me1">passwords</span> = <span class="br0">{</span><br/>
    <span class="st0">'jenyay@192.168.100.10:22'</span>: <span class="st0">'12345'</span>,<br/>
<span class="br0">}</span><br/>
<br/>
<br/>
<span class="kw1">def</span> runls <span class="br0">(</span>dirname<span class="br0">)</span>:<br/>
    with settings <span class="br0">(</span>hide<span class="br0">(</span><span class="st0">'warnings'</span><span class="br0">)</span>, warn_only=<span class="kw2">True</span><span class="br0">)</span>:<br/>
        command = <span class="st0">'ls {}'</span>.<span class="me1">format</span> <span class="br0">(</span>dirname<span class="br0">)</span><br/>
        result = run <span class="br0">(</span>command<span class="br0">)</span><br/>
<br/>
    <span class="kw1">print</span> <span class="st0">'result: {}'</span>.<span class="me1">format</span> <span class="br0">(</span>result.<span class="me1">return_code</span><span class="br0">)</span><br/>
<br/>
    <span class="kw1">print</span> <span class="st0">"**** Task is completed"</span></p></div>
  
</div>

<p class="vspace">Теперь в случае ошибки вывод будет таким:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock59">
  <div class="sourceblocktext"><p class="text">$ fab runls:abyrvalg<br/>
<br/>
[192.168.100.10] Executing task 'runls'<br/>
[192.168.100.10] run: ls abyrvalg<br/>
[192.168.100.10] out: ls: abyrvalg: No such file or directory<br/>
[192.168.100.10] out: <br/>
<br/>
result: 1<br/>
**** Task is completed<br/>
<br/>
Done.<br/>
Disconnecting from 192.168.100.10... done.</p></div>
  
</div>

<p class="vspace"/><h3><a name="advanced" id="advanced"/> Расширенные возможности запуска задач. Декоратор <em>task</em></h3>
<h4><a name="newstyle" id="newstyle"/> Новый стиль задач</h4>
<p>До сих пор мы создавали задачи, используя просто функции верхнего уровня в файле <em>fabfile.py</em> (или его аналоге), однако, начиная с Fabric 1.1 появились так называемые задачи нового стиля (new-style tasks), позволяющие еще более гибко их настраивать. Главное нововведение Fabric 1.1 - это декоратор <em>task</em> и класс <em>Task</em>, наследуя который можно создавать новые задачи. В этой статье мы рассмотрим только декоратор. Ранее все функции, не начинающиеся с символа "_", считались задачей. С новым стилем мы можем создавать функции с любыми именами, но снаружи видны будут только те из них, кто помечен декоратором <em>task</em>. Это правило работает, если есть хотя бы одна функция, отмеченная этим декоратором.
</p>
<p class="vspace">Например, пусть у нас есть такой <em>fabfile.py</em>:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock60">
  <div class="sourceblocktext"><p class="python"><span class="co1"># -*- coding: UTF-8 -*-</span><br/>
<br/>
<span class="kw1">from</span> fabric.<span class="me1">api</span> <span class="kw1">import</span> task<br/>
<br/>
<br/>
@task<br/>
<span class="kw1">def</span> task1 <span class="br0">(</span><span class="br0">)</span>:<br/>
    <span class="kw1">print</span> <span class="st0">"Task 1"</span><br/>
<br/>
<br/>
@task<br/>
<span class="kw1">def</span> task2 <span class="br0">(</span><span class="br0">)</span>:<br/>
    <span class="kw1">print</span> <span class="st0">"Task 2"</span><br/>
<br/>
<br/>
<span class="kw1">def</span> internal_func <span class="br0">(</span><span class="br0">)</span>:<br/>
    <span class="kw1">print</span> <span class="st0">"internal"</span></p></div>
  
</div>

<p class="vspace">С помощью параметра <em>--list</em> посмотрим список всех задач в этом файле:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock61">
  <div class="sourceblocktext"><p class="text">$ fab --list<br/>
<br/>
Available commands:<br/>
<br/>
    task1<br/>
    task2</p></div>
  
</div>

<p class="vspace">Как видно, функция <em>internal_func</em> не отображается, хотя она и не начинается с символа "_".
</p>
<p class="vspace"/><h4><a name="default" id="default"/> Задачи по умолчанию</h4>
<p>С помощью декоратора <em>task</em> можно указать задачу, которая будет выполняться в случае, если команде <em>fab</em> не будет передано имя задачи. Для этого в качестве параметра декоратора нужно задать <em>default=True</em>:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock62">
  <div class="sourceblocktext"><p class="python"><span class="co1"># -*- coding: UTF-8 -*-</span><br/>
<br/>
<span class="kw1">from</span> fabric.<span class="me1">api</span> <span class="kw1">import</span> task<br/>
<br/>
<br/>
@task <span class="br0">(</span>default=<span class="kw2">True</span><span class="br0">)</span><br/>
<span class="kw1">def</span> task1 <span class="br0">(</span><span class="br0">)</span>:<br/>
    <span class="kw1">print</span> <span class="st0">"Task 1"</span><br/>
<br/>
<br/>
@task<br/>
<span class="kw1">def</span> task2 <span class="br0">(</span><span class="br0">)</span>:<br/>
    <span class="kw1">print</span> <span class="st0">"Task 2"</span></p></div>
  
</div>

<p class="vspace">Теперь нам не нужно использовать команду <em>fab task1</em>, чтобы выполнить первую задачу, достаточно просто запустить команду <em>fab</em>:
</p>
<p class="vspace"/>


<p class="vspace">Разумеется, если мы выполним только команду <em>fab task2</em>, то будет выполнена только она:
</p>
<p class="vspace"/>


<p class="vspace"/><h4><a name="alias" id="alias"/> Псевдонимы</h4>
<p>С помощью декоратора <em>task</em> можно создавать псевдонимы для задач. В этом случае у задачи будет два имени, вызывать ее можно по любому из них. Чтобы создать псевдоним, в декоратор <em>task</em> нужно добавить параметр <em>alias="псевдоним"</em>. Изменим предыдущий пример:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock65">
  <div class="sourceblocktext"><p class="python"><span class="co1"># -*- coding: UTF-8 -*-</span><br/>
<br/>
<span class="kw1">from</span> fabric.<span class="me1">api</span> <span class="kw1">import</span> task<br/>
<br/>
<br/>
@task <span class="br0">(</span>alias=<span class="st0">"mytask"</span><span class="br0">)</span><br/>
<span class="kw1">def</span> task1 <span class="br0">(</span><span class="br0">)</span>:<br/>
    <span class="kw1">print</span> <span class="st0">"Task 1"</span><br/>
<br/>
<br/>
@task<br/>
<span class="kw1">def</span> task2 <span class="br0">(</span><span class="br0">)</span>:<br/>
    <span class="kw1">print</span> <span class="st0">"Task 2"</span></p></div>
  
</div>

<p class="vspace">Если мы теперь выполним команду <em>fab --list</em>, то в списке будет показаны три задачи:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock66">
  <div class="sourceblocktext"><p class="text">$ fab --list<br/>
<br/>
Available commands:<br/>
<br/>
    mytask<br/>
    task1<br/>
    task2</p></div>
  
</div>

<p class="vspace">Если мы выполним команду <em>fab mytask</em>, то это будет равносильно выполнению команды <em>fab task1</em>:
</p>
<p class="vspace"/>
<div class="sourceblock " id="sourceblock67">
  <div class="sourceblocktext"><p class="text">$ fab mytask<br/>
<br/>
Task 1<br/>
<br/>
Done.</p></div>
  
</div>

<p class="vspace"/><h3><a name="outro" id="outro"/> Заключение</h3>
<p>В этой статье мы рассмотрели основные, но далеко не все возможности библиотеки Fabric. Эта библиотека позволяет легко автоматизировать рутинные задачи как при работе на локальном компьютере, так и на удаленном сервере. С помощью Fabric можно создавать резервные копии, развертывать веб-приложения и даже использовать его для сборки программ. Преимущество Fabric в том, что эта библиотека не будет требовать от вас изучения нового синтаксиса, все скрипты пишутся на Python.
</p>
<p class="vspace">Спасибо за внимание, жду ваших отзывов и комментариев. Интересно, многие ли из вас дочитают эту большую статью до конца. :)
</p>
<p class="vspace"><strong><a class="wikilink" href="http://jenyay.net/Programming/Python">Другие статьи на тему программирования на Python</a></strong>
</p>
<p class="vspace"><a name="comments" id="comments"/>
</p>
<p class="vspace"> </p> 

<p class="vspace"/>

<hr/>
<p class="vspace"/>
</div>

			</div></body></html>