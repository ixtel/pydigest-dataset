<html><body><div><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b2e6db554244740452-1"><span class="crayon-p">#!/usr/bin/env python</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-2"><span class="crayon-p">#</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-3"><span class="crayon-p"># Copyright 2010 Facebook</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-4"><span class="crayon-p">#</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-5"><span class="crayon-p"># Licensed under the Apache License, Version 2.0 (the "License"); you may</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-6"><span class="crayon-p"># not use this file except in compliance with the License. You may obtain</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-7"><span class="crayon-p"># a copy of the License at</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-8"><span class="crayon-p">#</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-9"><span class="crayon-p">#     http://www.apache.org/licenses/LICENSE-2.0</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-10"><span class="crayon-p">#</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-11"><span class="crayon-p"># Unless required by applicable law or agreed to in writing, software</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-12"><span class="crayon-p"># distributed under the License is distributed on an "AS IS" BASIS, WITHOUT</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-13"><span class="crayon-p"># WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-14"><span class="crayon-p"># License for the specific language governing permissions and limitations</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-15"><span class="crayon-p"># under the License.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-16"> </p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-17"><span class="crayon-s">""</span><span class="crayon-s">"Python client library for the Facebook Platform.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-18"><span class="crayon-s">This client library is designed to support the Graph API and the</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-19"><span class="crayon-s">official Facebook JavaScript SDK, which is the canonical way to</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-20"><span class="crayon-s">implement Facebook authentication. Read more about the Graph API at</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-21"><span class="crayon-s">http://developers.facebook.com/docs/api. You can download the Facebook</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-22"><span class="crayon-s">JavaScript SDK at http://github.com/facebook/connect-js/.</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-23"><span class="crayon-s">"</span><span class="crayon-s">""</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-24"> </p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-25"><span class="crayon-e">import </span><span class="crayon-e">hashlib</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-26"><span class="crayon-e">import </span><span class="crayon-e">hmac</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-27"><span class="crayon-e">import </span><span class="crayon-e">base64</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-28"><span class="crayon-e">import </span><span class="crayon-e">requests</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-29"><span class="crayon-e">import </span><span class="crayon-e">json</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-30"><span class="crayon-e">import </span><span class="crayon-e">re</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-31"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-32"><span class="crayon-st">try</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-33"><span class="crayon-h">    </span><span class="crayon-e">from </span><span class="crayon-v">urllib</span><span class="crayon-sy">.</span><span class="crayon-e">parse </span><span class="crayon-e">import </span><span class="crayon-v">parse_qs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">urlencode</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-34"><span class="crayon-e">except </span><span class="crayon-v">ImportError</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-35"><span class="crayon-h">    </span><span class="crayon-e">from </span><span class="crayon-e">urlparse </span><span class="crayon-e">import </span><span class="crayon-e">parse_qs</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-36"><span class="crayon-e">    </span><span class="crayon-e">from </span><span class="crayon-e">urllib </span><span class="crayon-e">import </span><span class="crayon-e">urlencode</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-37"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-38"><span class="crayon-i">from</span><span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-h"> </span><span class="crayon-e">import </span><span class="crayon-e">version</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-39"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-40"> </p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-41"><span class="crayon-v">__version__</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">version</span><span class="crayon-sy">.</span><span class="crayon-e">__version__</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-42"> </p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-43"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-44"><span class="crayon-v">VALID_API_VERSIONS</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-s">"2.0"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"2.1"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"2.2"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"2.3"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"2.4"</span><span class="crayon-sy">]</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-45"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-46"> </p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-47"><span class="crayon-t">class</span><span class="crayon-h"> </span><span class="crayon-e">GraphAPI</span><span class="crayon-sy">(</span><span class="crayon-t">object</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-48"><span class="crayon-h">    </span><span class="crayon-s">""</span><span class="crayon-s">"A client for the Facebook Graph API.</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-49"><span class="crayon-s">    See http://developers.facebook.com/docs/api for complete</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-50"><span class="crayon-s">    documentation for the API.</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-51"><span class="crayon-s">    The Graph API is made up of the objects in Facebook (e.g., people,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-52"><span class="crayon-s">    pages, events, photos) and the connections between them (e.g.,</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-53"><span class="crayon-s">    friends, photo tags, and event RSVPs). This client provides access</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-54"><span class="crayon-s">    to those primitive types in a generic way. For example, given an</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-55"><span class="crayon-s">    OAuth access token, this will fetch the profile of the active user</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-56"><span class="crayon-s">    and the list of the user's friends:</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-57"><span class="crayon-s">       graph = facebook.GraphAPI(access_token)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-58"><span class="crayon-s">       user = graph.get_object("</span><span class="crayon-i">me</span><span class="crayon-s">")</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-59"><span class="crayon-s">       friends = graph.get_connections(user["</span><span class="crayon-i">id</span><span class="crayon-s">"], "</span><span class="crayon-i">friends</span><span class="crayon-s">")</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-60"><span class="crayon-s">    You can see a list of all of the objects and connections supported</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-61"><span class="crayon-s">    by the API at http://developers.facebook.com/docs/reference/api/.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-62"><span class="crayon-s">    You can obtain an access token via OAuth or by using the Facebook</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-63"><span class="crayon-s">    JavaScript SDK. See</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-64"><span class="crayon-s">    http://developers.facebook.com/docs/authentication/ for details.</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-65"><span class="crayon-s">    If you are using the JavaScript SDK, you can use the</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-66"><span class="crayon-s">    get_user_from_cookie() method below to get the OAuth access token</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-67"><span class="crayon-s">    for the active user from the cookie saved by the SDK.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-68"><span class="crayon-s">    "</span><span class="crayon-s">""</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-69"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-70"><span class="crayon-h">    </span><span class="crayon-e">def </span><span class="crayon-e">__init__</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">access_token</span><span class="crayon-o">=</span><span class="crayon-v">None</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">timeout</span><span class="crayon-o">=</span><span class="crayon-v">None</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">version</span><span class="crayon-o">=</span><span class="crayon-v">None</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-71"><span class="crayon-h">        </span><span class="crayon-p"># The default version is only used if the version kwarg does not exist.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-72"><span class="crayon-h">        </span><span class="crayon-v">default_version</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"2.0"</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-73"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-74"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">access_token</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">access_token</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-75"><span class="crayon-e">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">timeout</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">timeout</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-76"> </p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-77"><span class="crayon-e">        </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">version</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-78"><span class="crayon-h">            </span><span class="crayon-v">version_regex</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">re</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-s">"^\d\.\d$"</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-79"><span class="crayon-h">            </span><span class="crayon-v">match</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">version_regex</span><span class="crayon-sy">.</span><span class="crayon-e">search</span><span class="crayon-sy">(</span><span class="crayon-e">str</span><span class="crayon-sy">(</span><span class="crayon-v">version</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-80"><span class="crayon-h">            </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">match </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-v">None</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-81"><span class="crayon-h">                </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">str</span><span class="crayon-sy">(</span><span class="crayon-v">version</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">VALID_API_VERSIONS</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-82"><span class="crayon-h">                    </span><span class="crayon-e">raise </span><span class="crayon-e">GraphAPIError</span><span class="crayon-sy">(</span><span class="crayon-s">"Valid API versions are "</span><span class="crayon-h"> </span><span class="crayon-o">+</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-83"><span class="crayon-h">                                        </span><span class="crayon-e">str</span><span class="crayon-sy">(</span><span class="crayon-v">VALID_API_VERSIONS</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">strip</span><span class="crayon-sy">(</span><span class="crayon-s">'[]'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-84"><span class="crayon-h">                </span><span class="crayon-st">else</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-85"><span class="crayon-h">                    </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">version</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"v"</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e">str</span><span class="crayon-sy">(</span><span class="crayon-v">version</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-86"><span class="crayon-h">            </span><span class="crayon-st">else</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-87"><span class="crayon-h">                </span><span class="crayon-e">raise </span><span class="crayon-e">GraphAPIError</span><span class="crayon-sy">(</span><span class="crayon-s">"Version number should be in the"</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-88"><span class="crayon-h">                                    </span><span class="crayon-s">" following format: #.# (e.g. 2.0)."</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-89"><span class="crayon-h">        </span><span class="crayon-st">else</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-90"><span class="crayon-h">            </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">version</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"v"</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e">default_version</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-91"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-92"><span class="crayon-e">    </span><span class="crayon-e">def </span><span class="crayon-e">get_object</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-v">args</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-93"><span class="crayon-h">        </span><span class="crayon-s">""</span><span class="crayon-s">"Fetchs the given object from the graph."</span><span class="crayon-s">""</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-94"><span class="crayon-h">        </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">request</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">version</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">"/"</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">args</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-95"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-96"><span class="crayon-h">    </span><span class="crayon-e">def </span><span class="crayon-e">get_objects</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ids</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-v">args</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-97"><span class="crayon-h">        </span><span class="crayon-s">""</span><span class="crayon-s">"Fetchs all of the given object from the graph.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-98"><span class="crayon-s">        We return a map from ID to object. If any of the IDs are</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-99"><span class="crayon-s">        invalid, we raise an exception.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-100"><span class="crayon-s">        "</span><span class="crayon-s">""</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-101"><span class="crayon-h">        </span><span class="crayon-v">args</span><span class="crayon-sy">[</span><span class="crayon-s">"ids"</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">","</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">ids</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-102"><span class="crayon-h">        </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">request</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">version</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">"/"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">args</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-103"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-104"><span class="crayon-h">    </span><span class="crayon-e">def </span><span class="crayon-e">get_connections</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">connection_name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-v">args</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-105"><span class="crayon-h">        </span><span class="crayon-s">""</span><span class="crayon-s">"Fetchs the connections for given object."</span><span class="crayon-s">""</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-106"><span class="crayon-h">        </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">request</span><span class="crayon-sy">(</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-107"><span class="crayon-h">            </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">version</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">"/"</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">id</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">"/"</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">connection_name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">args</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-108"> </p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-109"><span class="crayon-h">    </span><span class="crayon-e">def </span><span class="crayon-e">put_object</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">parent_object</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">connection_name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-v">data</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-110"><span class="crayon-h">        </span><span class="crayon-s">""</span><span class="crayon-s">"Writes the given object to the graph, connected to the given parent.</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-111"><span class="crayon-s">        For example,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-112"><span class="crayon-s">            graph.put_object("</span><span class="crayon-i">me</span><span class="crayon-s">", "</span><span class="crayon-i">feed</span><span class="crayon-s">", message="</span><span class="crayon-v">Hello</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">world</span><span class="crayon-s">")</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-113"><span class="crayon-s">        writes "</span><span class="crayon-v">Hello</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">world</span><span class="crayon-s">" to the active user's wall. Likewise, this</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-114"><span class="crayon-s">        will comment on a the first post of the active user's feed:</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-115"><span class="crayon-s">            feed = graph.get_connections("</span><span class="crayon-i">me</span><span class="crayon-s">", "</span><span class="crayon-i">feed</span><span class="crayon-s">")</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-116"><span class="crayon-s">            post = feed["</span><span class="crayon-i">data</span><span class="crayon-s">"][0]</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-117"><span class="crayon-s">            graph.put_object(post["</span><span class="crayon-i">id</span><span class="crayon-s">"], "</span><span class="crayon-i">comments</span><span class="crayon-s">", message="</span><span class="crayon-v">First</span><span class="crayon-o">!</span><span class="crayon-s">")</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-118"><span class="crayon-s">        See http://developers.facebook.com/docs/api#publishing for all</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-119"><span class="crayon-s">        of the supported writeable objects.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-120"><span class="crayon-s">        Certain write operations require extended permissions. For</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-121"><span class="crayon-s">        example, publishing to a user's feed requires the</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-122"><span class="crayon-s">        "</span><span class="crayon-v">publish</span><span class="crayon-sy">_</span>actions<span class="crayon-s">" permission. See</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-123"><span class="crayon-s">        http://developers.facebook.com/docs/publishing/ for details</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-124"><span class="crayon-s">        about publishing permissions.</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-125"><span class="crayon-s">        "</span><span class="crayon-s">""</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-126"><span class="crayon-h">        </span><span class="crayon-st">assert</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">access_token</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"Write operations require an access token"</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-127"><span class="crayon-h">        </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">request</span><span class="crayon-sy">(</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-128"><span class="crayon-h">            </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">version</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">"/"</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">parent_object</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">"/"</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">connection_name</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-129"><span class="crayon-h">            </span><span class="crayon-v">post_args</span><span class="crayon-o">=</span><span class="crayon-v">data</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-130"><span class="crayon-h">            </span><span class="crayon-v">method</span><span class="crayon-o">=</span><span class="crayon-s">"POST"</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-131"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-132"><span class="crayon-h">    </span><span class="crayon-e">def </span><span class="crayon-e">put_wall_post</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">message</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">attachment</span><span class="crayon-o">=</span><span class="crayon-sy">{</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">profile_id</span><span class="crayon-o">=</span><span class="crayon-s">"me"</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-133"><span class="crayon-h">        </span><span class="crayon-s">""</span><span class="crayon-s">"Writes a wall post to the given profile's wall.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-134"><span class="crayon-s">        We default to writing to the authenticated user's wall if no</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-135"><span class="crayon-s">        profile_id is specified.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-136"><span class="crayon-s">        attachment adds a structured attachment to the status message</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-137"><span class="crayon-s">        being posted to the Wall. It should be a dictionary of the form:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-138"><span class="crayon-s">            {"</span><span class="crayon-i">name</span><span class="crayon-s">": "</span><span class="crayon-e">Link </span><span class="crayon-i">name</span><span class="crayon-s">"</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-139"><span class="crayon-s">             "</span><span class="crayon-i">link</span><span class="crayon-s">": "</span><span class="crayon-v">http</span><span class="crayon-o">:</span><span class="crayon-c">//www.example.com/",</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-140"><span class="crayon-h">             </span><span class="crayon-s">"caption"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"{*actor*} posted a new review"</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-141"><span class="crayon-h">             </span><span class="crayon-s">"description"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"This is a longer description of the attachment"</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-142"><span class="crayon-h">             </span><span class="crayon-s">"picture"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"http://www.example.com/thumbnail.jpg"</span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-143"><span class="crayon-h">        </span><span class="crayon-s">""</span><span class="crayon-s">"</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-144"><span class="crayon-s">        return self.put_object(profile_id, "</span><span class="crayon-i">feed</span><span class="crayon-s">", message=message,</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-145"><span class="crayon-s">                               **attachment)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-146"> </p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-147"><span class="crayon-s">    def put_comment(self, object_id, message):</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-148"><span class="crayon-s">        "</span><span class="crayon-s">""</span><span class="crayon-e">Writes </span><span class="crayon-e">the </span><span class="crayon-e">given </span><span class="crayon-e">comment </span><span class="crayon-e">on </span><span class="crayon-e">the </span><span class="crayon-e">given </span><span class="crayon-v">post</span><span class="crayon-sy">.</span><span class="crayon-s">""</span><span class="crayon-s">"</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-149"><span class="crayon-s">        return self.put_object(object_id, "</span><span class="crayon-i">comments</span><span class="crayon-s">", message=message)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-150"> </p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-151"><span class="crayon-s">    def put_like(self, object_id):</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-152"><span class="crayon-s">        "</span><span class="crayon-s">""</span><span class="crayon-e">Likes </span><span class="crayon-e">the </span><span class="crayon-e">given </span><span class="crayon-v">post</span><span class="crayon-sy">.</span><span class="crayon-s">""</span><span class="crayon-s">"</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-153"><span class="crayon-s">        return self.put_object(object_id, "</span><span class="crayon-i">likes</span><span class="crayon-s">")</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-154"> </p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-155"><span class="crayon-s">    def delete_object(self, id):</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-156"><span class="crayon-s">        "</span><span class="crayon-s">""</span><span class="crayon-e">Deletes </span><span class="crayon-e">the </span><span class="crayon-t">object</span><span class="crayon-h"> </span><span class="crayon-e">with </span><span class="crayon-e">the </span><span class="crayon-e">given </span><span class="crayon-e">ID </span><span class="crayon-e">from </span><span class="crayon-e">the </span><span class="crayon-v">graph</span><span class="crayon-sy">.</span><span class="crayon-s">""</span><span class="crayon-s">"</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-157"><span class="crayon-s">        self.request(self.version + "</span><span class="crayon-o">/</span><span class="crayon-s">" + id, method="</span><span class="crayon-i">DELETE</span><span class="crayon-s">")</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-158"> </p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-159"><span class="crayon-s">    def delete_request(self, user_id, request_id):</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-160"><span class="crayon-s">        "</span><span class="crayon-s">""</span><span class="crayon-e">Deletes </span><span class="crayon-e">the </span><span class="crayon-e">Request </span><span class="crayon-e">with </span><span class="crayon-e">the </span><span class="crayon-e">given </span><span class="crayon-e">ID </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">the </span><span class="crayon-e">given </span><span class="crayon-v">user</span><span class="crayon-sy">.</span><span class="crayon-s">""</span><span class="crayon-s">"</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-161"><span class="crayon-s">        self.request("</span><span class="crayon-o">%</span><span class="crayon-v">s_</span><span class="crayon-o">%</span><span class="crayon-i">s</span><span class="crayon-s">" % (request_id, user_id), method="</span><span class="crayon-i">DELETE</span><span class="crayon-s">")</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-162"> </p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-163"><span class="crayon-s">    def put_photo(self, image, album_path="</span><span class="crayon-v">me</span><span class="crayon-o">/</span><span class="crayon-i">photos</span><span class="crayon-s">", **kwargs):</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-164"><span class="crayon-s">        "</span><span class="crayon-s">""</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-165"><span class="crayon-h">        </span><span class="crayon-e">Upload </span><span class="crayon-e">an </span><span class="crayon-e">image </span><span class="crayon-e">using </span><span class="crayon-v">multipart</span><span class="crayon-o">/</span><span class="crayon-v">form</span><span class="crayon-o">-</span><span class="crayon-v">data</span><span class="crayon-sy">.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-166"><span class="crayon-h">        </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-i">A</span><span class="crayon-h"> </span><span class="crayon-e">file </span><span class="crayon-t">object</span><span class="crayon-h"> </span><span class="crayon-e">representing </span><span class="crayon-e">the </span><span class="crayon-e">image </span><span class="crayon-st">to</span><span class="crayon-h"> </span><span class="crayon-e">be </span><span class="crayon-v">uploaded</span><span class="crayon-sy">.</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-167"><span class="crayon-h">        </span><span class="crayon-v">album_path</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-i">A</span><span class="crayon-h"> </span><span class="crayon-e">path </span><span class="crayon-e">representing </span><span class="crayon-e">where </span><span class="crayon-e">the </span><span class="crayon-e">image </span><span class="crayon-e">should </span><span class="crayon-e">be </span><span class="crayon-v">uploaded</span><span class="crayon-sy">.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-168"><span class="crayon-h">        </span><span class="crayon-s">""</span><span class="crayon-s">"</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-169"><span class="crayon-s">        return self.request(</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-170"><span class="crayon-s">            self.version + "</span><span class="crayon-o">/</span><span class="crayon-s">" + album_path,</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-171"><span class="crayon-s">            post_args=kwargs,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-172"><span class="crayon-s">            files={"</span><span class="crayon-i">source</span><span class="crayon-s">": image},</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-173"><span class="crayon-s">            method="</span><span class="crayon-i">POST</span><span class="crayon-s">")</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-174"> </p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-175"><span class="crayon-s">    def get_version(self):</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-176"><span class="crayon-s">        "</span><span class="crayon-s">""</span><span class="crayon-e">Fetches </span><span class="crayon-e">the </span><span class="crayon-e">current </span><span class="crayon-e">version </span><span class="crayon-e">number </span><span class="crayon-e">of </span><span class="crayon-e">the </span><span class="crayon-e">Graph </span><span class="crayon-e">API </span><span class="crayon-e">being </span><span class="crayon-v">used</span><span class="crayon-sy">.</span><span class="crayon-s">""</span><span class="crayon-s">"</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-177"><span class="crayon-s">        args = {"</span><span class="crayon-v">access</span><span class="crayon-sy">_</span>token<span class="crayon-s">": self.access_token}</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-178"><span class="crayon-s">        try:</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-179"><span class="crayon-s">            response = requests.request("</span><span class="crayon-i">GET</span><span class="crayon-s">",</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-180"><span class="crayon-s">                                        "</span><span class="crayon-v">https</span><span class="crayon-o">:</span><span class="crayon-c">//graph.facebook.com/" +</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-181"><span class="crayon-h">                                        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">version</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">"/me"</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-182"><span class="crayon-h">                                        </span><span class="crayon-v">params</span><span class="crayon-o">=</span><span class="crayon-v">args</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-183"><span class="crayon-h">                                        </span><span class="crayon-v">timeout</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">timeout</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-184"><span class="crayon-h">        </span><span class="crayon-e">except </span><span class="crayon-v">requests</span><span class="crayon-sy">.</span><span class="crayon-e">HTTPError </span><span class="crayon-st">as</span><span class="crayon-h"> </span><span class="crayon-v">e</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-185"><span class="crayon-h">            </span><span class="crayon-v">response</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">json</span><span class="crayon-sy">.</span><span class="crayon-e">loads</span><span class="crayon-sy">(</span><span class="crayon-v">e</span><span class="crayon-sy">.</span><span class="crayon-e">read</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-186"><span class="crayon-h">            </span><span class="crayon-e">raise </span><span class="crayon-e">GraphAPIError</span><span class="crayon-sy">(</span><span class="crayon-v">response</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-187"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-188"><span class="crayon-h">        </span><span class="crayon-st">try</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-189"><span class="crayon-h">            </span><span class="crayon-v">headers</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">response</span><span class="crayon-sy">.</span><span class="crayon-e">headers</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-190"><span class="crayon-e">            </span><span class="crayon-v">version</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">headers</span><span class="crayon-sy">[</span><span class="crayon-s">"facebook-api-version"</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">replace</span><span class="crayon-sy">(</span><span class="crayon-s">"v"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">""</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-191"><span class="crayon-h">            </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">float</span><span class="crayon-sy">(</span><span class="crayon-v">version</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-192"><span class="crayon-h">        </span><span class="crayon-e">except </span><span class="crayon-v">Exception</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-193"><span class="crayon-h">            </span><span class="crayon-e">raise </span><span class="crayon-e">GraphAPIError</span><span class="crayon-sy">(</span><span class="crayon-s">"API version number not available"</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-194"> </p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-195"><span class="crayon-h">    </span><span class="crayon-e">def </span><span class="crayon-e">request</span><span class="crayon-sy">(</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-196"><span class="crayon-h">            </span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">path</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">args</span><span class="crayon-o">=</span><span class="crayon-v">None</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">post_args</span><span class="crayon-o">=</span><span class="crayon-v">None</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">files</span><span class="crayon-o">=</span><span class="crayon-v">None</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">method</span><span class="crayon-o">=</span><span class="crayon-v">None</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-197"><span class="crayon-h">        </span><span class="crayon-s">""</span><span class="crayon-s">"Fetches the given path in the Graph API.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-198"><span class="crayon-s">        We translate args to a valid query string. If post_args is</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-199"><span class="crayon-s">        given, we send a POST request to the given path with the given</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-200"><span class="crayon-s">        arguments.</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-201"><span class="crayon-s">        "</span><span class="crayon-s">""</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-202"><span class="crayon-h">        </span><span class="crayon-v">args</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">args</span><span class="crayon-h"> </span><span class="crayon-st">or</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-203"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-204"><span class="crayon-h">        </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">post_args </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-v">None</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-205"><span class="crayon-h">            </span><span class="crayon-v">method</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"POST"</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-206"> </p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-207"><span class="crayon-h">        </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">access_token</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-208"><span class="crayon-h">            </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">post_args </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-v">None</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-209"><span class="crayon-h">                </span><span class="crayon-v">post_args</span><span class="crayon-sy">[</span><span class="crayon-s">"access_token"</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">access_token</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-210"><span class="crayon-e">            </span><span class="crayon-st">else</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-211"><span class="crayon-h">                </span><span class="crayon-v">args</span><span class="crayon-sy">[</span><span class="crayon-s">"access_token"</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">access_token</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-212"> </p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-213"><span class="crayon-e">        </span><span class="crayon-st">try</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-214"><span class="crayon-h">            </span><span class="crayon-v">response</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">requests</span><span class="crayon-sy">.</span><span class="crayon-e">request</span><span class="crayon-sy">(</span><span class="crayon-e">method </span><span class="crayon-st">or</span><span class="crayon-h"> </span><span class="crayon-s">"GET"</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-215"><span class="crayon-h">                                        </span><span class="crayon-s">"https://graph.facebook.com/"</span><span class="crayon-h"> </span><span class="crayon-o">+</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-216"><span class="crayon-h">                                        </span><span class="crayon-v">path</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-217"><span class="crayon-h">                                        </span><span class="crayon-v">timeout</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">timeout</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-218"><span class="crayon-h">                                        </span><span class="crayon-v">params</span><span class="crayon-o">=</span><span class="crayon-v">args</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-219"><span class="crayon-h">                                        </span><span class="crayon-v">data</span><span class="crayon-o">=</span><span class="crayon-v">post_args</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-220"><span class="crayon-h">                                        </span><span class="crayon-v">files</span><span class="crayon-o">=</span><span class="crayon-v">files</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-221"><span class="crayon-h">        </span><span class="crayon-e">except </span><span class="crayon-v">requests</span><span class="crayon-sy">.</span><span class="crayon-e">HTTPError </span><span class="crayon-st">as</span><span class="crayon-h"> </span><span class="crayon-v">e</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-222"><span class="crayon-h">            </span><span class="crayon-v">response</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">json</span><span class="crayon-sy">.</span><span class="crayon-e">loads</span><span class="crayon-sy">(</span><span class="crayon-v">e</span><span class="crayon-sy">.</span><span class="crayon-e">read</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-223"><span class="crayon-h">            </span><span class="crayon-e">raise </span><span class="crayon-e">GraphAPIError</span><span class="crayon-sy">(</span><span class="crayon-v">response</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-224"> </p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-225"><span class="crayon-h">        </span><span class="crayon-v">headers</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">response</span><span class="crayon-sy">.</span><span class="crayon-e">headers</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-226"><span class="crayon-e">        </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-s">'json'</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">headers</span><span class="crayon-sy">[</span><span class="crayon-s">'content-type'</span><span class="crayon-sy">]</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-227"><span class="crayon-h">            </span><span class="crayon-v">result</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">response</span><span class="crayon-sy">.</span><span class="crayon-e">json</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-228"><span class="crayon-h">        </span><span class="crayon-i">elif</span><span class="crayon-h"> </span><span class="crayon-s">'image/'</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">headers</span><span class="crayon-sy">[</span><span class="crayon-s">'content-type'</span><span class="crayon-sy">]</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-229"><span class="crayon-h">            </span><span class="crayon-v">mimetype</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">headers</span><span class="crayon-sy">[</span><span class="crayon-s">'content-type'</span><span class="crayon-sy">]</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-230"><span class="crayon-h">            </span><span class="crayon-v">result</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-s">"data"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">response</span><span class="crayon-sy">.</span><span class="crayon-v">content</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-231"><span class="crayon-h">                      </span><span class="crayon-s">"mime-type"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">mimetype</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-232"><span class="crayon-h">                      </span><span class="crayon-s">"url"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">response</span><span class="crayon-sy">.</span><span class="crayon-v">url</span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-233"><span class="crayon-h">        </span><span class="crayon-i">elif</span><span class="crayon-h"> </span><span class="crayon-s">"access_token"</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">parse_qs</span><span class="crayon-sy">(</span><span class="crayon-v">response</span><span class="crayon-sy">.</span><span class="crayon-v">text</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-234"><span class="crayon-h">            </span><span class="crayon-v">query_str</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">parse_qs</span><span class="crayon-sy">(</span><span class="crayon-v">response</span><span class="crayon-sy">.</span><span class="crayon-v">text</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-235"><span class="crayon-h">            </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-s">"access_token"</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">query_str</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-236"><span class="crayon-h">                </span><span class="crayon-v">result</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-s">"access_token"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">query_str</span><span class="crayon-sy">[</span><span class="crayon-s">"access_token"</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-237"><span class="crayon-h">                </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-s">"expires"</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">query_str</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-238"><span class="crayon-h">                    </span><span class="crayon-v">result</span><span class="crayon-sy">[</span><span class="crayon-s">"expires"</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">query_str</span><span class="crayon-sy">[</span><span class="crayon-s">"expires"</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-239"><span class="crayon-h">            </span><span class="crayon-st">else</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-240"><span class="crayon-h">                </span><span class="crayon-e">raise </span><span class="crayon-e">GraphAPIError</span><span class="crayon-sy">(</span><span class="crayon-v">response</span><span class="crayon-sy">.</span><span class="crayon-e">json</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-241"><span class="crayon-h">        </span><span class="crayon-st">else</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-242"><span class="crayon-h">            </span><span class="crayon-e">raise </span><span class="crayon-e">GraphAPIError</span><span class="crayon-sy">(</span><span class="crayon-s">'Maintype was not text, image, or querystring'</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-243"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-244"><span class="crayon-h">        </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">result </span><span class="crayon-st">and</span><span class="crayon-h"> </span><span class="crayon-e">isinstance</span><span class="crayon-sy">(</span><span class="crayon-v">result</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dict</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">and</span><span class="crayon-h"> </span><span class="crayon-v">result</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-s">"error"</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-245"><span class="crayon-h">            </span><span class="crayon-e">raise </span><span class="crayon-e">GraphAPIError</span><span class="crayon-sy">(</span><span class="crayon-v">result</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-246"><span class="crayon-h">        </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">result</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-247"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-248"><span class="crayon-e">    </span><span class="crayon-e">def </span><span class="crayon-e">fql</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">query</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-249"><span class="crayon-h">        </span><span class="crayon-s">""</span><span class="crayon-s">"FQL query.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-250"><span class="crayon-s">        Example query: "</span><span class="crayon-e">SELECT </span><span class="crayon-e">affiliations </span><span class="crayon-e">FROM </span><span class="crayon-e">user </span><span class="crayon-e">WHERE </span><span class="crayon-v">uid</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">me</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-s">"</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-251"><span class="crayon-s">        "</span><span class="crayon-s">""</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-252"><span class="crayon-h">        </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">request</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">version</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">"/"</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">"fql"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-s">"q"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">query</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-253"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-254"><span class="crayon-h">    </span><span class="crayon-e">def </span><span class="crayon-e">get_app_access_token</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">app_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">app_secret</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-255"><span class="crayon-h">        </span><span class="crayon-s">""</span><span class="crayon-s">"Get the application's access token as a string."</span><span class="crayon-s">""</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-256"><span class="crayon-h">        </span><span class="crayon-v">args</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-s">'grant_type'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">'client_credentials'</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-257"><span class="crayon-h">                </span><span class="crayon-s">'client_id'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">app_id</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-258"><span class="crayon-h">                </span><span class="crayon-s">'client_secret'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">app_secret</span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-259"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-260"><span class="crayon-h">        </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">request</span><span class="crayon-sy">(</span><span class="crayon-s">"oauth/access_token"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">args</span><span class="crayon-o">=</span><span class="crayon-v">args</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-s">"access_token"</span><span class="crayon-sy">]</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-261"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-262"><span class="crayon-h">    </span><span class="crayon-e">def </span><span class="crayon-e">get_access_token_from_code</span><span class="crayon-sy">(</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-263"><span class="crayon-h">            </span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">code</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">redirect_uri</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">app_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">app_secret</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-264"><span class="crayon-h">        </span><span class="crayon-s">""</span><span class="crayon-s">"Get an access token from the "</span><span class="crayon-i">code</span><span class="crayon-s">" returned from an OAuth dialog.</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-265"><span class="crayon-s">        Returns a dict containing the user-specific access token and its</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-266"><span class="crayon-s">        expiration date (if applicable).</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-267"><span class="crayon-s">        "</span><span class="crayon-s">""</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-268"><span class="crayon-h">        </span><span class="crayon-v">args</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-269"><span class="crayon-h">            </span><span class="crayon-s">"code"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">code</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-270"><span class="crayon-h">            </span><span class="crayon-s">"redirect_uri"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">redirect_uri</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-271"><span class="crayon-h">            </span><span class="crayon-s">"client_id"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">app_id</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-272"><span class="crayon-h">            </span><span class="crayon-s">"client_secret"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">app_secret</span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-273"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-274"><span class="crayon-h">        </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">request</span><span class="crayon-sy">(</span><span class="crayon-s">"oauth/access_token"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">args</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-275"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-276"><span class="crayon-h">    </span><span class="crayon-e">def </span><span class="crayon-e">extend_access_token</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">app_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">app_secret</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-277"><span class="crayon-h">        </span><span class="crayon-s">""</span><span class="crayon-s">"</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-278"><span class="crayon-s">        Extends the expiration time of a valid OAuth access token. See</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-279"><span class="crayon-s">        &lt;https://developers.facebook.com/roadmap/offline-access-removal/</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-280"><span class="crayon-s">        #extend_token&gt;</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-281"><span class="crayon-s">        "</span><span class="crayon-s">""</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-282"><span class="crayon-h">        </span><span class="crayon-v">args</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-283"><span class="crayon-h">            </span><span class="crayon-s">"client_id"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">app_id</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-284"><span class="crayon-h">            </span><span class="crayon-s">"client_secret"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">app_secret</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-285"><span class="crayon-h">            </span><span class="crayon-s">"grant_type"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"fb_exchange_token"</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-286"><span class="crayon-h">            </span><span class="crayon-s">"fb_exchange_token"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">access_token</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-287"><span class="crayon-h">        </span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-288"> </p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-289"><span class="crayon-h">        </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">request</span><span class="crayon-sy">(</span><span class="crayon-s">"oauth/access_token"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">args</span><span class="crayon-o">=</span><span class="crayon-v">args</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-290"> </p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-291"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-292"><span class="crayon-t">class</span><span class="crayon-h"> </span><span class="crayon-e">GraphAPIError</span><span class="crayon-sy">(</span><span class="crayon-v">Exception</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-293"><span class="crayon-h">    </span><span class="crayon-e">def </span><span class="crayon-e">__init__</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">result</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-294"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">result</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">result</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-295"><span class="crayon-e">        </span><span class="crayon-st">try</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-296"><span class="crayon-h">            </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">type</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">result</span><span class="crayon-sy">[</span><span class="crayon-s">"error_code"</span><span class="crayon-sy">]</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-297"><span class="crayon-h">        </span><span class="crayon-v">except</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-298"><span class="crayon-h">            </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">type</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">""</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-299"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-300"><span class="crayon-h">        </span><span class="crayon-p"># OAuth 2.0 Draft 10</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-301"><span class="crayon-h">        </span><span class="crayon-st">try</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-302"><span class="crayon-h">            </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">message</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">result</span><span class="crayon-sy">[</span><span class="crayon-s">"error_description"</span><span class="crayon-sy">]</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-303"><span class="crayon-h">        </span><span class="crayon-v">except</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-304"><span class="crayon-h">            </span><span class="crayon-p"># OAuth 2.0 Draft 00</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-305"><span class="crayon-h">            </span><span class="crayon-st">try</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-306"><span class="crayon-h">                </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">message</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">result</span><span class="crayon-sy">[</span><span class="crayon-s">"error"</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-s">"message"</span><span class="crayon-sy">]</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-307"><span class="crayon-h">            </span><span class="crayon-v">except</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-308"><span class="crayon-h">                </span><span class="crayon-p"># REST server style</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-309"><span class="crayon-h">                </span><span class="crayon-st">try</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-310"><span class="crayon-h">                    </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">message</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">result</span><span class="crayon-sy">[</span><span class="crayon-s">"error_msg"</span><span class="crayon-sy">]</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-311"><span class="crayon-h">                </span><span class="crayon-v">except</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-312"><span class="crayon-h">                    </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">message</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">result</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-313"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-314"><span class="crayon-e">        </span><span class="crayon-v">Exception</span><span class="crayon-sy">.</span><span class="crayon-e">__init__</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">message</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-315"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-316"> </p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-317"><span class="crayon-e">def </span><span class="crayon-e">get_user_from_cookie</span><span class="crayon-sy">(</span><span class="crayon-v">cookies</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">app_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">app_secret</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-318"><span class="crayon-h">    </span><span class="crayon-s">""</span><span class="crayon-s">"Parses the cookie set by the official Facebook JavaScript SDK.</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-319"><span class="crayon-s">    cookies should be a dictionary-like object mapping cookie names to</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-320"><span class="crayon-s">    cookie values.</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-321"><span class="crayon-s">    If the user is logged in via Facebook, we return a dictionary with</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-322"><span class="crayon-s">    the keys "</span><span class="crayon-i">uid</span><span class="crayon-s">" and "</span><span class="crayon-v">access</span><span class="crayon-sy">_</span>token<span class="crayon-s">". The former is the user's</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-323"><span class="crayon-s">    Facebook ID, and the latter can be used to make authenticated</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-324"><span class="crayon-s">    requests to the Graph API. If the user is not logged in, we</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-325"><span class="crayon-s">    return None.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-326"><span class="crayon-s">    Download the official Facebook JavaScript SDK at</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-327"><span class="crayon-s">    http://github.com/facebook/connect-js/. Read more about Facebook</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-328"><span class="crayon-s">    authentication at</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-329"><span class="crayon-s">    http://developers.facebook.com/docs/authentication/.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-330"><span class="crayon-s">    "</span><span class="crayon-s">""</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-331"><span class="crayon-h">    </span><span class="crayon-v">cookie</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cookies</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-s">"fbsr_"</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">app_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">""</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-332"><span class="crayon-h">    </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-v">cookie</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-333"><span class="crayon-h">        </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">None</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-334"><span class="crayon-e">    </span><span class="crayon-v">parsed_request</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">parse_signed_request</span><span class="crayon-sy">(</span><span class="crayon-v">cookie</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">app_secret</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-335"><span class="crayon-h">    </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-v">parsed_request</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-336"><span class="crayon-h">        </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">None</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-337"><span class="crayon-e">    </span><span class="crayon-st">try</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-338"><span class="crayon-h">        </span><span class="crayon-v">result</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">get_access_token_from_code</span><span class="crayon-sy">(</span><span class="crayon-v">parsed_request</span><span class="crayon-sy">[</span><span class="crayon-s">"code"</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">""</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-339"><span class="crayon-h">                                            </span><span class="crayon-v">app_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">app_secret</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-340"><span class="crayon-h">    </span><span class="crayon-e">except </span><span class="crayon-v">GraphAPIError</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-341"><span class="crayon-h">        </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">None</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-342"><span class="crayon-e">    </span><span class="crayon-v">result</span><span class="crayon-sy">[</span><span class="crayon-s">"uid"</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">parsed_request</span><span class="crayon-sy">[</span><span class="crayon-s">"user_id"</span><span class="crayon-sy">]</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-343"><span class="crayon-h">    </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">result</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-344"> </p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-345"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-346"><span class="crayon-e">def </span><span class="crayon-e">parse_signed_request</span><span class="crayon-sy">(</span><span class="crayon-v">signed_request</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">app_secret</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-347"><span class="crayon-h">    </span><span class="crayon-s">""</span><span class="crayon-s">" Return dictionary with signed request data.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-348"><span class="crayon-s">    We return a dictionary containing the information in the</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-349"><span class="crayon-s">    signed_request. This includes a user_id if the user has authorised</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-350"><span class="crayon-s">    your application, as well as any information requested.</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-351"><span class="crayon-s">    If the signed_request is malformed or corrupted, False is returned.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-352"><span class="crayon-s">    "</span><span class="crayon-s">""</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-353"><span class="crayon-h">    </span><span class="crayon-st">try</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-354"><span class="crayon-h">        </span><span class="crayon-v">encoded_sig</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">payload</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">map</span><span class="crayon-sy">(</span><span class="crayon-v">str</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">signed_request</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-355"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-356"><span class="crayon-h">        </span><span class="crayon-v">sig</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">base64</span><span class="crayon-sy">.</span><span class="crayon-e">urlsafe_b64decode</span><span class="crayon-sy">(</span><span class="crayon-v">encoded_sig</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">"="</span><span class="crayon-h"> </span><span class="crayon-o">*</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-357"><span class="crayon-h">                                       </span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">4</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">encoded_sig</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-cn">4</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-cn">4</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-358"><span class="crayon-h">        </span><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">base64</span><span class="crayon-sy">.</span><span class="crayon-e">urlsafe_b64decode</span><span class="crayon-sy">(</span><span class="crayon-v">payload</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">"="</span><span class="crayon-h"> </span><span class="crayon-o">*</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-359"><span class="crayon-h">                                        </span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">4</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">payload</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-cn">4</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-cn">4</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-360"><span class="crayon-h">    </span><span class="crayon-e">except </span><span class="crayon-v">IndexError</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-361"><span class="crayon-h">        </span><span class="crayon-p"># Signed request was malformed.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-362"><span class="crayon-h">        </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">False</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-363"><span class="crayon-h">    </span><span class="crayon-e">except </span><span class="crayon-v">TypeError</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-364"><span class="crayon-h">        </span><span class="crayon-p"># Signed request had a corrupted payload.</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-365"><span class="crayon-h">        </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">False</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-366"> </p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-367"><span class="crayon-h">    </span><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">json</span><span class="crayon-sy">.</span><span class="crayon-e">loads</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-368"><span class="crayon-h">    </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-s">'algorithm'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">''</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">upper</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-s">'HMAC-SHA256'</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-369"><span class="crayon-h">        </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">False</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-370"> </p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-371"><span class="crayon-h">    </span><span class="crayon-p"># HMAC can only handle ascii (byte) strings</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-372"><span class="crayon-h">    </span><span class="crayon-p"># http://bugs.python.org/issue5285</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-373"><span class="crayon-h">    </span><span class="crayon-v">app_secret</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">app_secret</span><span class="crayon-sy">.</span><span class="crayon-e">encode</span><span class="crayon-sy">(</span><span class="crayon-s">'ascii'</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-374"><span class="crayon-h">    </span><span class="crayon-v">payload</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">payload</span><span class="crayon-sy">.</span><span class="crayon-e">encode</span><span class="crayon-sy">(</span><span class="crayon-s">'ascii'</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-375"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-376"><span class="crayon-h">    </span><span class="crayon-v">expected_sig</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">hmac</span><span class="crayon-sy">.</span><span class="crayon-e">new</span><span class="crayon-sy">(</span><span class="crayon-v">app_secret</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-377"><span class="crayon-h">                            </span><span class="crayon-v">msg</span><span class="crayon-o">=</span><span class="crayon-v">payload</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-378"><span class="crayon-h">                            </span><span class="crayon-v">digestmod</span><span class="crayon-o">=</span><span class="crayon-v">hashlib</span><span class="crayon-sy">.</span><span class="crayon-v">sha256</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">digest</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-379"><span class="crayon-h">    </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">sig</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-v">expected_sig</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-380"><span class="crayon-h">        </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">False</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-381"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-382"><span class="crayon-h">    </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">data</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-383"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-384"> </p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-385"><span class="crayon-e">def </span><span class="crayon-e">auth_url</span><span class="crayon-sy">(</span><span class="crayon-v">app_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">canvas_url</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">perms</span><span class="crayon-o">=</span><span class="crayon-v">None</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-v">kwargs</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-386"><span class="crayon-h">    </span><span class="crayon-v">url</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"https://www.facebook.com/dialog/oauth?"</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-387"><span class="crayon-h">    </span><span class="crayon-v">kvps</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-s">'client_id'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">app_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'redirect_uri'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">canvas_url</span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-388"><span class="crayon-h">    </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">perms</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-389"><span class="crayon-h">        </span><span class="crayon-v">kvps</span><span class="crayon-sy">[</span><span class="crayon-s">'scope'</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">","</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">perms</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-390"><span class="crayon-h">    </span><span class="crayon-v">kvps</span><span class="crayon-sy">.</span><span class="crayon-e">update</span><span class="crayon-sy">(</span><span class="crayon-v">kwargs</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-391"><span class="crayon-h">    </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">url</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e">urlencode</span><span class="crayon-sy">(</span><span class="crayon-v">kvps</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-392"> </p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-393"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-394"><span class="crayon-e">def </span><span class="crayon-e">get_access_token_from_code</span><span class="crayon-sy">(</span><span class="crayon-v">code</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">redirect_uri</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">app_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">app_secret</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-395"><span class="crayon-h">    </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">GraphAPI</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">get_access_token_from_code</span><span class="crayon-sy">(</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-396"><span class="crayon-h">        </span><span class="crayon-v">code</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">redirect_uri</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">app_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">app_secret</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-397"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-398"> </p><p class="crayon-line" id="crayon-56d5b2e6db554244740452-399"><span class="crayon-e">def </span><span class="crayon-e">get_app_access_token</span><span class="crayon-sy">(</span><span class="crayon-v">app_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">app_secret</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b2e6db554244740452-400"><span class="crayon-h">    </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">GraphAPI</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">get_app_access_token</span><span class="crayon-sy">(</span><span class="crayon-v">app_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">app_secret</span><span class="crayon-sy">)</span></p></div></div></body></html>