<html><body><div><article class="markdown-body entry-content" itemprop="text"><h1><a id="user-content-continuous-integration-and-deployment-with-flask--travis-ci" class="anchor" href="#continuous-integration-and-deployment-with-flask--travis-ci" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Continuous Integration and Deployment with Flask &amp; Travis CI</h1>

<p>Build environment for Flask development with Grunt for frontend development.<br/>
Testing and integration handled by Travis CI. 
Zero-downtime deployment stack with Nginx and Gunicorn, configured easily with Fabric locally or from Travis CI. 
Build flow based off of <a href="http://www.bango29.com/continuous-web-development/">Batista Harahap's configuration</a></p>

<h2><a id="user-content-setup" class="anchor" href="#setup" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Setup</h2>

<ol>
<li>Install the following:

</li>
<li>Run <code>npm install -g bower -g less</code> to install bower &amp; lessc</li>
<li>Run <code>bower install</code> to install browser packages from bower.json into /static/bower_components/</li>
<li>Install virtualenv using <code>pip install virtualenv</code> (Note: see <a href="http://flask.pocoo.org/docs/0.10/installation/">flask virtualenv install docs</a> for more info)</li>
<li>Setup virtualenv:

<ol>
<li>Run <code>virtualenv env</code></li>
<li>On Windows: <code>env\scripts\activate</code>; On Linux: <code>. env/bin/activate</code></li>
</ol></li>
<li>Install python packages with <code>pip install -r requirements.txt</code> (NOTE: Make sure you have activated the python virtualenv prior.)</li>
<li>Copy <code>flask_site/config/config_sample.yml</code> to <code>flask_site/config/config.yml</code> and <strong>DO NOT ADD IT TO GIT</strong> (do not delete <code>config_sample.yml</code>, it is used for testing)</li>
<li>Change <code>secret_key</code> in <code>config.yml</code></li>
</ol>

<h2><a id="user-content-develop" class="anchor" href="#develop" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Develop</h2>

<ul>
<li>New Flask routes are added to <code>routes.yml</code> with associated controllers in the <code>controllers</code> sub-package</li>
<li>Install JS and CSS plugin resources with <a href="http://bower.io/">bower</a>:

<ul>
<li>Use <code>bower search PACKAGE</code> to find a package.</li>
<li>Use <code>bower install PACKAGE --save</code> to install and remember package in <code>bower.json</code> (i.e. <code>bower install animate.css --save</code>)</li>
<li>Add resources to bundles in <code>bundles.yml</code> so they are compiled by <a href="http://flask-assets.readthedocs.org/en/latest/">Flask-Assets</a></li>
</ul></li>
<li>If you install a new python package with pip, run: <code>pip freeze &gt; requirements.txt</code></li>
<li>See <a href="http://flask.pocoo.org/docs/0.10/testing/">Testing Flask Applications</a> for useful info on how to make tests comprehensive.</li>
<li>If you make any changes to <code>flask_site/config/config.yml</code>, the file must be manually uploaded to <code>/home/$USER/blue-green/config/config.yml</code></li>
</ul>

<h2><a id="user-content-run" class="anchor" href="#run" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Run</h2>

<p>Run <code>python start.py development</code> to start Flask locally at 127.0.0.1:5000.<br/>
Run <code>python start.py</code> to test the production configuration.</p>

<h2><a id="user-content-test" class="anchor" href="#test" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Test</h2>

<p>Run <code>nosetests --with-xunit --with-xcoverage --cover-package=flask_site --cover-erase tests</code></p>

<h2><a id="user-content-deploy" class="anchor" href="#deploy" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Deploy</h2>

<p>Fabric is used to easily setup and push code to deployment servers. Deployment configuration is based off of the <a href="http://dan.bravender.net/2014/8/24/Simple_0-Downtime_Blue_Green_Deployments.html">0-downtime blue-green deployment</a> style.<br/>
Tested on Debian wheezy, but with minor alterations to <code>fabfile.py</code> it should work with other distros.</p>

<h3><a id="user-content-variables" class="anchor" href="#variables" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Variables</h3>

<p>Several variables are referenced in this section. Following is their descriptions:</p>

<ul>
<li><code>$DEPLOY_HOSTS</code> - the hosts you will deploy to (comma separated - I've only tested with one host)</li>
<li><code>$DEPLOY_PASS</code> - the ssh password you will set for your deployment user (default: <code>admin</code>) - <strong>NOT THE ROOT PASSWORD</strong></li>
<li><code>$LIVE_SERVER_URL</code> - the URL people will use to access your server (i.e. example.com)</li>
<li><code>$NEXT_SERVER_URL</code> - the URL you can use to test changes before going live (i.e. dev.example.com)</li>
</ul>

<h3><a id="user-content-setting-up" class="anchor" href="#setting-up" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Setting up</h3>

<p>This only has to be done once. If you'd like to use a different user besides <code>admin</code>, change env.user in <code>fabfile.py</code></p>

<h4><a id="user-content-from-your-remote-machine-as-root" class="anchor" href="#from-your-remote-machine-as-root" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>From your remote machine as root:</h4>

<ol>
<li><code>apt-get update</code></li>
<li><code>apt-get install -y sudo</code> (this is only necessary if it's not already installed) </li>
<li><code>adduser admin</code>, and set the password to something feisty.</li>
<li><code>adduser admin sudo</code></li>
</ol>

<h4><a id="user-content-from-your-local-machine" class="anchor" href="#from-your-local-machine" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>From your local machine:</h4>

<ol>
<li><code>pip install fabric gitric</code></li>
<li><code>fab -H $DEPLOY_HOSTS -p $DEPLOY_PASS --set LIVE_SERVER_URL=$LIVE_SERVER_URL,NEXT_SERVER_URL=$NEXT_SERVER_URL prod setup_machine</code></li>
</ol>

<h3><a id="user-content-deploy-automatically-using-travis-ci" class="anchor" href="#deploy-automatically-using-travis-ci" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Deploy automatically using Travis CI</h3>

<p>See <code>.travis.yml</code> if you're interested in exactly what's going on.<br/>
If you'd like to automatically deploy but manually switch from the new version to live, remove <code>cutover</code> from <code>.travis.yml</code> and 
skip step 1 of the "Deploy Manually" section.</p>

<ol>
<li>Navigate to <a href="https://travis-ci.org/">Travis CI</a> and enable this repository to be built (login with your Github credentials).</li>
<li>In settings, add the following environment variables (make sure they are all set to not display in log):<br/>

</li>
<li>Commit or push some changes to <code>master</code> branch.</li>
</ol>

<h3><a id="user-content-deploy-manually" class="anchor" href="#deploy-manually" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Deploy Manually</h3>

<ol>
<li><code>fab -H $DEPLOY_HOSTS -p $DEPLOY_PASS prod deploy</code>, enter <code>$DEPLOY_PASS</code> again when prompted

<ul>
<li>Alternatively, you can:

<ul>
<li>add your local public key to <code>~/.ssh/authorized_keys</code> on your production servers, or </li>
<li>use <code>--set SSH_PUB_KEY_FILE=$YOUR_PUB_KEY_LOCATION</code> to automatically add and remove the key during deployment. </li>
</ul></li>
</ul></li>
<li>(optional) test from <code>$NEXT_SERVER_URL</code></li>
<li><code>fab -H $DEPLOY_HOSTS -p $DEPLOY_PASS prod cutover</code></li>
</ol>

<p>If you don't intend to test the server before going live, you can run the commands at the same time:<br/>
<code>fab -H $DEPLOY_HOSTS -p $DEPLOY_PASS prod deploy cutover</code></p>

<h2><a id="user-content-notes" class="anchor" href="#notes" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Notes</h2>

<ul>
<li>To skip Travis builds, include [ci skip] in the commit message.</li>
<li>For a nice git branching model: <a href="http://nvie.com/posts/a-successful-git-branching-model/">http://nvie.com/posts/a-successful-git-branching-model/</a></li>
<li>Because of Flask-Assets, the first user to visit your newly-deployed site will take a long time to load (while resources compile). 
Circumvent this by visiting <code>$NEXT_SERVER_URL</code> before running <code>fab cutover</code></li>
</ul>
</article>
  </div></body></html>