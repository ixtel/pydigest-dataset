<html><body><div><div class="entry-content">
			<p>In <a href="https://aliteralmind.wordpress.com/2014/09/21/jquery_django_tutorial">part one of this tutorial</a>, we made a simple “colors” website in which you can search based on substrings, and choose one or more as your favorites (here is a <a href="http://aliteralmind.com/docs/computer/programming/aliteralmind_wordpress/django_jquery_blog_post/knockout_demo">JavaScript-only demonstration</a>). In <a href="https://aliteralmind.wordpress.com/2014/09/22/jquery_django_tutorial_2">part two</a>, we updated the like buttons with <a href="https://developer.mozilla.org/en-US/docs/AJAX">Ajax</a>, using <a href="http://jquery.com/">JQuery</a>. Ajax provides the benefit of reloading only the just-pressed button, instead of the whole page.</p>
<p><code><i>[<b>All parts:</b> <a href="/2014/09/21/jquery_django_tutorial/">ONE</a>, <a href="/2014/09/22/jquery_django_tutorial_2/">TWO</a>, <a href="/2014/09/24/django_ajax_tutorial3/">THREE</a>]</i></code></p>
<p>In this final part, we’re also going to implement Ajax into the search feature. In addition, we’ll make the search execute automatically on each key-press, and prevent rapid-fire requests, by ignoring key-presses less than one-tenth-of-a-second apart.<a name="views"/></p>
<p><i>(A reminder to backup your work before proceeding.)</i></p>
<h1>Changing the views</h1>
<p>In the <a href="https://aliteralmind.wordpress.com/2014/09/22/jquery_django_tutorial_2#views">original code</a>, the search is implemented as a logic branch in the main <code>ColorList</code> view. If a <code>GET</code> is detected</p>
<pre class="brush: python; title: ; notranslate" title="">        if(self.request.method == "GET"):</pre>
<p>(and there’s at least two characters) then a search is executed. Otherwise, it’s just a "normal" request, without interactivity–in other words: just load the page.</p>
<p>In order to refresh only the search results, that portion of the main template must be <a href="#templates">separated out into it’s own file</a>, and its corresponding view code must be moved out of the <code>ColorList</code> and into its own (<a href="https://docs.djangoproject.com/en/1.7/topics/http/views/">function-based</a>) view.</p>
<p>Do this by replacing the existing single <code>ColorList</code> (<a href="https://docs.djangoproject.com/en/1.7/topics/class-based-views/">class-based</a>) view in<br/>
     <code>/home/myname/django_files/django_ajax_demo/color_liker/views.py</code><br/>
with the following <i>two</i> views:</p>
<pre class="brush: python; title: ; notranslate" title="">class ColorList(ListView):
    """
    Displays all colors in a table with only two columns: the name
    of the color, and a "like/unlike" button.
    """
    model = Color
    context_object_name = "colors"

    def dispatch(self, request, *args, **kwargs):
        return super(ColorList, self).dispatch(request, *args, **kwargs)

    def get_queryset(self):
        """
        This returns the all colors, for display in the main table.

        The search result query set, if any, is passed as context.
        """
        return  super(ColorList, self).get_queryset()

    def get_context_data(self, **kwargs):
        #Get the current context.
        context = super(ColorList, self).get_context_data(**kwargs)

        context["MIN_SEARCH_CHARS"] = MIN_SEARCH_CHARS

        return  context

def submit_color_search_from_ajax(request):
    """
    Processes a search request, ignoring any where less than two
    characters are provided. The search text is both trimmed and
    lower-cased.

    See &lt;link to MIN_SEARCH_CHARS&gt;
    """

    colors = []  #Assume no results.

    global  MIN_SEARCH_CHARS

    search_text = ""   #Assume no search
    if(request.method == "GET"):
        search_text = request.GET.get("color_search_text", "").strip().lower()
        if(len(search_text) &lt; MIN_SEARCH_CHARS):
            """
            Ignore the search. This is also validated by
            JavaScript, and should never reach here, but remains
            as prevention.
            """
            search_text = ""

    #Assume no results.
    #Use an empty list instead of None. In the template, use
    #   {% if color_search_results.count &gt; 0 %}
    color_results = []

    if(search_text != ""):
        color_results = Color.objects.filter(name__contains=search_text)

    #print('search_text="' + search_text + '", results=' + str(color_results))

    context = {
        "search_text": search_text,
        "color_search_results": color_results,
        "MIN_SEARCH_CHARS": MIN_SEARCH_CHARS,
    };

    return  render_to_response("color_liker/color_search_results__html_snippet.txt",
                               context)</pre>
<p><a name="templates"/></p>
<h1>Update the templates</h1>
<h2>Create the search-results sub-template</h2>
<p><i>[The template from parts <a href="https://aliteralmind.wordpress.com/2014/09/21/jquery_django_tutorial/#template">one</a> and <a href="https://aliteralmind.wordpress.com/2014/09/22/jquery_django_tutorial_2/#templates">two</a>]</i></p>
<p>In order to render the search results separately, they must be moved from the main template into its own sub-template.</p>
<p>Save the following as<br/>
     <code>/home/myname/django_files/django_ajax_demo/color_liker/color_liker/templates/color_liker/color_search_results__html_snippet.txt</code></p>
<pre class="brush: xml; title: ; notranslate" title="">{% if  search_text|length &gt;= MIN_SEARCH_CHARS %}
   &lt;p&gt;&lt;b&gt;Searching for &amp;quot;&lt;code&gt;{{ search_text }}&lt;/code&gt;&amp;quot;:&lt;/b&gt;
   {% if  color_search_results.count &gt; 0 %}
      &lt;/p&gt;
      &lt;ul&gt;
         {% for  color in color_search_results %} {# No colon after "color_search_results" #}
            &lt;li&gt;{{ color.name }}&lt;/li&gt;
         {% endfor %}
      &lt;/ul&gt;
   {% else %}
      &lt;i&gt;No results&lt;/i&gt;&lt;/p&gt;
   {% endif %}
{% endif %}</pre>
<h2>Change the main template</h2>
<p>The changes:
</p><ol>
<li>The search-results are no longer in the main template,</li>
<li>Instead, they are now represented in the main template by a div, which is populated (and un-populated) by the <a href="#ajax">yet-to-be-created JavaScript</a></li>
<li>The search form is no longer a form–it’s only a text box,</li>
<li>The JavaScript imports are different, and require two additional Django variables to be assigned to JavaScript variables, <i>before</i> the imports.</li>
</ol>
<p>Replace the contents of<br/>
     <code>/home/myname/django_files/django_ajax_demo/color_liker/templates/color_liker/color_list.html</code><br/>
with</p>
<pre class="brush: xml; title: ; notranslate" title="">{% comment %}
   humanize:
      For the "apnumber" filter, to display "two" instead of
      "2". Requries 'django.contrib.humanize' in INSTALLED_APPS

   static:
      To access the public static file directory, without having to hard
      code urls.
{% endcomment %}
{% load humanize %}
{% load static %}
&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
   &lt;head&gt;
      &lt;title&gt;Color Likenatorizer&lt;/title&gt;
      &lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8"&gt;
      &lt;meta name="viewport" content="width=device-width"/&gt;
      &lt;link rel="stylesheet" type="text/css" href="{% static 'stylesheet.css' %}"&gt;
   &lt;/head&gt;
&lt;body&gt;
   &lt;div class="search_section"&gt;
      &lt;!--
         The form is submitted on every key press ("keyup") to the ajax
         function. If the number of characters is greater than
         MIN_SEARCH_CHARS, then it is submitted to the Django view. Django
         then renders the sub-template

         color_search_results__html_snippet.txt

         whose output is fed back to the ajax function. Ajax then populates
         the rendered sub-template into the below div.

         This no longer needs to be a form since the JavaScript directly
         reads both fields (that is, it attaches event listeners to them,
         which automatically react to key-presses). To be clearer, I've
         added "color_" to the beginning of the text field's id.

         Notes:
            - csrf_token-s are not required in get requests.
            - Only because the view expects a GET request, the search may
            be directly tested with
               http://my.website/color_liker/search?color_search_text=bl
      --&gt;
      &lt;input type="text" id="color_search_text" name="search_text"/&gt;
      &lt;p&gt;(Requires {{ MIN_SEARCH_CHARS|apnumber }} or more characters)&lt;/p&gt;
      &lt;div id="color_search_results"&gt;&lt;/div&gt;
   &lt;/div&gt;
   &lt;div class="content_section"&gt;
      &lt;h1&gt;Color Likenatorizer&lt;/h1&gt;

      {% if  colors.count == 0 %}
         &lt;p&gt;&lt;i&gt;There are no colors in the database.&lt;/i&gt;&lt;/p&gt;
      {% else %}
         &lt;table&gt;
            &lt;tr&gt;
               &lt;th colspan="2"&gt;Color&lt;/th&gt;
               &lt;th&gt;Favorite?&lt;/th&gt;
            &lt;/tr&gt;
               &lt;!--
                  The yes/no like button is contained in the third column.
                  The stylesheet eliminates the button's border and expands
                  its width and height to 100%, so it fills its entire
                  container: the table cell. It therefore appears to *be*
                  the table cell.

                  The table cell is in this main template, the button in
                  it, is in the "include"d sub-template. The button
                  sub-template is used by the below for-loop, and also by
                  the toggle_color_like view, which is called by Ajax.

                  Ajax calls Django, which renders the sub-template and
                  feeds it back to Ajax, which then replaces the current
                  button/sub-template with the new one.

                  (The data-color_id is how the id is passed to JQuery. See
                  http://api.jquery.com/data/ )
               --&gt;
            {% for  color in colors %} {# No colon after "colors" #}
               &lt;tr&gt;
                  &lt;td style="background-color: {{ color.name }};" class="td__color_color"&gt;{{ color.name }}&lt;/td&gt;
                  &lt;td class="td__color_name"&gt;{{ color.name }}&lt;/td&gt;
                  &lt;td id="toggle_color_like_cell_{{ color.id }}" class="td__toggle_color_like_button" data-color_id="{{ color.id }}"&gt;
                     {% include "color_liker/color_like_link__html_snippet.txt" %}
                  &lt;/td&gt;
               &lt;/tr&gt;
            {% endfor %}
         &lt;/table&gt;
      {% endif %}
   &lt;/div&gt;
   &lt;script type='text/javascript' src="{% static 'jquery-1.11.1.min.js' %}"&gt;&lt;/script&gt;
   &lt;script type='text/javascript' src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore-min.js"&gt;&lt;/script&gt;
   &lt;script language="javascript"&gt;
      /*
         Before our JavaScript can be imported, the following JavaScript
         variables need to be set from Django variables. While these
         values could be hard-coded into the JavaScript, this allows
         them to be centrally located.
      */
      //From color_liker.views.MIN_SEARCH_CHARS
      var MIN_SEARCH_CHARS = {{ MIN_SEARCH_CHARS }};

      //The url to submit the search form. From color_liker.urls
      var SUBMIT_URL = "{% url 'color_list' %}";

      /*
         the url to toggle the like. From color_liker.urls

         Since an id must be provided to the Django url, give it a
         bogus one, then immediately lop it off (along with the
         ending '/'). It is re-appended by the JavaScript.
      */
      var LIKE_URL_PRE_ID = "{% url 'toggle_color_like' color_id='999999999' %}"
      LIKE_URL_PRE_ID = LIKE_URL_PRE_ID.substring(0, LIKE_URL_PRE_ID.length - "999999999/".length);
   &lt;/script&gt;
   &lt;script type='text/javascript' src="{% static 'color_ajax_search.js' %}"&gt;&lt;/script&gt;
   &lt;script type='text/javascript' src="{% static 'color_ajax_like.js' %}"&gt;&lt;/script&gt;
   &lt;script type='text/javascript' src="{% static 'color_ajax_main.js' %}"&gt;&lt;/script&gt;
&lt;/body&gt;&lt;/html&gt;</pre>
<p><a name="urls"/></p>
<h1>Update the URL configuration</h1>
<p>There is a new <a href="#views">view</a> for the search form, so a new url must point to it. Replace the contents of<br/>
     <code>/home/myname/django_files/django_ajax_demo/color_liker/urls.py</code><br/>
with</p>
<pre class="brush: python; title: ; notranslate" title="">from django.conf.urls  import patterns, include, url
from color_liker.views import ColorList

urlpatterns = patterns('',
    url(r"^$", ColorList.as_view(), name="color_list"),
    url(r"^like_color_(?P&lt;color_id&gt;\d+)/$", "color_liker.views.toggle_color_like", name="toggle_color_like"),
    url(r"^search/$", "color_liker.views.submit_color_search_from_ajax", name="color_list"),
)</pre>
<p><a name="ajax"/></p>
<h1>Ajax: JavaScript</h1>
<p>The JavaScript for the search feature will be placed in a new file. Before creating it, lets split the single <a href="https://aliteralmind.wordpress.com/2014/09/22/jquery_django_tutorial_2#ajax">existing JavaScript</a> file, containing both the like button and "main" functionality, into two. While all this JavaScript code could easily be placed into a single file (without comments or empty lines, there’s only about 50 lines of code), I find it clearer to split them into three: main, like, and search.</p>
<p><i>This code now uses <a href="http://underscorejs.org">Underscore.js</a>. The <a href="/2015/02/05/ajax_rapidfire_manual_to_underscore">original code</a> doesn’t.</i></p>
<h2>File one: The like button</h2>
<p>The "main" function is moved out of this file, and into the one below.</p>
<p>File name:<br/>
     <code>/home/myname/django_files/django_ajax_demo/static/color_ajax_like.js</code></p>
<pre class="brush: jscript; title: ; notranslate" title="">//THIS FILE MUST BE IMPORTED BEFORE THE "main" FILE.

/**
   Executes a like click. Triggered by clicks on the various yes/no links.
 */
var processLike = function()  {

   //In this scope, "this" is the button just clicked on.
   //The "this" in processServerResponse is *not* the button just clicked
   //on.
   var $button_just_clicked_on = $(this);

   //The value of the "data-color_id" attribute.
   var color_id = $button_just_clicked_on.data('color_id');

   var processServerResponse = function(sersverResponse_data, textStatus_ignored,
                            jqXHR_ignored)  {
      //alert("sf sersverResponse_data='" + sersverResponse_data + "', textStatus_ignored='" + textStatus_ignored + "', jqXHR_ignored='" + jqXHR_ignored + "', color_id='" + color_id + "'");
      $('#toggle_color_like_cell_' + color_id).html(sersverResponse_data);
   }

   var config = {
      url: LIKE_URL_PRE_ID + color_id + '/',
      dataType: 'html',
      success: processServerResponse
      //Should also have a "fail" call as well.
   };
   $.ajax(config);
};</pre>
<h2>File two: The "main" function</h2>
<p>This includes the original main function, with the addition of one that attaches a key-press listener to the search text box. The new function is called by both the main and the below search-JavaScript file.</p>
<p>Save the following as:<br/>
     <code>/home/myname/django_files/django_ajax_demo/static/color_ajax_main.js</code></p>
<pre class="brush: jscript; title: ; notranslate" title="">//THIS MUST BE IMPORTED AS THE VERY LAST THING BEFORE THE CLOSE &lt;/body&gt;
//tag.

/**
  The number of milliseconds to ignore key-presses in the search box,
  after a key *that was not ignored* was pressed. Used by
  `$(document).ready()`.

  Equal to &lt;code&gt;100&lt;/code&gt;.
 */
var MILLS_TO_IGNORE_SEARCH = 100;
/**
  The number of milliseconds to ignore clicks on the *same* like
  button, after a button *that was not ignored* was clicked. Used by
  `$(document).ready()`.

  Equal to &lt;code&gt;500&lt;/code&gt;.
 */
var MILLS_TO_IGNORE_LIKES = 500;
/**
   The Ajax "main" function. Attaches the listeners to the elements on
   page load, each of which only take effect every
   &lt;link to MILLS_TO_IGNORE_SEARCH&gt; or &lt;link to MILLS_TO_IGNORE_LIKES&gt;
   seconds.

   This protection is only against a single user pressing buttons as fast
   as they can. This is in no way a protection against a real DDOS attack,
   of which almost 100% bypass the client (browser) (they instead
   directly attack the server). Hence client-side protection is pointless.

   - http://stackoverflow.com/questions/28309850/how-much-prevention-of-rapid-fire-form-submissions-should-be-on-the-client-side

   The protection is implemented via Underscore.js' debounce function:
  - http://underscorejs.org/#debounce

   Using this only requires importing underscore-min.js. underscore-min.map
   is not needed.
 */
$(document).ready(function()  {
  /*
    Warning: Placing the true parameter outside of the debounce call:

    $('#color_search_text').keyup(_.debounce(processSearch,
        MILLS_TO_IGNORE_SEARCH), true);

    results in "TypeError: e.handler.apply is not a function"
   */
  $('#color_search_text').keyup(_.debounce(processSearch,
      MILLS_TO_IGNORE_SEARCH, true));
  /*
    There are many buttons having the class

      td__toggle_color_like_button

    This attaches a listener to *every one*. Calling this again
    would attach a *second* listener to every button, meaning each
    click would be processed twice.
   */
  $('.td__toggle_color_like_button').click(_.debounce(processLike,
      MILLS_TO_IGNORE_LIKES, true));
});</pre>
<h2>File three: The search feature</h2>
<p>Save the following as:<br/>
     <code>/home/myname/django_files/django_ajax_demo/static/color_ajax_search.js</code></p>
<pre class="brush: jscript; title: ; notranslate" title="">///THIS FILE MUST BE IMPORTED BEFORE THE "main" FILE.
/**
  Executes a search for colors containing a substring.
 */
var processSearch = function()  {
  //The key-press listener is no longer attached

  //Get and trim the search text.
  var searchText = $('#color_search_text').val().trim().toLowerCase();

  if(searchText.length &lt; MIN_SEARCH_CHARS)  {
    //Too short. Ignore the submission, and erase any current results.
    $('#color_search_results').html("");

  }  else  {
    //There are at least two characters. Execute the search.

    var processServerResponse = function(sersverResponse_data, textStatus_ignored,
                        jqXHR_ignored)  {
      //alert("sersverResponse_data='" + sersverResponse_data + "', textStatus_ignored='" + textStatus_ignored + "', jqXHR_ignored='" + jqXHR_ignored + "'");
      $('#color_search_results').html(sersverResponse_data);
    }

    var config = {
      /*
        Using GET allows you to directly call the search page in
        the browser:

        http://the.url/search/?color_search_text=bl

        Also, GET-s do not require the csrf_token
       */
      type: "GET",
      url: SUBMIT_URL,
      data: {
        'color_search_text' : searchText,
      },
      dataType: 'html',
      success: processServerResponse
    };
    $.ajax(config);
  }
};</pre>
<p><a name="try"/></p>
<h1>That’s it! Give it a try!</h1>
<p><a href="https://aliteralmind.wordpress.com/2014/09/21/jquery_django_tutorial/#try">Start your server</a>, and go to<br/>
     <code><a href="http://my.website/color_liker" rel="nofollow">http://my.website/color_liker</a></code></p>
<p>Once again, you should see something like <a href="http://aliteralmind.com/docs/computer/programming/aliteralmind_wordpress/django_jquery_blog_post/knockout_demo">this</a>. The obvious difference is the page no longer reloads on each search request. To see the "rapid-fire request protection" in action, dramatically increase the value of <code>MILLS_TO_IGNORE_SEARCH</code>.</p>
<p><code><i>[<b>All parts:</b> <a href="/2014/09/21/jquery_django_tutorial/">ONE</a>, <a href="/2014/09/22/jquery_django_tutorial_2/">TWO</a>, <a href="/2014/09/24/django_ajax_tutorial3/">THREE</a>]</i></code></p>
<hr/>
<p>Thank you for going through this tutorial.</p>
<p>If you need help or have any suggestions, please leave a comment below. I’ll be glad to assist you.</p>
		<div id="jp-post-flair" class="sharedaddy sd-like-enabled sd-sharing-enabled"><div class="sharedaddy sd-block sd-like jetpack-likes-widget-wrapper jetpack-likes-widget-unloaded" id="like-post-wrapper-64273369-584-56d5b903d345d" data-src="//widgets.wp.com/likes/#blog_id=64273369&amp;post_id=584&amp;origin=aliteralmind.wordpress.com&amp;obj_id=64273369-584-56d5b903d345d" data-name="like-post-frame-64273369-584-56d5b903d345d"><h3 class="sd-title">Like this:</h3><p class="likes-widget-placeholder post-likes-widget-placeholder"><span class="button"><span>Like</span></span> <span class="loading">Loading...</span></p><span class="sd-text-color"/><a class="sd-link-color"/></div>
<p id="jp-relatedposts" class="jp-relatedposts">
	<h3 class="jp-relatedposts-headline"><em>Related</em></h3>
</p></div>					</div>
		
		</div></body></html>