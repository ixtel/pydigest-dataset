<html><body><div><div class="post-text" itemprop="text">

<p>I'd like to create an application with embedded python interpreter and basic debugging capabilities.
Now I'm searching the API for functions which I could use to <strong>run code step-by-step and get the number of the current line of code</strong> which is being (or is about to be) executed.</p>

<p>Official Python docs seem a little underdone for me when comes it to <a href="https://docs.python.org/3.5/c-api/init.html#profiling-and-tracing" rel="nofollow">tracing and profiling</a>.
There is, for example, no information about the meaning of the return value of <code>Py_tracefunc</code>.</p>

<p>So far I've assembled the following:</p>

<pre><code>#include &lt;Python.h&gt;

static int lineCounter = 0;

int trace(PyObject *obj, PyFrameObject *frame, int what, PyObject *arg)
{
    if(what == PyTrace_LINE)
    {
        lineCounter += 1;
        printf("line %d\n", lineCounter);
    }
    return 0;
}

int main(int argc, char *argv[])
{
    wchar_t *program = Py_DecodeLocale(argv[0], NULL);
    if (program == NULL) {
        fprintf(stderr, "Fatal error: cannot decode argv[0]\n");
        exit(1);
    }
    Py_SetProgramName(program);  /* optional but recommended */
    Py_Initialize();
    PyEval_SetTrace(trace, NULL);
    char *code = "def adder(a, b):\n"
                 " return a + b\n"
                 "x = 3\n"
                 "y = 4\n"
                 "print(adder(x, y))\n";
    PyRun_SimpleString(code);
    Py_Finalize();
    PyMem_RawFree(program);
    return 0;
}
</code></pre>

<p>However, the compiler outputs the following error:</p>

<pre class="lang-none prettyprint-override"><code>hello.c:5:26: error: unknown type name ‘PyFrameObject’
 int trace(PyObject *obj, PyFrameObject *frame, int what, PyObject *arg)
                          ^
</code></pre>

<p>I'm operating on ManjaroLinux and using the following to compile the above:</p>

<pre class="lang-none prettyprint-override"><code>gcc -o hello hello.c -I/usr/include/python3.5m  -Wno-unused-result -Wsign-compare -Wunreachable-code -march=x86-64 -mtune=generic -O2 -pipe -fstack-protector-strong --param=ssp-buffer-size=4 -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes -L/usr/lib -lpython3.5m -lpthread -ldl  -lutil -lm  -Xlinker -export-dynamic
</code></pre>

<p>I've found that I can replace <code>PyFrameObject</code> with <code>struct _frame</code> and then program compiles but everyone knows it's a dirty hack, not a solution.</p>

<p>The executable outputs the following:</p>

<pre class="lang-none prettyprint-override"><code>line 1
line 2
line 3
line 4
line 5
7
</code></pre>

<p><strong>But I'd like the traces to follow the execution flow of the script (that is: start from line 3, then 4, 5 and then, due to the function call, 2).</strong></p>

<p><strong>I could not find anything about step-by-step execution.</strong></p>

<p>Could you recommend some other sources about Python C API with more information and some introduction to the topic?</p>

<p><em>I awarded the answer with bounty since it would expire anyway. However, I'm still looking and would be grateful for answers for other questions from above.</em></p>
    </div>
    </div></body></html>