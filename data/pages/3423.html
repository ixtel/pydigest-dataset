<html><body><div><div class="post shortcuts_item" id="post_251419">
    <p class="published">26 февраля 2015 в 13:20</p>
    <h1 class="title">
      

        <span class="post_title">Генерация текстур планет с помощью алгоритма Fault Formation</span>

      

      

    </h1>

      


    <div class="content html_format">
      <p>
Возможно, кто-то помнит замечательную олдскульную космическую игру </p><a href="https://en.wikipedia.org/wiki/Star_Control_II">Star Control 2.</a><p> В свое время меня поразила огромная звездная карта с неизведанными планетами, которые предстояло исследовать на фоне разворачивающейся глобальной катастрофы. С тех пор как авторами были опубликованы исходные коды, игра была портирована под новым именем </p><a href="http://sc2.sourceforge.net">The Ur-Quan Masters</a><p> на большинство современных платформ.
</p><p>
Покопавшись в исходниках, я обнаружил простой алгоритм, генерирующий текстуры планет, и написал программу на Python, позволяющую генерировать аналогичные текстуры.
</p><a name="habracut"/>

<h1>Алгоритм</h1>
<ol>
<li>Формируем карту высот с помощью алгоритма <b>Fault Formation</b> (<i>«формирование разломов»</i>)</li>
<li>Раскрашиваем карту высот, используя опорные RGB цвета и градиент между ними</li>
</ol>
<h3>Формирование карты высот</h3>
<ol>
<li>Создаем матрицу высот той же размерности, что и генерируемая текстура планеты. Север сверху, юг снизу, а горизонталь матрицы представляет собой круговую развертку планеты вдоль параллели. Значение высот может меняться только в пределах от 0 до 255, поэтому удобно отображать их оттенками серого цвета</li>
<li>Заполняем матрицу базовым значением высоты (<b>base elevation</b>), например, 128:<br/>
<br/>
 <img src="https://habrastorage.org/files/18e/9ed/44d/18e9ed44de3649a085d4d2df136fb494.png"/>   <img src="https://habrastorage.org/files/459/e4b/49d/459e4b49da174e58835c62c694afd31f.png"/><br/>
 </li>
<li>Генерируем две случайные непересекающиеся линии с севера на юг. Эти линии «формируют разлом» — делят поверхность планеты на две части, одну из которых мы поднимаем на фиксированную константу (<b>elevation delta</b>), а другую опускаем на эту же константу. Для наглядности пусть константа равна 10:<br/>
<br/>
 <img src="https://habrastorage.org/files/07d/9c2/006/07d9c2006f0449bba1804fa1d8a405e5.png"/>   <img src="https://habrastorage.org/files/dd7/674/0a5/dd76740a5b314a4b8d1dd6749abad1c2.png"/><br/>
 </li>
<li>Повторяем предыдущий пункт заданное количество раз (<b>iterations num</b>).<br/>
На рисунках ниже: 10 итераций, 100 итераций, 1000 итераций:<br/>
<br/>
 <img src="https://habrastorage.org/files/09c/d88/354/09cd883540cd431f95c380744d20ddf2.png"/>   <img src="https://habrastorage.org/files/937/cbe/dbb/937cbedbbd6c45e386fd49a6735e79b6.png"/><br/>
 <br/>
<br/>
 <img src="https://habrastorage.org/files/fbe/ad0/73a/fbead073a44a4172bd47ee7bc4838f62.png"/>   <img src="https://habrastorage.org/files/68e/397/7f3/68e3977f37c042dab33da1ed65b1342f.png"/><br/>
 <br/>
<br/>
 <img src="https://habrastorage.org/files/858/0dc/4f9/8580dc4f957b465d90ebb6fce1167fb2.png"/>   <img src="https://habrastorage.org/files/799/a77/1a8/799a771a849d4d6fa54261112e459888.png"/><br/>
 </li>
</ol>

<h3>Раскрашивание карты высот RGB цветами</h3>
<ol>
<li>Делим весь диапазон высот (от 0 до 255) на N более-менее равных частей с N + 1 опорными точками на границах этих частей</li>
<li>Задаем RGB цвет для каждой опорной точки диапазона</li>
<li>Вычисляем RGB цвет для всех промежуточных точек диапазона, линейно интерполируя компоненты цвета между опорными точками. Иными словами, заполняем значения высот градиентом между опорными цветами</li>
<li>Генерируем текстуру планеты, заменяя каждую ячейку матрицы высот на вычисленный в предыдущем пункте RGB цвет</li>
</ol><p>
Вот несколько возможных вариантов раскрашивания одной и той же карты высот:

</p><img src="https://habrastorage.org/files/e2c/9fd/0af/e2c9fd0afc4a4ce1ace0d0244d16ba56.png"/>   <img src="https://habrastorage.org/files/a5d/2aa/e04/a5d2aae041d64ac786dd313e0bbac61b.png"/>
<img src="https://habrastorage.org/files/074/56f/29d/07456f29d2c5498ba09e634183df5f95.png"/>

<img src="https://habrastorage.org/files/f3a/506/25d/f3a50625da9e430b80159e970a7f771f.png"/>   <img src="https://habrastorage.org/files/22b/1af/989/22b1af98997646ec853f38d0edc207ea.png"/>
<img src="https://habrastorage.org/files/f78/688/c0d/f78688c0dd704533842b9e45c68a789f.png"/>

<img src="https://habrastorage.org/files/b48/f25/4c7/b48f254c772341df9cb9a9224cf0ca06.png"/>   <img src="https://habrastorage.org/files/223/4a3/66b/2234a366bfd340a9afcc953daf4c1871.png"/>
<img src="https://habrastorage.org/files/2ce/b20/1e4/2ceb201e41b2451782bb42484b5b06e5.png"/>
 

<h1>Программа</h1><p>
Для запуска программы необходимо установить </p><a href="https://www.python.org/download/releases/2.7/">Python 2.7</a><p> и несколько библиотек к нему: </p><a href="http://sourceforge.net/projects/numpy/">NumPy</a><p>, </p><a href="http://www.pythonware.com/products/pil/">PIL</a><p> и </p><a href="http://pyopengl.sourceforge.net/">PyOpenGL.</a>
<p>
Программу можно скачать из репозитория git: </p><a href="https://github.com/barabanus/starcontrol">https://github.com/barabanus/starcontrol</a>
<p>
Программа состоит из двух независимых скриптов: </p><b>planet.py</b><p> (генерирует текстуру), и </p><b>space.py</b><p> (рисует вращающуюся планету с наложенной текстурой).
</p><p>
Некоторые особенности управления:</p><ul>
<li>Для изменения опорного цвета кликните левой кнопкой мыши на квадратике с цветом. В MacOS во всплывающем диалоге есть возможность сэмплировать цвет с экрана</li>
<li>Для создания нового опорного цвета кликните левой кнопкой мыши на градиенте</li>
<li>Для удаления опорного цвета кликните правой кнопкой мыши на квадратике с цветом</li>
<li>Для сохранения текстуры кликните по ней левой кнопкой мыши. При этом запускается скрипт, рисующий вращающуюся планету с этой текстурой</li>
</ul><p>
Программа создавалась на MacOS, тестировалась на WinXP. Если вы нашли и смогли исправить ошибку в коде или украсили рендер — пишите и предлагайте изменения.


      
      </p><p class="clear"/>
    </div>

    
  


      <div class="infopanel_wrapper js-user_261629">
    <ul class="postinfo-panel postinfo-panel_post" id="infopanel_post_251419">

          <li class="postinfo-panel__item">
            
          </li>

      <li class="postinfo-panel__item">
        <p class="views-count_post" title="Просмотры публикации">12,6k</p>
      </li>

      <li class="postinfo-panel__item">
        <p class="favorite-wjt favorite">
            <button type="button" disabled="disabled" class="favorite-wjt__button favorite-wjt__button_disabled" title="Только зарегистрированные пользователи могут добавлять публикации в избранное">
              <span>Добавить в избранное</span>
            </button>
          <span class="favorite-wjt__counter js-favs_count" title="Количество пользователей, добавивших публикацию в избранное">147</span>
        </p>
      </li>




      
        <li class="postinfo-panel__item postinfo-panel__item_socials  postinfo-panel__item_socials_right ">
          
        </li>

      
    </ul>
  </div>


        

  


  </div>

      </div></body></html>