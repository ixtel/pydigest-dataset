<html><body><div><div class="post-body bordered-bottom col-md-8">
                    <p>A few days ago, Python <a href="https://www.python.org/downloads/release/python-279/">2.7.9</a> was released, with a very unusual feature change for a subminor release. HTTPS certificate validation is now enabled by default in the Python standard libraries.</p>

<p>Since I use <a href="http://brew.sh/">Homebrew</a>, upgrading was very easy. Of course, replacing the Python interpreter broke all my virtualenvs, but that was quickly fixed. I set about regenerating all the tox environments for my latest project and then something strange happened.</p>

<p><a href="https://coveralls.io/">Coveralls.io</a> provides coverage information for Python projects. Very handy, very useful public service. Except according to <a href="http://sphinx-doc.org/builders.html#sphinx.builders.linkcheck.CheckExternalLinksBuilder">sphinx linkcheck</a>, the website had an expired certificate, which caused my <code>tox docs</code> build to fail. I tried viewing the website in my browser; it worked just fine. But to anything using <code>urllib</code> or <code>httplib</code>, it was invalid.</p>

<p>The Coveralls site uses Cloudflare's free SSL certificate support. It's issued by GlobalSign, using an intermediate certificate. All three appeared valid when I inspected them in Chrome and Safari.</p>

<p><img src="/content/images/2014/12/certchain-1.png" alt="Coveralls.io certificate chain"/></p>

<p>With the help of some kind folks from the <code>#python</code> channel on Freenode, I figured out that Homebrew's Python install uses Homebrew's OpenSSL, and any other app using Homebrew's OpenSSL was similarly affected. So I bounced over to the <code>#machomebrew</code> channel.</p>

<p>During all this, I found out how to extract the three certificates in PEM format and get openssl to try to validate them. It told me the Root CA cert was invalid due to being self-signed, which made sense. Then it told me it was in fact the intermediate cert that was expired. And yet, when I dumped the dates from the certificate, it didn't expire until 2022. (It turned out that the result I got meant that the root cert had expired, but openssl didn't explain that well enough for me to understand.)</p>

<p>Meanwhile, I was experimenting with Homebrew OpenSSL's certificate store. When you install it, it <a href="https://github.com/Homebrew/homebrew/blob/75d1c094326e0d86ce8d315a483b4fbe8000beb5/Library/Formula/openssl.rb#L103">dumps the system trusted roots</a> into a <a href="http://en.wikipedia.org/wiki/X.509#Certificate_filename_extensions">PEM file</a>. I made a cursory check and the GlobalSign Root CA cert was there. If I'd made a better check, I probably would have spotted the issue right there, but I didn't.</p>

<p><img src="/content/images/2014/12/globalsign-1.png" alt="Expired Root Cert"/></p>

<p>However, eventually someone in <code>#machomebrew</code> gave me a link that shed some light on the issue. It turned out the OS X System Keychain had two root certs for GlobalSign; the valid one that was showing in Chrome and Safari and an expired one. Either the keychain itself or the browsers using it were smart enough to ignore the expired one, but OpenSSL wasn't. Removing the expired root cert and regenerating the OpenSSL cert store solved the problem.</p>
                </div>
            </div></body></html>