<html><body><div><article class="markdown-body entry-content" itemprop="text"><h1><a id="user-content-supycache" class="anchor" href="#supycache" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>supycache</h1>
<p>Simple yet capable caching decorator for python</p>
<p>Source code: <a href="https://github.com/lonetwin/supycache">https://github.com/lonetwin/supycache</a></p>
<p>Install using pip: <code>pip install supycache</code> or download from <a href="https://pypi.python.org/pypi/supycache">https://pypi.python.org/pypi/supycache</a></p>
<a name="user-content-what-is-supycache"/>
<h2><a id="user-content-what-is-supycache-" class="anchor" href="#what-is-supycache-" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>What is supycache ?</h2>
<p><code>supycache</code> is a decorator that enables caching of return values for
time-consuming functions, either in memory or on a cache server such as
<a href="http://memcached.org/">memcached</a> or <a href="http://redis.io/">redis</a>.</p>
<p>The cache keys can either be <em>indedependent</em> or dependent (completely or
<em>partially</em>) on the arguments passed to the function.</p>
<p>This is <strong>different</strong> from other similar caching decorators, for
instance,
<a href="https://docs.python.org/3/library/functools.html#functools.lru_cache">functools.lru_cache</a>
which is dependent on all the arguments passed to the function and
requires the arguments to be hashable.</p>
<p>If you use the default cache backend (ie: supycache.backends.DictCache), you
can also provide an age for the cached values</p>
<p>Here's an example of how you might use <code>supycache</code></p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">import</span> time
<span class="pl-k">import</span> supycache

<span class="pl-en">@supycache.supycache</span>(<span class="pl-v">cache_key</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>result<span class="pl-pds">'</span></span>, <span class="pl-v">max_age</span><span class="pl-k">=</span><span class="pl-c1">5</span>)
<span class="pl-k">def</span> <span class="pl-en">execute_expensive</span>():
    <span class="pl-c1">print</span> <span class="pl-s"><span class="pl-pds">'</span>original function called<span class="pl-pds">'</span></span>
    time.sleep(<span class="pl-c1">15</span>)
    <span class="pl-k">return</span> <span class="pl-c1">42</span>

<span class="pl-c1">print</span> execute_expensive()  <span class="pl-c"># This will take 15 seconds to execute ...</span>
original function called
<span class="pl-c1">42</span>
<span class="pl-c1">print</span> execute_expensive()  <span class="pl-c"># ...not this tho', because the value is cached ...</span>
<span class="pl-c1">42</span>
<span class="pl-c1">print</span> supycache.default_backend.get(<span class="pl-s"><span class="pl-pds">'</span>result<span class="pl-pds">'</span></span>) <span class="pl-c"># ..keyed as `result`</span>
<span class="pl-c1">42</span>
time.sleep(<span class="pl-c1">5</span>)              <span class="pl-c"># wait for the cache to expire...</span>
execute_expensive()        <span class="pl-c"># This will again take 15 seconds to execute ...</span>
original function called
<span class="pl-c1">42</span>
<span class="pl-c1">print</span> execute_expensive()  <span class="pl-c"># ...not this tho', because the value is re-cached ...</span>
<span class="pl-c1">42</span></pre></div>
<p>Sometimes you might want to be aware of the arguments that are passed to
the function:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-en">@supycache</span>(<span class="pl-v">cache_key</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>sum_of_<span class="pl-c1">{0}</span>_and_<span class="pl-c1">{1}</span><span class="pl-pds">'</span></span>)   <span class="pl-c"># Cache the sum of x and y creating a</span>
<span class="pl-k">def</span> <span class="pl-en">cached_sum</span>(<span class="pl-smi">x</span>, <span class="pl-smi">y</span>):                        <span class="pl-c"># key based on the arguments passed</span>
    <span class="pl-k">return</span> x <span class="pl-k">+</span> y

<span class="pl-c1">print</span> cached_sum(<span class="pl-c1">28</span>, <span class="pl-c1">14</span>)
<span class="pl-c1">42</span>
<span class="pl-c1">print</span> supycache.default_backend.get(<span class="pl-s"><span class="pl-pds">'</span>sum_of_28_and_14<span class="pl-pds">'</span></span>)
<span class="pl-c1">42</span></pre></div>
<p>You can also create the key based on <strong>partial arguments</strong> or on the
<code>attributes</code>/<code>items</code> within the arguments.</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">class</span> <span class="pl-en">User</span>:
    <span class="pl-k">def</span> <span class="pl-c1">__init__</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>, <span class="pl-smi">name</span>, <span class="pl-smi">session_key</span>):
        <span class="pl-v">self</span>.name <span class="pl-k">=</span> name
        <span class="pl-v">self</span>.session_key <span class="pl-k">=</span> session_key

<span class="pl-en">@supycache</span>(<span class="pl-v">cache_key</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span><span class="pl-c1">{user_obj.name}</span><span class="pl-pds">'</span></span>)   <span class="pl-c"># build the cache key dependent on *just*</span>
<span class="pl-k">def</span> <span class="pl-en">get_username</span>(<span class="pl-smi">user_obj</span>):               <span class="pl-c"># the `.name` attribute</span>
    time.sleep(<span class="pl-c1">15</span>)
    <span class="pl-k">return</span> user_obj.name

a <span class="pl-k">=</span> User(<span class="pl-v">name</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>steve<span class="pl-pds">'</span></span>, <span class="pl-v">session_key</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>0123456789<span class="pl-pds">'</span></span>)
b <span class="pl-k">=</span> User(<span class="pl-v">name</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>steve<span class="pl-pds">'</span></span>, <span class="pl-v">session_key</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>9876543210<span class="pl-pds">'</span></span>) <span class="pl-c"># same name, different session</span>

<span class="pl-c1">print</span> get_username(<span class="pl-v">user_obj</span><span class="pl-k">=</span>a)   <span class="pl-c"># This will take 15 seconds to execute ...</span>
steve
<span class="pl-c1">print</span> get_username(<span class="pl-v">user_obj</span><span class="pl-k">=</span>a)   <span class="pl-c"># ...not this tho'...</span>
steve
<span class="pl-c1">print</span> get_username(<span class="pl-v">user_obj</span><span class="pl-k">=</span>b)   <span class="pl-c"># ...and neither will this !</span>
steve


<span class="pl-en">@supycache</span>(<span class="pl-v">cache_key</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span><span class="pl-c1">{choices[0]}</span>_<span class="pl-c1">{menu[lunch]}</span><span class="pl-pds">'</span></span>)         <span class="pl-c"># build the cache</span>
<span class="pl-k">def</span> <span class="pl-en">supersized_lunch</span>(<span class="pl-smi">ignored</span>, <span class="pl-smi">choices</span><span class="pl-k">=</span><span class="pl-c1">None</span>, <span class="pl-smi">menu</span><span class="pl-k">=</span><span class="pl-c1">None</span>):    <span class="pl-c"># key dependent on</span>
    time.sleep(<span class="pl-c1">15</span>)                                         <span class="pl-c"># partial arguments</span>
    <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">'</span>You get a <span class="pl-c1">%s</span> <span class="pl-c1">%s</span><span class="pl-pds">'</span></span> <span class="pl-k">%</span> (choices[<span class="pl-k">-</span><span class="pl-c1">1</span>], menu[<span class="pl-s"><span class="pl-pds">'</span>lunch<span class="pl-pds">'</span></span>])

menu <span class="pl-k">=</span> {<span class="pl-s"><span class="pl-pds">'</span>breakfast<span class="pl-pds">'</span></span> : <span class="pl-s"><span class="pl-pds">'</span>eggs<span class="pl-pds">'</span></span>,
        <span class="pl-s"><span class="pl-pds">'</span>lunch<span class="pl-pds">'</span></span>     : <span class="pl-s"><span class="pl-pds">'</span>pizza<span class="pl-pds">'</span></span>,
        <span class="pl-s"><span class="pl-pds">'</span>dinner<span class="pl-pds">'</span></span>    : <span class="pl-s"><span class="pl-pds">'</span>steak<span class="pl-pds">'</span></span>}

sizes <span class="pl-k">=</span> [<span class="pl-s"><span class="pl-pds">'</span>small<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>medium<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>large<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>supersize<span class="pl-pds">'</span></span>]

<span class="pl-c1">print</span> supersized_lunch(<span class="pl-s"><span class="pl-pds">'</span>ignored<span class="pl-pds">'</span></span>, <span class="pl-v">choices</span><span class="pl-k">=</span>sizes, <span class="pl-v">menu</span><span class="pl-k">=</span>menu)
You get a supersize pizza       <span class="pl-c"># This will take 15 seconds to execute ...</span>

<span class="pl-c1">print</span> supersized_lunch(<span class="pl-s"><span class="pl-pds">'</span>changed<span class="pl-pds">'</span></span>, <span class="pl-v">choices</span><span class="pl-k">=</span>sizes, <span class="pl-v">menu</span><span class="pl-k">=</span>menu)
You get a supersize pizza       <span class="pl-c"># ...not this tho'...</span></pre></div>
<p>If that format specification for the <code>cache_key</code> looks familiar,
you've discovered the <em>secret</em> of supycache !</p>
<div class="highlight highlight-source-python"><pre><span class="pl-en">@supycache</span>(<span class="pl-v">backend</span><span class="pl-k">=</span>memcached_backend, <span class="pl-v">cache_key</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span><span class="pl-c1">{0}</span>_<span class="pl-c1">{kw[foo]}</span>_<span class="pl-c1">{obj.x}</span><span class="pl-pds">'</span></span>)
<span class="pl-k">def</span> <span class="pl-en">custom_key_built_from_args</span>(<span class="pl-smi">positional</span>, <span class="pl-smi">kw</span><span class="pl-k">=</span><span class="pl-c1">None</span>, <span class="pl-smi">obj</span><span class="pl-k">=</span><span class="pl-c1">None</span>):
    <span class="pl-c"># now, supycache will build the `cache_key` from the arguments passed and</span>
    <span class="pl-c"># use the memcached_backend instance to `set` the key with the return value</span>
    <span class="pl-c"># of this function</span>
    <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">'</span>cached<span class="pl-pds">'</span></span></pre></div>
<p>The <em>secret</em> of supycache is quite simple -- it calls <code>.format()</code> on
the <code>cache_key/expire_key</code> with the passed <code>args</code> and <code>kwargs</code> to
build the actual key.</p>
<p>However, if you'd like to have more control on the way the
<code>cache_key/expire_key</code> are created, simply pass in a callable !</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">def</span> <span class="pl-en">extract_path</span>(<span class="pl-smi">url</span><span class="pl-k">=</span><span class="pl-c1">None</span>, <span class="pl-k">*</span><span class="pl-smi">args</span>, <span class="pl-k">**</span><span class="pl-smi">kwags</span>):
    <span class="pl-k">return</span> urlparse.urlparse(url).path

<span class="pl-en">@supycache</span>(<span class="pl-v">cache_key</span><span class="pl-k">=</span>extract_path, <span class="pl-v">ignore_errors</span><span class="pl-k">=</span><span class="pl-c1">False</span>)
<span class="pl-k">def</span> <span class="pl-en">do_something_with</span>(<span class="pl-smi">url</span>):
    <span class="pl-c"># will call `extract_path` at runtime passing `url` as parameter and</span>
    <span class="pl-c"># will use the returned value as the cache key. Also, don't ignore any</span>
    <span class="pl-c"># errors in the entire process if something fails (the default is to</span>
    <span class="pl-c"># ignore any caching errors and just return the result as tho' this</span>
    <span class="pl-c"># function was undecorated.</span>
    <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">'</span>cached<span class="pl-pds">'</span></span>

do_something_with(<span class="pl-s"><span class="pl-pds">'</span>http://www.example.com/foo/bar<span class="pl-pds">'</span></span>)
<span class="pl-s"><span class="pl-pds">'</span>cached<span class="pl-pds">'</span></span>
supycache.default_backend.get(<span class="pl-s"><span class="pl-pds">'</span>/foo/bar<span class="pl-pds">'</span></span>)
<span class="pl-s"><span class="pl-pds">'</span>cached<span class="pl-pds">'</span></span></pre></div>
<p>The <code>backend</code> interface is abstarcted out neatly so that backends can be
swapped out without too much hassle. As long as the passed in object has a
<code>get()</code>, <code>set()</code> and <code>delete()</code> methods, it can be passed to
<code>supycache</code> as a backend or can be set as the <code>default_backend</code>.</p>
<p>Right now though, this project has only the code and tests, no docs
(barring some docstrings !). I'll be adding them soon. If interested take a
look at the tests to see the typical usage and try it out. Feedback, bug
reports and pull requests would be great !</p>
<a name="user-content-help-required"/>
<h2><a id="user-content-help-required" class="anchor" href="#help-required" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Help required</h2>
<p>I would really appreciate any help you could offer, not just in implementation
but also in validating the packaging and distribution of this module via pypi
since I've not distributed any packages before.</p>
<p>Besides that I plan on adding a few more things:</p>
<blockquote>
<ul>
<li>Ability to specify a <code>max_age</code> for all backends.</li>
<li>I'm not sure whether I am doing the right thing for the not the packaging
of the memcached dependency. I'd like to automatically include the
support for <code>memcached</code> or <code>redis</code> backends if the python memcached
or redis modules are installed.</li>
<li>logging support</li>
</ul>
</blockquote>

</article>
  </div></body></html>