<html><body><div><div class="section-inner layoutSingleColumn"><p name="78c9" id="78c9" class="graf--p graf--first">Our ISession implementation is initiated with a GatewayUser avatar an handles “exec” requests.</p><pre name="a046" id="a046" class="graf--pre graf-after--p">class GatewaySessionInterface():</pre><pre name="d266" id="d266" class="graf--pre graf-after--pre">    implements(ISession)</pre><pre name="0bd3" id="0bd3" class="graf--pre graf-after--pre">    def __init__(self, avatar):<br/>        self.avatar = avatar</pre><pre name="7bc8" id="7bc8" class="graf--pre graf-after--pre">    def execCommand(self, protocol, command_string):<br/>        log.msg(“Execute command : %s” % command_string)</pre><p name="c0d5" id="c0d5" class="graf--p graf-after--pre">We extend the SSHSession class so it will use GatewaySessionInterface as an ISession. There is another way to do this mentioned in the docs, but it is less explicit.</p><pre name="b5f4" id="b5f4" class="graf--pre graf-after--p">class GatewaySession(SSHSession):</pre><pre name="c6d2" id="c6d2" class="graf--pre graf-after--pre">    def channelOpen(self, specificData):<br/>        self.session = GatewaySessionInterface(self.avatar)</pre><p name="cd8c" id="cd8c" class="graf--p graf-after--pre">To enable our new GatewaySession class we override our avatar’s channel lookup “session” entry.</p><pre name="32f3" id="32f3" class="graf--pre graf-after--p">class GatewayUser(ConchUser):</pre><pre name="95d3" id="95d3" class="graf--pre graf-after--pre">    def __init__(self, key):<br/>        ConchUser.__init__(self)<br/>        self.user = key.user<br/>        self.project = key.project<br/>        self.channelLookup[‘session’] = GatewaySession</pre><h4 name="b812" id="b812" class="graf--h4 graf-after--pre"><strong class="markup--strong markup--h4-strong">Git — Processes, Reference Discovery, Packfile Negotiation</strong></h4><p name="624a" id="624a" class="graf--p graf-after--h4">To serve up Git we will need to understand its <a href="https://github.com/git/git/blob/master/Documentation/technical/pack-protocol.txt" data-href="https://github.com/git/git/blob/master/Documentation/technical/pack-protocol.txt" class="markup--anchor markup--p-anchor" rel="nofollow">protocol</a> and transport mechanisms. Git can utilize several transports, but we are only interested in SSH.</p><p name="c897" id="c897" class="graf--p graf-after--p">Each time a user fetches or pushes data a command is executed on the server using SSH. The process spawned from the command allows the server and client to communicate.</p><p name="be4e" id="be4e" class="graf--p graf-after--p">All commands are handled by two executables on the server : git-upload-pack and git-receive-pack. Sending data to the server fires up the git-receive-pack executable. Fetching data which includes cloning executes git-upload-pack.</p><p name="92f0" id="92f0" class="graf--p graf-after--p">For example, the command :</p><pre name="e1f0" id="e1f0" class="graf--pre graf-after--p">git clone <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="51343c383d113b3e3d25343c7f323e3c">[email protected]</a>:1</pre><p name="1aed" id="1aed" class="graf--p graf-after--pre">Is mapped to this command :</p><pre name="5e4d" id="5e4d" class="graf--pre graf-after--p">ssh <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="31545c585d715b5e5d45545c1f525e5c">[email protected]</a> “git-upload-pack ‘1'”</pre><p name="f77f" id="f77f" class="graf--p graf-after--pre">Which establishes an SSH connection and executes the command :</p><pre name="6f2d" id="6f2d" class="graf--pre graf-after--p">git-upload-pack ‘1'</pre><p name="3485" id="3485" class="graf--p graf-after--pre">Once the line of communication is opened <a href="https://github.com/git/git/blob/master/Documentation/technical/pack-protocol.txt" data-href="https://github.com/git/git/blob/master/Documentation/technical/pack-protocol.txt" class="markup--anchor markup--p-anchor" rel="nofollow">Git’s protocol</a> proceeds. The protocol uses <a href="https://github.com/git/git/blob/master/Documentation/technical/protocol-common.txt" data-href="https://github.com/git/git/blob/master/Documentation/technical/protocol-common.txt" class="markup--anchor markup--p-anchor" rel="nofollow">packet lines</a> ( or pkt-lines ) to communicate :</p><blockquote name="f3de" id="f3de" class="graf--blockquote graf-after--p"><em class="markup--em markup--blockquote-em">A pkt-line is a variable length binary string. The first four bytes of the line, the pkt-len, indicates the total length of the line, in hexadecimal. The pkt-len includes the 4 bytes used to contain the length’s hexadecimal representation.</em></blockquote><pre name="742c" id="742c" class="graf--pre graf-after--blockquote">Examples (as C-style strings):</pre><pre name="e3d8" id="e3d8" class="graf--pre graf-after--pre">——<br/> pkt-line actual value<br/> ————————————————-<br/> “0006a\n”       “a\n”<br/> “0005a”         “a”<br/> “000bfoobar\n”  “foobar\n”<br/> “0004"          “”<br/>——</pre><p name="1a23" id="1a23" class="graf--p graf-after--pre">A 0000 flush packet indicates an end of a group of statements.</p><p name="d56c" id="d56c" class="graf--p graf-after--p">The first order of business is <em class="markup--em markup--p-em">reference discovery </em>:</p><blockquote name="e5a0" id="e5a0" class="graf--blockquote graf-after--p"><em class="markup--em markup--blockquote-em">When the client initially connects the server will immediately respond with a listing of each reference it has (all branches and tags) along with the object name that each reference currently points to.</em></blockquote><p name="82a0" id="82a0" class="graf--p graf-after--blockquote">Along with the first reference in the list the server informs the client of its <a href="https://github.com/git/git/blob/master/Documentation/technical/protocol-capabilities.txt" data-href="https://github.com/git/git/blob/master/Documentation/technical/protocol-capabilities.txt" class="markup--anchor markup--p-anchor" rel="nofollow">capabilities</a>.</p><pre name="0833" id="0833" class="graf--pre graf-after--p">009bb8915a670ec46e39f25ff700eb260ef5e8d045b1 HEAD\x00multi_ack thin-pack side-band side-band-64k ofs-delta shallow no-progress include-tag multi_ack_detailed<br/>0040cbb40cbc1f82c5d823484b1ccaf742fe210bcf52 refs/heads/develop<br/>003fb8915a670ec46e39f25ff700eb260ef5e8d045b1 refs/heads/master<br/>0040964838da3cd6e95f71d6bf6b425431769f76c22e refs/tags/1.3.2^{}<br/>003d101c5cb5601d9ac04533bf3db810095d0faf7568 refs/tags/1.3.3<br/>003d5da834fffb7e252418b080cca78041517bcd9734 refs/tags/1.3.4<br/>0000</pre><p name="e8cc" id="e8cc" class="graf--p graf-after--pre">The next step depends on whether the client is fetching or pushing. If the client is fetching a process called <a href="https://github.com/git/git/blob/master/Documentation/technical/pack-protocol.txt" data-href="https://github.com/git/git/blob/master/Documentation/technical/pack-protocol.txt" class="markup--anchor markup--p-anchor" rel="nofollow"><em class="markup--em markup--p-em">pack file negotiation</em></a><em class="markup--em markup--p-em"> </em>proceeds. During the process the client informs the server what it has and what it wants. The server uses this to compile the necessary objects into the smallest <a href="https://github.com/git/git/blob/master/Documentation/technical/pack-format.txt" data-href="https://github.com/git/git/blob/master/Documentation/technical/pack-format.txt" class="markup--anchor markup--p-anchor" rel="nofollow">pack file</a> possible.</p><p name="e8e0" id="e8e0" class="graf--p graf-after--p">Since our main goals is to enforce branch level <em class="markup--em markup--p-em">push </em>permissions, let us examine what happens during a push.</p><blockquote name="5b58" id="5b58" class="graf--blockquote graf-after--p"><em class="markup--em markup--blockquote-em">Once the client knows what references the server is at, it can send a list of reference update requests. For each reference on the server that it wants to update, it sends a line listing the obj-id currently on the server, the obj-id the client would like to update it to and the name of the reference.</em></blockquote><p name="0824" id="0824" class="graf--p graf-after--blockquote">An example, pushing the develop and master branches :</p><pre name="5638" id="5638" class="graf--pre graf-after--p">00859d4c1ed658ee2617521d846bf601cec06001a2c8 cbb40cbc1f82c5d823484b1ccaf742fe210bcf52 refs/heads/develop\x00report-status side-band-64k<br/>00676860ded8258f538407e9eb1d2017ffc7a3015abe b8915a670ec46e39f25ff700eb260ef5e8d045b1 refs/heads/master<br/>0000</pre><p name="ab89" id="ab89" class="graf--p graf-after--pre graf--last">Immediately after this, the client compiles and sends a pack file. The file contains all the objects the server will need to fill the gap between the old and new commit.</p></div></div></body></html>