<html><body><div><section class="the_post">
    <div class="section" id="motivation">
<h2>Motivation</h2>
<p>A few months ago we posted a similar <a class="reference external" href="http://www.machinalis.com/blog/rt-django-notifications/">article</a>  that presented a way to implement real-time notifications on <a class="reference external" href="https://www.djangoproject.com/">Django</a> using <a class="reference external" href="http://nodejs.org/">Node.js</a>, <a class="reference external" href="http://socket.io/">socket.io</a> and <a class="reference external" href="http://redis.io/">Redis</a>. It got quite a few comments asking us why we used Node.js instead of a <a class="reference external" href="http://www.gevent.org/">gevent</a>-based solution. Our response was that we had hands-on experience with the Node.js solution, and that we would try to write another article about a gevent-based solution in the future. This is that article.</p>
<p>This time we’ll be replacing Node.js with a 100% Python implementation using <a class="reference external" href="https://github.com/abourget/gevent-socketio">gevent-socketio</a> and Redis with <a class="reference external" href="http://www.rabbitmq.com/">RabbitMQ</a>, but we also didn’t want to bore you with the same vanilla notifications site, so we’re going to build something different. Something useful.</p>
<p>This time we’re going to build a complete <a class="reference external" href="https://docs.djangoproject.com/en/1.7/ref/contrib/gis/">GeoDjango</a>-based site to report geo-located  incidents in real-time using <a class="reference external" href="https://developers.google.com/maps/documentation/javascript/">Google Maps</a>.</p>
</div>
<div class="section" id="update">
<h2>Update</h2>
<p>Given the problems that we mentioned regarding gevent-socketio, some users asked us for a Node.js+socket.io implementation (similar to the one in the old article). We created a new branch named on GitHub named <a class="reference external" href="https://github.com/abarto/tracker_project/tree/node_js/">node_js</a> to hold the new implementation.</p>
</div>
<div class="section" id="the-application">
<h2>The Application</h2>
<p>The application is a Django 1.7 site that uses GeoDjango (backed by <a class="reference external" href="http://postgis.net/">PostGIS</a>) to track and report in real-time geo-located incidents that occur in certain areas of interest around the world. It provides views to manage incidents and areas of interest, a view to monitor the occurrence of incidents in real-time and a view to report incidents that uses <a class="reference external" href="https://github.com/onury/geolocator">geolocator</a> to detect the user’s location.</p>
<p>Whenever an incident is saved (or updated), a message is sent to a RabbitMQ broadcast queue. At this time, the system checks whether the incident occurred in an area of interest, and a special alert message is sent if necessary. Any subscriber to the queue (which are created when a client connects to the notifications socket.io namespace) will receive the message and send a packet down the socket’s channel. It is up the the client’s JavaScript code to update the maps and generate notifications and alerts if necessary.</p>
<p>Although simple, the site has all the basic functionality and can be used as a basis for similar projects. The source is available on <a class="reference external" href="https://github.com/abarto/tracker_project">GitHub</a>.</p>
</div>
<div class="section" id="the-model">
<h2>The model</h2>
<p>To represent the incidents and the areas of interest, we’re going to use the following model:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.contrib.gis.db</span> <span class="kn">import</span> <span class="n">models</span>


<span class="k">class</span> <span class="nc">Incident</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">objects</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">GeoManager</span><span class="p">()</span>

    <span class="n">URGENT</span> <span class="o">=</span> <span class="s">'UR'</span>
    <span class="n">HIGH</span> <span class="o">=</span> <span class="s">'HI'</span>
    <span class="n">MEDIUM</span> <span class="o">=</span> <span class="s">'ME'</span>
    <span class="n">LOW</span> <span class="o">=</span> <span class="s">'LO'</span>
    <span class="n">INFO</span> <span class="o">=</span> <span class="s">'IN'</span>

    <span class="n">SEVERITY_CHOICES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">URGENT</span><span class="p">,</span> <span class="s">'Urgent'</span><span class="p">),</span>
        <span class="p">(</span><span class="n">HIGH</span><span class="p">,</span> <span class="s">'High'</span><span class="p">),</span>
        <span class="p">(</span><span class="n">MEDIUM</span><span class="p">,</span> <span class="s">'Medium'</span><span class="p">),</span>
        <span class="p">(</span><span class="n">LOW</span><span class="p">,</span> <span class="s">'Low'</span><span class="p">),</span>
        <span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">'Info'</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">severity</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">SEVERITY_CHOICES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">MEDIUM</span><span class="p">)</span>
    <span class="n">closed</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">location</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PointField</span><span class="p">()</span>
    <span class="n">created</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">editable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">auto_now_add</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">AreaOfInterest</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">objects</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">GeoManager</span><span class="p">()</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="n">severity</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">Incident</span><span class="o">.</span><span class="n">SEVERITY_CHOICES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">Incident</span><span class="o">.</span><span class="n">MEDIUM</span><span class="p">)</span>
    <span class="n">polygon</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PolygonField</span><span class="p">()</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">Incident</span></tt> class represents the occurrence of an event around a specific geographic point, specified by the <tt class="docutils literal"><span class="pre">location</span></tt> field. The <tt class="docutils literal"><span class="pre">AreaOfInterest</span></tt> is used to define a region for which the user is going to be alerted if an incident is reported within it. The <tt class="docutils literal"><span class="pre">polygon</span></tt> field specifies the geographic area.</p>
<p>The alerts are going to be sent only when the incident’s severity is above the area’s target severity, and <tt class="docutils literal"><span class="pre">location</span></tt> is within the area’s <tt class="docutils literal"><span class="pre">polygon</span></tt>. This is done using spatial QuerySets within the <tt class="docutils literal"><span class="pre">Incident</span></tt> <tt class="docutils literal"><span class="pre">post_save</span></tt> signal handler:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">areas_of_interest</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">area_of_interest</span><span class="o">.</span><span class="n">geojson_feature</span> <span class="k">for</span> <span class="n">area_of_interest</span> <span class="ow">in</span> <span class="n">AreaOfInterest</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">polygon__contains</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s">'instance'</span><span class="p">]</span><span class="o">.</span><span class="n">location</span><span class="p">,</span>
        <span class="n">severity__in</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s">'instance'</span><span class="p">]</span><span class="o">.</span><span class="n">alert_severities</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="sending-notifications">
<h2>Sending notifications</h2>
<p>Once a notification has been constructed, we connect to a RabbitMQ broadcast queue (using <a class="reference external" href="http://kombu.readthedocs.org/en/latest/userguide/examples.html">Kombu</a>) and publish the notification:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">send_notification</span><span class="p">(</span><span class="n">notification</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">BrokerConnection</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">AMPQ_URL</span><span class="p">)</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">producers</span><span class="p">[</span><span class="n">connection</span><span class="p">]</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">producer</span><span class="p">:</span>
            <span class="n">maybe_declare</span><span class="p">(</span><span class="n">notifications_exchange</span><span class="p">,</span> <span class="n">producer</span><span class="o">.</span><span class="n">channel</span><span class="p">)</span>
            <span class="n">producer</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
                <span class="n">notification</span><span class="p">,</span>
                <span class="n">exchange</span><span class="o">=</span><span class="s">'notifications'</span><span class="p">,</span>
                <span class="n">routing_key</span><span class="o">=</span><span class="s">'notifications'</span>
            <span class="p">)</span>
</pre></div>
</div>
<p>When a user accesses the site’s home view, it connects to a socket.io namespace:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">kombu</span> <span class="kn">import</span> <span class="n">BrokerConnection</span>
<span class="kn">from</span> <span class="nn">kombu.mixins</span> <span class="kn">import</span> <span class="n">ConsumerMixin</span>
<span class="kn">from</span> <span class="nn">socketio.namespace</span> <span class="kn">import</span> <span class="n">BaseNamespace</span>
<span class="kn">from</span> <span class="nn">socketio.sdjango</span> <span class="kn">import</span> <span class="n">namespace</span>

<span class="kn">from</span> <span class="nn">.queues</span> <span class="kn">import</span> <span class="n">notifications_queue</span>


<span class="nd">@namespace</span><span class="p">(</span><span class="s">'/notifications'</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">NotificationsNamespace</span><span class="p">(</span><span class="n">BaseNamespace</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NotificationsNamespace</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_initial_acl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="s">'recv_connect'</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">recv_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lift_acl_restrictions</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dispatch</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">BrokerConnection</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">AMPQ_URL</span><span class="p">)</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="n">NotificationsConsumer</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ns_name</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>When a connection is established (and authentication is verified), a new greenlet is spawned, passing the control to a NotificationConsumer instance:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">NotificationsConsumer</span><span class="p">(</span><span class="n">ConsumerMixin</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">socket</span><span class="p">,</span> <span class="n">ns_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">socket</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ns_name</span> <span class="o">=</span> <span class="n">ns_name</span>

    <span class="k">def</span> <span class="nf">get_consumers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Consumer</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">Consumer</span><span class="p">(</span><span class="n">queues</span><span class="o">=</span><span class="p">[</span><span class="n">notifications_queue</span><span class="p">],</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">process_notification</span><span class="p">])]</span>

    <span class="k">def</span> <span class="nf">process_notification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">send_packet</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="s">'event'</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s">'notification'</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">body</span><span class="p">,),</span>
            <span class="n">endpoint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ns_name</span>
        <span class="p">))</span>
        <span class="n">message</span><span class="o">.</span><span class="n">ack</span><span class="p">()</span>
</pre></div>
</div>
<p>Each message sent to the broadcast queue is handled by the callback <tt class="docutils literal"><span class="pre">process_notification</span></tt> which send a new packet down the socket’s channel with the body of the notification object.</p>
<img alt="/static/media/uploads/home_screenshot.png" src="/static/media/uploads/home_screenshot.png"/>
<p>The image above is a screenshot of the site’s home page while an alert is being shown to the user. The client side of the communication is quite simple:</p>
<div class="highlight-python"><pre>var socket = io.connect(
    "/notifications",
    {
        "reconnectionDelay": 5000,
        "timeout": 10000,
        "resource": "socket.io"
    }
);

socket.on('connect', function(){
    console.log('connect', socket);
});</pre>
</div>
<p>The client connects to the socket, and hooks the appropriate callbacks. Socket.io hides away the complexities of choosing a transport layer and handling retries and reconnects. The notification callback handles most of the client’s logic.</p>
<div class="highlight-python"><pre>socket.on('notification', function(notification){
    console.log('notification', notification);

    if (notification.type === "post_save") {
        if (notification.created) {
            map.data.addGeoJson(notification.feature);
        } else {
            var feature = map.data.getFeatureById(notification.feature.id);
            map.data.remove(feature);

            if (! notification.feature.properties.closed) {
                map.data.addGeoJson(notification.feature);
            }
        }
    } else if (notification.type === "post_delete") {
        var feature = map.data.getFeatureById(notification.feature.id);
        map.data.remove(feature);
    } else if (notification.type === "alert") {
        showAlert(buildAlertModalBodyHtml(notification))
    } else {
        console.log(notification);
    }
});
socket.on('disconnect', function(){
    console.log('disconnect', socket);
});</pre>
</div>
<p>Upon receiving a notification we make use of Google Maps <a class="reference external" href="https://developers.google.com/maps/documentation/javascript/examples/layer-data-simple">Data Layer API</a> to draw onto the map. Notice that all we had to do is just given the GeoJSON representation of the objects (which is generated by GeoDjango) to the map, and the rest is take care for us.</p>
</div>
<div class="section" id="managing-events-and-areas-of-interest">
<h2>Managing events and areas of interest</h2>
<p>The site provides views to manage incidents and areas of interest that use Google Maps JavaScript API to manipulate the objects graphically within maps. <a class="reference external" href="http://geojson.org/">GeoJson</a> format is supported both by GeoDjango and Google Maps, so we use it as the exchange format in the forms.</p>
<img alt="/static/media/uploads/report_incident_screenshot.png" src="/static/media/uploads/report_incident_screenshot.png"/>
<p>We also provide a simple incident report view (depicted above) that uses the geolocator JavaScript library to detect the user’s location.</p>
</div>
<div class="section" id="conclusions">
<h2>Conclusions</h2>
<p>Although the exercise proved to be really interesting (specially the features related to the spatial features), we really didn’t find any significant advantages over our <a class="reference external" href="http://www.machinalis.com/blog/rt-django-notifications/">previous solution</a> based on Node.js. In fact, we had to tackle several complications related to the restrictions that gevent places on the packages that can or can’t be used. First of all, we had to make sure that the libraries that work on the greenlets were either gevent specific, or monkey patching compatible (kombu is). We also had problems running the site using <a class="reference external" href="http://gunicorn.org/">Gunicorn</a> so we had to switch to <a class="reference external" href="https://chaussette.readthedocs.org/en/1.2/">Chaussette</a>. There was also the matter of gevent-socketio only supporting version 0.9 of the socket.io protocol (hence the bower dependency that points to the 0.9 branch of the client repo).</p>
<p>We hope that you find the information presented in this post useful. As usual, feel free to leave comments or suggestions on how to improve the solution.</p>
</div>
<div class="section" id="acknowledgements">
<h2>Acknowledgements</h2>
<p>The bulk of the notifications architecture is based on the solution presented by Jeremy West on his blogpost <a class="reference external" href="http://www.pixeldonor.com/2014/jan/10/django-gevent-and-socketio/">Django, Gevent, and Socket.io</a>. His tutorial is a great way to understand how gevent-socketio works and how to integrate it into Django.</p>
</div>

</section>


</div></body></html>