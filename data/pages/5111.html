<html><body><div><div class="content html_format">
      <img src="https://habrastorage.org/files/3fb/01e/b53/3fb01eb53076423b9aa455f475e42920.png"/>
<em>От переводчика: в двух словах, в декабре 2015 выйдет релиз Python 2.7.11, ускоряющий работу интерпретатора CPython до 20%. Ниже перевод статьи с <a href="http://https:/lwn.net/">LWN.net</a>, рассказывающей о сути и процессе произошедших изменений в коде. Имена, в произношении которых я не уверен, даны в оригинальном написании. Об ошибках и неточностях перевода просьба, как обычно, сообщать в личные сообщения.</em>
<p>
Несмотря на то, что разработка Python 2 (а конкретно ветки Python 2.7.x) находится сейчас в состоянии «никаких новых фич», которое в обычной ситуации заранее ставит крест на любых крупных изменениях, команда разработки приняла решение рассмотреть и принять backport-патч из Python 3, привносящий заметное улучшение производительности интерпретатора.
</p><a name="habracut"/><p>
Vamsi Parasa из команды оптимизации серверных скриптовых языков Intel предложил патч (</p><a href="http://article.gmane.org/gmane.comp.python.devel/153401">описание предложения с бенчмарками</a><p>), переводящий блок </p><code>switch</code><p>, отвечающий за обработку Python-байткода, на использование </p><a href="https://gcc.gnu.org/onlinedocs/gcc/Labels-as-Values.html">computed goto</a><p>, как это уже сделано в Python 3. Как </p><a href="http://eli.thegreenplace.net/2012/07/12/computed-goto-for-efficient-dispatch-tables">объяснял</a><p> Eli Bendersky, в таком огромном </p><code>switch</code><p>-блоке, как в блоке разбора байткода в CPython (состоящем из более чем 2000(!) строк), это даёт ускорение порядка 15-20%. Это происходит по двум причинам: </p><code>computed goto</code><p>, в отличие от </p><code>switch-case</code><p>, не производит граничных проверок, необходимых для оператора </p><code>switch</code><p> по стандарту C99, и, что, возможно, более важно, CPU может лучше </p><a href="https://ru.wikipedia.org/wiki/Предсказатель_переходов">прогнозировать ветвления</a><p> в таких ситуациях, что приводит к уменьшению числа сбросов конвейера, являющихся по своей природе «дорогой» операцией.
</p><p>
Несмотря на то, что некоторые из разработчиков CPython были против внедрения этого патча, т.к. «</p><a href="https://lwn.net/Articles/647041/">улучшение производительности — это не багфикс</a><p>», решение было принято в пользу Intel.
</p><p>
Одной из немаловажных причин стал тот факт, что Intel сообщили о своей готовности в дальнейшем помогать с поддержкой и улучшением CPython при условии открытости ветки 2.7 для изменений, связанных с производительностью. В частности, это значит, что в то время, как разработчики Intel занимаются «скучными» частями (в основном, исправлением ошибок и ускорением ветки 2.7), разработчики-добровольцы из opensource-сообщества смогут уделять больше времени более интересным задачам:
</p><blockquote>«Делай крутые вещи бесплатно, найди способ получать деньги за выполнение скучных-но-необходимых задач (или оставь это тем, кому за это платят)» — хороший подход к opensource-разработке, в то время, как попытки сделать <em>всё</em> забесплатно — лёгкий путь к выгоранию.<br/>
© <a href="https://lwn.net/Articles/647050/">Nick Coghlan</a><br/>
</blockquote><p>
С этим </p><a href="https://lwn.net/Articles/647052/">согласен</a><p> и «великодушный пожизненный диктатор» ван Россум, в частности потому, что компании Dropbox, на которую он работает, это поможет сохранить «кучу денег». По его словам, в таких больших компаниях процесс перехода на Python 3 происходит достаточно медленно, в то время, как обновление до последней актуальной версии из ветки 2.7 — нормальное явление. С идеей же «</p><a href="https://lwn.net/Articles/647053/">сосредоточить усилия на Python 3, тем самым мотивируя сообщество скорее на него мигрировать</a><p>» Гвидо </p><a href="https://lwn.net/Articles/647055/">не согласен</a><p>.
</p><p>
Патч, ускоряющий работу интерпретатора Python 2.7, принят (</p><a href="https://github.com/python/cpython/commit/57d001f0aa7a9a914d0936b7be17545409f61dae">коммит</a><p>) и запланирован к выходу в составе релиза 2.7.11, в декабре 2015. Несмотря на то, что Python 3 представляет множество новых фич, таких как </p><a href="https://lwn.net/Articles/643786/">async/await</a><p>, </p><a href="https://lwn.net/Articles/640359/">указание типов</a><p> и многое другое, Python 2.7 всё ещё остаётся популярным (и в соответствии с текущими планами, поддерживается как минимум </p><a href="https://hg.python.org/peps/rev/76d43e52d978">до 2020 года</a><p>), так что эта новость должна обрадовать большое количество Python-разработчиков по всему миру.
      </p><p class="clear"/>
    </div>

    
  </div></body></html>