<html><body><div><div id="doc-page">
					

<h1>RapydScript</h1>
<p><a href="http://travis-ci.org/atsepkov/RapydScript"><img alt="Build Status" src="https://secure.travis-ci.org/atsepkov/RapydScript.png"/></a></p>
<h2>What is RapydScript?</h2>
<p>RapydScript (pronounced 'RapidScript') is a pre-compiler for JavaScript, similar to CoffeeScript, but with cleaner, more readable syntax. The syntax is very similar to Python, but allows JavaScript as well. This project was written as an alternative to Pyjamas for those wishing Python-like JavaScript without the extra overhead and complexity Pyjamas introduces.</p>
<p>RapydScript allows to write your front-end in Python without the overhead that other similar frameworks introduce (the performance is the same as with pure JavaScript). To those familiar with CoffeeScript, RapydScript is like CoffeeScript, but inspired by Python's readability rather than Ruby's cleverness. To those familiar with Pyjamas, RapydScript brings many of the same features and support for Python syntax without the same overhead. Don't worry if you've never used either of the above-mentioned compilers, if you've ever had to write your code in pure JavaScript you'll appreciate RapydScript. RapydScript combines the best features of Python as well as JavaScript, bringing you features most other Pythonic JavaScript replacements overlook. Here are a few features of RapydScript:</p>
<ul>
<li>classes that work and feel very similar to Python</li>
<li>pythonic import system (you can also use <code>require()</code>)</li>
<li>optional function arguments that work just like Python (<code>func(third='foo')</code>)</li>
<li>inheritance system that's both, more powerful than Python and cleaner than JavaScript (single inheritance w/ mixins);</li>
<li>support for object literals with anonymous functions, like in JavaScript</li>
<li>ability to invoke any JavaScript/DOM object/function/method as if it's part of the same framework, without the need for special syntax</li>
<li>variable and object scoping that make sense (no need for repetitive <code>var</code> or <code>new</code> keywords)</li>
<li>ability to use both, Python's methods/functions and JavaScript's alternatives</li>
<li>similar to above, ability to use both, Python's and JavaScript's tutorials (as well as widgets)</li>
<li>decorators, list comprehensions, dict comprehensions, verbose regex, starargs, kwargs, you name it</li>
<li>it's self-hosting, the compiler is itself written in RapydScript and compiles into JavaScript</li>
</ul>
<p>Let's not waste any more time with the introductions, however. The best way to learn a new language/framework is to dive in.</p>
<h2>Table of Contents</h2>
<p>&lt;!-- START doctoc generated TOC please keep comment here to allow auto update --&gt;
&lt;!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE --&gt;</p>

<p>&lt;!-- END doctoc generated TOC please keep comment here to allow auto update --&gt;</p>
<h2>Community</h2>
<p>If you have questions, bug reports, or feature requests, feel free to post them on our mailing list:<br/>
<a href="http://groups.google.com/group/rapydscript">http://groups.google.com/group/rapydscript</a></p>
<p>I bundled a few demos with RapydScript itself, but several members of the community put together much better demos. If you would like to take a look at them to see what's possible with RapydScript, here are some examples:</p>
<p><a href="http://salvatore.pythonanywhere.com/RapydScript">http://salvatore.pythonanywhere.com/RapydScript</a><br/>
This includes the demos from RapydScript's <code>examples</code> directory, as well as a few others.</p>
<p><a href="http://salvatore.pythonanywhere.com/RapydBox">http://salvatore.pythonanywhere.com/RapydBox</a><br/>
This is a collection of very cool demos, showcasing RapydScript's similarity to real Python and at the same time its ability to work with other JavaScript. It relies on a JavaScript port of NodeBox (which was originally written in Python). NodeBox was ported from Python to JavaScript to allow cross-platform compatibility. Ironically, the original demos from Python version of NodeBox now work with JavaScript version of NodeBox with few changes (and sometimes none at all) by using RapydScript.</p>
<p><a href="http://salvatore.pythonanywhere.com/RapydGlow">http://salvatore.pythonanywhere.com/RapydGlow</a><br/>
RapydScript making use of GlowScript, another project done by a member of our community</p>
<p><a href="https://github.com/atsepkov/puzzles/tree/master/project-euler">https://github.com/atsepkov/puzzles/tree/master/project-euler</a><br/>
My solutions to Project Euler challenges in RapydScript. For those unfamiliar with projecteuler.net, it's a collection of mathematical puzzles for developers testing their ability to come up with clever/efficient algorithms as well as brevity/elegance of their chosen language. While Python and Ruby are popular choices, barely any solutions are in JavaScript (probably due to the language's arcane syntax and error handling and very limited utility for mathematical challenges out of the box). RapydScript, however, does quite well - sometimes allowing for identical solution as Python, sometimes a more clever one. Execution speed is typically faster than Python, but in some cases lags behind (i.e. when Python version uses sets or optimized numpy logic).</p>
<h2>Installation</h2>
<p>First make sure you have installed the latest version of <a href="http://nodejs.org/">node.js</a> (You may need to restart your computer after this step). </p>
<p>From NPM for use as a command line app:</p>
<div class="codehilite"><pre><span class="n">npm</span> <span class="n">install</span> <span class="n">rapydscript</span> <span class="o">-</span><span class="n">g</span>
</pre></div>


<p>From NPM for programmatic use:</p>



<p>From Git:</p>
<div class="codehilite"><pre><span class="n">git</span> <span class="n">clone</span> <span class="n">git</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">atsepkov</span><span class="o">/</span><span class="n">RapydScript</span><span class="p">.</span><span class="n">git</span>
<span class="n">cd</span> <span class="n">RapydScript</span>
<span class="n">npm</span> <span class="n">link</span> <span class="p">.</span>
</pre></div>


<p>If you're using OSX, you can probably use the same commands (let me know if that's not the case). If you're using Windows, you should be able to follow similar commands after installing node.js and git on your system.</p>
<h2>Compilation</h2>
<p>Once you have installed RapydScript, compiling your application is as simple as running the following command:</p>
<div class="codehilite"><pre><span class="n">rapydscript</span> <span class="o">&lt;</span><span class="n">location</span> <span class="n">of</span> <span class="n">main</span> <span class="n">file</span><span class="o">&gt;</span> <span class="p">[</span><span class="n">options</span><span class="p">]</span>
</pre></div>


<p>By default this will dump the output to STDOUT, but you can specify the output file using <code>--output</code> option. The generated file can then be referenced in your html page the same way as you would with a typical JavaScript file. If you're only using RapydScript for classes and functions, then you're all set. If you're using additional Python methods, such as <code>range()</code>, <code>print()</code>, <code>list.append()</code>, <code>list.remove()</code>, then you will want to link RapydScript's stdlib.js in your html page as well. There are two ways of doing this, one is to include it as a JavaScript file in your HTML, the other is to include it as an <code>import</code> in your source code and let RapydScript pull it in automatically.</p>
<p>RapydScript can take multiple input files. It's recommended that you pass the input files first, then pass the options. RapydScript will parse input files in sequence and apply any compression options. The files are parsed in the same global scope, that is, a reference from a file to some variable/function declared in another file will be matched properly.</p>
<p>If you want to read from STDIN instead, pass a single dash instead of input
files.</p>
<p>The available options are:</p>
<div class="codehilite"><pre><span class="o">-</span><span class="n">o</span><span class="p">,</span> <span class="o">--</span><span class="n">output</span>       <span class="n">Output</span> <span class="n">file</span> <span class="p">(</span><span class="n">default</span> <span class="n">STDOUT</span><span class="p">).</span>
<span class="o">-</span><span class="n">x</span><span class="p">,</span> <span class="o">--</span><span class="n">execute</span>      <span class="n">Execute</span> <span class="n">the</span> <span class="n">file</span> <span class="n">in</span><span class="o">-</span><span class="n">place</span> <span class="p">(</span><span class="n">no</span> <span class="n">compiled</span> <span class="n">output</span> <span class="n">generated</span><span class="p">)</span>
<span class="o">-</span><span class="n">b</span><span class="p">,</span> <span class="o">--</span><span class="n">bare</span>         <span class="n">Omit</span> <span class="n">scope</span><span class="o">-</span><span class="n">protection</span> <span class="n">wrapper</span> <span class="n">around</span> <span class="n">generated</span> <span class="n">code</span>
<span class="o">-</span><span class="n">p</span><span class="p">,</span> <span class="o">--</span><span class="n">prettify</span>     <span class="n">Beautify</span> <span class="n">output</span><span class="o">/</span><span class="n">specify</span> <span class="n">output</span> <span class="n">options</span><span class="p">.</span>
<span class="o">-</span><span class="n">V</span><span class="p">,</span> <span class="o">--</span><span class="n">version</span>      <span class="n">Print</span> <span class="n">version</span> <span class="n">number</span> <span class="n">and</span> <span class="n">exit</span><span class="p">.</span>
<span class="o">-</span><span class="n">t</span><span class="p">,</span> <span class="o">--</span><span class="n">test</span>         <span class="n">Run</span> <span class="n">unit</span> <span class="n">tests</span><span class="p">,</span> <span class="n">making</span> <span class="n">sure</span> <span class="n">the</span> <span class="n">compiler</span> <span class="n">produces</span> <span class="n">usable</span> <span class="n">code</span>
<span class="o">-</span>6<span class="p">,</span> <span class="o">--</span><span class="n">es6</span>          <span class="n">Build</span> <span class="n">code</span> <span class="k">for</span> <span class="n">ES6</span><span class="p">,</span> <span class="n">cleaner</span> <span class="n">output</span> <span class="n">with</span> <span class="n">support</span> <span class="k">for</span> <span class="n">more</span> <span class="n">features</span> <span class="p">(</span><span class="n">EXPERIMENTAL</span><span class="p">)</span>
<span class="o">-</span><span class="n">m</span><span class="p">,</span> <span class="o">--</span><span class="n">omit</span><span class="o">-</span><span class="n">baselib</span> <span class="n">Omit</span> <span class="n">base</span> <span class="n">library</span> <span class="n">from</span> <span class="n">generated</span> <span class="n">code</span><span class="p">,</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">you</span><span class="o">'</span><span class="n">re</span> <span class="n">including</span> <span class="n">baselib</span><span class="p">.</span><span class="n">js</span> <span class="k">if</span> <span class="n">you</span> <span class="n">use</span> <span class="n">this</span>
<span class="o">-</span><span class="nb">i</span><span class="p">,</span> <span class="o">--</span><span class="n">auto</span><span class="o">-</span><span class="n">bind</span>    <span class="n">Automatically</span> <span class="n">bind</span> <span class="k">methods</span> <span class="n">to</span> <span class="n">the</span> <span class="n">class</span> <span class="n">they</span> <span class="n">belong</span> <span class="n">to</span> <span class="p">(</span><span class="n">more</span> <span class="n">Pythonic</span><span class="p">,</span> <span class="n">but</span> <span class="n">could</span> <span class="n">interfere</span> <span class="n">with</span> <span class="n">other</span> <span class="n">JS</span> <span class="n">libs</span><span class="p">)</span>
<span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="o">--</span><span class="n">help</span>         <span class="n">Print</span> <span class="n">usage</span> <span class="n">and</span> <span class="n">more</span> <span class="n">information</span> <span class="n">on</span> <span class="n">each</span> <span class="n">of</span> <span class="n">these</span> <span class="n">options</span>
    <span class="o">--</span><span class="n">self</span>         <span class="n">Compile</span> <span class="n">the</span> <span class="n">compiler</span> <span class="n">itself</span>
    <span class="o">--</span><span class="n">stats</span>        <span class="n">Show</span> <span class="n">compilation</span> <span class="n">metrics</span> <span class="n">in</span> <span class="n">STDERR</span> <span class="p">(</span><span class="n">time</span> <span class="n">to</span> <span class="n">parse</span><span class="p">,</span> <span class="n">generate</span> <span class="n">code</span><span class="p">,</span> <span class="n">etc</span><span class="p">.)</span>
<span class="o">-</span><span class="n">l</span><span class="p">,</span> <span class="o">--</span><span class="n">lint</span>         <span class="n">Check</span> <span class="n">file</span> <span class="k">for</span> <span class="n">errors</span> <span class="n">and</span> <span class="n">compilation</span> <span class="n">problems</span>
</pre></div>


<p>The rest of the option remain from UglifyJS and have not been tested, some may work, but most will not, since the AST is different between RapydScript and UglifyJS. These option  will eventually be removed or modified to be relevant to RapydScript.</p>
<h2>Getting Started</h2>
<p>As you read the following sections, I suggest you start a RapydScript shell (by typing <code>rapydscript</code> without arguments) and follow along. You'll be able to see both, the generated JavaScript, and the output produced by the given RapydScript command.</p>
<p>Like JavaScript, RapydScript can be used to create anything from a quick function to a complex web-app. RapydScript can access anything regular JavaScript can, in the same manner. Let's say we want to write a function that greets us with a "Hello World" pop-up. The following code will do it:</p>
<div class="codehilite"><pre><span class="n">def</span> <span class="n">greet</span><span class="p">():</span>
    <span class="n">alert</span><span class="p">(</span>"<span class="n">Hello</span> <span class="n">World</span>!"<span class="p">)</span>
</pre></div>


<p>Once compiled, the above code will turn into the following JavaScript:</p>
<div class="codehilite"><pre><span class="k">function</span><span class="w"> </span><span class="nf">greet</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
    <span class="n">alert</span><span class="p">(</span>"<span class="n">Hello</span> <span class="n">World</span>!"<span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>Now you can reference this function from other JavaScript or the page itself (using "onclick", for example). For our next example, let's say you want a function that computes factorial of a number:</p>
<div class="codehilite"><pre><span class="n">def</span> <span class="nb">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> 0<span class="p">:</span>
        <span class="k">return</span> 1
    <span class="k">return</span> <span class="n">n</span> <span class="o">*</span> <span class="nb">factorial</span><span class="p">(</span><span class="n">n</span><span class="o">-</span>1<span class="p">)</span>
</pre></div>


<p>Now all we need is to tie it into our page so that it's interactive. Let's add an input field to the page body and a cell for displaying the factorial of the number in the input once the input loses focus.</p>
<div class="codehilite"><pre><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"user-input"</span> <span class="na">onblur=</span><span class="s">"computeFactorial()"</span><span class="nt">&gt;&lt;/input&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"result"</span><span class="nt">&gt;&lt;/div&gt;</span>
</pre></div>


<p><strong>NOTE:</strong> To complement RapydScript, I have also written RapydML (<a href="http://bitbucket.org/pyjeon/rapydml">http://bitbucket.org/pyjeon/rapydml</a>), which is a pre-compiler for HTML (just like RapydScript is a pre-compiler for JavaScript). </p>
<p>Now let's implement computeFactorial() function in RapydScript:</p>
<div class="codehilite"><pre><span class="n">def</span> <span class="n">computeFactorial</span><span class="p">():</span>
    <span class="n">n</span> <span class="p">=</span> <span class="n">document</span><span class="p">.</span><span class="n">getElementById</span><span class="p">(</span>"<span class="n">user</span><span class="o">-</span><span class="n">input</span>"<span class="p">).</span><span class="n">value</span>
    <span class="n">document</span><span class="p">.</span><span class="n">getElementById</span><span class="p">(</span>"<span class="n">result</span>"<span class="p">).</span><span class="n">innerHTML</span> <span class="p">=</span> <span class="nb">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</pre></div>


<p>Again, notice that we have access to everything JavaScript has access to, including direct DOM manipulation. Once compiled, this function will look like this:</p>
<div class="codehilite"><pre><span class="k">function</span><span class="w"> </span><span class="nf">computeFactorial</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
    <span class="n">var</span> <span class="n">n</span><span class="p">;</span>
    <span class="n">n</span> <span class="p">=</span> <span class="n">document</span><span class="p">.</span><span class="n">getElementById</span><span class="p">(</span>"<span class="n">user</span><span class="o">-</span><span class="n">input</span>"<span class="p">).</span><span class="n">value</span><span class="p">;</span>
    <span class="n">document</span><span class="p">.</span><span class="n">getElementById</span><span class="p">(</span>"<span class="n">result</span>"<span class="p">).</span><span class="n">innerHTML</span> <span class="p">=</span> <span class="nb">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>Notice that RapydScript automatically declares variables in local scope when you try to assign to them. This not only makes your code shorter, but saves you from making common JavaScript mistake of overwriting a global. For more information on controlling variable scope, see <code>Scope Control</code> section.</p>
<h2>Leveraging other APIs</h2>
<p>Aside from Python-like stdlib, RapydScript does not have any of its own APIs. Nor does it need to, there are already good options available that we can leverage instead. If we wanted, for example, to rewrite the above factorial logic using jQuery, we could easily do so:</p>
<div class="codehilite"><pre><span class="n">def</span> <span class="n">computeFactorial</span><span class="p">():</span>
    <span class="n">n</span> <span class="p">=</span> $<span class="p">(</span>"#<span class="n">user</span><span class="o">-</span><span class="n">input</span>"<span class="p">).</span><span class="n">val</span><span class="p">()</span>
    $<span class="p">(</span>"#<span class="n">result</span>"<span class="p">).</span><span class="n">text</span><span class="p">(</span><span class="nb">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
</pre></div>


<p>Many of these external APIs, however, take object literals as input. Like with JavaScript, you can easily create those with RapydScript, the same way you would create one in JavaScript, or a dictionary in Python:</p>
<div class="codehilite"><pre><span class="n">styles</span> <span class="p">=</span> <span class="p">{</span>
    <span class="s">'background-color'</span><span class="p">:</span> <span class="s">'#ffe'</span><span class="p">,</span>
    <span class="s">'border-left'</span><span class="p">:</span>      <span class="s">'5px solid #ccc'</span><span class="p">,</span>
    <span class="s">'width'</span><span class="p">:</span>            50<span class="p">,</span>
<span class="p">}</span>
</pre></div>


<p>Now you can pass it to jQuery:</p>
<div class="codehilite"><pre>$<span class="p">(</span><span class="s">'#element'</span><span class="p">).</span><span class="n">css</span><span class="p">(</span><span class="n">styles</span><span class="p">)</span>
</pre></div>


<p>Another feature of RapydScript is ability to have functions as part of your object literal. JavaScript APIs often take callback/handler functions as part of their input parameters, and RapydScript lets you create such object literal without any quirks/hacks:</p>
<div class="codehilite"><pre><span class="n">params</span> <span class="p">=</span> <span class="p">{</span>
    <span class="n">width</span><span class="p">:</span>  50<span class="p">,</span>
    <span class="n">height</span><span class="p">:</span> 30<span class="p">,</span>
    <span class="n">onclick</span><span class="p">:</span>    <span class="n">def</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">alert</span><span class="p">(</span>"<span class="n">you</span> <span class="n">clicked</span> <span class="n">me</span>"<span class="p">),</span>
    <span class="n">onmouseover</span><span class="p">:</span>    <span class="n">def</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        $<span class="p">(</span><span class="n">this</span><span class="p">).</span><span class="n">css</span><span class="p">(</span><span class="s">'background'</span><span class="p">,</span> <span class="s">'red'</span><span class="p">)</span>
    <span class="p">,</span>
    <span class="n">onmouseout</span><span class="p">:</span> <span class="n">def</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        # <span class="n">reset</span> <span class="n">the</span> <span class="n">background</span>
        $<span class="p">(</span><span class="n">this</span><span class="p">).</span><span class="n">css</span><span class="p">(</span><span class="s">'background'</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>


<p>Note the comma on a new line following a function declaration, it needs to be there to let the compiler know there are more attributes in this object literal, yet it can't go on the same line as the function since it would get parsed as part of the function block. Like Python, however, RapydScript supports new-line shorthand using a <code>;</code>, which you could use to place the comma on the same line:</p>
<div class="codehilite"><pre><span class="n">hash</span> <span class="p">=</span> <span class="p">{</span>
    <span class="s">'foo'</span><span class="p">:</span>  <span class="n">def</span><span class="p">():</span>
        <span class="n">print</span><span class="p">(</span><span class="s">'foo'</span><span class="p">);,</span>
    <span class="s">'bar'</span><span class="p">:</span>  <span class="n">def</span><span class="p">():</span>
        <span class="n">print</span><span class="p">(</span><span class="s">'bar'</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>


<p>It is because of easy integration with JavaScript's native libraries that RapydScript keeps its own libraries to a minimum. For example, it does not implement string interpolation, like native Python. However, by using <code>sprintf.js</code> library (<a href="https://github.com/alexei/sprintf.js">https://github.com/alexei/sprintf.js</a>) you can reproduce the same behavior in RapydScript:</p>
<div class="codehilite"><pre><span class="n">string</span> <span class="p">=</span> <span class="n">vsprintf</span><span class="p">(</span><span class="s">'%d bottles of %s on the wall'</span><span class="p">,</span> <span class="p">(</span>99<span class="p">,</span> <span class="s">'beer'</span><span class="p">))</span>
</pre></div>


<p>Take a look at the <code>examples</code> directory to see RapydScript integration with <code>jQuery</code>, <code>jQuery-UI</code>, <code>D3</code>, and <code>Google Charts</code>.</p>
<h2>Anonymous Functions</h2>
<p>Like JavaScript, RapydScript allows the use of anonymous functions. In fact, you've already seen the use of anonymous functions in previous section when creating an object literal ('onmouseover' and 'onmouseout' assignments). This is similar to Python's lambda function, except that the syntax isn't awkward like lambda, and the function isn't limited to one line. The following two function declarations are equivalent:</p>
<div class="codehilite"><pre><span class="n">def</span> <span class="nb">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> 0<span class="p">:</span>
        <span class="k">return</span> 1
    <span class="k">return</span> <span class="n">n</span> <span class="o">*</span> <span class="nb">factorial</span><span class="p">(</span><span class="n">n</span><span class="o">-</span>1<span class="p">)</span>

<span class="nb">factorial</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> 0<span class="p">:</span>
        <span class="k">return</span> 1
    <span class="k">return</span> <span class="n">n</span> <span class="o">*</span> <span class="nb">factorial</span><span class="p">(</span><span class="n">n</span><span class="o">-</span>1<span class="p">)</span>
</pre></div>


<p>This might not seem like much at first, but if you're familiar with JavaScript, you know that this can be extermely useful to the programmer, especially when dealing with nested functions, which are a bit syntactically awkward in Python (it's not immediatelly obvious that those can be copied and assigned to other objects). To illustrate the usefulness, let's create a method that creates and returns an element that changes color while the user keeps the mouse pressed on it.</p>
<div class="codehilite"><pre>def makeDivThatTurnsGreen():
    div = $('<span class="nt">&lt;div&gt;&lt;/div&gt;</span>')
    turnGreen = def(event):
        div.css('background', 'green')
    div.mousedown(turnGreen)
    resetColor = def(event):
        div.css('background', '')
    div.mouseup(resetColor)
    return div
</pre></div>


<p>At first glance, anonymous functions might not seem that useful. We could have easily created nested functions and assigned them instead. By using anonymous functions, however, we can quickly identify that these functions will be bound to a different object. They belong to the div, not the main function that created them, nor the logic that invoked it. The best use case for these is creating an element inside another function/object without getting confused which object the function belongs to.</p>
<p>Additionally, as you already noticed in the previous section, anonymous functions can be used to avoid creating excessive temporary variables and make your code cleaner:</p>
<div class="codehilite"><pre><span class="n">math_ops</span> <span class="p">=</span> <span class="p">{</span>
    <span class="n">add</span><span class="p">:</span>    <span class="n">def</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span> <span class="k">return</span> <span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">;,</span>
    <span class="n">sub</span><span class="p">:</span>    <span class="n">def</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span> <span class="k">return</span> <span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="p">;,</span>
    <span class="n">mul</span><span class="p">:</span>    <span class="n">def</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span> <span class="k">return</span> <span class="n">a</span><span class="o">*</span><span class="n">b</span><span class="p">;,</span>
    <span class="n">div</span><span class="p">:</span>    <span class="n">def</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span> <span class="k">return</span> <span class="n">a</span><span class="o">/</span><span class="n">b</span><span class="p">;,</span>
    <span class="n">roots</span><span class="p">:</span>  <span class="n">def</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="n">r</span> <span class="p">=</span> <span class="n">Math</span><span class="p">.</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="n">b</span> <span class="o">-</span> 4<span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">c</span><span class="p">)</span>
        <span class="n">d</span> <span class="p">=</span> 2<span class="o">*</span><span class="n">a</span>
        <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">+</span> <span class="n">r</span><span class="p">)</span><span class="o">/</span><span class="n">d</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span><span class="o">/</span><span class="n">d</span>
<span class="p">}</span>
</pre></div>


<p>I'm sure you will agree that the above code is cleaner than declaring 5 temporary variables first and assigning them to the object literal keys after. Note that the example puts the function header (def()) and content on the same line. I'll refer to it as function inlining. This is meant as a feature of RapydScript to make the code cleaner in cases like the example above. While you can use it in longer functions by chaining statements together using <code>;</code>, a good rule of thumb (to keep your code clean) is if your function needs semi-colons ask yourself whether you should be inlining, and if it needs more than 2 semi-colons, the answer is probably no (note that you can also use semi-colons as newline separators within functions that aren't inlined, as in the example in the previous section).</p>
<h2>Decorators</h2>
<p>Like Python, RapydScript supports function decorators. While decorator arguments are not supported, the basic decorators work exactly the same way as in Python:</p>
<div class="codehilite"><pre>def makebold(fn):
    def wrapped():
        return "<span class="nt">&lt;b&gt;</span>" + fn() + "<span class="nt">&lt;/b&gt;</span>"
    return wrapped

def makeitalic(fn):
    def wrapped():
        return "<span class="nt">&lt;i&gt;</span>" + fn() + "<span class="nt">&lt;/i&gt;</span>"
    return wrapped

@makebold
@makeitalic
def hello():
    return "hello world"

hello() # returns "<span class="nt">&lt;b&gt;&lt;i&gt;</span>hello world<span class="nt">&lt;/i&gt;&lt;/b&gt;</span>"
</pre></div>


<h2>Self-Executing Functions</h2>
<p>RapydScript wouldn't be useful if it required work-arounds for things that JavaScript handled easily. If you've worked with JavaScript or jQuery before, you've probably seen the following syntax:</p>
<div class="codehilite"><pre><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">args</span><span class="p">){</span>
    <span class="o">//</span> <span class="n">some</span> <span class="n">logic</span> <span class="n">here</span>
<span class="p">})(</span><span class="n">args</span><span class="p">)</span>
</pre></div>


<p>This code calls the function immediately after declaring it instead of assigning it to a variable. Python doesn't have any way of doing this. The closest work-around is this:</p>
<div class="codehilite"><pre><span class="n">def</span> <span class="n">tmp</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    # <span class="n">some</span> <span class="n">logic</span> <span class="n">here</span>
<span class="n">tmp</span><span class="p">.</span><span class="n">__call__</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</pre></div>


<p>While it's not horrible, it did litter our namespace with a temporary variable. If we have to do this repeatedly, this pattern does get annoying. This is where RapydScript decided to be a little unorthodox and implement the JavaScript-like solution:</p>
<div class="codehilite"><pre><span class="p">(</span><span class="n">def</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    # <span class="n">some</span> <span class="n">logic</span> <span class="n">here</span>
<span class="p">)()</span>
</pre></div>


<p>A close cousin of the above is the following code (passing current scope to the function being called):</p>
<div class="codehilite"><pre><span class="k">function</span><span class="err">(){</span>
    <span class="o">//</span> <span class="n">some</span> <span class="n">logic</span> <span class="n">here</span>
<span class="p">}.</span><span class="n">call</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
</pre></div>


<p>With RapydScript equivalent of:</p>
<div class="codehilite"><pre><span class="n">def</span><span class="p">():</span>
    # <span class="n">some</span> <span class="n">logic</span> <span class="n">here</span>
<span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="n">this</span><span class="p">)</span>
</pre></div>


<p>There is also a third alternative, that will pass the arguments as an array:</p>
<div class="codehilite"><pre><span class="n">def</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    # <span class="n">some</span> <span class="n">logic</span> <span class="n">here</span>
<span class="p">.</span><span class="n">apply</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>
</pre></div>


<h2>Chaining Blocks</h2>
<p>As seen in previous section, RapydScript will bind any lines beginning with <code>.</code> to the outside of the block with the matching indentation. This logic isn't limited to the <code>.call()</code> method, you can use it with <code>.apply()</code> or any other method/property the function has assigned to it. This can be used for jQuery as well:</p>
<div class="codehilite"><pre>$<span class="p">(</span><span class="n">element</span><span class="p">)</span>
<span class="p">.</span><span class="n">css</span><span class="p">(</span><span class="s">'background-color'</span><span class="p">,</span> <span class="s">'red'</span><span class="p">)</span>
<span class="p">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>


<p>The only limitation is that the indentation has to match, if you prefer to indent your chained calls, you can still do so by using the <code>\</code> delimiter:</p>
<div class="codehilite"><pre>$<span class="p">(</span><span class="n">element</span><span class="p">)</span><span class="o">\</span>
    <span class="p">.</span><span class="n">css</span><span class="p">(</span><span class="s">'background-color'</span><span class="p">,</span> <span class="s">'red'</span><span class="p">)</span><span class="o">\</span>
    <span class="p">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>


<p>RapydScript also allows an alternative syntax for the same feature, for those preferring Python's traditional, hanging-indent look:</p>
<div class="codehilite"><pre><span class="n">def</span><span class="p">(</span><span class="n">one</span><span class="p">,</span> <span class="n">two</span><span class="p">)</span> <span class="n">and</span> <span class="n">call</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> 1<span class="p">,</span> 2<span class="p">):</span>
    <span class="p">...</span>
</pre></div>


<p>Which is equivalent to the following:</p>
<div class="codehilite"><pre><span class="n">def</span><span class="p">(</span><span class="n">one</span><span class="p">,</span> <span class="n">two</span><span class="p">):</span>
    <span class="p">...</span>
<span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> 1<span class="p">,</span> 2<span class="p">)</span>
</pre></div>


<p>Some of you might welcome this feature, some of you might not. RapydScript always aims to make its unique features unobtrusive to regular Python, which means that you don't have to use them if you disagree with them. Recently, we have enhanced this feature to handle <code>do/while</code> loops as well:</p>
<div class="codehilite"><pre><span class="n">a</span> <span class="p">=</span> 0
<span class="n">do</span><span class="p">:</span>
    <span class="n">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">+</span><span class="p">=</span> 1
<span class="p">.</span><span class="k">while</span> <span class="n">a</span> <span class="o">&lt;</span> 1
</pre></div>


<p>In my opinion, this is something even Python could benefit from. Like with functions, you could use the hanging-indent form as well:</p>
<div class="codehilite"><pre><span class="n">a</span> <span class="p">=</span> 0
<span class="n">do</span> <span class="n">and</span> <span class="k">while</span> <span class="n">a</span> <span class="o">&lt;</span> 1<span class="p">:</span>
    <span class="n">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">+</span><span class="p">=</span> 1
</pre></div>


<h2>Function calling with optional arguments</h2>
<p>RapydScript supports the same function calling format as Python. You can have named optional arguments, create functions with variable numbers of arguments and variable numbers of named arguments. Some examples will illustrate this best:</p>
<div class="codehilite"><pre><span class="n">def</span> <span class="n">foo</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">=</span>2<span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]</span>
<span class="n">foo</span><span class="p">(</span>1<span class="p">)</span> <span class="o">==</span> <span class="n">foo</span><span class="p">(</span>1<span class="p">,</span> 2<span class="p">)</span> <span class="o">==</span> <span class="p">[</span>1<span class="p">,</span> 2<span class="p">]</span>

<span class="n">def</span> <span class="n">bar</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span>
<span class="n">bar</span><span class="p">(</span>3<span class="p">,</span> 2<span class="p">,</span> 1<span class="p">)</span> <span class="o">==</span> <span class="n">bar</span><span class="p">(</span><span class="n">c</span><span class="p">=</span>1<span class="p">,</span> <span class="n">b</span><span class="p">=</span>2<span class="p">,</span> <span class="n">a</span><span class="p">=</span>3<span class="p">)</span> <span class="o">==</span> <span class="p">[</span>3<span class="p">,</span> 2<span class="p">,</span> 1<span class="p">]</span>

<span class="n">def</span> <span class="n">baz</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">args</span><span class="p">]</span>
<span class="n">baz</span><span class="p">(</span>1<span class="p">,</span> 2<span class="p">,</span> 3<span class="p">)</span> <span class="o">==</span> <span class="p">[</span>1<span class="p">,</span> <span class="p">[</span>2<span class="p">,</span> 3<span class="p">]]</span>

<span class="n">def</span> <span class="n">qux</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">=</span>2<span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">]</span>
<span class="n">qux</span><span class="p">(</span>1<span class="p">,</span> <span class="n">b</span><span class="p">=</span>3<span class="p">,</span> <span class="n">c</span><span class="p">=</span>4<span class="p">)</span> <span class="o">==</span> <span class="p">[</span>1<span class="p">,</span> 3<span class="p">,</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span>4<span class="p">}]</span>
</pre></div>


<p>RapydScript is not as strict as Python when it comes to validating function arguments. This is both for performance and to make it easier to interoperate with other JavaScript libraries. So if you do not pass enough arguments when calling a function, the
extra arguments will be set to undefined instead of raising a TypeError, as would be the case in Python. Similarly, when mixing <code>**kwargs</code> and optional arguments, RapydScript will not complain if an optional argument is specified twice, it will use the one specified in kwargs.</p>
<p>RapydScript will also create a separate object for an optional argument each time the function is called. This makes it slightly less efficient, but prevents the common bug in python caused by using a mutable object literal as the default value for an optional argument.</p>
<h2>Inferred Tuple Packing/Unpacking</h2>
<p>Like Python, RapydScript allows inferred tuple packing/unpacking and assignment. While inferred/implicit logic is usually bad, it can sometimes make the code cleaner, and based on the order of statements in the Zen of Python, 'beautiful' takes priority over 'explicit'. For example, if you wanted to swap two variables, the following looks cleaner than explicitly declaring a temporary variable:</p>



<p>Likewise, if a function returns multiple variables, it's cleaner to say:</p>



<p>rather than:</p>
<div class="codehilite"><pre><span class="n">tmp</span> <span class="p">=</span> <span class="n">fun</span><span class="p">()</span>
<span class="n">a</span> <span class="p">=</span> <span class="n">tmp</span><span class="p">[</span>0<span class="p">]</span>
<span class="n">b</span> <span class="p">=</span> <span class="n">tmp</span><span class="p">[</span>1<span class="p">]</span>
<span class="n">c</span> <span class="p">=</span> <span class="n">tmp</span><span class="p">[</span>2<span class="p">]</span>
</pre></div>


<p>Since JavaScript doesn't have tuples, RapydScript uses arrays for tuple packing/unpacking behind the scenes, but the functionality stays the same. Note that unpacking only occurs when you're assigning to multiple arguments:</p>
<div class="codehilite"><pre><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="p">=</span> <span class="n">fun</span><span class="p">()</span>     # <span class="n">gets</span> <span class="n">unpacked</span>
<span class="n">tmp</span> <span class="p">=</span> <span class="n">fun</span><span class="p">()</span>         # <span class="n">no</span> <span class="n">unpacking</span><span class="p">,</span> <span class="n">tmp</span> <span class="n">will</span> <span class="n">store</span> <span class="n">an</span> <span class="n">array</span> <span class="n">of</span> <span class="nb">length</span> 3
</pre></div>


<p>Unpacking can also be done in <code>for</code> loops (which you can read about in later section):</p>
<div class="codehilite"><pre><span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span> <span class="n">in</span> <span class="n">enumerate</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
    <span class="n">print</span><span class="p">(</span><span class="n">index</span><span class="o">+</span><span class="s">': '</span><span class="o">+</span><span class="n">value</span><span class="p">)</span>
</pre></div>


<p>Tuple packing is the reverse operation, and is done to the variables being assigned, rather than the ones being assigned to. This can occur during assignment or function return:</p>
<div class="codehilite"><pre><span class="n">def</span> <span class="n">fun</span><span class="p">():</span>
    <span class="k">return</span> 1<span class="p">,</span> 2<span class="p">,</span> 3
</pre></div>


<p>To summarize packing and unpacking, it's basically just syntax sugar to remove obvious assignment logic that would just litter the code. For example, the swap operation shown in the beginning of this section is equivalent to the following code:</p>
<div class="codehilite"><pre><span class="n">tmp</span> <span class="p">=</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">]</span>
<span class="n">a</span> <span class="p">=</span> <span class="n">tmp</span><span class="p">[</span>0<span class="p">]</span>
<span class="n">b</span> <span class="p">=</span> <span class="n">tmp</span><span class="p">[</span>1<span class="p">]</span>
</pre></div>


<h2>Python vs JavaScript</h2>
<p>RapydScript allows you to use both, Python and JavaScript names for the methods. For example, we can 'push()' a value to array, as well as 'append()' it:</p>
<div class="codehilite"><pre><span class="n">arr</span> <span class="p">=</span> <span class="p">[]</span>
<span class="n">arr</span><span class="p">.</span><span class="n">push</span><span class="p">(</span>2<span class="p">)</span>
<span class="n">arr</span><span class="p">.</span><span class="n">append</span><span class="p">(</span>4<span class="p">)</span>
<span class="n">print</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> # <span class="n">outputs</span> <span class="p">[</span>2<span class="p">,</span>4<span class="p">]</span>
</pre></div>


<p>In order to use Python's methods, you will have to include RapydScript's stdlib.js. There are two ways of doing this. One is by adding the following line in your html page:</p>
<div class="codehilite"><pre><span class="nt">&lt;script</span> <span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">src=</span><span class="s">'stdlib.js'</span><span class="nt">&gt;&lt;/script&gt;</span>
</pre></div>


<p>The other way is to include the following line at the top of your main RapydScript file:</p>



<p>The advantage of the second method is that the library will automatically be pulled in without having to manually copy it over into your JavaScript directory. The first include method, however, might be useful when you have multiple independently compiled RapydScript programs on your page and don't want the overhead of the same stdlib included in each one.</p>
<p>In order to simulate Python-like methods, I had to bastardize a couple of JavaScript's own methods. For example, array.pop() has been overwritten to work like Python's pop() (or JavaScript's splice()):</p>
<div class="codehilite"><pre><span class="n">arr</span><span class="p">.</span><span class="n">pop</span><span class="p">()</span>       # <span class="n">removes</span> <span class="n">last</span> <span class="n">element</span> <span class="p">(</span><span class="n">expected</span> <span class="n">behavior</span> <span class="n">in</span> <span class="n">JavaScript</span> <span class="n">and</span> <span class="n">Python</span><span class="p">)</span>
<span class="n">arr</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span>2<span class="p">)</span>      # <span class="n">removes</span> <span class="n">third</span> <span class="n">element</span> <span class="p">(</span><span class="n">expected</span> <span class="n">behavior</span> <span class="n">in</span> <span class="n">Python</span><span class="p">,</span> <span class="n">but</span> <span class="n">not</span> <span class="n">JavaScript</span><span class="p">)</span>
<span class="n">arr</span><span class="p">.</span><span class="n">splice</span><span class="p">(</span>2<span class="p">,</span>1<span class="p">)</span> # <span class="n">removes</span> <span class="n">third</span> <span class="n">element</span> <span class="p">(</span><span class="n">expected</span> <span class="n">behavior</span> <span class="n">in</span> <span class="n">JavaScript</span><span class="p">,</span> <span class="n">but</span> <span class="n">not</span> <span class="n">Python</span><span class="p">)</span>
</pre></div>


<p>There is a subtle difference between the last 2 lines above, arr.pop(2) will return a single element, arr.splice(2,1) will return an array containing that single element. Most of the keywords are interchangeable as well:</p>
<div class="codehilite"><pre><span class="n">RapydScript</span>     <span class="n">JavaScript</span>

<span class="n">None</span><span class="o">/</span><span class="n">null</span>       <span class="n">null</span>
<span class="n">False</span><span class="o">/</span><span class="n">false</span>     <span class="n">false</span>
<span class="n">True</span><span class="o">/</span><span class="n">true</span>       <span class="n">true</span>
<span class="n">undefined</span>       <span class="n">undefined</span>
<span class="n">this</span>            <span class="n">this</span>
<span class="n">NaN</span>             <span class="n">NaN</span>
<span class="n">Infinity</span>        <span class="n">Infinity</span>
</pre></div>


<p>The basic operators like <code>+, +=, -, -=, /, /=, *, *=</code> work the same way in both languages as well. The JavaScript operators, however, are not supported. You will have to use Python versions of those. If you're unfamiliar with them, here is the mapping RapydScript uses:</p>
<div class="codehilite"><pre><span class="n">RapydScript</span>     <span class="n">JavaScript</span>

<span class="o">==</span>              <span class="o">==</span><span class="p">=</span>
<span class="sx">!=              !==</span>
<span class="n">and</span>             <span class="o">&amp;&amp;</span>
<span class="n">or</span>              <span class="o">||</span>
<span class="n">not</span>             !
<span class="n">is</span>              <span class="o">==</span><span class="p">=</span>
<span class="n">is</span> <span class="n">not</span>          !<span class="o">==</span>
<span class="o">+</span><span class="p">=</span>1             <span class="o">++</span>
<span class="o">-</span><span class="p">=</span>1             <span class="o">--</span>
<span class="o">**</span>              <span class="n">Math</span><span class="p">.</span><span class="n">pow</span><span class="p">()</span>
<span class="o">//</span>              <span class="nb">floor</span> <span class="n">division</span>
</pre></div>


<p>Admittedly, <code>is</code> is not exactly the same thing in Python as <code>===</code> in JavaScript, but JavaScript is quirky when it comes to comparing objects anyway.</p>
<p>You may also be interested in <code>eq</code> function, which is part of RapydScript. It performs deep equality test on two objects, and works on any types, including hashes and arrays:</p>
<div class="codehilite"><pre><span class="n">eq</span><span class="p">([</span>1<span class="p">,</span>2<span class="p">,</span>3<span class="p">],</span> <span class="p">[</span>1<span class="p">,[</span>2<span class="p">,</span>3<span class="p">]])</span>      # <span class="n">False</span>
<span class="n">eq</span><span class="p">([[</span>1<span class="p">,</span>2<span class="p">],</span>3<span class="p">],</span> <span class="p">[</span>1<span class="p">,[</span>2<span class="p">,</span>3<span class="p">]])</span>    # <span class="n">False</span>
<span class="n">eq</span><span class="p">([</span>1<span class="p">,[</span>2<span class="p">,</span>3<span class="p">]],</span> <span class="p">[</span>1<span class="p">,[</span>2<span class="p">,</span>3<span class="p">]])</span>    # <span class="n">True</span>
</pre></div>


<p>In rare cases RapydScript might not allow you to do what you need to, and you need access to pure JavaScript. When that's the case, you can wrap your JavaScript in a string, passing it to JS() method. Code inside JS() method is not a sandbox, you can still interact with it from normal RapydScript:</p>
<div class="codehilite"><pre><span class="n">JS</span><span class="p">(</span><span class="s">'a = {foo: "bar", baz: 1};'</span><span class="p">)</span>
<span class="n">print</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">foo</span><span class="p">)</span>    # <span class="n">prints</span> "<span class="n">bar</span>"
</pre></div>


<p>One last thing to note is the difference between <code>print()</code> and <code>console.log</code>, <code>print()</code> is part of RapydScript's stdlib, and is designed to work similar to Python's print statement, <code>console.log()</code> is JavaScript's version of debug output, which is more powerful but also more tedious when you just want a quick output. Here are some examples:</p>
<div class="codehilite"><pre><span class="n">arr</span> <span class="p">=</span> <span class="p">[</span>1<span class="p">,</span>2<span class="p">,</span>3<span class="p">,</span>4<span class="p">]</span>
<span class="n">print</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>          # <span class="p">[</span>1<span class="p">,</span>2<span class="p">,</span>3<span class="p">,</span>4<span class="p">]</span>
<span class="n">console</span><span class="p">.</span><span class="nb">log</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>    # <span class="p">[</span>1<span class="p">,</span>2<span class="p">,</span>3<span class="p">,</span>4<span class="p">]</span>

<span class="n">arr2</span> <span class="p">=</span> <span class="p">[[</span>1<span class="p">,</span>2<span class="p">],[</span>3<span class="p">,</span>4<span class="p">]]</span>
<span class="n">print</span><span class="p">(</span><span class="n">arr2</span><span class="p">)</span>         # <span class="p">[[</span>1<span class="p">,</span>2<span class="p">],[</span>3<span class="p">,</span>4<span class="p">]]</span>
<span class="n">console</span><span class="p">.</span><span class="nb">log</span><span class="p">(</span><span class="n">arr2</span><span class="p">)</span>   # <span class="p">[</span><span class="n">Array</span><span class="p">[</span>2<span class="p">],</span> <span class="n">Array</span><span class="p">[</span>2<span class="p">]]</span>

<span class="n">hash</span> <span class="p">=</span> <span class="p">{</span><span class="s">'dogs'</span><span class="p">:</span> 1<span class="p">,</span> <span class="s">'cats'</span><span class="p">:</span> 2<span class="p">}</span>
<span class="n">print</span><span class="p">(</span><span class="n">hash</span><span class="p">)</span>         # <span class="p">{</span>"<span class="n">dogs</span>"<span class="p">:</span>1<span class="p">,</span>"<span class="n">cats</span>"<span class="p">:</span>2<span class="p">}</span>
<span class="n">console</span><span class="p">.</span><span class="nb">log</span><span class="p">(</span><span class="n">hash</span><span class="p">)</span>   # <span class="n">Object</span>
</pre></div>


<p>One other topic I debated for a while is handling of conditionals. In Python, if you wanted a one-liner conditional that gets assigned to a variable, you would write something like this:</p>



<p>In JavaScript, the equivalent logic would be written as follows:</p>



<p>Which one looks cleaner is subject to personal preference (I'm used to seeing condition first in most of the <code>if</code> statements, so the second way makes more sense to me). But where the second approach wins is when dealing with anonymous functions. Indeed, Python doesn't have to handle them, yet RapydScript does. As a result, I decided to go with JavaScript's approach here. This also allows me to assign functions here, same way as JavaScript would:</p>
<div class="codehilite"><pre><span class="n">foo</span> <span class="p">=</span> <span class="n">baz</span> ? <span class="n">def</span><span class="p">():</span> <span class="k">return</span> <span class="n">bar</span><span class="p">;</span> <span class="p">:</span> <span class="n">def</span><span class="p">():</span> <span class="k">return</span> 10
</pre></div>


<h2>Loops</h2>
<p>RapydScript loops work like Python, not JavaScript. You can't, for example, use 'for(i=0;i&lt;max;i++)' syntax. You can, however, loop through arrays using 'for ... in' syntax without worrying about the extra irrelevant attributes regular JavaScript returns.</p>
<div class="codehilite"><pre><span class="n">animals</span> <span class="p">=</span> <span class="p">[</span><span class="s">'cat'</span><span class="p">,</span> <span class="s">'dog'</span><span class="p">,</span> <span class="s">'mouse'</span><span class="p">,</span> <span class="s">'horse'</span><span class="p">]</span>
<span class="k">for</span> <span class="n">animal</span> <span class="n">in</span> <span class="n">animals</span><span class="p">:</span>
    <span class="n">print</span><span class="p">(</span><span class="s">'I have a '</span><span class="o">+</span><span class="n">animal</span><span class="p">)</span>
</pre></div>


<p>If you need to use the index in the loop as well, you can do so by using enumerate():</p>
<div class="codehilite"><pre><span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">animal</span> <span class="n">in</span> <span class="n">enumerate</span><span class="p">(</span><span class="n">animals</span><span class="p">):</span>
    <span class="n">print</span><span class="p">(</span>"<span class="n">index</span><span class="p">:</span>"<span class="o">+</span><span class="n">index</span><span class="p">,</span> "<span class="n">animal</span><span class="p">:</span>"<span class="o">+</span><span class="n">animal</span><span class="p">)</span>
</pre></div>


<p>Like in Python, if you just want the index, you can use range:</p>
<div class="codehilite"><pre><span class="k">for</span> <span class="n">index</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="n">len</span><span class="p">(</span><span class="n">animals</span><span class="p">)):</span>           # <span class="n">or</span> <span class="n">range</span><span class="p">(</span><span class="n">animals</span><span class="p">.</span><span class="nb">length</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span>"<span class="n">animal</span> "<span class="o">+</span><span class="n">index</span><span class="o">+</span>" <span class="n">is</span> <span class="n">a</span> "<span class="o">+</span><span class="n">animals</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
</pre></div>


<p>When possible, RapydScript will automatically optimize the loop for you into JavaScript basic syntax, so you're not missing much by not being able to call it directly. However, if for some reason you really need to, you always can:</p>
<div class="codehilite"><pre><span class="k">for</span> <span class="n">JS</span><span class="p">(</span><span class="s">'i = 0; i &lt; 50; i++'</span><span class="p">):</span>
    <span class="n">print</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span>
</pre></div>


<h2>Dict and List Comprehensions</h2>
<p>RapydScript also supports list comprehensions, using Python syntax. Instead of the following, for example:</p>
<div class="codehilite"><pre><span class="n">myArray</span> <span class="p">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">index</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span>1<span class="p">,</span>20<span class="p">):</span>
    <span class="k">if</span> <span class="n">index</span><span class="o">*</span><span class="n">index</span> <span class="c">% 3 == 0:</span>
        <span class="n">myArray</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="o">*</span><span class="n">index</span><span class="p">)</span>
</pre></div>


<p>You could write this:</p>
<div class="codehilite"><pre><span class="n">myArray</span> <span class="p">=</span> <span class="p">[</span><span class="nb">i</span><span class="o">*</span><span class="nb">i</span> <span class="k">for</span> <span class="nb">i</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span>1<span class="p">,</span>20<span class="p">)</span> <span class="k">if</span> <span class="nb">i</span><span class="o">*</span><span class="nb">i</span><span class="c">%3 == 0]</span>
</pre></div>


<p>Dict comprehensions are also supported:</p>
<div class="codehilite"><pre><span class="n">alphabet</span> <span class="p">=</span> <span class="p">{</span><span class="n">String</span><span class="p">.</span><span class="n">charFromCode</span><span class="p">(</span>64<span class="o">+</span><span class="n">n</span><span class="p">):</span> <span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="n">in</span> <span class="p">[</span>1 <span class="n">to</span> 26<span class="p">]}</span>
</pre></div>


<h2>Inclusive/Exclusive Sequences</h2>
<p>Like Python, RapydScript has a range() function. While powerful, the result it generates isn't immediately obvious when looking at the code. It's a minor pet peeve, but the couple extra seconds trying to visually parse it and remember that it's not inclusive can detract from the code flow. To remedy this, RapydScript borrows <code>to/til</code> operators from LiveScript (also known as human-readable versions of Ruby's <code>../...</code>). The following 4 lines of code are equivalent, for example:</p>
<div class="codehilite"><pre><span class="n">a</span> <span class="p">=</span> <span class="p">[</span>3 <span class="n">to</span> 8<span class="p">]</span>
<span class="n">a</span> <span class="p">=</span> <span class="p">[</span>3 <span class="n">til</span> 9<span class="p">]</span>
<span class="n">a</span> <span class="p">=</span> <span class="n">range</span><span class="p">(</span>3<span class="p">,</span> 9<span class="p">)</span>
<span class="n">a</span> <span class="p">=</span> <span class="p">[</span>3<span class="p">,</span> 4<span class="p">,</span> 5<span class="p">,</span> 6<span class="p">,</span> 7<span class="p">,</span> 8<span class="p">]</span>
</pre></div>


<p>You can also use sequences within loops:</p>
<div class="codehilite"><pre><span class="k">for</span> <span class="nb">i</span> <span class="n">in</span> <span class="p">[</span>1 <span class="n">to</span> 5<span class="p">]:</span>
    <span class="n">print</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span>
</pre></div>


<p>Or in list comprehensions:</p>
<div class="codehilite"><pre><span class="p">[</span><span class="nb">i</span><span class="o">*</span><span class="nb">i</span> <span class="k">for</span> <span class="nb">i</span> <span class="n">in</span> <span class="p">[</span>1 <span class="n">to</span> 6<span class="p">]</span> <span class="k">if</span> <span class="nb">i</span><span class="c">%2 == 0]</span>
</pre></div>


<p>The <code>to/til</code> statement gets converted to range() at compile time, and therefore can support variables or even expressions for start and end of the range:</p>
<div class="codehilite"><pre><span class="n">num</span> <span class="p">=</span> 5
<span class="n">rng</span> <span class="p">=</span> <span class="p">[</span><span class="n">num</span> <span class="n">to</span> <span class="n">num</span> <span class="o">*</span> 2<span class="p">]</span>
</pre></div>


<p>The <code>to/til</code> operators bind less tightly than arithmetic operators, so parentheses are optional.</p>
<h2>Classes</h2>
<p>This is where RapydScript really starts to shine. JavaScript is known for having really crappy class implementation (it's basically a hack on top of a normal function, most experienced users suggest using external libraries for creating those instead of creating them in pure JavaScript). Luckily RapydScript fixes that. Let's imagine we want a special text field that takes in a user color string and changes color based on it. Let's create such field via a class.</p>
<div class="codehilite"><pre>class ColorfulTextField:
    def __init__(self):
        field = $('<span class="nt">&lt;input&gt;&lt;/input&gt;</span>')
        changeColor = def(event):
            field.css('backround', field.val())
        field.keydown(changeColor)
        self.widget = field
</pre></div>


<p>This class abuses DOM's tolerant behavior, where it will default to the original setting when the passed-in color is invalid (saving us the extra error-checking logic). To append this field to our page we can run the following code:</p>
<div class="codehilite"><pre><span class="n">textfield</span> <span class="p">=</span> <span class="n">ColorfulTextField</span><span class="p">()</span>
$<span class="p">(</span><span class="s">'body'</span><span class="p">).</span><span class="n">append</span><span class="p">(</span><span class="n">textfield</span><span class="p">.</span><span class="n">widget</span><span class="p">)</span>
</pre></div>


<p>If you're used to JavaScript, the code above probably set off a few red flags in your head. In pure JavaScript, you can't create an object without using a 'new' operator. Don't worry, the above code will compile to the following:</p>
<div class="codehilite"><pre><span class="n">var</span> <span class="n">textfield</span><span class="p">;</span>
<span class="n">textfield</span> <span class="p">=</span> <span class="n">new</span> <span class="n">ColorfulTextField</span><span class="p">()</span>
$<span class="p">(</span><span class="s">'body'</span><span class="p">).</span><span class="n">append</span><span class="p">(</span><span class="n">textfield</span><span class="p">.</span><span class="n">widget</span><span class="p">);</span>
</pre></div>


<p>RapydScript will automatically handle appending the 'new' keyword for you, assuming you used 'class' to create the class for your object. This also holds when creating an object inside a list or returning it as well. You could easily do the following, for example:</p>
<div class="codehilite"><pre><span class="n">fields</span> <span class="p">=</span> <span class="p">[</span><span class="n">ColorfulTextField</span><span class="p">(),</span> <span class="n">ColorfulTextField</span><span class="p">(),</span> <span class="n">ColorfulTextField</span><span class="p">()]</span>
</pre></div>


<p>This is very useful for avoiding a common JavaScript error of creating 'undefined' objects by forgetting this keyword. One other point to note here is that regular DOM/JavaScript objects are also covered by this. So if you want to create a DOM image element, you should not use the 'new' keyword either:</p>



<p>But RapydScript's capability doesn't end here. Like Python, RapydScript allows inheritance. Let's say, for example, we want a new field, which works similar to the one above. But in addition to changing color of the field, it allows us to change the color of a different item, with ID of 'target' after we press the 'apply' button, located right next to it. Not a problem, let's implement this guy:</p>
<div class="codehilite"><pre>class TextFieldAffectingOthers(ColorfulTextField):
    def __init__(self):
        ColorfulTextField.__init__(self)
        field = self.widget
        submit = $('<span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"button"</span><span class="nt">&gt;</span>apply<span class="nt">&lt;/button&gt;</span>')
        applyColor = def(event):
            $('#target').css('background', field.val())
        submit.click(applyColor)
        self.widget = $('<span class="nt">&lt;div&gt;&lt;/div&gt;</span>')\
            .append(field)\
            .append(submit)
</pre></div>


<p>A couple things to note here. We can invoke methods from the parent class the same way we would in Python, by using <code>Parent.method(self, ...)</code> syntax. This allows us to control when and how (assuming it requires additional arguments) the parent method gets executed. Also note the use of <code>\</code> operator to break up a line. This is something Python allows for keeping each line short and legible. Likewise, RapydScript, being indentation-based, allows the same.</p>
<p>An important distinction between Python and RapydScript is that RapydScript does not allow multiple inheritance. This might seem like a big deal at first, but in actuality it barely matters. When using multiple inheritance, we usually only care about a few methods from the alternative classes. Leveraging JavaScript prototypical inheritance, RapydScript allows us to reuse methods from another class without even inheriting from it:</p>
<div class="codehilite"><pre><span class="n">class</span> <span class="n">Something</span><span class="p">(</span><span class="n">Parent</span><span class="p">):</span>
    <span class="n">def</span> <span class="n">method</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
        <span class="n">Parent</span><span class="p">.</span><span class="n">method</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
        <span class="n">SomethingElse</span><span class="p">.</span><span class="n">method</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
        <span class="n">SomethingElse</span><span class="p">.</span><span class="n">anotherMethod</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
</pre></div>


<p>Notice that <code>Something</code> class has no <code>__init__</code> method. Like in Python, this method is optional for classes. If you omit it, an empty constructor will automatically get created for you by RapydScript (or when inheriting, the parent's constructor will be used). Also notice that we never inherited from SomethingElse class, yet we can invoke its methods. This brings us to the next point, the only real advantage of inheriting from another class (which you can't gain by calling the other classes method as shown above) is that the omitted methods are automatically copied from the parent. Admittedly, we might also care about <code>isinstance()</code> method, to have it work with the non-main parent, which is equivalent to JavaScript's <code>instanceof</code> operator.</p>
<p><strong>NOTE:</strong> If you compile your code without <code>--screw-ie8</code> flag, the constructor will be executed every time you create a subclass of the given class. In most cases this will not hurt you, but in some cases you could see odd side-effects. For example, having a <code>print()</code> statement in the parent constructor will cause its contents to be output for every subclass, even if you do not explicitly create an instance. <code>--screw-ie8</code> option fixes this issue, at the expense of compatibility with Internet Explorer 6-8.</p>
<p>There is also a convenience function in RapydScript called <code>mixin</code> that lets you assign all methods of a given class to another, like Python's multiple inheritance:</p>
<div class="codehilite"><pre><span class="n">mixin</span><span class="p">(</span><span class="n">Snake</span><span class="p">,</span> <span class="n">Animal</span><span class="p">,</span> <span class="n">false</span><span class="p">)</span>     # <span class="n">add</span> <span class="n">Animal</span><span class="o">'</span><span class="n">s</span> <span class="k">methods</span> <span class="n">to</span> <span class="n">Snake</span><span class="p">,</span> <span class="n">don</span><span class="o">'</span><span class="n">t</span> <span class="n">overwrite</span> <span class="nb">ones</span> <span class="n">already</span> <span class="n">declared</span> <span class="n">in</span> <span class="n">Snake</span>
<span class="n">mixin</span><span class="p">(</span><span class="n">Snake</span><span class="p">,</span> <span class="n">Animal</span><span class="p">,</span> <span class="n">true</span><span class="p">)</span>      # <span class="n">add</span> <span class="n">Animal</span><span class="o">'</span><span class="n">s</span> <span class="k">methods</span> <span class="n">to</span> <span class="n">Snake</span><span class="p">,</span> <span class="n">overwriting</span> <span class="nb">ones</span> <span class="n">already</span> <span class="n">declared</span> <span class="n">in</span> <span class="n">Snake</span>
</pre></div>


<p>To summarize classes, assume they work the same way as in Python, plus a few bonus cases. The following, for example, are equivalent:</p>
<div class="codehilite"><pre><span class="n">class</span> <span class="n">Aclass</span><span class="p">:</span>
    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">pass</span>

    <span class="n">def</span> <span class="n">method</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">doSomething</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>

<span class="n">class</span> <span class="n">Aclass</span><span class="p">:</span>
    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">method</span> <span class="p">=</span> <span class="n">def</span><span class="p">():</span>
            <span class="n">doSomething</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
</pre></div>


<p>The variable <code>self</code> in the above example is not a keyword. Like in Python, it can be replaced with any other variable name. Also, like in Python, this variable will be tied to the class, unlike <code>this</code> keyword of JavaScript. RapydScript still treats <code>this</code> keyword the same way JavaScript does:</p>
<div class="codehilite"><pre><span class="n">class</span> <span class="n">Main</span><span class="p">:</span>
    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="n">main</span> <span class="p">=</span> <span class="n">this</span>
        <span class="n">method</span> <span class="p">=</span> <span class="n">def</span><span class="p">():</span>
            <span class="n">main</span><span class="p">.</span><span class="n">doSomething</span><span class="p">()</span>
        $<span class="p">(</span><span class="s">'#element'</span><span class="p">).</span><span class="n">click</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">doSomething</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="p">...</span>
</pre></div>


<p>Or, leveraging Pythonic binding to first argument, the same can be shortened to:</p>
<div class="codehilite"><pre><span class="n">class</span> <span class="n">Main</span><span class="p">:</span>
    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="n">method</span> <span class="p">=</span> <span class="n">def</span><span class="p">():</span>
            <span class="n">s</span><span class="p">.</span><span class="n">doSomething</span><span class="p">()</span>
        $<span class="p">(</span><span class="s">'#element'</span><span class="p">).</span><span class="n">click</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">doSomething</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="p">...</span>
</pre></div>


<p>Like Python, RapydScript allows static methods. Marking the method static with <code>@staticmethod</code> decorator will compile that method such that it's not bound to the object instance, and ensure all calls to this method compile into static method calls:</p>
<div class="codehilite"><pre><span class="n">class</span> <span class="n">Test</span><span class="p">:</span>
    <span class="n">def</span> <span class="n">normalMethod</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> 1

    <span class="p">@</span><span class="n">staticmethod</span>
    <span class="n">def</span> <span class="n">staticMethod</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">+</span>1
</pre></div>


<p>Some methods in the native JavaScript classes, such as <code>String.fromCharCode()</code> have also been marked as static to make things easier for the developer.</p>
<h3>External Classes</h3>
<p>RapydScript will automatically detect classes declared within the same scope (as long as the declaration occurs before use), as well as classes properly imported into the module (each module making use of a certain class should explicitly import the module containing that class). RapydScript will also properly detect native JavaScript classes (String, Array, Date, etc.). Unfortunately, RapydScript has no way of detecting classes from third-party libraries. In those cases, you could use the <code>new</code> keyword every time you create an object from such class. Alternatively, you could mark the class as external.</p>
<p>Marking a class as external is done via <code>external</code> decorator. You do not need to fill in the contents of the class, a simple <code>pass</code> statement will do:</p>
<div class="codehilite"><pre><span class="p">@</span><span class="n">external</span>
<span class="n">class</span> <span class="n">Alpha</span><span class="p">:</span>
    <span class="n">pass</span>
</pre></div>


<p>RapydScript will now treat <code>Alpha</code> as if it was declared within the same scope, auto-prepending the <code>new</code> keyword when needed and using <code>prototype</code> to access its methods (see <code>casperjs</code> example in next section to see how this can be used in practice). You don't need to pre-declare the methods of this class (unless you decide to for personal reference, the compiler will simply ignore them) unless you want to mark certain methods as static:</p>
<div class="codehilite"><pre><span class="p">@</span><span class="n">external</span>
<span class="n">class</span> <span class="n">Alpha</span><span class="p">:</span>
    <span class="p">@</span><span class="n">staticmethod</span>
    <span class="n">def</span> <span class="n">one</span><span class="p">():</span>
        <span class="n">pass</span>
</pre></div>


<p><code>Alpha.one</code> is now a static method, every other method invoked on <code>Alpha</code> will still be treated as a regular class method. While not mandatory, you could pre-declare other methods you plan to use from <code>Alpha</code> class as well, to make your code easier to read for other developers, in which case this <code>external</code> declaration would also serve as a table of contents for <code>Alpha</code>:</p>
<div class="codehilite"><pre><span class="p">@</span><span class="n">external</span>
<span class="n">class</span> <span class="n">Alpha</span><span class="p">:</span>
    <span class="n">def</span> <span class="n">two</span><span class="p">():</span> <span class="n">pass</span>
    <span class="n">def</span> <span class="n">three</span><span class="p">():</span> <span class="n">pass</span>

    <span class="p">@</span><span class="n">staticmethod</span>
    <span class="n">def</span> <span class="n">one</span><span class="p">():</span> <span class="n">pass</span>
</pre></div>


<p>As mentioned earlier, this is simply for making your code easier to read. The compiler itself will ignore all method declarations except ones marked with <code>staticmethod</code> decorator.</p>
<p>You could also use <code>external</code> decorator to bypass improperly imported RapydScript modules. However, if you actually have control of these modules, the better solution would be to fix those imports.</p>
<h3>Method Binding</h3>
<p>By default, RapydScript does not bind methods to the classes they're declared under. This behavior is unlike Python, but very much like the rest of JavaScript. For example, consider this code:</p>
<div class="codehilite"><pre><span class="n">class</span> <span class="n">Boy</span><span class="p">:</span>
    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="p">=</span> <span class="n">name</span>

    <span class="n">def</span> <span class="n">greet</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">print</span><span class="p">(</span><span class="s">'My name is'</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>

<span class="n">tod</span> <span class="p">=</span> <span class="n">Boy</span><span class="p">(</span><span class="s">'Tod'</span><span class="p">)</span>
<span class="n">tod</span><span class="p">.</span><span class="n">greet</span><span class="p">()</span>                 # <span class="n">Hello</span><span class="p">,</span> <span class="n">my</span> <span class="n">name</span> <span class="n">is</span> <span class="n">Tod</span>
<span class="n">getattr</span><span class="p">(</span><span class="n">tod</span><span class="p">,</span> <span class="s">'greet'</span><span class="p">)()</span>     # <span class="n">Hello</span><span class="p">,</span> <span class="n">my</span> <span class="n">name</span> <span class="n">is</span> <span class="n">undefined</span>
</pre></div>


<p>In some cases, however, you may wish for the functions to remain bound to the object they were retrieved from. For those cases, RapydScript has <code>bind</code> function. Unlike regular JavaScript <code>Function.prototype.bind</code>, RapydScript's <code>bind</code> can rebind methods that have already been bound. The binding we wanted to see in the above example can be achieved as follows:</p>
<div class="codehilite"><pre><span class="n">bound</span> <span class="p">=</span> <span class="n">bind</span><span class="p">(</span><span class="n">getattr</span><span class="p">(</span><span class="n">tod</span><span class="p">,</span> <span class="s">'greet'</span><span class="p">),</span> <span class="n">tod</span><span class="p">)</span>
<span class="n">bound</span><span class="p">()</span>                     # <span class="n">Hello</span><span class="p">,</span> <span class="n">my</span> <span class="n">name</span> <span class="n">is</span> <span class="n">Tod</span>
</pre></div>


<p>To unbind a bound method, you can call pass <code>false</code> as a second argument instead of an object you wish to bind to. You can also auto-bind all methods of the class by calling <code>rebind_all</code>:</p>
<div class="codehilite"><pre><span class="n">class</span> <span class="n">Boy</span><span class="p">:</span>
    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="p">=</span> <span class="n">name</span>
        <span class="n">rebind_all</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">greet</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">print</span><span class="p">(</span><span class="s">'My name is'</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>

<span class="n">tod</span> <span class="p">=</span> <span class="n">Boy</span><span class="p">(</span><span class="s">'Tod'</span><span class="p">)</span>
<span class="n">tod</span><span class="p">.</span><span class="n">greet</span><span class="p">()</span>                 # <span class="n">Hello</span><span class="p">,</span> <span class="n">my</span> <span class="n">name</span> <span class="n">is</span> <span class="n">Tod</span>
<span class="n">getattr</span><span class="p">(</span><span class="n">tod</span><span class="p">,</span> <span class="s">'greet'</span><span class="p">)()</span>     # <span class="n">Hello</span><span class="p">,</span> <span class="n">my</span> <span class="n">name</span> <span class="n">is</span> <span class="n">Tod</span>
</pre></div>


<p>Likewise, <code>rebind_all(self, false)</code> will unbind all methods. It's not recommended to auto-bind classes that inherit from 3rd party libraries. For example, <code>casperjs</code> has <code>Casper</code> class, which RapydScript can easily inherit and extend:</p>
<div class="codehilite"><pre><span class="p">@</span><span class="n">external</span>
<span class="n">class</span> <span class="n">Casper</span><span class="p">:</span>
    <span class="n">pass</span>

<span class="n">class</span> <span class="n">Scraper</span><span class="p">(</span><span class="n">Casper</span><span class="p">):</span>
    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">Casper</span><span class="p">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>

<span class="n">s</span> <span class="p">=</span> <span class="n">Scraper</span><span class="p">()</span>
<span class="n">s</span><span class="p">.</span><span class="n">thenOpen</span><span class="p">(</span><span class="s">'http://casperjs.org'</span><span class="p">,</span>
    <span class="n">def</span><span class="p">():</span> <span class="n">this</span><span class="p">.</span><span class="n">echo</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">getTitle</span><span class="p">())</span>
<span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>


<p>Including <code>rebind_all</code> call in the constructor, however, will break <code>Casper</code>. It is for that reason that <code>rebind_all</code> isn't added to the constructor by default by RapydScript. You could, however use <code>--auto-bind</code> compile flag to have RapydScript rebind automatically for you. There is a bit more that this flag does behind the scenes, which ensures that class binding behaves identical to Python, at the expense of some performance and compatibility with libraries like <code>casperjs</code>.</p>
<h2>Modules</h2>
<p>RapydScript's module system works almost exactly like Python's. Modules are
files ending with the suffix <code>.pyj</code> and packages are directories containing
an <code>__init__.pyj</code> file. The only caveat is that star imports are not
currently supported (this is by design, star imports are easily abused).</p>
<p>Also, currently, aliasing with <code>as</code> is not supported, this is on my TODO list.</p>
<h2>Exception Handling</h2>
<p>Like Python and JavaScript, RapydScript has exception handling logic. The following, for example, will warn the user if variable <code>foo</code> is not defined:</p>
<div class="codehilite"><pre><span class="k">try</span><span class="o">:</span>
    <span class="n">print</span><span class="o">(</span><span class="n">foo</span><span class="o">)</span>
<span class="n">except</span><span class="o">:</span>
    <span class="n">print</span><span class="o">(</span><span class="s2">"Foo wasn't declared yet"</span><span class="o">)</span>
</pre></div>


<p>It's a good practice, however, to only catch exceptions we expect. Imagine, for example, if <code>foo</code> was defined, but as a circular structure (with one of its attributes referencing itself):</p>



<p>We would still trigger an exception, but for a completely different reason. A better way to rewrite our <code>try/except</code> block would be:</p>
<div class="codehilite"><pre><span class="k">try</span><span class="o">:</span>
    <span class="n">print</span><span class="o">(</span><span class="n">foo</span><span class="o">)</span>
<span class="n">except</span> <span class="n">ReferenceError</span><span class="o">:</span>
    <span class="n">print</span><span class="o">(</span><span class="s2">"Foo wasn't declared yet"</span><span class="o">)</span>
</pre></div>


<p>We could also handle circular structure exception, if we needed to:</p>
<div class="codehilite"><pre><span class="k">try</span><span class="o">:</span>
    <span class="n">print</span><span class="o">(</span><span class="n">foo</span><span class="o">)</span>
<span class="n">except</span> <span class="n">ReferenceError</span><span class="o">:</span>
    <span class="n">print</span><span class="o">(</span><span class="s2">"Foo wasn't declared yet"</span><span class="o">)</span>
<span class="n">except</span> <span class="n">TypeError</span><span class="o">:</span>
    <span class="n">print</span><span class="o">(</span><span class="s2">"One of foo's attributes references foo"</span><span class="o">)</span>
</pre></div>


<p>Or we could just dump the error back to the user:</p>
<div class="codehilite"><pre><span class="k">try</span><span class="o">:</span>
    <span class="n">print</span><span class="o">(</span><span class="n">foo</span><span class="o">)</span>
<span class="n">except</span> <span class="k">as</span> <span class="n">err</span><span class="o">:</span>
    <span class="n">print</span><span class="o">(</span><span class="n">err</span><span class="o">.</span><span class="na">name</span> <span class="o">+</span> <span class="s1">':'</span> <span class="o">+</span> <span class="n">err</span><span class="o">.</span><span class="na">message</span><span class="o">)</span>
</pre></div>


<p>In this example, <code>err</code> is a JavaScript error object, it has <code>name</code> and <code>message</code> attributes, more information can be found at <a href="https://developer.mozilla.org/en-US/docs/JavaScript/Reference/Global_Objects/Error">https://developer.mozilla.org/en-US/docs/JavaScript/Reference/Global_Objects/Error</a>. You can inherit from this object as if it was a class to create custom errors, just like you would in Python:       </p>
<div class="codehilite"><pre><span class="n">class</span> <span class="n">MyError</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="p">=</span> <span class="n">Error</span>
        <span class="n">self</span><span class="p">.</span><span class="n">message</span> <span class="p">=</span> <span class="n">message</span>

<span class="n">raise</span> <span class="n">MyError</span><span class="p">(</span><span class="s">'This is a custom error!'</span><span class="p">)</span>
</pre></div>


<p>You can lump multiple errors in the same except block as well:</p>
<div class="codehilite"><pre><span class="k">try</span><span class="o">:</span>
    <span class="n">print</span><span class="o">(</span><span class="n">foo</span><span class="o">)</span>
<span class="n">except</span> <span class="n">ReferenceError</span><span class="o">,</span> <span class="n">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="o">:</span>
    <span class="n">print</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">name</span> <span class="o">+</span> <span class="s1">':'</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">message</span><span class="o">)</span>
</pre></div>


<p>Basically, <code>try/except/finally</code> in RapydScript works very similar to the way it does in Python 3, lacking only the <code>else</code> directive (it didn't seem useful enough to implement). Like in Python and JavaScript, you can nest multiple exceptions inside each other, and use <code>raise</code> to throw the error back at the user:</p>
<div class="codehilite"><pre><span class="k">try</span><span class="o">:</span>
    <span class="n">print</span><span class="o">(</span><span class="n">foo</span><span class="o">)</span>
<span class="n">except</span> <span class="n">ReferenceError</span> <span class="k">as</span> <span class="n">e</span><span class="o">:</span>
    <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="na">message</span> <span class="o">==</span> <span class="s1">'foo is not defined'</span><span class="o">:</span>
        <span class="n">print</span><span class="o">(</span><span class="s1">'undefined'</span><span class="o">)</span>
    <span class="k">else</span><span class="o">:</span>
        <span class="n">raise</span> <span class="n">e</span>
<span class="n">finally</span><span class="o">:</span>
    <span class="err">#</span> <span class="n">reset</span> <span class="n">foo</span>
    <span class="n">foo</span> <span class="o">=</span> <span class="s1">'bar'</span>
</pre></div>


<p>Like in Python (but unlike in regular JavaScript), you can use <code>raise</code> keyword by itself from within <code>except</code> block to reraise last-caught error.</p>
<h2>Scope Control</h2>
<p>Scope refers to the context of a variable. For example, a variable declared inside a function is not seen by the code outside the function. This variable's scope is local to the function. JavaScript controls scope via <code>var</code> keyword. Any variable that you start using without declaring with a <code>var</code> first will try to reference inner-most variable with the same name, if one doesn't exist, it will create a global variable with that name. For example, the following JavaScript code will not only return <code>a</code> incremented by 1, but also overwrite the global variable <code>a</code> with <code>a+1</code>:</p>
<div class="codehilite"><pre><span class="n">a</span> <span class="p">=</span> 1<span class="p">;</span>
<span class="n">a_plus_1</span> <span class="p">=</span> <span class="k">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">++</span><span class="n">a</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>


<p>Basically, JavaScript defaults to outer or global scope if you omit <code>var</code>. This behavior can introduce some very frustrating bugs in large applications. To avoid this problem, RapydScript's scope preference works in reverse (same as Python's). RapydScript will prefer local-most scope, always creating a local variable if you perform any sort of assignment on it in a function (this is called variable shadowing). Shadowing can create another annoyance, however, of function's variable changes getting discarded. For example, at first, it looks like the following code will set <code>a</code> to 2:</p>
<div class="codehilite"><pre><span class="n">a</span> <span class="p">=</span> 1
<span class="n">b</span> <span class="p">=</span> 1
<span class="n">increment</span> <span class="p">=</span> <span class="n">def</span><span class="p">():</span>
    <span class="n">a</span> <span class="o">+</span><span class="p">=</span> <span class="n">b</span>
<span class="n">increment</span><span class="p">()</span>
</pre></div>


<p>When executed, however, increment() function will discard any changes to <code>a</code>. This is because, like Python, RapydScript will not allow you to edit variables declared in outer scope. As soon as you use any sort of assignment with <code>a</code> in the inner scope, RapydScript will declare it as an internal variable, shadowing <code>a</code> in the outer scope. One way around this is to use the <code>global</code> keyword, declaring <code>a</code> as a global variable. This, however, must be done in every function that edits <code>a</code>. It also litters global scope, which it frowned upon because it can accidentally overwrite an unrelated variable with the same name (declared by someone else or another library). RapydScript solves this by introducing <code>nonlocal</code> keyword (just like Python 3):</p>
<div class="codehilite"><pre><span class="n">a</span> <span class="p">=</span> 1
<span class="n">b</span> <span class="p">=</span> 1
<span class="n">increment</span> <span class="p">=</span> <span class="n">def</span><span class="p">():</span>
    <span class="n">nonlocal</span> <span class="n">a</span>
    <span class="n">a</span> <span class="o">+</span><span class="p">=</span> <span class="n">b</span>
<span class="n">increment</span><span class="p">()</span>
</pre></div>


<p>Note that <code>b</code> is not affected by shadowing. It's the assignment operator that triggers shadowing, you can read outer-scope variables without having to use <code>nonlocal</code>. You can combine multiple non-local arguments by separating them with a comma: <code>nonlocal a, b, c</code>. You can also chain <code>nonlocal</code> declarations to escape multiple scopes:</p>
<div class="codehilite"><pre><span class="n">def</span> <span class="n">fun1</span><span class="p">():</span>
    <span class="n">a</span> <span class="p">=</span> 5
    <span class="n">b</span> <span class="p">=</span> <span class="n">fun2</span><span class="p">():</span>
        <span class="n">nonlocal</span> <span class="n">a</span>
        <span class="n">a</span> <span class="o">*</span><span class="p">=</span> 2
        <span class="n">c</span> <span class="p">=</span> <span class="n">fun3</span><span class="p">():</span>
            <span class="n">nonlocal</span> <span class="n">a</span>
            <span class="n">a</span> <span class="o">+</span><span class="p">=</span> 1
</pre></div>


<p>Shadowing is preferred in most cases, since it can't accidently damage outside logic, and if you want to edit an external variable, you're usually better off assigning function's return value to it. There are cases, however, when using <code>nonlocal</code> makes the code cleaner. There is also <code>global</code>, but it is rarely a good solution, and use of <code>nonlocal</code> is preferred to it.</p>
<h2>Importing</h2>
<p>Like Python, RapydScript allows you to import additional modules into your code.</p>
<p>For those unfamiliar with importing, let's imagine we're writing a very large program. This program is several thousand lines of code. We could dump it all into the same file, but that wouldn't be too clean (especially when we have multiple developers working on it). Alternatively, we could separate different chunks of the program into different files. Let's imagine, for example, that we're writing a videogame. We've already written a module that implements 'BasicCharacter' class, used by NPCs, monsters, and the main character. We've saved this class to Basic.pyj (that's the extension RapydScript prefers). Now let's create the main character in a different module:</p>
<div class="codehilite"><pre><span class="n">from</span> <span class="n">Basic</span> <span class="n">import</span> <span class="n">BasicCharacter</span>

<span class="n">class</span> <span class="n">MainCharacter</span><span class="p">(</span><span class="n">BasicCharacter</span><span class="p">):</span>
    """
    <span class="n">This</span> <span class="n">is</span> <span class="n">the</span> <span class="n">main</span> <span class="n">character</span> <span class="n">class</span><span class="p">,</span> <span class="n">similar</span> <span class="n">to</span> <span class="n">basic</span> <span class="n">but</span> <span class="n">it</span> <span class="n">implements</span> <span class="n">attack</span> <span class="n">and</span> <span class="n">hp</span>
    """
    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">BasicCharacter</span><span class="p">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">hp</span> <span class="p">=</span> 100
        <span class="n">self</span><span class="p">.</span><span class="n">damage</span> <span class="p">=</span> 10

    <span class="n">def</span> <span class="n">attack</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">something</span><span class="p">):</span>
        <span class="n">something</span><span class="p">.</span><span class="n">getHurt</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">damage</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">getHurt</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">damage</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">hp</span> <span class="o">-</span><span class="p">=</span> <span class="n">damage</span>
</pre></div>


<p>With RapydScript's importing, you don't need to worry about including each JavaScript file individually in your html. All your .pyj files will get concatenated into a single .js file that you can then include in your page. The name of the .js file will match the name of the file you used input for the RapydScript compiler.</p>
<p>RapydScript already adds several modules you can import by default, like <code>stdlib</code> and <code>yql</code>. Check out the examples or the documentation in the modules themselves for usage.</p>
<h2>Regular Expressions</h2>
<p>RapydScript supports Pythonic and JavaScript way of declaring regular expressions. Additionally, like CoffeeScript, RapydScript supports verbose mode (which works like Perl's <code>/x</code> modifier or Python's <code>VERBOSE</code> modifier) - flags, if any, are at the end:</p>
<div class="codehilite"><pre><span class="c"># regular</span>
<span class="n">op</span> <span class="p">=</span> <span class="o">/</span>^<span class="p">(</span>?<span class="p">:[</span><span class="o">-=</span><span class="p">]</span><span class="o">&gt;|</span><span class="p">[</span><span class="o">-+*/</span><span class="c">%&lt;&gt;&amp;|^!?=]=|&gt;&gt;&gt;=?|([-+:])\1|([&amp;|&lt;&gt;])\2=?|\?\.|\.{2,3})/</span>

<span class="c"># verbose</span>
<span class="n">op</span> <span class="p">=</span> <span class="o">///</span> ^ <span class="p">(</span>
    ?<span class="p">:</span> <span class="p">[</span><span class="o">-=</span><span class="p">]</span><span class="o">&gt;</span>             <span class="c"># function</span>
     <span class="o">|</span> <span class="p">[</span><span class="o">-+*/</span><span class="c">%&lt;&gt;&amp;|^!?=]=  # compound assign / compare</span>
     <span class="o">|</span> <span class="o">&gt;&gt;&gt;</span><span class="p">=</span>?             <span class="c"># zero-fill right shift</span>
     <span class="o">|</span> <span class="p">([</span><span class="o">-+</span><span class="p">:])</span><span class="o">\</span>1         <span class="c"># doubles</span>
     <span class="o">|</span> <span class="p">([</span><span class="o">&amp;|&lt;&gt;</span><span class="p">])</span><span class="o">\</span>2<span class="p">=</span>?      <span class="c"># logic / shift</span>
     <span class="o">|</span> <span class="o">\</span>?<span class="o">\</span><span class="p">.</span>              <span class="c"># soak access</span>
     <span class="o">|</span> <span class="o">\</span><span class="p">.{</span>2<span class="p">,</span>3<span class="p">}</span>           <span class="c"># range or splat</span>
<span class="p">)</span> <span class="o">///</span>
</pre></div>


<p>And the Pythonic alternative (note that importing <code>re</code> module also brings in other logic into your code, you'll end up with more functionality at the expense of performance - unless you need that extra functionality, I recommend JavaScript version shown above):</p>
<div class="codehilite"><pre><span class="c"># pythonic</span>
<span class="n">import</span> <span class="n">re</span>
<span class="n">op</span> <span class="p">=</span> <span class="n">re</span><span class="p">.</span><span class="n">compile</span><span class="p">(</span><span class="s">'^(?:[-=]&gt;|[-+*/%&lt;&gt;&amp;|^!?=]=|&gt;&gt;&gt;=?|([-+:])\1|([&amp;|&lt;&gt;])\2=?|\?\.|\.{2,3})'</span><span class="p">)</span>

<span class="c"># verbose pythonic (re.VERBOSE is not implemented, since VERBOSE conversion in current engine happens at</span>
<span class="c"># compile time, for Pythonic re.VERBOSE syntax we'd need to duplicate this logic in re module to run at</span>
<span class="c"># runtime instead)</span>
<span class="n">op</span> <span class="p">=</span> <span class="n">re</span><span class="p">.</span><span class="n">compile</span><span class="p">(</span><span class="o">///</span> ^ <span class="p">(</span>
    ?<span class="p">:</span> <span class="p">[</span><span class="o">-=</span><span class="p">]</span><span class="o">&gt;</span>             <span class="c"># function</span>
     <span class="o">|</span> <span class="p">[</span><span class="o">-+*/</span><span class="c">%&lt;&gt;&amp;|^!?=]=  # compound assign / compare</span>
     <span class="o">|</span> <span class="o">&gt;&gt;&gt;</span><span class="p">=</span>?             <span class="c"># zero-fill right shift</span>
     <span class="o">|</span> <span class="p">([</span><span class="o">-+</span><span class="p">:])</span><span class="o">\</span>1         <span class="c"># doubles</span>
     <span class="o">|</span> <span class="p">([</span><span class="o">&amp;|&lt;&gt;</span><span class="p">])</span><span class="o">\</span>2<span class="p">=</span>?      <span class="c"># logic / shift</span>
     <span class="o">|</span> <span class="o">\</span>?<span class="o">\</span><span class="p">.</span>              <span class="c"># soak access</span>
     <span class="o">|</span> <span class="o">\</span><span class="p">.{</span>2<span class="p">,</span>3<span class="p">}</span>           <span class="c"># range or splat</span>
<span class="p">)</span> <span class="o">///</span><span class="p">)</span>
</pre></div>


<p>As in JavaScript, you can also use the <code>RegExp</code> class:</p>
<div class="codehilite"><pre><span class="n">regex</span> <span class="p">=</span> <span class="o">/</span><span class="n">ab</span><span class="o">+</span><span class="n">c</span><span class="o">/</span><span class="nb">i</span>
<span class="n">regex</span> <span class="p">=</span> <span class="n">RegExp</span><span class="p">(</span><span class="s">'ab+c'</span><span class="p">,</span> <span class="s">'i'</span><span class="p">)</span>
<span class="n">regex</span> <span class="p">=</span> <span class="n">RegExp</span><span class="p">(</span><span class="o">/</span><span class="n">ab</span><span class="o">+</span><span class="n">c</span><span class="o">/</span><span class="p">,</span> <span class="s">'i'</span><span class="p">)</span>
</pre></div>


<h2>Available Libraries</h2>
<p>One of Python's main strengths is the number of libraries available to the developer. This is something very few other <code>Python-in-a-browser</code> frameworks understand. In the browser JavaScript is king, and no matter how many libraries the community for the given project will write, the readily-available JavaScript libraries will always outnumber them. This is why RapydScript was designed with JavaScript and DOM integration in mind from the beginning. Indeed, plugging <code>underscore.js</code> in place of RapydScript's <code>stdlib</code> will work just as well, and some developers may choose to do so, after all, <code>underscore.js</code> is very Pythonic and very complete. Likewise, <code>sprintf.js</code> (<a href="https://npmjs.org/package/sprintf-js">https://npmjs.org/package/sprintf-js</a>) can be used with RapydScript to replicate Python's string interpolation.</p>
<p>It is for that reason that I try to keep RapydScript bells and whistles to a minimum. RapydScript's main strength is easy integration with JavaScript and DOM, which allows me to stay sane and not rewrite my own versions of the libraries that are already available. That doesn't mean, however, that pythonic libraries can't be written for RapydScript. To prove that, I have implemented lightweight clones of several popular Python libraries and bundled them into RapydScript, you can find them in <code>src</code> directory. The following libraries are included:</p>
<div class="codehilite"><pre><span class="n">stdlib</span><span class="o">/</span><span class="n">stdlib2</span>      # <span class="n">see</span> <span class="n">stdlib</span> <span class="n">section</span>
<span class="n">math</span>                # <span class="n">replicates</span> <span class="n">almost</span> <span class="n">all</span> <span class="n">of</span> <span class="n">the</span> <span class="n">functionality</span> <span class="n">from</span> <span class="n">Python</span><span class="o">'</span><span class="n">s</span> <span class="n">math</span> <span class="n">library</span>
<span class="n">re</span>                  # <span class="n">replicates</span> <span class="n">almost</span> <span class="n">all</span> <span class="n">of</span> <span class="n">the</span> <span class="n">functionality</span> <span class="n">from</span> <span class="n">Python</span><span class="o">'</span><span class="n">s</span> <span class="n">re</span> <span class="n">library</span>
<span class="n">unittest</span>            # <span class="n">replicates</span> <span class="n">almost</span> <span class="n">all</span> <span class="n">of</span> <span class="n">the</span> <span class="n">functionality</span> <span class="n">from</span> <span class="n">Python</span><span class="o">'</span><span class="n">s</span> <span class="n">unittest</span> <span class="n">library</span>
<span class="n">random</span>              # <span class="n">replicates</span> <span class="n">most</span> <span class="n">of</span> <span class="n">the</span> <span class="n">functionality</span> <span class="n">from</span> <span class="n">Python</span><span class="o">'</span><span class="n">s</span> <span class="n">random</span> <span class="n">library</span>
<span class="n">yql</span>                 # <span class="n">lightweight</span> <span class="n">library</span> <span class="k">for</span> <span class="n">performing</span> <span class="n">Yahoo</span> <span class="n">Query</span> <span class="n">Language</span> <span class="n">requests</span>
</pre></div>


<p>For the most part, the logic implemented in these libraries functions identically to the Python versions. One notable exception is that unittest library requires that classes be bound to the <code>global</code> (nodejs) or <code>window</code> (browser) object to be picked up by <code>unittest.main()</code>. An example in <code>unitetest.pyj</code> shows this usage. I'd be happy to include more libraries, if other members of the community want to implement them (it's fun to do, <code>re.pyj</code> is a good example), but I want to reemphasize that unlike most other Python-to-JavaScript compilers, RapydScript doesn't need them to be complete since there are already tons of available JavaScript libraries that it can use natively.</p>
<h2>Advanced Usage Topics</h2>
<p>This section contains various topics which might be of interest to the programmer writing large projects using RapydScript, but might not be relevant to a programmer who is just getting started with RapydScript. The topics in this section focus on coding conventions to keep your code clean, optimizations, and additional libraries that come with RapydScript, as well as suggestions for writing your own libraries.</p>
<h3>System Scripts</h3>
<p>I typically have a language I strongly prefer over others for writing miscellaneous system scripts, things like moving files around or automating certain tasks on my home (or work) machine. <em>Bash</em> tends to work well for simple tasks without too much conditional logic. For other things I used to prefer <em>Python</em>. Today, I use <em>RapydScript</em> instead. JavaScript has a powerful ecosystem, and it would be a shame to let it go to waste. You can have your <em>RapydScript</em> files run natively on your OS as well. Do do so, you can include the following line at the top of your file and <code>chmod a+x</code> it:</p>
<table class="codehilitetable"><tr><td class="linenos"/><td class="code"><div class="codehilite"><pre><span class="c">#!/usr/bin/env rapydscript -x</span>
</pre></div>
</td></tr></table>

<p>This is identical to the following terminal operation:</p>
<div class="codehilite"><pre><span class="n">rapydscript</span> <span class="o">--</span><span class="n">execute</span> <span class="p">[</span><span class="n">filename</span><span class="p">]</span>
</pre></div>


<p>It will trigger the script, omitting the compiled code. You can include the <code>--pretty</code> option to include output of the compiled code as well.</p>
<h3>Browser Compatibility</h3>
<p>By default, RapydScript compiles your logic such that it will work on modern browsers running HTML5. Previously I generated code that was compatible with older versions of IE, but have since decided that it wasn't worth it. It prevented me from making use of sensible JavaScript features many developers take for granted (setters, getters, strict mode, etc.), forced special cases on me, and required overly verbose JavaScript with unnecessary polyfill. RapydScript no longer supports versions of IE before 9, but you can easily bring that support back into RapydScript with the help of a tool like <code>Modernizr</code> or <code>Babel</code>.</p>
<h3>Code Conventions</h3>
<p>It's not hard to see that RapydScript is a cleaner language than JavaScript. However, like with all dynamically-typed languages (including Python), it's still easy to shoot yourself in the foot if you don't follow some sort of code conventions. Needless to say, they're called <code>conventions</code> for a reason, feel free to ignore them if you already have a set of conventions you follow or if you disagree with some.</p>
<h4>Tabs vs Spaces</h4>
<p>This seems to be a very old debate. Python code conventions suggest 4-space indent, most of the bundled RapydScript files use 1-tab for indentation. The old version of RapydScript relied on tabs, new one uses spaces since that seems to be more consistent in both Python and JavaScript communities. Use whichever one you prefer, as long as you stay consistent. If you intend to submit your code to RapydScript, it must use spaces to be consistent with the rest of the code int he repository.</p>
<h4>Object Literals vs Hashes/Dicts</h4>
<p>JavaScript treats object literals and hashes as the same thing. I'm not a fan of this policy. Some of the problems you can see resulting from this is Google Closure compiler's ADVANACED_OPTIMIZATIONS breaking a lot of seemingly-good JavaScript code. The main problem for most of the code that breaks seems to be renaming of methods/variables in one place and not another. My suggestion is to ALWAYS treat object literals as object literals and ALWAYS treat hashes as hashes, basically be consistent about quoting your keys. As an added bonus, your code will have a much better chance of compiling correctly via Closure compiler. For example:</p>
<div class="codehilite"><pre><span class="n">obj</span> <span class="p">=</span> <span class="p">{</span>
    <span class="n">foo</span><span class="p">:</span>    1<span class="p">,</span>
    <span class="n">bar</span><span class="p">:</span>    <span class="n">def</span><span class="p">():</span> <span class="n">print</span><span class="p">(</span><span class="s">'bar'</span> <span class="o">+</span> <span class="n">str</span><span class="p">(</span><span class="n">foo</span><span class="p">))</span>
<span class="p">}</span>
<span class="n">hash</span> <span class="p">=</span> <span class="p">{</span>
    <span class="s">'foo'</span><span class="p">:</span>  1<span class="p">,</span>
    <span class="s">'bar'</span><span class="p">:</span>  <span class="n">def</span><span class="p">():</span> <span class="n">print</span><span class="p">(</span><span class="s">'bar'</span> <span class="o">+</span> <span class="n">str</span><span class="p">(</span><span class="n">foo</span><span class="p">))</span>
<span class="p">}</span>

<span class="n">obj</span><span class="p">.</span><span class="n">bar</span><span class="p">()</span>       # <span class="n">good</span>
<span class="n">obj</span><span class="p">[</span><span class="s">'bar'</span><span class="p">]()</span>    # <span class="n">bad</span>

<span class="n">hash</span><span class="p">.</span><span class="n">bar</span><span class="p">()</span>      # <span class="n">bad</span>
<span class="n">hash</span><span class="p">[</span><span class="s">'bar'</span><span class="p">]()</span>   # <span class="n">good</span>
</pre></div>


<h4>Semi-Colons</h4>
<p>Don't abuse semi-colons. They're meant as a way to group related logic together, not to fit your entire web-app on one line. The following is fine:</p>



<p>Anything that requires more than a couple semi-colons, however, or involves long mathematical computations, is better off on its own line. Use your discretion, if the logic requires more than one visual pass-through from the programmer to understand the flow, you probably shouldn't use semi-colons. A Fibanacci function, as shown below, would probably be the upper limit of the kind of logic you could sanely represent with semi-colons:</p>
<div class="codehilite"><pre><span class="n">fib</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">if</span> <span class="n">x</span><span class="o">&lt;</span><span class="p">=</span>1<span class="p">:</span> <span class="k">return</span> 1<span class="p">;</span> <span class="k">return</span> <span class="n">fib</span><span class="p">(</span><span class="n">x</span><span class="o">-</span>1<span class="p">)</span><span class="o">+</span><span class="n">fib</span><span class="p">(</span><span class="n">x</span><span class="o">-</span>2<span class="p">)</span>
</pre></div>


<p>Even for this example, however, I'd personally prefer to use multiple lines.</p>
<h4>Raw JavaScript</h4>
<p>Occasionally you may need to use raw JavaScript due to a limitation of RapydScript. To keep code legible and consistent, I suggest minimizing the chunk of code contained within <code>JS</code>, keeping most of the logic within RapydScript itself. For example, instead of accessing a variable that shares reserved keyword as <code>JS('module.exports')</code> use <code>JS('module').exports</code>. This will make it more visually-obvious what you're trying to do as well as allow your syntax highlighter to do its job.</p>
<h4>jQuery-wrapped Elements</h4>
<p>If you use jQuery with your app, you will probably be storing these into variables a lot. If you've written a decently sized app, you've probably mistaken a bare element with wrapped element at least once. This is especially true of objects like <code>canvas</code>, where you need to access object's attributes and methods directly. My solution for these is simple, prepend jQuery-wrapped elements with <code>$</code>:</p>
<div class="codehilite"><pre><span class="p">$</span><span class="nv">canvas</span> = ('<span class="nt">&lt;canvas&gt;&lt;/canvas&gt;</span>')
canvas = <span class="p">$</span><span class="nv">canvas</span><span class="p">.</span><span class="nv">get</span><span class="p">(</span><span class="m">0</span><span class="p">)</span>
ctx = canvas.getContext('2d')
<span class="p">$</span><span class="nv">canvas</span><span class="p">.</span><span class="nv">appendTo</span><span class="p">(</span><span class="err">document</span><span class="p">)</span>
</pre></div>


<p>This is especially useful with function definitions, since you will immediately know what kind of object the function takes in just by skimming its signature.</p>
<h4>Libraries</h4>
<p>I recommend that developers rely on native JavaScript logic when possible, rather than libraries like <code>math.pyj</code> and <code>re.pyj</code>. While they mimic Python without problems and work quite well, they introduce extra overhead that your web app doesn't need. Additionally, I think <code>re</code> module in Python is unnecessarily complex, and JavaScript's <code>RegExp</code> object is much easier to use. With that said, these libraries can be extremely useful for porting large applications from Python to the web, but if you're writing new code, it will probably be easier to maintain if you decide to use native JavaScript alternatives (such as <code>Math</code> and <code>RegExp</code>) instead.</p>
<h4>External Libraries and Classes</h4>
<p>RapydScript will pick up any classes you declare yourself as well as native JavaScript classes. It will not, however, pick up class-like objects created by outside frameworks. There are two approaches for dealing with those. One is via <code>@external</code> decorator, the other is via <code>new</code> operator when declaring such object. To keep code legible and consistent, I strongly prefer the use of <code>@external</code> decorator over the <code>new</code> operator for several reasons, even if it may be more verbose:</p>
<ul>
<li><code>@external</code> decorator makes classes declared externally obvious to anyone looking at your code</li>
<li>class declaration that uses <code>@external</code> decorator can be exported into a reusable module</li>
<li>developers are much more likely to forget a single instance of <code>new</code> operator when declaring an object than to forget an import, the errors due to omitted <code>new</code> keyword are also likely to be more subtle and devious to debug</li>
</ul>
<h2>Quirks</h2>
<p>In a perfect world, software works flawlessly and doesn't have any special cases requiring workarounds on the user's part. In a less-perfect world, all quirks are due to the software itself and can be fixed. In our world, we not only have to deal with the quirks of the software we're using, but other software it interacts with. RapydScript is no exception, in addition to its own quirks there are a few quirks brought upon us by the browser as well as a few bugs in jQuery that affect us. Here is a list of things you need to be aware of:</p>
<ul>
<li>
<p>RapydScript automatically appends 'new' keyword when using classes generated
  by it, native JavaScript objects like <code>Image</code> and <code>RegExp</code> and classes from
  other libraries marked as external. This means that you should be using
  <code>@external</code> decorator from classes you're bringing in from the outside that
  the compiler isn't aware of, or use <code>new</code> when declaring them manually.</p>
</li>
<li>
<p>Automatic new insertion depends on the compiler being able to detect that a
  symbol resolves to a class. Because of the dynamic nature of JavaScript this
  is not possible to do with 100% accuracy (this is usually only a problem
  when you rely on duck-typing to conceal a class constructor in a variable).
  In those cases you should append the <code>new</code> keyword yourself. Similarly, the
  compiler will try to convert SomeClass.method() into SomeClass.prototype.method()
  for you, but will fail in the same cases. Declaring this variable as a class
  with <code>@external</code> decorator should fix this issue.</p>
</li>
<li>
<p>JavaScript's equality operator is gimped. It only works as equality operator for
  primitive types (string, number, boolean). For objects, it's more akin to Python's
  <code>is</code> operator, comparing memory address rather than equality. For that reason,
  never compare arrays or objects via <code>==</code>, instead use inbuilt <code>eq</code> function.</p>
</li>
<li>
<p>Truthiness in JavaScript is very different from Python. Empty lists and dicts
  are <code>False</code> in Python but <code>True</code> in JavaScript. The compiler could work
  around that, but not without a significant performance cost, so it is best to
  just get used to checking the length instead of the object directly.</p>
</li>
<li>
<p>Operators in JavaScript are very different from Python. <code>1 + '1'</code> would be
  an error in Python, but results in <code>'11'</code> in JavaScript. Keep that in mind
  as you write code.</p>
</li>
<li>
<p>Method binding in RS is not automatic. So <code>someobj.somemethod()</code> will do the
  right thing, but <code>x = someobj.somethod; x()</code> will not. RS could work around
  it, but at significant performance cost. See the section above on method
  binding for details. To work around it, you could assign it instead as
  <code>x = bind(someobj.somemethod, someobj)</code>. Alternatively, you can use
  <code>--auto-bind</code> flag, and enjoy automatic method binding at the expense of
  performance.</p>
</li>
<li>
<p>jQuery erroneously assumes that no other library will be modifying
  JavaScript's 'Object', and fails to do <code>object.hasOwnProperty()</code> check in
  multiple places where it should. To avoid breaking it, I had to implement
  stdlib such that dictionary methods are methods of a different object.
  Regular Python allows you to call hash.keys() as well as dict.keys(hash).
  RapydScript only supports the second notation - which is admittedly a bit
  more awkward.</p>
</li>
<li>
<p>Negative indexes are only supported for constant numbers. If the compiler
  detects that you're using a negative index (<code>array[-1]</code>), it will automatically
  convert it to <code>array[array.length-n]</code>. Otherwise, if the index is masked in
  a variable, you will have to convert it yourself.</p>
</li>
<li>
<p>Operator overloading is not supported, yet</p>
</li>
</ul>
				</div>
				<div id="ex-page">
					

<h1>Rapydscript Examples</h1>
<h2>Asteroids Example</h2>
<p>Copyright 2013 Pyjeon Software LLC<br/>
Author: Charles Law (based on Pyjamas Asteroids)<br/>
License: Creative Commons: Attribution + Noncommerial + ShareAlike  </p>
<p><img alt="Preview" src="https://bitbucket.org/pyjeon/rapydscript/raw/default/examples/asteroids/preview.png" title="Preview Screenshot"/></p>
<h3>RapydScript Asteroids</h3>
<p>The asteroids game was originally written as a Pyjs (formally Pyjamas) example. With some relatively minor changes, the code was ported over to RapydScript. The RapydScript verion has the full functionality of the game but with a significantly smaller footprint. The important metrics from our perspective are:</p>
<div class="codehilite"><pre><span class="n">Download</span> <span class="n">Size</span><span class="p">:</span> 18 <span class="n">kb</span>   <span class="n">vs</span> 1200 <span class="n">kb</span>
<span class="n">Download</span> <span class="n">Time</span><span class="p">:</span> 1<span class="p">.</span>3 <span class="nb">sec</span> <span class="n">vs</span>  17 <span class="nb">sec</span>
<span class="n">LOC</span><span class="p">:</span>             700   <span class="n">vs</span>   32900
</pre></div>


<p>It is also worth noting that there are currently 6 cache files generated for Pyjs so the app takes significantly more storage space.</p>
<p>Example in action: <a href="http://pyjeon.pythonanywhere.com/static/asteroids/index.html">RapydScript Asteroids</a></p>
<h3>Pyjs Asteroids</h3>
<p>The Pyjs Asteroids game builds to approximately 1200kb for a single cache file. End users will have to wait significantly longer to load a webpage.</p>
<p>For developers, Pyjs can make applications appear slow and use more bandwidth to transfer. It is also worth noting that Pyjs generates 6 cache files that all must be deployed.</p>
<p>Example in Action: <a href="http://pyjeon.pythonanywhere.com/static/examples/pyjsasteroids/compiled/Space.html">Pyjs Example</a></p>
<h3>asteroids.pyj</h3>
<div class="codehilite"><pre>"""
<span class="n">View</span>

<span class="n">The</span> <span class="n">view</span> <span class="n">contains</span> <span class="n">the</span> <span class="n">canvas</span> <span class="n">and</span> <span class="n">has</span> <span class="n">all</span> <span class="n">the</span> <span class="n">logic</span> <span class="k">for</span> <span class="n">drawing</span> <span class="n">the</span> <span class="n">game</span> <span class="n">state</span>
<span class="n">on</span> <span class="n">the</span> <span class="n">screen</span><span class="p">.</span> <span class="n">The</span> <span class="n">original</span> <span class="n">Pyjs</span> <span class="n">code</span> <span class="n">used</span> <span class="n">multiple</span> <span class="n">libraries</span> <span class="n">here</span><span class="p">.</span> <span class="n">Of</span> <span class="n">the</span> 3
<span class="n">files</span><span class="p">,</span> <span class="n">this</span> <span class="n">one</span> <span class="n">required</span> <span class="n">the</span> <span class="n">most</span> <span class="n">changes</span> <span class="n">to</span> <span class="n">port</span> <span class="n">to</span> <span class="n">RapydScript</span><span class="p">.</span>
"""

<span class="n">import</span> <span class="n">stdlib</span>
<span class="n">import</span> <span class="n">game_model</span>
<span class="n">import</span> <span class="n">game_controller</span>

<span class="n">SHOT_COLOR</span> <span class="p">=</span> <span class="s">'#fff'</span>

<span class="n">ASTEROID_SIZE</span> <span class="p">=</span> 180<span class="p">.</span>0
<span class="n">CANVAS_DIM_X</span> <span class="p">=</span> 800
<span class="n">CANVAS_DIM_Y</span> <span class="p">=</span> 600

<span class="n">class</span> <span class="n">View</span><span class="p">:</span>
    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">canvas</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">width</span> <span class="p">=</span> <span class="n">w</span>
        <span class="n">self</span><span class="p">.</span><span class="n">height</span> <span class="p">=</span> <span class="n">h</span>
        <span class="n">self</span><span class="p">.</span><span class="n">canvas</span> <span class="p">=</span> <span class="n">canvas</span>

        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="p">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">controller</span> <span class="p">=</span> <span class="n">Controller</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">number_images_loaded</span> <span class="p">=</span> 0
        <span class="n">self</span><span class="p">.</span><span class="n">view_loaded</span> <span class="p">=</span> <span class="n">False</span>

        <span class="n">document</span><span class="p">.</span><span class="n">addEventListener</span><span class="p">(</span><span class="s">'keydown'</span><span class="p">,</span> <span class="n">def</span> <span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">event</span><span class="p">.</span><span class="n">preventDefault</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">setKey</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">keyCode</span><span class="p">,</span> <span class="n">True</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">document</span><span class="p">.</span><span class="n">addEventListener</span><span class="p">(</span><span class="s">'keyup'</span><span class="p">,</span> <span class="n">def</span> <span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">event</span><span class="p">.</span><span class="n">preventDefault</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">setKey</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">keyCode</span><span class="p">,</span> <span class="n">False</span><span class="p">)</span>
        <span class="p">)</span>

        #<span class="n">Load</span> <span class="n">images</span>
        <span class="n">imgsrcs</span> <span class="p">=</span> <span class="p">[</span><span class="s">'./images/ship1.png'</span><span class="p">,</span>
                    <span class="s">'./images/ship2.png'</span><span class="p">,</span>
                    <span class="s">'./images/asteroid.png'</span><span class="p">]</span>

        <span class="n">self</span><span class="p">.</span><span class="n">img</span> <span class="p">=</span> <span class="p">[</span><span class="n">None</span><span class="p">,</span> <span class="n">None</span><span class="p">,</span> <span class="n">None</span><span class="p">]</span>
        <span class="k">for</span> <span class="nb">i</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span>3<span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="n">img</span><span class="p">[</span><span class="nb">i</span><span class="p">]</span> <span class="p">=</span> <span class="n">Image</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">img</span><span class="p">[</span><span class="nb">i</span><span class="p">].</span><span class="n">src</span> <span class="p">=</span> <span class="n">imgsrcs</span><span class="p">[</span><span class="nb">i</span><span class="p">]</span>
            <span class="n">self</span><span class="p">.</span><span class="n">img</span><span class="p">[</span><span class="nb">i</span><span class="p">].</span><span class="n">onload</span> <span class="p">=</span> <span class="n">def</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="n">number_images_loaded</span> <span class="o">+</span><span class="p">=</span> 1
                <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">number_images_loaded</span> <span class="o">&gt;</span><span class="p">=</span> 3<span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">view_loaded</span> <span class="p">=</span> <span class="n">True</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">.</span><span class="n">start_game</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">setKey</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">set</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> 38<span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">.</span><span class="n">key_up</span> <span class="p">=</span> <span class="n">set</span>
        <span class="n">elif</span> <span class="n">k</span> <span class="o">==</span> 40<span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">.</span><span class="n">key_down</span> <span class="p">=</span> <span class="n">set</span>
        <span class="n">elif</span> <span class="n">k</span> <span class="o">==</span> 37<span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">.</span><span class="n">key_left</span> <span class="p">=</span> <span class="n">set</span>
        <span class="n">elif</span> <span class="n">k</span> <span class="o">==</span> 39<span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">.</span><span class="n">key_right</span> <span class="p">=</span> <span class="n">set</span>
        <span class="n">elif</span> <span class="n">k</span> <span class="o">==</span> 32<span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">.</span><span class="n">key_fire</span> <span class="p">=</span> <span class="n">set</span>

    <span class="n">def</span> <span class="n">draw_asteroid</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">asteroid</span><span class="p">):</span>
        <span class="n">ctx</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">ctx</span><span class="p">.</span><span class="n">translate</span><span class="p">(</span><span class="n">asteroid</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">asteroid</span><span class="p">.</span><span class="n">y</span><span class="p">)</span>
        <span class="n">ctx</span><span class="p">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">asteroid</span><span class="p">.</span><span class="n">rot</span><span class="p">)</span>
        <span class="n">ctx</span><span class="p">.</span><span class="n">scale</span><span class="p">(</span><span class="n">asteroid</span><span class="p">.</span><span class="n">scale</span><span class="p">,</span><span class="n">asteroid</span><span class="p">.</span><span class="n">scale</span><span class="p">)</span>
        <span class="n">ctx</span><span class="p">.</span><span class="n">drawImage</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">img</span><span class="p">[</span>2<span class="p">],</span> <span class="o">-</span><span class="p">(</span><span class="n">ASTEROID_SIZE</span><span class="o">/</span>2<span class="p">),</span> <span class="o">-</span><span class="p">(</span><span class="n">ASTEROID_SIZE</span><span class="o">/</span>2<span class="p">))</span>
        <span class="n">ctx</span><span class="p">.</span><span class="n">restore</span><span class="p">()</span>

    <span class="n">def</span> <span class="n">draw_shot</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">shot</span><span class="p">):</span>
        <span class="n">ctx</span><span class="p">.</span><span class="n">fillStyle</span> <span class="p">=</span> <span class="n">SHOT_COLOR</span>
        <span class="n">ctx</span><span class="p">.</span><span class="n">fillRect</span><span class="p">(</span><span class="n">Math</span><span class="p">.</span><span class="nb">ceil</span><span class="p">(</span><span class="n">shot</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> 1<span class="p">),</span> <span class="n">Math</span><span class="p">.</span><span class="nb">ceil</span><span class="p">(</span><span class="n">shot</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> 1<span class="p">),</span> 3<span class="p">,</span> 3<span class="p">)</span>

    <span class="n">def</span> <span class="n">draw_ship</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">ship</span><span class="p">):</span>
        <span class="n">ctx</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">ctx</span><span class="p">.</span><span class="n">translate</span><span class="p">(</span><span class="n">ship</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">ship</span><span class="p">.</span><span class="n">y</span><span class="p">)</span>
        <span class="n">ctx</span><span class="p">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">ship</span><span class="p">.</span><span class="n">rot</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">.</span><span class="n">key_up</span><span class="p">:</span>
            <span class="n">img</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">img</span><span class="p">[</span>1<span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">img</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">img</span><span class="p">[</span>0<span class="p">]</span>
        <span class="n">ctx</span><span class="p">.</span><span class="n">drawImage</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="o">-</span>15<span class="p">,</span> <span class="o">-</span>12<span class="p">)</span>
        <span class="n">ctx</span><span class="p">.</span><span class="n">restore</span><span class="p">()</span>

    <span class="n">def</span> <span class="n">draw</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">ctx</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">canvas</span><span class="p">.</span><span class="n">getContext</span><span class="p">(</span><span class="s">'2d'</span><span class="p">)</span>

        #<span class="n">fill</span> <span class="n">the</span> <span class="n">background</span>
        <span class="n">ctx</span><span class="p">.</span><span class="n">fillStyle</span> <span class="p">=</span> <span class="s">'#000'</span>
        <span class="n">ctx</span><span class="p">.</span><span class="n">fillRect</span><span class="p">(</span>0<span class="p">,</span> 0<span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">height</span><span class="p">)</span>

        <span class="k">for</span> <span class="nb">i</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="n">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">asteroids</span><span class="p">)):</span>
            <span class="n">self</span><span class="p">.</span><span class="n">draw_asteroid</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">asteroids</span><span class="p">[</span><span class="nb">i</span><span class="p">])</span>
        <span class="k">for</span> <span class="nb">i</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="n">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">shots</span><span class="p">)):</span>
            <span class="n">self</span><span class="p">.</span><span class="n">draw_shot</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">shots</span><span class="p">[</span><span class="nb">i</span><span class="p">])</span>

        <span class="n">self</span><span class="p">.</span><span class="n">draw_ship</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">ship</span><span class="p">)</span>

<span class="n">window</span><span class="p">.</span><span class="n">runGame</span> <span class="p">=</span> <span class="n">def</span><span class="p">():</span>
    # <span class="n">The</span> <span class="n">view</span> <span class="n">tells</span> <span class="n">when</span> <span class="n">the</span> <span class="n">controller</span> <span class="n">to</span> <span class="n">start</span> <span class="n">and</span> <span class="n">passes</span> <span class="n">in</span> <span class="n">a</span> <span class="n">reference</span>
    # <span class="n">to</span> <span class="n">itself</span>
    <span class="n">canvas</span> <span class="p">=</span> <span class="n">document</span><span class="p">.</span><span class="n">getElementById</span><span class="p">(</span><span class="s">'myCanvas'</span><span class="p">)</span>
    <span class="n">view</span> <span class="p">=</span> <span class="n">View</span><span class="p">(</span><span class="n">CANVAS_DIM_X</span><span class="p">,</span> <span class="n">CANVAS_DIM_Y</span><span class="p">,</span> <span class="n">canvas</span><span class="p">)</span>
</pre></div>


<h3>game_controller.pyj</h3>
<div class="codehilite"><pre><span class="c">#   Copyright 2012 Charles Law</span>
<span class="c">#</span>
<span class="c">#   Licensed under the Apache License, Version 2.0 (the "License");</span>
<span class="c">#   you may not use this file except in compliance with the License.</span>
<span class="c">#   You may obtain a copy of the License at</span>
<span class="c">#</span>
<span class="c">#    http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c">#</span>
<span class="c">#   Unless required by applicable law or agreed to in writing, software</span>
<span class="c">#   distributed under the License is distributed on an "AS IS" BASIS,</span>
<span class="c">#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c">#   See the License for the specific language governing permissions and</span>
<span class="c">#   limitations under the License.</span>
<span class="c">#</span>

<span class="s">"""</span>
<span class="s">Controller</span>

<span class="s">The controller runs the game and modifies the Model. This required very few changes</span>
<span class="s">to port from Pyjs.</span>
<span class="s">"""</span>

<span class="n">import</span> <span class="n">game_model</span>

<span class="nb">class</span> <span class="n">Controller</span><span class="p">:</span>
    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="p">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">key_up</span> <span class="p">=</span> <span class="n">False</span>
        <span class="n">self</span><span class="p">.</span><span class="n">key_down</span> <span class="p">=</span> <span class="n">False</span>
        <span class="n">self</span><span class="p">.</span><span class="n">key_left</span> <span class="p">=</span> <span class="n">False</span>
        <span class="n">self</span><span class="p">.</span><span class="n">key_right</span> <span class="p">=</span> <span class="n">False</span>
        <span class="n">self</span><span class="p">.</span><span class="n">key_fire</span> <span class="p">=</span> <span class="n">False</span>

    <span class="n">def</span> <span class="n">start_game</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="nb">view</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="nb">view</span> <span class="p">=</span> <span class="nb">view</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">start_game</span><span class="p">(</span><span class="nb">view</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nb">reset</span><span class="p">()</span>

        <span class="c">#setup a timer</span>
        <span class="n">setInterval</span><span class="p">(</span><span class="n">def</span><span class="p">():</span>
            <span class="n">self</span><span class="p">.</span><span class="n">update</span><span class="p">()</span>
        <span class="p">,</span> 1000<span class="o">/</span><span class="n">FPS</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">update</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">keyboard_updates</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">update</span><span class="p">()</span>

    <span class="n">def</span> <span class="n">keyboard_updates</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">ship</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">ship</span>

        <span class="n">drot</span> <span class="p">=</span> 0
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">key_left</span><span class="p">:</span>
            <span class="n">drot</span> <span class="o">-=</span> <span class="n">ROTATE_SPEED</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">key_right</span><span class="p">:</span>
            <span class="n">drot</span> <span class="o">+=</span> <span class="n">ROTATE_SPEED</span>
        <span class="k">if</span> <span class="n">drot</span><span class="p">:</span>
            <span class="n">ship</span><span class="p">.</span><span class="n">rotate_ship</span><span class="p">(</span><span class="n">drot</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">key_up</span><span class="p">:</span>
            <span class="n">ship</span><span class="p">.</span><span class="n">thrust</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ship</span><span class="p">.</span><span class="n">friction</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">key_fire</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">trigger_fire</span><span class="p">()</span>
</pre></div>


<h3>game_model.pyj</h3>
<div class="codehilite"><pre><span class="c">#   Copyright 2009 Joe Rumsey</span>
<span class="c">#   Copyright 2012 Charles Law</span>
<span class="c">#</span>
<span class="c">#   Licensed under the Apache License, Version 2.0 (the "License");</span>
<span class="c">#   you may not use this file except in compliance with the License.</span>
<span class="c">#   You may obtain a copy of the License at</span>
<span class="c">#</span>
<span class="c">#    http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c">#</span>
<span class="c">#   Unless required by applicable law or agreed to in writing, software</span>
<span class="c">#   distributed under the License is distributed on an "AS IS" BASIS,</span>
<span class="c">#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c">#   See the License for the specific language governing permissions and</span>
<span class="c">#   limitations under the License.</span>
<span class="c">#</span>

<span class="s">"""</span>
<span class="s">Model</span>

<span class="s">The model contains the classes representing the various game objects - the asteroid, ship</span>
<span class="s">and shots. These are used to store all the state information on these different objects</span>
<span class="s">as well as helping modify them. The original Pyjs code did not use any libraries so</span>
<span class="s">porting over this code required almost no changes to the code.</span>
<span class="s">"""</span>

<span class="n">NUM_ASTEROIDS</span> <span class="p">=</span> 2
<span class="n">FPS</span> <span class="p">=</span> 30
<span class="n">FRICTION</span> <span class="p">=</span> 0<span class="p">.</span>05
<span class="n">THRUST</span> <span class="p">=</span> 0<span class="p">.</span>2
<span class="n">ROTATE_SPEED_PER_SEC</span> <span class="p">=</span> <span class="n">Math</span><span class="p">.</span><span class="n">PI</span>
<span class="n">ROTATE_SPEED</span> <span class="p">=</span> <span class="n">ROTATE_SPEED_PER_SEC</span> <span class="o">/</span> <span class="n">FPS</span>
<span class="n">MAX_ASTEROID_SPEED</span> <span class="p">=</span> 2<span class="p">.</span>0
<span class="n">SHOT_LIFESPAN</span> <span class="p">=</span> 60
<span class="n">SHOT_SPEED</span> <span class="p">=</span> 8<span class="p">.</span>0
<span class="n">SHOT_DELAY</span> <span class="p">=</span> 10
<span class="n">ASTEROID_SIZE</span> <span class="p">=</span> 180<span class="p">.</span>0
<span class="n">ASTEROID_SIZES</span> <span class="p">=</span> <span class="p">[</span>90<span class="p">.</span>0<span class="p">,</span> 45<span class="p">.</span>0<span class="p">,</span> 22<span class="p">.</span>0<span class="p">,</span> 11<span class="p">.</span>0<span class="p">]</span>

<span class="n">def</span> <span class="n">randfloat</span><span class="p">(</span><span class="nb">min</span><span class="p">,</span> <span class="nb">max</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Math</span><span class="p">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="nb">max</span> <span class="o">-</span> <span class="nb">min</span><span class="p">)</span> <span class="o">+</span> <span class="nb">min</span>

<span class="n">def</span> <span class="n">randint</span><span class="p">(</span><span class="nb">min</span><span class="p">,</span> <span class="nb">max</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Math</span><span class="p">.</span><span class="nb">floor</span><span class="p">(</span><span class="n">Math</span><span class="p">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="nb">max</span> <span class="o">-</span> <span class="nb">min</span> <span class="o">+</span> 1<span class="p">))</span> <span class="o">+</span> <span class="nb">min</span>

<span class="n">def</span> <span class="n">distsq</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x2</span><span class="p">))</span> <span class="o">+</span> <span class="p">((</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y2</span><span class="p">))</span>

<span class="nb">class</span> <span class="n">Asteroid</span><span class="p">:</span>
    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">x</span><span class="p">=</span><span class="n">None</span><span class="p">,</span> <span class="n">y</span><span class="p">=</span><span class="n">None</span><span class="p">,</span> <span class="nb">size</span><span class="p">=</span>0<span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="p">=</span> <span class="n">model</span>
        <span class="k">if</span> <span class="n">x</span> <span class="n">is</span> <span class="n">None</span> <span class="nb">or</span> <span class="n">y</span> <span class="n">is</span> <span class="n">None</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">x</span> <span class="p">=</span> <span class="n">model</span><span class="p">.</span><span class="n">x</span><span class="o">/</span>2
            <span class="n">self</span><span class="p">.</span><span class="n">y</span> <span class="p">=</span> <span class="n">model</span><span class="p">.</span><span class="n">y</span><span class="o">/</span>2
            <span class="k">while</span> <span class="n">distsq</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">model</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> 2<span class="p">,</span> <span class="n">model</span><span class="p">.</span><span class="n">y</span> <span class="o">/</span> 2<span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span>180<span class="o">*</span>180<span class="p">):</span>
                <span class="n">self</span><span class="p">.</span><span class="n">x</span> <span class="p">=</span> <span class="n">randint</span><span class="p">(</span>0<span class="p">,</span> <span class="n">model</span><span class="p">.</span><span class="n">x</span><span class="p">)</span>
                <span class="n">self</span><span class="p">.</span><span class="n">y</span> <span class="p">=</span> <span class="n">randint</span><span class="p">(</span>0<span class="p">,</span> <span class="n">model</span><span class="p">.</span><span class="n">y</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">x</span> <span class="p">=</span> <span class="n">x</span>
            <span class="n">self</span><span class="p">.</span><span class="n">y</span> <span class="p">=</span> <span class="n">y</span>

        <span class="n">self</span><span class="p">.</span><span class="n">dx</span> <span class="p">=</span> <span class="n">randfloat</span><span class="p">(</span>0<span class="p">,</span> <span class="n">MAX_ASTEROID_SPEED</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">dy</span> <span class="p">=</span> <span class="n">randfloat</span><span class="p">(</span>0<span class="p">,</span> <span class="n">MAX_ASTEROID_SPEED</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">rot</span> <span class="p">=</span> <span class="n">randfloat</span><span class="p">(</span>0<span class="p">,</span> 2<span class="o">*</span><span class="n">Math</span><span class="p">.</span><span class="n">PI</span><span class="p">)</span> <span class="o">-</span> <span class="n">Math</span><span class="p">.</span><span class="n">PI</span>
        <span class="n">self</span><span class="p">.</span><span class="n">rotspeed</span> <span class="p">=</span> <span class="n">randfloat</span><span class="p">(</span>0<span class="p">,</span> 0<span class="p">.</span>1<span class="p">)</span> <span class="o">-</span> 0<span class="p">.</span>05
        <span class="n">self</span><span class="p">.</span><span class="nb">size</span> <span class="p">=</span> <span class="nb">size</span>
        <span class="n">self</span><span class="p">.</span><span class="n">radius</span> <span class="p">=</span> <span class="n">ASTEROID_SIZES</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="nb">size</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">radius2</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">radius</span><span class="o">*</span><span class="n">self</span><span class="p">.</span><span class="n">radius</span>
        <span class="n">self</span><span class="p">.</span><span class="n">scale</span> <span class="p">=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">radius</span> <span class="o">/</span> <span class="n">ASTEROID_SIZE</span><span class="p">)</span> <span class="o">*</span> 2

    <span class="n">def</span> <span class="n">update_dim</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">d_dim</span><span class="p">,</span> <span class="n">max_dim</span><span class="p">):</span>
        <span class="n">pos</span> <span class="o">+=</span> <span class="n">d_dim</span>

        <span class="k">if</span> <span class="n">d_dim</span> <span class="o">&lt;</span> 0<span class="p">:</span>
            <span class="k">if</span> <span class="n">pos</span> <span class="o">&lt;</span><span class="p">=</span> 0<span class="p">:</span>
                <span class="n">pos</span> <span class="p">=</span> <span class="o">-</span><span class="n">pos</span>
                <span class="n">d_dim</span> <span class="p">=</span> <span class="o">-</span><span class="n">d_dim</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pos</span> <span class="o">&gt;</span><span class="p">=</span> <span class="n">max_dim</span><span class="p">:</span>
                <span class="n">d_dim</span> <span class="p">=</span> <span class="o">-</span><span class="n">d_dim</span>
                <span class="n">pos</span> <span class="p">=</span> 2<span class="o">*</span><span class="n">max_dim</span> <span class="o">-</span> <span class="n">pos</span>
        <span class="k">return</span> <span class="n">pos</span><span class="p">,</span> <span class="n">d_dim</span>

    <span class="n">def</span> <span class="n">move</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">dx</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">update_dim</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">dx</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">x</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">dy</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">update_dim</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">dy</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">y</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">rot</span> <span class="o">+=</span> <span class="n">self</span><span class="p">.</span><span class="n">rotspeed</span>

<span class="nb">class</span> <span class="n">Shot</span><span class="p">:</span>
    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">ship</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="p">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">x</span> <span class="p">=</span> <span class="n">ship</span><span class="p">.</span><span class="n">x</span>
        <span class="n">self</span><span class="p">.</span><span class="n">y</span> <span class="p">=</span> <span class="n">ship</span><span class="p">.</span><span class="n">y</span>
        <span class="n">self</span><span class="p">.</span><span class="n">dx</span> <span class="p">=</span> <span class="n">ship</span><span class="p">.</span><span class="n">dx</span>
        <span class="n">self</span><span class="p">.</span><span class="n">dy</span> <span class="p">=</span> <span class="n">ship</span><span class="p">.</span><span class="n">dy</span>
        <span class="n">self</span><span class="p">.</span><span class="n">direction</span> <span class="p">=</span> <span class="n">ship</span><span class="p">.</span><span class="n">rot</span>
        <span class="n">self</span><span class="p">.</span><span class="n">lifespan</span> <span class="p">=</span> <span class="n">SHOT_LIFESPAN</span>

    <span class="n">def</span> <span class="n">move</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">lifespan</span> <span class="o">-=</span> 1
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">lifespan</span> <span class="o">&lt;</span><span class="p">=</span> 0<span class="p">:</span>
            <span class="k">return</span> <span class="n">False</span>
        <span class="n">self</span><span class="p">.</span><span class="n">x</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">dx</span> <span class="o">+</span> <span class="n">SHOT_SPEED</span> <span class="o">*</span> <span class="n">Math</span><span class="p">.</span><span class="nb">sin</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">direction</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">y</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">dy</span> <span class="o">-</span> <span class="n">SHOT_SPEED</span> <span class="o">*</span> <span class="n">Math</span><span class="p">.</span><span class="nb">cos</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">direction</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="n">in</span> <span class="n">enumerate</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">asteroids</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">distsq</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">a</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">radius2</span><span class="p">):</span>
                <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">split_asteroid</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">False</span>

        <span class="k">return</span> <span class="n">True</span>

<span class="nb">class</span> <span class="n">Ship</span><span class="p">:</span>
    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cx</span> <span class="p">=</span> <span class="n">cx</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cy</span> <span class="p">=</span> <span class="n">cy</span>
        <span class="n">self</span><span class="p">.</span><span class="nb">reset</span><span class="p">()</span>

    <span class="n">def</span> <span class="n">rotate_ship</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">drot</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">rot</span> <span class="o">+=</span> <span class="n">drot</span>

        <span class="k">if</span> <span class="n">drot</span> <span class="o">&lt;</span> 0<span class="o">-</span><span class="n">Math</span><span class="p">.</span><span class="n">PI</span><span class="p">:</span>
            <span class="n">drot</span> <span class="o">+=</span> 2<span class="o">*</span><span class="n">Math</span><span class="p">.</span><span class="n">PI</span>
        <span class="n">elif</span> <span class="n">drot</span> <span class="o">&gt;</span> <span class="n">Math</span><span class="p">.</span><span class="n">PI</span><span class="p">:</span>
            <span class="n">drot</span> <span class="o">-=</span> 2<span class="o">*</span><span class="n">Math</span><span class="p">.</span><span class="n">PI</span>

    <span class="n">def</span> <span class="n">thrust</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">dx</span> <span class="o">+=</span> <span class="n">THRUST</span> <span class="o">*</span> <span class="n">Math</span><span class="p">.</span><span class="nb">sin</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">rot</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">dy</span> <span class="o">-=</span> <span class="n">THRUST</span> <span class="o">*</span> <span class="n">Math</span><span class="p">.</span><span class="nb">cos</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">rot</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">friction</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">Math</span><span class="p">.</span><span class="nb">abs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dx</span><span class="p">)</span> <span class="o">&lt;</span> 0<span class="p">.</span>001 <span class="nb">and</span> <span class="n">Math</span><span class="p">.</span><span class="nb">abs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dy</span><span class="p">)</span> <span class="o">&lt;</span> 0<span class="p">.</span>001<span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">dx</span> <span class="p">=</span> 0
            <span class="n">self</span><span class="p">.</span><span class="n">dy</span> <span class="p">=</span> 0
        <span class="k">else</span><span class="p">:</span>
            <span class="n">direction</span> <span class="p">=</span> <span class="n">Math</span><span class="p">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dx</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">dy</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">dx</span> <span class="o">-=</span> <span class="n">FRICTION</span> <span class="o">*</span> <span class="n">Math</span><span class="p">.</span><span class="nb">sin</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">dy</span> <span class="o">-=</span> <span class="n">FRICTION</span> <span class="o">*</span> <span class="n">Math</span><span class="p">.</span><span class="nb">cos</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">move</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">shot_delay</span> <span class="o">-=</span> 1

        <span class="n">self</span><span class="p">.</span><span class="n">x</span> <span class="o">+=</span> <span class="n">self</span><span class="p">.</span><span class="n">dx</span>
        <span class="n">self</span><span class="p">.</span><span class="n">y</span> <span class="o">+=</span> <span class="n">self</span><span class="p">.</span><span class="n">dy</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">dx</span> <span class="o">&gt;</span> 0 <span class="nb">and</span> <span class="n">self</span><span class="p">.</span><span class="n">x</span> <span class="o">&gt;</span><span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cx</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">x</span> <span class="o">-=</span> <span class="n">self</span><span class="p">.</span><span class="n">cx</span>
        <span class="n">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">dx</span> <span class="o">&lt;</span> 0 <span class="nb">and</span> <span class="n">self</span><span class="p">.</span><span class="n">x</span> <span class="o">&lt;</span> 0<span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">x</span> <span class="o">+=</span> <span class="n">self</span><span class="p">.</span><span class="n">cx</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">y</span> <span class="o">&gt;</span> 0 <span class="nb">and</span> <span class="n">self</span><span class="p">.</span><span class="n">y</span> <span class="o">&gt;</span><span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cy</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">y</span> <span class="o">-=</span> <span class="n">self</span><span class="p">.</span><span class="n">cy</span>
        <span class="n">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">dy</span> <span class="o">&lt;</span> 0 <span class="nb">and</span> <span class="n">self</span><span class="p">.</span><span class="n">y</span> <span class="o">&lt;</span> 0<span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">y</span> <span class="o">+=</span> <span class="n">self</span><span class="p">.</span><span class="n">cy</span>

    <span class="n">def</span> <span class="nb">reset</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">x</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cx</span><span class="o">/</span>2
        <span class="n">self</span><span class="p">.</span><span class="n">y</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cy</span><span class="o">/</span>2
        <span class="n">self</span><span class="p">.</span><span class="n">dx</span> <span class="p">=</span> 0
        <span class="n">self</span><span class="p">.</span><span class="n">dy</span> <span class="p">=</span> 0
        <span class="n">self</span><span class="p">.</span><span class="n">rot</span> <span class="p">=</span> 0
        <span class="n">self</span><span class="p">.</span><span class="n">shot_delay</span> <span class="p">=</span> 0

<span class="nb">class</span> <span class="n">Model</span><span class="p">:</span>
    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">x</span> <span class="p">=</span> <span class="n">x</span>
        <span class="n">self</span><span class="p">.</span><span class="n">y</span> <span class="p">=</span> <span class="n">y</span>

        <span class="n">self</span><span class="p">.</span><span class="n">num_asteroids</span> <span class="p">=</span> <span class="n">NUM_ASTEROIDS</span>
        <span class="n">self</span><span class="p">.</span><span class="n">ship</span> <span class="p">=</span> <span class="n">Ship</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">start_game</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="nb">view</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="nb">view</span> <span class="p">=</span> <span class="nb">view</span>

    <span class="n">def</span> <span class="n">update</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c"># Make model updates</span>
        <span class="k">for</span> <span class="n">a</span> <span class="n">in</span> <span class="n">self</span><span class="p">.</span><span class="n">asteroids</span><span class="p">:</span>
            <span class="n">a</span><span class="p">.</span><span class="n">move</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">distsq</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">ship</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">ship</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">a</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">radius2</span><span class="p">)):</span>
                <span class="n">self</span><span class="p">.</span><span class="n">destroyShip</span><span class="p">()</span>
                <span class="k">return</span>

        <span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="n">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">shots</span><span class="p">))):</span>
            <span class="k">if</span> <span class="nb">not</span> <span class="n">self</span><span class="p">.</span><span class="n">shots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">move</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="n">shots</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">asteroids</span><span class="p">)</span> <span class="o">==</span> 0<span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">start_next_level</span><span class="p">()</span>
                    <span class="k">return</span>

        <span class="n">self</span><span class="p">.</span><span class="n">ship</span><span class="p">.</span><span class="n">move</span><span class="p">()</span>

        <span class="n">self</span><span class="p">.</span><span class="nb">view</span><span class="p">.</span><span class="n">draw</span><span class="p">()</span>

    <span class="n">def</span> <span class="n">start_next_level</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">num_asteroids</span> <span class="o">+=</span> 1
        <span class="n">self</span><span class="p">.</span><span class="nb">reset</span><span class="p">()</span>

    <span class="n">def</span> <span class="n">destroyShip</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">num_asteroids</span> <span class="p">=</span> <span class="n">NUM_ASTEROIDS</span>
        <span class="n">self</span><span class="p">.</span><span class="nb">reset</span><span class="p">()</span>

    <span class="n">def</span> <span class="nb">reset</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">shots</span> <span class="p">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">asteroids</span> <span class="p">=</span> <span class="p">[</span><span class="n">Asteroid</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">num_asteroids</span><span class="p">)]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">ship</span><span class="p">.</span><span class="nb">reset</span><span class="p">()</span>

    <span class="n">def</span> <span class="n">trigger_fire</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">ship</span><span class="p">.</span><span class="n">shot_delay</span> <span class="o">&gt;</span> 0<span class="p">:</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">shots</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">Shot</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">ship</span><span class="p">))</span>
            <span class="n">self</span><span class="p">.</span><span class="n">ship</span><span class="p">.</span><span class="n">shot_delay</span> <span class="p">=</span> <span class="n">SHOT_DELAY</span>

    <span class="n">def</span> <span class="n">split_asteroid</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="n">a</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">asteroids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">a</span><span class="p">.</span><span class="nb">size</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">(</span><span class="n">ASTEROID_SIZES</span><span class="p">)</span> <span class="o">-</span> 1<span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="n">in</span> <span class="nb">range</span><span class="p">(</span>2<span class="p">):</span>
                <span class="n">self</span><span class="p">.</span><span class="n">asteroids</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">Asteroid</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">a</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">a</span><span class="p">.</span><span class="nb">size</span> <span class="o">+</span> 1<span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">asteroids</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</pre></div>


<h2>D3 TreeMap Example</h2>
<p>Copyright 2013 Pyjeon Software LLC<br/>
Author: Charles Law
License: Creative Commons: Attribution + Noncommerial + ShareAlike  </p>
<h3>TreeMap</h3>
<p>This is an example using the D3.js (Data-Driven Documents) library taken from http://bl.ocks.org/mbostock/4063582.  This example was a test case of the RapydScript decompiler.</p>
<h3>treemap.pyj</h3>
<div class="codehilite"><pre><span class="n">margin</span> <span class="p">=</span> <span class="p">{</span>
    <span class="n">top</span><span class="p">:</span> 40<span class="p">,</span>
    <span class="n">right</span><span class="p">:</span> 10<span class="p">,</span>
    <span class="n">bottom</span><span class="p">:</span> 10<span class="p">,</span>
    <span class="n">left</span><span class="p">:</span> 10
<span class="p">}</span>
<span class="n">width</span> <span class="p">=</span> 960 <span class="o">-</span> <span class="n">margin</span><span class="p">.</span><span class="n">left</span> <span class="o">-</span> <span class="n">margin</span><span class="p">.</span><span class="n">right</span>
<span class="n">height</span> <span class="p">=</span> 500 <span class="o">-</span> <span class="n">margin</span><span class="p">.</span><span class="n">top</span> <span class="o">-</span> <span class="n">margin</span><span class="p">.</span><span class="n">bottom</span>

<span class="n">color</span> <span class="p">=</span> <span class="n">d3</span><span class="p">.</span><span class="n">scale</span><span class="p">.</span><span class="n">category20c</span><span class="p">()</span>

<span class="n">treemap</span> <span class="p">=</span> <span class="n">d3</span><span class="p">.</span><span class="n">layout</span><span class="p">.</span><span class="n">treemap</span><span class="p">().</span><span class="nb">size</span><span class="p">([</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="p">]).</span><span class="n">sticky</span><span class="p">(</span><span class="n">True</span><span class="p">)</span><span class="o">\</span>
        <span class="p">.</span><span class="n">value</span><span class="p">(</span><span class="n">def</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">d</span><span class="p">.</span><span class="nb">size</span>
<span class="p">)</span>

<span class="n">div</span> <span class="p">=</span> <span class="n">d3</span><span class="p">.</span><span class="n">select</span><span class="p">(</span>"<span class="n">body</span>"<span class="p">).</span><span class="n">append</span><span class="p">(</span>"<span class="n">div</span>"<span class="p">).</span><span class="n">style</span><span class="p">(</span>"<span class="n">position</span>"<span class="p">,</span> "<span class="n">relative</span>"<span class="p">)</span><span class="o">.\</span>
    <span class="n">style</span><span class="p">(</span>"<span class="n">width</span>"<span class="p">,</span> <span class="n">width</span> <span class="o">+</span> <span class="n">margin</span><span class="p">.</span><span class="n">left</span> <span class="o">+</span> <span class="n">margin</span><span class="p">.</span><span class="n">right</span> <span class="o">+</span> "<span class="n">px</span>"<span class="p">)</span><span class="o">.\</span>
    <span class="n">style</span><span class="p">(</span>"<span class="n">height</span>"<span class="p">,</span> <span class="n">height</span> <span class="o">+</span> <span class="n">margin</span><span class="p">.</span><span class="n">top</span> <span class="o">+</span> <span class="n">margin</span><span class="p">.</span><span class="n">bottom</span> <span class="o">+</span> "<span class="n">px</span>"<span class="p">)</span><span class="o">.\</span>
    <span class="n">style</span><span class="p">(</span>"<span class="n">left</span>"<span class="p">,</span> <span class="n">margin</span><span class="p">.</span><span class="n">left</span> <span class="o">+</span> "<span class="n">px</span>"<span class="p">).</span><span class="n">style</span><span class="p">(</span>"<span class="n">top</span>"<span class="p">,</span> <span class="n">margin</span><span class="p">.</span><span class="n">top</span> <span class="o">+</span> "<span class="n">px</span>"<span class="p">)</span>

<span class="n">d3</span><span class="p">.</span><span class="n">json</span><span class="p">(</span>"<span class="n">flare</span><span class="p">.</span><span class="n">json</span>"<span class="p">,</span> <span class="n">def</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">root</span><span class="p">):</span>
    <span class="n">node</span> <span class="p">=</span> <span class="n">div</span><span class="p">.</span><span class="n">datum</span><span class="p">(</span><span class="n">root</span><span class="p">).</span><span class="n">selectAll</span><span class="p">(</span>"<span class="p">.</span><span class="n">node</span>"<span class="p">).</span><span class="n">data</span><span class="p">(</span><span class="n">treemap</span><span class="p">.</span><span class="n">nodes</span><span class="p">)</span><span class="o">.\</span>
        <span class="n">enter</span><span class="p">().</span><span class="n">append</span><span class="p">(</span>"<span class="n">div</span>"<span class="p">).</span><span class="n">attr</span><span class="p">(</span>"<span class="n">class</span>"<span class="p">,</span> "<span class="n">node</span>"<span class="p">).</span><span class="n">call</span><span class="p">(</span><span class="n">position</span><span class="p">)</span><span class="o">.\</span>
        <span class="n">style</span><span class="p">(</span>"<span class="n">background</span>"<span class="p">,</span> <span class="n">def</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        #<span class="n">Note</span><span class="p">:</span> <span class="n">This</span> <span class="n">is</span> <span class="n">actually</span> <span class="n">indented</span> 1 <span class="n">level</span> <span class="n">it</span><span class="o">'</span><span class="n">s</span> <span class="n">just</span> <span class="n">not</span> <span class="n">obvious</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">children</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">color</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">None</span>
    <span class="p">).</span><span class="n">text</span><span class="p">(</span><span class="n">def</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">children</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">d</span><span class="p">.</span><span class="n">name</span>
    <span class="p">)</span>
    <span class="n">d3</span><span class="p">.</span><span class="n">selectAll</span><span class="p">(</span>"<span class="n">input</span>"<span class="p">).</span><span class="n">on</span><span class="p">(</span>"<span class="n">change</span>"<span class="p">,</span> <span class="n">def</span> <span class="n">change</span><span class="p">():</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">value</span> <span class="n">is</span> "<span class="n">count</span>"<span class="p">):</span>
            <span class="n">value</span> <span class="p">=</span> <span class="n">def</span><span class="p">():</span>
                <span class="k">return</span> 1
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">d</span><span class="p">.</span><span class="nb">size</span>

        <span class="n">node</span><span class="p">.</span><span class="n">data</span><span class="p">(</span><span class="n">treemap</span><span class="p">.</span><span class="n">value</span><span class="p">(</span><span class="n">value</span><span class="p">).</span><span class="n">nodes</span><span class="p">).</span><span class="n">transition</span><span class="p">().</span><span class="n">duration</span><span class="p">(</span>1500<span class="p">)</span><span class="o">.\</span>
            <span class="n">call</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">def</span> <span class="n">position</span><span class="p">():</span>
    <span class="n">this</span><span class="p">.</span><span class="n">style</span><span class="p">(</span>"<span class="n">left</span>"<span class="p">,</span> <span class="n">def</span><span class="p">(</span><span class="n">d</span><span class="p">):</span> <span class="k">return</span> <span class="n">d</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> "<span class="n">px</span>"
    <span class="p">).</span><span class="n">style</span><span class="p">(</span>"<span class="n">top</span>"<span class="p">,</span> <span class="n">def</span><span class="p">(</span><span class="n">d</span><span class="p">):</span> <span class="k">return</span> <span class="n">d</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> "<span class="n">px</span>"
    <span class="p">).</span><span class="n">style</span><span class="p">(</span>"<span class="n">width</span>"<span class="p">,</span> <span class="n">def</span><span class="p">(</span><span class="n">d</span><span class="p">):</span> <span class="k">return</span> <span class="n">Math</span><span class="p">.</span><span class="n">max</span><span class="p">(</span>0<span class="p">,</span> <span class="n">d</span><span class="p">.</span><span class="n">dx</span> <span class="o">-</span> 1<span class="p">)</span> <span class="o">+</span> "<span class="n">px</span>"
    <span class="p">).</span><span class="n">style</span><span class="p">(</span>"<span class="n">height</span>"<span class="p">,</span> <span class="n">def</span><span class="p">(</span><span class="n">d</span><span class="p">):</span> <span class="k">return</span> <span class="n">Math</span><span class="p">.</span><span class="n">max</span><span class="p">(</span>0<span class="p">,</span> <span class="n">d</span><span class="p">.</span><span class="n">dy</span> <span class="o">-</span> 1<span class="p">)</span> <span class="o">+</span> "<span class="n">px</span>"
    <span class="p">)</span>
</pre></div>


<h2>Paint App Example</h2>
<p>Copyright 2012 Pyjeon Software LLC<br/>
Author: Alexander Tsepkov<br/>
License:    License: Creative Commons: Attribution + Noncommerial + ShareAlike  </p>
<p><img alt="Preview" src="https://bitbucket.org/pyjeon/rapydscript/raw/default/examples/paint/preview.png" title="Preview Screenshot"/></p>
<p>This paint app is meant to showcase RapydScript simplicity and power. It employs multiple features of RapydScript as well as RapydML and RapydCSS, it shows DRY (don't repeat yourself) coding style when writing RapydScript as well as building the webpage itself in RapydML. It uses multiple HTML5 features to cleanly separate CSS, HTML, and JavaScript. This app also showcases RapydScript's ability to integrate with other widgets and frameworks (jQuery, jQuery UI, and Farbtastic widget). It leverages many of JavaScript's design patterns (closures/function generators) while still keeping the code clean, as one would expect in Python. It might be hard to tell from this example alone, but it is also extremely efficient. The paint-bucket algorithm, for example, when implemented in Pyjamas, takes over a second to complete (and only works in Firefox), but is instantaneous here and works in all browsers.</p>
<h3>Drawing.pyj</h3>
<div class="codehilite"><pre><span class="c">######################################################</span>
<span class="c"># Copyright 2012 Pyjeon Software LLC</span>
<span class="c"># Author:   Alexander Tsepkov</span>
<span class="c"># License:  License: Creative Commons: Attribution + Noncommerial + ShareAlike</span>
<span class="c">######################################################</span>

<span class="c"># modes we will be using for drawing</span>
<span class="n">BRUSH</span>   <span class="p">=</span> 0
<span class="n">ERASER</span>  <span class="p">=</span> 1
<span class="n">LINE</span>    <span class="p">=</span> 2
<span class="n">SELECT</span>  <span class="p">=</span> 3
<span class="n">COLORSELECT</span> <span class="p">=</span> 4
<span class="n">LASSO</span>   <span class="p">=</span> 5
<span class="n">RECT</span>    <span class="p">=</span> 6
<span class="n">ELLIPSE</span> <span class="p">=</span> 7
<span class="n">SAMPLER</span> <span class="p">=</span> 8
<span class="n">BUCKET</span>  <span class="p">=</span> 9
<span class="n">TEXT</span>    <span class="p">=</span> 10

<span class="c"># misc</span>
<span class="n">X</span>       <span class="p">=</span> 0
<span class="n">Y</span>       <span class="p">=</span> 1
<span class="n">CLICK</span>   <span class="p">=</span> 1
<span class="n">RCLICK</span>  <span class="p">=</span> 3

<span class="nb">class</span> <span class="n">Drawing</span><span class="p">:</span>
    <span class="s">"""</span>
<span class="s">    Controls the currently displayed image, and handles undo/redo logic</span>
<span class="s">    """</span>
    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>

        <span class="c"># these are meant to be private</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_canvas</span> <span class="p">=</span> $<span class="p">(</span><span class="s">'#perm-dwg'</span><span class="p">).</span><span class="k">get</span><span class="p">(</span>0<span class="p">)</span>        <span class="c"># get actual DOM element</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_ctx</span> <span class="p">=</span> <span class="n">ctx</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_canvas</span><span class="p">.</span><span class="n">getContext</span><span class="p">(</span><span class="s">'2d'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_undoStack</span> <span class="p">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_redoStack</span> <span class="p">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_fillColor</span> <span class="p">=</span> <span class="n">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_strokeColor</span> <span class="p">=</span> <span class="n">None</span>

        <span class="c"># and these are not exposed at all</span>
        $<span class="n">tmpCanvas</span> <span class="p">=</span> $<span class="p">(</span><span class="s">'#temp-dwg'</span><span class="p">)</span>
        <span class="n">tmpCanvas</span> <span class="p">=</span> $<span class="n">tmpCanvas</span><span class="p">.</span><span class="k">get</span><span class="p">(</span>0<span class="p">)</span>
        <span class="n">tmpCtx</span> <span class="p">=</span> <span class="n">tmpCanvas</span><span class="p">.</span><span class="n">getContext</span><span class="p">(</span><span class="s">'2d'</span><span class="p">)</span>
        <span class="n">canvasWidth</span> <span class="p">=</span> <span class="n">tmpCanvas</span><span class="p">.</span><span class="n">width</span>
        <span class="n">canvasHeight</span> <span class="p">=</span> <span class="n">tmpCanvas</span><span class="p">.</span><span class="n">height</span>

        <span class="n">dragging</span> <span class="p">=</span> <span class="n">False</span>
        <span class="n">points</span> <span class="p">=</span> <span class="p">[]</span>
        <span class="n">selection</span> <span class="p">=</span> <span class="n">None</span>
        <span class="n">lastPt</span> <span class="p">=</span> <span class="p">[</span>0<span class="p">,</span> 0<span class="p">]</span>
        <span class="n">transparent_bg</span> <span class="p">=</span> <span class="n">True</span>

        <span class="c">#################</span>
        <span class="c"># utility functions</span>
        <span class="c">#################</span>
        <span class="n">getXY</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
            <span class="c"># +0.5 allows us to snap to the center of the pixel, preventing interpolation and</span>
            <span class="c"># making our images more crisp</span>
            <span class="n">absolute</span> <span class="p">=</span> $<span class="p">(</span><span class="n">obj</span><span class="p">).</span><span class="n">offset</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">event</span><span class="p">.</span><span class="n">pageX</span> <span class="o">-</span> <span class="n">absolute</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="n">event</span><span class="p">.</span><span class="n">pageY</span> <span class="o">-</span> <span class="n">absolute</span><span class="p">.</span><span class="n">top</span>
        <span class="n">normalize</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">width</span> <span class="o">&lt;</span> 0<span class="p">:</span>
                <span class="n">width</span> <span class="p">=</span> <span class="o">-</span><span class="n">width</span>
                <span class="n">x</span> <span class="p">=</span> <span class="n">x</span><span class="o">-</span><span class="n">width</span>
            <span class="k">if</span> <span class="n">height</span> <span class="o">&lt;</span> 0<span class="p">:</span>
                <span class="n">height</span> <span class="p">=</span> <span class="o">-</span><span class="n">height</span>
                <span class="n">y</span> <span class="p">=</span> <span class="n">y</span><span class="o">-</span><span class="n">height</span>
            <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span>
        <span class="n">ellipse</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">):</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="p">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
            <span class="n">ctrX</span> <span class="p">=</span> <span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">x</span><span class="o">+</span><span class="n">width</span><span class="p">)</span><span class="o">/</span>2
            <span class="n">ctrY</span> <span class="p">=</span> <span class="p">(</span><span class="n">y</span><span class="o">+</span><span class="n">y</span><span class="o">+</span><span class="n">height</span><span class="p">)</span><span class="o">/</span>2
            <span class="n">circ</span> <span class="p">=</span> <span class="n">Math</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
            <span class="n">scaleX</span> <span class="p">=</span> <span class="n">width</span><span class="o">/</span><span class="n">circ</span>
            <span class="n">scaleY</span> <span class="p">=</span> <span class="n">height</span><span class="o">/</span><span class="n">circ</span>
            <span class="n">context</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">context</span><span class="p">.</span><span class="n">translate</span><span class="p">(</span><span class="n">ctrX</span><span class="p">,</span> <span class="n">ctrY</span><span class="p">)</span>
            <span class="n">context</span><span class="p">.</span><span class="n">scale</span><span class="p">(</span><span class="n">scaleX</span><span class="p">,</span> <span class="n">scaleY</span><span class="p">)</span>
            <span class="n">context</span><span class="p">.</span><span class="n">arc</span><span class="p">(</span>0<span class="p">,</span> 0<span class="p">,</span> <span class="n">circ</span><span class="o">/</span>2<span class="p">,</span> 0<span class="p">,</span> 2<span class="o">*</span><span class="n">Math</span><span class="p">.</span><span class="n">PI</span><span class="p">)</span>
            <span class="n">context</span><span class="p">.</span><span class="n">restore</span><span class="p">()</span>
        <span class="n">drawSpline</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">lastPoint</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">lastPoint</span> <span class="n">is</span> <span class="n">undefined</span><span class="p">:</span>
                <span class="n">lastPoint</span> <span class="p">=</span> <span class="n">points</span><span class="p">[</span><span class="n">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span><span class="o">-</span>1<span class="p">]</span>
            <span class="n">context</span><span class="p">.</span><span class="n">beginPath</span><span class="p">()</span>
            <span class="n">context</span><span class="p">.</span><span class="n">moveTo</span><span class="p">(</span><span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">X</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">Y</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">==</span> 1<span class="p">:</span>
                <span class="n">context</span><span class="p">.</span><span class="n">lineTo</span><span class="p">(</span><span class="n">lastPoint</span><span class="p">[</span><span class="n">X</span><span class="p">],</span> <span class="n">lastPoint</span><span class="p">[</span><span class="n">Y</span><span class="p">])</span>
            <span class="n">elif</span> <span class="n">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">==</span> 2<span class="p">:</span>
                <span class="n">context</span><span class="p">.</span><span class="n">quadraticCurveTo</span><span class="p">(</span><span class="n">points</span><span class="p">[</span>1<span class="p">][</span><span class="n">X</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span>1<span class="p">][</span><span class="n">Y</span><span class="p">],</span> <span class="n">lastPoint</span><span class="p">[</span><span class="n">X</span><span class="p">],</span> <span class="n">lastPoint</span><span class="p">[</span><span class="n">Y</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">context</span><span class="p">.</span><span class="n">bezierCurveTo</span><span class="p">(</span><span class="o">\</span>
                    <span class="n">points</span><span class="p">[</span>1<span class="p">][</span><span class="n">X</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span>1<span class="p">][</span><span class="n">Y</span><span class="p">],</span> <span class="o">\</span>
                    <span class="n">points</span><span class="p">[</span>2<span class="p">][</span><span class="n">X</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span>2<span class="p">][</span><span class="n">Y</span><span class="p">],</span> <span class="o">\</span>
                    <span class="n">lastPoint</span><span class="p">[</span><span class="n">X</span><span class="p">],</span> <span class="n">lastPoint</span><span class="p">[</span><span class="n">Y</span><span class="p">])</span>
            <span class="n">context</span><span class="p">.</span><span class="n">stroke</span><span class="p">()</span>
        <span class="n">sample</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">click</span><span class="p">):</span>
            <span class="n">data</span> <span class="p">=</span> <span class="n">ctx</span><span class="p">.</span><span class="n">getImageData</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> 1<span class="p">,</span> 1<span class="p">).</span><span class="n">data</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span>3<span class="p">]:</span>
                <span class="n">color</span> <span class="p">=</span> <span class="s">'rgb('</span><span class="o">+</span><span class="n">data</span><span class="p">[</span>0<span class="p">]</span><span class="o">+</span><span class="s">','</span><span class="o">+</span><span class="n">data</span><span class="p">[</span>1<span class="p">]</span><span class="o">+</span><span class="s">','</span><span class="o">+</span><span class="n">data</span><span class="p">[</span>2<span class="p">]</span><span class="o">+</span><span class="s">')'</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">color</span> <span class="p">=</span> <span class="s">'transparent'</span>
            <span class="k">if</span> <span class="n">click</span> <span class="o">==</span> <span class="n">CLICK</span><span class="p">:</span>
                <span class="n">tag</span> <span class="p">=</span> <span class="s">'#stroke'</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tag</span> <span class="p">=</span> <span class="s">'#fill'</span>

            <span class="k">if</span> <span class="n">color</span> <span class="o">==</span> <span class="s">'transparent'</span><span class="p">:</span>
                <span class="n">color</span> <span class="p">=</span> <span class="n">None</span>
                $<span class="p">(</span><span class="n">tag</span><span class="p">).</span><span class="n">css</span><span class="p">(</span><span class="s">'background'</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                $<span class="p">(</span><span class="n">tag</span><span class="p">).</span><span class="n">css</span><span class="p">(</span><span class="s">'background'</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">click</span> <span class="o">==</span> <span class="n">CLICK</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_brushColor</span> <span class="p">=</span> <span class="n">color</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_fillColor</span> <span class="p">=</span> <span class="n">color</span>
        <span class="n">matchStartColor</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">colorLayer</span><span class="p">,</span> <span class="n">pixelPos</span><span class="p">,</span> <span class="n">startPixel</span><span class="p">):</span>
            <span class="n">r</span> <span class="p">=</span> <span class="n">colorLayer</span><span class="p">[</span><span class="n">pixelPos</span><span class="p">]</span>
            <span class="n">g</span> <span class="p">=</span> <span class="n">colorLayer</span><span class="p">[</span><span class="n">pixelPos</span><span class="o">+</span>1<span class="p">]</span>
            <span class="n">b</span> <span class="p">=</span> <span class="n">colorLayer</span><span class="p">[</span><span class="n">pixelPos</span><span class="o">+</span>2<span class="p">]</span>
            <span class="n">a</span> <span class="p">=</span> <span class="n">colorLayer</span><span class="p">[</span><span class="n">pixelPos</span><span class="o">+</span>3<span class="p">]</span>
            <span class="k">return</span> <span class="n">r</span> <span class="o">==</span> <span class="n">startPixel</span><span class="p">[</span>0<span class="p">]</span> <span class="nb">and</span> <span class="n">g</span> <span class="o">==</span> <span class="n">startPixel</span><span class="p">[</span>1<span class="p">]</span> <span class="nb">and</span> <span class="o">\</span>
                    <span class="n">b</span> <span class="o">==</span> <span class="n">startPixel</span><span class="p">[</span>2<span class="p">]</span> <span class="nb">and</span> <span class="n">bool</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="n">bool</span><span class="p">(</span><span class="n">startPixel</span><span class="p">[</span>3<span class="p">])</span>
        <span class="n">eachPixel</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">imageData</span><span class="p">,</span> <span class="n">callback</span><span class="p">):</span>
            <span class="n">offset</span> <span class="p">=</span> 0
            <span class="nb">length</span> <span class="p">=</span> <span class="n">imageData</span><span class="p">.</span><span class="n">height</span> <span class="o">*</span> <span class="n">imageData</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> 4
            <span class="k">while</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="nb">length</span><span class="p">:</span>
                <span class="n">callback</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
                <span class="n">offset</span> <span class="o">+=</span> 4
        <span class="n">self</span><span class="p">.</span><span class="n">_clear</span> <span class="p">=</span> <span class="n">clear</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
            <span class="n">context</span><span class="p">.</span><span class="n">clearRect</span><span class="p">(</span>0<span class="p">,</span> 0<span class="p">,</span> <span class="n">canvasWidth</span><span class="p">,</span> <span class="n">canvasHeight</span><span class="p">)</span>

        <span class="c">#################</span>
        <span class="c"># user input</span>
        <span class="c">#################</span>
        <span class="n">onMouseDown</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">nonlocal</span> <span class="n">dragging</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">lastPt</span><span class="p">,</span> <span class="n">selection</span>

            <span class="n">event</span><span class="p">.</span><span class="n">preventDefault</span><span class="p">()</span>  <span class="c"># prevents change to mouse cursor</span>
            <span class="n">dragging</span> <span class="p">=</span> <span class="n">True</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="p">=</span> <span class="n">getXY</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_undoStack</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">getImageData</span><span class="p">(</span>0<span class="p">,</span> 0<span class="p">,</span> <span class="n">canvasWidth</span><span class="p">,</span> <span class="n">canvasHeight</span><span class="p">))</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_redoStack</span> <span class="p">=</span> <span class="p">[]</span>
            <span class="n">ctx</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">tmpCtx</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_mode</span> <span class="n">in</span> <span class="p">[</span><span class="n">BRUSH</span><span class="p">,</span> <span class="n">ERASER</span><span class="p">]:</span>
                <span class="n">ctx</span><span class="p">.</span><span class="n">lineWidth</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_lineWidth</span>
                <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="n">BRUSH</span><span class="p">:</span>
                    <span class="n">ctx</span><span class="p">.</span><span class="n">strokeStyle</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_brushColor</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ctx</span><span class="p">.</span><span class="n">globalCompositeOperation</span> <span class="p">=</span> <span class="s">'destination-out'</span>
                <span class="n">ctx</span><span class="p">.</span><span class="n">beginPath</span><span class="p">()</span>
                <span class="n">ctx</span><span class="p">.</span><span class="n">moveTo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">_mode</span> <span class="n">in</span> <span class="p">[</span><span class="n">RECT</span><span class="p">,</span> <span class="n">ELLIPSE</span><span class="p">]:</span>
                <span class="n">tmpCtx</span><span class="p">.</span><span class="n">lineWidth</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_lineWidth</span>
                <span class="n">tmpCtx</span><span class="p">.</span><span class="n">strokeStyle</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_brushColor</span>
                <span class="n">tmpCtx</span><span class="p">.</span><span class="n">fillStyle</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_fillColor</span>
                <span class="n">points</span><span class="p">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>
            <span class="n">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="n">LINE</span><span class="p">:</span>
                <span class="n">tmpCtx</span><span class="p">.</span><span class="n">lineWidth</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_lineWidth</span>
                <span class="n">tmpCtx</span><span class="p">.</span><span class="n">strokeStyle</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_brushColor</span>
                <span class="n">points</span><span class="p">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>
            <span class="n">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="n">SAMPLER</span><span class="p">:</span>
                <span class="n">sample</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">event</span><span class="p">.</span><span class="n">which</span><span class="p">)</span>
            <span class="n">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="n">BUCKET</span> <span class="nb">and</span> <span class="n">self</span><span class="p">.</span><span class="n">_fillColor</span><span class="p">:</span>
                <span class="c"># paint-bucket algorithm based on one from this website:</span>
                <span class="c"># http://www.williammalone.com/articles/html5-canvas-javascript-paint-bucket-tool/</span>
                <span class="n">pixelStack</span> <span class="p">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)]</span>
                <span class="n">colorLayer</span> <span class="p">=</span> <span class="n">ctx</span><span class="p">.</span><span class="n">getImageData</span><span class="p">(</span>0<span class="p">,</span> 0<span class="p">,</span> <span class="n">canvasWidth</span><span class="p">,</span> <span class="n">canvasHeight</span><span class="p">)</span>
                <span class="n">data</span> <span class="p">=</span> <span class="n">colorLayer</span><span class="p">.</span><span class="n">data</span>
                <span class="n">startPixel</span> <span class="p">=</span> <span class="n">ctx</span><span class="p">.</span><span class="n">getImageData</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> 1<span class="p">,</span> 1<span class="p">).</span><span class="n">data</span>

                <span class="c"># convert swatch color to imageData (we're using canvas to avoid dealing with literal</span>
                <span class="c"># color names like 'aquamarine')</span>
                <span class="n">tmpCtx</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">tmpCtx</span><span class="p">.</span><span class="n">fillStyle</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_fillColor</span>
                <span class="n">locX</span><span class="p">,</span> <span class="n">locY</span> <span class="p">=</span> 50<span class="p">,</span> 50 <span class="c"># pick point far enough from the corner so it's not affected by border style</span>
                <span class="n">tmpCtx</span><span class="p">.</span><span class="n">fillRect</span><span class="p">(</span><span class="n">locX</span><span class="p">,</span> <span class="n">locY</span><span class="p">,</span> 1<span class="p">,</span> 1<span class="p">)</span>
                <span class="n">swatchPixel</span> <span class="p">=</span> <span class="n">tmpCtx</span><span class="p">.</span><span class="n">getImageData</span><span class="p">(</span><span class="n">locX</span><span class="p">,</span> <span class="n">locY</span><span class="p">,</span> 1<span class="p">,</span> 1<span class="p">).</span><span class="n">data</span>
                <span class="n">tmpCtx</span><span class="p">.</span><span class="n">clearRect</span><span class="p">(</span><span class="n">locX</span><span class="p">,</span> <span class="n">locY</span><span class="p">,</span> 1<span class="p">,</span> 1<span class="p">)</span>
                <span class="n">tmpCtx</span><span class="p">.</span><span class="n">restore</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">not</span> <span class="n">matchStartColor</span><span class="p">(</span><span class="n">swatchPixel</span><span class="p">,</span> 0<span class="p">,</span> <span class="n">startPixel</span><span class="p">):</span>
                    <span class="k">while</span> <span class="n">len</span><span class="p">(</span><span class="n">pixelStack</span><span class="p">):</span>
                        <span class="n">newPos</span> <span class="p">=</span> <span class="n">pixelStack</span><span class="p">.</span><span class="n">pop</span><span class="p">()</span>
                        <span class="n">x</span> <span class="p">=</span> <span class="n">newPos</span><span class="p">[</span><span class="n">X</span><span class="p">]</span>
                        <span class="n">y</span> <span class="p">=</span> <span class="n">newPos</span><span class="p">[</span><span class="n">Y</span><span class="p">]</span>
                        <span class="n">pixelPos</span> <span class="p">=</span> <span class="p">(</span><span class="n">y</span><span class="o">*</span><span class="n">canvasWidth</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span><span class="o">*</span>4
                        <span class="k">while</span> <span class="n">y</span> <span class="o">&gt;</span><span class="p">=</span> 0 <span class="nb">and</span> <span class="n">matchStartColor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pixelPos</span><span class="p">,</span> <span class="n">startPixel</span><span class="p">):</span>
                            <span class="n">y</span> <span class="o">-=</span> 1
                            <span class="n">pixelPos</span> <span class="o">-=</span> <span class="n">canvasWidth</span><span class="o">*</span>4
                        <span class="n">pixelPos</span> <span class="o">+=</span> <span class="n">canvasWidth</span><span class="o">*</span>4
                        <span class="n">y</span> <span class="o">+=</span> 1
                        <span class="n">reachLeft</span> <span class="p">=</span> <span class="n">False</span>
                        <span class="n">reachRight</span> <span class="p">=</span> <span class="n">False</span>
                        <span class="k">while</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">canvasHeight</span><span class="o">-</span>1 <span class="nb">and</span> <span class="n">matchStartColor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pixelPos</span><span class="p">,</span> <span class="n">startPixel</span><span class="p">):</span>
                            <span class="n">y</span> <span class="o">+=</span> 1
                            <span class="n">data</span><span class="p">[</span><span class="n">pixelPos</span><span class="p">]</span> <span class="p">=</span> <span class="n">swatchPixel</span><span class="p">[</span>0<span class="p">]</span>
                            <span class="n">data</span><span class="p">[</span><span class="n">pixelPos</span><span class="o">+</span>1<span class="p">]</span> <span class="p">=</span> <span class="n">swatchPixel</span><span class="p">[</span>1<span class="p">]</span>
                            <span class="n">data</span><span class="p">[</span><span class="n">pixelPos</span><span class="o">+</span>2<span class="p">]</span> <span class="p">=</span> <span class="n">swatchPixel</span><span class="p">[</span>2<span class="p">]</span>
                            <span class="n">data</span><span class="p">[</span><span class="n">pixelPos</span><span class="o">+</span>3<span class="p">]</span> <span class="p">=</span> <span class="n">swatchPixel</span><span class="p">[</span>3<span class="p">]</span>
                            <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> 0<span class="p">:</span>
                                <span class="k">if</span> <span class="n">matchStartColor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pixelPos</span><span class="o">-</span>4<span class="p">,</span> <span class="n">startPixel</span><span class="p">):</span>
                                    <span class="k">if</span> <span class="nb">not</span> <span class="n">reachLeft</span><span class="p">:</span>
                                        <span class="n">pixelStack</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="o">-</span>1<span class="p">,</span> <span class="n">y</span><span class="p">))</span>
                                        <span class="n">reachLeft</span> <span class="p">=</span> <span class="n">True</span>
                                <span class="n">elif</span> <span class="n">reachLeft</span><span class="p">:</span>
                                    <span class="n">reachLeft</span> <span class="p">=</span> <span class="n">False</span>
                            <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">canvasWidth</span><span class="o">-</span>1<span class="p">:</span>
                                <span class="k">if</span> <span class="n">matchStartColor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pixelPos</span><span class="o">+</span>4<span class="p">,</span> <span class="n">startPixel</span><span class="p">):</span>
                                    <span class="k">if</span> <span class="nb">not</span> <span class="n">reachRight</span><span class="p">:</span>
                                        <span class="n">pixelStack</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="o">+</span>1<span class="p">,</span> <span class="n">y</span><span class="p">))</span>
                                <span class="n">elif</span> <span class="n">reachRight</span><span class="p">:</span>
                                    <span class="n">reachRight</span> <span class="p">=</span> <span class="n">False</span>
                            <span class="n">pixelPos</span> <span class="o">+=</span> <span class="n">canvasWidth</span><span class="o">*</span>4
                    <span class="n">ctx</span><span class="p">.</span><span class="n">putImageData</span><span class="p">(</span><span class="n">colorLayer</span><span class="p">,</span> 0<span class="p">,</span> 0<span class="p">)</span>
            <span class="n">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="n">SELECT</span><span class="p">:</span>
                <span class="n">lastPt</span> <span class="p">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">selection</span> <span class="n">is</span> <span class="n">None</span><span class="p">:</span>
                    <span class="n">tmpCtx</span><span class="p">.</span><span class="n">lineWidth</span> <span class="p">=</span> 1
                    <span class="n">tmpCtx</span><span class="p">.</span><span class="n">strokeStyle</span> <span class="p">=</span> <span class="s">'rgb(0,255,0)'</span>
                    <span class="n">points</span><span class="p">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>
                <span class="n">elif</span> <span class="nb">not</span> <span class="p">(</span><span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">X</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x</span> <span class="nb">and</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">points</span><span class="p">[</span>1<span class="p">][</span><span class="n">X</span><span class="p">]</span> <span class="o">\</span>
                <span class="nb">and</span> <span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">Y</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">y</span> <span class="nb">and</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">points</span><span class="p">[</span>1<span class="p">][</span><span class="n">Y</span><span class="p">]):</span>
                    <span class="c"># we just deselected our selection, dump it back to main canvas</span>
                    <span class="k">if</span> <span class="n">transparent_bg</span><span class="p">:</span>
                        <span class="c"># background is transparent, merge two images together</span>
                        <span class="n">tmp</span> <span class="p">=</span> <span class="n">ctx</span><span class="p">.</span><span class="n">getImageData</span><span class="p">(</span><span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">X</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">Y</span><span class="p">],</span> <span class="o">\</span>
                            <span class="n">points</span><span class="p">[</span>1<span class="p">][</span><span class="n">X</span><span class="p">]</span><span class="o">-</span><span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">X</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span>1<span class="p">][</span><span class="n">Y</span><span class="p">]</span><span class="o">-</span><span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">Y</span><span class="p">]).</span><span class="n">data</span>
                        <span class="n">data</span> <span class="p">=</span> <span class="n">selection</span><span class="p">.</span><span class="n">data</span>
                        <span class="nb">merge</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">offset</span><span class="p">):</span>
                            <span class="k">if</span> <span class="nb">not</span> <span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span>3<span class="p">]:</span>
                                <span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="p">=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span>
                                <span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span>1<span class="p">]</span> <span class="p">=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span>1<span class="p">]</span>
                                <span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span>2<span class="p">]</span> <span class="p">=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span>2<span class="p">]</span>
                                <span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span>3<span class="p">]</span> <span class="p">=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span>3<span class="p">]</span>
                        <span class="n">eachPixel</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="nb">merge</span><span class="p">)</span>
                    <span class="n">ctx</span><span class="p">.</span><span class="n">putImageData</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">X</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">Y</span><span class="p">])</span>
                    <span class="n">clear</span><span class="p">(</span><span class="n">tmpCtx</span><span class="p">)</span>
                    <span class="n">selection</span> <span class="p">=</span> <span class="n">None</span>
                    <span class="n">points</span> <span class="p">=</span> <span class="p">[[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]]</span>

        <span class="n">onMouseMove</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">nonlocal</span> <span class="n">lastPt</span>

            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="n">LINE</span> <span class="nb">and</span> <span class="n">len</span><span class="p">(</span><span class="n">points</span><span class="p">):</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="p">=</span> <span class="n">getXY</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
                <span class="n">clear</span><span class="p">(</span><span class="n">tmpCtx</span><span class="p">)</span>
                <span class="n">drawSpline</span><span class="p">(</span><span class="n">tmpCtx</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
            <span class="n">elif</span> <span class="n">dragging</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="p">=</span> <span class="n">getXY</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_mode</span> <span class="n">in</span> <span class="p">[</span><span class="n">BRUSH</span><span class="p">,</span> <span class="n">ERASER</span><span class="p">]:</span>
                    <span class="n">ctx</span><span class="p">.</span><span class="n">lineTo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                    <span class="n">ctx</span><span class="p">.</span><span class="n">stroke</span><span class="p">()</span>
                <span class="n">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">_mode</span> <span class="n">in</span> <span class="p">[</span><span class="n">RECT</span><span class="p">,</span> <span class="n">ELLIPSE</span><span class="p">]:</span>
                    <span class="n">clear</span><span class="p">(</span><span class="n">tmpCtx</span><span class="p">)</span>
                    <span class="n">tmpCtx</span><span class="p">.</span><span class="n">beginPath</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="n">RECT</span><span class="p">:</span>
                        <span class="n">tmpCtx</span><span class="p">.</span><span class="n">rect</span><span class="p">(</span><span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">X</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">Y</span><span class="p">],</span> <span class="n">x</span><span class="o">-</span><span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">X</span><span class="p">],</span> <span class="n">y</span><span class="o">-</span><span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">Y</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ellipse</span><span class="p">(</span><span class="n">tmpCtx</span><span class="p">,</span> <span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">X</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">Y</span><span class="p">],</span> <span class="n">x</span><span class="o">-</span><span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">X</span><span class="p">],</span> <span class="n">y</span><span class="o">-</span><span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">Y</span><span class="p">])</span>

                    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_fillColor</span> <span class="n">is</span> <span class="nb">not</span> <span class="n">None</span><span class="p">:</span>
                        <span class="n">tmpCtx</span><span class="p">.</span><span class="nb">fill</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_brushColor</span> <span class="n">is</span> <span class="nb">not</span> <span class="n">None</span><span class="p">:</span>
                        <span class="n">tmpCtx</span><span class="p">.</span><span class="n">stroke</span><span class="p">()</span>
                <span class="n">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="n">SAMPLER</span><span class="p">:</span>
                    <span class="n">sample</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">event</span><span class="p">.</span><span class="n">which</span><span class="p">)</span>
                <span class="n">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="n">SELECT</span><span class="p">:</span>
                    <span class="n">clear</span><span class="p">(</span><span class="n">tmpCtx</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">selection</span> <span class="n">is</span> <span class="nb">not</span> <span class="n">None</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">point</span> <span class="n">in</span> <span class="n">points</span><span class="p">:</span>
                            <span class="n">point</span><span class="p">[</span>0<span class="p">]</span> <span class="o">+=</span> <span class="n">x</span><span class="o">-</span><span class="n">lastPt</span><span class="p">[</span><span class="n">X</span><span class="p">]</span>
                            <span class="n">point</span><span class="p">[</span>1<span class="p">]</span> <span class="o">+=</span> <span class="n">y</span><span class="o">-</span><span class="n">lastPt</span><span class="p">[</span><span class="n">Y</span><span class="p">]</span>
                        <span class="n">lastPt</span> <span class="p">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>
                        <span class="n">x</span> <span class="p">=</span> <span class="n">points</span><span class="p">[</span>1<span class="p">][</span><span class="n">X</span><span class="p">]</span>
                        <span class="n">y</span> <span class="p">=</span> <span class="n">points</span><span class="p">[</span>1<span class="p">][</span><span class="n">Y</span><span class="p">]</span>
                        <span class="n">tmpCtx</span><span class="p">.</span><span class="n">putImageData</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">X</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">Y</span><span class="p">])</span>
                    <span class="n">tmpCtx</span><span class="p">.</span><span class="n">strokeRect</span><span class="p">(</span><span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">X</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">Y</span><span class="p">],</span> <span class="n">x</span><span class="o">-</span><span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">X</span><span class="p">],</span> <span class="n">y</span><span class="o">-</span><span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">Y</span><span class="p">])</span>

        <span class="n">onMouseUp</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">nonlocal</span> <span class="n">dragging</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">selection</span>

            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_mode</span> <span class="n">in</span> <span class="p">[</span><span class="n">RECT</span><span class="p">,</span> <span class="n">ELLIPSE</span><span class="p">]:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="p">=</span> <span class="n">getXY</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
                <span class="n">ctx</span><span class="p">.</span><span class="n">beginPath</span><span class="p">()</span>
                <span class="n">ctx</span><span class="p">.</span><span class="n">lineWidth</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_lineWidth</span>
                <span class="n">ctx</span><span class="p">.</span><span class="n">strokeStyle</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_brushColor</span>
                <span class="n">ctx</span><span class="p">.</span><span class="n">fillStyle</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_fillColor</span>
                <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="n">RECT</span><span class="p">:</span>
                    <span class="n">ctx</span><span class="p">.</span><span class="n">rect</span><span class="p">(</span><span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">X</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">Y</span><span class="p">],</span> <span class="n">x</span><span class="o">-</span><span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">X</span><span class="p">],</span> <span class="n">y</span><span class="o">-</span><span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">Y</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ellipse</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">X</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">Y</span><span class="p">],</span> <span class="n">x</span><span class="o">-</span><span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">X</span><span class="p">],</span> <span class="n">y</span><span class="o">-</span><span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">Y</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_fillColor</span> <span class="n">is</span> <span class="nb">not</span> <span class="n">None</span><span class="p">:</span>
                    <span class="n">ctx</span><span class="p">.</span><span class="nb">fill</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_brushColor</span> <span class="n">is</span> <span class="nb">not</span> <span class="n">None</span><span class="p">:</span>
                    <span class="n">ctx</span><span class="p">.</span><span class="n">stroke</span><span class="p">()</span>
            <span class="n">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="n">LINE</span> <span class="nb">and</span> <span class="n">event</span><span class="p">.</span><span class="n">which</span> <span class="o">==</span> <span class="n">CLICK</span> <span class="nb">and</span> <span class="n">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">&gt;</span> 1<span class="p">:</span>
                <span class="n">ctx</span><span class="p">.</span><span class="n">lineWidth</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_lineWidth</span>
                <span class="n">ctx</span><span class="p">.</span><span class="n">strokeStyle</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_brushColor</span>
                <span class="n">drawSpline</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
            <span class="n">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="n">SELECT</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="p">=</span> <span class="n">getXY</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">selection</span> <span class="n">is</span> <span class="n">None</span> <span class="nb">and</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">X</span><span class="p">]</span> <span class="nb">and</span> <span class="n">y</span> <span class="o">!=</span> <span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">Y</span><span class="p">]:</span>
                    <span class="c"># we just selected something</span>
                    <span class="n">sx</span> <span class="p">=</span> <span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">X</span><span class="p">]</span>
                    <span class="n">sy</span> <span class="p">=</span> <span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">Y</span><span class="p">]</span>
                    <span class="n">width</span> <span class="p">=</span> <span class="n">x</span><span class="o">-</span><span class="n">sx</span>
                    <span class="n">height</span> <span class="p">=</span> <span class="n">y</span><span class="o">-</span><span class="n">sy</span>
                    <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="p">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
                    <span class="n">points</span> <span class="p">=</span> <span class="p">[[</span><span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">]]</span>
                    <span class="n">x</span> <span class="p">=</span> <span class="n">sx</span><span class="o">+</span><span class="n">width</span>
                    <span class="n">y</span> <span class="p">=</span> <span class="n">sy</span><span class="o">+</span><span class="n">height</span>
                    <span class="n">selection</span> <span class="p">=</span> <span class="n">ctx</span><span class="p">.</span><span class="n">getImageData</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
                    <span class="n">ctx</span><span class="p">.</span><span class="n">clearRect</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
                    <span class="n">tmpCtx</span><span class="p">.</span><span class="n">putImageData</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">X</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">Y</span><span class="p">])</span>
                    <span class="n">tmpCtx</span><span class="p">.</span><span class="n">strokeRect</span><span class="p">(</span><span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">X</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">Y</span><span class="p">],</span> <span class="n">x</span><span class="o">-</span><span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">X</span><span class="p">],</span> <span class="n">y</span><span class="o">-</span><span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">Y</span><span class="p">])</span>
                    <span class="n">points</span><span class="p">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>

            <span class="n">dragging</span> <span class="p">=</span> <span class="n">False</span>
            <span class="n">ctx</span><span class="p">.</span><span class="n">restore</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">not</span> <span class="n">selection</span> <span class="nb">or</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">X</span><span class="p">]</span> <span class="nb">and</span> <span class="n">y</span> <span class="o">==</span> <span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">Y</span><span class="p">]))</span> <span class="o">\</span>
            <span class="nb">and</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_mode</span> <span class="o">!=</span> <span class="n">LINE</span> <span class="nb">or</span> <span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">which</span> <span class="o">==</span> <span class="n">CLICK</span> <span class="nb">and</span> <span class="n">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">&gt;</span> 1<span class="p">)):</span>
                <span class="n">points</span> <span class="p">=</span> <span class="p">[]</span>
                <span class="n">clear</span><span class="p">(</span><span class="n">tmpCtx</span><span class="p">)</span>
                <span class="n">tmpCtx</span><span class="p">.</span><span class="n">restore</span><span class="p">()</span>

        <span class="c"># to be used by selection manipulation filters</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_filter</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">callback</span><span class="p">):</span>
            <span class="n">nonlocal</span> <span class="n">selection</span>
            <span class="k">if</span> <span class="n">selection</span><span class="p">:</span>
                <span class="n">pixels</span> <span class="p">=</span> <span class="n">selection</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pixels</span> <span class="p">=</span> <span class="n">ctx</span><span class="p">.</span><span class="n">getImageData</span><span class="p">(</span>0<span class="p">,</span> 0<span class="p">,</span> <span class="n">canvasWidth</span><span class="p">,</span> <span class="n">canvasHeight</span><span class="p">)</span>
            <span class="n">data</span> <span class="p">=</span> <span class="n">pixels</span><span class="p">.</span><span class="n">data</span>
            <span class="n">invoke</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">offset</span><span class="p">):</span>
                <span class="n">callback</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
            <span class="n">eachPixel</span><span class="p">(</span><span class="n">pixels</span><span class="p">,</span> <span class="n">invoke</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">selection</span><span class="p">:</span>
                <span class="n">clear</span><span class="p">(</span><span class="n">tmpCtx</span><span class="p">)</span>
                <span class="n">tmpCtx</span><span class="p">.</span><span class="n">putImageData</span><span class="p">(</span><span class="n">pixels</span><span class="p">,</span> <span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">X</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">Y</span><span class="p">])</span>
                <span class="n">tmpCtx</span><span class="p">.</span><span class="n">strokeRect</span><span class="p">(</span><span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">X</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">Y</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span>1<span class="p">][</span><span class="n">X</span><span class="p">]</span><span class="o">-</span><span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">X</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span>1<span class="p">][</span><span class="n">Y</span><span class="p">]</span><span class="o">-</span><span class="n">points</span><span class="p">[</span>0<span class="p">][</span><span class="n">Y</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ctx</span><span class="p">.</span><span class="n">putImageData</span><span class="p">(</span><span class="n">pixels</span><span class="p">,</span> 0<span class="p">,</span> 0<span class="p">)</span>

        $<span class="n">tmpCanvas</span><span class="p">.</span><span class="n">mousedown</span><span class="p">(</span><span class="n">onMouseDown</span><span class="p">)</span>
        $<span class="n">tmpCanvas</span><span class="p">.</span><span class="n">mousemove</span><span class="p">(</span><span class="n">onMouseMove</span><span class="p">)</span>
        $<span class="n">tmpCanvas</span><span class="p">.</span><span class="n">mouseup</span><span class="p">(</span><span class="n">onMouseUp</span><span class="p">)</span>
        <span class="n">onMouseLeave</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">dragging</span><span class="p">:</span>
                <span class="n">onMouseUp</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        $<span class="n">tmpCanvas</span><span class="p">.</span><span class="n">mouseleave</span><span class="p">(</span><span class="n">onMouseLeave</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_ctx</span><span class="p">.</span><span class="n">lineJoin</span> <span class="p">=</span> <span class="n">tmpCtx</span><span class="p">.</span><span class="n">lineJoin</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_ctx</span><span class="p">.</span><span class="n">lineCap</span> <span class="p">=</span> <span class="n">tmpCtx</span><span class="p">.</span><span class="n">lineCap</span> <span class="p">=</span> <span class="s">'round'</span>

    <span class="n">def</span> <span class="n">undo</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">state</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_undoStack</span><span class="p">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">state</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_redoStack</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_ctx</span><span class="p">.</span><span class="n">putImageData</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> 0<span class="p">,</span> 0<span class="p">)</span>

    <span class="n">def</span> <span class="n">redo</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">state</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_redoStack</span><span class="p">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">state</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_undoStack</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_ctx</span><span class="p">.</span><span class="n">putImageData</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> 0<span class="p">,</span> 0<span class="p">)</span>

    <span class="c"># invert declared inside __init__() since it needs access to hidden 'selection' variable</span>

    <span class="n">def</span> <span class="n">setMode</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="nb">mode</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_mode</span> <span class="p">=</span> <span class="nb">mode</span>

    <span class="n">def</span> <span class="n">setStroke</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">style</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_brushColor</span> <span class="p">=</span> <span class="n">style</span>

    <span class="n">def</span> <span class="n">setFill</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">style</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_fillColor</span> <span class="p">=</span> <span class="n">style</span>

    <span class="n">def</span> <span class="n">setWidth</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lineWidth</span> <span class="p">=</span> <span class="n">value</span>

    <span class="n">def</span> <span class="n">clear</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_clear</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_ctx</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">exportDwg</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_canvas</span><span class="p">.</span><span class="n">toDataURL</span><span class="p">()</span>

    <span class="n">def</span> <span class="n">invert</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">invert</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
            <span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="p">=</span> 255<span class="o">-</span><span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span>
            <span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span>1<span class="p">]</span> <span class="p">=</span> 255<span class="o">-</span><span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span>1<span class="p">]</span>
            <span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span>2<span class="p">]</span> <span class="p">=</span> 255<span class="o">-</span><span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span>2<span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_filter</span><span class="p">(</span><span class="n">invert</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">redFilter</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">remove</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
            <span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="p">=</span> 0
        <span class="n">self</span><span class="p">.</span><span class="n">_filter</span><span class="p">(</span><span class="n">remove</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">greenFilter</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">remove</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
            <span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span>1<span class="p">]</span> <span class="p">=</span> 0
        <span class="n">self</span><span class="p">.</span><span class="n">_filter</span><span class="p">(</span><span class="n">remove</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">blueFilter</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">remove</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
            <span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span>2<span class="p">]</span> <span class="p">=</span> 0
        <span class="n">self</span><span class="p">.</span><span class="n">_filter</span><span class="p">(</span><span class="n">remove</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">darken</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">darken</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
            <span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">/=</span> 2
            <span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span>1<span class="p">]</span> <span class="o">/=</span> 2
            <span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span>2<span class="p">]</span> <span class="o">/=</span> 2
        <span class="n">self</span><span class="p">.</span><span class="n">_filter</span><span class="p">(</span><span class="n">darken</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">lighten</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">lighten</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
            <span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="p">=</span> <span class="n">Math</span><span class="p">.</span><span class="nb">min</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">*</span> 2<span class="p">,</span> 255<span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span>1<span class="p">]</span> <span class="p">=</span> <span class="n">Math</span><span class="p">.</span><span class="nb">min</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span>1<span class="p">]</span> <span class="o">*</span> 2<span class="p">,</span> 255<span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span>2<span class="p">]</span> <span class="p">=</span> <span class="n">Math</span><span class="p">.</span><span class="nb">min</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span>2<span class="p">]</span> <span class="o">*</span> 2<span class="p">,</span> 255<span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_filter</span><span class="p">(</span><span class="n">lighten</span><span class="p">)</span>
</pre></div>


<h3>paint.pyj</h3>
<div class="codehilite"><pre><span class="c">######################################################</span>
<span class="c"># Copyright 2012 Pyjeon Software LLC</span>
<span class="c"># Author:   Alexander Tsepkov</span>
<span class="c"># License:  License: Creative Commons: Attribution + Noncommerial + ShareAlike</span>
<span class="c">######################################################</span>

<span class="n">import</span> <span class="n">Drawing</span>

<span class="nb">class</span> <span class="n">ColorSwatch</span><span class="p">:</span>
    <span class="s">"""</span>
<span class="s">    Color selection and preview widget</span>
<span class="s">    """</span>
    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">fg</span> <span class="p">=</span> $<span class="p">(</span><span class="s">'&lt;div&gt;&lt;/div&gt;'</span><span class="p">)</span><span class="o">\</span>
            <span class="p">.</span><span class="n">width</span><span class="p">(</span>36<span class="p">).</span><span class="n">height</span><span class="p">(</span>36<span class="p">)</span><span class="o">\</span>
            <span class="p">.</span><span class="n">css</span><span class="p">({</span><span class="s">'position'</span><span class="p">:</span> <span class="s">'absolute'</span><span class="p">,</span> <span class="s">'border'</span><span class="p">:</span> <span class="s">'1px solid black'</span><span class="p">})</span>
        <span class="n">fg</span><span class="p">.</span><span class="n">change</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">color</span><span class="p">):</span>
            $<span class="p">(</span><span class="n">self</span><span class="p">).</span><span class="n">css</span><span class="p">(</span><span class="s">'background'</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>
        <span class="n">bg</span> <span class="p">=</span> <span class="n">fg</span><span class="p">.</span><span class="n">clone</span><span class="p">()</span>
        $<span class="p">(</span><span class="s">'#color-swatch'</span><span class="p">)</span>

<span class="n">def</span> <span class="n">main</span><span class="p">():</span>
    <span class="n">dwg</span> <span class="p">=</span> <span class="n">Drawing</span><span class="p">()</span>

    <span class="c"># control brush sizes</span>
    <span class="c"># NOTE: jQuery UI spinner implementation is inconsistent with its documentation, since their</span>
    <span class="c"># implementation was buggy, this required some testing and work-arounds on my end, in particular</span>
    <span class="c"># .value() method doesn't exist (.val() does), and .change() doesn't trigger when using the</span>
    <span class="c"># arrows to update the value, instead I had to add my own manual trigger for it</span>
    <span class="n">onChange</span> <span class="p">=</span> <span class="n">def</span><span class="p">():</span>
        <span class="n">dwg</span><span class="p">.</span><span class="n">setWidth</span><span class="p">(</span>$<span class="p">(</span><span class="n">this</span><span class="p">).</span><span class="n">val</span><span class="p">())</span>
    $<span class="n">brushWidget</span> <span class="p">=</span> $<span class="p">(</span><span class="s">'#brush-size'</span><span class="p">).</span><span class="n">spinner</span><span class="p">({</span><span class="s">'min'</span><span class="p">:</span> 1<span class="p">,</span> <span class="s">'max'</span><span class="p">:</span> 40<span class="p">})</span>
    $<span class="n">brushWidget</span><span class="p">.</span><span class="n">change</span><span class="p">(</span><span class="n">onChange</span><span class="p">)</span>
    <span class="n">triggerChange</span> <span class="p">=</span> <span class="n">def</span><span class="p">():</span>
        $<span class="p">(</span><span class="n">this</span><span class="p">).</span><span class="n">siblings</span><span class="p">(</span><span class="s">'input'</span><span class="p">).</span><span class="n">change</span><span class="p">()</span>
    $<span class="p">(</span><span class="s">'.ui-spinner-button'</span><span class="p">).</span><span class="n">click</span><span class="p">(</span><span class="n">triggerChange</span><span class="p">)</span>
    $<span class="n">brushWidget</span><span class="p">.</span><span class="n">val</span><span class="p">(</span>1<span class="p">)</span>

    <span class="c"># map toolbox buttons to drawing modes</span>
    $<span class="n">tools</span> <span class="p">=</span> $<span class="p">(</span><span class="s">'.toolbox-item'</span><span class="p">)</span>
    <span class="n">makeMode</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="nb">mode</span><span class="p">):</span>
        <span class="n">setMode</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">dwg</span><span class="p">.</span><span class="n">setMode</span><span class="p">(</span><span class="nb">mode</span><span class="p">)</span>
            $<span class="n">tools</span><span class="p">.</span><span class="n">removeClass</span><span class="p">(</span><span class="s">'selected'</span><span class="p">)</span>
            $<span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">target</span><span class="p">).</span><span class="n">parent</span><span class="p">().</span><span class="n">addClass</span><span class="p">(</span><span class="s">'selected'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">setMode</span>
    $<span class="p">(</span><span class="s">'#toolbox-brush'</span><span class="p">).</span><span class="n">click</span><span class="p">(</span><span class="n">makeMode</span><span class="p">(</span><span class="n">BRUSH</span><span class="p">))</span>
    $<span class="p">(</span><span class="s">'#toolbox-eraser'</span><span class="p">).</span><span class="n">click</span><span class="p">(</span><span class="n">makeMode</span><span class="p">(</span><span class="n">ERASER</span><span class="p">))</span>
    $<span class="p">(</span><span class="s">'#toolbox-line'</span><span class="p">).</span><span class="n">click</span><span class="p">(</span><span class="n">makeMode</span><span class="p">(</span><span class="n">LINE</span><span class="p">))</span>
    $<span class="p">(</span><span class="s">'#toolbox-select'</span><span class="p">).</span><span class="n">click</span><span class="p">(</span><span class="n">makeMode</span><span class="p">(</span><span class="n">SELECT</span><span class="p">))</span>
    $<span class="p">(</span><span class="s">'#toolbox-colorselect'</span><span class="p">).</span><span class="n">click</span><span class="p">(</span><span class="n">makeMode</span><span class="p">(</span><span class="n">COLORSELECT</span><span class="p">))</span>
    $<span class="p">(</span><span class="s">'#toolbox-lasso'</span><span class="p">).</span><span class="n">click</span><span class="p">(</span><span class="n">makeMode</span><span class="p">(</span><span class="n">LASSO</span><span class="p">))</span>
    $<span class="p">(</span><span class="s">'#toolbox-rectangle'</span><span class="p">).</span><span class="n">click</span><span class="p">(</span><span class="n">makeMode</span><span class="p">(</span><span class="n">RECT</span><span class="p">))</span>
    $<span class="p">(</span><span class="s">'#toolbox-ellipse'</span><span class="p">).</span><span class="n">click</span><span class="p">(</span><span class="n">makeMode</span><span class="p">(</span><span class="n">ELLIPSE</span><span class="p">))</span>
    $<span class="p">(</span><span class="s">'#toolbox-sampler'</span><span class="p">).</span><span class="n">click</span><span class="p">(</span><span class="n">makeMode</span><span class="p">(</span><span class="n">SAMPLER</span><span class="p">))</span>
    $<span class="p">(</span><span class="s">'#toolbox-bucket'</span><span class="p">).</span><span class="n">click</span><span class="p">(</span><span class="n">makeMode</span><span class="p">(</span><span class="n">BUCKET</span><span class="p">))</span>
    $<span class="p">(</span><span class="s">'#toolbox-text'</span><span class="p">).</span><span class="n">click</span><span class="p">(</span><span class="n">makeMode</span><span class="p">(</span><span class="n">TEXT</span><span class="p">))</span>
    $<span class="p">(</span><span class="s">'#toolbox-brush'</span><span class="p">).</span><span class="n">click</span><span class="p">()</span>     <span class="c"># default to brush</span>

    <span class="c"># set up color selection menus</span>
    $<span class="n">stroke</span> <span class="p">=</span> $<span class="p">(</span><span class="s">'#stroke'</span><span class="p">)</span>
    $<span class="nb">fill</span> <span class="p">=</span> $<span class="p">(</span><span class="s">'#fill'</span><span class="p">)</span>
    <span class="n">setStroke</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">style</span><span class="p">):</span>
        <span class="n">dwg</span><span class="p">.</span><span class="n">setStroke</span><span class="p">(</span><span class="n">style</span><span class="p">)</span>
        $<span class="n">stroke</span><span class="p">.</span><span class="n">css</span><span class="p">(</span><span class="s">'background'</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>
    <span class="n">setFill</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">style</span><span class="p">):</span>
        <span class="n">dwg</span><span class="p">.</span><span class="n">setFill</span><span class="p">(</span><span class="n">style</span><span class="p">)</span>
        $<span class="nb">fill</span><span class="p">.</span><span class="n">css</span><span class="p">(</span><span class="s">'background'</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>
    <span class="n">setStroke</span><span class="p">(</span><span class="s">'black'</span><span class="p">)</span>

    <span class="c"># farbtastic is an open-source color-picker we will be leveraging to avoid reinventing the wheel:</span>
    <span class="c"># http://acko.net/blog/farbtastic-jquery-color-picker-plug-in/</span>
    $<span class="n">colorPickers</span> <span class="p">=</span> $<span class="p">(</span><span class="s">'.colorpicker'</span><span class="p">)</span>
    <span class="k">for</span> $<span class="n">swatch</span><span class="p">,</span> <span class="n">idtag</span><span class="p">,</span> <span class="n">resetid</span><span class="p">,</span> <span class="n">callback</span> <span class="n">in</span> <span class="p">[(</span>$<span class="n">stroke</span><span class="p">,</span> <span class="s">'#fg-color'</span><span class="p">,</span> <span class="s">'#no-stroke'</span><span class="p">,</span> <span class="n">setStroke</span><span class="p">),</span> <span class="o">\</span>
                                            <span class="p">(</span>$<span class="nb">fill</span><span class="p">,</span> <span class="s">'#bg-color'</span><span class="p">,</span> <span class="s">'#no-fill'</span><span class="p">,</span> <span class="n">setFill</span><span class="p">)]:</span>
        $<span class="n">colorPicker</span> <span class="p">=</span> $<span class="p">(</span><span class="n">idtag</span><span class="p">)</span>
        $<span class="n">colorPicker</span><span class="p">.</span><span class="n">farbtastic</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>

        <span class="c"># a function generator allows us to create a handler tied to current values, not the final ones</span>
        <span class="c"># that the loop terminates with (useful for keeping color-pickers independent)</span>
        <span class="n">makeHandler</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span>$<span class="n">target</span><span class="p">,</span> $<span class="n">popup</span><span class="p">):</span>
            <span class="n">showColorpicker</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                $<span class="n">colorPickers</span><span class="p">.</span><span class="n">hide</span><span class="p">()</span>
                <span class="n">popupUnder</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> $<span class="n">target</span><span class="p">,</span> $<span class="n">popup</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">showColorpicker</span>
        $<span class="n">swatch</span><span class="p">.</span><span class="n">click</span><span class="p">(</span><span class="n">makeHandler</span><span class="p">(</span>$<span class="n">swatch</span><span class="p">,</span> $<span class="n">colorPicker</span><span class="p">))</span>

        <span class="c"># now add a button that resets color to transparent</span>
        <span class="n">makeReset</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span>$<span class="n">target</span><span class="p">,</span> <span class="n">setFunction</span><span class="p">):</span>
            <span class="nb">reset</span> <span class="p">=</span> <span class="n">def</span><span class="p">():</span>
                <span class="n">event</span><span class="p">.</span><span class="n">stopPropagation</span><span class="p">()</span> <span class="c"># prevent colorpicker from showing</span>
                <span class="n">setFunction</span><span class="p">(</span><span class="s">'transparent'</span><span class="p">)</span>
                $<span class="n">target</span><span class="p">.</span><span class="n">css</span><span class="p">(</span><span class="s">'background'</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">reset</span>
        $<span class="p">(</span><span class="n">resetid</span><span class="p">).</span><span class="n">click</span><span class="p">(</span><span class="n">makeReset</span><span class="p">(</span>$<span class="n">swatch</span><span class="p">,</span> <span class="n">callback</span><span class="p">))</span>

    <span class="c"># set up top menubar</span>
    <span class="n">popupUnder</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> $<span class="n">element</span><span class="p">,</span> $<span class="n">popup</span><span class="p">):</span>
        <span class="n">event</span><span class="p">.</span><span class="n">stopPropagation</span><span class="p">()</span> <span class="c"># prevent document from closing us</span>
        <span class="n">absolute</span> <span class="p">=</span> $<span class="n">element</span><span class="p">.</span><span class="n">offset</span><span class="p">()</span>
        $<span class="n">popup</span><span class="p">.</span><span class="n">css</span><span class="p">({</span><span class="s">'left'</span><span class="p">:</span> <span class="n">absolute</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="s">'top'</span><span class="p">:</span> <span class="n">absolute</span><span class="p">.</span><span class="n">top</span><span class="o">+</span>$<span class="n">element</span><span class="p">.</span><span class="n">outerHeight</span><span class="p">()}).</span><span class="n">show</span><span class="p">()</span>
    $<span class="n">menus</span> <span class="p">=</span> $<span class="p">(</span><span class="s">'.menubar-menu'</span><span class="p">)</span>
    <span class="n">makeMenu</span> <span class="p">=</span> <span class="n">def</span><span class="p">():</span>
        $<span class="n">this</span> <span class="p">=</span> $<span class="p">(</span><span class="n">this</span><span class="p">)</span>
        <span class="n">idtag</span> <span class="p">=</span> $<span class="n">this</span><span class="p">.</span><span class="n">attr</span><span class="p">(</span><span class="s">'id'</span><span class="p">).</span><span class="n">split</span><span class="p">(</span><span class="s">'-'</span><span class="p">)[</span>2<span class="p">]</span>
        <span class="n">showMenu</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            $<span class="n">menus</span><span class="p">.</span><span class="n">hide</span><span class="p">()</span>
            <span class="n">popupUnder</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> $<span class="n">this</span><span class="p">,</span> $<span class="p">(</span><span class="s">'#menubar-menu-'</span><span class="o">+</span><span class="n">idtag</span><span class="p">))</span>
        $<span class="n">this</span><span class="p">.</span><span class="n">click</span><span class="p">(</span><span class="n">showMenu</span><span class="p">)</span>

    <span class="c"># hide menus if we click anywhere outside the menu div</span>
    <span class="n">hideMenus</span> <span class="p">=</span> <span class="n">def</span><span class="p">():</span>
        $<span class="n">menus</span><span class="p">.</span><span class="n">hide</span><span class="p">()</span>
        $<span class="n">colorPickers</span><span class="p">.</span><span class="n">hide</span><span class="p">()</span>
    $<span class="p">(</span><span class="n">document</span><span class="p">).</span><span class="n">click</span><span class="p">(</span><span class="n">hideMenus</span><span class="p">)</span>

    $<span class="n">menus</span><span class="p">.</span><span class="nb">menu</span><span class="p">().</span><span class="n">removeClass</span><span class="p">(</span><span class="s">'ui-widget'</span><span class="p">)</span>  <span class="c"># ui-widget adds ugly font, we don't want that</span>
    $<span class="p">(</span><span class="s">'.menubar-item'</span><span class="p">).</span><span class="n">each</span><span class="p">(</span><span class="n">makeMenu</span><span class="p">)</span>

    <span class="c"># attach actual functionality to menu items</span>
    $<span class="p">(</span><span class="s">'#menubar-menu-item-new'</span><span class="p">).</span><span class="n">click</span><span class="p">(</span>
        <span class="c"># start new drawing</span>
        <span class="n">def</span><span class="p">():</span> <span class="n">dwg</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="p">)</span>

    $<span class="p">(</span><span class="s">'#menubar-menu-item-export-to-image'</span><span class="p">).</span><span class="n">click</span><span class="p">(</span>
        <span class="c"># export drawing to PNG</span>
        <span class="n">def</span><span class="p">():</span>
            <span class="n">url</span> <span class="p">=</span> <span class="n">dwg</span><span class="p">.</span><span class="n">exportDwg</span><span class="p">()</span>
            <span class="n">window</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s">'_blank'</span><span class="p">)</span>
    <span class="p">)</span>

    $<span class="p">(</span><span class="s">'#menubar-menu-item-undo'</span><span class="p">).</span><span class="n">click</span><span class="p">(</span>
        <span class="c"># undo last action</span>
        <span class="n">def</span><span class="p">():</span> <span class="n">dwg</span><span class="p">.</span><span class="n">undo</span><span class="p">()</span>
    <span class="p">)</span>

    $<span class="p">(</span><span class="s">'#menubar-menu-item-redo'</span><span class="p">).</span><span class="n">click</span><span class="p">(</span>
        <span class="c"># redo last action</span>
        <span class="n">def</span><span class="p">():</span> <span class="n">dwg</span><span class="p">.</span><span class="n">redo</span><span class="p">()</span>
    <span class="p">)</span>

    $<span class="p">(</span><span class="s">'#menubar-menu-item-invert-colors'</span><span class="p">).</span><span class="n">click</span><span class="p">(</span>
        <span class="c"># invert colors</span>
        <span class="n">def</span><span class="p">():</span> <span class="n">dwg</span><span class="p">.</span><span class="n">invert</span><span class="p">()</span>
    <span class="p">)</span>

    $<span class="p">(</span><span class="s">'#menubar-menu-item-red-filter'</span><span class="p">).</span><span class="n">click</span><span class="p">(</span>
        <span class="c"># filter out red channel</span>
        <span class="n">def</span><span class="p">():</span> <span class="n">dwg</span><span class="p">.</span><span class="n">redFilter</span><span class="p">()</span>
    <span class="p">)</span>

    $<span class="p">(</span><span class="s">'#menubar-menu-item-green-filter'</span><span class="p">).</span><span class="n">click</span><span class="p">(</span>
        <span class="c"># filter out green channel</span>
        <span class="n">def</span><span class="p">():</span> <span class="n">dwg</span><span class="p">.</span><span class="n">greenFilter</span><span class="p">()</span>
    <span class="p">)</span>

    $<span class="p">(</span><span class="s">'#menubar-menu-item-blue-filter'</span><span class="p">).</span><span class="n">click</span><span class="p">(</span>
        <span class="c"># filter out blue channel</span>
        <span class="n">def</span><span class="p">():</span> <span class="n">dwg</span><span class="p">.</span><span class="n">blueFilter</span><span class="p">()</span>
    <span class="p">)</span>

    $<span class="p">(</span><span class="s">'#menubar-menu-item-darken'</span><span class="p">).</span><span class="n">click</span><span class="p">(</span>
        <span class="c"># make image half as bright</span>
        <span class="n">def</span><span class="p">():</span> <span class="n">dwg</span><span class="p">.</span><span class="n">darken</span><span class="p">()</span>
    <span class="p">)</span>

    $<span class="p">(</span><span class="s">'#menubar-menu-item-lighten'</span><span class="p">).</span><span class="n">click</span><span class="p">(</span>
        <span class="c"># make image twice as bright</span>
        <span class="n">def</span><span class="p">():</span> <span class="n">dwg</span><span class="p">.</span><span class="n">lighten</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="c"># pre-cache the element, so we don't have to 'select' it repeatedly</span>
    $<span class="n">about</span> <span class="p">=</span> $<span class="p">(</span><span class="s">'#about'</span><span class="p">).</span><span class="n">dialog</span><span class="p">({</span><span class="s">'modal'</span><span class="p">:</span> <span class="n">True</span><span class="p">})</span>
    $<span class="p">(</span><span class="s">'#menubar-menu-item-about'</span><span class="p">).</span><span class="n">click</span><span class="p">(</span>
        <span class="c"># show info about this app</span>
        <span class="n">def</span><span class="p">():</span> $<span class="n">about</span><span class="p">.</span><span class="n">dialog</span><span class="p">(</span><span class="s">'open'</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c"># disable right-click menu</span>
    <span class="n">window</span><span class="p">.</span><span class="n">oncontextmenu</span> <span class="p">=</span> <span class="n">def</span><span class="p">():</span> <span class="k">return</span> <span class="n">False</span>

$<span class="p">(</span><span class="n">document</span><span class="p">).</span><span class="n">ready</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>


<h2>Ray-Tracing Example</h2>
<p>Author: Salvatore DI DIO
License:    License: Creative Commons: Attribution + Noncommerial + ShareAlike  </p>
<p>This demo shows Ray-Tracing done on a canvas element in RapydScript. This demo is based on <a href="http://viola.informatik.uni-bremen.de/typo/html/qingteng/index.html">logic described on this website</a>. You can also play with this demo's source code live <a href="http://salvatore.pythonanywhere.com/RapydRay">here</a>.</p>
<h3>rapydray.pyj</h3>
<div class="codehilite"><pre><span class="c">#</span>
<span class="c"># Based on:</span>
<span class="c">#http://viola.informatik.uni-bremen.de/typo/html/qingteng/index.html</span>
<span class="c">#</span>
<span class="c"># Documentation :</span>
<span class="c"># http://www.scratchapixel.com</span>
<span class="c">#</span>
<span class="c"># Thanks to Alexander Tsepkov the creator of RapydScript, and</span>
<span class="c"># Charles Law for allowing testing RapydScript online</span>
<span class="c"># Post comments and suggestions on RapydScript Google Group</span>
<span class="c">#</span>
<span class="c"># You can modify the script and see the modifications</span>
<span class="c"># in direct live (quite)</span>
<span class="c"># When modifying you can reduce WIDTH and HEIGHT to avoid lag</span>
<span class="c">#</span>
<span class="c"># Authored by Salvatore DI DIO (email : salvatore dot didio at gmail)</span>
<span class="c">#</span>
<span class="c"># Best performance with Firefox</span>
<span class="c"># On my mac book pro : 1280 x 800 rendered in less than a minute</span>

<span class="n">WIDTH</span> <span class="p">=</span> 440
<span class="n">HEIGHT</span> <span class="p">=</span> 240

<span class="nb">class</span> <span class="n">Vector</span><span class="p">:</span>
    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">=</span>0<span class="p">,</span> <span class="n">y</span><span class="p">=</span>0<span class="p">,</span> <span class="n">z</span><span class="p">=</span>0<span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">x</span> <span class="p">=</span> <span class="n">x</span>
        <span class="n">self</span><span class="p">.</span><span class="n">y</span> <span class="p">=</span> <span class="n">y</span>
        <span class="n">self</span><span class="p">.</span><span class="n">z</span> <span class="p">=</span> <span class="n">z</span>

    <span class="n">def</span> <span class="n">copy</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Vector</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">z</span><span class="p">)</span>

    <span class="n">def</span> <span class="nb">length</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Math</span><span class="p">.</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">self</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="n">self</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">z</span><span class="o">*</span><span class="n">self</span><span class="p">.</span><span class="n">z</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">sqrLength</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">self</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="n">self</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">z</span><span class="o">*</span><span class="n">self</span><span class="p">.</span><span class="n">z</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">normalize</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nb">inv</span> <span class="p">=</span> 1<span class="p">.</span>0<span class="o">/</span><span class="n">self</span><span class="p">.</span><span class="nb">length</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Vector</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="nb">inv</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="nb">inv</span><span class="p">,</span><span class="n">self</span><span class="p">.</span><span class="n">z</span><span class="o">*</span><span class="nb">inv</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">negate</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Vector</span><span class="p">(</span><span class="o">-</span><span class="n">self</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">self</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="o">-</span><span class="n">self</span><span class="p">.</span><span class="n">z</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">add</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="n">v</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Vector</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">v</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">v</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">z</span> <span class="o">+</span> <span class="n">v</span><span class="p">.</span><span class="n">z</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">sub</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="n">v</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Vector</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">v</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">v</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">v</span><span class="p">.</span><span class="n">z</span><span class="p">)</span>

    <span class="n">def</span> <span class="nb">times</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Vector</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">self</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="o">*</span><span class="n">self</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">k</span><span class="o">*</span><span class="n">self</span><span class="p">.</span><span class="n">z</span><span class="p">)</span>

    <span class="n">def</span> <span class="nb">dot</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">t</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="n">t</span><span class="p">.</span><span class="n">y</span><span class="o">+</span><span class="n">self</span><span class="p">.</span><span class="n">z</span><span class="o">*</span><span class="n">t</span><span class="p">.</span><span class="n">z</span>

    <span class="n">def</span> <span class="nb">cross</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="n">w</span><span class="p">):</span>
        <span class="n">v</span> <span class="p">=</span> <span class="n">Vector</span><span class="p">()</span>
        <span class="n">v</span><span class="p">.</span><span class="n">x</span> <span class="p">=</span>  <span class="n">self</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">w</span><span class="p">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">z</span> <span class="o">*</span> <span class="n">w</span><span class="p">.</span><span class="n">y</span>
        <span class="n">v</span><span class="p">.</span><span class="n">y</span> <span class="p">=</span> <span class="o">-</span><span class="n">self</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">w</span><span class="p">.</span><span class="n">z</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">z</span> <span class="o">*</span> <span class="n">w</span><span class="p">.</span><span class="n">x</span>
        <span class="n">v</span><span class="p">.</span><span class="n">z</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">w</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">w</span><span class="p">.</span><span class="n">x</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="p">@</span><span class="n">staticmethod</span>    
    <span class="n">def</span> <span class="n">zero</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">Vector</span><span class="p">()</span>

<span class="nb">class</span> <span class="n">Ray</span><span class="p">:</span>
    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">vectOrigin</span><span class="p">,</span> <span class="n">vectDest</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">origin</span> <span class="p">=</span> <span class="n">vectOrigin</span>
        <span class="n">self</span><span class="p">.</span><span class="n">direction</span> <span class="p">=</span> <span class="n">vectDest</span>

    <span class="n">def</span> <span class="n">getPoint</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="c"># p = self.origin + t * self.direction</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">direction</span><span class="p">.</span><span class="nb">times</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>

<span class="nb">class</span> <span class="n">IntersectionResult</span><span class="p">:</span>
    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">sceneobject</span> <span class="p">=</span> <span class="nb">null</span>
        <span class="n">self</span><span class="p">.</span><span class="n">distance</span> <span class="p">=</span> 0
        <span class="n">self</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="n">Vector</span><span class="p">.</span><span class="n">zero</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="n">Vector</span><span class="p">.</span><span class="n">zero</span><span class="p">()</span>

    <span class="p">@</span><span class="n">staticmethod</span>
    <span class="n">def</span> <span class="n">nohit</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">IntersectionResult</span><span class="p">()</span>

<span class="nb">class</span> <span class="n">Sphere</span><span class="p">:</span>
    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="nb">center</span> <span class="p">=</span> <span class="n">Vector</span><span class="p">(</span>0<span class="p">,</span>2<span class="p">,</span><span class="o">-</span>1<span class="p">),</span> <span class="n">radius</span> <span class="p">=</span> 1<span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="nb">center</span> <span class="p">=</span> <span class="nb">center</span>
        <span class="n">self</span><span class="p">.</span><span class="n">radius</span> <span class="p">=</span> <span class="n">radius</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="p">=</span> <span class="s">"Sphere"</span>

    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">sqrRadius</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">radius</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">radius</span>

    <span class="n">def</span> <span class="nb">double</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> 100

    <span class="n">def</span> <span class="nb">intersect</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">ray</span><span class="p">):</span>    
        <span class="n">v</span> <span class="p">=</span> <span class="n">ray</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nb">center</span><span class="p">)</span>
        <span class="n">a0</span> <span class="p">=</span> <span class="n">v</span><span class="p">.</span><span class="n">sqrLength</span><span class="p">()</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">sqrRadius</span>
        <span class="n">DdotV</span> <span class="p">=</span> <span class="n">ray</span><span class="p">.</span><span class="n">direction</span><span class="p">.</span><span class="nb">dot</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">DdotV</span> <span class="o">&lt;</span><span class="p">=</span> 0<span class="p">:</span> 
            <span class="n">discr</span> <span class="p">=</span> <span class="n">DdotV</span> <span class="o">*</span> <span class="n">DdotV</span> <span class="o">-</span> <span class="n">a0</span>   
            <span class="k">if</span> <span class="n">discr</span> <span class="o">&gt;</span><span class="p">=</span> 0<span class="p">:</span>
                <span class="n">r</span> <span class="p">=</span> <span class="n">IntersectionResult</span><span class="p">()</span>
                <span class="n">r</span><span class="p">.</span><span class="n">sceneobject</span> <span class="p">=</span> <span class="n">self</span>
                <span class="n">r</span><span class="p">.</span><span class="n">distance</span> <span class="p">=</span>  <span class="o">-</span><span class="n">DdotV</span> <span class="o">-</span> <span class="n">Math</span><span class="p">.</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">discr</span><span class="p">)</span>
                <span class="n">r</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="n">ray</span><span class="p">.</span><span class="n">getPoint</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">distance</span><span class="p">)</span>
                <span class="n">r</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span>  <span class="n">r</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nb">center</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">r</span>
        <span class="k">return</span> <span class="n">IntersectionResult</span><span class="p">.</span><span class="n">nohit</span><span class="p">()</span>

<span class="nb">class</span> <span class="n">Camera</span><span class="p">:</span>
    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="nb">eye</span><span class="p">,</span> <span class="n">front</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">fov</span><span class="p">,</span><span class="n">aspectratio</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="nb">eye</span> <span class="p">=</span> <span class="nb">eye</span>
        <span class="n">self</span><span class="p">.</span><span class="n">front</span> <span class="p">=</span> <span class="n">front</span> 
        <span class="n">self</span><span class="p">.</span><span class="n">RefUp</span> <span class="p">=</span> <span class="n">up</span>
        <span class="n">self</span><span class="p">.</span><span class="n">fov</span> <span class="p">=</span> <span class="n">fov</span>
        <span class="n">self</span><span class="p">.</span><span class="n">aspectratio</span> <span class="p">=</span> <span class="n">aspectratio</span>

    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">right</span> <span class="p">=</span>  <span class="n">self</span><span class="p">.</span><span class="n">front</span><span class="p">.</span><span class="nb">cross</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">RefUp</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">up</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">right</span><span class="p">.</span><span class="nb">cross</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">front</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">fovScale</span> <span class="p">=</span> <span class="n">Math</span><span class="p">.</span><span class="nb">tan</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">fov</span> <span class="o">*</span> 0<span class="p">.</span>5 <span class="o">*</span> <span class="n">Math</span><span class="p">.</span><span class="n">PI</span><span class="o">/</span>180<span class="p">)</span><span class="o">*</span>2

    <span class="n">def</span> <span class="n">generateRay</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
        <span class="n">r</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">right</span><span class="p">.</span><span class="nb">times</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> 0<span class="p">.</span>5<span class="p">)</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">fovScale</span><span class="o">*</span><span class="n">self</span><span class="p">.</span><span class="n">aspectratio</span><span class="p">)</span>
        <span class="n">u</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">up</span><span class="p">.</span><span class="nb">times</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> 0<span class="p">.</span>5<span class="p">)</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">fovScale</span><span class="p">)</span>
        <span class="n">ray</span> <span class="p">=</span> <span class="n">Ray</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nb">eye</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">front</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">r</span><span class="p">).</span><span class="n">add</span><span class="p">(</span><span class="n">u</span><span class="p">).</span><span class="n">normalize</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">ray</span>

<span class="nb">class</span> <span class="n">Union</span><span class="p">:</span>
    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="n">geometries</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">geometries</span> <span class="p">=</span> <span class="n">geometries</span>

    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">geo</span> <span class="n">in</span> <span class="n">self</span><span class="p">.</span><span class="n">geometries</span><span class="p">:</span>
            <span class="n">geo</span><span class="p">.</span><span class="n">initialize</span><span class="p">()</span>

    <span class="n">def</span> <span class="nb">intersect</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">ray</span><span class="p">):</span>
        <span class="n">minDistance</span> <span class="p">=</span> <span class="n">Infinity</span>
        <span class="n">minResult</span> <span class="p">=</span> <span class="n">IntersectionResult</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">geo</span> <span class="n">in</span> <span class="n">self</span><span class="p">.</span><span class="n">geometries</span><span class="p">:</span>
            <span class="n">result</span> <span class="p">=</span> <span class="n">geo</span><span class="p">.</span><span class="nb">intersect</span><span class="p">(</span><span class="n">ray</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">result</span><span class="p">.</span><span class="n">sceneobject</span> <span class="o">!=</span> <span class="nb">null</span><span class="p">)</span> <span class="nb">and</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="n">minDistance</span><span class="p">)):</span>        
                <span class="n">minDistance</span> <span class="p">=</span> <span class="n">result</span><span class="p">.</span><span class="n">distance</span>
                <span class="n">minResult</span> <span class="p">=</span> <span class="n">result</span>
        <span class="k">return</span> <span class="n">minResult</span>

<span class="nb">class</span> <span class="n">Plane</span><span class="p">:</span>
    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">normal</span><span class="p">,</span> <span class="n">distance</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="n">normal</span>
        <span class="n">self</span><span class="p">.</span><span class="n">d</span> <span class="p">=</span> <span class="n">distance</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="p">=</span> <span class="s">"Plane"</span>

    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="nb">times</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">d</span><span class="p">)</span>

    <span class="n">def</span> <span class="nb">intersect</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">ray</span><span class="p">):</span>
        <span class="n">a</span> <span class="p">=</span>  <span class="n">ray</span><span class="p">.</span><span class="n">direction</span><span class="p">.</span><span class="nb">dot</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">normal</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span><span class="p">=</span> 0<span class="p">:</span>
            <span class="k">return</span> <span class="n">IntersectionResult</span><span class="p">.</span><span class="n">nohit</span><span class="p">()</span>

        <span class="n">b</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="nb">dot</span><span class="p">(</span><span class="n">ray</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">position</span><span class="p">))</span>
        <span class="n">result</span> <span class="p">=</span> <span class="n">IntersectionResult</span><span class="p">()</span>
        <span class="n">result</span><span class="p">.</span><span class="n">sceneobject</span> <span class="p">=</span> <span class="n">self</span>
        <span class="n">result</span><span class="p">.</span><span class="n">distance</span> <span class="p">=</span> <span class="o">-</span><span class="n">b</span><span class="o">/</span><span class="n">a</span>
        <span class="n">result</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span>  <span class="n">ray</span><span class="p">.</span><span class="n">getPoint</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">distance</span><span class="p">)</span>
        <span class="n">result</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">normal</span>
        <span class="k">return</span> <span class="n">result</span>

<span class="nb">class</span> <span class="n">Color</span><span class="p">:</span>
    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">r</span><span class="p">=</span>0<span class="p">,</span> <span class="n">g</span><span class="p">=</span>0<span class="p">,</span> <span class="n">b</span><span class="p">=</span>0<span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">r</span> <span class="p">=</span> <span class="n">r</span>
        <span class="n">self</span><span class="p">.</span><span class="n">g</span> <span class="p">=</span> <span class="n">g</span>
        <span class="n">self</span><span class="p">.</span><span class="n">b</span> <span class="p">=</span> <span class="n">b</span>

    <span class="n">def</span> <span class="n">add</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>
       <span class="k">return</span> <span class="n">Color</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">r</span> <span class="o">+</span> <span class="n">c</span><span class="p">.</span><span class="n">r</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">g</span> <span class="o">+</span> <span class="n">c</span><span class="p">.</span><span class="n">g</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="p">.</span><span class="n">b</span><span class="p">)</span>

    <span class="n">def</span> <span class="nb">times</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Color</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">self</span><span class="p">.</span><span class="n">r</span><span class="p">,</span> <span class="n">k</span><span class="o">*</span><span class="n">self</span><span class="p">.</span><span class="n">g</span><span class="p">,</span> <span class="n">k</span><span class="o">*</span><span class="n">self</span><span class="p">.</span><span class="n">b</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">modulate</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Color</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">r</span> <span class="o">*</span> <span class="n">c</span><span class="p">.</span><span class="n">r</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">c</span><span class="p">.</span><span class="n">g</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">b</span> <span class="o">*</span> <span class="n">c</span><span class="p">.</span><span class="n">b</span><span class="p">)</span>

<span class="n">Color</span><span class="p">.</span><span class="n">black</span> <span class="p">=</span> <span class="n">Color</span><span class="p">()</span>
<span class="n">Color</span><span class="p">.</span><span class="n">red</span> <span class="p">=</span> <span class="n">Color</span><span class="p">(</span>1<span class="p">,</span>0<span class="p">,</span>0<span class="p">)</span>
<span class="n">Color</span><span class="p">.</span><span class="nb">white</span> <span class="p">=</span> <span class="n">Color</span><span class="p">(</span>1<span class="p">,</span>1<span class="p">,</span>1<span class="p">)</span>
<span class="n">Color</span><span class="p">.</span><span class="n">green</span> <span class="p">=</span> <span class="n">Color</span><span class="p">(</span>0<span class="p">,</span>1<span class="p">,</span>0<span class="p">)</span>
<span class="n">Color</span><span class="p">.</span><span class="n">blue</span> <span class="p">=</span> <span class="n">Color</span><span class="p">(</span>0<span class="p">,</span>0<span class="p">,</span>1<span class="p">)</span>
<span class="n">Color</span><span class="p">.</span><span class="n">gold</span> <span class="p">=</span> <span class="n">Color</span><span class="p">(</span>1<span class="p">,</span>0<span class="p">.</span>8745098039215686<span class="p">,</span>0<span class="p">)</span>
<span class="n">Color</span><span class="p">.</span><span class="n">cyan</span> <span class="p">=</span> <span class="n">Color</span><span class="p">(</span>0<span class="p">,</span>1<span class="p">,</span>1<span class="p">)</span>

<span class="nb">class</span> <span class="n">CheckerMaterial</span><span class="p">:</span>
    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">reflectiveness</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">scale</span> <span class="p">=</span> <span class="n">scale</span>
        <span class="n">self</span><span class="p">.</span><span class="n">reflectiveness</span> <span class="p">=</span> <span class="n">reflectiveness</span>

    <span class="n">def</span> <span class="n">sample</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="n">ray</span><span class="p">,</span><span class="n">position</span><span class="p">,</span> <span class="n">normal</span><span class="p">):</span>
        <span class="n">v</span> <span class="p">=</span>  <span class="n">Math</span><span class="p">.</span><span class="nb">abs</span><span class="p">((</span><span class="n">Math</span><span class="p">.</span><span class="nb">floor</span><span class="p">(</span><span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> 0<span class="p">.</span>1<span class="p">)</span> <span class="o">\</span>
           <span class="o">+</span> <span class="n">Math</span><span class="p">.</span><span class="nb">floor</span><span class="p">(</span><span class="n">position</span><span class="p">.</span><span class="n">z</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">scale</span><span class="p">))</span> <span class="c">% 2)</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;</span> 1<span class="p">:</span>
            <span class="k">return</span> <span class="n">Color</span><span class="p">.</span><span class="n">black</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Color</span><span class="p">.</span><span class="nb">white</span>

<span class="n">lightDir</span> <span class="p">=</span>  <span class="n">Vector</span><span class="p">(</span>6<span class="p">,</span> 8<span class="p">.</span>5<span class="p">,</span> 15<span class="p">).</span><span class="n">normalize</span><span class="p">()</span>
<span class="n">lightColor</span> <span class="p">=</span> <span class="n">Color</span><span class="p">(</span>1<span class="p">,</span>1<span class="p">,</span>1<span class="p">)</span>

<span class="nb">class</span> <span class="n">PhongMaterial</span><span class="p">:</span>
    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="nb">diffuse</span><span class="p">,</span> <span class="nb">specular</span><span class="p">,</span> <span class="n">shininess</span><span class="p">,</span> <span class="n">reflectiveness</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="nb">diffuse</span> <span class="p">=</span> <span class="nb">diffuse</span>
        <span class="n">self</span><span class="p">.</span><span class="nb">specular</span> <span class="p">=</span> <span class="nb">specular</span>
        <span class="n">self</span><span class="p">.</span><span class="n">shininess</span> <span class="p">=</span> <span class="n">shininess</span>
        <span class="n">self</span><span class="p">.</span><span class="n">reflectiveness</span> <span class="p">=</span> <span class="n">reflectiveness</span>

    <span class="n">def</span> <span class="n">sample</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="n">ray</span><span class="p">,</span><span class="n">position</span><span class="p">,</span><span class="n">normal</span><span class="p">):</span>
        <span class="n">NdotL</span> <span class="p">=</span> <span class="n">normal</span><span class="p">.</span><span class="nb">dot</span><span class="p">(</span><span class="n">lightDir</span><span class="p">)</span>
        <span class="n">H</span> <span class="p">=</span> <span class="p">(</span><span class="n">lightDir</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="n">ray</span><span class="p">.</span><span class="n">direction</span><span class="p">)).</span><span class="n">normalize</span><span class="p">()</span>
        <span class="n">NdotH</span> <span class="p">=</span> <span class="n">normal</span><span class="p">.</span><span class="nb">dot</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
        <span class="n">diffuseTerm</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="nb">diffuse</span><span class="p">.</span><span class="nb">times</span><span class="p">(</span><span class="n">Math</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="n">NdotL</span><span class="p">,</span> 0<span class="p">))</span>        
        <span class="n">specularTerm</span> <span class="p">=</span>  <span class="n">self</span><span class="p">.</span><span class="nb">specular</span><span class="p">.</span><span class="nb">times</span><span class="p">(</span><span class="n">Math</span><span class="p">.</span><span class="n">pow</span><span class="p">(</span><span class="n">Math</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="n">NdotH</span><span class="p">,</span> 0<span class="p">),</span> <span class="n">self</span><span class="p">.</span><span class="n">shininess</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">lightColor</span><span class="p">.</span><span class="n">modulate</span><span class="p">(</span><span class="n">diffuseTerm</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">specularTerm</span><span class="p">))</span>

<span class="n">def</span> <span class="n">rayTraceRecursive</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="n">ray</span><span class="p">,</span> <span class="n">maxReflect</span><span class="p">):</span>
    <span class="n">result</span> <span class="p">=</span> <span class="n">scene</span><span class="p">.</span><span class="nb">intersect</span><span class="p">(</span><span class="n">ray</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span><span class="p">.</span><span class="n">sceneobject</span><span class="p">:</span>
        <span class="n">reflectiveness</span> <span class="p">=</span> <span class="n">result</span><span class="p">.</span><span class="n">sceneobject</span><span class="p">.</span><span class="n">material</span><span class="p">.</span><span class="n">reflectiveness</span>
        <span class="n">mat</span> <span class="p">=</span> <span class="n">result</span><span class="p">.</span><span class="n">sceneobject</span><span class="p">.</span><span class="n">material</span>
        <span class="n">color</span> <span class="p">=</span> <span class="n">mat</span><span class="p">.</span><span class="n">sample</span><span class="p">(</span><span class="n">ray</span><span class="p">,</span> <span class="n">result</span><span class="p">.</span><span class="n">position</span><span class="p">,</span><span class="n">result</span><span class="p">.</span><span class="n">normal</span><span class="p">)</span>
        <span class="n">color</span><span class="p">.</span><span class="nb">times</span><span class="p">(</span>1 <span class="o">-</span> <span class="n">reflectiveness</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">reflectiveness</span> <span class="o">&gt;</span> 0 <span class="nb">and</span> <span class="n">maxReflect</span> <span class="o">&gt;</span> 0<span class="p">):</span>
            <span class="n">r</span> <span class="p">=</span> <span class="n">result</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="nb">times</span><span class="p">(</span><span class="o">-</span>2 <span class="o">*</span> <span class="n">result</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="nb">dot</span><span class="p">(</span><span class="n">ray</span><span class="p">.</span><span class="n">direction</span><span class="p">)).</span><span class="n">add</span><span class="p">(</span><span class="n">ray</span><span class="p">.</span><span class="n">direction</span><span class="p">)</span>
            <span class="n">ray</span> <span class="p">=</span> <span class="n">Ray</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">position</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
            <span class="n">reflectedColor</span> <span class="p">=</span> <span class="n">rayTraceRecursive</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="n">ray</span><span class="p">,</span> <span class="n">maxReflect</span> <span class="o">-</span> 1<span class="p">)</span>
            <span class="n">color</span> <span class="p">=</span> <span class="n">color</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">reflectedColor</span><span class="p">.</span><span class="nb">times</span><span class="p">(</span><span class="n">reflectiveness</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">color</span>
    <span class="k">return</span> <span class="n">Color</span><span class="p">(</span>0<span class="p">,</span>0<span class="p">,</span>0<span class="p">)</span>

<span class="n">CHECKER_PATTERN</span> <span class="p">=</span> <span class="n">True</span>
<span class="n">def</span> <span class="n">main</span><span class="p">():</span>
    <span class="n">canvas</span> <span class="p">=</span> <span class="n">document</span><span class="p">.</span><span class="n">getElementById</span><span class="p">(</span><span class="s">"canvas"</span><span class="p">)</span>
    <span class="n">ctx</span> <span class="p">=</span> <span class="n">canvas</span><span class="p">.</span><span class="n">getContext</span><span class="p">(</span><span class="s">"2d"</span><span class="p">)</span>
    <span class="n">canvas</span><span class="p">.</span><span class="n">width</span> <span class="p">=</span> <span class="n">WIDTH</span>
    <span class="n">canvas</span><span class="p">.</span><span class="n">height</span> <span class="p">=</span> <span class="n">HEIGHT</span>
    <span class="n">w</span>  <span class="p">=</span> <span class="n">canvas</span><span class="p">.</span><span class="n">width</span>
    <span class="n">h</span> <span class="p">=</span> <span class="n">canvas</span><span class="p">.</span><span class="n">height</span>
    <span class="n">ctx</span><span class="p">.</span><span class="n">fillStyle</span> <span class="p">=</span> <span class="s">"rgb(255,255,255)"</span>
    <span class="n">ctx</span><span class="p">.</span><span class="n">fillRect</span><span class="p">(</span>0<span class="p">,</span> 0<span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>

    <span class="n">aspectratio</span> <span class="p">=</span> <span class="n">w</span><span class="o">/</span><span class="n">h</span>
    <span class="n">camera</span> <span class="p">=</span> <span class="n">Camera</span><span class="p">(</span><span class="n">Vector</span><span class="p">(</span>0<span class="p">,</span>0<span class="p">.</span>56<span class="p">,</span>8<span class="p">),</span><span class="n">Vector</span><span class="p">(</span>0<span class="p">,</span>0<span class="p">,</span><span class="o">-</span>1<span class="p">),</span><span class="n">Vector</span><span class="p">(</span>0<span class="p">,</span>1<span class="p">,</span>0<span class="p">),</span>30<span class="p">,</span><span class="n">aspectratio</span><span class="p">)</span>
    <span class="n">camera</span><span class="p">.</span><span class="n">initialize</span><span class="p">()</span>

    <span class="nb">sphere</span> <span class="p">=</span> <span class="n">Sphere</span><span class="p">(</span><span class="n">Vector</span><span class="p">(</span>1<span class="p">.</span>5<span class="p">,</span>0<span class="p">,</span><span class="o">-</span>1<span class="p">),</span>1<span class="p">)</span>
    <span class="nb">sphere</span><span class="p">.</span><span class="n">material</span> <span class="p">=</span> <span class="n">PhongMaterial</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">red</span><span class="p">,</span> <span class="n">Color</span><span class="p">.</span><span class="nb">white</span><span class="p">,</span> 500<span class="p">,</span>0<span class="p">.</span>25<span class="p">)</span>

    <span class="n">sphere2</span> <span class="p">=</span> <span class="n">Sphere</span><span class="p">(</span><span class="n">Vector</span><span class="p">(</span><span class="o">-</span>1<span class="p">.</span>5<span class="p">,</span>0<span class="p">,</span><span class="o">-</span>1<span class="p">),</span>1<span class="p">)</span>
    <span class="n">sphere2</span><span class="p">.</span><span class="n">material</span> <span class="p">=</span> <span class="n">PhongMaterial</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">gold</span><span class="p">,</span> <span class="n">Color</span><span class="p">.</span><span class="nb">white</span><span class="p">,</span> 500<span class="p">,</span>0<span class="p">.</span>25<span class="p">)</span>

    <span class="n">sphere3</span> <span class="p">=</span> <span class="n">Sphere</span><span class="p">(</span><span class="n">Vector</span><span class="p">(</span>0<span class="p">,</span>0<span class="p">,</span><span class="o">-</span>2<span class="p">),</span>1<span class="p">)</span>
    <span class="n">sphere3</span><span class="p">.</span><span class="n">material</span> <span class="p">=</span> <span class="n">PhongMaterial</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">blue</span><span class="p">,</span> <span class="n">Color</span><span class="p">.</span><span class="nb">white</span><span class="p">,</span> 500<span class="p">,</span>0<span class="p">.</span>25<span class="p">)</span>

    <span class="n">plane</span> <span class="p">=</span> <span class="n">Plane</span><span class="p">(</span><span class="n">Vector</span><span class="p">(</span>0<span class="p">,</span>1<span class="p">,</span>0<span class="p">),</span><span class="o">-</span>1<span class="p">)</span>
    <span class="k">if</span> <span class="n">CHECKER_PATTERN</span><span class="p">:</span>
        <span class="n">plane</span><span class="p">.</span><span class="n">material</span> <span class="p">=</span> <span class="n">CheckerMaterial</span><span class="p">(</span>0<span class="p">.</span>1<span class="p">,</span>0<span class="p">.</span>9<span class="p">);</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plane</span><span class="p">.</span><span class="n">material</span> <span class="p">=</span> <span class="n">PhongMaterial</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">cyan</span><span class="p">,</span> <span class="n">Color</span><span class="p">.</span><span class="nb">white</span><span class="p">,</span> 500<span class="p">,</span>1<span class="p">.</span>0<span class="p">)</span>

    <span class="n">scene</span> <span class="p">=</span> <span class="n">Union</span><span class="p">([</span><span class="n">plane</span><span class="p">,</span><span class="nb">sphere</span><span class="p">,</span><span class="n">sphere2</span><span class="p">,</span><span class="n">sphere3</span><span class="p">])</span>
    <span class="n">scene</span><span class="p">.</span><span class="n">initialize</span><span class="p">()</span>

    <span class="n">maxDepth</span> <span class="p">=</span> 20

    <span class="n">imgdata</span> <span class="p">=</span> <span class="n">ctx</span><span class="p">.</span><span class="n">createImageData</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">h</span><span class="p">)</span>
    <span class="c">#start</span>
    <span class="k">for</span> <span class="n">y</span> <span class="n">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">x</span> <span class="n">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
            <span class="n">sy</span> <span class="p">=</span> 1<span class="o">-</span> <span class="n">y</span><span class="o">/</span><span class="n">h</span>
            <span class="n">sx</span> <span class="p">=</span> <span class="n">x</span><span class="o">/</span><span class="n">w</span>
            <span class="nb">index</span> <span class="p">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span> <span class="o">*</span> 4
            <span class="n">ray</span> <span class="p">=</span> <span class="n">camera</span><span class="p">.</span><span class="n">generateRay</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">)</span>
            <span class="n">result</span> <span class="p">=</span> <span class="n">scene</span><span class="p">.</span><span class="nb">intersect</span><span class="p">(</span><span class="n">ray</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">sceneobject</span> <span class="o">!=</span> <span class="nb">null</span><span class="p">):</span>
                <span class="n">col</span> <span class="p">=</span>  <span class="n">rayTraceRecursive</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="n">ray</span><span class="p">,</span> 4<span class="p">)</span>
                <span class="n">imgdata</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="nb">index</span> <span class="o">+</span> 0<span class="p">]</span> <span class="p">=</span> <span class="n">col</span><span class="p">.</span><span class="n">r</span> <span class="o">*</span> 255
                <span class="n">imgdata</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="nb">index</span> <span class="o">+</span> 1<span class="p">]</span> <span class="p">=</span> <span class="n">col</span><span class="p">.</span><span class="n">g</span> <span class="o">*</span> 255
                <span class="n">imgdata</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="nb">index</span> <span class="o">+</span> 2<span class="p">]</span> <span class="p">=</span> <span class="n">col</span><span class="p">.</span><span class="n">b</span> <span class="o">*</span> 255
                <span class="n">imgdata</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="nb">index</span> <span class="o">+</span> 3<span class="p">]</span> <span class="p">=</span> 255
            <span class="k">else</span><span class="p">:</span>
                <span class="n">imgdata</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="nb">index</span> <span class="o">+</span> 0<span class="p">]</span> <span class="p">=</span> 0
                <span class="n">imgdata</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="nb">index</span> <span class="o">+</span> 1<span class="p">]</span> <span class="p">=</span> 0
                <span class="n">imgdata</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="nb">index</span> <span class="o">+</span> 2<span class="p">]</span> <span class="p">=</span> 0
                <span class="n">imgdata</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="nb">index</span> <span class="o">+</span> 3<span class="p">]</span> <span class="p">=</span> 255

    <span class="n">ctx</span><span class="p">.</span><span class="n">putImageData</span><span class="p">(</span><span class="n">imgdata</span><span class="p">,</span>1<span class="p">,</span>0<span class="p">)</span>

<span class="n">toggle</span> <span class="p">=</span> <span class="n">document</span><span class="p">.</span><span class="n">getElementById</span><span class="p">(</span><span class="s">'toggle'</span><span class="p">)</span>
<span class="n">toggle</span><span class="p">.</span><span class="n">onclick</span> <span class="p">=</span> <span class="n">def</span><span class="p">():</span>
    <span class="n">nonlocal</span> <span class="n">CHECKER_PATTERN</span>
    <span class="n">CHECKER_PATTERN</span> <span class="p">=</span> <span class="nb">not</span> <span class="n">CHECKER_PATTERN</span>
    <span class="n">main</span><span class="p">()</span>
<span class="n">main</span><span class="p">()</span>
</pre></div>


<h2>Stocks App Example</h2>
<p>Copyright 2013 Pyjeon Software LLC<br/>
Author: Alexander Tsepkov<br/>
License: Creative Commons: Attribution + Noncommerial + ShareAlike  </p>
<p><img alt="Preview" src="https://bitbucket.org/pyjeon/rapydscript/raw/default/examples/stocks/preview.png" title="Preview Screenshot"/></p>
<p>This is a web app for retrieving stock information from Google Finance and displaying it in a chart. The app also allows the user to modify the way stock data is presented. This app showcases:</p>
<ul>
<li>Including stdlib as an import instead of a separate js file</li>
<li>Integration with Google Charts API</li>
<li>Ability to wrap/abstract entire APIs in separate classes (YQL and Google Charts)</li>
<li>Ability to create Pyjamas-like widgets that wrap around existing elements and extend their functionality (stock picker input widget, stock chart widget)</li>
<li>Ability to work with Flash (Google Charts API currently uses Flash for rendering)</li>
<li>Pulling data from outside sources via YQL (NASDAQ and Google Finance)</li>
<li>Asynchronous coding via RapydScript</li>
<li>RapydScript integration with RapydML and RapydCSS/SASS</li>
</ul>
<h3>stocks.pyj</h3>
<div class="codehilite"><pre><span class="c">######################################################</span>
<span class="c"># Copyright 2013 Pyjeon Software LLC</span>
<span class="c"># Author:   Alexander Tsepkov</span>
<span class="c"># License: Creative Commons: Attribution + Noncommerial + ShareAlike</span>
<span class="c">######################################################</span>

<span class="n">import</span> <span class="n">stdlib</span>
<span class="n">import</span> <span class="n">yql</span>

<span class="nb">class</span> <span class="n">Stock</span><span class="p">:</span>
    <span class="s">"""</span>
<span class="s">    Class responsible for tracking stock information. It handles tracking current stock name</span>
<span class="s">    as well as performing the YQL query to retrieve stock data from Google and storing the</span>
<span class="s">    data.</span>
<span class="s">    """</span>
    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">callback</span><span class="p">=</span><span class="n">None</span><span class="p">):</span>

        <span class="n">self</span><span class="p">.</span><span class="n">callback</span> <span class="p">=</span> <span class="n">callback</span>

        <span class="c"># pre-cache these so we're not retrieving the element again on every blur/enter event</span>
        $<span class="n">start</span> <span class="p">=</span> $<span class="p">(</span><span class="s">'#start-date'</span><span class="p">)</span>
        $<span class="k">end</span> <span class="p">=</span> $<span class="p">(</span><span class="s">'#end-date'</span><span class="p">)</span>
        <span class="n">onUpdate</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span>$<span class="n">event</span><span class="p">,</span> <span class="n">ui</span><span class="p">):</span>
            <span class="c"># select triggers before the update occurs, so we have to use 'select' name instead of .val()</span>
            <span class="k">if</span> $<span class="n">event</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="s">'autocompleteselect'</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span>$<span class="n">widget</span><span class="p">.</span><span class="n">val</span><span class="p">(</span><span class="n">ui</span><span class="p">.</span><span class="n">item</span><span class="p">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">startdate</span> <span class="p">=</span> $<span class="n">start</span><span class="p">.</span><span class="n">val</span><span class="p">()</span>
            <span class="n">enddate</span> <span class="p">=</span> $<span class="k">end</span><span class="p">.</span><span class="n">val</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span>$<span class="n">widget</span> <span class="p">=</span> $<span class="p">(</span><span class="s">'&lt;input&gt;&lt;/input&gt;'</span><span class="p">).</span><span class="n">autocomplete</span><span class="p">({</span>
            <span class="s">'minLength'</span><span class="p">:</span>    2<span class="p">,</span>
            <span class="s">'source'</span><span class="p">:</span>       <span class="n">symbols</span><span class="p">,</span>
            <span class="s">'select'</span><span class="p">:</span>       <span class="n">onUpdate</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">self</span><span class="p">.</span><span class="n">data</span> <span class="p">=</span> <span class="n">None</span>
        <span class="n">self</span><span class="p">.</span>$<span class="n">widget</span><span class="p">.</span><span class="n">blur</span><span class="p">(</span><span class="n">onUpdate</span><span class="p">)</span>

        <span class="n">ENTER</span> <span class="p">=</span> 13
        <span class="n">onKeypress</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span>$<span class="n">event</span><span class="p">):</span>
            <span class="n">code</span> <span class="p">=</span> $<span class="n">event</span><span class="p">.</span><span class="n">keyCode</span> <span class="nb">or</span> $<span class="n">event</span><span class="p">.</span><span class="n">which</span>
            <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="n">ENTER</span><span class="p">:</span>
                <span class="n">onUpdate</span><span class="p">(</span>$<span class="n">event</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span>$<span class="n">widget</span><span class="p">.</span><span class="n">keypress</span><span class="p">(</span><span class="n">onKeypress</span><span class="p">)</span>

    <span class="n">def</span> <span class="k">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">startDate</span><span class="p">,</span> <span class="n">endDate</span><span class="p">):</span>
        <span class="s">"""</span>
<span class="s">        get method for this stock, which retrieves info from google finance</span>
<span class="s">        """</span>
        <span class="n">name</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span>$<span class="n">widget</span><span class="p">.</span><span class="n">val</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">symbol</span> <span class="o">==</span> <span class="n">name</span> <span class="nb">and</span> <span class="n">self</span><span class="p">.</span><span class="n">startDate</span> <span class="o">==</span> <span class="n">startDate</span> <span class="nb">and</span> <span class="n">self</span><span class="p">.</span><span class="n">endDate</span> <span class="o">==</span> <span class="n">endDate</span><span class="p">:</span>
            <span class="c"># don't trigger a refresh unless the parameters have been updated</span>
            <span class="k">return</span>
        <span class="n">self</span><span class="p">.</span><span class="n">symbol</span> <span class="p">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">startDate</span> <span class="p">=</span> <span class="n">startDate</span>
        <span class="n">self</span><span class="p">.</span><span class="n">endDate</span> <span class="p">=</span> <span class="n">endDate</span>

        <span class="n">format</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="nb">date</span><span class="p">):</span>
            <span class="n">mmddyyyy</span> <span class="p">=</span> <span class="nb">date</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
            <span class="k">return</span> <span class="s">'-'</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="n">mmddyyyy</span><span class="p">[</span>2<span class="p">],</span> <span class="n">mmddyyyy</span><span class="p">[</span>0<span class="p">],</span> <span class="n">mmddyyyy</span><span class="p">[</span>1<span class="p">]])</span>

        <span class="c"># google's historical data is only available in CSV format, but we need it in</span>
        <span class="c"># JSON if we want to work with it in JavaScript. We will use Yahoo's YQL to</span>
        <span class="c"># convert it. We will also need to create a callback function, since the request</span>
        <span class="c"># is asynchronous</span>
        <span class="n">onUpdate</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">query</span><span class="p">[</span><span class="s">'results'</span><span class="p">]</span> <span class="n">is</span> <span class="n">None</span><span class="p">:</span>
                <span class="c"># bad symbol</span>
                <span class="n">self</span><span class="p">.</span><span class="n">data</span> <span class="p">=</span> <span class="n">None</span>
                <span class="n">self</span><span class="p">.</span>$<span class="n">widget</span><span class="p">.</span><span class="n">css</span><span class="p">(</span><span class="s">'background'</span><span class="p">,</span> <span class="s">'#fdd'</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">data</span> <span class="p">=</span> <span class="n">query</span><span class="p">[</span><span class="s">'results'</span><span class="p">][</span><span class="s">'row'</span><span class="p">]</span>
                <span class="n">self</span><span class="p">.</span>$<span class="n">widget</span><span class="p">.</span><span class="n">css</span><span class="p">(</span><span class="s">'background'</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">callback</span> <span class="n">is</span> <span class="nb">not</span> <span class="n">None</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">callback</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">symbol</span> <span class="o">!=</span> <span class="s">''</span><span class="p">:</span>
            <span class="c"># we will use csv version of the data to avoid dealing with unnecessary html</span>
            <span class="n">url</span> <span class="p">=</span> <span class="s">'http://www.google.com/finance/historical?q='</span> <span class="o">+</span> <span class="n">name</span> <span class="o">\</span>
                <span class="o">+</span> <span class="s">'&amp;startdate='</span> <span class="o">+</span> <span class="n">format</span><span class="p">(</span><span class="n">startDate</span><span class="p">)</span> <span class="o">\</span>
                <span class="o">+</span> <span class="s">'&amp;enddate='</span> <span class="o">+</span> <span class="n">format</span><span class="p">(</span><span class="n">endDate</span><span class="p">)</span> <span class="o">+</span> <span class="s">'&amp;output=csv'</span>

            <span class="n">YQL</span><span class="p">(</span><span class="s">'select * from csv where url="'</span> <span class="o">+</span> <span class="n">url</span> <span class="o">+</span> <span class="s">'"'</span><span class="p">,</span> <span class="n">onUpdate</span><span class="p">).</span><span class="n">fetch</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># box is blank, don't try to request YQL for it</span>
            <span class="n">self</span><span class="p">.</span><span class="n">data</span> <span class="p">=</span> <span class="n">None</span>
            <span class="n">self</span><span class="p">.</span>$<span class="n">widget</span><span class="p">.</span><span class="n">css</span><span class="p">(</span><span class="s">'background'</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">callback</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>

<span class="nb">class</span> <span class="n">StockChart</span><span class="p">:</span>
    <span class="s">"""</span>
<span class="s">    This is a wrapper around Google Charts. It handles displaying and updating the chart,</span>
<span class="s">    abstracting Google Charts away from the rest of the app. It also handles compiling</span>
<span class="s">    the data in a representation Google Charts supports since the format of the API is</span>
<span class="s">    somewhat clunky compared to other plotting tools like jqPlot. The only thing it doesn't</span>
<span class="s">    wrap around is the loading logic for Google Charts API, unfortunately, which is due to</span>
<span class="s">    awkward loading implementation on Google's part.</span>
<span class="s">    """</span>
    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        $<span class="n">options</span> <span class="p">=</span> $<span class="p">(</span><span class="s">'#chart-options'</span><span class="p">)</span>

        <span class="c"># create various technical indicator filters the user can play with</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_filters</span> <span class="p">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_filterLogic</span> <span class="p">=</span> <span class="p">{}</span>
        <span class="n">addFilter</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">callback</span><span class="p">):</span>
            $<span class="n">button</span> <span class="p">=</span> $<span class="p">(</span><span class="s">'&lt;input type="checkbox" value="'</span>
                    <span class="o">+</span> <span class="n">name</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">' '</span><span class="p">,</span> <span class="s">'-'</span><span class="p">)</span> <span class="o">+</span> <span class="s">'"&gt;'</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">'&lt;/input&gt;'</span><span class="p">)</span>
            $<span class="n">options</span><span class="p">.</span><span class="n">append</span><span class="p">(</span>$<span class="n">button</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_filterLogic</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="p">=</span> <span class="n">callback</span>
            <span class="n">setFilter</span> <span class="p">=</span> <span class="n">def</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_filters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="p">=</span> $<span class="p">(</span><span class="n">this</span><span class="p">).</span><span class="n">is</span><span class="p">(</span><span class="s">':checked'</span><span class="p">)</span>
                <span class="n">self</span><span class="p">.</span><span class="n">redraw</span><span class="p">()</span>
            $<span class="n">button</span><span class="p">.</span><span class="n">click</span><span class="p">(</span><span class="n">setFilter</span><span class="p">)</span>

        <span class="n">normalize</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="nb">rows</span><span class="p">):</span>
            <span class="c"># divide all stocks by their starting value so we can compare them better</span>
            <span class="n">normalized</span> <span class="p">=</span> <span class="p">[]</span>
            <span class="n">orig</span> <span class="p">=</span> <span class="nb">rows</span><span class="p">[</span><span class="n">len</span><span class="p">(</span><span class="nb">rows</span><span class="p">)</span><span class="o">-</span>1<span class="p">]</span>
            <span class="k">for</span> <span class="n">day</span><span class="p">,</span> <span class="n">row</span> <span class="n">in</span> <span class="n">enumerate</span><span class="p">(</span><span class="nb">rows</span><span class="p">):</span>
                <span class="n">normalized</span><span class="p">.</span><span class="n">append</span><span class="p">([</span><span class="n">row</span><span class="p">[</span>0<span class="p">]])</span>
                <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">stock</span> <span class="n">in</span> <span class="n">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">[</span>1<span class="p">:]):</span>
                    <span class="n">normalized</span><span class="p">[</span><span class="n">day</span><span class="p">].</span><span class="n">append</span><span class="p">(</span><span class="n">stock</span><span class="o">/</span><span class="n">orig</span><span class="p">[</span><span class="n">num</span><span class="o">+</span>1<span class="p">])</span>
            <span class="k">return</span> <span class="n">cols</span><span class="p">,</span> <span class="n">normalized</span>
        <span class="n">makeMovingAvg</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">days</span><span class="p">,</span> <span class="n">ema</span><span class="p">):</span>
            <span class="nb">sum</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
            <span class="k">return</span> <span class="n">name</span><span class="p">,</span> <span class="n">def</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="nb">rows</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">col</span> <span class="n">in</span> <span class="n">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">col</span><span class="p">[</span><span class="n">len</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">-</span>1<span class="p">]</span> <span class="o">!=</span> <span class="s">')'</span><span class="p">:</span>
                        <span class="n">avgs</span> <span class="p">=</span> <span class="p">[{}]</span>
                        <span class="n">moving</span> <span class="p">=</span> <span class="p">[]</span>
                        <span class="k">if</span> <span class="n">ema</span><span class="p">:</span>
                            <span class="n">alpha</span> <span class="p">=</span> 2<span class="o">/</span><span class="p">(</span><span class="n">days</span><span class="o">+</span>1<span class="p">)</span>
                            <span class="n">moving</span> <span class="p">=</span> <span class="nb">rows</span><span class="p">[</span><span class="n">len</span><span class="p">(</span><span class="nb">rows</span><span class="p">)</span><span class="o">-</span>1<span class="p">][</span><span class="n">idx</span><span class="o">+</span>1<span class="p">]</span>
                        <span class="k">for</span> <span class="n">row</span> <span class="n">in</span> <span class="n">reversed</span><span class="p">(</span><span class="nb">rows</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">ema</span><span class="p">:</span>
                                <span class="n">moving</span> <span class="p">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">row</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span>1<span class="p">]</span> <span class="o">+</span> <span class="p">(</span>1<span class="o">-</span><span class="n">alpha</span><span class="p">)</span><span class="o">*</span><span class="n">moving</span>
                                <span class="n">avgs</span><span class="p">.</span><span class="n">unshift</span><span class="p">({</span><span class="s">'col4'</span><span class="p">:</span> <span class="n">moving</span><span class="p">})</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">moving</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span>1<span class="p">])</span>
                                <span class="n">avgs</span><span class="p">.</span><span class="n">unshift</span><span class="p">({</span><span class="s">'col4'</span><span class="p">:</span> <span class="n">moving</span><span class="p">.</span><span class="n">reduce</span><span class="p">(</span><span class="nb">sum</span><span class="p">)</span><span class="o">/</span><span class="n">len</span><span class="p">(</span><span class="n">moving</span><span class="p">)})</span>
                                <span class="k">if</span> <span class="n">len</span><span class="p">(</span><span class="n">moving</span><span class="p">)</span> <span class="o">&gt;</span><span class="p">=</span> <span class="n">days</span><span class="p">:</span>
                                    <span class="n">moving</span><span class="p">.</span><span class="nb">shift</span><span class="p">()</span>
                        <span class="n">self</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">col</span> <span class="o">+</span> <span class="s">' ('</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">')'</span><span class="p">,</span> <span class="n">avgs</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="nb">rows</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">cols</span><span class="p">,</span> <span class="nb">rows</span>
        <span class="n">rsi</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="nb">rows</span><span class="p">):</span>
            <span class="c"># relative strength index filter</span>
            <span class="n">tmp</span><span class="p">,</span> <span class="n">ema15</span> <span class="p">=</span> <span class="n">makeMovingAvg</span><span class="p">(</span><span class="s">''</span><span class="p">,</span> 15<span class="p">,</span> <span class="n">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">col</span> <span class="n">in</span> <span class="n">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">col</span><span class="p">[</span><span class="n">len</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">-</span>1<span class="p">]</span> <span class="o">!=</span> <span class="s">')'</span><span class="p">:</span>
                    <span class="n">rsis</span> <span class="p">=</span> <span class="p">[{}]</span>
                    <span class="n">ups</span> <span class="p">=</span> <span class="p">[]</span>
                    <span class="n">downs</span> <span class="p">=</span> <span class="p">[]</span>
                    <span class="n">prev</span> <span class="p">=</span> <span class="nb">rows</span><span class="p">[</span><span class="n">len</span><span class="p">(</span><span class="nb">rows</span><span class="p">)</span><span class="o">-</span>1<span class="p">][</span><span class="n">idx</span><span class="o">+</span>1<span class="p">]</span>
                    <span class="k">for</span> <span class="n">row</span> <span class="n">in</span> <span class="n">reversed</span><span class="p">(</span><span class="nb">rows</span><span class="p">):</span>
                        <span class="n">current</span> <span class="p">=</span> <span class="n">row</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span>1<span class="p">]</span>
                        <span class="n">DATE</span> <span class="p">=</span> 0    <span class="c"># fake date placeholder</span>
                        <span class="k">if</span> <span class="n">current</span> <span class="o">&gt;</span> <span class="n">prev</span><span class="p">:</span>
                            <span class="n">ups</span><span class="p">.</span><span class="n">unshift</span><span class="p">([</span><span class="n">DATE</span><span class="p">,</span> <span class="n">current</span><span class="o">-</span><span class="n">prev</span><span class="p">])</span>
                            <span class="n">downs</span><span class="p">.</span><span class="n">unshift</span><span class="p">([</span><span class="n">DATE</span><span class="p">,</span> 0<span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ups</span><span class="p">.</span><span class="n">unshift</span><span class="p">([</span><span class="n">DATE</span><span class="p">,</span> 0<span class="p">])</span>
                            <span class="n">downs</span><span class="p">.</span><span class="n">unshift</span><span class="p">([</span><span class="n">DATE</span><span class="p">,</span> <span class="n">prev</span><span class="o">-</span><span class="n">current</span><span class="p">])</span>
                        <span class="n">prev</span> <span class="p">=</span> <span class="n">current</span>
                    <span class="n">tmp</span><span class="p">,</span> <span class="n">ups</span> <span class="p">=</span> <span class="n">ema15</span><span class="p">([</span><span class="s">'up'</span><span class="p">],</span> <span class="n">ups</span><span class="p">)</span>
                    <span class="n">tmp</span><span class="p">,</span> <span class="n">downs</span> <span class="p">=</span> <span class="n">ema15</span><span class="p">([</span><span class="s">'down'</span><span class="p">],</span> <span class="n">downs</span><span class="p">)</span>
                    <span class="k">for</span> <span class="nb">index</span> <span class="n">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">len</span><span class="p">(</span><span class="n">ups</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="n">downs</span><span class="p">[</span><span class="nb">index</span><span class="p">][</span>2<span class="p">]:</span>
                            <span class="n">rs</span> <span class="p">=</span> <span class="n">ups</span><span class="p">[</span><span class="nb">index</span><span class="p">][</span>2<span class="p">]</span><span class="o">/</span><span class="n">downs</span><span class="p">[</span><span class="nb">index</span><span class="p">][</span>2<span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">rs</span> <span class="p">=</span> 100
                        <span class="n">rsis</span><span class="p">.</span><span class="n">append</span><span class="p">({</span><span class="s">'col4'</span><span class="p">:</span> 100<span class="o">-</span>100<span class="o">/</span><span class="p">(</span>1<span class="o">+</span><span class="n">rs</span><span class="p">)})</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">col</span> <span class="o">+</span> <span class="s">' (RSI)'</span><span class="p">,</span> <span class="n">rsis</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="nb">rows</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cols</span><span class="p">,</span> <span class="nb">rows</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">fun</span> <span class="n">in</span> <span class="p">[</span><span class="o">\</span>
                <span class="p">(</span><span class="s">'Normalize'</span><span class="p">,</span> <span class="n">normalize</span><span class="p">),</span> <span class="o">\</span>
                <span class="n">makeMovingAvg</span><span class="p">(</span><span class="s">'15-Day SMA'</span><span class="p">,</span> 15<span class="p">,</span> <span class="n">False</span><span class="p">),</span> <span class="o">\</span>
                <span class="n">makeMovingAvg</span><span class="p">(</span><span class="s">'50-Day SMA'</span><span class="p">,</span> 50<span class="p">,</span> <span class="n">False</span><span class="p">),</span> <span class="o">\</span>
                <span class="n">makeMovingAvg</span><span class="p">(</span><span class="s">'15-Day EMA'</span><span class="p">,</span> 15<span class="p">,</span> <span class="n">True</span><span class="p">),</span> <span class="o">\</span>
                <span class="n">makeMovingAvg</span><span class="p">(</span><span class="s">'50-Day EMA'</span><span class="p">,</span> 50<span class="p">,</span> <span class="n">True</span><span class="p">),</span> <span class="o">\</span>
                <span class="p">(</span><span class="s">'15-Day RSI'</span><span class="p">,</span> <span class="n">rsi</span><span class="p">)]:</span>
            <span class="n">addFilter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fun</span><span class="p">)</span>

        <span class="c"># this is an external API, so we have to use the 'new' keyword</span>
        <span class="n">self</span><span class="p">.</span><span class="n">annotatedTimeline</span> <span class="p">=</span> <span class="n">new</span> <span class="n">google</span><span class="p">.</span><span class="n">visualization</span><span class="p">.</span><span class="n">AnnotatedTimeLine</span><span class="p">(</span>$<span class="p">(</span><span class="s">'#chart'</span><span class="p">).</span><span class="k">get</span><span class="p">(</span>0<span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="n">def</span> <span class="n">clear</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cols</span> <span class="p">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_rows</span> <span class="p">=</span> <span class="p">[]</span>

    <span class="n">def</span> <span class="n">add</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">cols</span><span class="p">=</span><span class="n">self</span><span class="p">.</span><span class="n">_cols</span><span class="p">,</span> <span class="nb">rows</span><span class="p">=</span><span class="n">self</span><span class="p">.</span><span class="n">_rows</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">data</span> <span class="n">is</span> <span class="nb">not</span> <span class="n">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">not</span> <span class="n">len</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
                <span class="c"># this is the first symbol, create rows and append date</span>
                <span class="k">for</span> <span class="n">item</span> <span class="n">in</span> <span class="n">data</span><span class="p">[</span>1<span class="p">:]:</span>
                    <span class="nb">rows</span><span class="p">.</span><span class="n">append</span><span class="p">([</span><span class="n">Date</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s">'col0'</span><span class="p">]),</span> <span class="n">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s">'col4'</span><span class="p">])])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># rows have already been generated, just append to them</span>
                <span class="k">for</span> <span class="nb">index</span><span class="p">,</span> <span class="n">item</span> <span class="n">in</span> <span class="n">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">[</span>1<span class="p">:]):</span>
                    <span class="nb">rows</span><span class="p">[</span><span class="nb">index</span><span class="p">].</span><span class="n">append</span><span class="p">(</span><span class="n">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s">'col4'</span><span class="p">]))</span>
            <span class="n">cols</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">redraw</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c"># make a deep-copies of the data</span>
        <span class="n">cols</span> <span class="p">=</span> $<span class="p">.</span><span class="n">extend</span><span class="p">(</span><span class="n">True</span><span class="p">,</span> <span class="p">[],</span> <span class="n">self</span><span class="p">.</span><span class="n">_cols</span><span class="p">)</span>
        <span class="nb">rows</span> <span class="p">=</span> $<span class="p">.</span><span class="n">extend</span><span class="p">(</span><span class="n">True</span><span class="p">,</span> <span class="p">[],</span> <span class="n">self</span><span class="p">.</span><span class="n">_rows</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="n">in</span> <span class="n">dict</span><span class="p">.</span><span class="n">items</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_filters</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
                <span class="n">cols</span><span class="p">,</span> <span class="nb">rows</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_filterLogic</span><span class="p">[</span><span class="n">key</span><span class="p">](</span><span class="n">cols</span><span class="p">,</span> <span class="nb">rows</span><span class="p">)</span>

        <span class="n">data</span> <span class="p">=</span> <span class="n">new</span> <span class="n">google</span><span class="p">.</span><span class="n">visualization</span><span class="p">.</span><span class="n">DataTable</span><span class="p">()</span>
        <span class="n">data</span><span class="p">.</span><span class="n">addColumn</span><span class="p">(</span><span class="s">'date'</span><span class="p">,</span> <span class="s">'Date'</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="n">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="n">data</span><span class="p">.</span><span class="n">addColumn</span><span class="p">(</span><span class="s">'number'</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
        <span class="n">data</span><span class="p">.</span><span class="n">addRows</span><span class="p">(</span><span class="nb">rows</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">annotatedTimeline</span><span class="p">.</span><span class="n">draw</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">{})</span>

<span class="n">def</span> <span class="n">main</span><span class="p">():</span>
    <span class="n">stockFields</span> <span class="p">=</span> <span class="p">[]</span>

    <span class="c"># declare a dummy method to avoid errors in case it is triggered before Google Charts finish loading</span>
    <span class="n">updateChart</span> <span class="p">=</span> <span class="n">def</span><span class="p">():</span>
        <span class="n">pass</span>

    <span class="c"># load charting widget</span>
    <span class="n">onChartLoad</span> <span class="p">=</span> <span class="n">def</span><span class="p">():</span>
        <span class="n">nonlocal</span> <span class="n">updateChart</span>
        <span class="n">chart</span> <span class="p">=</span> <span class="n">StockChart</span><span class="p">()</span>
        <span class="n">updateChart</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
            <span class="n">chart</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">stock</span> <span class="n">in</span> <span class="n">stockFields</span><span class="p">:</span>
                <span class="n">chart</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">stock</span><span class="p">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">stock</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">chart</span><span class="p">.</span><span class="n">redraw</span><span class="p">()</span>
    <span class="n">google</span><span class="p">.</span><span class="nb">load</span><span class="p">(</span><span class="s">'visualization'</span><span class="p">,</span> <span class="s">'1'</span><span class="p">,</span> <span class="p">{</span><span class="s">'packages'</span><span class="p">:[</span><span class="s">'annotatedtimeline'</span><span class="p">],</span> <span class="s">'callback'</span><span class="p">:</span> <span class="n">onChartLoad</span><span class="p">})</span>

    <span class="c"># set up stock picker and dates</span>
    <span class="n">triggerChange</span> <span class="p">=</span> <span class="n">def</span><span class="p">():</span>
        $<span class="p">(</span><span class="n">this</span><span class="p">).</span><span class="n">change</span><span class="p">()</span>
    $<span class="n">start</span> <span class="p">=</span> $<span class="p">(</span><span class="s">'#start-date'</span><span class="p">).</span><span class="n">datepicker</span><span class="p">({</span><span class="s">'onSelect'</span><span class="p">:</span> <span class="n">triggerChange</span><span class="p">})</span>
    $<span class="k">end</span> <span class="p">=</span> $<span class="p">(</span><span class="s">'#end-date'</span><span class="p">).</span><span class="n">datepicker</span><span class="p">({</span><span class="s">'onSelect'</span><span class="p">:</span> <span class="n">triggerChange</span><span class="p">})</span>
    $<span class="n">start</span><span class="p">.</span><span class="n">datepicker</span><span class="p">(</span><span class="s">'setDate'</span><span class="p">,</span> <span class="o">-</span>90<span class="p">)</span>
    $<span class="k">end</span><span class="p">.</span><span class="n">datepicker</span><span class="p">(</span><span class="s">'setDate'</span><span class="p">,</span> <span class="n">Date</span><span class="p">())</span>

    <span class="n">symbols</span> <span class="p">=</span> <span class="p">[]</span>
    $<span class="n">stocks</span> <span class="p">=</span> $<span class="p">(</span><span class="s">'#stock-input'</span><span class="p">)</span>

    <span class="c"># add new input widget</span>
    <span class="n">newStock</span> <span class="p">=</span> <span class="n">def</span><span class="p">():</span>
        <span class="n">symbol</span> <span class="p">=</span> <span class="n">Stock</span><span class="p">(</span><span class="n">symbols</span><span class="p">)</span>
        $<span class="n">stocks</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">symbol</span><span class="p">.</span>$<span class="n">widget</span><span class="p">)</span>
        <span class="k">get</span> <span class="p">=</span> <span class="n">def</span><span class="p">():</span>
            <span class="n">startdate</span> <span class="p">=</span> $<span class="n">start</span><span class="p">.</span><span class="n">val</span><span class="p">()</span>
            <span class="n">enddate</span> <span class="p">=</span> $<span class="k">end</span><span class="p">.</span><span class="n">val</span><span class="p">()</span>
            <span class="n">symbol</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">)</span>
        $<span class="n">start</span><span class="p">.</span><span class="n">change</span><span class="p">(</span><span class="k">get</span><span class="p">)</span>
        $<span class="k">end</span><span class="p">.</span><span class="n">change</span><span class="p">(</span><span class="k">get</span><span class="p">)</span>
        <span class="n">stockFields</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>

        <span class="c"># handle addition and removal of new widgets</span>
        <span class="c"># new widgets will get added when there are no more empty widgets</span>
        <span class="c"># empty widgets will get removed when there is more than one</span>
        <span class="n">onWidgetUpdate</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
            <span class="n">value</span> <span class="p">=</span> <span class="n">symbol</span><span class="p">.</span><span class="n">symbol</span>
            <span class="n">isLast</span> <span class="p">=</span> <span class="n">symbol</span><span class="p">.</span>$<span class="n">widget</span><span class="p">.</span><span class="n">is</span><span class="p">(</span><span class="s">':last-child'</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">isLast</span> <span class="nb">and</span> <span class="n">value</span> <span class="o">!=</span> <span class="s">''</span><span class="p">:</span>
                <span class="n">newStock</span><span class="p">()</span>
            <span class="n">elif</span> <span class="n">value</span> <span class="o">==</span> <span class="s">''</span> <span class="nb">and</span> <span class="nb">not</span> <span class="n">isLast</span><span class="p">:</span>
                <span class="n">stockFields</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
                <span class="n">symbol</span><span class="p">.</span>$<span class="n">widget</span><span class="p">.</span><span class="n">remove</span><span class="p">()</span>
            <span class="n">updateChart</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">symbol</span><span class="p">.</span><span class="n">callback</span> <span class="p">=</span> <span class="n">onWidgetUpdate</span>

    <span class="c"># NASDAQ returns stock symbols in CSV format as well, YQL will convert them for us</span>
    <span class="c"># it also seems to store companies from other stock exchanges, which makes work easier for us</span>
    <span class="n">sync</span> <span class="p">=</span> 0
    <span class="n">exchanges</span> <span class="p">=</span> <span class="p">[</span><span class="s">'nyse'</span><span class="p">,</span> <span class="s">'nasdaq'</span><span class="p">,</span> <span class="s">'lon'</span><span class="p">]</span>
    <span class="n">onUpdate</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
        <span class="n">nonlocal</span> <span class="n">sync</span><span class="p">,</span> <span class="n">symbols</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="n">in</span> <span class="n">query</span><span class="p">[</span><span class="s">'results'</span><span class="p">][</span><span class="s">'row'</span><span class="p">]:</span>
            <span class="n">symbols</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">symbol</span><span class="p">[</span><span class="s">'col0'</span><span class="p">])</span>
        <span class="n">sync</span> <span class="o">+=</span> 1

        <span class="k">if</span> <span class="n">sync</span> <span class="o">==</span> <span class="n">len</span><span class="p">(</span><span class="n">exchanges</span><span class="p">):</span>
            <span class="c"># all exchanges loaded, remove duplicates and create stock picker</span>
            $<span class="n">stocks</span><span class="p">.</span><span class="nb">text</span><span class="p">(</span><span class="s">'Stocks:'</span><span class="p">)</span>
            <span class="nb">unique</span> <span class="p">=</span> <span class="n">def</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="nb">index</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="nb">index</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="o">==</span> <span class="nb">index</span>
            <span class="n">symbols</span> <span class="p">=</span> <span class="n">symbols</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="nb">unique</span><span class="p">,</span> <span class="n">symbols</span><span class="p">)</span>
            <span class="n">newStock</span><span class="p">()</span>

    $<span class="n">stocks</span><span class="p">.</span><span class="nb">text</span><span class="p">(</span><span class="s">'Loading Symbols from Stock Exchanges'</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">exchange</span> <span class="n">in</span> <span class="n">exchanges</span><span class="p">:</span>
        <span class="n">YQL</span><span class="p">(</span><span class="s">'select col0 from csv where url="http://www.nasdaq.com/screening/companies-by-name.aspx?letter=0&amp;exchange='</span> <span class="o">+</span> <span class="n">exchange</span> <span class="o">+</span> <span class="s">'&amp;render=download"'</span><span class="p">,</span> <span class="n">onUpdate</span><span class="p">).</span><span class="n">fetch</span><span class="p">()</span>

$<span class="p">(</span><span class="n">document</span><span class="p">).</span><span class="n">ready</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
				</div>
				</div></body></html>