<html><body><div><p>Fast mass dns resolver which can bypass loadbalancers.</p>
<div id="motivation">

<p>DNS servers can provide load balancing of many types. It can be simple round-robin or another algorithm that
depends on the implementation of a particular DNS server. See <a href="https://tools.ietf.org/html/rfc1794" rel="nofollow">RFC 1794</a>
to understand the capabilities and flexibility of the DNS protocol. As a result, it is possible that when the ordinary
resolver is not able to get <em>all</em> IP addresses, e.g. DNS server can return small sets of IP addresses (or even only one IP)
with low TTL per request. Number and presence of addresses may vary depending on the load of servers. Important to note
that this information can be cached by other DNS servers and can be distorted. Getting all IP addresses problem arises when
you want to resolve many domains with sufficient accuracy which useful for blocking network purposes, e.g. websites filtering,
parental controls, etc.</p>
<p>Let’s try to make a couple probes for www.twitter.com.</p>
<pre><span class="p">;</span> &lt;&lt;&gt;&gt; DiG 9.10.2-P1 &lt;&lt;&gt;&gt; @8.8.8.8 www.twitter.com +nocomments +noquestion
<span class="p">;</span> <span class="o">(</span><span class="m">1</span> server found<span class="o">)</span>
<span class="p">;;</span> global options: +cmd
www.twitter.com.    <span class="m">593</span>     IN      CNAME   twitter.com.
twitter.com.                <span class="m">23</span>      IN      A       199.16.156.70
twitter.com.                <span class="m">23</span>      IN      A       199.16.156.198
twitter.com.                <span class="m">23</span>      IN      A       199.16.156.102
twitter.com.                <span class="m">23</span>      IN      A       199.16.156.6
<span class="p">;;</span> Query time: <span class="m">5</span> msec
<span class="p">;;</span> SERVER: 8.8.8.8#53<span class="o">(</span>8.8.8.8<span class="o">)</span>
<span class="p">;;</span> WHEN: Sat Aug <span class="m">08</span> 04:01:43 MSK 2015
<span class="p">;;</span> MSG SIZE  rcvd: 122
</pre>
<pre><span class="p">;</span> &lt;&lt;&gt;&gt; DiG 9.10.2-P1 &lt;&lt;&gt;&gt; @8.8.8.8 www.twitter.com +nocomments +noquestion
<span class="p">;</span> <span class="o">(</span><span class="m">1</span> server found<span class="o">)</span>
<span class="p">;;</span> global options: +cmd
www.twitter.com.    <span class="m">596</span>     IN      CNAME   twitter.com.
twitter.com.                <span class="m">26</span>      IN      A       199.16.156.230
twitter.com.                <span class="m">26</span>      IN      A       199.16.156.70
twitter.com.                <span class="m">26</span>      IN      A       199.16.156.198
twitter.com.                <span class="m">26</span>      IN      A       199.16.156.102
<span class="p">;;</span> Query time: <span class="m">4</span> msec
<span class="p">;;</span> SERVER: 8.8.8.8#53<span class="o">(</span>8.8.8.8<span class="o">)</span>
<span class="p">;;</span> WHEN: Sat Aug <span class="m">08</span> 04:01:44 MSK 2015
<span class="p">;;</span> MSG SIZE  rcvd: 122
</pre>
<p>You see different RR sets with small TTL. What about another public DNS?</p>
<pre><span class="p">;</span> &lt;&lt;&gt;&gt; DiG 9.10.2-P1 &lt;&lt;&gt;&gt; @77.88.8.8 www.twitter.com +nocomments +noquestion
<span class="p">;</span> <span class="o">(</span><span class="m">1</span> server found<span class="o">)</span>
<span class="p">;;</span> global options: +cmd
www.twitter.com.    <span class="m">30</span>      IN      CNAME   twitter.com.
twitter.com.                <span class="m">30</span>      IN      A       199.16.156.102
twitter.com.                <span class="m">30</span>      IN      A       199.16.156.6
twitter.com.                <span class="m">30</span>      IN      A       199.16.156.38
twitter.com.                <span class="m">30</span>      IN      A       199.16.156.230
<span class="p">;;</span> Query time: <span class="m">2</span> msec
<span class="p">;;</span> SERVER: 77.88.8.8#53<span class="o">(</span>77.88.8.8<span class="o">)</span>
<span class="p">;;</span> WHEN: Sat Aug <span class="m">08</span> 04:04:05 MSK 2015
<span class="p">;;</span> MSG SIZE  rcvd: 111
</pre>
<p>Let’s try www.youtube.com.</p>
<pre><span class="p">;</span> &lt;&lt;&gt;&gt; DiG 9.10.2-P1 &lt;&lt;&gt;&gt; @8.8.8.8 www.youtube.com +nocomments +noquestion
<span class="p">;</span> <span class="o">(</span><span class="m">1</span> server found<span class="o">)</span>
<span class="p">;;</span> global options: +cmd
www.youtube.com.    <span class="m">21313</span>   IN      CNAME   youtube-ui.l.google.com.
youtube-ui.l.google.com. <span class="m">13</span> IN      CNAME   wide-youtube.l.google.com.
wide-youtube.l.google.com. <span class="m">13</span>       IN      A       74.125.143.198
<span class="p">;;</span> Query time: <span class="m">5</span> msec
<span class="p">;;</span> SERVER: 8.8.8.8#53<span class="o">(</span>8.8.8.8<span class="o">)</span>
<span class="p">;;</span> WHEN: Sat Aug <span class="m">08</span> 04:06:08 MSK 2015
<span class="p">;;</span> MSG SIZE  rcvd: 121
</pre>
<pre><span class="p">;</span> &lt;&lt;&gt;&gt; DiG 9.10.2-P1 &lt;&lt;&gt;&gt; @8.8.8.8 www.youtube.com +nocomments +noquestion
<span class="p">;</span> <span class="o">(</span><span class="m">1</span> server found<span class="o">)</span>
<span class="p">;;</span> global options: +cmd
www.youtube.com.    <span class="m">21599</span>   IN      CNAME   youtube-ui.l.google.com.
youtube-ui.l.google.com. <span class="m">299</span>        IN      CNAME   wide-youtube.l.google.com.
wide-youtube.l.google.com. <span class="m">299</span>      IN      A       173.194.71.198
<span class="p">;;</span> Query time: <span class="m">6</span> msec
<span class="p">;;</span> SERVER: 8.8.8.8#53<span class="o">(</span>8.8.8.8<span class="o">)</span>
<span class="p">;;</span> WHEN: Sat Aug <span class="m">08</span> 04:06:11 MSK 2015
<span class="p">;;</span> MSG SIZE  rcvd: 121
</pre>
<pre><span class="p">;</span> &lt;&lt;&gt;&gt; DiG 9.10.2-P1 &lt;&lt;&gt;&gt; @84.200.70.40 www.youtube.com +nocomments +noquestion
<span class="p">;</span> <span class="o">(</span><span class="m">1</span> server found<span class="o">)</span>
<span class="p">;;</span> global options: +cmd
www.youtube.com.    <span class="m">55513</span>   IN      CNAME   youtube-ui.l.google.com.
youtube-ui.l.google.com. <span class="m">271</span>        IN      A       216.58.209.46
<span class="p">;;</span> Query time: <span class="m">41</span> msec
<span class="p">;;</span> SERVER: 84.200.70.40#53<span class="o">(</span>84.200.70.40<span class="o">)</span>
<span class="p">;;</span> WHEN: Sat Aug <span class="m">08</span> 04:07:29 MSK 2015
<span class="p">;;</span> MSG SIZE  rcvd: 94
</pre>
<p>This outputs may be outdated soon, but it is only necessary to show the behavior of DNS. Any website can use
load balancer and so you are not able to do full resolve these sites.</p>
<p>The solution is query many nameservers many times for each domain. Yes, it’s a bit clumsy, but works well enough
in many cases. The resolving should be performed in multiple threads, because resolving in one thread is slow,
especially in this case.</p>
<p>And so Berserker Resolver is emerged.</p>
<p><em>It’s worth noting that full resolving may be impossible because GEO load balancing or resolving can be occurred
“at the wrong time in the wrong place” when some servers are down and their IP addresses are excluded from DNS pool by fault
tolerance algorithm. If you need actual information you should schedule resolving attempts, maintain your DNS database,
maybe perform resolving from different networks/servers. There is no universal solution for that cases, but you can use Berserker
Resolver as the backend in your application.</em></p>
</div>
<div id="resolver-class">

<p>Core of the Berserker Resolver.</p>
<p>Methods:</p>

<p>Properties:</p>
<ul>
<li>nameservers</li>
<li>tries</li>
<li>timeout</li>
<li>qname</li>
<li>threads</li>
<li>www</li>
<li>www_combine</li>
<li>verbose</li>
</ul>
<p>Properties can be assign via constructor or directly to the object.</p>
<div id="resolver-resolve">

<p>Resolve method. It takes list of domains and returns dictionary with results (dictionary of sets).</p>
<pre><span class="kn">from</span> <span class="nn">berserker_resolver</span> <span class="kn">import</span> <span class="n">Resolver</span>

<span class="n">domains</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'kernel.org'</span><span class="p">,</span> <span class="s1">'toster.ru'</span><span class="p">]</span>

<span class="n">resolver</span> <span class="o">=</span> <span class="n">Resolver</span><span class="p">()</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">domains</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="sd">'''
    {
        'toster.ru': {
            &lt;DNS IN A rdata: 178.248.236.52&gt;
        },
        'kernel.org': {
            &lt;DNS IN A rdata: 198.145.20.140&gt;,
            &lt;DNS IN A rdata: 199.204.44.194&gt;,
            &lt;DNS IN A rdata: 149.20.4.69&gt;
        }
    }
'''</span>
</pre>
</div>
<div id="resolver-query">

<p>Query method, wrapper around <tt>dns.resolver.Resolver.query</tt> from dnspython. It takes domain and nameserver,
and returns result of the query. Nameserver is optional, if not given, random from <tt>Resolver.nameservers</tt>
will be used.</p>
<p>Can throw exception, see details <a href="http://www.dnspython.org/docs/1.12.0/dns.resolver.Resolver-class.html#query" rel="nofollow">here</a>.</p>
<pre><span class="kn">from</span> <span class="nn">berserker_resolver</span> <span class="kn">import</span> <span class="n">Resolver</span>

<span class="n">resolver</span> <span class="o">=</span> <span class="n">Resolver</span><span class="p">()</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">'facebook.com'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="p">))</span> <span class="c1"># [&lt;DNS IN A rdata: 173.252.120.6&gt;]</span>

<span class="c1"># Query to the local dns.</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">'facebook.com'</span><span class="p">,</span> <span class="s1">'127.0.0.1'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="p">))</span> <span class="c1"># [&lt;DNS IN A rdata: 173.252.120.6&gt;]</span>
</pre>
</div>
<div id="resolver-nameservers">

<p>List of nameservers for resolving, each of them will be queried for particular domain.</p>
<p>The larger the list, the more chances to get all IP addresses, but it increases
time  needed for resolving.</p>
<p>Default is <tt>['8.8.8.8', '8.8.4.4', '77.88.8.8', '77.88.8.1', '84.200.69.80', '84.200.70.40']</tt>. There are
<a href="https://developers.google.com/speed/public-dns/" rel="nofollow">Google Public DNS</a>, <a href="https://dns.yandex.ru/" rel="nofollow">Yandex.DNS</a>
and <a href="https://dns.watch/" rel="nofollow">DNS.WATCH</a>.</p>
</div>
<div id="resolver-tries">

<p>Number of queries for each nameserver.</p>
<p>If the number of times increases, the resolving accuracy increases too, but it also
increases time to resolving.</p>
<p>Default is <tt>48</tt>.</p>
</div>
<div id="resolver-timeout">

<p>The total number of seconds to spend trying to get an answer to the query.</p>
<p>Note that low timeout combined with high values of <tt>Resolver.tries</tt> and <tt>Resolver.threads</tt> can lead to
numerous timeout errors when nameserver does not have enough time to return a response.</p>
<p>Default is <tt>3</tt>.</p>
</div>
<div id="resolver-threads">

<p>Number of threads.</p>
<p>More threads lead to increase speed of resolving, but too many threads lead to threads switching overhead.
You should test different numbers and choose one suitable for your systems. Also be careful with large number of threads, you can
flood the DNS server. If you want to use crazy large amount of threads, check
<a href="https://stackoverflow.com/questions/344203/maximum-number-of-threads-per-process-in-linux" rel="nofollow">stackoverflow thread</a> and
increase <tt>Resolver.timeout</tt>.</p>
<p>Default is <tt>512</tt>.</p>
</div>
<div id="resolver-qname">

<p>DNS query type name.</p>
<p>Default is <tt>A</tt>.</p>
</div>
<div id="resolver-www">

<p>Enables automatic addition/removal of <em>www</em> prefix depending on the domain.</p>
<pre><span class="kn">from</span> <span class="nn">berserker_resolver</span> <span class="kn">import</span> <span class="n">Resolver</span>

<span class="n">domains</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'wikipedia.org'</span><span class="p">,</span> <span class="s1">'www.toster.ru'</span><span class="p">]</span>

<span class="n">resolver</span> <span class="o">=</span> <span class="n">Resolver</span><span class="p">(</span><span class="n">www</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">domains</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="sd">'''
    {
        'toster.ru': {
            &lt;DNS IN A rdata: 178.248.236.52&gt;
        },
        'www.wikipedia.org': {
            &lt;DNS IN A rdata: 91.198.174.192&gt;
        },
        'www.toster.ru': {
            &lt;DNS IN A rdata: 178.248.236.52&gt;
        },
        'wikipedia.org': {
            &lt;DNS IN A rdata: 91.198.174.192&gt;
        }
    }
'''</span>
</pre>
<p>Default is <tt>False</tt>.</p>
</div>
<div id="resolver-www-combine">

<p>Enables automatic combining <em>www</em> prefixed domains with theirs non-<em>www</em> versions.</p>
<pre><span class="kn">from</span> <span class="nn">berserker_resolver</span> <span class="kn">import</span> <span class="n">Resolver</span>

<span class="n">domains</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'facebook.com'</span><span class="p">,</span> <span class="s1">'www.facebook.com'</span><span class="p">]</span>

<span class="n">resolver</span> <span class="o">=</span> <span class="n">Resolver</span><span class="p">()</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">domains</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="sd">'''
    {
        'facebook.com': {
            &lt;DNS IN A rdata: 173.252.120.6&gt;
        },
        'www.facebook.com': {
            &lt;DNS IN A rdata: 31.13.93.3&gt;,
            &lt;DNS IN A rdata: 31.13.91.2&gt;,
            &lt;DNS IN A rdata: 173.252.88.66&gt;,
            &lt;DNS IN A rdata: 31.13.64.1&gt;
        }
    }
'''</span>

<span class="n">resolver</span><span class="o">.</span><span class="n">www_combine</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">domains</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="sd">'''
    {
        'www.facebook.com': {
            &lt;DNS IN A rdata: 173.252.120.6&gt;
            &lt;DNS IN A rdata: 31.13.93.3&gt;,
            &lt;DNS IN A rdata: 31.13.91.2&gt;,
            &lt;DNS IN A rdata: 173.252.88.66&gt;,
            &lt;DNS IN A rdata: 31.13.64.1&gt;
        }
    }
'''</span>
</pre>
<p>Powerful use case is combine this property together with <tt>Resolver.www</tt>.</p>
<pre><span class="kn">from</span> <span class="nn">berserker_resolver</span> <span class="kn">import</span> <span class="n">Resolver</span>

<span class="n">domains</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'facebook.com'</span><span class="p">]</span>

<span class="n">resolver</span> <span class="o">=</span> <span class="n">Resolver</span><span class="p">(</span><span class="n">www</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">www_combine</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">domains</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="sd">'''
    {
        'www.facebook.com': {
            &lt;DNS IN A rdata: 173.252.120.6&gt;
            &lt;DNS IN A rdata: 31.13.93.3&gt;,
            &lt;DNS IN A rdata: 31.13.91.2&gt;,
            &lt;DNS IN A rdata: 173.252.88.66&gt;,
            &lt;DNS IN A rdata: 31.13.64.1&gt;
        }
    }
'''</span>
</pre>
<p>Default is <tt>False</tt>.</p>
</div>
<div id="resolver-verbose">

<p>This property enables error reporting, e.g. nxdomain, noanswer, etc. <tt>Resolver.resolve</tt> normally returns
dictionary of sets with resolved domains, but with this option it returns dictionary with two keys:</p>

<pre><span class="kn">from</span> <span class="nn">berserker_resolver</span> <span class="kn">import</span> <span class="n">Resolver</span>

<span class="n">domains</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'nonexistent.domain'</span><span class="p">,</span> <span class="s1">'facebook.com'</span><span class="p">]</span>

<span class="n">resolver</span> <span class="o">=</span> <span class="n">Resolver</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">domains</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="sd">'''
    {
        'success': {
            'facebook.com': {
                &lt;DNS IN A rdata: 173.252.120.6&gt;
            }
        },
        'error': {
            'nonexistent.domain': {
                '77.88.8.1': NXDOMAIN(),
                '8.8.4.4': NXDOMAIN(),
                '8.8.8.8': NXDOMAIN(),
                '77.88.8.8': NXDOMAIN()
            }
        }
    }
'''</span>
</pre>
<p><tt><span class="pre">result['success']</span></tt> is dictionary with successfully resolved domains, as if without <tt>Resolver.verbose</tt>.
<tt><span class="pre">result['error']</span></tt> is dictionary with unsuccessfully resolved domains where each key contains another dictionary
with per nameserver exception. Exceptions comes from dnspython backend as <tt>dns.exception.DNSException</tt> subclasses.
Check out <a href="http://www.dnspython.org/docs/1.12.0/dns.exception.DNSException-class.html" rel="nofollow">dnspython docs</a> for more
information about built-in exceptions.</p>
<p><em>Note that particular domain can be placed in both dictionaries, because some nameservers can return answer and some not.</em></p>
<pre><span class="kn">from</span> <span class="nn">berserker_resolver</span> <span class="kn">import</span> <span class="n">Resolver</span>

<span class="n">domains</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'facebook.com'</span><span class="p">]</span>

<span class="c1"># 216.239.32.10 is ns1.google.com</span>
<span class="n">resolver</span> <span class="o">=</span> <span class="n">Resolver</span><span class="p">(</span><span class="n">nameservers</span><span class="o">=</span><span class="p">[</span><span class="s1">'216.239.32.10'</span><span class="p">,</span> <span class="s1">'8.8.8.8'</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">domains</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="sd">'''
    {
        'success': {
            'facebook.com': {
                &lt;DNS IN A rdata: 173.252.120.6&gt;
            }
        },
        'error': {
            'facebook.com': {
                '216.239.32.10': NoNameservers()
            }
        }
    }
'''</span>
</pre>
<p>Default is <tt>False</tt>.</p>
</div>
</div>


</div></body></html>