<html><body><div><div class="entry-content">
            <p>Стандартно в Django для модели создаются три роли: «добавить», «редактировать», «удалять».</p>
<p>Но как же быть, если мы хотим дать роль пользователю только на просмотр и при этом использовать <code>django.admin</code>?</p>
<p>Есть множество способов, но элегантных, которые позволили бы создать роль «Can view model» практически нет.</p>
<h2>И так, вот рецепт:</h2>
<h3>Создадим новый сигнал</h3>
<pre><code>from django.db.models.signals import post_migrate
from django.contrib.contenttypes.models import ContentType
from django.contrib.auth.models import Permission

def add_view_permissions(sender, **kwargs):
    """
    Add view permissions
    """
    for content_type in ContentType.objects.all():
        codename = "view_%s" % content_type.model
        if not Permission.objects.filter(content_type=content_type, codename=codename):
                Permission.objects.create(content_type=content_type, codename=codename,
                         name="Can view %s" % content_type.name)

post_migrate.connect(add_view_permissions)
</code></pre>
<p>При миграции, наш сигнал будет каждый раз проверять и создавать роль <code>view_</code> для новой модели.</p>
<h3>Создадим наследуемый класс для admin.ModelAdmin</h3>
<pre><code>from django.contrib import admin
class AdminMixin(admin.ModelAdmin):
     def has_change_permission(self, request, obj=None):
         change_permission = super(AdminMixin, self).has_change_permission(request, obj)
         if change_permission:
             self.readonly_fields = AdminMixin.readonly_fields
             return True
         if request.user.has_perm('{}.view_{}'.format(self.model._meta.app_label, self.model._meta.object_name)):
             self.readonly_fields = self._meta.get_all_field_names()
             return True
         return False
</code></pre>
<p>Вот и все.</p>
<p>Теперь, пользователи, у которых будет роль только view, смогут лишь просматривать объекты в <code>django.admin</code>.</p>
        </div>
        

        

        </div></body></html>