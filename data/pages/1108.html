<html><body><div><div class="post_content entry-content">
  					<p>So first off, to clarify, the title of this post should be “Isolation of the Django ORM,” but, you know, I just wanted to stir up some drama with a controversial title that would really stir some violent debate. I recently wrote a <a href="http://scottlobdell.me/2014/08/fastest-django-app-ive-ever-written/">blog post</a> that actually contained too much disparate content to really create a clear theme, and in the process it made me want to follow up with a subsequent post to clarify the main point I ended up driving home. You know…isolate a single topic so that it knows nothing about the rest of the stuff you’re writing about…like in software. Get it? Because that’s also what I’m writing about. It’s a pun.</p>
<p>So John “Arvin” Lynn read my post, didn’t even hit the like button on Facebook, and then took the effort to follow up with me with an insightful video that I might find interesting.  The video is below:</p>
<p/>
<p>And in fact, I did find it interesting.  The very points I was trying to make in my previous blog post about creating proxy models for Django were hit home and explained far more intelligently by someone far nerdier than I (and mind you, I mean that as a compliment, and I don’t think Alex Gaynor would take this as an insult.  You’ll notice that his shirt said “2.8″ on it.  That’s as nerdy as it gets).  If you look at the comments of the YouTube video, which often leads down to the cesspool of the internets, there was a comment with the complaint that Alex had voiced his qualms with Django quite articulately and with examples, but to follow that, he did not provide the solution to his complaints.  I like to think that my single example from my previous post illustrated an example solution of an abstract concept he was talking about.</p>
<p> </p>
<h1>So what was said in the video?</h1>
<p>In my own interpretation of Alex’s points:</p>
<ul>
<li>MVC is an oversimplification and does not account for the additional modularity to write clean, maintainable code</li>
<li>Django’s environment has a clear definition of what MVC means, and perhaps that definition falls wildly short of what it really should be</li>
<li>Django’s ORM is used all over the place, at least in Django code samples even from the book, that are totally not MVC’ish</li>
</ul>
<p>Here’s the single code sample that Alex used to make his point:<br/>
</p>
<div>
<pre><span>def</span> <span>vote</span><span>(request,</span> <span>poll_id):</span>
    <span>p</span> <span>=</span> <span>get_object_or_404(Poll,</span> <span>pk=poll_id)</span>
    <span>try</span><span>:</span>
        <span>selected_choice</span> <span>=</span> <span>p.choice_set.get(pk=request.POST[</span><span>'choice'</span><span>])</span>
    <span>except</span> <span>(</span><span>KeyError</span><span>,</span> <span>Choice.DoesNotExist):</span>
        <span># Redisplay the poll voting form.</span>
        <span>return</span> <span>render_to_response(</span><span>'polls/detail.html'</span><span>,</span> <span>{</span>
            <span>'poll'</span><span>:</span> <span>p,</span>
            <span>'error_message'</span><span>:</span> <span>"You didn't select a choice."</span><span>,</span>
        <span>},</span> <span>context_instance=RequestContext(request))</span>
    <span>else</span><span>:</span>
        <span>selected_choice.votes</span> <span>+=</span> <span>1</span>
        <span>selected_choice.save()</span>
        <span># Always return an HttpResponseRedirect after successfully dealing</span>
        <span># with POST data. This prevents data from being posted twice if a</span>
        <span># user hits the Back button.</span>
        <span>return</span> <span>HttpResponseRedirect(reverse(</span><span>'polls.views.results'</span><span>,</span> <span>args=(p.id,)))</span></pre>
</div>
<p>Here, there’s no real separation from the view and the model. The get_object_or_404 function is a helper function that intermingles the two. Database queries are being made directly from request data. Here are my interpretations of the points Alex made in order to avoid this sort of intermingling:</p>
<ul>
<li>Requests should not need to be re-created in order to test your code</li>
<li>Team members should not need to understand or know about your database schema in order to use your models.</li>
<li>Django models shouldn’t need to know about other django models</li>
</ul>
<p>So let’s see if I can offer a “better” way to re-create the above logic using Alex’s points and hopefully I can do his points justice:<br/>
</p>
<div>
<pre><span>class</span> <span>_Poll</span><span>(models.Model):</span>
    <span>''' django model stuff goes in here '''</span>

<span>class</span> <span>Poll</span><span>(</span><span>object</span><span>):</span>
    <span>''' pure python object that abstracts everything in _Poll '''</span>
    <span>def</span> <span>__init__</span><span>(</span><span>self</span><span>,</span> <span>_poll):</span>
        <span>self</span><span>._poll</span> <span>=</span> <span>_poll</span>

    <span>def</span> <span>get_choices</span><span>(</span><span>self</span><span>,</span> <span>choice_id):</span>
        <span>''' Lots of other logic goes here involving a m2m table;</span>
<span>            involving similarly built out proxy models'''</span>

    <span>@classmethod</span>
    <span>def</span> <span>get_by_id</span><span>(</span><span>self</span><span>,</span> <span>poll_id):</span>
        <span>_poll</span> <span>=</span> <span>_Poll.objects.get(</span><span>id</span><span>=poll_id)</span>
        <span>return</span> <span>Poll(_poll)</span>

<span>def</span> <span>up_vote_poll_id_with_choice_id</span><span>(poll_id,</span> <span>choice_id):</span>
    <span>try</span><span>:</span>
        <span>poll</span> <span>=</span> <span>Poll.get_by_id(poll_id)</span>
    <span>except</span> <span>ObjectDoesNotExist:</span>
        <span>return</span> <span>False</span>
    <span>selected_choice</span> <span>=</span> <span>poll.get_choices(choice_id)</span>
    <span>selected_choice.upvote()</span>
    <span>return</span> <span>True</span>

<span>def</span> <span>vote</span><span>(request,</span> <span>poll_id):</span>
    <span>if</span> <span>'choice'</span> <span>not</span> <span>in</span> <span>request.POST:</span>
        <span>render_data</span> <span>=</span> <span>{</span>
            <span>'error_message'</span><span>:</span> <span>"You didn't select a choice.  Idiot."</span>
        <span>}</span>
        <span>return</span> <span>render_to_response(</span><span>'polls/detail.html'</span><span>,</span> <span>render_data,</span> <span>status=</span><span>400</span><span>)</span>
    <span>choice_id</span> <span>=</span> <span>int</span><span>(request.POST[</span><span>'choice'</span><span>])</span>
    <span>success</span> <span>=</span> <span>up_vote_poll_id_with_choice_id(poll_id,</span> <span>choice_id)</span>
    <span>if</span> <span>success:</span>
        <span>return</span> <span>HttpResponseRedirect(reverse(</span><span>'polls.views.results'</span><span>,</span> <span>args=(poll_id,)))</span>

    <span>render_data</span> <span>=</span> <span>{</span>
        <span>'error_message'</span><span>:</span> <span>"That poll ID doesn't exist.  Idiot"</span>
    <span>}</span>
    <span>return</span> <span>render_to_response(</span><span>'polls/detail.html'</span><span>,</span> <span>render_data,</span> <span>status=</span><span>400</span><span>)</span></pre>
</div>
<p>Here, we try and separate request/response logic, business logic, and database interaction. Methods can be individually tested, validated, and re-used. Other developers don’t need to know what data is inside the database or how the table is constructed or which columns are indexed.  Modules know only as much as they need to know about neighboring modules.</p>
<p>The second approach is noticeably longer, but the cost of more verbose code is marginal.  Writing code is far easier than figuring out a problem.  The majority of code development involves maintenance, not the construction of new blocks of code.  As such, the drawback of more lines becomes even more negligible.  Making a change is simple, easy, and testable.</p>
<p>To the point that modules only know as much as they need to know about neighboring modules, this brings up <a href="http://en.wikipedia.org/wiki/Law_of_Demeter">The Law of Demeter</a>.  In super plain English, following the Law of Demeter allows maintenance and long term development of code much easier and cheaper.  To actually abide by the Law, the basic idea is to eliminate excessive dots.  For example, this is bad:</p>
<p>
</p><div>
<pre><span>def</span> <span>signup</span><span>(account):</span>
    <span>name</span> <span>=</span> <span>account.owner.name</span>
</pre>
</div>
<p>But this is better:<br/>

</p><div>
<pre><span>class</span> <span>Account</span><span>(</span><span>object</span><span>):</span>
    <span>@property</span>
    <span>def</span> <span>owner_name</span><span>(</span><span>self</span><span>):</span>
        <span>return</span> <span>self</span><span>.owner.name</span>

<span>def</span> <span>signup</span><span>(account):</span>
    <span>name</span> <span>=</span> <span>account.owner_name</span>
</pre>
</div>
<p>Even though these are logically equivalent, the point is that in the first case, the module we’re in has to know something about the Account object and the Owner object.  In the second case, the module we’re in only has to know something about the Account object.  Over time and with more complex code, it’s much simpler to modify things when modules only know about their immediately related modules.  This is loose coupling.  Coupling must exist in order for your code to even do anything, but we want to minimize it wherever possible.<br/><br/><br/>
Consider this awesome illustration I drew with my own two hands with my own blood, sweat, and tears where we represent objects with little squares, and relationships between objects or their knowledge of each other is represented with an edge.<a href="http://scottlobdell.me/wp-content/uploads/2014/08/IMG_0372.jpg"><img src="http://scottlobdell.me/wp-content/uploads/2014/08/IMG_0372-225x300.jpg" alt="IMG_0372" class="alignnone size-medium wp-image-757"/></a></p>
<p><a href="http://scottlobdell.me/wp-content/uploads/2014/08/IMG_0373.jpg"><img src="http://scottlobdell.me/wp-content/uploads/2014/08/IMG_0373-225x300.jpg" alt="IMG_0373" class="alignnone size-medium wp-image-758"/></a>:<br/>
Of the two, the first illustration is clearly an easier block of code to maintain given each objects’ limited knowledge of its neighbors.  If we wanted to remove a module or replace a module with something else, it would be incredibly easy to do.  In the second example, everything just looks like a giant jenga puzzle, and no one wants to touch it or modify it, but then stuff still needs to get added to it, so more and more code just gets mangled in there, and the code just continues to rot.</p>
<p>Such is the reasoning for using django proxy models.  Just to finish this post in the laziest manner possible, here is some more example code from my latest side project in which I used proxy models in conjunction with Django models:<br/>

</p><div>
<pre><span>import</span> <span>datetime</span>

<span>from</span> <span>django.db</span> <span>import</span> <span>models</span>

<span>from</span> <span>..pricing.models</span> <span>import</span> <span>Pricing</span>
<span>from</span> <span>..pictures.models</span> <span>import</span> <span>Picture</span>


<span>class</span> <span>_Order__Picture</span><span>(models.Model):</span>

    <span>class</span> <span>Meta</span><span>:</span>
        <span>app_label</span> <span>=</span> <span>'orders'</span>
        <span>db_table</span> <span>=</span> <span>'orders_order__picture'</span>

    <span>order_id</span> <span>=</span> <span>models.IntegerField()</span>
    <span>picture_id</span> <span>=</span> <span>models.IntegerField()</span>
    <span>price</span> <span>=</span> <span>models.FloatField()</span>
    <span>dimensions</span> <span>=</span> <span>models.CharField(max_length=</span><span>50</span><span>)</span>
    <span>final_picture_url</span> <span>=</span> <span>models.CharField(max_length=</span><span>255</span><span>)</span>


<span>class</span> <span>_Order</span><span>(models.Model):</span>

    <span>class</span> <span>Meta</span><span>:</span>
        <span>app_label</span> <span>=</span> <span>'orders'</span>
        <span>db_table</span> <span>=</span> <span>'orders_order'</span>

    <span>date_created</span> <span>=</span> <span>models.DateTimeField()</span>
    <span>customer_email</span> <span>=</span> <span>models.CharField(max_length=</span><span>100</span><span>)</span>
    <span>completed_credit_card_payment</span> <span>=</span> <span>models.BooleanField(default=</span><span>False</span><span>)</span>
    <span>completed_photo_processing</span> <span>=</span> <span>models.BooleanField(default=</span><span>False</span><span>)</span>
    <span>error_message</span> <span>=</span> <span>models.CharField(max_length=</span><span>255</span><span>)</span>


<span>class</span> <span>Order</span><span>(</span><span>object</span><span>):</span>

    <span>def</span> <span>__init__</span><span>(</span><span>self</span><span>,</span> <span>_order):</span>
        <span>self</span><span>._order</span> <span>=</span> <span>_order</span>
        <span>self</span><span>._cached_pictures</span> <span>=</span> <span>None</span>

    <span>@classmethod</span>
    <span>def</span> <span>_wrap</span><span>(cls,</span> <span>_order):</span>
        <span>return</span> <span>Order(_order)</span>

    <span>@classmethod</span>
    <span>def</span> <span>create</span><span>(cls,</span>
               <span>customer_email,</span>
               <span>picture_id_to_pricing_id):</span>
        <span>pricing_id_to_obj</span> <span>=</span> <span>{p.id:</span> <span>p</span> <span>for</span> <span>p</span> <span>in</span> <span>Pricing.get_by_ids([</span><span>int</span><span>(i)</span> <span>for</span> <span>i</span> <span>in</span> <span>picture_id_to_pricing_id.values()])}</span>
        <span>_order</span> <span>=</span> <span>_Order.objects.create(date_created=datetime.datetime.utcnow(),</span>
                                       <span>customer_email=customer_email,</span>
                                       <span>error_message=</span><span>""</span><span>)</span>
        <span>for</span> <span>picture_id,</span> <span>pricing_id</span> <span>in</span> <span>picture_id_to_pricing_id.items():</span>
            <span>pricing</span> <span>=</span> <span>pricing_id_to_obj[pricing_id]</span>
            <span>_Order__Picture.objects.create(order_id=_order.id,</span>
                                           <span>picture_id=picture_id,</span>
                                           <span>price=pricing.price,</span>
                                           <span>dimensions=pricing.dimensions,</span>
                                           <span>final_picture_url=</span><span>""</span><span>)</span>
        <span>return</span> <span>cls._wrap(_order)</span>

    <span>@classmethod</span>
    <span>def</span> <span>get_by_id</span><span>(cls,</span> <span>order_id):</span>
        <span>_order</span> <span>=</span> <span>_Order.objects.get(</span><span>id</span><span>=order_id)</span>
        <span>return</span> <span>cls._wrap(_order)</span>

    <span>def</span> <span>get_pictures</span><span>(</span><span>self</span><span>):</span>
        <span>if</span> <span>self</span><span>._cached_pictures</span> <span>is</span> <span>not</span> <span>None</span><span>:</span>
            <span>return</span> <span>self</span><span>._cached_pictures</span>

        <span>picture_ids</span> <span>=</span> <span>_Order__Picture.objects.filter(order_id=</span><span>self</span><span>.id).values_list(</span><span>'picture_id'</span><span>,</span> <span>flat=</span><span>True</span><span>)</span>
        <span>self</span><span>._cached_pictures</span> <span>=</span> <span>Picture.get_by_ids(picture_ids)</span>
        <span>return</span> <span>self</span><span>._cached_pictures</span>

    <span>def</span> <span>get_pictures_with_dimensions</span><span>(</span><span>self</span><span>):</span>
        <span>m2ms</span> <span>=</span> <span>_Order__Picture.objects.filter(order_id=</span><span>self</span><span>.id)</span>
        <span>picture_ids</span> <span>=</span> <span>[m2m.picture_id</span> <span>for</span> <span>m2m</span> <span>in</span> <span>m2ms]</span>
        <span>self</span><span>._cached_pictures</span> <span>=</span> <span>Picture.get_by_ids(picture_ids)</span>
        <span>picture_id_to_obj</span> <span>=</span> <span>{p.id:</span> <span>p</span> <span>for</span> <span>p</span> <span>in</span> <span>self</span><span>._cached_pictures}</span>
        <span>return</span> <span>[(picture_id_to_obj[m2m.picture_id],</span> <span>m2m.dimensions)</span> <span>for</span> <span>m2m</span> <span>in</span> <span>m2ms]</span>

    <span>@property</span>
    <span>def</span> <span>id</span><span>(</span><span>self</span><span>):</span>
        <span>return</span> <span>self</span><span>._order.id</span>

    <span>@property</span>
    <span>def</span> <span>total_price</span><span>(</span><span>self</span><span>):</span>
        <span>all_prices</span> <span>=</span> <span>_Order__Picture.objects.filter(order_id=</span><span>self</span><span>.id).values_list(</span><span>'price'</span><span>,</span> <span>flat=</span><span>True</span><span>)</span>
        <span>total_price</span> <span>=</span> <span>sum</span><span>(all_prices)</span>
        <span>return</span> <span>"%.2f"</span> <span>%</span> <span>total_price</span>

    <span>@property</span>
    <span>def</span> <span>num_pictures</span><span>(</span><span>self</span><span>):</span>
        <span>return</span> <span>len</span><span>(</span><span>self</span><span>.get_pictures())</span>

    <span>def</span> <span>mark_credit_card_payment_complete</span><span>(</span><span>self</span><span>):</span>
        <span>self</span><span>._order.completed_credit_card_payment</span> <span>=</span> <span>True</span>
        <span>self</span><span>._order.save()</span>

    <span>def</span> <span>mark_photo_processing_complete</span><span>(</span><span>self</span><span>):</span>
        <span>self</span><span>._order.completed_photo_processing</span> <span>=</span> <span>True</span>
        <span>self</span><span>._order.save()</span>

    <span>def</span> <span>annotate_error_message</span><span>(</span><span>self</span><span>,</span> <span>error_message):</span>
        <span>error_message</span> <span>=</span> <span>error_message[:</span><span>255</span><span>]</span>
        <span>self</span><span>._order.error_message</span> <span>=</span> <span>error_message</span>
        <span>self</span><span>._order.save()</span>

    <span>def</span> <span>update_picture_id_with_finish_url</span><span>(</span><span>self</span><span>,</span> <span>picture_id,</span> <span>final_url):</span>
        <span># alternatively I could just update the properties as appropriate</span>
        <span># instead of busting the cache</span>
        <span>self</span><span>._cached_pictures</span> <span>=</span> <span>None</span>
        <span>m2m</span> <span>=</span> <span>_Order__Picture.objects.get(order_id=</span><span>self</span><span>.id,</span>
                                          <span>picture_id=picture_id)</span>
        <span>m2m.final_picture_url</span> <span>=</span> <span>final_url</span>
        <span>m2m.save()</span>

    <span>def</span> <span>get_final_image_urls</span><span>(</span><span>self</span><span>):</span>
        <span>m2ms</span> <span>=</span> <span>_Order__Picture.objects.filter(order_id=</span><span>self</span><span>.id)</span>
        <span>return</span> <span>[m2m.final_picture_url</span> <span>for</span> <span>m2m</span> <span>in</span> <span>m2ms]</span>
</pre>
</div>
<p>
</p><div>
<pre><span>import</span> <span>random</span>

<span>from</span> <span>django.db</span> <span>import</span> <span>models</span>


<span>class</span> <span>_Coupon</span><span>(models.Model):</span>

    <span>class</span> <span>Meta</span><span>:</span>
        <span>app_label</span> <span>=</span> <span>'coupons'</span>
        <span>db_table</span> <span>=</span> <span>'coupons_coupon'</span>

    <span>code</span> <span>=</span> <span>models.CharField(max_length=</span><span>50</span><span>)</span>
    <span>expiration_date</span> <span>=</span> <span>models.DateTimeField(null=</span><span>True</span><span>)</span>
    <span>dollar_value</span> <span>=</span> <span>models.FloatField()</span>
    <span>percent_off</span> <span>=</span> <span>models.FloatField()</span>  <span># value from 0..1</span>
    <span>reason_created</span> <span>=</span> <span>models.CharField(max_length=</span><span>255</span><span>)</span>
    <span>redeemed</span> <span>=</span> <span>models.BooleanField(default=</span><span>False</span><span>)</span>


<span>class</span> <span>Coupon</span><span>(</span><span>object</span><span>):</span>

    <span>def</span> <span>__init__</span><span>(</span><span>self</span><span>,</span> <span>_coupon):</span>
        <span>self</span><span>._coupon</span> <span>=</span> <span>_coupon</span>

    <span>@classmethod</span>
    <span>def</span> <span>_wrap</span><span>(cls,</span> <span>_coupon):</span>
        <span>return</span> <span>Coupon(_coupon)</span>

    <span>@classmethod</span>
    <span>def</span> <span>_generate_random_string</span><span>(cls):</span>
        <span># this string supports 10 million permutations</span>
        <span>random_chars</span> <span>=</span> <span>""</span><span>.join([</span><span>chr</span><span>(random.randint(</span><span>0</span><span>,</span> <span>25</span><span>)</span> <span>+</span> <span>65</span><span>)</span> <span>for</span> <span>count</span> <span>in</span> <span>xrange</span><span>(</span><span>5</span><span>)])</span>
        <span>while</span> <span>_Coupon.objects.filter(code=random_chars).exists():</span>
            <span>random_chars</span> <span>=</span> <span>""</span><span>.join([</span><span>chr</span><span>(random.randint(</span><span>0</span><span>,</span> <span>25</span><span>)</span> <span>+</span> <span>65</span><span>)</span> <span>for</span> <span>count</span> <span>in</span> <span>xrange</span><span>(</span><span>5</span><span>)])</span>
        <span>return</span> <span>random_chars</span>

    <span>@classmethod</span>
    <span>def</span> <span>create_dollar_value_with_reason</span><span>(cls,</span> <span>dollar_value,</span> <span>reason_str):</span>
        <span>coupon_str</span> <span>=</span> <span>cls._generate_random_string()</span>
        <span>_coupon</span> <span>=</span> <span>_Coupon.objects.create(code=coupon_str,</span>
                                         <span>dollar_value=dollar_value,</span>
                                         <span>reason_created=reason_str,</span>
                                         <span>percent_off=</span><span>0.0</span><span>)</span>
        <span>return</span> <span>cls._wrap(_coupon)</span>

    <span>@classmethod</span>
    <span>def</span> <span>create_percent_off_with_reason</span><span>(cls,</span> <span>percent_off,</span> <span>reason_str):</span>
        <span>if</span> <span>percent_off</span> <span>&lt;</span> <span>0.0</span> <span>or</span> <span>percent_off</span> <span>&gt;</span> <span>1.0</span><span>:</span>
            <span>raise</span> <span>ValueError</span><span>(</span><span>"Invalid value for percent_off"</span><span>)</span>
        <span>coupon_str</span> <span>=</span> <span>cls._generate_random_string()</span>
        <span>_coupon</span> <span>=</span> <span>_Coupon.objects.create(code=coupon_str,</span>
                                         <span>dollar_value=</span><span>0.0</span><span>,</span>
                                         <span>reason_created=reason_str,</span>
                                         <span>percent_off=percent_off)</span>
        <span>return</span> <span>cls._wrap(_coupon)</span>

    <span>def</span> <span>is_valid</span><span>(</span><span>self</span><span>):</span>
        <span>if</span> <span>self</span><span>._coupon.dollar_value</span> <span>&gt;</span> <span>0</span><span>:</span>
            <span>return</span> <span>True</span>
        <span>if</span> <span>self</span><span>._coupon.percent_off</span> <span>&gt;</span> <span>0</span> <span>and</span> <span>not</span> <span>self</span><span>._coupon.redeemed:</span>
            <span>return</span> <span>True</span>
        <span>return</span> <span>False</span>

    <span>def</span> <span>get_amount_off</span><span>(</span><span>self</span><span>,</span> <span>order_dollar_total):</span>
        <span>if</span> <span>not</span> <span>self</span><span>.is_valid():</span>
            <span>return</span> <span>0.0</span>
        <span>amount_off</span> <span>=</span> <span>self</span><span>._coupon.dollar_value</span>
        <span>amount_off</span> <span>+=</span> <span>(order_dollar_total</span> <span>-</span> <span>amount_off)</span> <span>*</span> <span>self</span><span>._coupon.percent_off</span>
        <span>return</span> <span>amount_off</span>

    <span>def</span> <span>mark_redeemed</span><span>(</span><span>self</span><span>):</span>
        <span>self</span><span>._coupon.redeemed</span> <span>=</span> <span>True</span>
        <span>self</span><span>._coupon.save()</span>
</pre>
</div>
<p>
</p><div>
<pre><span>import</span> <span>datetime</span>
<span>import</span> <span>random</span>

<span>from</span> <span>django.core.exceptions</span> <span>import</span> <span>ObjectDoesNotExist</span>
<span>from</span> <span>django.core.urlresolvers</span> <span>import</span> <span>reverse</span>
<span>from</span> <span>django.db</span> <span>import</span> <span>models</span>

<span>from</span> <span>..pictures.models</span> <span>import</span> <span>Picture</span>


<span>class</span> <span>_Event</span><span>(models.Model):</span>

    <span>class</span> <span>Meta</span><span>:</span>
        <span>app_label</span> <span>=</span> <span>"events"</span>
        <span>db_table</span> <span>=</span> <span>"events_event"</span>

    <span>name</span> <span>=</span> <span>models.CharField(max_length=</span><span>255</span><span>)</span>
    <span>date_hosted</span> <span>=</span> <span>models.DateTimeField()</span>
    <span># TODO make sure that I index on name, should be unique...</span>


<span>class</span> <span>Event</span><span>(</span><span>object</span><span>):</span>

    <span>def</span> <span>__init__</span><span>(</span><span>self</span><span>,</span> <span>_event):</span>
        <span>self</span><span>._event</span> <span>=</span> <span>_event</span>
        <span>self</span><span>._cached_pictures</span> <span>=</span> <span>None</span>
        <span>self</span><span>._cached_cover_picture</span> <span>=</span> <span>None</span>

    <span>@classmethod</span>
    <span>def</span> <span>_wrap</span><span>(cls,</span> <span>_event):</span>
        <span>return</span> <span>Event(_event)</span>

    <span>@classmethod</span>
    <span>def</span> <span>get_by_id</span><span>(cls,</span> <span>event_id):</span>
        <span>_event</span> <span>=</span> <span>_Event.objects.get(</span><span>id</span><span>=event_id)</span>
        <span>return</span> <span>cls._wrap(_event)</span>

    <span>@classmethod</span>
    <span>def</span> <span>get_or_create_from_event_name</span><span>(cls,</span> <span>event_name):</span>
        <span>cleaned_event_name</span> <span>=</span> <span>" "</span><span>.join(event_name.split())</span>
        <span>cleaned_event_name</span> <span>=</span> <span>cleaned_event_name.title()</span>
        <span>try</span><span>:</span>
            <span>_event</span> <span>=</span> <span>_Event.objects.get(name=cleaned_event_name)</span>
        <span>except</span> <span>ObjectDoesNotExist:</span>
            <span>_event</span> <span>=</span> <span>_Event.objects.create(name=cleaned_event_name,</span>
                                           <span>date_hosted=datetime.datetime.utcnow())</span>
        <span>return</span> <span>cls._wrap(_event)</span>

    <span>@classmethod</span>
    <span>def</span> <span>get_events_by_most_recent</span><span>(cls,</span> <span>max_count=</span><span>None</span><span>):</span>
        <span># this assumes that a relatively small number of events will take place</span>
        <span># total...no paging built in or anything</span>
        <span>_events</span> <span>=</span> <span>_Event.objects.all().order_by(</span><span>"-date_hosted"</span><span>)</span>
        <span>if</span> <span>max_count</span> <span>is</span> <span>not</span> <span>None</span><span>:</span>
            <span>_events</span> <span>=</span> <span>_events[:max_count]</span>
        <span>return</span> <span>[cls._wrap(_event)</span> <span>for</span> <span>_event</span> <span>in</span> <span>_events]</span>

    <span>def</span> <span>get_pictures</span><span>(</span><span>self</span><span>):</span>
        <span>if</span> <span>self</span><span>._cached_pictures</span> <span>is</span> <span>not</span> <span>None</span><span>:</span>
            <span>return</span> <span>self</span><span>._cached_pictures</span>
        <span>self</span><span>._cached_pictures</span> <span>=</span> <span>Picture.get_pictures_from_event(</span><span>self</span><span>)</span>
        <span>return</span> <span>self</span><span>._cached_pictures</span>

    <span>@property</span>
    <span>def</span> <span>_cover_picture</span><span>(</span><span>self</span><span>):</span>
        <span>if</span> <span>self</span><span>._cached_cover_picture</span> <span>is</span> <span>not</span> <span>None</span><span>:</span>
            <span>return</span> <span>self</span><span>._cached_cover_picture</span>
        <span>try</span><span>:</span>
            <span>self</span><span>._cached_cover_picture</span> <span>=</span> <span>random.choice(</span><span>self</span><span>.get_pictures())</span>
        <span>except</span> <span>IndexError</span><span>:</span>
            <span>self</span><span>._cached_cover_picture</span> <span>=</span> <span>None</span>
        <span>return</span> <span>self</span><span>._cached_cover_picture</span>

    <span>@property</span>
    <span>def</span> <span>cover_picture_thumbnail</span><span>(</span><span>self</span><span>):</span>
        <span>if</span> <span>self</span><span>._cover_picture:</span>
            <span>return</span> <span>self</span><span>._cover_picture.thumbnail_url</span>
        <span>return</span> <span>None</span>

    <span>@property</span>
    <span>def</span> <span>cover_picture_watermark</span><span>(</span><span>self</span><span>):</span>
        <span>if</span> <span>self</span><span>._cover_picture:</span>
            <span>return</span> <span>self</span><span>._cover_picture.watermark_url</span>
        <span>return</span> <span>None</span>

    <span>@property</span>
    <span>def</span> <span>id</span><span>(</span><span>self</span><span>):</span>
        <span>return</span> <span>self</span><span>._event.id</span>

    <span>@property</span>
    <span>def</span> <span>name</span><span>(</span><span>self</span><span>):</span>
        <span>return</span> <span>self</span><span>._event.name</span>

    <span>@property</span>
    <span>def</span> <span>formatted_date</span><span>(</span><span>self</span><span>):</span>
        <span>datetime_obj</span> <span>=</span> <span>self</span><span>._event.date_hosted</span>
        <span>return</span> <span>datetime_obj.strftime(</span><span>"%B %d, %Y"</span><span>)</span>

    <span>@property</span>
    <span>def</span> <span>url</span><span>(</span><span>self</span><span>):</span>
        <span>return</span> <span>reverse(</span><span>'event'</span><span>,</span> <span>args=[</span><span>self</span><span>.id])</span>
</pre>
</div>
<h1>
The End.<br/>
</h1>
  					<p class="clear"/>
 			 </div>	
			 
					   					</div></body></html>