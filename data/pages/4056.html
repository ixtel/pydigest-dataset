<html><body><div><div class="col s12 m12 l8 offset-l1" id="page">
            <p><a href=".././">Documentation</a> &gt; <a href="../Programming-Guide/">Programming Guide</a> &gt; Frameworks and Specific Scenarios &gt; Adding Real-Time to Django Applications</p>
<a name="top" class="anchor"/><h1>Adding Real-Time to Django Applications</h1>
<p>WAMP has a <a href="http://tavendo.com/blog/post/is-crossbar-the-future-of-python-web-apps/">lot of potential</a>, but it's asynchronous and most current Python Web stacks are synchronous.</p>
<p>Still, you may want to benefit from WAMP realtime notifications right now in your synchronous applications.</p>
<p>Crossbar.io enables you to trigger realtime notifications from your synchronous Python Web stack since it comes with a HTTP Pusher service: just configure a few lines of JSON in the Crossbar.io config file, and Crossbar.io provides a HTTP REST endpoint so that you can publish to a WAMP topic with a simple POST request.</p>

<div class="highlight-code"><div class="highlight"><pre><span class="s2">"transports"</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span>
       <span class="s2">"type"</span><span class="o">:</span> <span class="s2">"web"</span><span class="p">,</span>
       <span class="s2">"endpoint"</span><span class="o">:</span> <span class="p">{</span>
          <span class="s2">"type"</span><span class="o">:</span> <span class="s2">"tcp"</span><span class="p">,</span>
          <span class="s2">"port"</span><span class="o">:</span> <span class="mi">8080</span>
       <span class="p">},</span>
       <span class="s2">"paths"</span><span class="o">:</span> <span class="p">{</span>
          <span class="p">...</span>
          <span class="s2">"notify"</span><span class="o">:</span> <span class="p">{</span>
             <span class="s2">"type"</span><span class="o">:</span> <span class="s2">"pusher"</span><span class="p">,</span>
             <span class="s2">"realm"</span><span class="o">:</span> <span class="s2">"realm1"</span><span class="p">,</span>
             <span class="s2">"role"</span><span class="o">:</span> <span class="s2">"anonymous"</span>
          <span class="p">}</span>
       <span class="p">}</span>
    <span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
<p>Publishing to an example topic "great_topic" is then just:</p>

<div class="highlight-code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">requests</span>
<span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">"http://router_ip/notify"</span><span class="p">,</span>
                  <span class="n">json</span><span class="o">=</span><span class="p">{</span>
                      <span class="s1">'topic'</span><span class="p">:</span> <span class="s1">'great_topic'</span>
                      <span class="s1">'args'</span><span class="p">:</span> <span class="p">[</span><span class="n">some</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="k">pass</span><span class="p">,</span> <span class="n">along</span><span class="p">,</span> <span class="k">if</span><span class="p">,</span> <span class="n">you</span><span class="p">,</span> <span class="n">need</span><span class="p">,</span> <span class="n">to</span><span class="p">]</span>
                  <span class="p">})</span>
</pre></div>
</div>
<p>This sends a POST request to an endpoint at the path <code>notify</code>, and Crossbar.io dispatches a WAMP PubSub event based on it.</p>
<p>In order to illustrate this, I'm going to show you how to build a little monitoring service with Crossbar.io and Django. To follow this article, you'll need:</p>
<ul>
<li>a basic knowledge of JS.</li>
<li>an understanding of the basic WAMP concepts.</li>
<li>to know how to install Python 2.7 libs with C extensions on your machine.</li>
<li>to know Django. (Even if the concepts of the tutorial apply to Flask, Pyramid and others.)</li>
</ul>
<p>You can get the source code from the <a href="https://github.com/crossbario/crossbarexamples/tree/master/django/realtimemonitor">Crossbar.io examples repo</a>.</p>
<a name="top" class="anchor"/><h1>First steps</h1>
<p>Our goal is to have a little WAMP monitoring client that we run on each machine we wish to monitor. It will retrieve CPU, RAM and disk usage every X seconds and then publish this data using WAMP.</p>
<p>
</p>

<p>The client will talk to a server with a Django Website containing a model for each monitored machine, with values to say whether we are interested in the CPU, the RAM or the disk usage, and the currently set publishing interval for the data.</p>
<p>A web page displays all readings for all machines in real time. When we change a model in the Django admin, the page reflects the change immediately.</p>
<p>
</p>

<p>So, we will need Django</p>


<p>requests</p>


<p>and <a href="../pythonhosted.org/psutil//">psutil</a></p>
<p>"psutil" is the Python lib which will enable us to retrieve all the values for the RAM, the disk and the CPU. It uses C extensions, so you'll need a compiler and Python headers. Under Ubuntu, you'll need to do:</p>

<div class="highlight-code"><div class="highlight"><pre>sudo apt-get install gcc python-dev
</pre></div>
</div>
<p>For CentOS, that would be:</p>

<div class="highlight-code"><div class="highlight"><pre>yum groupinstall <span class="s2">"Development tools"</span>
yum install python-devel
</pre></div>
</div>
<p>In Mac, Python headers should be included, but you'll need GCC. If you have xcode, you already have a compiler, otherwise, there is a <a href="https://github.com/kennethreitz/osx-gcc-installer#readme">light installer</a> for it.</p>
<p>Windows installer is a wheel, so you don't need to do anything in particular.</p>
<p>Then you can</p>


<p>At last, we will need to <a href="http://crossbar.io/docs/Local-Installation/">install Crossbar.io</a>. The basic install can be done by doing</p>


<p>but note that Windows users will need to install <a href="http://sourceforge.net/projects/pywin32/files/pywin32/Build%20219/">PyWin32</a> first. Also, as usual, make sure you got your Python installation directories added in your system PATH otherwise none of the commands will be found.</p>
<a name="top" class="anchor"/><h1>The HTML</h1>
<p>The monitoring front end is just a single page. Since this article is framework agnostic, it's written using pure JS, not jQuery or AngularJS, which makes it verbose.</p>

<div class="highlight-code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">"utf-8"</span> <span class="p">/&gt;</span>

    <span class="c">&lt;!-- Some style to easily hide a block --&gt;</span>
    <span class="p">&lt;</span><span class="nt">style</span> <span class="na">type</span><span class="o">=</span><span class="s">"text/css"</span><span class="p">&gt;</span>
        <span class="nc">.hide</span> <span class="p">{</span><span class="nb">display</span><span class="o">:</span><span class="nb">none</span><span class="p">;}</span>
    <span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>

    <span class="c">&lt;!--</span>
<span class="c">        The JS lib allowing to speak WAMP.</span>

<span class="c">        Here I'm assuming we are using a browser with Websocket support.</span>
<span class="c">        It's possible to fall back to flash or long poll, but that</span>
<span class="c">        would require additional dependencies.</span>
<span class="c">    --&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"https://autobahn.s3.amazonaws.com/autobahnjs/latest/autobahn.min.jgz"</span>
           <span class="na">type</span><span class="o">=</span><span class="s">"text/javascript"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>


    <span class="c">&lt;!-- All our client code, inlined for easy reading --&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">"text/javascript"</span><span class="p">&gt;</span>

      <span class="cm">/* When the page is loaded, run our code. */</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">"load"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>

        <span class="cm">/* Connection configuration to our WAMP router */</span>
        <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">autobahn</span><span class="p">.</span><span class="nx">Connection</span><span class="p">({</span>
           <span class="nx">url</span><span class="o">:</span> <span class="s1">'ws://127.0.0.1:8080/ws'</span><span class="p">,</span>
           <span class="nx">realm</span><span class="o">:</span> <span class="s1">'realm1'</span>
        <span class="p">});</span>

        <span class="cm">/* When the connection is opened, execute this code */</span>
        <span class="nx">connection</span><span class="p">.</span><span class="nx">onopen</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">session</span><span class="p">)</span> <span class="p">{</span>

          <span class="kd">var</span> <span class="nx">clients</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"clients"</span><span class="p">);</span>

          <span class="cm">/* When we receive the 'clientstats' event, run this function */</span>
          <span class="nx">session</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'clientstats'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">args</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">stats</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="kd">var</span> <span class="nx">serverNode</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">stats</span><span class="p">.</span><span class="nx">ip</span><span class="p">);</span>

            <span class="cm">/*</span>
<span class="cm">                Create a LI containing a H2 and a DL for this client if</span>
<span class="cm">                it's not in the page already.</span>
<span class="cm">            */</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">serverNode</span><span class="p">){</span>
                <span class="nx">serverNode</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">"li"</span><span class="p">);</span>
                <span class="nx">serverNode</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">stats</span><span class="p">.</span><span class="nx">ip</span><span class="p">;</span>
                <span class="nx">serverNode</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">"h2"</span><span class="p">));</span>
                <span class="nx">serverNode</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">"dl"</span><span class="p">));</span>
                <span class="nx">serverNode</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">stats</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">" ("</span> <span class="o">+</span> <span class="nx">stats</span><span class="p">.</span><span class="nx">ip</span> <span class="o">+</span> <span class="s2">")"</span><span class="p">;</span>
                <span class="nx">clients</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">serverNode</span><span class="p">);</span>

                <span class="c1">// Hide the informations for this machine if it's been</span>
                <span class="c1">// disabled.</span>
                <span class="nx">session</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'clientconfig.'</span> <span class="o">+</span> <span class="nx">stats</span><span class="p">.</span><span class="nx">ip</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">args</span><span class="p">){</span>
                    <span class="kd">var</span> <span class="nx">config</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">disabled</span><span class="p">){</span>
                        <span class="kd">var</span> <span class="nx">serverNode</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">ip</span><span class="p">);</span>
                        <span class="nx">serverNode</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s2">"hide"</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">});</span>

            <span class="p">}</span>

            <span class="c1">// Reset the client's LI content</span>
            <span class="nx">serverNode</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">dl</span> <span class="o">=</span> <span class="nx">serverNode</span><span class="p">.</span><span class="nx">lastChild</span><span class="p">;</span>
            <span class="k">while</span> <span class="p">(</span><span class="nx">dl</span><span class="p">.</span><span class="nx">hasChildNodes</span><span class="p">())</span> <span class="p">{</span>
                <span class="nx">dl</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">dl</span><span class="p">.</span><span class="nx">lastChild</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="c1">// If we got CPU data, display it</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">stats</span><span class="p">.</span><span class="nx">cpus</span><span class="p">){</span>
                <span class="kd">var</span> <span class="nx">cpus</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">"dt"</span><span class="p">);</span>
                <span class="nx">cpus</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">"CPUs:"</span><span class="p">;</span>
                <span class="nx">dl</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">cpus</span><span class="p">);</span>
                <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">stats</span><span class="p">.</span><span class="nx">cpus</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">cpu</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">"dd"</span><span class="p">);</span>
                    <span class="nx">cpu</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">stats</span><span class="p">.</span><span class="nx">cpus</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                    <span class="nx">dl</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">cpu</span><span class="p">);</span>
                <span class="p">};</span>
            <span class="p">}</span>

            <span class="c1">// If we got disk usage data, display it</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">stats</span><span class="p">.</span><span class="nx">disks</span><span class="p">){</span>
                <span class="kd">var</span> <span class="nx">disks</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">"dt"</span><span class="p">);</span>
                <span class="nx">disks</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">"Disk usage:"</span><span class="p">;</span>
                <span class="nx">dl</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">disks</span><span class="p">);</span>
                <span class="k">for</span> <span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">stats</span><span class="p">.</span><span class="nx">disks</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">disk</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">"dd"</span><span class="p">);</span>
                    <span class="nx">disk</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">"&lt;strong&gt;"</span> <span class="o">+</span> <span class="nx">key</span> <span class="o">+</span> <span class="s2">"&lt;/strong&gt;: "</span> <span class="o">+</span> <span class="nx">stats</span><span class="p">.</span><span class="nx">disks</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
                    <span class="nx">dl</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">disk</span><span class="p">);</span>
                <span class="p">};</span>
            <span class="p">}</span>

            <span class="c1">// If we got memory data, display it</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">stats</span><span class="p">.</span><span class="nx">memory</span><span class="p">){</span>
                <span class="kd">var</span> <span class="nx">memory</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">"dt"</span><span class="p">);</span>
                <span class="nx">memory</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">"Memory:"</span><span class="p">;</span>
                <span class="nx">dl</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">memory</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">memVal</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">"dd"</span><span class="p">);</span>
                <span class="nx">memVal</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">stats</span><span class="p">.</span><span class="nx">memory</span><span class="p">;</span>
                <span class="nx">dl</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">memVal</span><span class="p">);</span>
            <span class="p">}</span>

          <span class="p">});</span>

        <span class="p">};</span>

        <span class="c1">// Open the WAMP connection with the router.</span>
        <span class="nx">connection</span><span class="p">.</span><span class="nx">open</span><span class="p">();</span>

      <span class="p">});</span>
    <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span> Monitoring<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span> Monitoring <span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">ul</span> <span class="na">id</span><span class="o">=</span><span class="s">"clients"</span><span class="p">&gt;&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>

<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>As you can see, most of it is ordinary JS, and DOM manipulations. The only WAMP specific parts are:</p>

<div class="highlight-code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">autobahn</span><span class="p">.</span><span class="nx">Connection</span><span class="p">({</span>
           <span class="nx">url</span><span class="o">:</span> <span class="s1">'ws://127.0.0.1:8080/ws'</span><span class="p">,</span>
           <span class="nx">realm</span><span class="o">:</span> <span class="s1">'realm1'</span>
        <span class="p">});</span>
<span class="nx">connection</span><span class="p">.</span><span class="nx">onopen</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">session</span><span class="p">)</span> <span class="p">{</span>
<span class="p">...</span>
<span class="p">}</span>
<span class="nx">connection</span><span class="p">.</span><span class="nx">open</span><span class="p">();</span>
</pre></div>
</div>
<p>which etablishes the connection to the router, and</p>

<div class="highlight-code"><div class="highlight"><pre><span class="nx">session</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'clientstats'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">args</span><span class="p">){</span>
<span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>which subscribes us to the topic <code>clientstats</code> and provides the function to extecute on each WAMP publication to this topic.</p>
<a name="top" class="anchor"/><h1>Client monitoring</h1>
<p>This is the code that will run on each machine we want to monitor:</p>

<div class="highlight-code"><div class="highlight"><pre><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>

<span class="kn">import</span> <span class="nn">socket</span>

<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">psutil</span>

<span class="kn">from</span> <span class="nn">autobahn.twisted.wamp</span> <span class="kn">import</span> <span class="n">Application</span>
<span class="kn">from</span> <span class="nn">autobahn.twisted.util</span> <span class="kn">import</span> <span class="n">sleep</span>

<span class="kn">from</span> <span class="nn">twisted.internet.defer</span> <span class="kn">import</span> <span class="n">inlineCallbacks</span>

<span class="k">def</span> <span class="nf">to_gib</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">30</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">"GiB"</span><span class="p">):</span>
    <span class="sd">""" Convert a number of bytes to Gibibytes</span>

<span class="sd">        Ex : 1073741824 bytes = 1073741824/2**30 = 1GiB</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="s2">"</span><span class="si">%0.2f%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="nb">bytes</span> <span class="o">/</span> <span class="n">factor</span><span class="p">,</span> <span class="n">suffix</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_stats</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sd">""" Returns the current values for CPU/memory/disk usage.</span>

<span class="sd">        These values are returned as a dict such as:</span>

<span class="sd">            {</span>
<span class="sd">                'cpus': ['x%', 'y%', etc],</span>
<span class="sd">                'memory': "z%",</span>
<span class="sd">                'disk':{</span>
<span class="sd">                    '/partition/1': 'x/y (z%)',</span>
<span class="sd">                    '/partition/2': 'x/y (z%)',</span>
<span class="sd">                    etc</span>
<span class="sd">                }</span>
<span class="sd">            }</span>

<span class="sd">        The filter parameter is a dict such as:</span>

<span class="sd">            {'cpus': bool, 'memory':bool, 'disk':bool}</span>

<span class="sd">        It's used to decide to include or not values for the 3 types of</span>
<span class="sd">        ressources.</span>
<span class="sd">    """</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'show_cpus'</span><span class="p">,</span> <span class="bp">True</span><span class="p">)):</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">'cpus'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="s2">"</span><span class="si">%s%%</span><span class="s2">"</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">psutil</span><span class="o">.</span><span class="n">cpu_percent</span><span class="p">(</span><span class="n">percpu</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'show_memory'</span><span class="p">,</span> <span class="bp">True</span><span class="p">)):</span>
        <span class="n">memory</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">phymem_usage</span><span class="p">()</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">'memory'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'{used}/{total} ({percent}%)'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">used</span><span class="o">=</span><span class="n">to_gib</span><span class="p">(</span><span class="n">memory</span><span class="o">.</span><span class="n">used</span><span class="p">),</span>
            <span class="n">total</span><span class="o">=</span><span class="n">to_gib</span><span class="p">(</span><span class="n">memory</span><span class="o">.</span><span class="n">total</span><span class="p">),</span>
            <span class="n">percent</span><span class="o">=</span><span class="n">memory</span><span class="o">.</span><span class="n">percent</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'show_disk'</span><span class="p">,</span> <span class="bp">True</span><span class="p">)):</span>
        <span class="n">disks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">psutil</span><span class="o">.</span><span class="n">disk_partitions</span><span class="p">():</span>
            <span class="c1"># skip mountpoint not actually mounted (like CD drives with no disk on Windows)</span>
            <span class="k">if</span> <span class="n">device</span><span class="o">.</span><span class="n">fstype</span> <span class="o">!=</span> <span class="s2">""</span><span class="p">:</span>
                <span class="n">usage</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">disk_usage</span><span class="p">(</span><span class="n">device</span><span class="o">.</span><span class="n">mountpoint</span><span class="p">)</span>
                <span class="n">disks</span><span class="p">[</span><span class="n">device</span><span class="o">.</span><span class="n">mountpoint</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'{used}/{total} ({percent}%)'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">used</span><span class="o">=</span><span class="n">to_gib</span><span class="p">(</span><span class="n">usage</span><span class="o">.</span><span class="n">used</span><span class="p">),</span>
                    <span class="n">total</span><span class="o">=</span><span class="n">to_gib</span><span class="p">(</span><span class="n">usage</span><span class="o">.</span><span class="n">total</span><span class="p">),</span>
                    <span class="n">percent</span><span class="o">=</span><span class="n">usage</span><span class="o">.</span><span class="n">percent</span>
                <span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">'disks'</span><span class="p">]</span> <span class="o">=</span> <span class="n">disks</span>

    <span class="k">return</span> <span class="n">results</span>

<span class="c1"># We create the WAMP client.</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Application</span><span class="p">(</span><span class="s1">'monitoring'</span><span class="p">)</span>

<span class="c1"># This is my set to localhost to enable running a first</span>
<span class="c1"># test client instance on the machine that Crossbar.io &amp; Django</span>
<span class="c1"># are running on. You should change this value</span>
<span class="c1"># to the pulbic IP of the machine for external clients.</span>
<span class="n">SERVER</span> <span class="o">=</span> <span class="s1">'127.0.0.1'</span>

<span class="c1"># First, we use a trick to know the public IP for this</span>
<span class="c1"># machine.</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s2">"8.8.8.8"</span><span class="p">,</span> <span class="mi">80</span><span class="p">))</span>
<span class="c1"># We attach a dict to the app, so that its</span>
<span class="c1"># reference is accessible from anywhere.</span>
<span class="n">app</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'name'</span><span class="p">:</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">(),</span> <span class="s1">'ip'</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">0</span><span class="p">]}</span>
<span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="nd">@app.signal</span><span class="p">(</span><span class="s1">'onjoined'</span><span class="p">)</span>
<span class="nd">@inlineCallbacks</span>
<span class="k">def</span> <span class="nf">called_on_joinded</span><span class="p">():</span>
    <span class="sd">""" Loop sending the state of this machine using WAMP every x seconds.</span>

<span class="sd">        This function is executed when the client joins the router, which</span>
<span class="sd">        means it's connected and authenticated, ready to send WAMP messages.</span>
<span class="sd">    """</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Connected"</span><span class="p">)</span>

    <span class="c1"># Then we make a POST request to the server to notify it we are active</span>
    <span class="c1"># and to retrieve the configuration values for our client.</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">'http://'</span> <span class="o">+</span> <span class="n">SERVER</span> <span class="o">+</span> <span class="s1">':8080/clients/'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">'ip'</span><span class="p">:</span> <span class="n">app</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">'ip'</span><span class="p">]})</span>
    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">app</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Could not retrieve configuration for client: {} ({})"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">reason</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">))</span>


    <span class="c1"># The we loop for ever.</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Entering stats loop .."</span><span class="p">)</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Tick"</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Every time we loop, we get the stats for our machine</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'ip'</span><span class="p">:</span> <span class="n">app</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">'ip'</span><span class="p">],</span> <span class="s1">'name'</span><span class="p">:</span> <span class="n">app</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]}</span>
            <span class="n">stats</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">get_stats</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">_params</span><span class="p">))</span>

            <span class="c1"># If we are requested to send the stats, we publish them using WAMP.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">app</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">'disabled'</span><span class="p">]:</span>
                <span class="n">app</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s1">'clientstats'</span><span class="p">,</span> <span class="n">stats</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">"Stats published: {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stats</span><span class="p">))</span>

            <span class="c1"># Then we wait. Thanks to @inlineCallbacks, using yield means we</span>
            <span class="c1"># won't block here, so our client can still listen to WAMP events</span>
            <span class="c1"># and react to them.</span>
            <span class="k">yield</span> <span class="n">sleep</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">'frequency'</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"Error in stats loop: {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">break</span>


<span class="c1"># We subscribe to the "clientconfig" WAMP event.</span>
<span class="nd">@app.subscribe</span><span class="p">(</span><span class="s1">'clientconfig.'</span> <span class="o">+</span> <span class="n">app</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">'ip'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">update_configuration</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">""" Update the client configuration when Django asks for it. """</span>
    <span class="n">app</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<span class="c1"># We start our client.</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s2">"ws://</span><span class="si">%s</span><span class="s2">:8080/ws"</span> <span class="o">%</span> <span class="n">SERVER</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">debug_wamp</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
<p><code>app = Application('monitoring')</code> creates a WAMP client, and <code>@app.signal('onjoined')</code> tells us how to start the function when our client is connected and ready to send events. <code>@inlineCallbacks</code> is a specific feature of Twisted allowing us to write asynchronous code without using explicit callbacks everywhere: instead of them, we use <code>yield</code>.</p>
<p>All the work of our client happens in the loop: <code>app.session.publish('clientstats', infos)</code> publishes new stats for the CPU/RAM/Disk via WAMP, then waits for some time (<code>yield sleep(app._params['frequency']</code>) before doing it again. Waiting is not blocking, thanks to the <code>sleep()</code> from Twisted.</p>
<p>Let's not forget:</p>

<div class="highlight-code"><div class="highlight"><pre><span class="nd">@app.subscribe</span><span class="p">(</span><span class="s1">'clientconfig.'</span> <span class="o">+</span> <span class="n">app</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">'ip'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">update_configuration</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">app</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code>update_configuration()</code> function is called every time a WAMP publication is made to the topic "clientconfig.&lt;client_ip&gt;". Our function only updates the client configuration, which is a dict, looking like:</p>

<div class="highlight-code"><div class="highlight"><pre><span class="p">{</span><span class="s1">'cpus'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
<span class="s1">'memory'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
<span class="s1">'disk'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
<span class="s1">'disabled'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
<span class="s1">'frequency'</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
</pre></div>
</div>
<p>It's this dict which is used by <code>get_stats()</code> to choose which values to retrieve, and also in the loop to know how many seconds to wait until the next measurements or if we send the stats at all.</p>
<p>The initial value for this dict is retrieved when the client starts, by doing:</p>

<div class="highlight-code"><div class="highlight"><pre><span class="n">app</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">'http://'</span> <span class="o">+</span> <span class="n">SERVER</span> <span class="o">+</span> <span class="s1">':8080/clients/'</span><span class="p">,</span>
                                    <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">'ip'</span><span class="p">:</span> <span class="n">app</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">'ip'</span><span class="p">]})</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
</pre></div>
</div>
<p><code>requests.post(server_url, data={'ip': app._params['ip']}).json()</code> does a POST request to a Django URL which we'll see later, returning the client's configuration matching this IP, as JSON.</p>
<p>We use HTTP once to get the values at the beginning, then WAMP for all future udpates. WAMP and HTTP are not excluding each other: they are complementary.</p>
<p>A little digression:</p>

<div class="highlight-code"><div class="highlight"><pre><span class="n">SERVER</span> <span class="o">=</span> <span class="s1">'192.168.0.104'</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s2">"8.8.8.8"</span><span class="p">,</span> <span class="mi">80</span><span class="p">))</span>
<span class="n">app</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'name'</span><span class="p">:</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">(),</span> <span class="s1">'ip'</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">0</span><span class="p">]}</span>
<span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>As you can see I hard coded the IP of the Crossbar.io and Django server out of pure laziness. But in production this should, obviously, be a parameter or an environment variable.</p>
<p>Remember you can get this IP on Linux and Mac doing (from the server machine):</p>


<p>And on Windows:</p>


<p>Then, since I need to identify my client, I do it with its IP address too. So I need its public IP, which I get by using a little trick involving opening a connection to some reliable external IP (here the Google DNS 8.8.8.8) and by closing it right after that. This lets me know how other machines see me from the outside world.</p>
<h2>The Django Web site</h2><p>Since this article requires that you know Django, this will be easier.</p>
<p>We create a project and an app:</p>

<div class="highlight-code"><div class="highlight"><pre>django-admin startproject django_project
./manage.py startapp django_app
</pre></div>
</div>
<p>And we add the app to <code>settings.INSTALLED_APPS</code>.</p>
<p>Then we write a small model containing the configuration for each client (remember our dict ? This is where it comes from):</p>

<div class="highlight-code"><div class="highlight"><pre><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">requests</span>

<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.db.models.signals</span> <span class="kn">import</span> <span class="n">post_save</span>
<span class="kn">from</span> <span class="nn">django.dispatch</span> <span class="kn">import</span> <span class="n">receiver</span>
<span class="kn">from</span> <span class="nn">django.forms.models</span> <span class="kn">import</span> <span class="n">model_to_dict</span>


<span class="k">class</span> <span class="nc">Client</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">""" Our client configuration """</span>

    <span class="c1"># Client unique identifier</span>
    <span class="n">ip</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">GenericIPAddressField</span><span class="p">()</span>

    <span class="c1"># What data to send to the dashboard</span>
    <span class="n">show_cpus</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">show_memory</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">show_disk</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># Stop sending data</span>
    <span class="n">disabled</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># Data refresh frequency</span>
    <span class="n">frequency</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip</span>


<span class="nd">@receiver</span><span class="p">(</span><span class="n">post_save</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">Client</span><span class="p">,</span> <span class="n">dispatch_uid</span><span class="o">=</span><span class="s2">"server_post_save"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">notify_server_config_changed</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">""" Notifies a client that its config has changed.</span>

<span class="sd">        This function is executed when we save a Client model, and it</span>
<span class="sd">        makes a POST request on the WAMP-HTTP bridge, allowing us to</span>
<span class="sd">        make a WAMP publication from Django.</span>
<span class="sd">    """</span>
    <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">"http://127.0.0.1:8080/notify"</span><span class="p">,</span>
                  <span class="n">json</span><span class="o">=</span><span class="p">{</span>
                      <span class="s1">'topic'</span><span class="p">:</span> <span class="s1">'clientconfig.'</span> <span class="o">+</span> <span class="n">instance</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span>
                      <span class="s1">'args'</span><span class="p">:</span> <span class="p">[</span><span class="n">model_to_dict</span><span class="p">(</span><span class="n">instance</span><span class="p">)]</span>
                  <span class="p">})</span>
</pre></div>
</div>
<p>The model part is known territory. The fun part is actually:</p>

<div class="highlight-code"><div class="highlight"><pre><span class="nd">@receiver</span><span class="p">(</span><span class="n">post_save</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">Client</span><span class="p">,</span> <span class="n">dispatch_uid</span><span class="o">=</span><span class="s2">"server_post_save"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">notify_server_config_changed</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">"http://127.0.0.1:8080/notify"</span><span class="p">,</span>
                  <span class="n">json</span><span class="o">=</span><span class="p">{</span>
                      <span class="s1">'topic'</span><span class="p">:</span> <span class="s1">'clientconfig.'</span> <span class="o">+</span> <span class="n">instance</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span>
                      <span class="s1">'args'</span><span class="p">:</span> <span class="p">[</span><span class="n">model_to_dict</span><span class="p">(</span><span class="n">instance</span><span class="p">)]</span>
                  <span class="p">})</span>
</pre></div>
</div>
<p>Here we use Django signals, a framework feature allowing us to trigger a function when something happens. In our case, we say 'run this function when one Client model is modified'.</p>
<p>So <code>notify_server_config_changed()</code> is executed when a client configuration is modified, such as when using the Django admin, and will receive the modified object as the "instance" parameter.</p>
<p>Now we make a small POST request to <code>http://127.0.0.1:8080/notify</code>, which is the URL we will later use to configure our PUSH service. By doing a request to it, we are asking Crossbar.io to turn this HTTP request into a WAMP publication about the 'clientconfig.&lt;client_ip&gt;' topic. For all intents and purposes, we are publishing a WAMP message from Django.</p>
<p>This works from anywhere, not just Django. From the shell, from Flask, from any place you can make an HTTP request you can publish using the Crossbar.io push service.</p>
<p>The message we sent is going to be received by our clients, whereever they are, since they are all connected to the same WAMP router. Indeed, our client did:</p>

<div class="highlight-code"><div class="highlight"><pre><span class="nd">@app.subscribe</span><span class="p">(</span><span class="s1">'clientconfig.'</span> <span class="o">+</span> <span class="n">app</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">'ip'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">update_configuration</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">app</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</pre></div>
</div>
<p>So it will receive the message, the content of <code>args</code>: <code>[model_to_dict(instance)]</code>, meaning the new configuration which has just changed in the data base. This way it can update itself immediately.</p>
<p>To illustrate this, we add the model in our Django admin:</p>

<div class="highlight-code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>

<span class="c1"># Register your models here.</span>

<span class="kn">from</span> <span class="nn">django_app.models</span> <span class="kn">import</span> <span class="n">Client</span>

<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Client</span><span class="p">)</span>
</pre></div>
</div>
<p>Doing this makes the client configurations editable from the Django admin, and when clicking the "save" button, it sends our WAMP publication, which triggers the right client update.</p>
<p>The rest is just small tweaks:</p>

<div class="highlight-code"><div class="highlight"><pre><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">django_app.models</span> <span class="kn">import</span> <span class="n">Client</span>
<span class="kn">from</span> <span class="nn">django.views.decorators.csrf</span> <span class="kn">import</span> <span class="n">csrf_exempt</span>
<span class="kn">from</span> <span class="nn">django.forms.models</span> <span class="kn">import</span> <span class="n">model_to_dict</span>

<span class="nd">@csrf_exempt</span>
<span class="k">def</span> <span class="nf">clients</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">""" Retrieve a client config from DB and send it back to the client """</span>
    <span class="n">ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'ip'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">client</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">ip</span><span class="o">=</span><span class="n">ip</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">model_to_dict</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Could not retrieve client config for IP '{}': {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Client config for retrieved for IP '{}'"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">'application/json'</span><span class="p">)</span>
</pre></div>
</div>
<p>We disable the CSRF protection for the demo, but once again, in production, you should do that in a clean way, with <code>@login_required</code>, protected views and CSRF token exchanges.</p>
<p>This view retrieves the client configuration matching this IP (creating it if needed), and returns it as JSON. Remember, this allows our client to do:</p>

<div class="highlight-code"><div class="highlight"><pre><span class="n">app</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">'http://'</span> <span class="o">+</span> <span class="n">SERVER</span> <span class="o">+</span> <span class="s1">':8080/clients/'</span><span class="p">,</span>
                                    <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">'ip'</span><span class="p">:</span> <span class="n">app</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">'ip'</span><span class="p">]})</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
</pre></div>
</div>
<p>So at startup it declares itself in the database, and gets its config back.</p>
<p>You plug all the moving parts in urls.py:</p>

<div class="highlight-code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">include</span><span class="p">,</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">django.views.generic</span> <span class="kn">import</span> <span class="n">TemplateView</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="s1">r'^admin/'</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span>
    <span class="n">url</span><span class="p">(</span><span class="s1">r'^clients/'</span><span class="p">,</span> <span class="s1">'django_app.views.clients'</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s1">r'^$'</span><span class="p">,</span> <span class="n">TemplateView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(</span><span class="n">template_name</span><span class="o">=</span><span class="s1">'dashboard.html'</span><span class="p">)),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>This contains the routes for the admin, our new view, and some generic code to serve the HTML we saw at the beginning of this article.</p>
<p>Then you need to create your database and collect static files :</p>

<div class="highlight-code"><div class="highlight"><pre>./manage.py syncdb
./manage.py collectstatic
</pre></div>
</div>
<a name="top" class="anchor"/><h1>Crossbar.io</h1>
<p>Finally, we just need to configure Crossbar.io. On the command line go to your project's base directory and do</p>

<pre class="plaincode"><code>crossbar init</code></pre>
<p>This creates the <code>.crossbar</code> directory which contains a <code>config.json</code> file. We need to edit this to look like:</p>

<div class="highlight-code"><div class="highlight"><pre><span class="p">{</span>
   <span class="s2">"workers"</span><span class="o">:</span> <span class="p">[</span>
      <span class="p">{</span>
         <span class="s2">"type"</span><span class="o">:</span> <span class="s2">"router"</span><span class="p">,</span>
         <span class="s2">"options"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"pythonpath"</span><span class="o">:</span> <span class="p">[</span><span class="s2">".."</span><span class="p">]</span>
         <span class="p">},</span>
         <span class="s2">"realms"</span><span class="o">:</span> <span class="p">[</span>
            <span class="p">{</span>
               <span class="s2">"name"</span><span class="o">:</span> <span class="s2">"realm1"</span><span class="p">,</span>
               <span class="s2">"roles"</span><span class="o">:</span> <span class="p">[</span>
                  <span class="p">{</span>
                     <span class="s2">"name"</span><span class="o">:</span> <span class="s2">"anonymous"</span><span class="p">,</span>
                     <span class="s2">"permissions"</span><span class="o">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                           <span class="s2">"uri"</span><span class="o">:</span> <span class="s2">"*"</span><span class="p">,</span>
                           <span class="s2">"publish"</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                           <span class="s2">"subscribe"</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                           <span class="s2">"call"</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                           <span class="s2">"register"</span><span class="o">:</span> <span class="kc">true</span>
                        <span class="p">}</span>
                     <span class="p">]</span>
                  <span class="p">}</span>
               <span class="p">]</span>
            <span class="p">}</span>
         <span class="p">],</span>
         <span class="s2">"transports"</span><span class="o">:</span> <span class="p">[</span>
            <span class="p">{</span>
               <span class="s2">"type"</span><span class="o">:</span> <span class="s2">"web"</span><span class="p">,</span>
               <span class="s2">"endpoint"</span><span class="o">:</span> <span class="p">{</span>
                  <span class="s2">"type"</span><span class="o">:</span> <span class="s2">"tcp"</span><span class="p">,</span>
                  <span class="s2">"port"</span><span class="o">:</span> <span class="mi">8080</span>
               <span class="p">},</span>
               <span class="s2">"paths"</span><span class="o">:</span> <span class="p">{</span>
                  <span class="s2">"/"</span><span class="o">:</span> <span class="p">{</span>
                     <span class="s2">"type"</span><span class="o">:</span> <span class="s2">"wsgi"</span><span class="p">,</span>
                     <span class="s2">"module"</span><span class="o">:</span> <span class="s2">"django_project.wsgi"</span><span class="p">,</span>
                     <span class="s2">"object"</span><span class="o">:</span> <span class="s2">"application"</span>
                  <span class="p">},</span>
                  <span class="s2">"ws"</span><span class="o">:</span> <span class="p">{</span>
                     <span class="s2">"type"</span><span class="o">:</span> <span class="s2">"websocket"</span><span class="p">,</span>
                     <span class="s2">"debug"</span><span class="o">:</span> <span class="kc">false</span>
                  <span class="p">},</span>
                  <span class="s2">"notify"</span><span class="o">:</span> <span class="p">{</span>
                     <span class="s2">"type"</span><span class="o">:</span> <span class="s2">"pusher"</span><span class="p">,</span>
                     <span class="s2">"realm"</span><span class="o">:</span> <span class="s2">"realm1"</span><span class="p">,</span>
                     <span class="s2">"role"</span><span class="o">:</span> <span class="s2">"anonymous"</span>
                  <span class="p">},</span>
                  <span class="s2">"static"</span><span class="o">:</span> <span class="p">{</span>
                     <span class="s2">"type"</span><span class="o">:</span> <span class="s2">"static"</span><span class="p">,</span>
                     <span class="s2">"directory"</span><span class="o">:</span> <span class="s2">"../static"</span>
                  <span class="p">}</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">]</span>
      <span class="p">}</span>
   <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The first part is more or less Crossbar.io's equivalent of chmod 777:</p>

<div class="highlight-code"><div class="highlight"><pre><span class="s2">"type"</span><span class="o">:</span> <span class="s2">"router"</span><span class="p">,</span>
         <span class="s2">"realms"</span><span class="o">:</span> <span class="p">[</span>
            <span class="p">{</span>
               <span class="s2">"name"</span><span class="o">:</span> <span class="s2">"realm1"</span><span class="p">,</span>
               <span class="s2">"roles"</span><span class="o">:</span> <span class="p">[</span>
                  <span class="p">{</span>
                     <span class="s2">"name"</span><span class="o">:</span> <span class="s2">"anonymous"</span><span class="p">,</span>
                     <span class="s2">"permissions"</span><span class="o">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                           <span class="s2">"uri"</span><span class="o">:</span> <span class="s2">"*"</span><span class="p">,</span>
                           <span class="s2">"publish"</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                           <span class="s2">"subscribe"</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                           <span class="s2">"call"</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                           <span class="s2">"register"</span><span class="o">:</span> <span class="kc">true</span>
                        <span class="p">}</span>
                     <span class="p">]</span>
                  <span class="p">}</span>
               <span class="p">]</span>
            <span class="p">}</span>
         <span class="p">]</span>
</pre></div>
</div>
<p>"Set me up a router with an access named 'realm1' authorizing anonymous clients to do anything". A realm is security notion in Crossbar.io used to isolate connected clients and give them permissions, but we are going to put them all in the same realm to make the demo simple.</p>
<p>Then we add transports for each desired technology. We are going to group them all under the "8080" port as Twisted can listen to HTTP and Websocket on a single port at the same time.</p>

<div class="highlight-code"><div class="highlight"><pre><span class="s2">"transports"</span><span class="o">:</span> <span class="p">[</span>
<span class="p">{</span>
   <span class="s2">"type"</span><span class="o">:</span> <span class="s2">"web"</span><span class="p">,</span>
   <span class="s2">"endpoint"</span><span class="o">:</span> <span class="p">{</span>
      <span class="s2">"type"</span><span class="o">:</span> <span class="s2">"tcp"</span><span class="p">,</span>
      <span class="s2">"port"</span><span class="o">:</span> <span class="mi">8080</span>
   <span class="p">}</span>
</pre></div>
</div>
<p>The root URL will serve our Django app:</p>

<div class="highlight-code"><div class="highlight"><pre><span class="s2">"/"</span><span class="o">:</span> <span class="p">{</span>
 <span class="s2">"type"</span><span class="o">:</span> <span class="s2">"wsgi"</span><span class="p">,</span>
 <span class="s2">"module"</span><span class="o">:</span> <span class="s2">"django_project.wsgi"</span><span class="p">,</span>
 <span class="s2">"object"</span><span class="o">:</span> <span class="s2">"application"</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Yes, Crossbar.io can server your Django app. It's not mandatory, but it will exempt you from needing Gunicorn and Nginx. The Web server in Twisted can take a real life traffic load without problems.</p>
<p>For our example, we use Crossbar.io for everything, making the setup easier. To do that, we just need to tell it which variable (application) from which WSGI file (django_project/wsgi.py) to load.</p>
<p>On '/ws', we listen for Websocket traffic:</p>

<div class="highlight-code"><div class="highlight"><pre><span class="s2">"ws"</span><span class="o">:</span> <span class="p">{</span>
 <span class="s2">"type"</span><span class="o">:</span> <span class="s2">"websocket"</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This is where WAMP comes in, and that's why our clients connect to the router by doing <code>app.run(url="ws://%s:8080/ws" % SERVER)</code> and <code>autobahn.Connection({url: 'ws://127.0.0.1:8080/ws', realm: 'realm1'})</code>.</p>
<p>Then, '/notify' is for our WAMP-HTTP bridge:</p>

<div class="highlight-code"><div class="highlight"><pre><span class="s2">"notify"</span><span class="o">:</span> <span class="p">{</span>
     <span class="s2">"type"</span><span class="o">:</span> <span class="s2">"pusher"</span><span class="p">,</span>
     <span class="s2">"realm"</span><span class="o">:</span> <span class="s2">"realm1"</span><span class="p">,</span>
     <span class="s2">"role"</span><span class="o">:</span> <span class="s2">"anonymous"</span>
  <span class="p">}</span>
</pre></div>
</div>
<p>All anonymous clients from <code>realm1</code> can use the HTTP REST endpoint created by this. It's thanks to this that we were able to do this in our Django signal:</p>

<div class="highlight-code"><div class="highlight"><pre><span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">"http://127.0.0.1:8080/notify"</span><span class="p">,</span>
                  <span class="n">json</span><span class="o">=</span><span class="p">{</span>
                      <span class="s1">'topic'</span><span class="p">:</span> <span class="s1">'clientconfig.'</span> <span class="o">+</span> <span class="n">instance</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span>
                      <span class="s1">'args'</span><span class="p">:</span> <span class="p">[</span><span class="n">model_to_dict</span><span class="p">(</span><span class="n">instance</span><span class="p">)]</span>
                  <span class="p">})</span>
</pre></div>
</div>
<p>and publish a WAMP message via a HTTP POST.</p>
<p>At last, we serve Django static files:</p>

<div class="highlight-code"><div class="highlight"><pre><span class="s2">"static"</span><span class="o">:</span> <span class="p">{</span>
 <span class="s2">"type"</span><span class="o">:</span> <span class="s2">"static"</span><span class="p">,</span>
 <span class="s2">"directory"</span><span class="o">:</span> <span class="s2">"../static"</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now that everything is in place, we can start Crossbar.io:</p>


<p>Let's visit http:127.0.0.1:8080/ to see your Django template dashboard.The HTML comes to life!</p>
<p>For each machine running a client (<code>python client.py</code>), new stats appear on the dashboard, and are be updated in real time. (Remember to change the server IP to the one your Django/Crossbar.io instance are on!)</p>
<p>Now if you open a new tab to http:127.0.0.1:8080/admin/ and change a client's configuration, our client adapts, and our dashboard updates automatically.</p>
<h2>Last words</h2><p>In the end our project looks like this:</p>

<div class="highlight-code"><div class="highlight"><pre>.
client.py
.crossbar
    config.json
db.sqlite3
django_app
    admin.py
    __init__.py
    models.py
    templates
        dashboard.html
    views.py
django_project
    __init__.py
    settings.py
    urls.py
    wsgi.py
static
manage.py
</pre></div>
</div>
<p>You can get the source code from the <a href="https://github.com/crossbario/crossbarexamples/tree/master/django/realtimemonitor">Crossbar.io examples repo</a>.</p>
<p>As you can see, we used very little WAMP code: a few lines for the JS part, and a few lines for the Python client. The only thing linking WAMP to Django is the Crossbar.io configuration which adds the HTTP pusher service and our POST request in <code>models.py</code>.</p>
<p>This solution is not limited to Django, and works well for all synchronous technologies unable to run WAMP clients directly. For now, the HTTP-WAMP bridge only allows publishes, not subscriptions or RPC. But having real time notifications available everywhere is already a nice touch, and the other actions will be implemented by the Crossbar.io team in the near future.</p>
<p>At moment you can already see that we can mix HTTP, WAMP, Python, clients, servers and build our own architecture to fit our needs. Crossbar.io can also serve the WSGI app, and actually could manage any WAMP client life cycle on the same machine, or if needed, any command line process (such as NodeJS).</p>
<p>We could have written the client in Python 3 since it's on other machines. In fact, if we run Django by itself (not using Crossbar.io), then Django can be coded using Pyton 3 too. Crossbar.io is the only bit still needing Python 2.7 (because Twisted doesn't run on Python 3 yet). Still, this is just a component which we configure and then forget about.</p>
<p>I tried this small system with several docker images running Python clients inside them and it's great to see the machines being added in real time. The immediate feedback you get by seeing any changes applied to the Django admin reflected on the page is also a nice touch.</p>

        </div>
        </div></body></html>