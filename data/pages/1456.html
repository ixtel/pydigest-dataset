<html><body><div><div class="article">
		<p>A presentation of various problems and an effective solution for pickling Python collections with non-built-in types as keys and cycles or self references. Applies to dictionaries, default dictionaries, ordered dictionaries, sets, and ordered sets, at all levels of the pickle and cPickle protocol, in Python 2 and 3. The entirety of the implementation is available as an open source package <a href="/software/python-restorable-collections/">python-restorable-collections</a>.</p>


<h3>Motivation</h3>

<p>In many object compositions in Python we effectively create pointer graphs because an object 'contained' in another object maintains a pointer back to its 'container'; the typical example being a node in a tree with pointers to its children which in turn have pointers back to the parent node. Sometimes an object may even point to itself, such as when modeling relations in a system which allows self-relations. Further still, sometimes nominal types (defined through a class) are better suited as keys in dictionaries or entries in sets rather than having to use only built-in types corresponding to the objects.</p>


<h3>Problem</h3>

<p>The hash value of an instance object is necessary for the object to be used in any data structure which <a href="https://docs.python.org/2/library/stdtypes.html#mapping-types-dict">looks up objects based on hashes</a>, including <code>dict</code>, <code>OrderedDict</code>, and <code>set</code>. Crucially, the hash value must never change after the object is used as a key, because Python's <a href="https://docs.python.org/2/faq/design.html#how-are-dictionaries-implemented">dictionary implementation</a> stores the hash value <a href="http://hg.python.org/cpython/file/52f68c95e025/Include/dictobject.h#l51">in a C structure</a> behind the scenes and will not update (rehash) this structure should <code>__hash__</code> return different values during the lifetime of the object.</p>

<p>In our example below, the implementation of the <code>__hash__</code> method relies on the value of a <code>name</code> field, however, during unpickling, the <code>__dict__</code> of the instance object - and hence the field <code>name</code> - will not be available until <code>__setstate__</code> has completed (either a custom version of this method defined in the class, or the <a href="https://docs.python.org/2/library/pickle.html#object.__setstate__">built-in behavior</a> which simply restores the instance object's pickled state as the object's <code>__dict__</code>). Our fallback will be to return the <a href="https://docs.python.org/2/glossary.html#term-hashable">default hash value</a> for non-built-in objects, namely their <code>id</code>. We cannot rely on <a href="https://docs.python.org/2/library/pickle.html#object.__getnewargs__">protocol 2</a> <code>__getnewargs__</code> either, because it will not have access to the state and is only used for supplying internal <em>invariant</em> data primarily useful for <code>__new__</code>.</p>

<p>When the unpickling algorithm needs to use an object as a key, therefore, it will invoke <code>__hash__</code> and internally store this value in the C structure implementing the lookup for the dictionary or set; usually, this will happen only after the instance object has already been restored via an invocation to <code>__setstate__</code> (or by default state restoration), because unpickling is <em>bottom-up</em>, in the sense that objects' states are restored prior to them being placed in other data structures.</p>

<p>However, there are a set of circumstances which make it impossible for the unpickling algorithm to restore the state prior to placing the object as a key in a dictionary or set: when the collection is an attribute of the very object being restored and the object itself is used as a key, or when two objects mutually form a reference cycle through their collection attributes. In these situations, the hash value (of at least one object) is needed prior to the collection attribute preparation.</p>



<h3>Discussion</h3>

<p>Obviously this inability to unpickle certain heap configurations is not a flaw in the language specification nor a bug in its implementation, although it could be argued that pickling and unpickling should always restore the same heap shape if that heap was valid in the first place. External resources, such as sockets and files, by nature represent state and must be manually restored or recreated. However, Python objects not associated with the aforementioned resources are stateless in the light of the never-changing hash value requirement, and should be fair game for automatic restoration irrespective of their pointer graph.</p>

<p>Furthermore, discussion of other dictionary issues such as <a href="http://bugs.python.org/issue1475692">1475692</a> and <a href="http://bugs.python.org/issue1761028">1761028</a> makes it abundantly clear that there are certain performance characteristics of the C structures involved which necessitate maintaining these implementation decisions, and since they have been carried over to Python 3 they are here to stay with us for a long time.</p>

<p>One way of automatically solving this problem would be for the unpickling algorithm to maintain a look-aside table of allocated objects whose hash value was required prior to their state being restored, and then internally rehashing all C structures which contain them. Naturally there would be a performance hit, but it would be one-off during unpickling, and may well be preferable to refactoring code so it uses only built-in keys and needs to perform translation from the built-in key value to the object of interest. Designing or proposing an update to the pickle protocol is beyond the scope of this article, but I believe is worthwhile of future consideration.</p>



<h3>Example</h3>

<p>Our example consists of a <code>World</code> in which <code>Wizard</code> instances cast <code>Spell</code> instances on each other in epic battles of magic and so on. Some wizards may chose to also cast protective spells on themselves, which means that the <code>caster</code> and the <code>target</code> of the spell can be the same object. Cast spells are recorded with each wizard, along with the order in which they were cast, in the <code>spells</code> dictionary which maps the spell's target to the instance of the spell.</p>

<p>This creates the possibility for a wizard to contain a dictionary with herself as the key. Finally, note that in order for a wizard to be usable as a key the class must implement <code>__hash__</code> which relies on the hash of the <code>name</code> string with a fall-back to <code>id</code>.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="k">class</span> <span class="nc">World</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span>     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno"> 6</span>         <span class="nb">super</span><span class="p">(</span><span class="n">World</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
<span class="lineno"> 7</span>         <span class="bp">self</span><span class="o">.</span><span class="n">wizards</span> <span class="o">=</span> <span class="p">[]</span>
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span> <span class="k">class</span> <span class="nc">Wizard</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="lineno">10</span> 
<span class="lineno">11</span>     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">world</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="lineno">12</span>         <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
<span class="lineno">13</span>         <span class="bp">self</span><span class="o">.</span><span class="n">spells</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
<span class="lineno">14</span>         <span class="n">world</span><span class="o">.</span><span class="n">wizards</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<span class="lineno">15</span> 
<span class="lineno">16</span>     <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno">17</span>         <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">'name'</span><span class="p">)</span> <span class="k">else</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<span class="lineno">18</span> 
<span class="lineno">19</span> <span class="k">class</span> <span class="nc">Spell</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="lineno">20</span> 
<span class="lineno">21</span>     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">caster</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="lineno">22</span>         <span class="nb">super</span><span class="p">(</span><span class="n">Spell</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
<span class="lineno">23</span>         <span class="bp">self</span><span class="o">.</span><span class="n">caster</span> <span class="o">=</span> <span class="n">caster</span>
<span class="lineno">24</span>         <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span>
<span class="lineno">25</span>         <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
<span class="lineno">26</span>         <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">caster</span><span class="o">.</span><span class="n">spells</span><span class="p">:</span>
<span class="lineno">27</span>             <span class="n">caster</span><span class="o">.</span><span class="n">spells</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="lineno">28</span>         <span class="n">caster</span><span class="o">.</span><span class="n">spells</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<span class="lineno">29</span> 
<span class="lineno">30</span>     <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno">31</span>         <span class="k">return</span> <span class="s">"""&lt;Spell {caster} : {target} : {name} ...&gt;"""</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<span class="lineno">32</span>             <span class="n">caster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caster</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></code></pre></div>

<h4>Testing Without Pickling</h4>

<p>The following execution works just fine and all tests pass. If most of these tests appear to be asserting the obvious, it is because they serve to demonstrate where the problem with unpickling lies.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="k">class</span> <span class="nc">MagicTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
<span class="lineno"> 2</span>     <span class="k">def</span> <span class="nf">test_without_pickling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno"> 3</span>         <span class="n">world</span> <span class="o">=</span> <span class="n">World</span><span class="p">()</span>
<span class="lineno"> 4</span>         <span class="n">wizard_merlin</span> <span class="o">=</span> <span class="n">Wizard</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="s">'Merlin'</span><span class="p">)</span>
<span class="lineno"> 5</span>         <span class="n">wizard_morgana</span> <span class="o">=</span> <span class="n">Wizard</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="s">'Morgana'</span><span class="p">)</span>
<span class="lineno"> 6</span>         <span class="n">spell_a</span> <span class="o">=</span> <span class="n">Spell</span><span class="p">(</span><span class="n">wizard_merlin</span><span class="p">,</span> <span class="n">wizard_morgana</span><span class="p">,</span> <span class="s">'magic-missile'</span><span class="p">)</span>
<span class="lineno"> 7</span>         <span class="n">spell_b</span> <span class="o">=</span> <span class="n">Spell</span><span class="p">(</span><span class="n">wizard_merlin</span><span class="p">,</span> <span class="n">wizard_merlin</span><span class="p">,</span> <span class="s">'stone-skin'</span><span class="p">)</span>
<span class="lineno"> 8</span>         <span class="n">spell_c</span> <span class="o">=</span> <span class="n">Spell</span><span class="p">(</span><span class="n">wizard_morgana</span><span class="p">,</span> <span class="n">wizard_merlin</span><span class="p">,</span> <span class="s">'geas'</span><span class="p">)</span>
<span class="lineno"> 9</span> 
<span class="lineno">10</span>         <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">wizard_merlin</span><span class="o">.</span><span class="n">spells</span><span class="p">[</span><span class="n">wizard_morgana</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">spell_a</span><span class="p">)</span>
<span class="lineno">11</span>         <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">wizard_merlin</span><span class="o">.</span><span class="n">spells</span><span class="p">[</span><span class="n">wizard_merlin</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">spell_b</span><span class="p">)</span>
<span class="lineno">12</span>         <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">wizard_morgana</span><span class="o">.</span><span class="n">spells</span><span class="p">[</span><span class="n">wizard_merlin</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">spell_c</span><span class="p">)</span>
<span class="lineno">13</span> 
<span class="lineno">14</span>         <span class="c"># Merlin has cast Magic Missile on Morgana, and Stone Skin on himself</span>
<span class="lineno">15</span>         <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">wizard_merlin</span><span class="o">.</span><span class="n">spells</span><span class="p">[</span><span class="n">wizard_morgana</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<span class="lineno">16</span>             <span class="s">'magic-missile'</span><span class="p">)</span>
<span class="lineno">17</span>         <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">wizard_merlin</span><span class="o">.</span><span class="n">spells</span><span class="p">[</span><span class="n">wizard_merlin</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<span class="lineno">18</span>             <span class="s">'stone-skin'</span><span class="p">)</span>
<span class="lineno">19</span> 
<span class="lineno">20</span>         <span class="c"># Morgana has cast Geas on Merlin</span>
<span class="lineno">21</span>         <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">wizard_morgana</span><span class="o">.</span><span class="n">spells</span><span class="p">[</span><span class="n">wizard_merlin</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">'geas'</span><span class="p">)</span>
<span class="lineno">22</span> 
<span class="lineno">23</span>         <span class="c"># Merlin's first target was Morgana</span>
<span class="lineno">24</span>         <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">wizard_merlin</span><span class="o">.</span><span class="n">spells</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">wizard_merlin</span><span class="o">.</span><span class="n">spells</span><span class="p">)</span>
<span class="lineno">25</span>         <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">wizard_merlin</span><span class="o">.</span><span class="n">spells</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">wizard_morgana</span><span class="p">)</span>
<span class="lineno">26</span> 
<span class="lineno">27</span>         <span class="c"># Merlin's second target was himself</span>
<span class="lineno">28</span>         <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">wizard_merlin</span><span class="o">.</span><span class="n">spells</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">wizard_merlin</span><span class="o">.</span><span class="n">spells</span><span class="p">)</span>
<span class="lineno">29</span>         <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">wizard_merlin</span><span class="o">.</span><span class="n">spells</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">wizard_merlin</span><span class="p">)</span>
<span class="lineno">30</span> 
<span class="lineno">31</span>         <span class="c"># Morgana's first target was Merlin</span>
<span class="lineno">32</span>         <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">wizard_morgana</span><span class="o">.</span><span class="n">spells</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">wizard_morgana</span><span class="o">.</span><span class="n">spells</span><span class="p">)</span>
<span class="lineno">33</span>         <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">wizard_morgana</span><span class="o">.</span><span class="n">spells</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">wizard_merlin</span><span class="p">)</span>
<span class="lineno">34</span> 
<span class="lineno">35</span>         <span class="c"># Merlin's first spell cast with himself as target is in the dictionary,</span>
<span class="lineno">36</span>         <span class="c"># first by looking up directly with Merlin's instance object...</span>
<span class="lineno">37</span>         <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">wizard_merlin</span><span class="p">,</span>
<span class="lineno">38</span>             <span class="n">wizard_merlin</span><span class="o">.</span><span class="n">spells</span><span class="p">[</span><span class="n">wizard_merlin</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
<span class="lineno">39</span> 
<span class="lineno">40</span>         <span class="c"># ...and then with the instance object directly from the dictionary keys</span>
<span class="lineno">41</span>         <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">wizard_merlin</span><span class="p">,</span>
<span class="lineno">42</span>             <span class="n">wizard_merlin</span><span class="o">.</span><span class="n">spells</span><span class="p">[</span><span class="n">wizard_merlin</span><span class="o">.</span><span class="n">spells</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
<span class="lineno">43</span> 
<span class="lineno">44</span>         <span class="c"># Ensure Merlin's object is unique...</span>
<span class="lineno">45</span>         <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">wizard_merlin</span><span class="p">),</span> <span class="nb">id</span><span class="p">(</span><span class="n">wizard_merlin</span><span class="o">.</span><span class="n">spells</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span>
<span class="lineno">46</span> 
<span class="lineno">47</span>         <span class="c"># ...and consistently hashed</span>
<span class="lineno">48</span>         <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="n">wizard_merlin</span><span class="p">),</span>
<span class="lineno">49</span>             <span class="nb">hash</span><span class="p">(</span><span class="n">wizard_merlin</span><span class="o">.</span><span class="n">spells</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span></code></pre></div>


<h4>Testing With Pickling</h4>

<p>Now we pickle the world and extract the same object references from the unpickled version of the world. Several of the tests fail (marked with a strike through below), specifically all those which use Merlin as a key, including when his object is obtained directly from the <code>keys</code> method of the dictionary. If you want to run the successful tests, then you'll have to remove or comment out the ones which fail.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="k">class</span> <span class="nc">MagicTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
<span class="lineno"> 2</span> 	<span class="k">def</span> <span class="nf">test_with_pickling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno"> 3</span>         <span class="n">world</span> <span class="o">=</span> <span class="n">World</span><span class="p">()</span>
<span class="lineno"> 4</span>         <span class="n">wizard_merlin</span> <span class="o">=</span> <span class="n">Wizard</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="s">'Merlin'</span><span class="p">)</span>
<span class="lineno"> 5</span>         <span class="n">wizard_morgana</span> <span class="o">=</span> <span class="n">Wizard</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="s">'Morgana'</span><span class="p">)</span>
<span class="lineno"> 6</span>         <span class="n">spell_a</span> <span class="o">=</span> <span class="n">Spell</span><span class="p">(</span><span class="n">wizard_merlin</span><span class="p">,</span> <span class="n">wizard_morgana</span><span class="p">,</span> <span class="s">'magic-missile'</span><span class="p">)</span>
<span class="lineno"> 7</span>         <span class="n">spell_b</span> <span class="o">=</span> <span class="n">Spell</span><span class="p">(</span><span class="n">wizard_merlin</span><span class="p">,</span> <span class="n">wizard_merlin</span><span class="p">,</span> <span class="s">'stone-skin'</span><span class="p">)</span>
<span class="lineno"> 8</span>         <span class="n">spell_c</span> <span class="o">=</span> <span class="n">Spell</span><span class="p">(</span><span class="n">wizard_morgana</span><span class="p">,</span> <span class="n">wizard_merlin</span><span class="p">,</span> <span class="s">'geas'</span><span class="p">)</span>
<span class="lineno"> 9</span> 
<span class="lineno">10</span>         <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">wizard_merlin</span><span class="o">.</span><span class="n">spells</span><span class="p">[</span><span class="n">wizard_morgana</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">spell_a</span><span class="p">)</span>
<span class="lineno">11</span>         <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">wizard_merlin</span><span class="o">.</span><span class="n">spells</span><span class="p">[</span><span class="n">wizard_merlin</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">spell_b</span><span class="p">)</span>
<span class="lineno">12</span>         <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">wizard_morgana</span><span class="o">.</span><span class="n">spells</span><span class="p">[</span><span class="n">wizard_merlin</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">spell_c</span><span class="p">)</span>
<span class="lineno">13</span>         <span class="n">_world</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">world</span><span class="p">)</span>
<span class="lineno">14</span>         <span class="n">u_world</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">_world</span><span class="p">)</span>
<span class="lineno">15</span>         <span class="n">u_wizard_merlin</span> <span class="o">=</span> <span class="n">u_world</span><span class="o">.</span><span class="n">wizards</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="lineno">16</span>         <span class="n">u_wizard_morgana</span> <span class="o">=</span> <span class="n">u_world</span><span class="o">.</span><span class="n">wizards</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="lineno">17</span> 
<span class="lineno">18</span>         <span class="c"># Merlin has cast Magic Missile on Morgana, and Stone Skin on himself</span>
<span class="lineno">19</span>         <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">u_wizard_merlin</span><span class="o">.</span><span class="n">spells</span><span class="p">[</span><span class="n">u_wizard_morgana</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<span class="lineno">20</span>             <span class="s">'magic-missile'</span><span class="p">)</span>
<span class="lineno">21</span> <span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">u_wizard_merlin</span><span class="o">.</span><span class="n">spells</span><span class="p">[</span><span class="n">u_wizard_merlin</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span class="lineno">22</span> <span class="hll">            <span class="s">'stone-skin'</span><span class="p">)</span>
</span><span class="lineno">23</span> 
<span class="lineno">24</span>         <span class="c"># Morgana has cast Geas on Merlin</span>
<span class="lineno">25</span> <span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">u_wizard_morgana</span><span class="o">.</span><span class="n">spells</span><span class="p">[</span><span class="n">u_wizard_merlin</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span class="lineno">26</span> <span class="hll">            <span class="s">'geas'</span><span class="p">)</span>
</span><span class="lineno">27</span> 
<span class="lineno">28</span>         <span class="c"># Merlin's first target was Morgana</span>
<span class="lineno">29</span>         <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
<span class="lineno">30</span>             <span class="n">u_wizard_merlin</span><span class="o">.</span><span class="n">spells</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">u_wizard_merlin</span><span class="o">.</span><span class="n">spells</span><span class="p">)</span>
<span class="lineno">31</span>         <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">u_wizard_merlin</span><span class="o">.</span><span class="n">spells</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">u_wizard_morgana</span><span class="p">)</span>
<span class="lineno">32</span> 
<span class="lineno">33</span>         <span class="c"># Merlin's second target was himself</span>
<span class="lineno">34</span> <span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
</span><span class="lineno">35</span> <span class="hll">            <span class="n">u_wizard_merlin</span><span class="o">.</span><span class="n">spells</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">u_wizard_merlin</span><span class="o">.</span><span class="n">spells</span><span class="p">)</span>
</span><span class="lineno">36</span>         <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">u_wizard_merlin</span><span class="o">.</span><span class="n">spells</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">u_wizard_merlin</span><span class="p">)</span>
<span class="lineno">37</span> 
<span class="lineno">38</span>         <span class="c"># Morgana's first target was Merlin</span>
<span class="lineno">39</span> <span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
</span><span class="lineno">40</span> <span class="hll">            <span class="n">u_wizard_morgana</span><span class="o">.</span><span class="n">spells</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">u_wizard_morgana</span><span class="o">.</span><span class="n">spells</span><span class="p">)</span>
</span><span class="lineno">41</span>         <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">u_wizard_morgana</span><span class="o">.</span><span class="n">spells</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">u_wizard_merlin</span><span class="p">)</span>
<span class="lineno">42</span> 
<span class="lineno">43</span>         <span class="c"># Merlin's first spell cast with himself as target is in the dictionary,</span>
<span class="lineno">44</span>         <span class="c"># first by looking up directly with Merlin's instance object...</span>
<span class="lineno">45</span> <span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">u_wizard_merlin</span><span class="p">,</span>
</span><span class="lineno">46</span> <span class="hll">            <span class="n">u_wizard_merlin</span><span class="o">.</span><span class="n">spells</span><span class="p">[</span><span class="n">u_wizard_merlin</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
</span><span class="lineno">47</span> 
<span class="lineno">48</span>         <span class="c"># ...and then with the instance object directly from the dictionary keys</span>
<span class="lineno">49</span> <span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">u_wizard_merlin</span><span class="p">,</span>
</span><span class="lineno">50</span> <span class="hll">            <span class="n">u_wizard_merlin</span><span class="o">.</span><span class="n">spells</span><span class="p">[</span><span class="n">u_wizard_merlin</span><span class="o">.</span><span class="n">spells</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
</span><span class="lineno">51</span> 
<span class="lineno">52</span>         <span class="c"># Ensure Merlin's object is unique...</span>
<span class="lineno">53</span>         <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">u_wizard_merlin</span><span class="p">),</span>
<span class="lineno">54</span>             <span class="nb">id</span><span class="p">(</span><span class="n">u_wizard_merlin</span><span class="o">.</span><span class="n">spells</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span>
<span class="lineno">55</span> 
<span class="lineno">56</span>         <span class="c"># ...and consistently hashed</span>
<span class="lineno">57</span>         <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="n">u_wizard_merlin</span><span class="p">),</span>
<span class="lineno">58</span>             <span class="nb">hash</span><span class="p">(</span><span class="n">u_wizard_merlin</span><span class="o">.</span><span class="n">spells</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span></code></pre></div>

<p>The third from last assertion on lines 49-50, which fails as below, is the crux of our problem. The last two assertions, which compare the identities and hashes of the objects, tell us that in fact both <code>u_wizard_merlin</code> and <code>u_wizard_merlin.spells.keys()[1]</code> are the same object. Since Merlin has cast a spell on himself, he has formed a (trivial) pointer cycle. Wizards.</p>

<pre>
Error
Traceback (most recent call last):
  File "....py", line ..., in test_with_pickling
    u_wizard_merlin.spells[u_wizard_merlin.spells.keys()[1]][0].target)
KeyError: Merlin
</pre>

<h3>Solution</h3>

<p>Below I present one solution to this problem via means of automatically restoring dictionary or set keys after unpickling; for clarity I have not inherited directly from the built-in types (e.g. <code>dict</code>, <code>set</code>, and so on), rather, I have <em>wrapped</em> the underlying structures and provided interfaces conforming with the <a href="https://docs.python.org/2/library/collections.html#collections-abstract-base-classes">Collections Abstract Base Classes</a>. Design issues such as <a href="http://bugs.python.org/issue4712">4712</a> and <a href="http://bugs.python.org/issue826897">26897</a> mean that the workarounds required for directly sub-classing <code>dict</code> and maintaining pickle behavior make the outcome ridiculously fragile and error-prone.</p>

<p>We may be tempted to restore the contents of a collection in <code>__setattr__</code>, however, this would not work: there may be keys in our collection  which have not been restored by the unpickling yet, and their hash value may change after we perform the restoration. Therefore, we must perform the restoration after the unpickling algorithm has finished with all objects.</p>

<p>There are two ways of restoring collections after unpickling: either we keep track of which collections need restoration and restore them after unpickling, or we mark all such collections and intercept attribute access to their wrapped contents the first time they are accessed, restoring them as needed. I have chosen the latter strategy because it does not require a separate unpickling step nor a tracking structure, and because it is <em>lazy</em> in the sense that a collection will be restored only at the point of time it is used. Of course, the restoration logic can easily be extracted and invoked <em>eagerly</em> at any time after unpickling and prior to use.</p>

<h4>Abstract Restorable</h4>

<p>This mix-in type is responsible for maintaining the restoration requirement marking of a collection, as well as intercepting access to the wrapped <code>_contents</code> attribute and delegating to the concrete restoration method <code>_restore</code>. This restoration method is expected to be handed the entirety of the information it needs from the <code>_restoration_data</code> attribute, which must be made available by the subclass <code>__setstate__</code> method. Typically, the subclass <code>__getstate__</code> generates this information which is given to <code>__setstate__</code> during unpickling.</p>

<p>The <code>__setstate__</code> method, other than performing the default object state setting on <code>__dict__</code>, marks the object as requiring restoration. Note that <code>__init__</code> uses the <code>False</code> mark, because restoration is necessary only for unpickled objects.</p>

<p>If you inherit this class and override <code>__setstate__</code> then you will have to ensure that the <code>_requires_restoration</code> marker is set to <code>True</code>. Furthermore, note that <code>_restore</code> is likely to access the object and the wrapped collection, so in order to avoid indefinite recursion we must set the market to <code>False</code> before delegating to <code>_restore</code>. Finally, the <code>_restoration_data</code> attribute is removed after restoration so no pointers remain to keys which may later be removed as part of normal collection use.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="k">class</span> <span class="nc">Restorable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span>     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno"> 4</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_requires_restoration</span> <span class="o">=</span> <span class="bp">False</span>
<span class="lineno"> 5</span> 
<span class="lineno"> 6</span>     <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="lineno"> 7</span>         <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span> <span class="o">=</span> <span class="n">state</span>
<span class="lineno"> 8</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_requires_restoration</span> <span class="o">=</span> <span class="bp">True</span>
<span class="lineno"> 9</span> 
<span class="lineno">10</span>     <span class="k">def</span> <span class="nf">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
<span class="lineno">11</span>         <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="s">'_contents'</span><span class="p">:</span>
<span class="lineno">12</span>             <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_requires_restoration</span><span class="p">:</span>
<span class="lineno">13</span>                 <span class="bp">self</span><span class="o">.</span><span class="n">_requires_restoration</span> <span class="o">=</span> <span class="bp">False</span>
<span class="lineno">14</span>                 <span class="bp">self</span><span class="o">.</span><span class="n">_restore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_restoration_data</span><span class="p">)</span>
<span class="lineno">15</span>                 <span class="bp">self</span><span class="o">.</span><span class="n">_restoration_data</span> <span class="o">=</span> <span class="bp">None</span>
<span class="lineno">16</span>         <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
<span class="lineno">17</span> 
<span class="lineno">18</span>     <span class="k">def</span> <span class="nf">_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">restoration_data</span><span class="p">):</span>
<span class="lineno">19</span>         <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
<span class="lineno">20</span>             <span class="s">"you must specify the _restore method with the Restorable type"</span><span class="p">)</span></code></pre></div>


<h4>Restorable Dictionary</h4>

<p>We wrap a normal <code>dict</code> constructed by passing our arguments directly to it, inherit from <code>Restorable</code> and implement the <code>__getstate__</code>, <code>__setstate__</code>, and <code>_restore</code> methods, as well as provide an interface to the wrapped dictionary via means of <code>MutableMapping</code>. Our restoration method simply updates the wrapped dictionary with the keys and values from the restoration data. Since unpickling is finished, the keys will now be placed in the dictionary's C structure with their correct hash value.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">MutableMapping</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="k">class</span> <span class="nc">RestorableDict</span><span class="p">(</span><span class="n">MutableMapping</span><span class="p">,</span> <span class="n">Restorable</span><span class="p">,</span> <span class="nb">object</span><span class="p">):</span>
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span>     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="lineno"> 6</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_contents</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="lineno"> 7</span>         <span class="n">Restorable</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span>     <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno">10</span>         <span class="k">return</span> <span class="p">[</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contents</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span> <span class="p">]</span>
<span class="lineno">11</span> 
<span class="lineno">12</span>     <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="lineno">13</span>         <span class="n">Restorable</span><span class="o">.</span><span class="n">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">{</span>
<span class="lineno">14</span>             <span class="s">'_contents'</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">(),</span>
<span class="lineno">15</span>             <span class="s">'_restoration_data'</span> <span class="p">:</span> <span class="n">state</span><span class="p">,</span>
<span class="lineno">16</span>         <span class="p">})</span>
<span class="lineno">17</span> 
<span class="lineno">18</span>     <span class="k">def</span> <span class="nf">_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">restoration_data</span><span class="p">):</span>
<span class="lineno">19</span>         <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">restoration_data</span><span class="p">:</span>
<span class="lineno">20</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_contents</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<span class="lineno">21</span> 
<span class="lineno">22</span>     <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
<span class="lineno">23</span>         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contents</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
<span class="lineno">24</span> 
<span class="lineno">25</span>     <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="lineno">26</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_contents</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<span class="lineno">27</span> 
<span class="lineno">28</span>     <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="lineno">29</span>         <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contents</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
<span class="lineno">30</span> 
<span class="lineno">31</span>     <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno">32</span>         <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_contents</span><span class="p">)</span>
<span class="lineno">33</span> 
<span class="lineno">34</span>     <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno">35</span>         <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_contents</span><span class="p">)</span>
<span class="lineno">36</span> 
<span class="lineno">37</span>     <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno">38</span>         <span class="k">return</span> <span class="s">"""RestorableDict{}"""</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_contents</span><span class="p">))</span></code></pre></div>


<h4>Restorable Default Dictionary</h4>

<p>Now that we have a restorable dictionary, we can extend it in order to support <code>defaultdict</code>. We need only override the state-related methods, since we must now also persist the <code>default_factory</code> attribute.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="k">class</span> <span class="nc">RestorableDefaultDict</span><span class="p">(</span><span class="n">RestorableDict</span><span class="p">,</span> <span class="nb">object</span><span class="p">):</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span>     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="lineno"> 4</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_contents</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="lineno"> 5</span>         <span class="n">Restorable</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span>     <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno"> 8</span>         <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_contents</span><span class="o">.</span><span class="n">default_factory</span><span class="p">,</span>
<span class="lineno"> 9</span>             <span class="p">[</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contents</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span> <span class="p">])</span>
<span class="lineno">10</span> 
<span class="lineno">11</span>     <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="lineno">12</span>         <span class="n">Restorable</span><span class="o">.</span><span class="n">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">{</span>
<span class="lineno">13</span>             <span class="s">'_contents'</span> <span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
<span class="lineno">14</span>             <span class="s">'_restoration_data'</span> <span class="p">:</span> <span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
<span class="lineno">15</span>         <span class="p">})</span></code></pre></div>

<h4>Restorable Ordered Dictionary</h4>

<p>Other than setting <code>_contents</code> to be an <code>OrderedDict</code>, we don't need to do anything else because the <code>RestorableDict</code> restoration follows the order of <code>iteritems</code>, which ensures proper ordering in our case.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="k">class</span> <span class="nc">RestorableOrderedDict</span><span class="p">(</span><span class="n">RestorableDict</span><span class="p">,</span> <span class="nb">object</span><span class="p">):</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span>     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="lineno"> 4</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_contents</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="lineno"> 5</span>         <span class="n">Restorable</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span>     <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="lineno"> 8</span>         <span class="n">Restorable</span><span class="o">.</span><span class="n">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">{</span>
<span class="lineno"> 9</span>             <span class="s">'_contents'</span> <span class="p">:</span> <span class="n">OrderedDict</span><span class="p">(),</span>
<span class="lineno">10</span>             <span class="s">'_restoration_data'</span> <span class="p">:</span> <span class="n">state</span><span class="p">,</span>
<span class="lineno">11</span>         <span class="p">})</span></code></pre></div>


<h4>Restorable Set</h4>

<p>Finally, for <code>set</code>, things are even simpler, as the <code>_restoration_data</code> consist of all elements of the set, and are used to directly update the set in <code>_restore</code>.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="k">class</span> <span class="nc">RestorableSet</span><span class="p">(</span><span class="n">MutableSet</span><span class="p">,</span> <span class="n">Restorable</span><span class="p">,</span> <span class="nb">object</span><span class="p">):</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span>     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="lineno"> 4</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_contents</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="lineno"> 5</span>         <span class="n">Restorable</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span>     <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno"> 8</span>         <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_contents</span><span class="p">)</span>
<span class="lineno"> 9</span> 
<span class="lineno">10</span>     <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="lineno">11</span>         <span class="n">Restorable</span><span class="o">.</span><span class="n">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">{</span>
<span class="lineno">12</span>             <span class="s">'_contents'</span> <span class="p">:</span> <span class="nb">set</span><span class="p">(),</span>
<span class="lineno">13</span>             <span class="s">'_restoration_data'</span> <span class="p">:</span> <span class="n">state</span><span class="p">,</span>
<span class="lineno">14</span>         <span class="p">})</span>
<span class="lineno">15</span> 
<span class="lineno">16</span>     <span class="k">def</span> <span class="nf">_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">restoration_data</span><span class="p">):</span>
<span class="lineno">17</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_contents</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">restoration_data</span><span class="p">)</span>
<span class="lineno">18</span> 
<span class="lineno">19</span>     <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="lineno">20</span>         <span class="k">return</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contents</span>
<span class="lineno">21</span> 
<span class="lineno">22</span>     <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno">23</span>         <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_contents</span><span class="p">)</span>
<span class="lineno">24</span> 
<span class="lineno">25</span>     <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno">26</span>         <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_contents</span><span class="p">)</span>
<span class="lineno">27</span> 
<span class="lineno">28</span>     <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="lineno">29</span>         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contents</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="lineno">30</span> 
<span class="lineno">31</span>     <span class="k">def</span> <span class="nf">discard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="lineno">32</span>         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contents</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="lineno">33</span> 
<span class="lineno">34</span>     <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno">35</span>         <span class="k">return</span> <span class="s">"""RestorableSet{}"""</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_contents</span><span class="p">))</span></code></pre></div>


<h3>Conclusion</h3>

<p>We've worked around an inherent limitation of Python's pickle protocol at the cost of more complexity as well as a performance hit. Specifically, we must now maintain restorable versions of collections, as well as accept a slow-down of unpickling and access to the wrapped collection.</p>

<p>In terms of performance, both slow-downs are a constant on top of their respective operations, and should not be prohibitive for small collections. If the collections involved are large and have many cyclic structures, then perhaps the question no longer is whether we can pickle effectively but whether we should be using pickled data or Python at all. Perhaps a dedicated graph database and query language are better suited.</p>

<p>With respect to maintenance complexity, it is highly likely that a lot of code will not accept these restorable collections if it makes any kind of type checking using <code>dict</code> or <code>set</code> instead of, respectively, <code>Mapping</code> and <code>Set</code>; this is a more general issue with the appropriate use of Python's Collection Abstract Base Classes rather than our particular workaround.</p>



<h3>Acknowledgments</h3>

<p>Gratitude to <a href="http://www.niarchou.org/">Dr Anastasia Niarchou</a> for her feedback.</p>





		</div>
		</div></body></html>