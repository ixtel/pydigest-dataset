<html><body><div><div class="entry-content clearfix">







<p>When I was new to Django, one of the most frustrating things I experienced was the need to run a bit of code periodically. I wrote a nice function that performed an action that needed to run daily at 12am. Easy, right? Wrong. This turned out to be a huge problem to me since at the time I was used to “<a href="http://en.wikipedia.org/wiki/Web_hosting_control_panel">Cpanel</a>-type” web hosting where there was a nice handy GUI for setting up cron jobs for this very purpose.</p>

<p>After much research, I found a nice solution – <a href="http://www.celeryproject.org/">Celery</a>, a powerful asynchronous job queue used for running tasks in the background. But this led to additional problems, since I couldn’t find an easy set of instructions to integrate Celery into a Django Project.</p>

<p>Of course I eventually did manage to figure it – which is what this article will cover: <strong>How to integrate Celery into a Django Project and create Periodic Tasks.</strong></p>

<blockquote><p>This project utilizes Python <a href="https://www.python.org/download/releases/3.4.0/">3.4</a>, Django <a href="https://docs.djangoproject.com/en/1.8/releases/1.8.2/">1.8.2</a>, Celery <a href="http://celery.readthedocs.org/en/latest/changelog.html">3.1.18</a>, and Redis <a href="https://raw.githubusercontent.com/antirez/redis/3.0/00-RELEASENOTES">3.0.2</a>.</p></blockquote>

<a name="Overview"/>
<h2>Overview</h2>

<p>For your convenience, since this is such a large post, please refer back to this table for brief info on each step and to grab the associated code.</p>

<table>
<thead>
<tr>
<th/>
<th> Step              </th>
<th> Overview                      </th>
<th> Git Tag                                                   </th>
</tr>
</thead>
<tbody>
<tr>
<td/>
<td> Boilerplate       </td>
<td> Download boilerplate          </td>
<td> <a href="https://github.com/realpython/Picha/releases/tag/v1">v1</a></td>
</tr>
<tr>
<td/>
<td> Setup             </td>
<td> Integrate Celery with Django  </td>
<td> <a href="https://github.com/realpython/Picha/releases/tag/v2">v2</a></td>
</tr>
<tr>
<td/>
<td> Celery Tasks      </td>
<td> Add basic Celery Task         </td>
<td> <a href="https://github.com/realpython/Picha/releases/tag/v3">v3</a></td>
</tr>
<tr>
<td/>
<td> Periodic Tasks    </td>
<td> Add Periodic Task             </td>
<td> <a href="https://github.com/realpython/Picha/releases/tag/v4">v4</a></td>
</tr>
<tr>
<td/>
<td> Running Locally   </td>
<td> Run our app locally           </td>
<td> <a href="https://github.com/realpython/Picha/releases/tag/v5">v5</a></td>
</tr>
<tr>
<td/>
<td> Running Remotely  </td>
<td> Run our app remotely          </td>
<td> <a href="https://github.com/realpython/Picha/releases/tag/v5">v5</a></td>
</tr>
</tbody>
</table>


<a name="What.is.Celery."/>
<h2>What is Celery?</h2>

<p>“<a href="http://www.celeryproject.org/">Celery</a> is an asynchronous task queue/job queue based on distributed message passing. It is focused on real-time operation, but supports scheduling as well.” For this post, we will focus on the scheduling feature to periodically run a job/task.</p>

<p><strong>Why is this useful?</strong></p>

<ul>
<li>Think of all the times you have had to run a certain task in the future. Perhaps you needed to access an API every hour. Or maybe you needed to send a batch of emails at the end of the day. Large or small, Celery makes scheduling such periodic tasks easy.</li>
<li>You never want end users to have to wait unnecessarily for pages to load or actions to complete. If a long process is part of your application’s workflow, you can use Celery to execute that process in the background, as resources become available, so that your application can continue to respond to client requests. This keeps the task out of the application’s context.</li>
</ul>


<a name="Setup"/>
<h2>Setup</h2>

<p>Before diving into Celery, grab the starter project from the Github <a href="https://github.com/realpython/Picha/releases/tag/v1">repo</a>. Make sure to activate a virtualenv, install the requirements, and run the migrations. Then fire up the server and navigate to <a href="http://localhost:8000/">http://localhost:8000/</a> in your browser. You should see the familiar “Congratulations on your first Django-powered page” text. When done, kill the sever.</p>

<p>Next, let’s install Celery:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>pip install <span class="nv">celery</span><span class="o">==</span>3.1.18
</span><span class="line"><span class="nv">$ </span>pip freeze &gt; requirements.txt
</span></code></pre></td></tr></table></div></figure>


<p>Now we can integrate Celery into our Django Project in just three easy steps.</p>

<a name="Step.1:.Add..em.celery.py..em."/>
<h3>Step 1: Add <em>celery.py</em></h3>

<p>Inside the “picha” directory, create a new file called <em>celery.py</em>:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">os</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
</span><span class="line">
</span><span class="line"><span class="c"># set the default Django settings module for the 'celery' program.</span>
</span><span class="line"><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">'DJANGO_SETTINGS_MODULE'</span><span class="p">,</span> <span class="s">'picha.settings'</span><span class="p">)</span>
</span><span class="line"><span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s">'picha'</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="c"># Using a string here means the worker will not have to</span>
</span><span class="line"><span class="c"># pickle the object when using Windows.</span>
</span><span class="line"><span class="n">app</span><span class="o">.</span><span class="n">config_from_object</span><span class="p">(</span><span class="s">'django.conf:settings'</span><span class="p">)</span>
</span><span class="line"><span class="n">app</span><span class="o">.</span><span class="n">autodiscover_tasks</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">INSTALLED_APPS</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="nd">@app.task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class="line"><span class="k">def</span> <span class="nf">debug_task</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">    <span class="k">print</span><span class="p">(</span><span class="s">'Request: {0!r}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Take note of the comments in the code.</p>

<a name="Step.2:.Import.your.new.Celery.app"/>
<h3>Step 2: Import your new Celery app</h3>

<p>To ensure that the Celery app is loaded when Django starts, add the following code into the <em>__init__.py</em> file that sits next to your <em>settings.py</em> file:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
</span><span class="line">
</span><span class="line"><span class="c"># This will make sure the app is always imported when</span>
</span><span class="line"><span class="c"># Django starts so that shared_task will use this app.</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">.celery</span> <span class="kn">import</span> <span class="n">app</span> <span class="k">as</span> <span class="n">celery_app</span>
</span></code></pre></td></tr></table></div></figure>


<p>Having done that, your project layout should now look like:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line">├── manage.py
</span><span class="line">├── picha
</span><span class="line">│   ├── __init__.py
</span><span class="line">│   ├── celery.py
</span><span class="line">│   ├── settings.py
</span><span class="line">│   ├── urls.py
</span><span class="line">│   └── wsgi.py
</span><span class="line">└── requirements.txt
</span></code></pre></td></tr></table></div></figure>


<a name="Step.3:.Install.Redis.as.a.Celery..Broker."/>
<h3>Step 3: Install Redis as a Celery “Broker”</h3>

<p>Celery uses “<a href="http://celery.readthedocs.org/en/latest/getting-started/brokers/">brokers</a>” to pass messages between a Django Project and the Celery <a href="http://celery.readthedocs.org/en/latest/userguide/workers.html">workers</a>. In this tutorial, we will use <a href="http://celery.readthedocs.org/en/latest/getting-started/brokers/redis.html">Redis</a> as the message broker.</p>

<p>First, install <a href="http://redis.io/">Redis</a> from the official download <a href="http://redis.io/download">page</a> or via brew (<code>brew install redis</code>) and then turn to your terminal, in a new terminal window, fire up the server:</p>

<figure class="code"><figcaption><span/></figcaption></figure>


<p>You can test that Redis is working properly by typing this into your terminal:</p>

<figure class="code"><figcaption><span/></figcaption></figure>


<p>Redis should reply with <code>PONG</code> – try it!</p>

<p>Once Redis is up, add the following code to your settings.py file:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c"># CELERY STUFF</span>
</span><span class="line"><span class="n">BROKER_URL</span> <span class="o">=</span> <span class="s">'redis://localhost:6379'</span>
</span><span class="line"><span class="n">CELERY_RESULT_BACKEND</span> <span class="o">=</span> <span class="s">'redis://localhost:6379'</span>
</span><span class="line"><span class="n">CELERY_ACCEPT_CONTENT</span> <span class="o">=</span> <span class="p">[</span><span class="s">'application/json'</span><span class="p">]</span>
</span><span class="line"><span class="n">CELERY_TASK_SERIALIZER</span> <span class="o">=</span> <span class="s">'json'</span>
</span><span class="line"><span class="n">CELERY_RESULT_SERIALIZER</span> <span class="o">=</span> <span class="s">'json'</span>
</span><span class="line"><span class="n">CELERY_TIMEZONE</span> <span class="o">=</span> <span class="s">'Africa/Nairobi'</span>
</span></code></pre></td></tr></table></div></figure>


<p>You also need to add Redis as a dependency in the Django Project:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>pip install <span class="nv">redis</span><span class="o">==</span>2.10.3
</span><span class="line"><span class="nv">$ </span>pip freeze &gt; requirements.txt
</span></code></pre></td></tr></table></div></figure>


<p>That’s it! You should now be able to use Celery with Django. For more information on setting up Celery with Django, please check out the official Celery <a href="http://docs.celeryproject.org/en/latest/django/first-steps-with-django.html#using-celery-with-django">documentation</a>.</p>

<p>Before moving on, let’s run a few sanity checks to ensure all is well…</p>

<p>Test that the Celery worker is ready to receive tasks:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>celery -A picha worker -l info
</span><span class="line">...
</span><span class="line"><span class="o">[</span>2015-07-07 14:07:07,398: INFO/MainProcess<span class="o">]</span> Connected to redis://localhost:6379//
</span><span class="line"><span class="o">[</span>2015-07-07 14:07:07,410: INFO/MainProcess<span class="o">]</span> mingle: searching <span class="k">for </span>neighbors
</span><span class="line"><span class="o">[</span>2015-07-07 14:07:08,419: INFO/MainProcess<span class="o">]</span> mingle: all alone
</span></code></pre></td></tr></table></div></figure>


<p>Kill the process with CTRL-C. Now, test that the Celery task scheduler is ready for action:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>celery -A picha beat -l info
</span><span class="line">...
</span><span class="line"><span class="o">[</span>2015-07-07 14:08:23,054: INFO/MainProcess<span class="o">]</span> beat: Starting...
</span></code></pre></td></tr></table></div></figure>


<p>Boom!</p>

<p>Again, kill the process when done.</p>

<a name="Celery.Tasks"/>
<h2>Celery Tasks</h2>

<p>Celery utilizes <a href="http://celery.readthedocs.org/en/latest/userguide/tasks.html">tasks</a>, which can be thought of as regular Python functions that are called with Celery.</p>

<p>For example, let’s turn this basic function into a Celery task:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span><span class="line">    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</span></code></pre></td></tr></table></div></figure>


<p>First, add a decorator:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">celery.decorators</span> <span class="kn">import</span> <span class="n">task</span>
</span><span class="line">
</span><span class="line"><span class="nd">@task</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">"sum_two_numbers"</span><span class="p">)</span>
</span><span class="line"><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span><span class="line">    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then you can run this task asynchronously with Celery like so:</p>

<figure class="code"><figcaption><span/></figcaption></figure>


<p>Simple, right?</p>

<p>So, these types of tasks are perfect for when you want to load a web page without making the user wait for some background process to complete.</p>

<p>Let’s look at an example…</p>

<hr/>


<p>Going back to the Django Project, grab version <a href="https://github.com/realpython/Picha/releases/tag/v3">three</a>, which includes an app that accepts feedback from users, aptly called <code>feedback</code>:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line">├── feedback
</span><span class="line">│   ├── __init__.py
</span><span class="line">│   ├── admin.py
</span><span class="line">│   ├── emails.py
</span><span class="line">│   ├── forms.py
</span><span class="line">│   ├── models.py
</span><span class="line">│   ├── tests.py
</span><span class="line">│   └── views.py
</span><span class="line">├── manage.py
</span><span class="line">├── picha
</span><span class="line">│   ├── __init__.py
</span><span class="line">│   ├── celery.py
</span><span class="line">│   ├── settings.py
</span><span class="line">│   ├── urls.py
</span><span class="line">│   └── wsgi.py
</span><span class="line">├── requirements.txt
</span><span class="line">└── templates
</span><span class="line">    ├── base.html
</span><span class="line">    └── feedback
</span><span class="line">        ├── contact.html
</span><span class="line">        └── email
</span><span class="line">            ├── feedback_email_body.txt
</span><span class="line">            └── feedback_email_subject.txt
</span></code></pre></td></tr></table></div></figure>


<p>Install the new requirements, fire up the app, and navigate to <a href="http://localhost:8000/feedback/">http://localhost:8000/feedback/</a>. You should see:</p>









<p>Let’s wire up the Celery task.</p>

<a name="Add.the.Task"/>
<h3>Add the Task</h3>

<p>Basically, after the user submits the feedback form, we want to immediately let him continue on his merry way while we process the feedback, send an email, etc., all in the background.</p>

<p>To accomplish this, first add a file called <em>tasks.py</em> to the “feedback” directory:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">celery.decorators</span> <span class="kn">import</span> <span class="n">task</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">celery.utils.log</span> <span class="kn">import</span> <span class="n">get_task_logger</span>
</span><span class="line">
</span><span class="line"><span class="kn">from</span> <span class="nn">feedback.emails</span> <span class="kn">import</span> <span class="n">send_feedback_email</span>
</span><span class="line">
</span><span class="line"><span class="n">logger</span> <span class="o">=</span> <span class="n">get_task_logger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="nd">@task</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">"send_feedback_email_task"</span><span class="p">)</span>
</span><span class="line"><span class="k">def</span> <span class="nf">send_feedback_email_task</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
</span><span class="line">    <span class="sd">"""sends an email when feedback form is filled successfully"""</span>
</span><span class="line">    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Sent feedback email"</span><span class="p">)</span>
</span><span class="line">    <span class="k">return</span> <span class="n">send_feedback_email</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then update <em>forms.py</em> like so:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">feedback.tasks</span> <span class="kn">import</span> <span class="n">send_feedback_email_task</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">FeedbackForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
</span><span class="line">    <span class="n">email</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">EmailField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">"Email Address"</span><span class="p">)</span>
</span><span class="line">    <span class="n">message</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
</span><span class="line">        <span class="n">label</span><span class="o">=</span><span class="s">"Message"</span><span class="p">,</span> <span class="n">widget</span><span class="o">=</span><span class="n">forms</span><span class="o">.</span><span class="n">Textarea</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s">'rows'</span><span class="p">:</span> <span class="mi">5</span><span class="p">}))</span>
</span><span class="line">    <span class="n">honeypot</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">widget</span><span class="o">=</span><span class="n">forms</span><span class="o">.</span><span class="n">HiddenInput</span><span class="p">(),</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">send_email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="c"># try to trick spammers by checking whether the honeypot field is</span>
</span><span class="line">        <span class="c"># filled in; not super complicated/effective but it works</span>
</span><span class="line">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">'honeypot'</span><span class="p">]:</span>
</span><span class="line">            <span class="k">return</span> <span class="bp">False</span>
</span><span class="line">        <span class="n">send_feedback_email_task</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">'email'</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">'message'</span><span class="p">])</span>
</span></code></pre></td></tr></table></div></figure>


<p>In essence, the <code>send_feedback_email_task.delay(email, message)</code> function processes and sends the feedback email in the background as the user continues to use the site.</p>

<blockquote><p><strong>NOTE</strong>: The <code>success_url</code> in <em>views.py</em> is set to redirect the user to <code>/</code>, which does not exist yet. We’ll set this endpoint up in the next section.</p></blockquote>

<a name="Periodic.Tasks"/>
<h2>Periodic Tasks</h2>

<p>Often, you’ll need to schedule a task to run at a specific time every so often – i.e., a web scraper may need to run daily, for example. Such tasks, called <a href="http://celery.readthedocs.org/en/latest/userguide/periodic-tasks.html">periodic tasks</a>, are easy to set up with Celery.</p>

<p>Celery uses “celery beat” to schedule periodic tasks. Celery beat runs tasks at regular intervals, which are then executed by celery workers.</p>

<p>For example, the following task is scheduled to run every fifteen minutes:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">celery.task.schedules</span> <span class="kn">import</span> <span class="n">crontab</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">celery.decorators</span> <span class="kn">import</span> <span class="n">periodic_task</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="nd">@periodic_task</span><span class="p">(</span><span class="n">run_every</span><span class="o">=</span><span class="p">(</span><span class="n">crontab</span><span class="p">(</span><span class="n">minute</span><span class="o">=</span><span class="s">'*/15'</span><span class="p">)),</span> <span class="n">name</span><span class="o">=</span><span class="s">"some_task"</span><span class="p">,</span> <span class="n">ignore_result</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class="line"><span class="k">def</span> <span class="nf">some_task</span><span class="p">():</span>
</span><span class="line">    <span class="c"># do something</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let’s look at more robust example by adding this functionality into the Django Project…</p>

<hr/>


<p>Back to the Django Project, grab version <a href="https://github.com/realpython/Picha/releases/tag/v4">four</a>, which includes another new app, called <code>photos</code>, that uses the <a href="https://www.flickr.com/services/api/">Flickr API</a> to get new photos for display on the site:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line">├── feedback
</span><span class="line">│   ├── __init__.py
</span><span class="line">│   ├── admin.py
</span><span class="line">│   ├── emails.py
</span><span class="line">│   ├── forms.py
</span><span class="line">│   ├── models.py
</span><span class="line">│   ├── tasks.py
</span><span class="line">│   ├── tests.py
</span><span class="line">│   └── views.py
</span><span class="line">├── manage.py
</span><span class="line">├── photos
</span><span class="line">│   ├── __init__.py
</span><span class="line">│   ├── admin.py
</span><span class="line">│   ├── models.py
</span><span class="line">│   ├── settings.py
</span><span class="line">│   ├── tests.py
</span><span class="line">│   ├── utils.py
</span><span class="line">│   └── views.py
</span><span class="line">├── picha
</span><span class="line">│   ├── __init__.py
</span><span class="line">│   ├── celery.py
</span><span class="line">│   ├── settings.py
</span><span class="line">│   ├── urls.py
</span><span class="line">│   └── wsgi.py
</span><span class="line">├── requirements.txt
</span><span class="line">└── templates
</span><span class="line">    ├── base.html
</span><span class="line">    ├── feedback
</span><span class="line">    │   ├── contact.html
</span><span class="line">    │   └── email
</span><span class="line">    │       ├── feedback_email_body.txt
</span><span class="line">    │       └── feedback_email_subject.txt
</span><span class="line">    └── photos
</span><span class="line">        └── photo_list.html
</span></code></pre></td></tr></table></div></figure>


<p>Install the new requirements, run the migrations, and then fire up the server to make sure all is well. Try testing out the feedback form again. This time it should redirect just fine.</p>

<p>What’s next?</p>

<p>Well, since we would need to call the Flickr API periodically to add more photos to our site, we can add a Celery task.</p>

<a name="Add.the.Task"/>
<h3>Add the Task</h3>

<p>Add a <em>tasks.py</em> to the <code>photos</code> app:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">celery.task.schedules</span> <span class="kn">import</span> <span class="n">crontab</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">celery.decorators</span> <span class="kn">import</span> <span class="n">periodic_task</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">celery.utils.log</span> <span class="kn">import</span> <span class="n">get_task_logger</span>
</span><span class="line">
</span><span class="line"><span class="kn">from</span> <span class="nn">photos.utils</span> <span class="kn">import</span> <span class="n">save_latest_flickr_image</span>
</span><span class="line">
</span><span class="line"><span class="n">logger</span> <span class="o">=</span> <span class="n">get_task_logger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="nd">@periodic_task</span><span class="p">(</span>
</span><span class="line">    <span class="n">run_every</span><span class="o">=</span><span class="p">(</span><span class="n">crontab</span><span class="p">(</span><span class="n">minute</span><span class="o">=</span><span class="s">'*/15'</span><span class="p">)),</span>
</span><span class="line">    <span class="n">name</span><span class="o">=</span><span class="s">"task_save_latest_flickr_image"</span><span class="p">,</span>
</span><span class="line">    <span class="n">ignore_result</span><span class="o">=</span><span class="bp">True</span>
</span><span class="line"><span class="p">)</span>
</span><span class="line"><span class="k">def</span> <span class="nf">task_save_latest_flickr_image</span><span class="p">():</span>
</span><span class="line">    <span class="sd">"""</span>
</span><span class="line"><span class="sd">    Saves latest image from Flickr</span>
</span><span class="line"><span class="sd">    """</span>
</span><span class="line">    <span class="n">save_latest_flickr_image</span><span class="p">()</span>
</span><span class="line">    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Saved image from Flickr"</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here, we run the <code>save_latest_flickr_image()</code> function every fifteen minutes by wrapping the function call in a <code>task</code>. The <code>@periodic_task</code> decorator abstracts out the code to run the Celery task, leaving the <em>tasks.py</em> file clean and easy to read!</p>

<a name="Running.Locally"/>
<h2>Running Locally</h2>

<p>Ready to run this thing?</p>

<p>With your Django App and Redis running, open two new terminal windows/tabs. In each new window, navigate to your project directory, activate your virtualenv, and then run the following commands (one in each window):</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>celery -A picha worker -l info
</span><span class="line"><span class="nv">$ </span>celery -A picha beat -l info
</span></code></pre></td></tr></table></div></figure>


<p>When you visit the site on <a href="http://127.0.0.1:8000/">http://127.0.0.1:8000/</a> you should now see one image. Our app gets one image from Flickr every 15 minutes:</p>



















<p>Take a look at <code>photos/tasks.py</code> to see the code. Clicking on the “Feedback” button allows you to… send some feedback:</p>



















<p>This works via a celery task. Have a look at <code>feedback/tasks.py</code> for more.</p>

<p>That’s it, you have the Picha project up and running!</p>

<p>This is good for testing while developing your Django Project locally, but does not work so well when you need to deploy to production – like on <a href="https://www.digitalocean.com/?refcode=d8f211a4b4c2">DigitalOcean</a>, perhaps. For that, it is recommended that you run the Celery worker and scheduler in the background as a daemon with <a href="http://supervisord.org/">Supervisor</a>.</p>

<a name="Running.Remotely"/>
<h2>Running Remotely</h2>

<p>Installation is simple. Grab version <a href="https://github.com/realpython/Picha/releases/tag/v5">five</a> from the repo (if you don’t already have it). Then SSH into your remote server and run:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>sudo apt-get install supervisor
</span></code></pre></td></tr></table></div></figure>


<p>We then need to tell Supervisor about our Celery workers by adding configuration files to the “/etc/supervisor/conf.d/” directory on the remote server. In our case, we need two such configuration files – one for the Celery worker and one for the Celery scheduler.</p>

<p>Locally, create a folder called “supervisor” in the project root. Then add the following files…</p>

<p><strong>Celery Worker: <em>picha_celery.conf</em></strong></p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="p">;</span> <span class="o">==================================</span>
</span><span class="line"><span class="p">;</span>  celery worker supervisor example
</span><span class="line"><span class="p">;</span> <span class="o">==================================</span>
</span><span class="line">
</span><span class="line"><span class="p">;</span> the name of your supervisord program
</span><span class="line"><span class="o">[</span>program:pichacelery<span class="o">]</span>
</span><span class="line">
</span><span class="line"><span class="p">;</span> Set full path to celery program <span class="k">if </span>using virtualenv
</span><span class="line"><span class="nb">command</span><span class="o">=</span>/home/mosh/.virtualenvs/picha/bin/celery worker -A picha --loglevel<span class="o">=</span>INFO
</span><span class="line">
</span><span class="line"><span class="p">;</span> The directory to your Django project
</span><span class="line"><span class="nv">directory</span><span class="o">=</span>/home/mosh/sites/picha
</span><span class="line">
</span><span class="line"><span class="p">;</span> If supervisord is run as the root user, switch users to this UNIX user account
</span><span class="line"><span class="p">;</span> before doing any processing.
</span><span class="line"><span class="nv">user</span><span class="o">=</span>mosh
</span><span class="line">
</span><span class="line"><span class="p">;</span> Supervisor will start as many instances of this program as named by numprocs
</span><span class="line"><span class="nv">numprocs</span><span class="o">=</span>1
</span><span class="line">
</span><span class="line"><span class="p">;</span> Put process stdout output in this file
</span><span class="line"><span class="nv">stdout_logfile</span><span class="o">=</span>/var/log/celery/picha_worker.log
</span><span class="line">
</span><span class="line"><span class="p">;</span> Put process stderr output in this file
</span><span class="line"><span class="nv">stderr_logfile</span><span class="o">=</span>/var/log/celery/picha_worker.log
</span><span class="line">
</span><span class="line"><span class="p">;</span> If <span class="nb">true</span>, this program will start automatically when supervisord is started
</span><span class="line"><span class="nv">autostart</span><span class="o">=</span><span class="nb">true</span>
</span><span class="line">
</span><span class="line"><span class="p">;</span> May be one of <span class="nb">false</span>, unexpected, or true. If <span class="nb">false</span>, the process will never
</span><span class="line"><span class="p">;</span> be autorestarted. If unexpected, the process will be restart when the program
</span><span class="line"><span class="p">;</span> exits with an <span class="nb">exit </span>code that is not one of the <span class="nb">exit </span>codes associated with this
</span><span class="line"><span class="p">;</span> process’ configuration <span class="o">(</span>see exitcodes<span class="o">)</span>. If <span class="nb">true</span>, the process will be
</span><span class="line"><span class="p">;</span> unconditionally restarted when it exits, without regard to its <span class="nb">exit </span>code.
</span><span class="line"><span class="nv">autorestart</span><span class="o">=</span><span class="nb">true</span>
</span><span class="line">
</span><span class="line"><span class="p">;</span> The total number of seconds which the program needs to stay running after
</span><span class="line"><span class="p">;</span> a startup to consider the start successful.
</span><span class="line"><span class="nv">startsecs</span><span class="o">=</span>10
</span><span class="line">
</span><span class="line"><span class="p">;</span> Need to <span class="nb">wait </span><span class="k">for </span>currently executing tasks to finish at shutdown.
</span><span class="line"><span class="p">;</span> Increase this <span class="k">if </span>you have very long running tasks.
</span><span class="line"><span class="nv">stopwaitsecs</span> <span class="o">=</span> 600
</span><span class="line">
</span><span class="line"><span class="p">;</span> When resorting to send SIGKILL to the program to terminate it
</span><span class="line"><span class="p">;</span> send SIGKILL to its whole process group instead,
</span><span class="line"><span class="p">;</span> taking care of its children as well.
</span><span class="line"><span class="nv">killasgroup</span><span class="o">=</span><span class="nb">true</span>
</span><span class="line">
</span><span class="line"><span class="p">;</span> <span class="k">if </span>your broker is supervised, <span class="nb">set </span>its priority higher
</span><span class="line"><span class="p">;</span> so it starts first
</span><span class="line"><span class="nv">priority</span><span class="o">=</span>998
</span></code></pre></td></tr></table></div></figure>


<p><strong>Celery Scheduler: <em>picha_celerybeat.conf</em></strong></p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="p">;</span> <span class="o">================================</span>
</span><span class="line"><span class="p">;</span>  celery beat supervisor example
</span><span class="line"><span class="p">;</span> <span class="o">================================</span>
</span><span class="line">
</span><span class="line"><span class="p">;</span> the name of your supervisord program
</span><span class="line"><span class="o">[</span>program:pichacelerybeat<span class="o">]</span>
</span><span class="line">
</span><span class="line"><span class="p">;</span> Set full path to celery program <span class="k">if </span>using virtualenv
</span><span class="line"><span class="nb">command</span><span class="o">=</span>/home/mosh/.virtualenvs/picha/bin/celerybeat -A picha --loglevel<span class="o">=</span>INFO
</span><span class="line">
</span><span class="line"><span class="p">;</span> The directory to your Django project
</span><span class="line"><span class="nv">directory</span><span class="o">=</span>/home/mosh/sites/picha
</span><span class="line">
</span><span class="line"><span class="p">;</span> If supervisord is run as the root user, switch users to this UNIX user account
</span><span class="line"><span class="p">;</span> before doing any processing.
</span><span class="line"><span class="nv">user</span><span class="o">=</span>mosh
</span><span class="line">
</span><span class="line"><span class="p">;</span> Supervisor will start as many instances of this program as named by numprocs
</span><span class="line"><span class="nv">numprocs</span><span class="o">=</span>1
</span><span class="line">
</span><span class="line"><span class="p">;</span> Put process stdout output in this file
</span><span class="line"><span class="nv">stdout_logfile</span><span class="o">=</span>/var/log/celery/picha_beat.log
</span><span class="line">
</span><span class="line"><span class="p">;</span> Put process stderr output in this file
</span><span class="line"><span class="nv">stderr_logfile</span><span class="o">=</span>/var/log/celery/picha_beat.log
</span><span class="line">
</span><span class="line"><span class="p">;</span> If <span class="nb">true</span>, this program will start automatically when supervisord is started
</span><span class="line"><span class="nv">autostart</span><span class="o">=</span><span class="nb">true</span>
</span><span class="line">
</span><span class="line"><span class="p">;</span> May be one of <span class="nb">false</span>, unexpected, or true. If <span class="nb">false</span>, the process will never
</span><span class="line"><span class="p">;</span> be autorestarted. If unexpected, the process will be restart when the program
</span><span class="line"><span class="p">;</span> exits with an <span class="nb">exit </span>code that is not one of the <span class="nb">exit </span>codes associated with this
</span><span class="line"><span class="p">;</span> process’ configuration <span class="o">(</span>see exitcodes<span class="o">)</span>. If <span class="nb">true</span>, the process will be
</span><span class="line"><span class="p">;</span> unconditionally restarted when it exits, without regard to its <span class="nb">exit </span>code.
</span><span class="line"><span class="nv">autorestart</span><span class="o">=</span><span class="nb">true</span>
</span><span class="line">
</span><span class="line"><span class="p">;</span> The total number of seconds which the program needs to stay running after
</span><span class="line"><span class="p">;</span> a startup to consider the start successful.
</span><span class="line"><span class="nv">startsecs</span><span class="o">=</span>10
</span><span class="line">
</span><span class="line"><span class="p">;</span> <span class="k">if </span>your broker is supervised, <span class="nb">set </span>its priority higher
</span><span class="line"><span class="p">;</span> so it starts first
</span><span class="line"><span class="nv">priority</span><span class="o">=</span>999
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Make sure to update the paths in these files to match the remote server’s filesystem.</p></blockquote>

<p>Basically, these supervisor configuration files tell supervisord how to run and manage our ‘programs’ (as they are called by supervisord).</p>

<p>In the examples above, we have created two supervisord programs named “pichacelery” and “pichacelerybeat”.</p>

<p>Now just copy these files to the remote server in the “/etc/supervisor/conf.d/” directory.</p>

<p>We also need to create the log files that are mentioned in the above scripts on the remote server:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>touch /var/log/celery/picha_worker.log
</span><span class="line"><span class="nv">$ </span>touch /var/log/celery/picha_beat.log
</span></code></pre></td></tr></table></div></figure>


<p>Finally, run the following commands to make Supervisor aware of the programs – e.g., <code>pichacelery</code> and <code>pichacelerybeat</code>:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>sudo supervisorctl reread
</span><span class="line"><span class="nv">$ </span>sudo supervisorctl update
</span></code></pre></td></tr></table></div></figure>


<p>Run the following commands to stop, start, and/or check the status of the <code>pichacelery</code> program:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>sudo supervisorctl stop pichacelery
</span><span class="line"><span class="nv">$ </span>sudo supervisorctl start pichacelery
</span><span class="line"><span class="nv">$ </span>sudo supervisorctl status pichacelery
</span></code></pre></td></tr></table></div></figure>


<p>You can read more about Supervisor from the <a href="http://supervisord.org">official documentation</a>.</p>

<a name="Final.Tips"/>
<h2>Final Tips</h2>

<ol>
<li><em>Do not pass Django model objects to Celery tasks.</em> To avoid cases where the model object has already changed before it is passed to a Celery task, pass the object’s primary key to Celery. You would then, of course, have to use the primary key to get the object from the database before working on it.</li>
<li><em>The default Celery scheduler creates some files to store its schedule locally.</em> These files would be “celerybeat-schedule.db” and “celerybeat.pid”. If you are using a version control system like Git (which you should!), it is a good idea to ignore this files and not add them to your repository since they are for running processes locally.</li>
</ol>


<a name="Next.steps"/>
<h2>Next steps</h2>

<p>Well, that’s it for the basic introduction to integrating Celery into a Django Project.</p>

<p>Want more?</p>

<ol>
<li>Dive into the official <a href="http://celery.readthedocs.org/en/latest/userguide/">Celery User Guide</a> to learn more.</li>
<li>Create a <a href="http://www.fabfile.org/">Fabfile</a> to setup Supervisor and the configuration files. Make sure to add the commands to <code>reread</code> and <code>update</code> Supervisor.</li>
<li>Fork the Project from the <a href="https://github.com/realpython/Picha">repo</a> and open a Pull Request to add a new Celery task.</li>
</ol>


<p>Happy coding!</p>
</div>


      </div></body></html>