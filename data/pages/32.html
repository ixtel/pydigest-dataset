<html><body><div><div class="document">
<p><a class="reference external" href="http://www.celeryproject.org/">Celery</a> is a great tool for background task processing in <a class="reference external" href="https://www.djangoproject.com/">Django</a>.  We use it in a lot of the custom web apps we build at Caktus, and it's quickly becoming the standard for all variety of task scheduling work loads, from simple to highly complex.</p>
<p>Although rarely, sometimes a Celery worker may stop processing tasks and appear completely hung.  In other words, issuing a <tt class="docutils literal">restart</tt> command (through <a class="reference external" href="http://supervisord.org/">Supervisor</a>) or <tt class="docutils literal">kill</tt> (from the command line) doesn't immediately restart or shutdown the process.  This can particularly be an issue in cases where you have a queue setup with only one worker (e.g., to avoid processing any of the tasks in this queue simultaneously), because then none of the new tasks in the queue will get processed.  In these cases you may find yourself resorting to manually calling <tt class="docutils literal">kill <span class="pre">-9</span> &lt;pid&gt;</tt> on the process to get the queue started back up again.</p>
<p>We recently ran into this issue at Caktus, and in our case the stuck worker process wasn't processing any new tasks and wasn't showing any CPU activity in <tt class="docutils literal">top</tt>.  That seemed a bit odd, so I thought I'd make an attempt to discover what that process was actually doing at the time that it became non-responsive.  Enter <tt class="docutils literal">strace</tt>.</p>
<p><tt class="docutils literal">strace</tt> is a powerful command-line tool for inspecting running processes to determine what "system calls" they're making.  <a class="reference external" href="https://en.wikipedia.org/wiki/System_call">System calls</a> are low level calls to the operating system kernel that might involve accessing hard disks, the network, creating new processes, or other such operations.  First, let's find the PID of the celery process we're interested in:</p>


<p>You'll find the PID in the second column.  For the purposes of this post let's assume that's <tt class="docutils literal">1234</tt>.  You can inspect the full command in the process list to make sure you've identified the right celery worker.</p>
<p>Next, run <tt class="docutils literal">strace</tt> on that PID as follows:</p>
<div class="highlight"><pre>sudo strace -p <span class="m">1234</span> -s 100000
</pre></div>

<p>The <tt class="docutils literal"><span class="pre">-p</span></tt> flag specifies the PID, and the <tt class="docutils literal"><span class="pre">-s</span></tt> flag specifies the size of the output.  By default it's limited to 32 characters, which we found isn't very helpful if the system call being made includes a long string as an argument.  You might see something like this:</p>
<pre class="literal-block">Process 1234 attached - interrupt to quit
write(5, "ion id='89273' responses='12'&gt;\n     ...", 37628
</pre>
<p>In our case, the task was writing what looked like some XML to file descriptor "5".  The XML was much longer and at the end included what looked like a few attributes of a pickled Python object, but I've shortened it here for clarity's sake.  You can see what "5" corresponds to by looking at the output of <tt class="docutils literal">lsof</tt>:</p>


<p>The file descriptor shows up in the "FD" column; in our version of <tt class="docutils literal">strace</tt>, that happens to be the 4th column from the left.  You'll see a bunch of files that you don't care about, and then down near the bottom, the list of open file descriptors:</p>
<pre class="literal-block">python    1234   myuser    0r     FIFO                0,8      0t0    6593806 pipe
python    1234   myuser    1w     FIFO                0,8      0t0    6593807 pipe
python    1234   myuser    2w     FIFO                0,8      0t0    6593807 pipe
python    1234   myuser    3u     0000                0,9        0       4738 anon_inode
python    1234   myuser    4r     FIFO                0,8      0t0    6593847 pipe
python    1234   myuser    5w     FIFO                0,8      0t0    6593847 pipe
python    1234   myuser    6r      CHR                1,9      0t0       4768 /dev/urandom
python    1234   myuser    7r     FIFO                0,8      0t0    6593850 pipe
python    1234   myuser    8w     FIFO                0,8      0t0    6593850 pipe
python    1234   myuser    9r     FIFO                0,8      0t0    6593916 pipe
python    1234   myuser   10u     IPv4            6593855      0t0        TCP ip-10-142-126-212.ec2.internal:33589-&gt;ip-10-112-43-181.ec2.internal:amqp (ESTABLISHED)
</pre>
<p>You can see "5" corresponds to a pipe, which at least in theory ends up with a TCP connection to the amqp port on another EC2 server (host names are fictional).</p>
<p>RabbitMQ was operating properly and not reporting any errors, so our attention turned to the Celery task in question.  Upon further examination, an object we were passing to the task included a long XML string as an attribute, which was being pickled and passed to RabbitMQ.  <a class="reference external" href="https://github.com/celery/celery/issues/318">Issues have been reported</a> with long argument sizes in Celery before, and while it appears they should be supported, an easy workaround for us (and Celery's <a class="reference external" href="http://docs.celeryproject.org/en/latest/userguide/tasks.html#data-locality">recommended approach</a>) was to pass an ID for this object rather than the object itself, greatly reducing the size of the task's arguments and avoiding the risk of overwriting any object attributes.</p>
<p>While there may have been other ways to fix the underlying issue, <tt class="docutils literal">strace</tt> and <tt class="docutils literal">lsof</tt> were crucial in helping us figure out the problem.  One might be able to accomplish the same thing with a lot of logging, but if your code is stuck in a system call and doesn't appear to be showing any noticeable CPU usage in <tt class="docutils literal">top</tt>, <tt class="docutils literal">strace</tt> can take you immediately to the root of the problem.</p>
</div>

  </div></body></html>