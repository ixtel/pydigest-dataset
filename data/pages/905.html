<html><body><div><div id="content">
<p>Do you remember <a href="/~mdione/glob/posts/restoring-files-owner-and-permissions/">this</a>?
Well, now I have a similar but quite different case: I want to restore the files'
times. Why? Read me out.</p>

<p>Since a long time I'm doing backups to an external drive. For that I simply use <code>rsync</code>.
When I bought my second laptop, I took the chance to test restoring from that
backup, so I just did a last backup in the old machine and a restore in the new one.
This allowed me to add the last few things that were missing. After a few more
weeks finding missing things, doing more backup/restore cycles between the old
and new laptops, I was happy.</p>

<p>But there was something that I didn't realize till a few months later. The file
times were not backed up, and clearly not restored. This didn't affect me in any
way, at least until I tried to a new post to this glob.</p>

<p>See, this glob is generated with <a href="http://ikiwiki.info/"><code>ikiwiki</code></a>. <code>ikiwiki</code>
uses the files' mtime to generate the posts' times, and uses that to sort them
and to assign them as belonging to some year or month. With the mtimes lost,
<code>ikiwiki</code> was assigning all the older posts to some day in Oct, 2012, which was
the date of the last backup/restore cycle.</p>

<p>Frustrated (yes, sometimes I have a low threshold), I left it like that: no planet
was flooded because in any case the rss feeds didn't really change, and nobody
would notice <em>and</em> complain about it. In fact, nobody did.[1] Have in mid that
as I kept my old laptop as a server, and that I didn't clean up all the files
I keep in my backup, I still had the original mtimes in the original files.</p>

<p>Yesterday, playing around with unrelated things, I came across the post I mentioned
at the beginning of this one, and had the urge to really fix that mess. Today I
started looking at it, and found that this command was some part of it:</p>

<div class="highlight-sh"><pre class="hl"><span class="hl kwc">find</span> src<span class="hl opt">/</span>projects<span class="hl opt">/</span>glob<span class="hl opt">/</span>work<span class="hl opt">/ -</span>name <span class="hl opt">*</span>.mdwn | <span class="hl kwc">xargs</span> stat <span class="hl opt">--</span>format <span class="hl str">'%X %Y %Z %n'</span>
</pre></div>

<p>but processing its output in <code>bash</code> seemed like a burden. Luckily, I have the
solution for that, a project that I started for exactly that same reason: <code>bash</code>
sucks at manipulating data.</p>

<p>So I grabbed my editor, punched keys for some 7 minutes, run 3 or 4 tests, making
sure that everything would go smooth, run once more on the live system, rebuilt
my glob[2] and voilĂ ! It's fixed now.</p>

<p>How long is the code? Not much really:</p>

<div class="highlight-py"><pre class="hl"><span class="hl kwa">from</span> os <span class="hl kwa">import</span> utime

with <span class="hl kwd">remote</span> <span class="hl opt">(</span><span class="hl str">'192.168.0.42'</span><span class="hl opt">,</span> allow_agent<span class="hl opt">=</span><span class="hl kwa">False</span><span class="hl opt">,</span> password<span class="hl opt">=</span><span class="hl str">'XXXXXXXX'</span><span class="hl opt">)</span> <span class="hl kwa">as</span> fds<span class="hl opt">:</span>
    <span class="hl slc"># find al files (not only posts), get its times and path</span>
    with <span class="hl kwd">cd</span> <span class="hl opt">(</span><span class="hl str">'src/projects/glob/work'</span><span class="hl opt">):</span>
        <span class="hl kwd">find</span> <span class="hl opt">(</span><span class="hl str">'.'</span><span class="hl opt">,</span> <span class="hl str">'-name'</span><span class="hl opt">,</span> <span class="hl str">'*.mdwn'</span><span class="hl opt">)</span> | <span class="hl kwd">xargs</span> <span class="hl opt">(</span><span class="hl str">'stat'</span><span class="hl opt">,</span> format<span class="hl opt">=</span><span class="hl str">'</span><span class="hl ipl">%X %</span><span class="hl str">Y %Z %n'</span><span class="hl opt">)</span>

<span class="hl opt">(</span>i<span class="hl opt">,</span> o<span class="hl opt">,</span> e<span class="hl opt">)=</span> fds

<span class="hl kwa">for</span> line <span class="hl kwa">in</span> e<span class="hl opt">.</span><span class="hl kwd">readlines</span> <span class="hl opt">():</span>
    <span class="hl kwa">print</span> <span class="hl opt">(</span>line<span class="hl opt">.</span><span class="hl kwd">decode</span> <span class="hl opt">(</span><span class="hl str">'utf-8'</span><span class="hl opt">),</span> end<span class="hl opt">=</span><span class="hl str">''</span><span class="hl opt">)</span>

<span class="hl kwa">for</span> line <span class="hl kwa">in</span> o<span class="hl opt">.</span><span class="hl kwd">readlines</span> <span class="hl opt">():</span>
    data<span class="hl opt">=</span> line<span class="hl opt">.</span><span class="hl kwd">split</span> <span class="hl opt">()</span>
    access<span class="hl opt">,</span> modif<span class="hl opt">,</span> change<span class="hl opt">= [</span> <span class="hl kwb">int</span> <span class="hl opt">(</span>x<span class="hl opt">)</span> <span class="hl kwa">for</span> x <span class="hl kwa">in</span> data<span class="hl opt">[:</span><span class="hl num">3</span><span class="hl opt">] ]</span>
    file_path<span class="hl opt">=</span> data<span class="hl opt">[</span><span class="hl num">3</span><span class="hl opt">].</span><span class="hl kwd">decode</span> <span class="hl opt">(</span><span class="hl str">'utf-8'</span><span class="hl opt">)</span>
    <span class="hl kwa">if</span> <span class="hl kwd">_e</span> <span class="hl opt">(</span>file_path<span class="hl opt">):</span>
        <span class="hl kwd">utime</span> <span class="hl opt">(</span>file_path<span class="hl opt">,</span> times<span class="hl opt">= (</span>access<span class="hl opt">,</span> modif<span class="hl opt">))</span>
    <span class="hl kwa">else</span><span class="hl opt">:</span>
        <span class="hl kwa">print</span> <span class="hl opt">(</span><span class="hl str">"</span><span class="hl ipl">%s </span><span class="hl str">not found!"</span> % file_path<span class="hl opt">)</span>
</pre></div>

<p>Notice that this example is even more complex than initially thought: it <code>ssh</code>'s
into the server to fetch the original times.</p>

<p>This makes one thing clear: I have to improve a lot the <code>remote()</code> API. For
instance, so far I have no way to know if the remote commands executed fine or
not, and the way to read the lines is still ugly and not homogeneous with how
other <code>ayrton</code> functions/executables work.</p>

<p>Also note that this does not restore the ctimes, as I hadn't found a way to do it,
but didn't really did a lot of effort. I don't really need them.</p>

<p>Of course, I also fixed my backup and restore scripts :)</p>

<hr/>

<p>[1] I was this &gt;&lt; close of adding <code>#foreveralone</code> to that sentence. I think I'll
    resist for a couple more years.</p>

<p>[2] Don't forget, <code>ikiwiki</code> compiles static sites.</p>

<hr/>

<p><a href="../../tags/ayrton/">ayrton</a> <a href="../../tags/python/">python</a> <a href="../../tags/sysadmin/">sysadmin</a></p>

</div>





</div></body></html>