<html><body><div><div class="entry-content">
    <p>Test-driven Development (<span class="caps">TDD</span>) has been getting a lot of attention these days. While I understand the importance of testing, I was sceptical of Test-Driven Development for a long time. I mean, why not Development-Driven Testing or Develop Then Test Later? I thought figuring out the tests before one can write even a single line of code would be impossible.</p>
<p>I was so wrong.</p>
<p>Test-driven Development will help you immensely in the long run. We will soon see how. We will approach <span class="caps">TDD</span> from a sceptical viewpoint and then try to create a simple <span class="caps">URL</span> shortener like bit.ly using <span class="caps">TDD</span>. I will conclude with my evaluation of the pros and cons of the technique; to which you may directly jump to as well.</p>
<h3 id="what-is-tdd">What is <span class="caps">TDD</span>?</h3>
<p>Test-driven development (<span class="caps">TDD</span>) is a form of software development where you first write the test, run the test (which will fail first) and then write the minimum code needed to make the test pass. We will elaborate on these steps in detail later but essentially this is the process that gets repeated.</p>
<p>This might sound counter-intuitive. Why do we need to write tests when we know that we have not written any code and we are certain that it will fail because of that? It seems like we are not testing anything at all.</p>
<p>But look again. Later, we do write code that merely <em>satisfies</em> these tests. That means that these tests are not ordinary tests, they are more like <strong>Specifications</strong>. They are telling you what to expect. These tests or specifications will directly come from your client’s user stories. You are writing just enough code to make it work.</p>
<p>For instance, your client needs a website (in Django) with a Article model that specifies a headline and a body. The very first thing to do in <span class="caps">TDD</span> would be to write a test which checks this specification. Then you run the test. Watch it fail. Then write three lines of code in <code>models.py</code> to create an Article class with a headline and body.</p>
<p>But wait a minute. Isn’t this cheating? Your client actually wanted you to create a Blog application. But your three lines are no where near the functionality of a blog. This is an uncomfortable thought that bothers you when you start with <span class="caps">TDD</span>.</p>
<p>Just ignore it for now. It is not that much of a big deal. In fact, even your client wouldn’t be too bothered about it. They would be happy that you are working on their application one spec at a time. They can actually watch the progress (and trust me they love that, especially management).</p>


<p>In any form of engineering, this is a common way of building things - there is a plan and we build it bit-by-bit based on it. Before a building is constructed, a blueprint is drawn and progress is made floor-by-floor. Prior to every mobile phone being manufactured, there are detailed <span class="caps">CAD</span> models to ensure that every part fits each other perfectly. So why should software engineering be any different?</p>
<h3 id="how-to-do-tdd">How to do <span class="caps">TDD</span>?</h3>
<p>Now, let’s see how test-driven development is done. Just follow this simple procedure:</p>
<ol>
<li><strong>Decide what the code will do</strong>: This is usually told to you by the client. </li>
<li><strong>Write a test</strong>: The test should pass only if the code does that.</li>
<li><strong>Run the test</strong>: It will fail.</li>
<li><strong>Write some code</strong>: Just enough to make it pass.</li>
<li><strong>Run the test</strong>: If it fails go to step 4.</li>
<li><strong>Refactor the code</strong>: Tests will ensure that it doesn’t break specs. </li>
<li><strong>Rinse and Repeat</strong>: Take another spec/user-story/feature and go to step 1.</li>
</ol>
<p>Now that you know that tests are like specifications, you might be seeing some method in this madness. But this method is more familiar to you than you might think.</p>


<p>This is, in fact, quite similar to the <a href="http://en.wikipedia.org/wiki/Scientific_method">Scientific method</a> which is the basis of modern science. Let’s recollect what scientific method teaches us:</p>
<ol>
<li>Define a question</li>
<li>Gather information and resources (observe)</li>
<li>Form an explanatory hypothesis</li>
<li>Test the hypothesis by performing an experiment and collecting data in a reproducible manner</li>
<li>Analyse the data</li>
<li>Interpret the data and draw conclusions that serve as a starting point for new hypothesis (go to step 3)</li>
<li>Publish results</li>
<li>Retest (frequently done by other scientists)</li>
</ol>
<p>Compare this with the previous steps for <span class="caps">TDD</span> and notice the similarities. Tests in <span class="caps">TDD</span> take the role of experiments in Science. Your theory is only good if the experiments are repeatable and verifiable. You will see that the same will hold good for tests in your project’s source code when you work with other developers.</p>
<p>In fact, let’s look at collaborative software development happening in large open source projects. Almost all of them would have a good collection of tests. While writing test cases seem like a good idea, are there any good reasons to write tests before code?</p>
<h3 id="why-do-tdd">Why do <span class="caps">TDD</span>?</h3>
<p>So it seems that that <span class="caps">TDD</span> is not a arbitrary practice after all. But we still don’t have to follow it. There are plenty of ways to develop software.</p>
<p>But <span class="caps">TDD</span> does come with its own set of advantages, some of which are obvious and some which are not:</p>
<ol>
<li>It is <em>live</em> documentation that grows, lives and changes with your code.</li>
<li>Improves design</li>
<li>Catches future errors</li>
<li>Long-term time savings</li>
<li>Reduces technical debt and hence risk</li>
<li>Avoid manual one-off tests. Eventually, you will add and re-add test data to test by hand. Too hackey.</li>
</ol>
<p>These are advantages gathered from various developers who practice <span class="caps">TDD</span>. Each of them merit a detailed explanation. But to summarise, <span class="caps">TDD</span> brings with it a lot of benefits of testing by making it a mandatory part of your development cycle. You might think that you will add tests later, but sometimes you never get around to doing it.</p>
<p>Code written by passing <a href="http://www.softwaretestingmentor.com/tptc/writing-good-test-cases/">simple, focused test cases</a> tend to be more modular and hence better designed. It is a pleasant side effect of the process but you will certainly notice it.</p>
<h3 id="how-is-tdd-done">How is <span class="caps">TDD</span> done?</h3>
<p>To understand <span class="caps">TDD</span> better we will try to implement an entire Django project by writing test cases first and then the code. We will be creating a <span class="caps">URL</span> shortening services which takes a long url and converts it into a short one (possibly for fitting into a twitter message).</p>
<p>You can also watch the screencast below to see how the site is created.</p>
<p><a href="http://www.youtube.com/watch?v=qfkFhcxd2XI"><img src="/static/images/blog/tdd-tiny.png" alt="Screencast" title="Go to the Screencast on YouTube"/></a></p>
<h4 id="user-stories">User Stories</h4>
<p>Imagine that after a long call with your client, you have distilled their needs into the following user stories:</p>
<ol>
<li>The short <span class="caps">URL</span> must be always smaller than the original <span class="caps">URL</span>.</li>
<li>If you give the short <span class="caps">URL</span>, you must be able to recover the original <span class="caps">URL</span>.</li>
<li>The home page must have a form to enter the long <span class="caps">URL</span>.</li>
<li>Submitting the home page form should show the short <span class="caps">URL</span>.</li>
<li>Clicking on the short <span class="caps">URL</span> must redirect to the original (long) <span class="caps">URL</span>.</li>
</ol>
<p>We have also roughly ordered the stories so that the core functionality comes first.</p>
<h4 id="create-the-project">Create the Project</h4>
<p><em>Note: You will need at least Python 2.7 and Django 1.6 to follow the rest of this post. Earlier versions of Python and Django had some differences in unit testing tools.</em></p>
<p>Typically <span class="caps">URL</span> shortener sites will have a short name like http://ti.ny. So let’s call our project <code>tiny</code></p>
<div class="codehilite"><pre><span class="go">django-admin.py startproject tiny</span>
<span class="go">cd tiny</span>
<span class="go">./manage.py startapp shorturls</span>
</pre></div>


<p>Configure <span class="caps">DATABASES</span> in <code>tiny/settings.py</code> to use a simple file-based <code>sqlite3</code> database and add the app <code>shorturls</code> in INSTALLED_APPS as well. Next, synchronise the database with:</p>



<h3 id="writing-the-first-test">Writing the First Test</h3>
<p>Add your first test case to <code>shorturls/tests.py</code>:</p>
<div class="codehilite"><pre><span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">TestCase</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Link</span>

<span class="k">class</span> <span class="nc">ShortenerText</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_shortens</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Test that urls get shorter</span>
<span class="sd">        """</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">"http://www.example.com/"</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">Link</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">)</span>
        <span class="n">short_url</span> <span class="o">=</span> <span class="n">Link</span><span class="o">.</span><span class="n">shorten</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertLess</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">short_url</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
</pre></div>


<p>This test creates a simple Link object given a (long) <span class="caps">URL</span>. It creates a short <span class="caps">URL</span> by using a class method called <code>shorten()</code> and asserts that it is shorter in length. Note that we are not saving the Link object into the database. Whenever a test can avoid touching the database, it must jump at the opportunity. Django uses an in-memory database while testing but even that can take some time. Faster the unit tests are, the more likely you are to use them.</p>
<p>Also, notice that we get a better error message when we use the <code>assert...()</code> functions (see the Sidenote below).</p>
<p>Run:</p>
<div class="codehilite"><pre><span class="go">./manage.py test shorturls</span>
</pre></div>


<p>As expected, it fails. Now build a model for this to work in <code>shorturls/models.py</code>:</p>
<div class="codehilite"><pre><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>

<span class="k">class</span> <span class="nc">Link</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">shorten</span><span class="p">(</span><span class="n">long_url</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">""</span>
</pre></div>


<p>We are cheating by returning a zero length string but we know that this will pass the test.</p>
<div class="codehilite"><pre><span class="p">.</span><span class="o">/</span><span class="n">manage</span><span class="p">.</span><span class="n">py</span> <span class="n">test</span> <span class="n">shorturls</span>
</pre></div>


<h4 id="sidenote-choosing-the-right-assertion">Sidenote: Choosing the right assertion</h4>
<p>There are several assert functions provided by the <a href="http://docs.python.org/2/library/unittest.html"><code>unittest</code></a> module in Python and several more provided by Django in the <a href="https://docs.djangoproject.com/en/dev/topics/testing/tools/#testcase"><code>TestCase</code> class</a>. Initially, they might feel redundant. After all, <a href="http://docs.python.org/2/reference/simple_stmts.html#the-assert-statement"><code>assert</code></a> is a keyword built into Python. Every conceivable assertion function can be replaced by an <code>assert</code> keyword checking for the truth of a Python expression.</p>
<p>The real difference is when the assertion fails. Here are three equivalent assertions along with the typical error message when it fails. Compare them yourself:</p>
<div class="codehilite"><pre><span class="go">    assert len(url) &lt; len(docs_url)</span>
<span class="go">AssertionError</span>

<span class="go">    self.assertTrue(len(url) &lt; len(docs_url))</span>
<span class="go">AssertionError: False is not true</span>

<span class="go">    self.assertLess(len(url), len(docs_url))</span>
<span class="go">AssertionError: 101 not less than 58</span>
</pre></div>


<p>Clearly, the  <code>self.assert...()</code> functions have a clearer error message. So it is worthwhile to familiarise ourselves with the assert <span class="caps">API</span> unless you plan to you something like <a href="http://pytest.org/">pytest</a>.</p>
<h3 id="second-test-recovering-the-url">Second Test: Recovering the url</h3>
<blockquote>
<p><span class="dquo">“</span>But you wouldn’t clap yet. Because making something disappear isn’t enough; you have
to bring it back. That’s why every magic trick has a third act, the hardest part,
the part we call “The Prestige”.”  — Christopher Priest, The Prestige</p>
</blockquote>


<p>Add another test to <code>shorturls/tests.py</code>:</p>
<div class="codehilite"><pre><span class="k">def</span> <span class="nf">test_recover_link</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Tests that the shortened then expanded url is the same as original</span>
<span class="sd">    """</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s">"http://www.example.com/"</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">Link</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">)</span>
    <span class="n">short_url</span> <span class="o">=</span> <span class="n">Link</span><span class="o">.</span><span class="n">shorten</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
    <span class="n">l</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="c"># Another user asks for the expansion of short_url</span>
    <span class="n">exp_url</span> <span class="o">=</span> <span class="n">Link</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">short_url</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">exp_url</span><span class="p">)</span>
</pre></div>


<p>Our bluff gets called. We now need a real way to shorten urls and recover them. Unlike what might come to you intuitively, the <span class="caps">URL</span> is not mapped to a more compact encoding like a zip file. The <a href="http://stackoverflow.com/questions/7109143/what-characters-are-valid-in-a-url">allowable character set for a <span class="caps">URL</span></a> is pretty limited. Any kind of ‘string compression’ would reach its limits.</p>
<p>Instead we do something very simple. We know that, once saved into the database, each Link object can be uniquely identified by an integer - its primary key. Simple add this primary key to the domain’s <span class="caps">URL</span> and we have a short <span class="caps">URL</span> that can be mapped back to the original <span class="caps">URL</span> with a database lookup.</p>
<p>Change <code>shorturls/models.py</code> to this: </p>
<div class="codehilite"><pre><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>

<span class="k">class</span> <span class="nc">Link</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">shorten</span><span class="p">(</span><span class="n">link</span><span class="p">):</span>
        <span class="n">l</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Link</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">link</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">expand</span><span class="p">(</span><span class="n">slug</span><span class="p">):</span>
        <span class="n">link_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">slug</span><span class="p">)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">Link</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">link_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">url</span>
</pre></div>


<p>Now the tests should pass.</p>
<h3 id="third-test-home-page-with-a-form">Third Test: Home Page With a Form</h3>
<p>Add to <code>shorturls/tests.py</code>:</p>
<div class="codehilite"><pre><span class="kn">from</span> <span class="nn">django.core.urlresolvers</span> <span class="kn">import</span> <span class="n">reverse</span>
<span class="o">...</span>

<span class="k">def</span> <span class="nf">test_homepage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Tests that a home page exists and it contains a form.</span>
<span class="sd">    """</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s">"home"</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">"form"</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
</pre></div>


<p>This test fails because we don’t have any views mapped in our <code>urls.py</code>. In the spirit of minimum effort, let’s use Django’s class based view. Since the submission of a form would create a new Link object, let’s use a <code>CreateView</code> instead of a <code>TemplateView</code>. A CreateView will generate the form for free and it will be useful later on.</p>
<p>Replace contents of <code>shorturls/views.py</code> with:</p>
<div class="codehilite"><pre><span class="kn">from</span> <span class="nn">django.views.generic.edit</span> <span class="kn">import</span> <span class="n">CreateView</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Link</span>

<span class="k">class</span> <span class="nc">LinkCreate</span><span class="p">(</span><span class="n">CreateView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Link</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">"url"</span><span class="p">]</span>
</pre></div>


<p>Create <code>shorturls/templates/shorturls/link_form.html</code>:</p>
<div class="codehilite"><pre><span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>{% csrf_token %}
{{ form.as_p }}
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Shorten"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div>


<p>Replace contents of <code>tiny/urls.py</code> with:</p>
<div class="codehilite"><pre><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">include</span><span class="p">,</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">shorturls.views</span> <span class="kn">import</span> <span class="n">LinkCreate</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">''</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^$'</span><span class="p">,</span> <span class="n">LinkCreate</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">'home'</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>


<p>Now the test should pass.</p>
<h3 id="fourth-test-form-returns-a-short-url">Fourth Test: Form Returns a Short <span class="caps">URL</span></h3>
<p>Add to <code>shorturls/tests.py</code>:</p>
<div class="codehilite"><pre><span class="k">def</span> <span class="nf">test_shortener_form</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Tests that submitting the forms returns a Link object.</span>
<span class="sd">    """</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s">"http://example.com/"</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s">"home"</span><span class="p">),</span>
                                <span class="p">{</span><span class="s">"url"</span><span class="p">:</span> <span class="n">url</span><span class="p">},</span> <span class="n">follow</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">"link"</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s">"link"</span><span class="p">]</span>
    <span class="n">short_url</span> <span class="o">=</span> <span class="n">Link</span><span class="o">.</span><span class="n">shorten</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">short_url</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</pre></div>


<p>(This test is designed to work with Django URLField’s default behaviour to add trailing slashes. This needs to be agreed with your client, of course. In my case, I simply had to ask the mirror.)</p>
<p>Now we need to think of what gets shown when the form is submitted. Obviously, there would be the short <span class="caps">URL</span>. Once again we can use a ready made class based view for this - the <code>DetailView</code>.</p>
<p>Add to <code>shorturls/views.py</code>:</p>
<div class="codehilite"><pre><span class="kn">from</span> <span class="nn">django.views.generic</span> <span class="kn">import</span> <span class="n">DetailView</span>
<span class="o">...</span>

<span class="k">class</span> <span class="nc">LinkCreate</span><span class="p">(</span><span class="n">CreateView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Link</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">"url"</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="c"># Check if the Link object already exists</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">Link</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prev</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">"link_show"</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">prev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">LinkCreate</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">LinkShow</span><span class="p">(</span><span class="n">DetailView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Link</span>
</pre></div>


<p>Change <code>tiny/urls.py</code> to:</p>
<div class="codehilite"><pre><span class="kn">from</span> <span class="nn">shorturls.views</span> <span class="kn">import</span> <span class="n">LinkCreate</span>
<span class="kn">from</span> <span class="nn">shorturls.views</span> <span class="kn">import</span> <span class="n">LinkShow</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">''</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^$'</span><span class="p">,</span> <span class="n">LinkCreate</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">'home'</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^link/(?P&lt;pk&gt;\d+)$'</span><span class="p">,</span> <span class="n">LinkShow</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">'link_show'</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>


<p>Now add the template for the <code>DetailView</code>. Create <code>shorturls/templates/shorturls/link_detail.html</code> with the following contents:</p>
<div class="codehilite"><pre><span class="nt">&lt;p&gt;</span> Short Link: /r/{{ object.id }}
<span class="nt">&lt;p&gt;</span> Original Link: {{ object.url }}
</pre></div>


<p>Note that we haven’t created the short link redirection code for <code>/r/</code> yet.</p>
<p>Only hitch we have now is that Django doesn’t know where to go after the form is submitted. One way to solve that is by adding <code>get_absolute_url()</code> to the <code>Link</code> model.</p>
<p>Change <code>shorturls/models.py</code> to:</p>
<div class="codehilite"><pre><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.core.urlresolvers</span> <span class="kn">import</span> <span class="n">reverse</span>

<span class="k">class</span> <span class="nc">Link</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_absolute_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span><span class="s">"link_show"</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s">"pk"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">})</span>
</pre></div>


<p>Now if the form is submitted, it gets redirected to the new <code>DetailView</code>. The tests should pass.</p>
<h3 id="fifth-test-short-url-must-redirect-to-the-long-url">Fifth Test: Short <span class="caps">URL</span> Must Redirect To The Long <span class="caps">URL</span></h3>
<p>Our next and final test actually tests if the short URLs work:</p>
<div class="codehilite"><pre><span class="k">def</span> <span class="nf">test_redirect_to_long_link</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Tests that submitting the forms returns a Link object.</span>
<span class="sd">    """</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s">"http://example.com"</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">Link</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">)</span>        
    <span class="n">short_url</span> <span class="o">=</span> <span class="n">Link</span><span class="o">.</span><span class="n">shorten</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="n">reverse</span><span class="p">(</span><span class="s">"redirect_short_url"</span><span class="p">,</span>
                <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s">"short_url"</span><span class="p">:</span> <span class="n">short_url</span><span class="p">}))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertRedirects</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
</pre></div>


<p>The final bit of the puzzle is the reverse lookup or redirected the user with the short <span class="caps">URL</span> to the original <span class="caps">URL</span>. As you might have guessed, time for yet another class based view - <code>RedirectView</code>.</p>


<p>Add to <code>shorturls/views.py</code>:</p>
<div class="codehilite"><pre><span class="kn">from</span> <span class="nn">django.views.generic.base</span> <span class="kn">import</span> <span class="n">RedirectView</span>
<span class="o">...</span>

<span class="k">class</span> <span class="nc">RedirectToLongURL</span><span class="p">(</span><span class="n">RedirectView</span><span class="p">):</span>

    <span class="n">permanent</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">get_redirect_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">short_url</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">"short_url"</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">Link</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">short_url</span><span class="p">)</span>
</pre></div>


<p>Add to <code>tiny/urls.py</code>:</p>
<div class="codehilite"><pre><span class="kn">from</span> <span class="nn">shorturls.views</span> <span class="kn">import</span> <span class="n">RedirectToLongURL</span>
<span class="o">...</span>

    <span class="n">url</span><span class="p">(</span><span class="s">r'^r/(?P&lt;short_url&gt;\w+)$'</span><span class="p">,</span> <span class="n">RedirectToLongURL</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span>
              <span class="n">name</span><span class="o">=</span><span class="s">'redirect_short_url'</span><span class="p">),</span>
</pre></div>


<p>Now the tests should pass.</p>
<h3 id="refactoring-for-shorter-urls">Refactoring For Shorter URLs</h3>
<p>We will now see how tests prevent regression. The short URLs we generate are nothing but primary keys of Link instances in the database. This scheme works swimmingly well until a smart guy notices that we are wasting too many characters compared to other <span class="caps">URL</span> shorteners.</p>
<p>A shortener like bit.ly creates short urls which are a mix of alphabets (lower and upper case), numbers and symbols (like hyphens and underscores). However, we use only numbers. Mathematically speaking, we can use a base higher than 10 if we have more than ten symbols. This can lead to shorter numbers. For e.g. the decimal “255” can be represented as “<span class="caps">FF</span>” in hexadecimal, which saved 1 byte!</p>
<p>Notice that we have deliberately avoided testing the short <span class="caps">URL</span> format. This gives us flexibility to use any short <span class="caps">URL</span> representation we like and we are not limited to just decimals. So we create a module which can convert a decimal to a higher base with more symbols and back.</p>
<p>Create a new file <code>shorturls/basechanger.py</code> with the following contents:</p>
<div class="codehilite"><pre><span class="n"><span class="caps">CHARS</span></span> <span class="o">=</span> <span class="s">"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGUIJKLMNOPQRSTUVWXYZ"</span>
<span class="n"><span class="caps">BASE</span></span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n"><span class="caps">CHARS</span></span><span class="p">)</span>

<span class="k">def</span> <span class="nf">decimal2base_n</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="n"><span class="caps">BASE</span></span><span class="p">:</span>
        <span class="k">return</span> <span class="n">decimal2base_n</span><span class="p">(</span><span class="n">n</span> <span class="o">//</span> <span class="n"><span class="caps">BASE</span></span><span class="p">)</span> <span class="o">+</span> <span class="n"><span class="caps">CHARS</span></span><span class="p">[</span><span class="n">n</span> <span class="o">%</span> <span class="n"><span class="caps">BASE</span></span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n"><span class="caps">CHARS</span></span><span class="p">[</span><span class="n">n</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">base_n2decimal</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">base_n2decimal</span><span class="p">(</span><span class="n">n</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n"><span class="caps">BASE</span></span> <span class="o">+</span> <span class="n"><span class="caps">CHARS</span></span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n"><span class="caps">CHARS</span></span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>


<p>If you suspect anything wrong, just play along ;) . Since all the <span class="caps">URL</span> shortening and expansion logic resides in the models (as it should), we need to change that as well.</p>
<p>Change <code>shorturls/models.py</code> to:</p>
<div class="codehilite"><pre><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.core.urlresolvers</span> <span class="kn">import</span> <span class="n">reverse</span>
<span class="kn">from</span> <span class="nn">.basechanger</span> <span class="kn">import</span> <span class="n">decimal2base_n</span><span class="p">,</span> <span class="n">base_n2decimal</span>

<span class="k">class</span> <span class="nc">Link</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_absolute_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span><span class="s">"link_show"</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s">"pk"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">})</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">shorten</span><span class="p">(</span><span class="n">link</span><span class="p">):</span>
        <span class="n">l</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Link</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">link</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">decimal2base_n</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">pk</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">expand</span><span class="p">(</span><span class="n">slug</span><span class="p">):</span>
        <span class="n">link_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">base_n2decimal</span><span class="p">(</span><span class="n">slug</span><span class="p">))</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">Link</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">link_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">url</span>
</pre></div>


<p>Now running your tests should work as if nothing happened. Your smart guy will be pleased that the short URLs are now shorter. It is a win-win, folks!</p>
<p>Note that we have not removed the hard-coded short <span class="caps">URL</span> path in our <code>DetailView</code> template. Let’s do that as well.</p>
<p>First, add a method to <code>shorturls/models.py</code>:</p>
<div class="codehilite"><pre><span class="k">def</span> <span class="nf">short_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span><span class="s">"redirect_short_url"</span><span class="p">,</span>
                   <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s">"short_url"</span><span class="p">:</span> <span class="n">Link</span><span class="o">.</span><span class="n">shorten</span><span class="p">(</span><span class="bp">self</span><span class="p">)})</span>
</pre></div>


<p>Change <code>shorturls/templates/shorturls/link_detail.html</code>:</p>
<div class="codehilite"><pre><span class="nt">&lt;p&gt;</span> Short Link: <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{{ object.short_url }}"</span><span class="nt">&gt;</span>{{ object.short_url }}<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;p&gt;</span> Original Link: {{ object.url }}
</pre></div>


<h3 id="subtle-bug-more-tests-needed">Subtle Bug: More Tests Needed</h3>
<p>Everything goes great for a while until user testing, when you get a strange bug report:</p>
<blockquote>
<p><strong>Critical</strong>: Some short URLs get redirected to the wrong site.</p>
</blockquote>
<p>By following <span class="caps">TDD</span>, the only way to fix your code would be to create a test to reproduce your bug. Since the problem only happens after a certain number of short URLs are created, you design a test to create a large number of short URLs and compare it with the original <span class="caps">URL</span>.</p>
<p>Add a new test case to <code>shorturls/tests.py</code>:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">random</span><span class="o">,</span> <span class="nn">string</span>
<span class="o">...</span>

<span class="k">def</span> <span class="nf">test_recover_link_n_times</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Tests multiple times that after shortening and expanding</span>
<span class="sd">    the original url is recovered.</span>
<span class="sd">    """</span>
    <span class="n"><span class="caps">TIMES</span></span> <span class="o">=</span> <span class="mi">100</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n"><span class="caps">TIMES</span></span><span class="p">):</span>
        <span class="n">uri</span> <span class="o">=</span> <span class="s">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">"https://example.com/{}/{}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">uri</span><span class="p">)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">Link</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">)</span>
        <span class="n">short_url</span> <span class="o">=</span> <span class="n">Link</span><span class="o">.</span><span class="n">shorten</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="n">long_url</span> <span class="o">=</span> <span class="n">Link</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">short_url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">long_url</span><span class="p">)</span>
</pre></div>


<p>Running the test gives you a mysterious error.</p>
<div class="codehilite"><pre><span class="go">AssertionError: 'https://example.com/55/KPAOz' != u'https://example.com/42/mDcHw'</span>
</pre></div>


<p>The hint of what is wrong is in the URLs themselves. After running a debugger, you realise that the 55th character is same as the 42nd character - the symbol ‘H’. A simple typo that was actually overlooked when I was writing this article.</p>
<p>I learnt two lessons from this. First, to never underestimate testing. The more tests you can write, the better your code becomes. Second, to never attempt to list the alphabets by hand. We are no longer in kindergarten and we are certainly not expected to remember all of it. That’s why Python has <code>string</code> module with such silly strings kept ready for you.</p>
<p>So the fix is a simple change in the first line of <code>shorturls/basechanger.py</code>:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">string</span>
<span class="n"><span class="caps">CHARS</span></span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="o">+</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span><span class="o">+</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span>
</pre></div>


<p>So once again, we have a 100% success rate in our tests.</p>
<p>The completed source code can be found at <a href="https://github.com/arocks/tiny">Github</a></p>
<h3 id="so-whats-wrong-with-tdd">So What’s Wrong With <span class="caps">TDD</span>?</h3>


<p>The biggest problem I faced while learning <span class="caps">TDD</span> was wearing two different hats alternatingly. The Tester Hat first makes you think the most specific way to break your code and the Code Hat wants you to write terse code that works in the most general way possible. Perhaps, after some practice, the cognitive load was greatly reduced. But, I would leave you with this pithy statement for some thought:</p>
<blockquote>
<p><span class="dquo">“</span>Debugging is twice as hard as writing the code in the first place. Therefore, if 
you write the code as cleverly as possible, you are, by definition, not smart 
enough to debug it.” — Brian Kernighan﻿</p>
</blockquote>
<p>Of course, <span class="caps">TDD</span> practitioners themselves ackowledge that <span class="caps">TDD</span> is not for exploratory programming. In other words, you cannot create a map if you don’t know where you are or where you want to go. It is also expected that you have a certain amount of expertise in the language (in this case, Python/Django), to clearly see how the test case should be written in advance. So I wouldn’t expect a beginner to learn <span class="caps">TDD</span> along with learning programming.</p>
<p>It, of course, goes without saying due to its counter intuitive nature, it takes some time to get comfortable with <span class="caps">TDD</span>.</p>
<h1 id="conclusion">Conclusion</h1>
<p><span class="caps">TDD</span> is a design technique that needs a little bit of extra time for planning ahead. Some <a href="http://research.microsoft.com/en-us/groups/ese/nagappan_tdd.pdf">studies</a> put this between 15-35% increase in development time. So, I wouldn’t use it for one time scripts or a quick work. But I will strongly consider it whenever I need to build production quality sites.</p>
<p>I might also not consider it for version 1 of something that I am working on. Maybe version 2 onwards, when the development will get faster and I am more familiar with the domain.</p>
<p>It doesn’t necessarily improve the client’s experience. If they are more interested in development time rather than the quality of code, then they might not appreciate <span class="caps">TDD</span> designed code itself. This is when <a href="http://en.wikipedia.org/wiki/Behavior-driven_development"><span class="caps">BDD</span></a> is much more effective in engaging them and “showcasing” the effectiveness of the methodology.</p>
<p>Django tests are pretty fast. So I am not too slowed down by the runs. I work on the models first, then the views, then the system tests and finally the templates. I prefer smaller, faster, non-redundant, black-boxy and functionality-oriented tests. Perhaps you want to read that again. It takes a while to design a good test case.</p>
<p>However, <a href="http://pytest.org/">Pytest</a> is a better option without learning all the legacy JUnit functions. It is a <a href="http://pydanny.com/pytest-no-boilerplate-testing.html">lot better</a> that the default Django testing tool and I would prefer to use Pytest as my default test runner.</p>
<p><span class="caps">TDD</span> relies on the inherent human nature to fix things. Writing tests are important but not essential. We might forget them. <span class="caps">TDD</span> will actually show a ‘broken’ status if any test fails, this is a great incentive to fix tests.</p>
<p>I tend to make a lot of design decisions while writing test cases. This is a good side effect of <span class="caps">TDD</span>. Lot of corner case which are missed while coding get importance upfront and by the time you are coding you are aware of them, rather than other way around. This is why the design is better for <span class="caps">TDD</span>.</p>
<p>It takes a lot of time to be good at <span class="caps">TDD</span>.</p>
  </div>

    </div></body></html>