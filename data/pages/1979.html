<html><body><div><div class="section" id="first-attempt">
<h2>First Attempt</h2>
<p>Like I did in my <a class="reference external" href="http://pbpython.com/simple-graphing-pandas.html">previous article</a>, I am using an IPython notebook to test out my solution.
If you would like to follow along, here are <a class="reference external" href="http://pbpython.com/extras/sample-address-1.xlsx">sample-address-1</a> and <a class="reference external" href="http://pbpython.com/extras/sample-address-2.xlsx">sample-address-2</a></p>
<p>The first step, is my normal imports:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
</pre></div>
<p>Next, read in both of our excel files into dataframes</p>
<div class="highlight"><pre><span class="n">df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s">'sample-address-1.xlsx'</span><span class="p">,</span> <span class="s">'Sheet1'</span><span class="p">,</span> <span class="n">na_values</span><span class="o">=</span><span class="p">[</span><span class="s">'NA'</span><span class="p">])</span>
<span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s">'sample-address-2.xlsx'</span><span class="p">,</span> <span class="s">'Sheet1'</span><span class="p">,</span> <span class="n">na_values</span><span class="o">=</span><span class="p">[</span><span class="s">'NA'</span><span class="p">])</span>
</pre></div>
<p>Order by account number and reindex so that it stays this way.</p>
<div class="highlight"><pre><span class="n">df1</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s">"account number"</span><span class="p">)</span>
<span class="n">df1</span><span class="o">=</span><span class="n">df1</span><span class="o">.</span><span class="n">reindex</span><span class="p">()</span>
<span class="n">df2</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s">"account number"</span><span class="p">)</span>
<span class="n">df2</span><span class="o">=</span><span class="n">df2</span><span class="o">.</span><span class="n">reindex</span><span class="p">()</span>
</pre></div>
<p>Create a diff function to show what the changes are.</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">report_diff</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="s">'{} ---&gt; {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
</pre></div>
<p>Merge the two datasets together in a <code class="code">
Panel</code>
. I will admit that I haven’t fully
grokked the panel concept yet but the only way to learn is to keep pressing on!</p>
<div class="highlight"><pre><span class="n">diff_panel</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Panel</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">df1</span><span class="o">=</span><span class="n">df1</span><span class="p">,</span><span class="n">df2</span><span class="o">=</span><span class="n">df2</span><span class="p">))</span>
</pre></div>
<p>Once the data is in a panel, we use the <code class="code">
report_diff</code>
 function to highlight all the changes.
I think this is a very intuitive way (for this data set) to show changes. It is relatively simple
to see what the old value is and the new one. For example, someone could easily check and see why
that postal code changed for account number 880043.</p>
<div class="highlight"><pre><span class="n">diff_output</span> <span class="o">=</span> <span class="n">diff_panel</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">report_diff</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">diff_output</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
<div>
<table border="1" class="dataframe">
<thead>
<tr>
<th/>
<th>account number</th>
<th>name</th>
<th>street</th>
<th>city</th>
<th>state</th>
<th>postal code</th>
</tr>
</thead>
<tbody>
<tr>
<th>95</th>
<td> 677936</td>
<td>  Hodkiewicz-Koch</td>
<td>    604 Lemke Knoll Suite 661</td>
<td>     East Laurence</td>
<td> Wisconsin</td>
<td>            98576</td>
</tr>
<tr>
<th>96</th>
<td> 880043</td>
<td>       Beatty Inc</td>
<td> 3641 Schaefer Isle Suite 171</td>
<td> North Gardnertown</td>
<td>   Wyoming</td>
<td> 64318 —-&gt; 64918</td>
</tr>
<tr>
<th>97</th>
<td> 899885</td>
<td> Kessler and Sons</td>
<td>   356 Johnson Isle Suite 991</td>
<td>        Casiehaven</td>
<td>   Wyoming</td>
<td>            37996</td>
</tr>
<tr>
<th>98</th>
<td> 704567</td>
<td>     Yundt-Abbott</td>
<td>           8338 Sauer Highway</td>
<td>         Jennyfort</td>
<td>   Wyoming</td>
<td>            19932</td>
</tr>
<tr>
<th>99</th>
<td> 880729</td>
<td>        Huels <span class="caps">PLC</span></td>
<td>   695 Labadie Lakes Apt. 256</td>
<td>       Port Orland</td>
<td>   Wyoming</td>
<td>            42977</td>
</tr>
</tbody>
</table>
</div><p>One of the things we want to do is flag rows that have changes so it is
easier to see the changes. We will create a <code class="code">
has_change</code>
 function and
use <code class="code">
apply</code>
 to run the function against each row.</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">has_change</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="k">if</span> <span class="s">"---&gt;"</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">to_string</span><span class="p">():</span>
        <span class="k">return</span> <span class="s">"Y"</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">"N"</span>


<span class="n">diff_output</span><span class="p">[</span><span class="s">'has_change'</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff_output</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">has_change</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">diff_output</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
<div>
<table border="1" class="dataframe">
<thead>
<tr>
<th/>
<th>account number</th>
<th>name</th>
<th>street</th>
<th>city</th>
<th>state</th>
<th>postal code</th>
<th>has_change</th>
</tr>
</thead>
<tbody>
<tr>
<th>95</th>
<td> 677936</td>
<td>  Hodkiewicz-Koch</td>
<td>    604 Lemke Knoll Suite 661</td>
<td>     East Laurence</td>
<td> Wisconsin</td>
<td>            98576</td>
<td> N</td>
</tr>
<tr>
<th>96</th>
<td> 880043</td>
<td>       Beatty Inc</td>
<td> 3641 Schaefer Isle Suite 171</td>
<td> North Gardnertown</td>
<td>   Wyoming</td>
<td> 64318 —-&gt; 64918</td>
<td> Y</td>
</tr>
<tr>
<th>97</th>
<td> 899885</td>
<td> Kessler and Sons</td>
<td>   356 Johnson Isle Suite 991</td>
<td>        Casiehaven</td>
<td>   Wyoming</td>
<td>            37996</td>
<td> N</td>
</tr>
<tr>
<th>98</th>
<td> 704567</td>
<td>     Yundt-Abbott</td>
<td>           8338 Sauer Highway</td>
<td>         Jennyfort</td>
<td>   Wyoming</td>
<td>            19932</td>
<td> N</td>
</tr>
<tr>
<th>99</th>
<td> 880729</td>
<td>        Huels <span class="caps">PLC</span></td>
<td>   695 Labadie Lakes Apt. 256</td>
<td>       Port Orland</td>
<td>   Wyoming</td>
<td>            42977</td>
<td> N</td>
</tr>
</tbody>
</table>
</div><p>It is simple to show all the columns with a change:</p>
<div class="highlight"><pre><span class="n">diff_output</span><span class="p">[(</span><span class="n">diff_output</span><span class="o">.</span><span class="n">has_change</span> <span class="o">==</span> <span class="s">'Y'</span><span class="p">)]</span>
</pre></div>
<div>
<table border="1" class="dataframe">
<thead>
<tr>
<th/>
<th>account number</th>
<th>name</th>
<th>street</th>
<th>city</th>
<th>state</th>
<th>postal code</th>
<th>has_change</th>
</tr>
</thead>
<tbody>
<tr>
<th>24</th>
<td> 595932</td>
<td> Kuhic, Eichmann and West</td>
<td>          4059 Tobias Inlet —-&gt; 4059 Tobias St</td>
<td>             New Rylanfurt</td>
<td>       Illinois</td>
<td>            89271</td>
<td> Y</td>
</tr>
<tr>
<th>30</th>
<td> 558879</td>
<td>            Watsica Group</td>
<td> 95616 Enos Grove Suite 139 —-&gt; 829 Big street</td>
<td> West Atlas —-&gt; Smithtown</td>
<td> Iowa —-&gt; Ohio</td>
<td> 47419 —-&gt; 47919</td>
<td> Y</td>
</tr>
<tr>
<th>96</th>
<td> 880043</td>
<td>               Beatty Inc</td>
<td>                   3641 Schaefer Isle Suite 171</td>
<td>         North Gardnertown</td>
<td>        Wyoming</td>
<td> 64318 —-&gt; 64918</td>
<td> Y</td>
</tr>
</tbody>
</table>
</div><p>Finally, let’s write it out to an Excel file:</p>
<div class="highlight"><pre><span class="n">diff_output</span><span class="p">[(</span><span class="n">diff_output</span><span class="o">.</span><span class="n">has_change</span> <span class="o">==</span> <span class="s">'Y'</span><span class="p">)]</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s">'my-diff.xlsx'</span><span class="p">)</span>
</pre></div>
<p>Here is a simple program that does what I’ve just shown:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="c"># Define the diff function to show the changes in each field</span>
<span class="k">def</span> <span class="nf">report_diff</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="s">'{} ---&gt; {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>

<span class="c"># We want to be able to easily tell which rows have changes</span>
<span class="k">def</span> <span class="nf">has_change</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="k">if</span> <span class="s">"---&gt;"</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">to_string</span><span class="p">():</span>
        <span class="k">return</span> <span class="s">"Y"</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">"N"</span>

<span class="c"># Read in both excel files</span>
<span class="n">df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s">'sample-address-1.xlsx'</span><span class="p">,</span> <span class="s">'Sheet1'</span><span class="p">,</span> <span class="n">na_values</span><span class="o">=</span><span class="p">[</span><span class="s">'NA'</span><span class="p">])</span>
<span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s">'sample-address-2.xlsx'</span><span class="p">,</span> <span class="s">'Sheet1'</span><span class="p">,</span> <span class="n">na_values</span><span class="o">=</span><span class="p">[</span><span class="s">'NA'</span><span class="p">])</span>

<span class="c"># Make sure we order by account number so the comparisons work</span>
<span class="n">df1</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s">"account number"</span><span class="p">)</span>
<span class="n">df1</span><span class="o">=</span><span class="n">df1</span><span class="o">.</span><span class="n">reindex</span><span class="p">()</span>
<span class="n">df2</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s">"account number"</span><span class="p">)</span>
<span class="n">df2</span><span class="o">=</span><span class="n">df2</span><span class="o">.</span><span class="n">reindex</span><span class="p">()</span>

<span class="c"># Create a panel of the two dataframes</span>
<span class="n">diff_panel</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Panel</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">df1</span><span class="o">=</span><span class="n">df1</span><span class="p">,</span><span class="n">df2</span><span class="o">=</span><span class="n">df2</span><span class="p">))</span>

<span class="c">#Apply the diff function</span>
<span class="n">diff_output</span> <span class="o">=</span> <span class="n">diff_panel</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">report_diff</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c"># Flag all the changes</span>
<span class="n">diff_output</span><span class="p">[</span><span class="s">'has_change'</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff_output</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">has_change</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c">#Save the changes to excel but only include the columns we care about</span>
<span class="n">diff_output</span><span class="p">[(</span><span class="n">diff_output</span><span class="o">.</span><span class="n">has_change</span> <span class="o">==</span> <span class="s">'Y'</span><span class="p">)]</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s">'my-diff-1.xlsx'</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">"account number"</span><span class="p">,</span>
                                                      <span class="s">"name"</span><span class="p">,</span><span class="s">"street"</span><span class="p">,</span><span class="s">"city"</span><span class="p">,</span><span class="s">"state"</span><span class="p">,</span><span class="s">"postal code"</span><span class="p">])</span>
</pre></div>
</div>
<div class="section" id="second-attempt">
<h2>Second Attempt</h2>
<p>I will use a similar approach but build it out to show more details on the changes
and make the solution more robust for bigger data sets. Here are the data sets
for those interested: <a class="reference external" href="http://pbpython.com/extras/sample-address-new.xlsx">sample-address-new</a> and <a class="reference external" href="http://pbpython.com/extras/sample-address-old.xlsx">sample-address-old</a>.</p>
<p>Start with the standard imports.</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
</pre></div>
<p>We will define our <code class="code">
report_diff</code>
 function like we did in the previous exercise.</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">report_diff</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="s">'{} ---&gt; {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
</pre></div>
<p>Read in the values in the two different sheets</p>
<div class="highlight"><pre><span class="n">old</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s">'sample-address-old.xlsx'</span><span class="p">,</span> <span class="s">'Sheet1'</span><span class="p">,</span> <span class="n">na_values</span><span class="o">=</span><span class="p">[</span><span class="s">'NA'</span><span class="p">])</span>
<span class="n">new</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s">'sample-address-new.xlsx'</span><span class="p">,</span> <span class="s">'Sheet1'</span><span class="p">,</span> <span class="n">na_values</span><span class="o">=</span><span class="p">[</span><span class="s">'NA'</span><span class="p">])</span>
</pre></div>
<p>Label the two data sets so that when we combine them, we know which is which</p>
<div class="highlight"><pre><span class="n">old</span><span class="p">[</span><span class="s">'version'</span><span class="p">]</span> <span class="o">=</span> <span class="s">"old"</span>
<span class="n">new</span><span class="p">[</span><span class="s">'version'</span><span class="p">]</span> <span class="o">=</span> <span class="s">"new"</span>
</pre></div>
<p>We can look at the data to see what the format looks like and how many
records we ended up with.</p>

<div>
<table border="1" class="dataframe">
<thead>
<tr>
<th/>
<th>account number</th>
<th>name</th>
<th>street</th>
<th>city</th>
<th>state</th>
<th>postal code</th>
<th>version</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td> 935480</td>
<td>            Bruen and Jones Group</td>
<td>  5131 Nienow Viaduct Apt. 290</td>
<td>    Port Arlie</td>
<td>  Alabama</td>
<td> 14118</td>
<td> new</td>
</tr>
<tr>
<th>1</th>
<td> 371770</td>
<td>                Cruickshank-Boyer</td>
<td> 839 Lana Expressway Suite 234</td>
<td> South Viviana</td>
<td>  Alabama</td>
<td> 57838</td>
<td> new</td>
</tr>
<tr>
<th>2</th>
<td> 548367</td>
<td>        Spencer, Grady and Herman</td>
<td>    65387 Lang Circle Apt. 516</td>
<td> Greenholtbury</td>
<td>   Alaska</td>
<td> 58394</td>
<td> new</td>
</tr>
<tr>
<th>3</th>
<td> 132971</td>
<td> Williamson, Schumm and Hettinger</td>
<td>          89403 Casimer Spring</td>
<td>  Jeremieburgh</td>
<td> Arkansas</td>
<td>  6278</td>
<td> new</td>
</tr>
<tr>
<th>4</th>
<td> 985603</td>
<td>                      Bosco-Upton</td>
<td>                 89 Big Street</td>
<td>    Small Town</td>
<td>    Texas</td>
<td> 19033</td>
<td> new</td>
</tr>
</tbody>
</table>
</div>
<div>
<table border="1" class="dataframe">
<thead>
<tr>
<th/>
<th>account number</th>
<th>name</th>
<th>street</th>
<th>city</th>
<th>state</th>
<th>postal code</th>
<th>version</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td> 935480</td>
<td>                      Bruen Group</td>
<td>  5131 Nienow Viaduct Apt. 290</td>
<td>     Port Arlie</td>
<td>  Alabama</td>
<td> 14118</td>
<td> old</td>
</tr>
<tr>
<th>1</th>
<td> 371770</td>
<td>                Cruickshank-Boyer</td>
<td> 839 Lana Expressway Suite 234</td>
<td>  South Viviana</td>
<td>  Alabama</td>
<td> 57838</td>
<td> old</td>
</tr>
<tr>
<th>2</th>
<td> 548367</td>
<td>        Spencer, Grady and Herman</td>
<td>    65387 Lang Circle Apt. 516</td>
<td>  Greenholtbury</td>
<td>   Alaska</td>
<td> 58394</td>
<td> old</td>
</tr>
<tr>
<th>3</th>
<td> 296620</td>
<td>   Schamberger, Hagenes and Brown</td>
<td>     26340 Ferry Neck Apt. 612</td>
<td> McCulloughstad</td>
<td>   Alaska</td>
<td> 74052</td>
<td> old</td>
</tr>
<tr>
<th>4</th>
<td> 132971</td>
<td> Williamson, Schumm and Hettinger</td>
<td>          89403 Casimer Spring</td>
<td>   Jeremieburgh</td>
<td> Arkansas</td>
<td> 62785</td>
<td> old</td>
</tr>
</tbody>
</table>
</div>
<pre class="literal-block">
22
</pre>

<pre class="literal-block">
24
</pre>
<p>We will add all the data together into a new table</p>
<div class="highlight"><pre><span class="n">full_set</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">old</span><span class="p">,</span><span class="n">new</span><span class="p">],</span><span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
<p>As expected, the full set includes 46 records.</p>

<pre class="literal-block">
account number    46
name              46
street            46
city              46
state             46
postal code       46
version           46
dtype: int64
</pre>

<div>
<table border="1" class="dataframe">
<thead>
<tr>
<th/>
<th>account number</th>
<th>name</th>
<th>street</th>
<th>city</th>
<th>state</th>
<th>postal code</th>
<th>version</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td> 935480</td>
<td>                      Bruen Group</td>
<td>  5131 Nienow Viaduct Apt. 290</td>
<td>     Port Arlie</td>
<td>  Alabama</td>
<td> 14118</td>
<td> old</td>
</tr>
<tr>
<th>1</th>
<td> 371770</td>
<td>                Cruickshank-Boyer</td>
<td> 839 Lana Expressway Suite 234</td>
<td>  South Viviana</td>
<td>  Alabama</td>
<td> 57838</td>
<td> old</td>
</tr>
<tr>
<th>2</th>
<td> 548367</td>
<td>        Spencer, Grady and Herman</td>
<td>    65387 Lang Circle Apt. 516</td>
<td>  Greenholtbury</td>
<td>   Alaska</td>
<td> 58394</td>
<td> old</td>
</tr>
<tr>
<th>3</th>
<td> 296620</td>
<td>   Schamberger, Hagenes and Brown</td>
<td>     26340 Ferry Neck Apt. 612</td>
<td> McCulloughstad</td>
<td>   Alaska</td>
<td> 74052</td>
<td> old</td>
</tr>
<tr>
<th>4</th>
<td> 132971</td>
<td> Williamson, Schumm and Hettinger</td>
<td>          89403 Casimer Spring</td>
<td>   Jeremieburgh</td>
<td> Arkansas</td>
<td> 62785</td>
<td> old</td>
</tr>
</tbody>
</table>
</div>
<div>
<table border="1" class="dataframe">
<thead>
<tr>
<th/>
<th>account number</th>
<th>name</th>
<th>street</th>
<th>city</th>
<th>state</th>
<th>postal code</th>
<th>version</th>
</tr>
</thead>
<tbody>
<tr>
<th>41</th>
<td> 869125</td>
<td>                 Wiza <span class="caps">LLC</span></td>
<td>            9824 Noemi Harbors</td>
<td>     North Tristin</td>
<td>       Maine</td>
<td> 98114</td>
<td> new</td>
</tr>
<tr>
<th>42</th>
<td> 875910</td>
<td> Lowe, Tremblay and Bruen</td>
<td> 3722 Tatyana Springs Apt. 464</td>
<td>         Selmafurt</td>
<td> NorthDakota</td>
<td> 17496</td>
<td> new</td>
</tr>
<tr>
<th>43</th>
<td> 878977</td>
<td>                Swift <span class="caps">PLC</span></td>
<td>         5605 Hodkiewicz Views</td>
<td>        Summerfurt</td>
<td>     Vermont</td>
<td> 98029</td>
<td> new</td>
</tr>
<tr>
<th>44</th>
<td> 880043</td>
<td>               Beatty Inc</td>
<td>  3641 Schaefer Isle Suite 171</td>
<td> North Gardnertown</td>
<td>     Wyoming</td>
<td> 64318</td>
<td> new</td>
</tr>
<tr>
<th>45</th>
<td> 880729</td>
<td>                Huels <span class="caps">PLC</span></td>
<td>    695 Labadie Lakes Apt. 256</td>
<td>       Port Orland</td>
<td>     Wyoming</td>
<td> 42977</td>
<td> new</td>
</tr>
</tbody>
</table>
</div><p>We use <code class="code">
drop_duplicates</code>
 to get rid of the obvious columns where there has
not been any change. Note that we keep the last one using <code class="code">
take_last=True</code>
 so we can tell which
accounts have been removed in the new data set.</p>
<p>One interesting note about <code class="code">
drop_duplicates</code>
, you can specify which columns you care about. This
functionality is really useful if you have extra columns (say sales, or notes) that you expect to change
but don’t really care about for these purposes.</p>
<div class="highlight"><pre><span class="n">changes</span> <span class="o">=</span> <span class="n">full_set</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s">"account number"</span><span class="p">,</span><span class="s">"name"</span><span class="p">,</span><span class="s">"street"</span><span class="p">,</span><span class="s">"city"</span><span class="p">,</span><span class="s">"state"</span><span class="p">,</span><span class="s">"postal code"</span><span class="p">],</span><span class="n">take_last</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
<p>We have cut down our data set to 28 records.</p>

<pre class="literal-block">
28
</pre>
<p>Sort and take a look at what the data looks like. If you look at account number 132971, you
can get an idea for how the data is structured.</p>
<div class="highlight"><pre><span class="n">changes</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s">"account number"</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
<div>
<table border="1" class="dataframe">
<thead>
<tr>
<th/>
<th>account number</th>
<th>name</th>
<th>street</th>
<th>city</th>
<th>state</th>
<th>postal code</th>
<th>version</th>
</tr>
</thead>
<tbody>
<tr>
<th>27</th>
<td> 121213</td>
<td>                    Bauch-Goldner</td>
<td>       7274 Marissa Common</td>
<td> Shanahanchester</td>
<td> California</td>
<td> 49681</td>
<td> new</td>
</tr>
<tr>
<th>4 </th>
<td> 132971</td>
<td> Williamson, Schumm and Hettinger</td>
<td>      89403 Casimer Spring</td>
<td>    Jeremieburgh</td>
<td>   Arkansas</td>
<td> 62785</td>
<td> old</td>
</tr>
<tr>
<th>25</th>
<td> 132971</td>
<td> Williamson, Schumm and Hettinger</td>
<td>      89403 Casimer Spring</td>
<td>    Jeremieburgh</td>
<td>   Arkansas</td>
<td>  6278</td>
<td> new</td>
</tr>
<tr>
<th>28</th>
<td> 214098</td>
<td>      Goodwin, Homenick and Jerde</td>
<td> 649 Cierra Forks Apt. 078</td>
<td>        Rosaberg</td>
<td>   Colorado</td>
<td> 47743</td>
<td> new</td>
</tr>
<tr>
<th>3 </th>
<td> 296620</td>
<td>   Schamberger, Hagenes and Brown</td>
<td> 26340 Ferry Neck Apt. 612</td>
<td>  McCulloughstad</td>
<td>     Alaska</td>
<td> 74052</td>
<td> old</td>
</tr>
</tbody>
</table>
</div><p>Use the <code class="code">
get_duplicates</code>
 function to get a list of all the account
numbers which are duplicated.</p>
<div class="highlight"><pre><span class="n">dupe_accts</span> <span class="o">=</span> <span class="n">changes</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s">'account number'</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_duplicates</span><span class="p">()</span>
<span class="n">dupe_accts</span>
</pre></div>
<pre class="literal-block">
[132971, 935480, 985603]
</pre>
<p>Get a list of all the dupes into one frame using <code class="code">
isin</code>
.</p>
<div class="highlight"><pre><span class="n">dupes</span> <span class="o">=</span> <span class="n">changes</span><span class="p">[</span><span class="n">changes</span><span class="p">[</span><span class="s">"account number"</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">dupe_accts</span><span class="p">)]</span>
<span class="n">dupes</span>
</pre></div>
<div>
<table border="1" class="dataframe">
<thead>
<tr>
<th/>
<th>account number</th>
<th>name</th>
<th>street</th>
<th>city</th>
<th>state</th>
<th>postal code</th>
<th>version</th>
</tr>
</thead>
<tbody>
<tr>
<th>0 </th>
<td> 935480</td>
<td>                      Bruen Group</td>
<td> 5131 Nienow Viaduct Apt. 290</td>
<td>    Port Arlie</td>
<td>  Alabama</td>
<td> 14118</td>
<td> old</td>
</tr>
<tr>
<th>4 </th>
<td> 132971</td>
<td> Williamson, Schumm and Hettinger</td>
<td>         89403 Casimer Spring</td>
<td>  Jeremieburgh</td>
<td> Arkansas</td>
<td> 62785</td>
<td> old</td>
</tr>
<tr>
<th>5 </th>
<td> 985603</td>
<td>                      Bosco-Upton</td>
<td>                03369 Moe Way</td>
<td> Port Casandra</td>
<td> Arkansas</td>
<td> 86014</td>
<td> old</td>
</tr>
<tr>
<th>22</th>
<td> 935480</td>
<td>            Bruen and Jones Group</td>
<td> 5131 Nienow Viaduct Apt. 290</td>
<td>    Port Arlie</td>
<td>  Alabama</td>
<td> 14118</td>
<td> new</td>
</tr>
<tr>
<th>25</th>
<td> 132971</td>
<td> Williamson, Schumm and Hettinger</td>
<td>         89403 Casimer Spring</td>
<td>  Jeremieburgh</td>
<td> Arkansas</td>
<td>  6278</td>
<td> new</td>
</tr>
<tr>
<th>26</th>
<td> 985603</td>
<td>                      Bosco-Upton</td>
<td>                89 Big Street</td>
<td>    Small Town</td>
<td>    Texas</td>
<td> 19033</td>
<td> new</td>
</tr>
</tbody>
</table>
</div><p>We need two data frames of the same size so split them into a new and
old version.</p>
<div class="highlight"><pre><span class="n">change_new</span> <span class="o">=</span> <span class="n">dupes</span><span class="p">[(</span><span class="n">dupes</span><span class="p">[</span><span class="s">"version"</span><span class="p">]</span> <span class="o">==</span> <span class="s">"new"</span><span class="p">)]</span>
<span class="n">change_old</span> <span class="o">=</span> <span class="n">dupes</span><span class="p">[(</span><span class="n">dupes</span><span class="p">[</span><span class="s">"version"</span><span class="p">]</span> <span class="o">==</span> <span class="s">"old"</span><span class="p">)]</span>
</pre></div>
<p>Drop the version columns since we don’t need them any more.</p>
<div class="highlight"><pre><span class="n">change_new</span> <span class="o">=</span> <span class="n">change_new</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s">'version'</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">change_old</span> <span class="o">=</span> <span class="n">change_old</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s">'version'</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">change_old</span>
</pre></div>
<div>
<table border="1" class="dataframe">
<thead>
<tr>
<th/>
<th>account number</th>
<th>name</th>
<th>street</th>
<th>city</th>
<th>state</th>
<th>postal code</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td> 935480</td>
<td>                      Bruen Group</td>
<td> 5131 Nienow Viaduct Apt. 290</td>
<td>    Port Arlie</td>
<td>  Alabama</td>
<td> 14118</td>
</tr>
<tr>
<th>4</th>
<td> 132971</td>
<td> Williamson, Schumm and Hettinger</td>
<td>         89403 Casimer Spring</td>
<td>  Jeremieburgh</td>
<td> Arkansas</td>
<td> 62785</td>
</tr>
<tr>
<th>5</th>
<td> 985603</td>
<td>                      Bosco-Upton</td>
<td>                03369 Moe Way</td>
<td> Port Casandra</td>
<td> Arkansas</td>
<td> 86014</td>
</tr>
</tbody>
</table>
</div><p>Index on the account number.</p>
<div class="highlight"><pre><span class="n">change_new</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s">'account number'</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>

<div>
<table border="1" class="dataframe">
<thead>
<tr>
<th/>
<th>name</th>
<th>street</th>
<th>city</th>
<th>state</th>
<th>postal code</th>
</tr>
<tr>
<th>account number</th>
<th/>
<th/>
<th/>
<th/>
<th/>
</tr>
</thead>
<tbody>
<tr>
<th>935480</th>
<td>            Bruen and Jones Group</td>
<td> 5131 Nienow Viaduct Apt. 290</td>
<td>   Port Arlie</td>
<td>  Alabama</td>
<td> 14118</td>
</tr>
<tr>
<th>132971</th>
<td> Williamson, Schumm and Hettinger</td>
<td>         89403 Casimer Spring</td>
<td> Jeremieburgh</td>
<td> Arkansas</td>
<td>  6278</td>
</tr>
<tr>
<th>985603</th>
<td>                      Bosco-Upton</td>
<td>                89 Big Street</td>
<td>   Small Town</td>
<td>    Texas</td>
<td> 19033</td>
</tr>
</tbody>
</table>
</div><div class="highlight"><pre><span class="n">change_old</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s">'account number'</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>

<div>
<table border="1" class="dataframe">
<thead>
<tr>
<th/>
<th>name</th>
<th>street</th>
<th>city</th>
<th>state</th>
<th>postal code</th>
</tr>
<tr>
<th>account number</th>
<th/>
<th/>
<th/>
<th/>
<th/>
</tr>
</thead>
<tbody>
<tr>
<th>935480</th>
<td>                      Bruen Group</td>
<td> 5131 Nienow Viaduct Apt. 290</td>
<td>    Port Arlie</td>
<td>  Alabama</td>
<td> 14118</td>
</tr>
<tr>
<th>132971</th>
<td> Williamson, Schumm and Hettinger</td>
<td>         89403 Casimer Spring</td>
<td>  Jeremieburgh</td>
<td> Arkansas</td>
<td> 62785</td>
</tr>
<tr>
<th>985603</th>
<td>                      Bosco-Upton</td>
<td>                03369 Moe Way</td>
<td> Port Casandra</td>
<td> Arkansas</td>
<td> 86014</td>
</tr>
</tbody>
</table>
</div><p>Run our diff process like we did in our first attempt now that we have the data
structured in the way we need to.</p>
<div class="highlight"><pre><span class="n">diff_panel</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Panel</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">df1</span><span class="o">=</span><span class="n">change_old</span><span class="p">,</span><span class="n">df2</span><span class="o">=</span><span class="n">change_new</span><span class="p">))</span>
<span class="n">diff_output</span> <span class="o">=</span> <span class="n">diff_panel</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">report_diff</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">diff_output</span>
</pre></div>
<div>
<table border="1" class="dataframe">
<thead>
<tr>
<th/>
<th>name</th>
<th>street</th>
<th>city</th>
<th>state</th>
<th>postal code</th>
</tr>
<tr>
<th>account number</th>
<th/>
<th/>
<th/>
<th/>
<th/>
</tr>
</thead>
<tbody>
<tr>
<th>935480</th>
<td> Bruen Group —-&gt; Bruen and Jones Group</td>
<td>     5131 Nienow Viaduct Apt. 290</td>
<td>                    Port Arlie</td>
<td>             Alabama</td>
<td>            14118</td>
</tr>
<tr>
<th>132971</th>
<td>       Williamson, Schumm and Hettinger</td>
<td>             89403 Casimer Spring</td>
<td>                  Jeremieburgh</td>
<td>            Arkansas</td>
<td>  62785 —-&gt; 6278</td>
</tr>
<tr>
<th>985603</th>
<td>                            Bosco-Upton</td>
<td> 03369 Moe Way —-&gt; 89 Big Street</td>
<td> Port Casandra —-&gt; Small Town</td>
<td> Arkansas —-&gt; Texas</td>
<td> 86014 —-&gt; 19033</td>
</tr>
</tbody>
</table>
</div><p>Looks pretty good!</p>
<p>We know our diff, now we need to figure out which accounts were removed
in the new list. We need to find records from the “old” version that are no longer in the “new” version.</p>
<div class="highlight"><pre><span class="n">changes</span><span class="p">[</span><span class="s">'duplicate'</span><span class="p">]</span><span class="o">=</span><span class="n">changes</span><span class="p">[</span><span class="s">"account number"</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">dupe_accts</span><span class="p">)</span>
<span class="n">removed_accounts</span> <span class="o">=</span> <span class="n">changes</span><span class="p">[(</span><span class="n">changes</span><span class="p">[</span><span class="s">"duplicate"</span><span class="p">]</span> <span class="o">==</span> <span class="bp">False</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">changes</span><span class="p">[</span><span class="s">"version"</span><span class="p">]</span> <span class="o">==</span> <span class="s">"old"</span><span class="p">)]</span>
<span class="n">removed_accounts</span>
</pre></div>
<div>
<table border="1" class="dataframe">
<thead>
<tr>
<th/>
<th>account number</th>
<th>name</th>
<th>street</th>
<th>city</th>
<th>state</th>
<th>postal code</th>
<th>version</th>
<th>duplicate</th>
</tr>
</thead>
<tbody>
<tr>
<th>3</th>
<td> 296620</td>
<td> Schamberger, Hagenes and Brown</td>
<td> 26340 Ferry Neck Apt. 612</td>
<td> McCulloughstad</td>
<td> Alaska</td>
<td> 74052</td>
<td> old</td>
<td> False</td>
</tr>
</tbody>
</table>
</div><p>The final portion is figuring out which accounts are new.</p>
<p>We will go back to the full set and take only the first duplicate row.</p>
<div class="highlight"><pre><span class="n">new_account_set</span> <span class="o">=</span> <span class="n">full_set</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s">"account number"</span><span class="p">,</span><span class="s">"name"</span><span class="p">,</span><span class="s">"street"</span><span class="p">,</span><span class="s">"city"</span><span class="p">,</span><span class="s">"state"</span><span class="p">,</span><span class="s">"postal code"</span><span class="p">],</span><span class="n">take_last</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">new_account_set</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
<div>
<table border="1" class="dataframe">
<thead>
<tr>
<th/>
<th>account number</th>
<th>name</th>
<th>street</th>
<th>city</th>
<th>state</th>
<th>postal code</th>
<th>version</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td> 935480</td>
<td>                      Bruen Group</td>
<td>  5131 Nienow Viaduct Apt. 290</td>
<td>     Port Arlie</td>
<td>  Alabama</td>
<td> 14118</td>
<td> old</td>
</tr>
<tr>
<th>1</th>
<td> 371770</td>
<td>                Cruickshank-Boyer</td>
<td> 839 Lana Expressway Suite 234</td>
<td>  South Viviana</td>
<td>  Alabama</td>
<td> 57838</td>
<td> old</td>
</tr>
<tr>
<th>2</th>
<td> 548367</td>
<td>        Spencer, Grady and Herman</td>
<td>    65387 Lang Circle Apt. 516</td>
<td>  Greenholtbury</td>
<td>   Alaska</td>
<td> 58394</td>
<td> old</td>
</tr>
<tr>
<th>3</th>
<td> 296620</td>
<td>   Schamberger, Hagenes and Brown</td>
<td>     26340 Ferry Neck Apt. 612</td>
<td> McCulloughstad</td>
<td>   Alaska</td>
<td> 74052</td>
<td> old</td>
</tr>
<tr>
<th>4</th>
<td> 132971</td>
<td> Williamson, Schumm and Hettinger</td>
<td>          89403 Casimer Spring</td>
<td>   Jeremieburgh</td>
<td> Arkansas</td>
<td> 62785</td>
<td> old</td>
</tr>
</tbody>
</table>
</div><p>Add a duplicate column again.</p>
<div class="highlight"><pre><span class="n">new_account_set</span><span class="p">[</span><span class="s">'duplicate'</span><span class="p">]</span><span class="o">=</span><span class="n">new_account_set</span><span class="p">[</span><span class="s">"account number"</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">dupe_accts</span><span class="p">)</span>
<span class="n">new_account_set</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
<div>
<table border="1" class="dataframe">
<thead>
<tr>
<th/>
<th>account number</th>
<th>name</th>
<th>street</th>
<th>city</th>
<th>state</th>
<th>postal code</th>
<th>version</th>
<th>duplicate</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td> 935480</td>
<td>                      Bruen Group</td>
<td>  5131 Nienow Viaduct Apt. 290</td>
<td>     Port Arlie</td>
<td>  Alabama</td>
<td> 14118</td>
<td> old</td>
<td>  True</td>
</tr>
<tr>
<th>1</th>
<td> 371770</td>
<td>                Cruickshank-Boyer</td>
<td> 839 Lana Expressway Suite 234</td>
<td>  South Viviana</td>
<td>  Alabama</td>
<td> 57838</td>
<td> old</td>
<td> False</td>
</tr>
<tr>
<th>2</th>
<td> 548367</td>
<td>        Spencer, Grady and Herman</td>
<td>    65387 Lang Circle Apt. 516</td>
<td>  Greenholtbury</td>
<td>   Alaska</td>
<td> 58394</td>
<td> old</td>
<td> False</td>
</tr>
<tr>
<th>3</th>
<td> 296620</td>
<td>   Schamberger, Hagenes and Brown</td>
<td>     26340 Ferry Neck Apt. 612</td>
<td> McCulloughstad</td>
<td>   Alaska</td>
<td> 74052</td>
<td> old</td>
<td> False</td>
</tr>
<tr>
<th>4</th>
<td> 132971</td>
<td> Williamson, Schumm and Hettinger</td>
<td>          89403 Casimer Spring</td>
<td>   Jeremieburgh</td>
<td> Arkansas</td>
<td> 62785</td>
<td> old</td>
<td>  True</td>
</tr>
</tbody>
</table>
</div><p>We want to find the accounts that aren’t duplicated and are only in the new data set.</p>
<div class="highlight"><pre><span class="n">added_accounts</span> <span class="o">=</span> <span class="n">new_account_set</span><span class="p">[(</span><span class="n">new_account_set</span><span class="p">[</span><span class="s">"duplicate"</span><span class="p">]</span> <span class="o">==</span> <span class="bp">False</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">new_account_set</span><span class="p">[</span><span class="s">"version"</span><span class="p">]</span> <span class="o">==</span> <span class="s">"new"</span><span class="p">)]</span>
</pre></div>
<p>Let’s look at all the new accounts we have added:</p>

<div>
<table border="1" class="dataframe">
<thead>
<tr>
<th/>
<th>account number</th>
<th>name</th>
<th>street</th>
<th>city</th>
<th>state</th>
<th>postal code</th>
<th>version</th>
<th>duplicate</th>
</tr>
</thead>
<tbody>
<tr>
<th>27</th>
<td> 121213</td>
<td>                 Bauch-Goldner</td>
<td>       7274 Marissa Common</td>
<td> Shanahanchester</td>
<td> California</td>
<td> 49681</td>
<td> new</td>
<td> False</td>
</tr>
<tr>
<th>28</th>
<td> 214098</td>
<td>   Goodwin, Homenick and Jerde</td>
<td> 649 Cierra Forks Apt. 078</td>
<td>        Rosaberg</td>
<td>   Colorado</td>
<td> 47743</td>
<td> new</td>
<td> False</td>
</tr>
<tr>
<th>29</th>
<td> 566618</td>
<td> Greenfelder, Wyman and Harris</td>
<td>     17557 Romaguera Field</td>
<td>    South Tamica</td>
<td>   Colorado</td>
<td> 50037</td>
<td> new</td>
<td> False</td>
</tr>
</tbody>
</table>
</div><p>Finally we can save all of this into three different sheets in an Excel file.</p>
<div class="highlight"><pre><span class="n">writer</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="s">"my-diff-2.xlsx"</span><span class="p">)</span>
<span class="n">diff_output</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span><span class="s">"changed"</span><span class="p">)</span>
<span class="n">removed_accounts</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span><span class="s">"removed"</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">"account number"</span><span class="p">,</span>
                                         <span class="s">"name"</span><span class="p">,</span><span class="s">"street"</span><span class="p">,</span><span class="s">"city"</span><span class="p">,</span><span class="s">"state"</span><span class="p">,</span><span class="s">"postal code"</span><span class="p">])</span>
<span class="n">added_accounts</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span><span class="s">"added"</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">"account number"</span><span class="p">,</span>
                                         <span class="s">"name"</span><span class="p">,</span><span class="s">"street"</span><span class="p">,</span><span class="s">"city"</span><span class="p">,</span><span class="s">"state"</span><span class="p">,</span><span class="s">"postal code"</span><span class="p">])</span>
<span class="n">writer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
<p>Here is a full streamlined code example:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="c"># Define the diff function to show the changes in each field</span>
<span class="k">def</span> <span class="nf">report_diff</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="s">'{} ---&gt; {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>

<span class="c"># Read in the two files but call the data old and new and create columns to track</span>
<span class="n">old</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s">'sample-address-old.xlsx'</span><span class="p">,</span> <span class="s">'Sheet1'</span><span class="p">,</span> <span class="n">na_values</span><span class="o">=</span><span class="p">[</span><span class="s">'NA'</span><span class="p">])</span>
<span class="n">new</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s">'sample-address-new.xlsx'</span><span class="p">,</span> <span class="s">'Sheet1'</span><span class="p">,</span> <span class="n">na_values</span><span class="o">=</span><span class="p">[</span><span class="s">'NA'</span><span class="p">])</span>
<span class="n">old</span><span class="p">[</span><span class="s">'version'</span><span class="p">]</span> <span class="o">=</span> <span class="s">"old"</span>
<span class="n">new</span><span class="p">[</span><span class="s">'version'</span><span class="p">]</span> <span class="o">=</span> <span class="s">"new"</span>

<span class="c">#Join all the data together and ignore indexes so it all gets added</span>
<span class="n">full_set</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">old</span><span class="p">,</span><span class="n">new</span><span class="p">],</span><span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c"># Let's see what changes in the main columns we care about</span>
<span class="n">changes</span> <span class="o">=</span> <span class="n">full_set</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s">"account number"</span><span class="p">,</span><span class="s">"name"</span><span class="p">,</span><span class="s">"street"</span><span class="p">,</span><span class="s">"city"</span><span class="p">,</span><span class="s">"state"</span><span class="p">,</span><span class="s">"postal code"</span><span class="p">],</span><span class="n">take_last</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c">#We want to know where the duplicate account numbers are, that means there have been changes</span>
<span class="n">dupe_accts</span> <span class="o">=</span> <span class="n">changes</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s">'account number'</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_duplicates</span><span class="p">()</span>

<span class="c">#Get all the duplicate rows</span>
<span class="n">dupes</span> <span class="o">=</span> <span class="n">changes</span><span class="p">[</span><span class="n">changes</span><span class="p">[</span><span class="s">"account number"</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">dupe_accts</span><span class="p">)]</span>

<span class="c">#Pull out the old and new data into separate dataframes</span>
<span class="n">change_new</span> <span class="o">=</span> <span class="n">dupes</span><span class="p">[(</span><span class="n">dupes</span><span class="p">[</span><span class="s">"version"</span><span class="p">]</span> <span class="o">==</span> <span class="s">"new"</span><span class="p">)]</span>
<span class="n">change_old</span> <span class="o">=</span> <span class="n">dupes</span><span class="p">[(</span><span class="n">dupes</span><span class="p">[</span><span class="s">"version"</span><span class="p">]</span> <span class="o">==</span> <span class="s">"old"</span><span class="p">)]</span>

<span class="c">#Drop the temp columns - we don't need them now</span>
<span class="n">change_new</span> <span class="o">=</span> <span class="n">change_new</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s">'version'</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">change_old</span> <span class="o">=</span> <span class="n">change_old</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s">'version'</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c">#Index on the account numbers</span>
<span class="n">change_new</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s">'account number'</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">change_old</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s">'account number'</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c">#Now we can diff because we have two data sets of the same size with the same index</span>
<span class="n">diff_panel</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Panel</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">df1</span><span class="o">=</span><span class="n">change_old</span><span class="p">,</span><span class="n">df2</span><span class="o">=</span><span class="n">change_new</span><span class="p">))</span>
<span class="n">diff_output</span> <span class="o">=</span> <span class="n">diff_panel</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">report_diff</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c">#Diff'ing is done, we need to get a list of removed items</span>

<span class="c">#Flag all duplicated account numbers</span>
<span class="n">changes</span><span class="p">[</span><span class="s">'duplicate'</span><span class="p">]</span><span class="o">=</span><span class="n">changes</span><span class="p">[</span><span class="s">"account number"</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">dupe_accts</span><span class="p">)</span>

<span class="c">#Identify non-duplicated items that are in the old version and did not show in the new version</span>
<span class="n">removed_accounts</span> <span class="o">=</span> <span class="n">changes</span><span class="p">[(</span><span class="n">changes</span><span class="p">[</span><span class="s">"duplicate"</span><span class="p">]</span> <span class="o">==</span> <span class="bp">False</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">changes</span><span class="p">[</span><span class="s">"version"</span><span class="p">]</span> <span class="o">==</span> <span class="s">"old"</span><span class="p">)]</span>

<span class="c"># We have the old and diff, we need to figure out which ones are new</span>

<span class="c">#Drop duplicates but keep the first item instead of the last</span>
<span class="n">new_account_set</span> <span class="o">=</span> <span class="n">full_set</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s">"account number"</span><span class="p">,</span><span class="s">"name"</span><span class="p">,</span><span class="s">"street"</span><span class="p">,</span><span class="s">"city"</span><span class="p">,</span><span class="s">"state"</span><span class="p">,</span><span class="s">"postal code"</span><span class="p">],</span><span class="n">take_last</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="c">#Identify dupes in this new dataframe</span>
<span class="n">new_account_set</span><span class="p">[</span><span class="s">'duplicate'</span><span class="p">]</span><span class="o">=</span><span class="n">new_account_set</span><span class="p">[</span><span class="s">"account number"</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">dupe_accts</span><span class="p">)</span>

<span class="c">#Identify added accounts</span>
<span class="n">added_accounts</span> <span class="o">=</span> <span class="n">new_account_set</span><span class="p">[(</span><span class="n">new_account_set</span><span class="p">[</span><span class="s">"duplicate"</span><span class="p">]</span> <span class="o">==</span> <span class="bp">False</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">new_account_set</span><span class="p">[</span><span class="s">"version"</span><span class="p">]</span> <span class="o">==</span> <span class="s">"new"</span><span class="p">)]</span>

<span class="c">#Save the changes to excel but only include the columns we care about</span>
<span class="n">writer</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="s">"my-diff-2.xlsx"</span><span class="p">)</span>
<span class="n">diff_output</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span><span class="s">"changed"</span><span class="p">)</span>
<span class="n">removed_accounts</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span><span class="s">"removed"</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">"account number"</span><span class="p">,</span>
                                         <span class="s">"name"</span><span class="p">,</span><span class="s">"street"</span><span class="p">,</span><span class="s">"city"</span><span class="p">,</span><span class="s">"state"</span><span class="p">,</span><span class="s">"postal code"</span><span class="p">])</span>
<span class="n">added_accounts</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span><span class="s">"added"</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">"account number"</span><span class="p">,</span>
                                         <span class="s">"name"</span><span class="p">,</span><span class="s">"street"</span><span class="p">,</span><span class="s">"city"</span><span class="p">,</span><span class="s">"state"</span><span class="p">,</span><span class="s">"postal code"</span><span class="p">])</span>
<span class="n">writer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
<p>Here is the final output excel file: <a class="reference external" href="http://pbpython.com/extras/my-diff-2.xlsx">my-diff-2</a></p>
</div>
</div></body></html>