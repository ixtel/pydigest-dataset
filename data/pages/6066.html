<html><body><div><div class="entry">
    <p><img src="/images/raspberry_pi/raspberry_pi.jpg" alt="raspberry_pi"/></p>

<p>What's cooler than controlling your TV with voice commands?<br/>
<strong>A billion dollars!</strong></p>

<p>But for this post,<br/>
it's controlling your TV with voice commands through <strong>Raspberry Pi!</strong><br/>
(and a billion dollars...)</p>

<p>So, down to business.</p>

<p>Full code can be found on <a href="https://github.com/kazuar/raspberrypi_voice_control">GitHub</a>.</p>

<h1>Hardware requirements:</h1>

<ol>
<li>TV set with enabled <a href="https://en.wikipedia.org/wiki/HDMI#CEC">HDMI-CEC</a> / Anynet+ (Samsung) - You'll have to check your own TV set and make sure that you enable the HDMI-CEC control.</li>
<li>Raspberry Pi - I recommend the <a href="http://www.amazon.com/gp/product/B00G1PNG54">CanaKit Raspberry Pi 2</a>. For this tutorial, the Raspberry Pi should be connected to the TV set via HDMI.</li>
<li>USB microphone - I used <a href="http://www.amazon.com/gp/product/B00IR8R7WQ">C-Media microphone USB</a> </li>
</ol>

<h1>Install usb microphone on Raspberry Pi</h1>

<p>It seems that just connecting the USB microphone is not enough with the Raspberry Pi, you actually have to enable it on the Raspberry Pi OS in order to use it:</p>

<p>1) Edit <strong>/etc/modprobe.d/alsa-base.conf</strong> with your favorite editor </p>

<p>1.1) Set the value <strong>options snd-usb-audio index=-2</strong> to be <strong>options snd-usb-audio index=0</strong><br/>
1.2) On the next line add: <strong>options snd_bcm2835 index=1</strong><br/></p>

<p>2) Reboot your Raspberry Pi</p>



<p>3) From the Raspberry Pi terminal, run <strong>lsusb</strong>.<br/> Make sure that you can see your device in the list (in my case "C-Media Electronics, Inc. CM108 Audio Controller"):</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">pi@raspberrypi ~ <span class="nv">$ </span>lsusb
Bus <span class="m">001</span> Device 002: ID 0424:9514 Standard Microsystems Corp.
Bus <span class="m">001</span> Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
Bus <span class="m">001</span> Device 003: ID 0424:ec00 Standard Microsystems Corp.
Bus <span class="m">001</span> Device 004: ID 148f:5370 Ralink Technology, Corp. RT5370 Wireless Adapter
Bus <span class="m">001</span> Device 005: ID 0781:5575 SanDisk Corp.
Bus <span class="m">001</span> Device 006: ID 0d8c:013c C-Media Electronics, Inc. CM108 Audio Controller
Bus <span class="m">001</span> Device 007: ID 046d:c31c Logitech, Inc. Keyboard K120 <span class="k">for</span> Business</code></pre></div>

<p>4) Run "<strong>cat /proc/asound/cards</strong>" and verify that your USB mic is set on device 0:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">pi@raspberrypi ~ <span class="nv">$ </span>cat /proc/asound/cards
 <span class="m">0</span> <span class="o">[</span>Device         <span class="o">]</span>: USB-Audio - USB PnP Sound Device
                      C-Media Electronics Inc. USB PnP Sound Device at usb-3f980000.usb-1.4, full spe
 <span class="m">1</span> <span class="o">[</span>ALSA           <span class="o">]</span>: bcm2835 - bcm2835 ALSA
                      bcm2835 ALSA</code></pre></div>

<h1>Install requirements (on the Raspberry Pi)</h1>

<h2>Install basics</h2>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">sudo apt-get install libcec-dev build-essential python-dev</code></pre></div>

<h2>Install pyaudio</h2>

<p>1) Clone the <a href="http://people.csail.mit.edu/hubert/git/pyaudio.git">pyaudio</a> git repository</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">git clone http://people.csail.mit.edu/hubert/git/pyaudio.git</code></pre></div>

<p>2) Go to the pyaudio folder and run the install command</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cd </span>pyaudio
sudo python setup.py install</code></pre></div>

<h2>Install flac</h2>

<p><a href="https://en.wikipedia.org/wiki/FLAC">Flac</a> is an audio compression format (like MP3).<br/>
If you don't have it, pyaudio will not be able to run.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">sudo apt-get install flac</code></pre></div>

<h1>Install required python modules</h1>

<p>Last step before creating our script is to install a few python packages.
I usually like to create <a href="http://docs.python-guide.org/en/latest/dev/virtualenvs/">virtual environments</a> for these projects.</p>

<p>In your virtual environment install the following packages:</p>

<ol>
<li><a href="https://pypi.python.org/pypi/SpeechRecognition/">Speechrecognition</a> - Library for performing speech recognition with the Google Speech Recognition API.</li>
<li><a href="https://people.csail.mit.edu/hubert/pyaudio/">pyaudio</a> - provides Python bindings for PortAudio, the cross-platform audio I/O library</li>
<li><a href="https://pypi.python.org/pypi/cec/0.2.3">python cec</a> - Python bindings for libcec. This will be used to control the TV through HDMI.</li>
</ol>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">pip install Speechrecognition
pip install --allow-external pyaudio --allow-unverified pyaudio pyaudio
pip install cec</code></pre></div>

<h1>Creating the script</h1>

<p>This is a very simple script, which performs the following steps:</p>

<ol>
<li>Initialize the required components</li>
<li>Start running an infinite loop until there's a stop command:

<ol>
<li>Record audio through the microphone</li>
<li>Translate the audio to text</li>
<li>Check if text contains a command</li>
<li>Perform the required command</li>
</ol></li>
</ol>

<h3>Step 1: Initialize required components</h3>

<p>We'll start by importing the required packages:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">cec</span>
<span class="kn">import</span> <span class="nn">speech_recognition</span> <span class="kn">as</span> <span class="nn">sr</span></code></pre></div>

<p>We need to define the commands that we want to use. For this example I chose the following commands:</p>

<ol>
<li>Turn the TV on</li>
<li>Turn the TV off</li>
<li>Close program</li>
</ol>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">TURN_TV_ON</span> <span class="o">=</span> <span class="s">"turn tv on"</span>
<span class="n">TURN_TV_OFF</span> <span class="o">=</span> <span class="s">"turn tv off"</span>
<span class="n">CLOSE_PROGRAM</span> <span class="o">=</span> <span class="s">"close program"</span></code></pre></div>

<p>Initialize CEC control</p>



<p>Create speech recognition object</p>



<h3>Step 2: Record and analyze audio</h3>

<p>In an infinite loop, record audio through the microphone</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">with</span> <span class="n">sr</span><span class="o">.</span><span class="n">Microphone</span><span class="p">()</span> <span class="k">as</span> <span class="n">source</span><span class="p">:</span>
    <span class="n">audio</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">source</span><span class="p">)</span></code></pre></div>

<p>Translate the audio to text</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">command</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recognize</span><span class="p">(</span><span class="n">audio</span><span class="p">)</span></code></pre></div>

<p>Check if the command is to turn the TV <strong>on</strong></p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">if</span> <span class="n">TURN_TV_ON</span> <span class="ow">in</span> <span class="n">command</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
    <span class="c"># Get tv device and turn it on</span>
    <span class="n">tv</span> <span class="o">=</span> <span class="n">cec</span><span class="o">.</span><span class="n">Device</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">tv</span><span class="o">.</span><span class="n">power_on</span><span class="p">()</span></code></pre></div>

<p>Check if the command is to turn the TV <strong>off</strong></p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">if</span> <span class="n">TURN_TV_OFF</span> <span class="ow">in</span> <span class="n">command</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
    <span class="c"># Get tv device and turn it off</span>
    <span class="n">tv</span> <span class="o">=</span> <span class="n">cec</span><span class="o">.</span><span class="n">Device</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">tv</span><span class="o">.</span><span class="n">standby</span><span class="p">()</span></code></pre></div>

<p>Check if the command is to stop the script</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">if</span> <span class="n">CLOSE_PROGRAM</span> <span class="ow">in</span> <span class="n">command</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
    <span class="c"># Stop program</span>
    <span class="k">break</span></code></pre></div>

<p>This is how the full code looks like:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">cec</span>
<span class="kn">import</span> <span class="nn">speech_recognition</span> <span class="kn">as</span> <span class="nn">sr</span>

<span class="n">TURN_TV_ON</span> <span class="o">=</span> <span class="s">"turn tv on"</span>
<span class="n">TURN_TV_OFF</span> <span class="o">=</span> <span class="s">"turn tv off"</span>
<span class="n">CLOSE_PROGRAM</span> <span class="o">=</span> <span class="s">"close program"</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c"># Create cec control</span>
    <span class="n">cec</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

    <span class="c"># Ceate speech recognizer object</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">sr</span><span class="o">.</span><span class="n">Recognizer</span><span class="p">()</span>

    <span class="c"># Create infinite loop</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="c"># Record sound</span>
        <span class="k">with</span> <span class="n">sr</span><span class="o">.</span><span class="n">Microphone</span><span class="p">()</span> <span class="k">as</span> <span class="n">source</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"Recording"</span><span class="p">)</span>
            <span class="n">audio</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c"># Try to recognize the audio</span>
            <span class="n">command</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recognize</span><span class="p">(</span><span class="n">audio</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"Detected speech:{0}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>
            <span class="c"># Check the current command</span>
            <span class="k">if</span> <span class="n">TURN_TV_ON</span> <span class="ow">in</span> <span class="n">command</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="c"># Get tv device and turn it on</span>
                <span class="n">tv</span> <span class="o">=</span> <span class="n">cec</span><span class="o">.</span><span class="n">Device</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">tv</span><span class="o">.</span><span class="n">power_on</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">TURN_TV_OFF</span> <span class="ow">in</span> <span class="n">command</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="c"># Get tv device and turn it off</span>
                <span class="n">tv</span> <span class="o">=</span> <span class="n">cec</span><span class="o">.</span><span class="n">Device</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">tv</span><span class="o">.</span><span class="n">standby</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">CLOSE_PROGRAM</span> <span class="ow">in</span> <span class="n">command</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="c"># Stop program</span>
                <span class="k">break</span>
        <span class="k">except</span> <span class="ne">LookupError</span><span class="p">:</span>
            <span class="c"># In case of an exception</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"Could not translate audio"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span></code></pre></div>

<p>If you run the script, you can say the commands and check in the script output if it was able to translate your speech correctly and run the correct command.</p>

<p>That's it!</p>

<p>Full code can be found on <a href="https://github.com/kazuar/raspberrypi_voice_control">GitHub</a>.</p>

<p>So, what's cooler than controlling your TV with voice commands?<br/>
A billion dollars!</p>

<p><img src="/images/raspberry_pi/billion.jpg" alt="billion"/></p>

  </div>

  </div></body></html>