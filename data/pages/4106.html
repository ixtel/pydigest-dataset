<html><body><div><div class="entry-content">
		<p>Early on at Sentry we set up Jenkins to automatically deploy after a passing build. Eventually we wanted better control over where we were deploying, and when (i.e. branch FOO to staging). To solve this we started with simple parameterized builds, and effectively had something working. Unfortunately when it came down to adding external controls we hit the age-old API issues within Jenkins itself.</p>

<h3 id="enter-freight">Enter Freight</h3>

<p>When we started going heads down on Sentry this year, it was a goal to make sure our tooling was functional and accessible. While we don’t want to invest a lot of time into those things, we want to ensure our day-to-day workflows are smooth. We started off by looking at what tools exist, and found things like GitHub’s <a href="https://github.com/atmos/heaven">Heaven</a>. Originally going down that path, we quickly (though reluctantly) decided we were better off writing our own, as we’re not rubyists, and some of the design decisions simply didn’t make sense for our security model.</p>

<p>Enter <a href="https://github.com/getsentry/freight">Freight</a>. Freight is heavily inspired by GitHub’s Heaven project, but it has a few key distinctions:</p>

<ul>
  <li>It’s not coupled to GitHub</li>
  <li>It can run entirely behind a firewall</li>
</ul>

<p>Beyond that there’s a lot of things in common, but at the core they’re both just task runners.</p>

<p><img src="/img/post-images/freight/freight-home.png" alt="Freight Deploy List" title="Deploy List"/></p>

<p><img src="/img/post-images/freight/freight-log.png" alt="Freight Deploy Log" title="Deploy Log"/></p>

<h3 id="a-simple-core">A Simple Core</h3>

<p>Just like Heaven, Freight is entirely focused on executing deploys, primarily through simple commands.</p>

<p>A few key things are already done for you:</p>

<ul>
  <li>Multiple apps and environments.</li>
  <li>Management of the source repository (unique per app).</li>
  <li>Basic workspace management (repository is copied over, and deploy is executed from new location).</li>
  <li>Abstractions for deploy provider, validation checks, and notifiers.</li>
</ul>

<p>In our case, we simply plug in our existing Fabric deploy scripts (using the Shell provider):</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
    </span><span class="nt">"command"</span><span class="p">:</span><span class="w"> </span><span class="s2">"bin/fab -a -i {ssh_key} -R {environment} {task}:sha={sha}"</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>Freight automatically fills these in with the appropriate values at runtime.</p>

<p>We’ve also bundled in checks for GitHub Context (we use <a href="https://circleci.com">CircleCI</a>), as well as notifications for <a href="https://slack.com/">Slack</a>.</p>

<h3 id="api-driven">API Driven</h3>

<p>Freight is an API-first project. It’s becoming what is the modern standard in reusable and accessible tooling. The choice allows us the ability to quickly whip up a React-based frontend, as well as integrations such as <a href="https://github.com/getsentry/hubot-freight">hubot-freight</a>:</p>

<p><img src="/img/post-images/freight/freight-hubot.png" alt="Freight Hubot Integration" title="Hubot Integration"/></p>

<p>We’ve also built out a very basic command line utility, <a href="https://github.com/getsentry/freight-cli">freight-cli</a>:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span>freight deploy --help
Usage: freight deploy <span class="o">[</span>OPTIONS] APP

Options:
  --env TEXT
  --ref TEXT
  -f, --force
  --help       Show this message and exit.

<span class="gp">$ </span>freight deploy getsentry --env staging
Created new Task with ID <span class="o">=</span> 404

<span class="gp">$ </span>freight tail 404
<span class="o">(</span>waiting <span class="k">for </span>output..<span class="o">)</span>
<span class="gp">&gt;&gt; </span>Check has passed: github
<span class="gp">&gt;&gt; </span>Running <span class="o">[</span><span class="s1">'git'</span>, <span class="s1">'fetch'</span>, <span class="s1">'--all'</span>, <span class="s1">'-p'</span><span class="o">]</span>
Fetching origin
Warning: Permanently added <span class="s1">'github.com,192.30.252.131'</span> <span class="o">(</span>RSA<span class="o">)</span> to the list of known hosts.
<span class="gp">&gt;&gt; </span>Running <span class="o">[</span><span class="s1">'git'</span>, <span class="s1">'clone'</span>, <span class="s1">'/tmp/freight-repo-1'</span>, <span class="s1">'/tmp/freight-workspace-70653104e33011e496e95a5015beb482'</span><span class="o">]</span>
Cloning into <span class="s1">'/tmp/freight-workspace-70653104e33011e496e95a5015beb482'</span>...
<span class="k">done</span>.</code></pre></figure>

<h3 id="an-early-preview">An Early Preview</h3>

<p>We’re huge believers in open source, and while Freight is fairly early, we’ve kept all of it’s development public. The source, as well as the intended goals are all <a href="https://github.com/getsentry/freight">available on GitHub</a>. While today the setup requires you to have a little bit of knowledge around how Python packages work, it’s fairly quick to run on Heroku.</p>

<p>It’s our hope to continue the open source tradition that started Sentry wherever possible, and developer services are the lifeblood of a lot of what we do. Give it a try and let us know what you think.</p>

	</div>
	</div></body></html>