<html><body><div><div class="blog-post-content">
    <p>TrackMaven has begun hosting a <a href="http://www.meetup.com/TrackMaven-Monthly-Challenge/">Monthly Challenge meetup</a>! Each month, we will name a general topic, a new technology, or something in between. We'll collect a few resources and examples to get everyone started (hence this post), then we'll meet up in a month to share short presentations on everyone's new projects.</p>
<p>Our first topic is <strong>Elasticsearch</strong>, an incredibly powerful search and analytics engine. Go <a href="http://www.elasticsearch.org/overview/elasticsearch">here</a> for a high level, buzzword-heavy overview, or just jump into <a href="http://www.elasticsearch.org/guide/en/elasticsearch/guide/current/">the documentation</a> if you're feeling bold.</p>
<p>Built on top of <a href="http://lucene.apache.org/core/">Lucene</a>, Elasticsearch is most frequently used to add full text search functionality; it comes out of the box with a rich query language that supports fuzzy matching and advanced <a href="http://lucene.apache.org/core/3_0_3/queryparsersyntax.html">parsing patterns</a>.</p>
<p>We'll go into the details of a sample project to get you started below. A few Elasticsearch-inspired possibilities for projects might be:</p>
<ul>
<li>Provide real-time text search over a large corpus (ie, some subset of <a href="http://www.gutenberg.org/">Project Gutenburg</a>, a bunch of product reviews, etc.)</li>
<li>Beyond search, <em>analysis</em> of a large set of text: determine similar authors based on vocabulary, compare word usage over time using Google Books data, or see what stands out in the language of spammy emails</li>
<li>Task logging and visualization of results with <a href="http://www.elasticsearch.org/overview/logstash/">Logstash</a> and <a href="http://www.elasticsearch.org/overview/kibana/">Kibana</a>, the Elasticsearch <a href="http://www.elasticsearch.org/webinars/introduction-elk-stack/">"ELK" stack</a></li>
<li>Data analyses using <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/search-aggregations.html">aggregations</a> on any sort of tabular data: financial records, movie reviews, census results...</li>
<li>Find unusual patterns in weather data or crime data by location</li>
<li>Create a better real-time Twitter search by combining Elasticsearch with NLP on Twitter's streaming API</li>
</ul>
<p>Elasticsearch communicates over a RESTful API using JSON. There are a <a href="http://www.elasticsearch.org/guide/en/elasticsearch/client/">large number of clients</a> to get you started in many different languages. We will be using the <a href="http://elasticsearch-py.readthedocs.org/en/master/">Python wrapper</a> in our examples, but there is also <a href="http://www.elasticsearch.org/guide/en/elasticsearch/client/javascript-api/current/quick-start.html">Elasticsearch.js</a> if that's more your style. You can also cURL POST data directly into Elasticsearch manually, although that may not scale well...</p>
<p>Let's get started! <a href="http://www.elasticsearch.org/download/">Download ES</a> and unpack it into a directory/project of your choice. You can then run:</p>
<p><code>/bin/elasticsearch</code></p>
<p>By default, Elasticsearch sits on port 9200. Once it's booted up, youÂ can visit:
http://localhost:9200/</p>
<p>in your browser and see something like:</p>
<div class="highlight"><pre>{
  "status" : 200,
  "name" : "Some Really Weird Name",
  "version" : {
    "number" : "1.3.4",
    "build_hash" : "a70f3ccb52200f8f2c87e9c370c6597448eb3e45",
    "build_timestamp" : "2014-11-01T09:07:17Z",
    "build_snapshot" : false,
    "lucene_version" : "4.9"
  },
  "tagline" : "You Know, for Search"
}
</pre></div>


<p>Now let's put some data in! Install the libraries <code>elasticsearch</code> and <code>requests</code>:</p>
<div class="highlight"><pre>pip install elasticsearch requests
</pre></div>


<p>You can then run this demo script to load in the top 100 Reddit "IAMA" posts (where a famous or otherwise interesting person makes a Reddit post to say "I Am A ___, Ask Me Anything"):</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">elasticsearch</span> <span class="kn">import</span> <span class="n">Elasticsearch</span>

<span class="n">es</span> <span class="o">=</span> <span class="n">Elasticsearch</span><span class="p">()</span>

<span class="c"># Return a response of the top 100 IAMA Reddit posts of all time</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">"http://api.reddit.com/r/iama/top/?t=all&amp;limit=100"</span><span class="p">,</span> 
                        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">"User-Agent"</span><span class="p">:</span><span class="s">"TrackMaven"</span><span class="p">})</span>

<span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">'title'</span><span class="p">,</span> <span class="s">'selftext'</span><span class="p">,</span> <span class="s">'author'</span><span class="p">,</span> <span class="s">'score'</span><span class="p">,</span> 
        <span class="s">'ups'</span><span class="p">,</span> <span class="s">'downs'</span><span class="p">,</span> <span class="s">'num_comments'</span><span class="p">,</span> <span class="s">'url'</span><span class="p">,</span> <span class="s">'created'</span><span class="p">]</span>

<span class="c"># Loop through results and add each data dictionary to the ES "reddit" index</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">iama</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s">'data'</span><span class="p">][</span><span class="s">'children'</span><span class="p">]):</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">iama</span><span class="p">[</span><span class="s">'data'</span><span class="p">]</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
        <span class="n">doc</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
    <span class="n">es</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s">"reddit"</span><span class="p">,</span> <span class="n">doc_type</span><span class="o">=</span><span class="s">'iama'</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">doc</span><span class="p">)</span>
</pre></div>


<p>Elasticsearch arranges everything by an <strong>indexes</strong>, which can usually be thought of as the equivalent of a database in SQL terms, and <strong>document types</strong>, which in SQL terms would be individual tables. Each document type can then hold chunks of JSON data (the <strong>body</strong>), each labeled by an <strong>id</strong>.</p>
<p>In Elasticsearch, if an index does not already exist then it will be created automatically when you first try to add data to it. Note that if we had just tried to run:</p>
<div class="highlight"><pre><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">iama</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s">'data'</span><span class="p">][</span><span class="s">'children'</span><span class="p">]):</span>
    <span class="n">es</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s">'reddit'</span><span class="p">,</span> <span class="n">doc_type</span><span class="o">=</span><span class="s">'iama'</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">iama</span><span class="p">[</span><span class="s">'data'</span><span class="p">])</span>
</pre></div>


<p>and stored <em>all</em> the returned fields, we would have run into a parsing error. This is because Elasticsearch tries to guess at the data types best suited for storing on the fly, but it doesn't always guess correctly. This is one reason why it's a good idea to create a new index using an explicit <a href="http://www.elasticsearch.org/guide/reference/mapping/">mapping</a> to define how you want each field stored ahead of time.</p>
<p>Now that the index is populated with data, you can run search queries against Elasticsearch through cURL or directly in your browser. Try these out:</p>
<div class="highlight"><pre>http://localhost:9200/reddit/iama/_search?pretty=true&amp;size=3
http://localhost:9200/reddit/iama/_search?pretty=true&amp;q=title:almost
</pre></div>


<p>The Elasticsearch documentation <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/query-dsl.html">here</a> gives some more examples of the types of queries you can make.</p>
<p>Let's use the Python wrapper to make some queries as well:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">elasticsearch</span> <span class="kn">import</span> <span class="n">Elasticsearch</span>

<span class="n">es</span> <span class="o">=</span> <span class="n">Elasticsearch</span><span class="p">()</span>

<span class="c"># Fetch a specific result</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s">'reddit'</span><span class="p">,</span> <span class="n">doc_type</span><span class="o">=</span><span class="s">'iama'</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">print</span> <span class="n">res</span><span class="p">[</span><span class="s">'_source'</span><span class="p">]</span>

<span class="c"># Update the index to be able to query against it</span>
<span class="n">es</span><span class="o">.</span><span class="n">indices</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s">"reddit"</span><span class="p">)</span>

<span class="c"># Query for results: nothing will match this author</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s">"reddit"</span><span class="p">,</span> 
                <span class="n">body</span><span class="o">=</span><span class="p">{</span><span class="s">"query"</span><span class="p">:</span> <span class="p">{</span><span class="s">"match"</span><span class="p">:</span> <span class="p">{</span><span class="s">"author"</span><span class="p">:</span> <span class="s">"no results here!"</span><span class="p">}}})</span>
<span class="k">print</span> <span class="n">res</span>

<span class="c"># Query for all results (no matching criteria)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s">"reddit"</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="p">{</span><span class="s">"query"</span><span class="p">:</span> <span class="p">{</span><span class="s">"match_all"</span><span class="p">:</span> <span class="p">{}}})</span>
<span class="k">print</span> <span class="n">res</span><span class="p">[</span><span class="s">'hits'</span><span class="p">][</span><span class="s">'total'</span><span class="p">]</span>
<span class="k">print</span> <span class="n">res</span><span class="p">[</span><span class="s">'hits'</span><span class="p">][</span><span class="s">'hits'</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s">'_source'</span><span class="p">][</span><span class="s">'title'</span><span class="p">]</span>

<span class="c"># Query based on text appearing in the title</span>
<span class="c"># (by default matches across capitalization, pluralization, etc)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s">"reddit"</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="p">{</span><span class="s">"query"</span><span class="p">:</span> <span class="p">{</span><span class="s">"match"</span><span class="p">:</span> <span class="p">{</span><span class="s">"title"</span><span class="p">:</span> <span class="s">"obama"</span><span class="p">}}})</span>
<span class="k">print</span> <span class="n">res</span><span class="p">[</span><span class="s">'hits'</span><span class="p">][</span><span class="s">'total'</span><span class="p">]</span>
<span class="k">print</span> <span class="n">res</span><span class="p">[</span><span class="s">'hits'</span><span class="p">][</span><span class="s">'hits'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">'_source'</span><span class="p">][</span><span class="s">'title'</span><span class="p">]</span>
</pre></div>


<p>At this point, you could build more functionality around the built-in search or use <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/search-aggregations.html">aggregations</a> to perform broader analysis on the data.</p>
<p>For now, let's try working with some time series data so that we can make some pretty charts. Download a CSV of some <a href="http://www.capitalbikeshare.com/trip-history-data">trip history data</a> from Capital Bikeshare.</p>
<p>We'll create a mapping before storing our data this time. We can specify that certain string fields are "not_analyzed" as well, meaning that rather than try to parse out the text in "D St &amp; Maryland Ave NE", Elasticsearch will treat it as a single string not to be broken up:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">from</span> <span class="nn">elasticsearch</span> <span class="kn">import</span> <span class="n">Elasticsearch</span>

<span class="c"># Map the fields of a new "trip" doc_type</span>
<span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"trip"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">"properties"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">"duration"</span><span class="p">:</span> <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="s">"integer"</span><span class="p">},</span>
            <span class="s">"start_date"</span><span class="p">:</span> <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="s">"string"</span><span class="p">},</span>
            <span class="s">"start_station"</span><span class="p">:</span> <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="s">"string"</span><span class="p">,</span> <span class="s">"index"</span><span class="p">:</span> <span class="s">"not_analyzed"</span><span class="p">},</span>
            <span class="s">"start_terminal"</span><span class="p">:</span> <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="s">"integer"</span><span class="p">},</span>
            <span class="s">"end_date"</span><span class="p">:</span> <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="s">"string"</span><span class="p">},</span>
            <span class="s">"end_station"</span><span class="p">:</span> <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="s">"string"</span><span class="p">,</span> <span class="s">"index"</span><span class="p">:</span> <span class="s">"not_analyzed"</span><span class="p">},</span>
            <span class="s">"end_terminal"</span><span class="p">:</span> <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="s">"integer"</span><span class="p">},</span>
            <span class="s">"bike_id"</span><span class="p">:</span> <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="s">"string"</span><span class="p">},</span>
            <span class="s">"subscriber"</span><span class="p">:</span> <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="s">"string"</span><span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c"># Create a new "bikeshare" index that includes "trips" with the above mapping</span>
<span class="n">es</span> <span class="o">=</span> <span class="n">Elasticsearch</span><span class="p">()</span>
<span class="n">es</span><span class="o">.</span><span class="n">indices</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s">"bikeshare"</span><span class="p">)</span>
<span class="n">es</span><span class="o">.</span><span class="n">indices</span><span class="o">.</span><span class="n">put_mapping</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s">"bikeshare"</span><span class="p">,</span> <span class="n">doc_type</span><span class="o">=</span><span class="s">"trip"</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">mapping</span><span class="p">)</span>

<span class="c"># Import a CSV file of trip data - this will take quite a while!</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'2014-Q2-Trips-History-Data.csv'</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
    <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">)</span>
    <span class="n">reader</span><span class="o">.</span><span class="n">next</span><span class="p">()</span> <span class="c"># Skip header row</span>
    <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reader</span><span class="p">):</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">trip_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="mi">60</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">content</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"duration"</span><span class="p">:</span> <span class="n">trip_seconds</span><span class="p">,</span>
            <span class="s">"start_date"</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s">"start_station"</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="s">"start_terminal"</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="s">"end_date"</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
            <span class="s">"end_station"</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
            <span class="s">"end_terminal"</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
            <span class="s">"bike_id"</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
            <span class="s">"subscriber"</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="n">es</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s">"bikeshare"</span><span class="p">,</span> <span class="n">doc_type</span><span class="o">=</span><span class="s">'trip'</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">content</span><span class="p">)</span>
</pre></div>


<p>Run a couple queries to make sure data stored as expected:</p>
<div class="highlight"><pre>http://localhost:9200/bikeshare/trip/_search?size=3&amp;pretty=true
</pre></div>


<p>Now let's graph some results with Kibana! A browser-based analytics dashboard built for adding visualization to Elasticsearch, Kibana is usually used for analyzing data over time (ie, tracking log events as a time series). In this case, we haven't collected timestamps, but </p>
<p>Start by <a href="http://www.elasticsearch.org/overview/kibana/installation/">downloading Kibana</a>. While Elasticsearch is still up and running, you can separately visit Kibana's directory and run:</p>
<div class="highlight"><pre>python -m SimpleHTTPServer 9201
</pre></div>


<p>If you now visit:</p>



<p>you should be able to see Kibana's default interface. Click "Blank Dashboard" at the bottom to get started, or let Kibana fill in some default panels. Add a row of query results using a "table" panel and try searching for <code>subscriber:registered</code> at the top instead of the default <code>*</code> to see the results limit. (To add a panel to a new row, click the green "+" on the far left.)</p>
<p>Let's see the proportion of registered users in a chart. Add a new row to the dashboard, then add a <strong>terms</strong> type panel to that row. Give it a title "Subscriber types" and take the <strong>count</strong> of the <strong>field</strong> "subscribers" for a <em>style</em>* of "bar" or "pie". This should create a chart of the registered versus casual bikeshare users:
</p><center><img alt="ElasticSearch Chart 1" src="/images/ESchart1.png"/></center>
<p>Try taking a look at the distribution of top ending stations, <code>end_station</code>, in a similar way:
</p><center><img alt="ElasticSearch Chart 2" src="/images/ESchart2.png"/></center>
<p>Now we can run search queries and get real-time updates on these charts; try searching for <code>start_station:"Lincoln Memorial"</code> to see where riders end their journey when they start at the Lincoln Memorial.</p>
<p>Next steps: examine results across time, analyze the total duration of trips, add geocoding and map the results, find the bikes that have traveled the farthest total distance... Even if you aren't attending the meetup, please let us know if you try out any interesting side projects using Elasticsearch - bonus points if you include an open-source repo that we could share here!</p>


    <p class="addthis_sharing_toolbox"/>
  </div>
  </div></body></html>