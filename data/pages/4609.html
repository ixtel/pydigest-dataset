<html><body><div><div class="section" id="the-problem">
<h2>The Problem</h2>
<p>A colleague asked us for help in tackling a problem in a <a class="reference external" href="https://www.djangoproject.com/">Django</a> project. Their reporting solution was based on <a class="reference external" href="https://code.google.com/p/python-relatorio/">Relatorio</a> and they were concerned with the library as it seemed that it was abandoned. On top of this, the templates were stored as binary files which make the version tracking and bug-fixing a real chore.</p>
<p>As we mentioned in the previous article, some of us have a lot of experience with Java, and most of us had to tackle reporting more than once. Luckily, there are quite a few mature reporting solutions in Java like <a class="reference external" href="http://community.jaspersoft.com/">JasperReports</a> or <a class="reference external" href="http://www.dynamicreports.org/">DynamicReports</a>.</p>
<p>Given that the existing solution was already dependent on external tools like <a class="reference external" href="https://www.libreoffice.org/">LibreOffice</a>, trying to integrate an alternative mature non-python library might be worth the try.</p>
</div>
<div class="section" id="the-solution">
<h2>The Solution</h2>
<p>We cannot show you the code that needed the new reporting solution, so we’ll use a Django project presented in <a class="reference external" href="http://www.machinalis.com/blog/rt-notifications-gevent-gis/">an older blogpost</a>. You don’t have to worry about the particulars or the project, since we’re only going to be generating a simple tabular report of a particular entity. Everything is available on <a class="reference external" href="https://github.com/abarto/tracker_project/tree/jython_dynamicreports">GitHub</a>.</p>
<p>The proposed solution was to use <a class="reference external" href="http://www.dynamicreports.org/">DynamicReports</a>, but generating the report structure and content from Python instead of Java. Each report is contained in a module that takes the data from the command line (in Base64 encoded JSON) and returns the a Base64 encoded PDF report on the standard output. We know the solution is far from ideal, but it’ll give you a starting point for a more adequate architecture.</p>
<p>The first problem to tackle is packaging Jython and DynamicReports (and all their dependencies) in a way that makes the deployment and execution as simple as possible. This can be done easily in Java using <a class="reference external" href="https://maven.apache.org/">Maven</a>. For those unfamiliar with Maven, it is a tool to manage the project workflow, from building to packaging to documentation and much, much more. A Maven project is defined using a project object model (POM) file. On this file you can declare the project dependencies, define how it is built, how to execute tests, etc. A little bit like you would do with fabric and pip.</p>
<p>You can see the full version of pom.xml file on <a class="reference external" href="https://github.com/abarto/tracker_project/blob/jython_dynamicreports/tracker_project/tracker/reports/pom.xml">GitHub</a>, but for now, let us concentrate on the dependencies:</p>
<div class="highlight-python">
<pre>&lt;dependencies&gt;
        &lt;dependency&gt;
                &lt;groupId&gt;net.sourceforge.dynamicreports&lt;/groupId&gt;
                &lt;artifactId&gt;dynamicreports-core&lt;/artifactId&gt;
                &lt;version&gt;4.0.0&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
                &lt;groupId&gt;org.python&lt;/groupId&gt;
                &lt;artifactId&gt;jython-standalone&lt;/artifactId&gt;
                &lt;version&gt;2.7.0&lt;/version&gt;
        &lt;/dependency&gt;
&lt;/dependencies&gt;</pre>
</div>
<p>Our project only depends on Jython and DynamicReports, but these packages have dependencies of their own. Deploying Java packages can be problematic (specially when multiple conflicting jars are involved), and we want to keep our deployment simple, so we’ll make use of <a class="reference external" href="https://maven.apache.org/plugins/maven-shade-plugin/">Maven’s Shade Plugin</a>. This plugin allows us to build a single JAR file containing all the dependencies. Here’s the configuration for the plugin:</p>
<div class="highlight-python">
<pre>&lt;plugin&gt;
        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
        &lt;artifactId&gt;maven-shade-plugin&lt;/artifactId&gt;
        &lt;version&gt;2.3&lt;/version&gt;
        &lt;executions&gt;
                &lt;execution&gt;
                        &lt;phase&gt;package&lt;/phase&gt;
                        &lt;goals&gt;
                                &lt;goal&gt;shade&lt;/goal&gt;
                        &lt;/goals&gt;
                        &lt;configuration&gt;
    &lt;createDependencyReducedPom&gt;false&lt;/createDependencyReducedPom&gt;
                                &lt;transformers&gt;
                                        &lt;transformer
                                                implementation="org.apache.maven.plugins.shade.resource.ManifestResourceTransformer"&gt;
                                                &lt;manifestEntries&gt;
                                                        &lt;Main-Class&gt;org.python.util.jython&lt;/Main-Class&gt;
                                                &lt;/manifestEntries&gt;
                                        &lt;/transformer&gt;
                                &lt;/transformers&gt;
                                &lt;filters&gt;
                                        &lt;filter&gt;
                                                &lt;artifact&gt;net.sourceforge.dynamicreports:dynamicreports-core&lt;/artifact&gt;
                                                &lt;excludes&gt;
                                                        &lt;exclude&gt;jasperreports_extension.properties&lt;/exclude&gt;
                                                &lt;/excludes&gt;
                                        &lt;/filter&gt;
                                &lt;/filters&gt;
                        &lt;/configuration&gt;
                &lt;/execution&gt;
        &lt;/executions&gt;
&lt;/plugin&gt;</pre>
</div>
<p>What we’re doing here is telling Maven to generate a single JAR file, using org.python.util.jython (the Jython shell) as the Main class. We’re also filtering (i.e. not including in the final package) a file that causes problems when executing the JAR directly.</p>
<p>In order to build the package, you need to install Maven. In a ubuntu system this can be accomplished with the following command:</p>
<div class="highlight-python">
<pre>$ sudo apt-get install maven</pre>
</div>
<p>Once the installation finishes, you can build the package invoking the following command from the directory that contains the pom.xml file:</p>

<p>If you haven’t worked with maven before, and depending on your Internet connection it might take a while for the command to complete as it has to download all the required Maven components and the project’s dependencies. If everything went well there should be a file named reports-0.0.1.jar on the “target/” directory.</p>
<p>It might surprise you that no Java code is needed for this to work. The rest of the component is all written in Python. Granted, we make use of existing Java classes but once you’re familiar with reading javadocs, you’ll be able to leverage the full power of the DynamicReports library (or any other Java library).</p>
<p>We’re now going to write a Python module to generate PDF reports of Incidents using the DynamicReports API.</p>
<p>We could make use of PostgreSQL’s JDBC drivers to access the database directly, but we rather keep this as simple as possible so the script will take a Base64 encoded JSON representation of the Incident list. Using this, we build a DataSource object that’s used to describe and build the actual report. Once the report is built, we print the Base64 encoded result to the standard output.</p>
<div class="highlight-python">
<div class="highlight">
<pre><span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">base64</span> <span class="kn">import</span> <span class="p">(</span><span class="n">b64encode</span><span class="p">,</span> <span class="n">b64decode</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">java.io</span> <span class="kn">import</span> <span class="n">ByteArrayOutputStream</span>
<span class="kn">from</span> <span class="nn">json</span> <span class="kn">import</span> <span class="n">loads</span>

<span class="kn">from</span> <span class="nn">net.sf.dynamicreports.report.builder.DynamicReports</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="nb">cmp</span> <span class="k">as</span> <span class="n">dr_cmp</span><span class="p">,</span> <span class="n">col</span> <span class="k">as</span> <span class="n">dr_col</span><span class="p">,</span> <span class="n">report</span> <span class="k">as</span> <span class="n">dr_report</span><span class="p">,</span> <span class="nb">type</span> <span class="k">as</span> <span class="n">dr_type</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">net.sf.dynamicreports.report.datasource</span> <span class="kn">import</span> <span class="n">DRDataSource</span>


<span class="k">def</span> <span class="nf">get_report_data</span><span class="p">(</span><span class="n">report_data</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">loads</span><span class="p">(</span><span class="n">b64decode</span><span class="p">(</span><span class="n">report_data</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">"utf-8"</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">create_report</span><span class="p">(</span><span class="n">data_source</span><span class="p">):</span>
    <span class="n">output_stream</span> <span class="o">=</span> <span class="n">ByteArrayOutputStream</span><span class="p">()</span>
    <span class="n">dr_report</span><span class="p">()</span> \
        <span class="o">.</span><span class="n">columns</span><span class="p">(</span>
            <span class="n">dr_col</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="s">'Pk'</span><span class="p">,</span> <span class="s">'pk'</span><span class="p">,</span> <span class="n">dr_type</span><span class="o">.</span><span class="n">integerType</span><span class="p">()),</span>
            <span class="n">dr_col</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="s">'Name'</span><span class="p">,</span> <span class="s">'name'</span><span class="p">,</span> <span class="n">dr_type</span><span class="o">.</span><span class="n">stringType</span><span class="p">()),</span>
            <span class="n">dr_col</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="s">'Description'</span><span class="p">,</span> <span class="s">'description'</span><span class="p">,</span> <span class="n">dr_type</span><span class="o">.</span><span class="n">stringType</span><span class="p">()),</span>
            <span class="n">dr_col</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="s">'Severity'</span><span class="p">,</span> <span class="s">'severity'</span><span class="p">,</span> <span class="n">dr_type</span><span class="o">.</span><span class="n">stringType</span><span class="p">()),</span>
            <span class="n">dr_col</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="s">'Closed'</span><span class="p">,</span> <span class="s">'closed'</span><span class="p">,</span> <span class="n">dr_type</span><span class="o">.</span><span class="n">booleanType</span><span class="p">()),</span>
            <span class="n">dr_col</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="s">'Location'</span><span class="p">,</span> <span class="s">'location'</span><span class="p">,</span> <span class="n">dr_type</span><span class="o">.</span><span class="n">stringType</span><span class="p">()),</span>
            <span class="n">dr_col</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="s">'Created'</span><span class="p">,</span> <span class="s">'created'</span><span class="p">,</span> <span class="n">dr_type</span><span class="o">.</span><span class="n">stringType</span><span class="p">())</span>
        <span class="p">)</span> \
        <span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">dr_cmp</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s">'Incidents'</span><span class="p">))</span> \
        <span class="o">.</span><span class="n">setDataSource</span><span class="p">(</span><span class="n">data_source</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">toPdf</span><span class="p">(</span><span class="n">output_stream</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_stream</span><span class="o">.</span><span class="n">toByteArray</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">create_data_source</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">dr_data_source</span> <span class="o">=</span> <span class="n">DRDataSource</span><span class="p">(</span>
        <span class="p">[</span><span class="s">'pk'</span><span class="p">,</span> <span class="s">'name'</span><span class="p">,</span> <span class="s">'description'</span><span class="p">,</span> <span class="s">'severity'</span><span class="p">,</span> <span class="s">'closed'</span><span class="p">,</span> <span class="s">'location'</span><span class="p">,</span> <span class="s">'created'</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">incident</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">dr_data_source</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="n">incident</span><span class="p">[</span><span class="s">'pk'</span><span class="p">],</span>
            <span class="n">incident</span><span class="p">[</span><span class="s">'fields'</span><span class="p">][</span><span class="s">'name'</span><span class="p">],</span>
            <span class="n">incident</span><span class="p">[</span><span class="s">'fields'</span><span class="p">][</span><span class="s">'description'</span><span class="p">],</span>
            <span class="n">incident</span><span class="p">[</span><span class="s">'fields'</span><span class="p">][</span><span class="s">'severity'</span><span class="p">],</span>
            <span class="n">incident</span><span class="p">[</span><span class="s">'fields'</span><span class="p">][</span><span class="s">'closed'</span><span class="p">],</span>
            <span class="n">incident</span><span class="p">[</span><span class="s">'fields'</span><span class="p">][</span><span class="s">'location'</span><span class="p">],</span>
            <span class="n">incident</span><span class="p">[</span><span class="s">'fields'</span><span class="p">][</span><span class="s">'created'</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">dr_data_source</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">data_source</span> <span class="o">=</span> <span class="n">create_data_source</span><span class="p">(</span><span class="n">get_report_data</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">report_pdf</span> <span class="o">=</span> <span class="n">create_report</span><span class="p">(</span><span class="n">data_source</span><span class="p">)</span>

    <span class="k">print</span> <span class="n">b64encode</span><span class="p">(</span><span class="n">report_pdf</span><span class="p">)</span>
</pre>
</div>
</div>
<p>The generated report is rudimentary, but after reading the documentation you’ll be able to write incredibly rich reports. This set-up solves the problem the report design version tracking, as it is just a plain Python module.</p>
<p>In order to use this module, we created a new Django view that invokes java supplying the report data, and sends the results back to the client:</p>
<div class="highlight-python">
<div class="highlight">
<pre><span class="nd">@login_required</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">incident_export_report</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="s">'application/pdf'</span><span class="p">)</span>
    <span class="n">response</span><span class="p">[</span><span class="s">'Content-Disposition'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'attachment; filename="incidents-{}.pdf"'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>

    <span class="n">incidents</span> <span class="o">=</span> <span class="n">Incident</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">'-created'</span><span class="p">)</span>
    <span class="n">report_data</span> <span class="o">=</span> <span class="n">b64encode</span><span class="p">(</span><span class="n">serialize</span><span class="p">(</span><span class="s">'json'</span><span class="p">,</span> <span class="n">incidents</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">))</span>

    <span class="n">reports_output</span> <span class="o">=</span> <span class="n">check_output</span><span class="p">(</span>
        <span class="p">[</span><span class="s">'java'</span><span class="p">,</span> <span class="s">'-jar'</span><span class="p">,</span> <span class="s">'tracker/reports/target/reports-0.0.1.jar'</span><span class="p">,</span> <span class="s">'tracker/reports/incidents.py'</span><span class="p">,</span> <span class="n">report_data</span><span class="p">],</span>
        <span class="n">stderr</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="bp">None</span>
    <span class="p">)</span>

    <span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b64decode</span><span class="p">(</span><span class="n">reports_output</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>

    <span class="k">return</span> <span class="n">response</span>
</pre>
</div>
</div>
</div>
<div class="section" id="conclusions">
<h2>Conclusions</h2>
<p>As you saw, Jython allowed us to integrate a fairly mature reporting library without much effort. The interaction between Python and Java through the command line is not very elegant, but it can be easily replaced by other solutions.</p>
<p>The presented approach can be used with any other Java library just by changing the dependency declaration on the POM file.</p>
<p>We think that we’ve made a very good case for the usage of Jython in a Python eco-system and that you shouldn’t shy away from the incredibly rich Java libraries that are available.</p>
<p>As usual, any comments or suggestions are welcomed. We’re interested to know if you had to face a similar problem where a Java library might replace a Python module that’s not ideal for your needs.</p>
</div>
</div></body></html>