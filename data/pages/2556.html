<html><body><div><div class="entry-content">
                    <img alt="Setup.py tricks" class="align-center" id="id1" src="http://pydanny.com/static/setup.png"/>
<p>Seasons greetings!</p>
<p>Before I begin, I want to make very clear that most of what I'm about to explain are <strong>'tricks'</strong>. They aren't "best practices",  and in at least one case, is possibly inadvisable.</p>
<p>Speaking of inadvisable practices, at some point I'll write a <strong>'setup.py traps'</strong> blog post, which are things I believe you should never, ever do in a <strong>setup.py</strong> module.</p>
<div class="section" id="tricks">
<h2>Tricks</h2>
<p>These are tricks I have to make package management in <a class="reference external" href="http://python.org">python</a> a tiny bit easier. Before you attempt to implement them, I recommend you have at least basic experience with creating new packages. Two ways to learn about python packaging are the <a class="reference external" href="http://audreyr.gitbooks.io/new-library-sprint/content/">New Library Sprint</a> (beginner friendly) and the <a class="reference external" href="https://python-packaging-user-guide.readthedocs.org">Python Packaging User Guide</a> (more advanced).</p>
<div class="section" id="python-setup-py-publish">
<h3>'python setup.py publish'</h3>
<p>This is where it all started. One day I was looking at some of <a class="reference external" href="https://github.com/tomchristie">Tom Christie's code</a> and discovered the <a class="reference external" href="https://github.com/tomchristie/django-rest-framework/blob/971578ca345c3d3bae7fd93b87c41d43483b6f05/setup.py#L61-L67">python setup.py publish</a> command inside the <strong>setup.py</strong> module of <strong>Django Rest Framework</strong>. It goes something like this:</p>
<div class="highlight"><pre><span class="c"># setup.py</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="c"># I'll discuss version tricks in a future blog post.</span>
<span class="n">version</span> <span class="o">=</span> <span class="s">"42.0.0"</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">'publish'</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">"python setup.py sdist upload"</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">"python setup.py bdist_wheel upload"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"You probably want to also tag the version now:"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"  git tag -a </span><span class="si">%s</span><span class="s"> -m 'version </span><span class="si">%s</span><span class="s">'"</span> <span class="o">%</span> <span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">version</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"  git push --tags"</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

<span class="c"># Below this point is the rest of the setup() function</span>
</pre></div>
<p>What's awesome about this is that using this technique I don't have to look up the somewhat cryptic <strong>python setup.py sdist upload</strong> command, or the actually cryptic <strong>python setup.py bdist_wheel upload</strong>. Instead, when it's time to push one of my packages to <a class="reference external" href="https://pypi.python.org/pypi">PyPI</a>, I just type:</p>
<div class="highlight"><pre><span class="nv">$ </span>python setup.py publish
</pre></div>
<p>Much easier to remember!</p>
</div>
<div class="section" id="python-setup-py-tag">
<h3>'python setup.py tag'</h3>
<p>The problem with Tom Christie's <strong>python setup.py publish</strong> command is that it forces me to type out the <strong>git tag</strong> command. Okay, let's be honest, it forces me to copy/paste the output of my screen. Therefore, all on my very own, I 'invented' the <strong>python setup.py tag</strong> command:</p>
<div class="highlight"><pre><span class="c"># setup.py</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">'tag'</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">"git tag -a </span><span class="si">%s</span><span class="s"> -m 'version </span><span class="si">%s</span><span class="s">'"</span> <span class="o">%</span> <span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">version</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">"git push --tags"</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</pre></div>
<p>Pretty nifty, eh? Now I don't have to remember so many cryptic git commands. And I get to shorten the <cite>python setup.py publish</cite> command:</p>
<div class="highlight"><pre><span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">'publish'</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">"python setup.py sdist upload"</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">"python setup.py bdist_wheel upload"</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</pre></div>
<p>When I need to do a version release, I commit my code then type:</p>
<div class="highlight"><pre><span class="nv">$ </span>python setup.py publish
<span class="nv">$ </span>python setup.py tag
</pre></div>
<p>Why don't I combine the commands? Well, you aren't supposed to put things like 'RC1' or '-alpha' in your PyPI version names. By seperating the commands I have finer grained control over my package releases. I'm encouraged to place alpha, beta, and release candidates in git tags, rather than formal PyPI releases.</p>
</div>
<div class="section" id="python-setup-py-test">
<h3>'python setup.py test'</h3>
<p>I'm fairly certain some of my readers are going to have a seriously problem with this trick. In fact, depending on the the response of those who manage Python's packaging infrastructure, it might be moved to my forthcoming 'traps' blog post.</p>
<p>Alrighty then...</p>
<p>I like <a class="reference external" href="http://pytest.org">py.test</a>. I've <a class="reference external" href="http://www.pydanny.com/pytest-no-boilerplate-testing.html">blogged about the use of py.test</a>. I try to use it everywhere. Yet, I'm really not a fan of how we're supposed tie it into <strong>python setup.py test</strong>. The precise moment I get uncomfortable with <strong>py.test</strong> is when it makes me add special classes into <strong>setup.py</strong>.</p>
<p>Fortunately, there is another way:</p>
<div class="highlight"><pre><span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">'test'</span><span class="p">:</span>
    <span class="n">test_requirements</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">'pytest'</span><span class="p">,</span>
        <span class="s">'flake8'</span><span class="p">,</span>
        <span class="s">'coverage'</span>
    <span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">modules</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">__import__</span><span class="p">,</span> <span class="n">test_requirements</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">err_msg</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"No module named "</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">"</span><span class="si">%s</span><span class="s"> is not installed. Install your test requirments."</span> <span class="o">%</span> <span class="n">err_msg</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">'py.test'</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</pre></div>
<p>Which means I get to use <strong>py.test</strong> and <strong>python setup.py test</strong> with a trivial addition of code:</p>

<p>In theory, one could run <strong>pip install</strong> on the missing requirements, or call them from a requirements file. However, since these are 'tricks', I like to keep things short and sweet. If I get enough positive results for this one I'll update this example to include calling of <strong>pip</strong> for missing requirements.</p>
<p><strong>note</strong>: This doesn't mean I'm not using <a class="reference external" href="https://pypi.python.org/pypi/tox">tox</a>. In fact, I use tox to call my version of <strong>python setup.py test</strong>.</p>
</div>
</div>
<div class="section" id="what-about-subprocess">
<h2>What about subprocess?</h2>
<p>There are those who will ask, "Why aren't you using the <a class="reference external" href="https://docs.python.org/2/library/subprocess.html">subprocess</a> library for these shell commands?"</p>
<p>My answer to that question is, "Because if I need a nuclear weapon to kill a rabbit maybe I'm overdoing things." For these simple tricks, the <strong>os.system()</strong> function is good enough.</p>
</div>
<div class="section" id="why-not-just-use-a-makefile">
<h2>Why not just use a Makefile?</h2>
<p>While I code primarily on Mac OSX and Linux, most of my open source packages are used Windows. Thanks to <a class="reference external" href="http://appveyor.com">AppVeyor</a>, I'm testing more and more of them in that environment. In fact, I'll probably be modifying these "tricks" to work better for Windows users.</p>
</div>
<div class="section" id="traps">
<h2>Traps!</h2>
<p>Stay tuned for my 'traps' blog post to come out early in 2015.</p>
</div>
<div class="section" id="updates">
<h2>Updates</h2>
<ul class="simple">
<li>2014/12/21 - Added a note about using tox.</li>
<li>2014/12/21 - Added a note about Makefile and Windows</li>
</ul>
</div>

                    
                </div>
                                </div></body></html>