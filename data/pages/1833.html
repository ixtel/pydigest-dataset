<html><body><div><div id="article_text">
    <p>An annoyance of the development process for frontend teams consuming a JSON-based API is not getting a JSON-formatted response back when an error occurs. Getting Django's HTML-based error pages instead of something formed in JSON means more coding at their end to capture errors and top that off, the HTML  itself is long and difficult to eyeball quickly.</p>
<p>Here's what I'm looking to replace:</p>
<div class="highlight"><pre>➫ curl -s localhost:8001/missing

&lt;!DOCTYPE html&gt;
&lt;html <span class="nv">lang</span><span class="o">=</span><span class="s2">"en"</span>&gt;
&lt;head&gt;
  &lt;meta http-equiv<span class="o">=</span><span class="s2">"content-type"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"text/html; charset=utf-8"</span>&gt;
  &lt;title&gt;Page not found at /missing&lt;/title&gt;
  &lt;meta <span class="nv">name</span><span class="o">=</span><span class="s2">"robots"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"NONE,NOARCHIVE"</span>&gt;
  &lt;style <span class="nb">type</span><span class="o">=</span><span class="s2">"text/css"</span>&gt;
    html * <span class="o">{</span> padding:0<span class="p">;</span> margin:0<span class="p">;</span> <span class="o">}</span>
    body * <span class="o">{</span> padding:10px 20px<span class="p">;</span> <span class="o">}</span>
    body * * <span class="o">{</span> padding:0<span class="p">;</span> <span class="o">}</span>
    body <span class="o">{</span> font:small sans-serif<span class="p">;</span> background:#eee<span class="p">;</span> <span class="o">}</span>
    body&gt;div <span class="o">{</span> border-bottom:1px solid <span class="c">#ddd; }</span>
    h1 <span class="o">{</span> font-weight:normal<span class="p">;</span> margin-bottom:.4em<span class="p">;</span> <span class="o">}</span>
    h1 span <span class="o">{</span> font-size:60%<span class="p">;</span> color:#666<span class="p">;</span> font-weight:normal<span class="p">;</span> <span class="o">}</span>
    table <span class="o">{</span> border:none<span class="p">;</span> border-collapse: collapse<span class="p">;</span> width:100%<span class="p">;</span> <span class="o">}</span>
    td, th <span class="o">{</span> vertical-align:top<span class="p">;</span> padding:2px 3px<span class="p">;</span> <span class="o">}</span>
    th <span class="o">{</span> width:12em<span class="p">;</span> text-align:right<span class="p">;</span> color:#666<span class="p">;</span> padding-right:.5em<span class="p">;</span> <span class="o">}</span>
    <span class="c">#info { background:#f6f6f6; }</span>
    <span class="c">#info ol { margin: 0.5em 4em; }</span>
...
</pre></div>
<p>Being able to return both regular content and unexpected errors in JSON format helps remove the pains of dealing with errors during the development process.</p>
<p><a class="reference external" href="https://github.com/jsocol/django-jsonview">django-jsonview</a> is a package that gives you a decorator for your view methods that wraps their contents in a JSON response. It will also catch exceptions and return them in a consistent fashion and there is even support to modify HTTP headers if need be.</p>
<p>I'll walk you through it's usage.</p>
<div class="section" id="setup-a-django-project-and-application">
<h2>Setup a Django project and application</h2>
<p>First, I'll create a new project and app. The project will be called 'speak_json' and the app within it will be called 'photos':</p>
<div class="highlight"><pre>➫ pip install <span class="nv">Django</span><span class="o">==</span>1.7 django-jsonview
➫ django-admin startproject speak_json
➫ <span class="nb">cd </span>speak_json
➫ django-admin startapp photos
</pre></div>
<p>Now I need to edit (and in some cases create) five files: The base settings file, the base urls file, a models file with an example model, the urls file for the app and finally, the view with our decorated views.</p>
<p>I added 'photos' to the <cite>INSTALLED_APPS</cite> tuple in <cite>speak_json/settings.py</cite>:</p>
<div class="highlight"><pre><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">'django.contrib.admin'</span><span class="p">,</span>
    <span class="s">'django.contrib.auth'</span><span class="p">,</span>
    <span class="s">'django.contrib.contenttypes'</span><span class="p">,</span>
    <span class="s">'django.contrib.sessions'</span><span class="p">,</span>
    <span class="s">'django.contrib.messages'</span><span class="p">,</span>
    <span class="s">'django.contrib.staticfiles'</span><span class="p">,</span>
    <span class="s">'photos'</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
<p>I added an entry for urls that begin with 'photos/' to route to the photos app in <cite>speak_json/urls.py</cite>:</p>
<div class="highlight"><pre><span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">''</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^photos/'</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s">'photos.urls'</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s">'photos'</span><span class="p">)),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^admin/$'</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span>
<span class="p">)</span>
</pre></div>
<p>I created a small model in <cite>photos/models.py</cite>:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>


<span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">first_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">last_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</pre></div>
<p>After I created the model I created the migration and migrated the app so the sqlite3 database would have the corresponding table:</p>
<div class="highlight"><pre>➫ python manage.py makemigrations
➫ python manage.py migrate
</pre></div>
<p>I then added in URL mappings for five views in <cite>photos/urls.py</cite>:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">url</span>


<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>


<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">''</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^foo_bar/$'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">foo_bar</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^is_payment_needed/$'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">is_payment_needed</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^server_name/$'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">server_name</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^one_equals_two/$'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">one_equals_two</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^missing_person/$'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">missing_person</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
<p>Just to keep track, these are the files in their respective locations for this project:</p>
<div class="highlight"><pre>➫ find speak_json/
speak_json/db.sqlite3
speak_json/manage.py
speak_json/photos/__init__.py
speak_json/photos/admin.py
speak_json/photos/migrations
speak_json/photos/migrations/0001_initial.py
speak_json/photos/migrations/__init__.py
speak_json/photos/models.py
speak_json/photos/tests.py
speak_json/photos/urls.py
speak_json/photos/views.py
speak_json/speak_json
speak_json/speak_json/__init__.py
speak_json/speak_json/settings.py
speak_json/speak_json/urls.py
speak_json/speak_json/wsgi.py
</pre></div>
</div>
<div class="section" id="wrapping-views-with-the-json-view-decorator">
<h2>Wrapping views with the json_view decorator</h2>
<p>The fifth file I edited was <cite>photos/views.py</cite> which is where I added in five view methods wrapped with the <cite>json_view</cite> decorator:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">jsonview.decorators</span> <span class="kn">import</span> <span class="n">json_view</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Person</span>


<span class="nd">@json_view</span>
<span class="k">def</span> <span class="nf">foo_bar</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s">'foo'</span><span class="p">:</span> <span class="s">'bar'</span><span class="p">,</span>
    <span class="p">}</span>


<span class="nd">@json_view</span>
<span class="k">def</span> <span class="nf">is_payment_needed</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
        <span class="c"># Send a 402 Payment Required status.</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">'subscribed'</span><span class="p">:</span> <span class="bp">False</span><span class="p">},</span> <span class="mi">402</span>
    <span class="c"># Send a 200 OK.</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">'subscribed'</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>


<span class="nd">@json_view</span>
<span class="k">def</span> <span class="nf">server_name</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{},</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s">'X-Server'</span><span class="p">:</span> <span class="s">'myserver'</span><span class="p">}</span>


<span class="nd">@json_view</span>
<span class="k">def</span> <span class="nf">one_equals_two</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">assert</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s">'1 is not equal to 2'</span>


<span class="nd">@json_view</span>
<span class="k">def</span> <span class="nf">missing_person</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">person</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">1234</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">'found'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'person_id'</span><span class="p">:</span> <span class="n">person</span><span class="o">.</span><span class="n">pk</span><span class="p">}</span>
</pre></div>
</div>
<div class="section" id="testing-http-responses">
<h2>Testing HTTP responses</h2>
<p>Now that the code is written I'll run the WSGI server and try out some of the endpoints:</p>
<div class="highlight"><pre>➫ python manage.py runserver 8001
</pre></div>
<p>The first method <cite>foo_bar</cite> returns a dictionary. Here it is with the correct HTTP 200 response code and 'application/json' content type.</p>
<div class="highlight"><pre>➫ curl -v localhost:8001/photos/foo_bar/
...
&lt; HTTP/1.0 <span class="m">200</span> OK
&lt; Content-Type: application/json
...
<span class="o">{</span><span class="s2">"foo"</span>: <span class="s2">"bar"</span><span class="o">}</span>
</pre></div>
<p>The second method <cite>is_payment_needed</cite> can return a custom HTTP response code, in this case '402 PAYMENT REQUIRED':</p>
<div class="highlight"><pre>➫ curl -v localhost:8001/photos/is_payment_needed/
*...
&lt; HTTP/1.0 <span class="m">402</span> PAYMENT REQUIRED
&lt; Content-Type: application/json
...
<span class="o">{</span><span class="s2">"subscribed"</span>: <span class="nb">false</span><span class="o">}</span>
</pre></div>
<p>The third method <cite>server_name</cite> returns a new header 'X-Server', along with an empty dictionary:</p>
<div class="highlight"><pre>➫ curl -v localhost:8001/photos/server_name/
...
&lt; HTTP/1.0 <span class="m">200</span> OK
&lt; X-Server: myserver
...
<span class="o">{}</span>
</pre></div>
<p>The fourth method <cite>one_equals_two</cite> raises an AssertionError which when caught, returned as a string and uses HTTP 500 as it's error code:</p>
<div class="highlight"><pre>➫ curl -v localhost:8001/photos/one_equals_two/
...
&lt; HTTP/1.0 <span class="m">500</span> INTERNAL SERVER ERROR
&lt; Content-Type: application/json
...
<span class="o">{</span><span class="s2">"message"</span>: <span class="s2">"1 is not equal to 2"</span>, <span class="s2">"error"</span>: 500<span class="o">}</span>
</pre></div>
<p>The fifth method <cite>missing_person</cite> intentionally returns an error for a record that does not exist. Here you can see it returns HTTP 500 instead of 404:</p>
<div class="highlight"><pre>➫ curl -v localhost:8001/photos/missing_person/
...
&lt; HTTP/1.0 <span class="m">500</span> INTERNAL SERVER ERROR
&lt; Content-Type: application/json
...
<span class="o">{</span><span class="s2">"message"</span>: <span class="s2">"Person matching query does not exist."</span>, <span class="s2">"error"</span>: 500<span class="o">}</span>
</pre></div>
<p>To get the response to return a 404 instead we need to import <cite>get_object_or_404</cite> which will raise the proper exception json_view needs to see in order to return a 404. Here's the modified code:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">get_object_or_404</span>


<span class="nd">@json_view</span>
<span class="k">def</span> <span class="nf">missing_person</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">person</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Person</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="mi">1234</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">'found'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'person_id'</span><span class="p">:</span> <span class="n">person</span><span class="o">.</span><span class="n">pk</span><span class="p">}</span>
</pre></div>
<p>And here is the output correctly identifying HTTP 404 as the response code:</p>
<div class="highlight"><pre>➫ curl -v localhost:8001/photos/missing_person/
...
&lt; HTTP/1.0 <span class="m">404</span> NOT FOUND
&lt; Content-Type: application/json
...
<span class="o">{</span><span class="s2">"message"</span>: <span class="s2">"No Person matches the given query."</span>, <span class="s2">"error"</span>: 404<span class="o">}</span>
</pre></div>
</div>

  </div>

   <div id="support_text"><p>
    Thank you for taking the time to read this post. If you're considering using </p><a href="https://www.digitalocean.com/?refcode=074ce6598105">Digital Ocean</a><p>, the hosting provider this blog is hosted on, please consider using </p><a href="https://www.digitalocean.com/?refcode=074ce6598105">this link to sign up</a><p>.
  </p></div>


  
</div></body></html>