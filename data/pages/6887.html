<html><body><div><div class="twelve columns entry-div">
    <header id="entry-header">
      <h1 id="entry-h1">Remap: Nested Data Multitool for Python</h1>
      <p id="entry-tagline"/>
    </header>
      <p/><blockquote>
<p><em>This entry is the first in a series of "cookbooklets" showcasing
more advanced <a href="https://boltons.readthedocs.org">Boltons</a>. If all goes well, the next 5
minutes will literally save you 5 hours.</em></p>
</blockquote>

<p>Data is everywhere, especially within itself. That's right, whether
it's public APIs, document stores, or plain old configuration files,
data <em>will</em> nest. And that nested data will find you.</p>
<p><a href="https://en.wikipedia.org/wiki/Flat_design">UI fads</a> aside, developers have always liked
"flat". Even Python, so often turned to for data wrangling, only has
succinct built-in constructs for dealing with flat
data. <a href="https://docs.python.org/2/tutorial/datastructures.html#list-comprehensions">List comprehensions</a>,
<a href="https://docs.python.org/2/reference/expressions.html#generator-expressions">generator expressions</a>, <a href="https://docs.python.org/2/library/functions.html#map">map</a>/<a href="https://docs.python.org/2/library/functions.html#filter">filter</a>, and
<a href="https://docs.python.org/2/library/itertools.html">itertools</a> are all built for flat work. In fact, the
allure of flat data is likely a direct result of this common gap in
most programming languages.</p>
<p><a href="https://commons.wikimedia.org/wiki/File:Russian-Matroshka2.jpg">
<img src="/uploads/Russian-Matroshka2.jpg"/>
</a></p>
<p><strong>Let's change that.</strong> First, let's meet this nested
adversary. Provided you overlook my taste in media, it's hard to fault
nested data when it reads as well as this <a href="https://en.wikipedia.org/wiki/YAML">YAML</a>:</p>
<div class="codehilite"><pre><span class="l-Scalar-Plain">reviews</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">shows</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">title</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Star Trek - The Next Generation</span>
      <span class="l-Scalar-Plain">rating</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10</span>
      <span class="l-Scalar-Plain">review</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Episodic AND deep. &lt;3 Data.</span>
      <span class="l-Scalar-Plain">tags</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">'space'</span><span class="p-Indicator">]</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">title</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Monty Python's Flying Circus</span>
      <span class="l-Scalar-Plain">rating</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10</span>
      <span class="l-Scalar-Plain">tags</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">'comedy'</span><span class="p-Indicator">]</span>
  <span class="l-Scalar-Plain">movies</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">title</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">The Hitchiker's Guide to the Galaxy</span>
      <span class="l-Scalar-Plain">rating</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">6</span>
      <span class="l-Scalar-Plain">review</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">So great to see Mos Def getting good work.</span>
      <span class="l-Scalar-Plain">tags</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">'comedy'</span><span class="p-Indicator">,</span> <span class="s">'space'</span><span class="p-Indicator">,</span> <span class="s">'life'</span><span class="p-Indicator">]</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">title</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Monty Python's Meaning of Life</span>
      <span class="l-Scalar-Plain">rating</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">7</span>
      <span class="l-Scalar-Plain">review</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Better than Brian, but not a Holy Grail, nor Completely Different.</span>
      <span class="l-Scalar-Plain">tags</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">'comedy'</span><span class="p-Indicator">,</span> <span class="s">'life'</span><span class="p-Indicator">]</span>
      <span class="l-Scalar-Plain">prologue</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">title</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">The Crimson Permanent Assurance</span>
        <span class="l-Scalar-Plain">rating</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">9</span>
</pre></div>


<p>Even this very straightforwardly nested data can be a real hassle to
manipulate. How would one add a default review for entries without
one? How would one convert the ratings to a 5-star scale? And what
does all of this mean for more complex real-world cases, exemplified
by this excerpt from <a href="https://api.github.com/users/mahmoud/events">a real GitHub API</a> response:</p>
<p><a id="github_event_data"/></p>
<div class="codehilite"><pre><span class="p">[{</span>
    <span class="nt">"id"</span><span class="p">:</span> <span class="s2">"3165090957"</span><span class="p">,</span>
    <span class="nt">"type"</span><span class="p">:</span> <span class="s2">"PushEvent"</span><span class="p">,</span>
    <span class="nt">"actor"</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">"id"</span><span class="p">:</span> <span class="mi">130193</span><span class="p">,</span>
      <span class="nt">"login"</span><span class="p">:</span> <span class="s2">"mahmoud"</span><span class="p">,</span>
      <span class="nt">"gravatar_id"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="nt">"url"</span><span class="p">:</span> <span class="s2">"https://api.github.com/users/mahmoud"</span><span class="p">,</span>
      <span class="nt">"avatar_url"</span><span class="p">:</span> <span class="s2">"https://avatars.githubusercontent.com/u/130193?"</span>
    <span class="p">},</span>
    <span class="nt">"repo"</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">"id"</span><span class="p">:</span> <span class="mi">8307391</span><span class="p">,</span>
      <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"mahmoud/boltons"</span><span class="p">,</span>
      <span class="nt">"url"</span><span class="p">:</span> <span class="s2">"https://api.github.com/repos/mahmoud/boltons"</span>
    <span class="p">},</span>
    <span class="nt">"payload"</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">"push_id"</span><span class="p">:</span> <span class="mi">799258895</span><span class="p">,</span>
      <span class="nt">"size"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nt">"distinct_size"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nt">"ref"</span><span class="p">:</span> <span class="s2">"refs/heads/master"</span><span class="p">,</span>
      <span class="nt">"head"</span><span class="p">:</span> <span class="s2">"27a4bc1b6d1da25a38fe8e2c5fb27f22308e3260"</span><span class="p">,</span>
      <span class="nt">"before"</span><span class="p">:</span> <span class="s2">"0d6486c40282772bab232bf393c5e6fad9533a0e"</span><span class="p">,</span>
      <span class="nt">"commits"</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nt">"sha"</span><span class="p">:</span> <span class="s2">"27a4bc1b6d1da25a38fe8e2c5fb27f22308e3260"</span><span class="p">,</span>
          <span class="nt">"author"</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">"email"</span><span class="p">:</span> <span class="s2">"mahmoud@hatnote.com"</span><span class="p">,</span>
            <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"Mahmoud Hashemi"</span>
          <span class="p">},</span>
          <span class="nt">"message"</span><span class="p">:</span> <span class="s2">"switched reraise_visit to be just a kwarg"</span><span class="p">,</span>
          <span class="nt">"distinct"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
          <span class="nt">"url"</span><span class="p">:</span> <span class="s2">"https://api.github.com/repos/mahmoud/boltons/commits/27a4bc1b6d1da25a38fe8e2c5fb27f22308e3260"</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">},</span>
    <span class="nt">"public"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">"created_at"</span><span class="p">:</span> <span class="s2">"2015-09-21T10:04:37Z"</span>
<span class="p">}]</span>
</pre></div>


<p>The astute reader may spot some inconsistency and general complexity,
but don't run away.</p>
<p><big><strong>Remap</strong>, the <a href="https://en.wikipedia.org/wiki/Recursion_(computer_science)">recursive</a> <a href="https://docs.python.org/2/library/functions.html#map">map</a>, is here to save the day.</big></p>
<p>Remap is a Pythonic traversal utility that creates a transformed copy
of your nested data. It uses three callbacks -- <code>visit</code>, <code>enter</code>, and
<code>exit</code> -- and is designed to accomplish the vast majority of tasks by
passing only one function, usually <code>visit</code>. <a href="http://boltons.readthedocs.org/en/latest/iterutils.html#boltons.iterutils.remap">The API docs have full
descriptions</a>, but the basic rundown is:</p>
<ul>
<li><code>visit</code> transforms an individual item</li>
<li><code>enter</code> controls how container objects are created and traversed</li>
<li><code>exit</code> controls how new container objects are populated</li>
</ul>
<p>It may sound complex, but the examples shed a lot of light. So let's
get remapping!</p>

<p>First, let's import the modules and data we'll need.</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">yaml</span>  <span class="c"># https://pypi.python.org/pypi/PyYAML</span>
<span class="kn">from</span> <span class="nn">boltons.iterutils</span> <span class="kn">import</span> <span class="n">remap</span>  <span class="c"># https://pypi.python.org/pypi/boltons</span>

<span class="n">review_map</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">media_reviews</span><span class="p">)</span>

<span class="n">event_list</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">github_events</span><span class="p">)</span>
</pre></div>


<p>Now let's turn back to that GitHub API data. Earlier one may have been
annoyed by the inconsistent type of <code>id</code>. <code>event['repo']['id']</code> is an
integer, but <code>event['id']</code> is a string. When sorting events by ID, you
would not want <a href="https://en.wikipedia.org/wiki/Lexicographical_order">string ordering</a>.</p>
<p>With <code>remap</code>, fixing this sort inconsistency couldn't be easier:</p>
<div class="codehilite"><pre><span class="kn">from</span> <span class="nn">boltons.iterutils</span> <span class="kn">import</span> <span class="n">remap</span>

<span class="k">def</span> <span class="nf">visit</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s">'id'</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span>

<span class="n">remapped</span> <span class="o">=</span> <span class="n">remap</span><span class="p">(</span><span class="n">event_list</span><span class="p">,</span> <span class="n">visit</span><span class="o">=</span><span class="n">visit</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">remapped</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">'id'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3165090957</span>

<span class="c"># You can even do it in one line:</span>
<span class="n">remap</span><span class="p">(</span><span class="n">event_list</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s">'id'</span> <span class="k">else</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
</pre></div>


<p>By default, <code>visit</code> gets called on every item in the root structure,
including <a href="https://docs.python.org/2/tutorial/datastructures.html#more-on-lists">lists</a>, <a href="https://docs.python.org/2/tutorial/datastructures.html#dictionaries">dicts</a>, and other containers, so let's take a closer
look at its signature. <code>visit</code> takes three arguments we're going to
see in all of remap's callbacks:</p>
<ul>
<li><code>path</code> is a <a href="https://docs.python.org/2/tutorial/datastructures.html#tuples-and-sequences">tuple</a> of keys leading up to the current item</li>
<li><code>key</code> is the current item's key</li>
<li><code>value</code> is the current item's value</li>
</ul>
<p><code>key</code> and <code>value</code> are exactly what you would expect, though it may
bear mentioning that the <code>key</code> for a list item is its index. <code>path</code>
refers to the keys of all the parents of the current item, not
including the <code>key</code>. For example, looking at
<a href="#github_event_data">the GitHub event data</a>, the commit author's
name's path is <code>(0, 'payload', 'commits', 0, 'author')</code>, because the
key, <code>name</code>, is located in the author of the first commit in the
payload of the first event.</p>
<p>As for the return signature of <code>visit</code>, it's very similar to the
input. Just return the new <code>(key, value)</code> you want in the remapped
output.</p>

<p>Next up, GitHub's move away from <a href="https://en.wikipedia.org/wiki/Gravatar">Gravatars</a> left an
artifact in their API: a blank <code>'gravatar_id'</code> key. We can get rid of
that item, and any other blank strings, in a jiffy:</p>
<div class="codehilite"><pre><span class="n">drop_blank</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span> <span class="o">!=</span> <span class="s">""</span>
<span class="n">remapped</span> <span class="o">=</span> <span class="n">remap</span><span class="p">(</span><span class="n">event_list</span><span class="p">,</span> <span class="n">visit</span><span class="o">=</span><span class="n">drop_blank</span><span class="p">)</span>

<span class="k">assert</span> <span class="s">'gravatar_id'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">remapped</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">'actor'</span><span class="p">]</span>
</pre></div>


<p>Unlike the previous example, instead of a <code>(key, value)</code> pair, this
<code>visit</code> is returning a <code>bool</code>. For added convenience, when <code>visit</code>
returns <code>True</code>, <code>remap</code> carries over the original item
unmodified. Returning <code>False</code> drops the item from the remapped structure.</p>
<p>With the ability to arbitrarily transform items, pass through old
items, and drop items from the remapped structure, it's clear that the
<code>visit</code> function makes the majority of recursive transformations
trivial. So many tedious and error-prone lines of traversal code turn
into one-liners that usually <code>remap</code> with a <code>visit</code> callback is all
one needs. With that said, the next recipes focus on <code>remap</code>'s more
advanced callable arguments, <code>enter</code> and <code>exit</code>.</p>

<p>So far we've looked at actions on remapping individual items, using
the <code>visit</code> callable. Now we turn our attention to actions on
containers, the parent objects of individual items. We'll start doing
this by looking at the <code>enter</code> argument to <code>remap</code>.</p>
<div class="codehilite"><pre><span class="c"># from collections import OrderedDict</span>
<span class="kn">from</span> <span class="nn">boltons.dictutils</span> <span class="kn">import</span> <span class="n">OrderedMultiDict</span> <span class="k">as</span> <span class="n">OMD</span>
<span class="kn">from</span> <span class="nn">boltons.iterutils</span> <span class="kn">import</span> <span class="n">remap</span><span class="p">,</span> <span class="n">default_enter</span>

<span class="k">def</span> <span class="nf">enter</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">OMD</span><span class="p">(),</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">default_enter</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<span class="n">remapped</span> <span class="o">=</span> <span class="n">remap</span><span class="p">(</span><span class="n">review_list</span><span class="p">,</span> <span class="n">enter</span><span class="o">=</span><span class="n">enter</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">remapped</span><span class="p">[</span><span class="s">'reviews'</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">'movies'</span>
<span class="c"># True because 'reviews' is now ordered and 'movies' comes before 'shows'</span>
</pre></div>


<p>The <code>enter</code> callable controls both if and how an object is
traversed. Like <code>visit</code>, it accepts <code>path</code>, <code>key</code>, and <code>value</code>. But
instead of <code>(key, value)</code>, it returns a tuple of <code>(new_parent,
items)</code>. <code>new_parent</code> is the container that will receive items
remapped by the <code>visit</code> callable. <code>items</code> is an iterable of <code>(key,
value)</code> pairs that will be passed to <code>visit</code>. Alternatively, <code>items</code>
can be <code>False</code>, to tell remap that the current value should not be
traversed, but that's getting pretty advanced. The API docs have some
other <code>enter</code> details to consider.</p>
<p>Also note how this code builds on the default remap logic by calling
through to the <code>default_enter</code> function, imported from the same place
as <code>remap</code> itself. Most practical use cases will want to do this, but
of course the choice is yours.</p>

<p>The last example used <code>enter</code> to interact with containers before they
were being traversed. This time, to sort all lists in a structure,
we'll use the <code>remap</code>'s final callable argument: <code>exit</code>.</p>
<div class="codehilite"><pre><span class="kn">from</span> <span class="nn">boltons.iterutils</span> <span class="kn">import</span> <span class="n">remap</span><span class="p">,</span> <span class="n">default_exit</span>

<span class="k">def</span> <span class="nf">exit</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">old_parent</span><span class="p">,</span> <span class="n">new_parent</span><span class="p">,</span> <span class="n">new_items</span><span class="p">):</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">default_exit</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">old_parent</span><span class="p">,</span> <span class="n">new_parent</span><span class="p">,</span> <span class="n">new_items</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ret</span>

<span class="n">remap</span><span class="p">(</span><span class="n">review_list</span><span class="p">,</span> <span class="nb">exit</span><span class="o">=</span><span class="nb">exit</span><span class="p">)</span>
</pre></div>


<p>Similar to the <code>enter</code> example, we're building on <code>remap</code>'s default
behavior by importing and calling <code>default_exit</code>. Looking at the
arguments passed to <code>exit</code> and <code>default_exit</code>, there's the <code>path</code> and
<code>key</code> that we're used to from <code>visit</code> and <code>enter</code>. <code>value</code> is there,
too, but it's named <code>old_parent</code>, to differentiate it from the new
value, appropriately called <code>new_parent</code>. At the point <code>exit</code> is
called, <code>new_parent</code> is just an empty structure as constructed by
<code>enter</code>, and <code>exit</code>'s job is to fill that new container with
<code>new_items</code>, a list of <code>(key, value)</code> pairs returned by <code>remap</code>'s
calls to <code>visit</code>. Still with me?</p>
<p>Either way, here we don't interact with the arguments. We just call
<code>default_exit</code> and work on its return value, <code>new_parent</code>, sorting it
in-place if it's a <code>list</code>. Pretty simple! In fact, <em>very</em> attentive
readers might point out this can be done with <code>visit</code>, because
<code>remap</code>'s very next step is to call <code>visit</code> with the
<code>new_parent</code>. You'll have to forgive the contrived example and let it
be a testament to the rarity of overriding <code>exit</code>. Without going into
the details, <code>enter</code> and <code>exit</code> are most useful when teaching <code>remap</code>
how to traverse nonstandard containers, such as non-iterable Python
objects. As mentioned in the <a href="#drop_empty_values">"drop empty values"</a>
example, <code>remap</code> is designed to maximize the mileage you get out of
the <code>visit</code> callback. Let's look at an advanced usage reason that's
true.</p>

<p>Sometimes you just want to traverse a nested structure, and you don't
need the result. For instance, if we wanted to collect the full set of
tags used in media reviews. Let's create a <code>remap</code>-based function,
<code>get_all_tags</code>:</p>
<div class="codehilite"><pre><span class="k">def</span> <span class="nf">get_all_tags</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
    <span class="n">all_tags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">visit</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">all_tags</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s">'tags'</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="n">remap</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">visit</span><span class="o">=</span><span class="n">visit</span><span class="p">,</span> <span class="n">reraise_visit</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">all_tags</span>

<span class="k">print</span><span class="p">(</span><span class="n">get_all_tags</span><span class="p">(</span><span class="n">review_map</span><span class="p">))</span>
<span class="c"># set(['space', 'comedy', 'life'])</span>
</pre></div>


<p>Like the first recipe, we've used the <code>visit</code> argument to <code>remap</code>, and
like the second recipe, we're just returning <code>False</code>, because we don't
actually care about contents of the resulting structure.</p>
<p>What's new here is the <code>reraise_visit=False</code> keyword argument, which
tells <code>remap</code> to <strong>keep</strong> any item that causes a <code>visit</code> exception. This
practical convenience lets <code>visit</code> functions be shorter, clearer, and
just more <acronym title="Easier to Ask Forgiveness than&#10;Permission"><a href="https://en.wikipedia.org/wiki/Python_syntax_and_semantics#Exceptions">EAFP</a></acronym>. Reducing the example to a
one-liner is left as an exercise to the reader.</p>

<p>As a final advanced <code>remap</code> example, let's look at adding items to
structures. Through the examples above, we've learned that <code>visit</code> is
best-suited for 1:1 transformations and dropping values. This leaves
us with two main approaches for addition. The first uses the <code>enter</code>
callable and is suitable for making data consistent and adding data
which can be overridden.</p>
<div class="codehilite"><pre><span class="n">base_review</span> <span class="o">=</span> <span class="p">{</span><span class="s">'title'</span><span class="p">:</span> <span class="s">''</span><span class="p">,</span>
               <span class="s">'rating'</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
               <span class="s">'review'</span><span class="p">:</span> <span class="s">''</span><span class="p">,</span>
               <span class="s">'tags'</span><span class="p">:</span> <span class="p">[]}</span>

<span class="k">def</span> <span class="nf">enter</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="n">new_parent</span><span class="p">,</span> <span class="n">new_items</span> <span class="o">=</span> <span class="n">default_enter</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">new_parent</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">base_review</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">new_parent</span><span class="p">,</span> <span class="n">new_items</span>

<span class="n">remapped</span> <span class="o">=</span> <span class="n">remap</span><span class="p">(</span><span class="n">review_list</span><span class="p">,</span> <span class="n">enter</span><span class="o">=</span><span class="n">enter</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">review_list</span><span class="p">[</span><span class="s">'shows'</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s">'review'</span><span class="p">]</span> <span class="o">==</span> <span class="s">''</span>
<span class="c"># True, the placeholder review is holding its place</span>
</pre></div>


<p>The second method uses the <code>exit</code> callback to override values and
calculate new values from the new data.</p>
<div class="codehilite"><pre><span class="k">def</span> <span class="nf">exit</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">old_parent</span><span class="p">,</span> <span class="n">new_parent</span><span class="p">,</span> <span class="n">new_items</span><span class="p">):</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">default_exit</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">old_parent</span><span class="p">,</span> <span class="n">new_parent</span><span class="p">,</span> <span class="n">new_items</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ret</span><span class="p">[</span><span class="s">'review_length'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">[</span><span class="s">'review'</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">ret</span>

<span class="n">remapped</span> <span class="o">=</span> <span class="n">remap</span><span class="p">(</span><span class="n">review_list</span><span class="p">,</span> <span class="nb">exit</span><span class="o">=</span><span class="nb">exit</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">remapped</span><span class="p">[</span><span class="s">'shows'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">'review_length'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">27</span>
<span class="k">assert</span> <span class="n">remapped</span><span class="p">[</span><span class="s">'movies'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">'review_length'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">42</span>
<span class="c"># True times two.</span>
</pre></div>


<p>By now you might agree that <code>remap</code> is making such feats positively
routine. Come for the nested data manipulation, stay for the
<a href="https://en.wikipedia.org/wiki/Phrases_from_The_Hitchhiker's_Guide_to_the_Galaxy#Answer_to_the_Ultimate_Question_of_Life.2C_the_Universe.2C_and_Everything_.2842.29">number jokes</a>.</p>

<p>This whole guide has focused on data that came from "real-world"
sources, such as JSON API responses. But there are certain rare cases
which typically only arise from within Python code:
<a href="http://pythondoeswhat.blogspot.com/2015/09/loopy-references.html">self-referential objects</a>. These are objects that
contain references to themselves or their parents. Have a look at this
trivial example:</p>
<div class="codehilite"><pre><span class="n">self_ref</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">self_ref</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">self_ref</span><span class="p">)</span>
</pre></div>


<p>The experienced programmer has probably seen this before, but most
Python coders might even think the second line is an error. It's a
list containing itself, and it has the rather cool <a href="https://docs.python.org/2/reference/datamodel.html#object.__repr__">repr</a>:
<code>[[...]]</code>.</p>
<p>Now, this is pretty rare, but reference loops do come up in
programming. The <em>good</em> news is that remap handles these just fine:</p>
<div class="codehilite"><pre><span class="k">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">remap</span><span class="p">(</span><span class="n">self_ref</span><span class="p">)))</span>
<span class="c"># prints "[[...]]"</span>
</pre></div>


<p>The more common corner case that arises is that of duplicate
references, which remap also handles with no problem:</p>
<div class="codehilite"><pre><span class="n">my_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

<span class="n">dupe_ref</span> <span class="o">=</span> <span class="p">(</span><span class="n">my_set</span><span class="p">,</span> <span class="p">[</span><span class="n">my_set</span><span class="p">])</span>
<span class="n">remapped</span> <span class="o">=</span> <span class="n">remap</span><span class="p">(</span><span class="n">dupe_ref</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">remapped</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="n">remapped</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="c"># True, of course</span>
</pre></div>


<p>Two references to the same set go in, two references to a copy of that
set come out. That's right: only one copy is made, and then used
twice, preserving the original structure.</p>

<p>If you've made it this far, then I hope you'll agree that <code>remap</code> is
useful enough to be your new friend. If that wasn't enough detail,
then <a href="http://boltons.readthedocs.org/en/latest/iterutils.html#boltons.iterutils.remap">there are the docs</a>. <code>remap</code> is
<a href="https://github.com/mahmoud/boltons/blob/master/tests/test_iterutils.py">well-tested</a>, but making something this
general-purpose is a tricky area. Please
<a href="https://github.com/mahmoud/boltons/issues">file bugs and requests</a>. Don't forget about <a href="https://docs.python.org/2/library/pprint.html">pprint</a>
and <a href="https://docs.python.org/2/library/repr.html">repr</a>/<a href="https://docs.python.org/3/library/reprlib.html">reprlib</a>, which can help with reading
large structures. As always, <a href="https://twitter.com/mhashemi">stay tuned</a> for <a href="/tagged/boltons/">future boltons
cookbooklets</a>, and much much more.</p>
<p><a href="https://commons.wikimedia.org/wiki/File:First_matryoshka_museum_doll_open.jpg">
<img src="/uploads/First_matryoshka_museum_doll_open.jpg"/>
</a></p>


<p/>



<hr/>


  </div>
  </div></body></html>