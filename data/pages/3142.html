<html><body><div><div itemprop="articleBody"><p>Suppose you have a brand new nonblocking socket and you want to do something with it (i have a connect in mind - but it's irrelevant anyway). So what is your obvious choice for that since the socket is non-blocking? Use select or poll or whatever ofcourse. Right? NO.</p><p>Sadly they don't work the same with unconnected sockets - I wonder why.</p><p>select (win32):</p><div class="highlight"><pre><span/><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">select</span><span class="o">,</span> <span class="nn">socket</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">s</span><span class="p">],</span> <span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
<span class="go">([], [], [])</span>
</pre></div><p>select (linux):</p><div class="highlight"><pre><span/><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">select</span><span class="o">,</span> <span class="nn">socket</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">s</span><span class="p">],</span> <span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
<span class="go">([], [], [])</span>
</pre></div><p>select (freebsd):</p><div class="highlight"><pre><span/><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">select</span><span class="o">,</span> <span class="nn">socket</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">s</span><span class="p">],</span> <span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
<span class="go">([], [], [])</span>
</pre></div><p>Pretty inconsistent eh?</p><p>poll (linux):</p><div class="highlight"><pre><span/><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">select</span><span class="o">,</span> <span class="nn">socket</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">poll</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">poll</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">select</span><span class="o">.</span><span class="n">POLLIN</span> <span class="o">|</span> <span class="n">select</span><span class="o">.</span><span class="n">POLLOUT</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">ev</span><span class="p">),</span> <span class="o">=</span> <span class="n">poll</span><span class="o">.</span><span class="n">poll</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ev</span> <span class="o">&amp;</span> <span class="n">select</span><span class="o">.</span><span class="n">POLLIN</span>
<span class="go">0</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ev</span> <span class="o">&amp;</span> <span class="n">select</span><span class="o">.</span><span class="n">POLLOUT</span>
<span class="go">4</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ev</span> <span class="o">&amp;</span> <span class="n">select</span><span class="o">.</span><span class="n">POLLERR</span>
<span class="go">0</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ev</span> <span class="o">&amp;</span> <span class="n">select</span><span class="o">.</span><span class="n">POLLHUP</span>
<span class="go">16</span>
</pre></div><p>poll (freebsd):</p><div class="highlight"><pre><span/><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">select</span><span class="o">,</span> <span class="nn">socket</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">poll</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">poll</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">select</span><span class="o">.</span><span class="n">POLLIN</span> <span class="o">|</span> <span class="n">select</span><span class="o">.</span><span class="n">POLLOUT</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">ev</span><span class="p">),</span> <span class="o">=</span> <span class="n">poll</span><span class="o">.</span><span class="n">poll</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">"..."</span>, line <span class="m">1</span>, in <span class="n">...</span>
<span class="gr">ValueError</span>: <span class="n">need more than 0 values to unpack</span>
</pre></div><p>Oh NOES!!!!1 It's not portable. <a class="reference external" href="http://pypi.python.org/pypi/py-epoll/1.2">epoll</a>:</p><div class="highlight"><pre><span/><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">epoll</span><span class="o">,</span> <span class="nn">socket</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">efd</span> <span class="o">=</span> <span class="n">epoll</span><span class="o">.</span><span class="n">epoll_create</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">epoll</span><span class="o">.</span><span class="n">epoll_ctl</span><span class="p">(</span><span class="n">efd</span><span class="p">,</span> <span class="n">epoll</span><span class="o">.</span><span class="n">EPOLL_CTL_ADD</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">epoll</span><span class="o">.</span><span class="n">EPOLLIN</span> <span class="o">|</span> <span class="n">epoll</span><span class="o">.</span><span class="n">EPOLLOUT</span><span class="p">)</span>
<span class="go">0</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="n">fd</span><span class="p">),</span> <span class="o">=</span> <span class="n">epoll</span><span class="o">.</span><span class="n">epoll_wait</span><span class="p">(</span><span class="n">efd</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ev</span> <span class="o">&amp;</span> <span class="n">epoll</span><span class="o">.</span><span class="n">EPOLLHUP</span>
<span class="go">16</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ev</span> <span class="o">&amp;</span> <span class="n">epoll</span><span class="o">.</span><span class="n">EPOLLOUT</span>
<span class="go">4</span>
</pre></div><p><a class="reference external" href="http://pypi.python.org/pypi/py-kqueue/2.0">kqueue</a>:</p><div class="highlight"><pre><span/><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">kqueue</span><span class="o">,</span> <span class="nn">socket</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">kq</span> <span class="o">=</span> <span class="n">kqueue</span><span class="o">.</span><span class="n">kqueue</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">kq</span><span class="o">.</span><span class="n">kevent</span><span class="p">(</span><span class="n">kqueue</span><span class="o">.</span><span class="n">EV_SET</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">kqueue</span><span class="o">.</span><span class="n">EVFILT_READ</span> <span class="o">|</span> <span class="n">kqueue</span><span class="o">.</span><span class="n">EVFILT_WRITE</span><span class="p">,</span> <span class="n">kqueue</span><span class="o">.</span><span class="n">EV_ADD</span> <span class="o">|</span> <span class="n">kqueue</span><span class="o">.</span><span class="n">EV_ENABLE</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">kq</span><span class="o">.</span><span class="n">kevent</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1000000000</span><span class="p">)</span>
<span class="go">[]</span>
</pre></div><p>I wonder why are these so inconsistent. One would expect come consistent results for multiplexing a simple thing such a unconnected brand new socket, no?If you think that is horrible - well, I do - check out the tricks to check for connection success on non-blocking sockets - and they don't cover win32:</p><p>However, win32 has a much nicer api in the so called overlapped io wich is very different: you don't need to check the sockets before making a operation - you just make the socket call with a overlapped and check for for completed calls (via io completion ports - <a class="reference external" href="http://msdn2.microsoft.com/en-us/library/aa364986(VS.85).aspx">gqcs</a>). Still, you can use some selects variants (<a class="reference external" href="http://msdn2.microsoft.com/en-us/library/ms741540%28VS.85%29.aspx">WSAAsyncSelect</a>, <a class="reference external" href="http://msdn2.microsoft.com/en-us/library/ms741576%28VS.85%29.aspx">WSAEventSelect</a>, <a class="reference external" href="http://msdn2.microsoft.com/en-us/library/ms740141%28VS.85%29.aspx">select</a>) wich are just as bad. ** **</p><p>Unfortunately python has a incomplete binding, pywin32 (not that bad - only <strong>ConnectEx</strong> and TransmitFile missing) for that and it's actually fairly easy to crash your python interpreter with this.</p></div></div></body></html>