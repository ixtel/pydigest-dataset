<html><body><div><div class="blog-entry" id="e20150429T200600"><p>A recent pull request for coverage.py by Conrad Ho added a timestamp to the
    HTML report pages.  Of course, it included tests. They needed a little
    cleaning up, because they dealt with the current time, and that always
    gets involved.</p><p>The
    <a href="https://bitbucket.org/ned/coveragepy/commits/5ca71b85c47c3d45931601b2ad45ddb057d6ce05">original
    test</a> looked like this:</p><blockquote class="code"><code><span class="k">def</span> <span class="nf">test_has_date_stamp_in_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><br/>    <span class="bp">self</span><span class="o">.</span><span class="n">run_coverage</span><span class="p">()</span><br/>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"htmlcov/index.html"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span><br/>        <span class="n">index</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><br/>    <span class="n">time_stamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M'</span><span class="p">)</span><br/>    <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">"&lt;p&gt;Created on {}&lt;/p&gt;"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_stamp</span><span class="p">),</span> <span class="n">index</span><span class="p">)</span><br/></code></blockquote><p>Here, run_coverage creates the HTML report, then the test reads the HTML
    file directly, computes the expected timestamp, and then checks that the
    expected timestamp is in the file.</p><p>Seems straightforward enough, but there's a problem.  Deep inside
    run_coverage is a call to datetime.now() to get the current time to create
    the timestamp.  Then in our test, we call datetime.now() again to create
    the expected timestamp.  The problem is that because we call now() twice,
    they will return different times.  Even formatting to hours and minutes as
    we do, the timestamps could be different.</p><p>This test will very occasionally fail: it is a flaky test, which is a very
    bad thing.  Some of the existing tests in the test suite weren't changed
    in this pull request, but they also become flaky.  They looked kind of
    like this:</p><blockquote class="code"><code><span class="k">def</span> <span class="nf">test_html_delta_from_source_change</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><br/>    <span class="bp">self</span><span class="o">.</span><span class="n">run_coverage</span><span class="p">()</span><br/>    <span class="n">index1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_html_index_content</span><span class="p">()</span><br/><br/>    <span class="c"># ... change some stuff ...</span><br/><br/>    <span class="bp">self</span><span class="o">.</span><span class="n">run_coverage</span><span class="p">()</span><br/>    <span class="n">index2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_html_index_content</span><span class="p">()</span><br/>    <span class="bp">self</span><span class="o">.</span><span class="n">assertMultiLineEqual</span><span class="p">(</span><span class="n">index1</span><span class="p">,</span> <span class="n">index2</span><span class="p">)</span><br/></code></blockquote><p>Here, we're creating two different HTML reports, and asserting that they are
    the same.  But run_coverage() in each calls now() at different times, so
    the timestamps can differ in them.  Some might say that the chances are
    really small, and a very occasional test failure is not worth the extra
    complexity.  True story: the first time these tests were run on Travis,
    they failed because of different timestamps!</p><p>One way to solve time problems like this is to mock out datetime.now(), but
    <a href="http://nedbatchelder.com/blog/201209/mocking_datetimetoday.html">that can be complicated</a>.
    So I took different approaches.</p><p>The second tests were straightforward to make impervious to the time
    changes.  In that case, I
    <a href="https://bitbucket.org/ned/coveragepy/commits/f040027819bf92801e9484e93673e49fc62ebc71">amended get_html_index_content</a>
    to strip out the timestamp:</p><blockquote class="code"><code><span class="k">def</span> <span class="nf">get_html_index_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><br/>    <span class="sd">"""Return the content of index.html, with timestamps scrubbed."""</span><br/>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"htmlcov/index.html"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span><br/>        <span class="n">index</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><br/>    <span class="n">index</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><br/>        <span class="s">r"created at \d{4}-\d{2}-\d{2} \d{2}:\d{2}"</span><span class="p">,</span><br/>        <span class="s">r"created at YYYY-MM-DD HH:MM"</span><span class="p">,</span><br/>        <span class="n">index</span><span class="p">,</span><br/>    <span class="p">)</span><br/>    <span class="k">return</span> <span class="n">index</span><br/></code></blockquote><p>Now the text of index.html doesn't have the timestamp, so the value of now()
    doesn't matter, and the tests aren't flaky.  These are tests of other
    aspects than the timestamp, so it's fine to just remove the timestamp.</p><p>But the first tests were about the timestamp itself, we can't just scrub it
    from the output.  For those tests, I chose a different approach: extract
    the timestamp from the HTML, and check that it is a very recent timestamp:</p><blockquote class="code"><code><span class="k">def</span> <span class="nf">test_has_date_stamp_in_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><br/>    <span class="bp">self</span><span class="o">.</span><span class="n">run_coverage</span><span class="p">()</span><br/>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"htmlcov/index.html"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span><br/>        <span class="bp">self</span><span class="o">.</span><span class="n">assert_correct_timestamp</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span><br/><br/><span class="k">def</span> <span class="nf">assert_correct_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html</span><span class="p">):</span><br/>    <span class="sd">"""Extract the timestamp from `html`, and assert it is recent."""</span><br/>    <span class="n">timestamp_pat</span> <span class="o">=</span> <span class="s">r"created at (\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2})"</span><br/>    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">timestamp_pat</span><span class="p">,</span> <span class="n">html</span><span class="p">)</span><br/>    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">"Didn't find a timestamp!"</span><span class="p">)</span><br/>    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()))</span><br/><br/>    <span class="n">age</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timestamp</span><br/>    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">age</span><span class="o">.</span><span class="n">days</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><br/>    <span class="c"># The timestamp only records the minute, so the delta could be from</span><br/>    <span class="c"># 12:00 to 12:01:59, or two minutes.</span><br/>    <span class="bp">self</span><span class="o">.</span><span class="n">assertLessEqual</span><span class="p">(</span><br/>        <span class="nb">abs</span><span class="p">(</span><span class="n">age</span><span class="o">.</span><span class="n">seconds</span><span class="p">),</span><br/>        <span class="mi">120</span><span class="p">,</span><br/>        <span class="s">"Timestamp is wrong: {0}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span><br/>    <span class="p">)</span><br/></code></blockquote><p>Here I have a new method, assert_correct_timestamp. It takes the content of
    the HTML, extracts the timestamp with a regex, converts it into a datetime,
    and then checks that the datetime is recent.  This fixes the flaky test: it
    will not fail due to shifting time windows.</p><p>But now the test method has a bunch of code for figuring out if the datetime
    is recent.  And it has a bug: I used abs(age.seconds) &lt; 120, which will
    pass if the datetime is in the near future as well as in the near past.</p><p>This test has two ideas in it: get the timestamp from the HTML code, and
    check if it is recent.  Better would be to
    <a href="https://bitbucket.org/ned/coveragepy/commits/510aa19a8bbfba34d5c223f9e78a7b67221dae7f">factor out that second part</a>
    into its own datetime assert method:</p><blockquote class="code"><code><span class="k">def</span> <span class="nf">assert_recent_datetime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span><br/>    <span class="sd">"""Assert that `dt` marks a time at most `seconds` seconds ago."""</span><br/>    <span class="n">age</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">dt</span><br/>    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">age</span><span class="o">.</span><span class="n">days</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span><br/>    <span class="bp">self</span><span class="o">.</span><span class="n">assertGreaterEqual</span><span class="p">(</span><span class="n">age</span><span class="o">.</span><span class="n">seconds</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span><br/>    <span class="bp">self</span><span class="o">.</span><span class="n">assertLessEqual</span><span class="p">(</span><span class="n">age</span><span class="o">.</span><span class="n">seconds</span><span class="p">,</span> <span class="n">seconds</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span><br/></code></blockquote><p>This assert method is purely about datetimes and their recency.  We've fixed
    the bug with the near future.  Now we can test this assert method directly
    to be sure we have the logic right:</p><blockquote class="code"><code><span class="k">def</span> <span class="nf">test_assert_recent_datetime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><br/>    <span class="k">def</span> <span class="nf">now_delta</span><span class="p">(</span><span class="n">seconds</span><span class="p">):</span><br/>        <span class="sd">"""Make a datetime `seconds` seconds from now."""</span><br/>        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">seconds</span><span class="p">)</span><br/><br/>    <span class="c"># Default delta is 10 seconds.</span><br/>    <span class="bp">self</span><span class="o">.</span><span class="n">assert_recent_datetime</span><span class="p">(</span><span class="n">now_delta</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><br/>    <span class="bp">self</span><span class="o">.</span><span class="n">assert_recent_datetime</span><span class="p">(</span><span class="n">now_delta</span><span class="p">(</span><span class="o">-</span><span class="mi">9</span><span class="p">))</span><br/>    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AssertionError</span><span class="p">):</span><br/>        <span class="bp">self</span><span class="o">.</span><span class="n">assert_recent_datetime</span><span class="p">(</span><span class="n">now_delta</span><span class="p">(</span><span class="o">-</span><span class="mi">11</span><span class="p">))</span><br/>    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AssertionError</span><span class="p">):</span><br/>        <span class="bp">self</span><span class="o">.</span><span class="n">assert_recent_datetime</span><span class="p">(</span><span class="n">now_delta</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><br/><br/>    <span class="c"># Delta is settable.</span><br/>    <span class="bp">self</span><span class="o">.</span><span class="n">assert_recent_datetime</span><span class="p">(</span><span class="n">now_delta</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">seconds</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span><br/>    <span class="bp">self</span><span class="o">.</span><span class="n">assert_recent_datetime</span><span class="p">(</span><span class="n">now_delta</span><span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">),</span> <span class="n">seconds</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span><br/>    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AssertionError</span><span class="p">):</span><br/>        <span class="bp">self</span><span class="o">.</span><span class="n">assert_recent_datetime</span><span class="p">(</span><span class="n">now_delta</span><span class="p">(</span><span class="o">-</span><span class="mi">1000</span><span class="p">),</span> <span class="n">seconds</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span><br/>    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AssertionError</span><span class="p">):</span><br/>        <span class="bp">self</span><span class="o">.</span><span class="n">assert_recent_datetime</span><span class="p">(</span><span class="n">now_delta</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">seconds</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span><br/></code></blockquote><p>And with all that in place, we can simplify our HTML report test:</p><blockquote class="code"><code><span class="k">def</span> <span class="nf">assert_correct_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html</span><span class="p">):</span><br/>    <span class="sd">"""Extract the timestamp from `html`, and assert it is recent."""</span><br/>    <span class="n">timestamp_pat</span> <span class="o">=</span> <span class="s">r"created at (\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2})"</span><br/>    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">timestamp_pat</span><span class="p">,</span> <span class="n">html</span><span class="p">)</span><br/>    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">"Didn't find a timestamp!"</span><span class="p">)</span><br/>    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()))</span><br/>    <span class="c"># The timestamp only records the minute, so the delta could be from</span><br/>    <span class="c"># 12:00:00 to 12:01:59, or two minutes.</span><br/>    <span class="bp">self</span><span class="o">.</span><span class="n">assert_recent_datetime</span><span class="p">(</span><br/>        <span class="n">timestamp</span><span class="p">,</span><br/>        <span class="n">seconds</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span><br/>        <span class="n">msg</span><span class="o">=</span><span class="s">"Timestamp is wrong: {0}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timestamp</span><span class="p">),</span><br/>        <span class="p">)</span><br/></code></blockquote><p>Nice.</p></div></div></body></html>