<html><body><div><div class="col-md-12">
				<p>If you’re curious to find out how to launch yourself into outer space and land on Mars, you’ve come to the right place. With the help of an open source image processing library called OpenCV, along with Twilio MMS, Python, and Flask we are limited only by our imagination.</p>
<p>And if you haven’t seen The Martian yet, seriously, what are you waiting for? The movie is really good, <a href="http://www.wired.com/2015/09/science-martian-isnt-perfect-thats-ok/">filled with science</a>, <a href="https://twitter.com/RachelAppel/status/650157158261243904">Matt Damon</a> and <a href="https://media2.giphy.com/media/105OwsN7a4UQ2Q/200.gif">potatoes</a>.</p>
<p>When Twilio decided to host a private screening of The Martian as a way for the community to come together, it seemed like the perfect opportunity to make something fun for people to play with as they filed into the theater.</p>
<p>Instead of giving you a hipster mustache, I opted to remix Rob Spectre’s <a href="https://www.twilio.com/blog/2014/09/how-to-build-a-mustached-message-service-with-twilio-mms-and-python.html">Mustachify</a> for The Martian, Martianify! Because what’s a better way to kill time than to take selfies? You know you were going to do it anyway. So why not send one to this Twilio number and see what happens? Go on, give it a try.</p>
<p><strong>United States: (347) 537-3850</strong></p>
<p> </p>
<p><img class="&quot; aligncenter" title="" src="https://www.twilio.com/blog/wp-content/uploads/2015/11/uwZsqt_APqslTEeWPxZriIWcKt_yH44Z65huZl-ccQGR5Uo1glyUQi69_3-rfnJurPlh4jrjVNHGdCHK4ZuJ5gOa4WuGdAQ_azue8AzvPg58vY0nnPrAq-4PCeK-debhUPa9K54.png" alt=""/></p>
<p> </p>
<h3>GETTING STARTED</h3>
<p>To kick things off, let’s take a look at our dependencies.</p>
<ul>
<li>A Twilio account. <a href="https://www.twilio.com/try-twilio">Sign up for your free account </a>if you don’t have one already.</li>
<li>A Twilio phone number with MMS capability. These are only available in the United States and Canada.</li>
<li>A publicly accessible URL to configure Twilio webhook (<a href="https://www.twilio.com/blog/2015/09/6-awesome-reasons-to-use-ngrok-when-testing-webhooks.html">try ngrok</a>)</li>
<li>Twilio <a href="https://www.twilio.com/docs/python/install">Python helper library</a> to create our TwiML</li>
<li>Python 2.x (Python 3.x is compatible with OpenCV; however the setup instructions are different)</li>
<li><a href="https://pypi.python.org/pypi/pip">Pip</a>, the friendly Python Package Installer</li>
<li><a href="http://opencv.org/downloads.html">Op</a><a href="http://opencv.org/downloads.html">enCV 2.4.</a><a href="http://opencv.org/downloads.html">12</a> (Don’t worry, we’ll walk through the setup below)</li>
<li><a href="http://flask.pocoo.org/">Flask</a>, the Python web microframework</li>
<li><a href="https://drive.google.com/a/twilio.com/file/d/0B3d-cfkKzKl7bFI4cF9jN3RDS0U/view">The Martian Helmet Image</a></li>
</ul>
<p>With that, let’s get started. If you are using a Twilio trial account for this example, you will only be able to send messages to phone numbers that you have verified with Twilio. Phone numbers can be verified via your <a href="https://www.twilio.com/user/account/phone-numbers/incoming">Twilio Account’s Phone Numbers Page</a>.</p>
<h3>THE GREAT INSTALL</h3>
<p>We’ll kick things off by getting started with OpenCV on Mac. If you’re on Windows, try following <a href="http://kevinhughes.ca/tutorials/opencv-install-on-windows-with-codeblocks-and-mingw/">this tutorial</a>. Unfortunately, OpenCV is not available via pip. That means we have to install it manually. For this project I am using OpenCV 2.4.12.  If OpenCV is already installed on your computer, lucky you! You can check to see if you have it installed or double check your version in a python shell like this:</p>

		<div id="crayon-56d5b9d7d77db187112481" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b9d7d77db187112481-1"><span class="crayon-o">&gt;&gt;&gt;</span><span class="crayon-h"> </span><span class="crayon-e">import </span><span class="crayon-v">cv2</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d77db187112481-2"><span class="crayon-o">&gt;&gt;&gt;</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-e">.__version__</span></p><p class="crayon-line" id="crayon-56d5b9d7d77db187112481-3"><span class="crayon-s">'2.4.12'</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>If you were unable to import cv2, don’t worry – I’ll walk you through the steps you need to take using <a href="http://brew.sh">brew</a> on OS X to get OpenCV set up. You’ll also want to follow these instructions if your version is below OpenCV 2.0. If you’re running OpenCV 3.0.0 this code should be compatible.</p>

		<div id="crayon-56d5b9d7d77ee592029902" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b9d7d77ee592029902-1"><span class="crayon-e">brew </span><span class="crayon-e">tap </span><span class="crayon-v">homebrew</span><span class="crayon-o">/</span><span class="crayon-e">science</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d77ee592029902-2"><span class="crayon-e">brew </span><span class="crayon-e">install </span><span class="crayon-v">opencv</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>That brew install could take a while. But when it’s finished, find your OpenCV at the following path ending in your installed version number. Be mindful of your version and <a href="http://stackoverflow.com/questions/26647412/homebrew-could-not-symlink-usr-local-bin-is-not-writable">running into permissions problems on homebrew folders</a>.</p>

		<div id="crayon-56d5b9d7d77f9271154791" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b9d7d77f9271154791-1"><span class="crayon-r">cd</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">usr</span><span class="crayon-o">/</span><span class="crayon-v">local</span><span class="crayon-o">/</span><span class="crayon-v">Cellar</span><span class="crayon-o">/</span><span class="crayon-v">opencv</span><span class="crayon-o">/</span><span class="crayon-cn">2.4.12</span><span class="crayon-o">/</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>You’ll also need to configure OpenCV with Python. If you don’t know where your Python is installed, you can find it in .bash_profile:</p>

		<div id="crayon-56d5b9d7d7803443079029" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b9d7d7803443079029-1"><span class="crayon-r">cat</span><span class="crayon-h"> </span><span class="crayon-o">~</span><span class="crayon-o">/</span><span class="crayon-e">.bash_profile</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r">grep</span><span class="crayon-h"> </span><span class="crayon-v">PYTHONPATH</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>Inside of the Python path we will link our compiled OpenCV files with a <a href="https://kb.iu.edu/d/abbe">symlink</a>.</p>

		<div id="crayon-56d5b9d7d780d647374632" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b9d7d780d647374632-1"><span class="crayon-r">ln</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">s</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">usr</span><span class="crayon-o">/</span><span class="crayon-v">local</span><span class="crayon-o">/</span><span class="crayon-v">Cellar</span><span class="crayon-o">/</span><span class="crayon-v">opencv</span><span class="crayon-o">/</span><span class="crayon-cn">2.4.12</span><span class="crayon-o">/</span><span class="crayon-v">lib</span><span class="crayon-o">/</span><span class="crayon-v">python2</span><span class="crayon-sy">.</span><span class="crayon-cn">7</span><span class="crayon-o">/</span><span class="crayon-v">site</span><span class="crayon-o">-</span><span class="crayon-v">packages</span><span class="crayon-o">/</span><span class="crayon-v">cv</span><span class="crayon-e">.py</span><span class="crayon-h"> </span><span class="crayon-v">cv</span><span class="crayon-e">.py</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d780d647374632-2"><span class="crayon-r">ln</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">s</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">usr</span><span class="crayon-o">/</span><span class="crayon-v">local</span><span class="crayon-o">/</span><span class="crayon-v">Cellar</span><span class="crayon-o">/</span><span class="crayon-v">opencv</span><span class="crayon-o">/</span><span class="crayon-cn">2.4.12</span><span class="crayon-o">/</span><span class="crayon-v">lib</span><span class="crayon-o">/</span><span class="crayon-v">python2</span><span class="crayon-sy">.</span><span class="crayon-cn">7</span><span class="crayon-o">/</span><span class="crayon-v">site</span><span class="crayon-o">-</span><span class="crayon-v">packages</span><span class="crayon-o">/</span><span class="crayon-v">cv2</span><span class="crayon-e">.so</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-e">.so</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>Now retry your import in that Python shell.</p>

		<div id="crayon-56d5b9d7d7817180881697" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b9d7d7817180881697-1"><span class="crayon-o">&gt;&gt;&gt;</span><span class="crayon-e">import </span><span class="crayon-v">cv2</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7817180881697-2"><span class="crayon-o">&gt;&gt;&gt;</span><span class="crayon-v">cv2</span><span class="crayon-e">.__version__</span></p><p class="crayon-line" id="crayon-56d5b9d7d7817180881697-3"><span class="crayon-s">'2.4.12'</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p><img class="&quot; aligncenter" title="" src="https://www.twilio.com/blog/wp-content/uploads/2015/11/6mDLzn2aF07jyicsytih1QcezNNoBTD-MoSlgjgNAL6E6jaOLLs96vEW65-WZP0n-l3_Wk4fg_08my8U2fnhdbZeilPpXJD-GvvvfSc92J60G7ivYeAwxfCGM8IQ2lYqsAWvWoP8.png" alt=""/></p>
<h3>3, 2, 1… BLAST OFF!</h3>
<p>Just a little primer on OpenCV. It’s an open source library, which is fantastic. Along with Python, there are also  C , C++, and Java bindings. There is a pretty large community surrounding the library and it has many applications. We’re going to use something called <a href="http://docs.opencv.org/master/d7/d8b/tutorial_py_face_detection.html">Haar Feature-based Cascade Classifiers</a> to detect things like faces, eyes, noses, and so on. Using a machine learning approach, the classifiers detect features based upon the data it has been pre-trained with. OpenCV contains many of these pre-trained classifiers stored as XML files in <code>/usr/local/Cellar/opencv/2.4.12/share/OpenCV/haarcascades/</code>. You can also <a href="http://docs.opencv.org/master/dc/d88/tutorial_traincascade.html#gsc.tab=0">train classifiers for any object</a> like a car or an airplane using OpenCV to create one. We’re going to use the <a href="https://github.com/rajatsaxena/OpenCV/blob/16eef50da9d4771b301dcaceb6603ba838ce5b26/haarcascade_frontalface_default.xml">haarcascade_frontalface_default.xml</a> file.</p>

		<div id="crayon-56d5b9d7d7823549782211" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-56d5b9d7d7823549782211-1">1</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7823549782211-2">2</p><p class="crayon-num" data-line="crayon-56d5b9d7d7823549782211-3">3</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7823549782211-4">4</p><p class="crayon-num" data-line="crayon-56d5b9d7d7823549782211-5">5</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7823549782211-6">6</p><p class="crayon-num" data-line="crayon-56d5b9d7d7823549782211-7">7</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7823549782211-8">8</p><p class="crayon-num" data-line="crayon-56d5b9d7d7823549782211-9">9</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7823549782211-10">10</p><p class="crayon-num" data-line="crayon-56d5b9d7d7823549782211-11">11</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7823549782211-12">12</p><p class="crayon-num" data-line="crayon-56d5b9d7d7823549782211-13">13</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7823549782211-14">14</p><p class="crayon-num" data-line="crayon-56d5b9d7d7823549782211-15">15</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7823549782211-16">16</p><p class="crayon-num" data-line="crayon-56d5b9d7d7823549782211-17">17</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7823549782211-18">18</p><p class="crayon-num" data-line="crayon-56d5b9d7d7823549782211-19">19</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b9d7d7823549782211-1"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">cv2</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7823549782211-2"> </p><p class="crayon-line" id="crayon-56d5b9d7d7823549782211-3"><span class="crayon-v">face_cascade</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">CascadeClassifier</span><span class="crayon-sy">(</span><span class="crayon-s">'/path/to/haarcascade_frontalface_default.xml'</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7823549782211-4"><span class="crayon-v">original_image_path</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'/path/to/your/selfie'</span></p><p class="crayon-line" id="crayon-56d5b9d7d7823549782211-5"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7823549782211-6"><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">imread</span><span class="crayon-sy">(</span><span class="crayon-v">original_image_path</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b9d7d7823549782211-7"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7823549782211-8"><span class="crayon-v">faces</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">face_cascade</span><span class="crayon-sy">.</span><span class="crayon-e">detectMultiScale</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d5b9d7d7823549782211-9"><span class="crayon-h">                                      </span><span class="crayon-v">scaleFactor</span><span class="crayon-o">=</span><span class="crayon-cn">1.1</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7823549782211-10"><span class="crayon-h">                                      </span><span class="crayon-v">minNeighbors</span><span class="crayon-o">=</span><span class="crayon-cn">3</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d5b9d7d7823549782211-11"><span class="crayon-h">                                      </span><span class="crayon-v">minSize</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">30</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">30</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7823549782211-12"><span class="crayon-h">                                      </span><span class="crayon-v">flags</span><span class="crayon-o">=</span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">cv</span><span class="crayon-sy">.</span><span class="crayon-v">CV_HAAR_SCALE_IMAGE</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b9d7d7823549782211-13"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7823549782211-14"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-k ">w</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">h</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">faces</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b9d7d7823549782211-15"><span class="crayon-h">    </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">rectangle</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-k ">w</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">h</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">255</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7823549782211-16"> </p><p class="crayon-line" id="crayon-56d5b9d7d7823549782211-17"><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">imshow</span><span class="crayon-sy">(</span><span class="crayon-s">'Picture'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7823549782211-18"><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">waitKey</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b9d7d7823549782211-19"><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">destroyAllWindows</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>This is a good chunk of code, let’s break it down line by line.</p>
<p>Line 1: Import the OpenCV library.</p>
<p>Line 3: Load the classifier from file</p>
<p>Lines 4-6: Create an object of our selfie by providing the full path (be sure to change this to your own) and load the image into cv2.</p>
<p>Lines 8-11: Use the <a href="http://docs.opencv.org/2.4.9/modules/objdetect/doc/cascade_classification.html?highlight=detectmultiscale#cv2.CascadeClassifier.detectMultiScale">cv2.CascadeClassifier.detectMultiScale</a> function on an image to find objects of different sizes in the input image. The detected objects are returned as a list of rectangles. To learn more about what each parameter does check out the docs on <a href="http://docs.opencv.org/2.4.9/modules/objdetect/doc/cascade_classification.html?highlight=detectmultiscale#cv2.CascadeClassifier.detectMultiScale">Cascade Classification</a>.</p>
<p>Lines 12-13: Iterate through the corners of the faces detected and draw a rectangle in that pattern.</p>
<p>Lines 15-17: imShow() will display the image on screen and we’ll see how we did. waitKey() allows you to press any key to execute closing the image on destroyAllWindows().</p>
<p>Facial detection is more art than science and will vary depending on the image provided. Play around with the parameters of cv2.detectMultiScale to find what works for you. Once you feel comfortable with this step, go on.</p>
<p><img class="&quot; aligncenter" title="" src="https://www.twilio.com/blog/wp-content/uploads/2015/11/CcshPhZjHU9I8-ABBg2gra43WVQyXLw_RHac62ZCZtXtIS3FsvHWSZDX0QLHCbOMyGxU2U_GRU7_-AyjhfFhusjWFCPF4YwZMF0nB6dD_Z5cT1yS-e4dckBuM0IZL6L_rsAJgiVQ.png" alt=""/></p>
<h3>OH, LOOK AT ALL THE LOVELY FACES</h3>
<p>Great! We’re seeing faces. Now, let’s continue on our millions of miles journey to Mars.</p>
<p>We’ll reuse some of the code from above and add what we need to overlay The Martian helmet image on just the face. Make a file called <code>martianify.py</code>. This is what’s happening:</p>
<ul>
<li>Load Martian and Selfie images</li>
<li>Create masks for both</li>
<li>Sizing and padding of selfie image</li>
<li>Facial detection</li>
<li>Merge the two images</li>
</ul>
<p>In this first block, we’ll load the foreground image with <a href="http://docs.opencv.org/2.4.9/modules/highgui/doc/reading_and_writing_images_and_video.html?highlight=cv2.imread#cv2.imread">cv2.imread</a>.</p>
<p>Then, we’ll create masks which are used to identify the pixels that should be used when applied to an image. Read more about how we use <a href="http://docs.opencv.org/2.4.9/modules/core/doc/operations_on_arrays.html?highlight=bitwise_not#cv2.bitwise_not">cv2.bitwise_not</a> here.</p>
<p>In the final prep of the foreground, we’ll declare size and ratio for The Martian that we will use to fit our selfie into the hole.</p>

		<div id="crayon-56d5b9d7d7830090270172" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-56d5b9d7d7830090270172-1">1</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7830090270172-2">2</p><p class="crayon-num" data-line="crayon-56d5b9d7d7830090270172-3">3</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7830090270172-4">4</p><p class="crayon-num" data-line="crayon-56d5b9d7d7830090270172-5">5</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7830090270172-6">6</p><p class="crayon-num" data-line="crayon-56d5b9d7d7830090270172-7">7</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7830090270172-8">8</p><p class="crayon-num" data-line="crayon-56d5b9d7d7830090270172-9">9</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7830090270172-10">10</p><p class="crayon-num" data-line="crayon-56d5b9d7d7830090270172-11">11</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7830090270172-12">12</p><p class="crayon-num" data-line="crayon-56d5b9d7d7830090270172-13">13</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7830090270172-14">14</p><p class="crayon-num" data-line="crayon-56d5b9d7d7830090270172-15">15</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7830090270172-16">16</p><p class="crayon-num" data-line="crayon-56d5b9d7d7830090270172-17">17</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7830090270172-18">18</p><p class="crayon-num" data-line="crayon-56d5b9d7d7830090270172-19">19</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7830090270172-20">20</p><p class="crayon-num" data-line="crayon-56d5b9d7d7830090270172-21">21</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7830090270172-22">22</p><p class="crayon-num" data-line="crayon-56d5b9d7d7830090270172-23">23</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7830090270172-24">24</p><p class="crayon-num" data-line="crayon-56d5b9d7d7830090270172-25">25</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b9d7d7830090270172-1"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">cv2</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7830090270172-2"> </p><p class="crayon-line" id="crayon-56d5b9d7d7830090270172-3"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7830090270172-4"><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">martianify</span><span class="crayon-sy">(</span><span class="crayon-v">original_image_path</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b9d7d7830090270172-5"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7830090270172-6"><span class="crayon-h">    </span><span class="crayon-c"># Load the face detection cascade file.</span></p><p class="crayon-line" id="crayon-56d5b9d7d7830090270172-7"><span class="crayon-h">    </span><span class="crayon-v">face_cascade</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">CascadeClassifier</span><span class="crayon-sy">(</span><span class="crayon-s">'/path/to/haarcascade_frontalface_default.xml'</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7830090270172-8"> </p><p class="crayon-line" id="crayon-56d5b9d7d7830090270172-9"><span class="crayon-h">    </span><span class="crayon-c"># Load our Martian as foreground image with alpha transparency.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7830090270172-10"><span class="crayon-h">    </span><span class="crayon-c"># The -1 reads the alpha transparency of our image otherwise</span></p><p class="crayon-line" id="crayon-56d5b9d7d7830090270172-11"><span class="crayon-h">    </span><span class="crayon-c"># known as the face hole.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7830090270172-12"><span class="crayon-h">    </span><span class="crayon-v">foreground_image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">imread</span><span class="crayon-sy">(</span><span class="crayon-s">'/path/to/martian/image/.png'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b9d7d7830090270172-13"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7830090270172-14"><span class="crayon-h">    </span><span class="crayon-c"># Create foreground mask from alpha transparency.</span></p><p class="crayon-line" id="crayon-56d5b9d7d7830090270172-15"><span class="crayon-h">    </span><span class="crayon-v">foreground_mask</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">foreground_image</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">3</span><span class="crayon-sy">]</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7830090270172-16"> </p><p class="crayon-line" id="crayon-56d5b9d7d7830090270172-17"><span class="crayon-h">    </span><span class="crayon-c"># Create inverted background mask.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7830090270172-18"><span class="crayon-h">    </span><span class="crayon-v">background_mask</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">bitwise_not</span><span class="crayon-sy">(</span><span class="crayon-v">foreground_mask</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b9d7d7830090270172-19"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7830090270172-20"><span class="crayon-h">    </span><span class="crayon-c"># Convert foreground image to BGR.</span></p><p class="crayon-line" id="crayon-56d5b9d7d7830090270172-21"><span class="crayon-h">    </span><span class="crayon-v">foreground_image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">foreground_image</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-cn">3</span><span class="crayon-sy">]</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7830090270172-22"> </p><p class="crayon-line" id="crayon-56d5b9d7d7830090270172-23"><span class="crayon-h">    </span><span class="crayon-c"># Declare foreground size.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7830090270172-24"><span class="crayon-h">    </span><span class="crayon-v">foreground_size</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">630</span></p><p class="crayon-line" id="crayon-56d5b9d7d7830090270172-25"><span class="crayon-h">    </span><span class="crayon-v">foreground_ratio</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">float</span><span class="crayon-sy">(</span><span class="crayon-v">foreground_size</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>On the command line, <code>python martianify.py</code> should run without errors but will not display any results.</p>
<p>Next, we’ll configure our background image. Declare the size of background image to be 1100 pixels. Then we’ll calculate the padding for the background or selfie image.</p>

		<div id="crayon-56d5b9d7d783b223647256" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b9d7d783b223647256-1"><span class="crayon-h">    </span><span class="crayon-c"># Declare background size and padding.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d783b223647256-2"><span class="crayon-h">    </span><span class="crayon-v">background_size</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">1100</span></p><p class="crayon-line" id="crayon-56d5b9d7d783b223647256-3"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d783b223647256-4"><span class="crayon-h">    </span><span class="crayon-v">padding_top</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">background_size</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">foreground_size</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-cn">3</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-cn">2</span></p><p class="crayon-line" id="crayon-56d5b9d7d783b223647256-5"><span class="crayon-h">    </span><span class="crayon-v">padding_bottom</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">background_size</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-e">padding_top</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d783b223647256-6"><span class="crayon-e">    </span><span class="crayon-v">padding_left</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">background_size</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">foreground_size</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-cn">2</span></p><p class="crayon-line" id="crayon-56d5b9d7d783b223647256-7"><span class="crayon-h">    </span><span class="crayon-v">padding_right</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">background_size</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">foreground_size</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-cn">2</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>Now, we’re going to reuse most of the code from earlier that loads the selfie image into OpenCV and finds faces in the image. This time when we iterate over the faces we declare the region of interest on the face on line 54.</p>

		<div id="crayon-56d5b9d7d7846560185672" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-56d5b9d7d7846560185672-1">1</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7846560185672-2">2</p><p class="crayon-num" data-line="crayon-56d5b9d7d7846560185672-3">3</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7846560185672-4">4</p><p class="crayon-num" data-line="crayon-56d5b9d7d7846560185672-5">5</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7846560185672-6">6</p><p class="crayon-num" data-line="crayon-56d5b9d7d7846560185672-7">7</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7846560185672-8">8</p><p class="crayon-num" data-line="crayon-56d5b9d7d7846560185672-9">9</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7846560185672-10">10</p><p class="crayon-num" data-line="crayon-56d5b9d7d7846560185672-11">11</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7846560185672-12">12</p><p class="crayon-num" data-line="crayon-56d5b9d7d7846560185672-13">13</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7846560185672-14">14</p><p class="crayon-num" data-line="crayon-56d5b9d7d7846560185672-15">15</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7846560185672-16">16</p><p class="crayon-num" data-line="crayon-56d5b9d7d7846560185672-17">17</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7846560185672-18">18</p><p class="crayon-num" data-line="crayon-56d5b9d7d7846560185672-19">19</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7846560185672-20">20</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b9d7d7846560185672-1"><span class="crayon-h">    </span><span class="crayon-c"># Capture selfie image in OpenCV.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7846560185672-2"><span class="crayon-h">    </span><span class="crayon-v">cv_image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">imread</span><span class="crayon-sy">(</span><span class="crayon-v">original_image_path</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b9d7d7846560185672-3"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7846560185672-4"><span class="crayon-h">    </span><span class="crayon-c"># Find that face.</span></p><p class="crayon-line" id="crayon-56d5b9d7d7846560185672-5"><span class="crayon-h">    </span><span class="crayon-v">faces</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">face_cascade</span><span class="crayon-sy">.</span><span class="crayon-e">detectMultiScale</span><span class="crayon-sy">(</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7846560185672-6"><span class="crayon-h">        </span><span class="crayon-v">cv_image</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d5b9d7d7846560185672-7"><span class="crayon-h">        </span><span class="crayon-v">scaleFactor</span><span class="crayon-o">=</span><span class="crayon-cn">1.1</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7846560185672-8"><span class="crayon-h">        </span><span class="crayon-v">minNeighbors</span><span class="crayon-o">=</span><span class="crayon-cn">3</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d5b9d7d7846560185672-9"><span class="crayon-h">        </span><span class="crayon-v">minSize</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">30</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">30</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7846560185672-10"><span class="crayon-h">        </span><span class="crayon-v">flags</span><span class="crayon-o">=</span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">cv</span><span class="crayon-sy">.</span><span class="crayon-v">CV_HAAR_SCALE</span><span class="crayon-sy">_</span>IMAGE</p><p class="crayon-line" id="crayon-56d5b9d7d7846560185672-11"><span class="crayon-h">        </span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7846560185672-12"> </p><p class="crayon-line" id="crayon-56d5b9d7d7846560185672-13"><span class="crayon-h">    </span><span class="crayon-c"># Iterate over each face found - roi: region of interest</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7846560185672-14"><span class="crayon-h">    </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">x1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-k ">w</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">h</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">faces</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b9d7d7846560185672-15"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7846560185672-16"><span class="crayon-h">        </span><span class="crayon-c"># Extract image of face.</span></p><p class="crayon-line" id="crayon-56d5b9d7d7846560185672-17"><span class="crayon-h">        </span><span class="crayon-v">x2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">x1</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-k ">w</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7846560185672-18"><span class="crayon-h">        </span><span class="crayon-v">y2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">y1</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-i">h</span></p><p class="crayon-line" id="crayon-56d5b9d7d7846560185672-19"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7846560185672-20"><span class="crayon-h">        </span><span class="crayon-v">face_roi</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv_image</span><span class="crayon-sy">[</span><span class="crayon-v">y1</span><span class="crayon-o">:</span><span class="crayon-v">y2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">x1</span><span class="crayon-o">:</span><span class="crayon-v">x2</span><span class="crayon-sy">]</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>Add the following lines to the bottom of the file to show the face.</p>

		<div id="crayon-56d5b9d7d7850646746313" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b9d7d7850646746313-1"><span class="crayon-h">        </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">imshow</span><span class="crayon-sy">(</span><span class="crayon-s">'Face Only'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">face_roi</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7850646746313-2"><span class="crayon-h">        </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">waitKey</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b9d7d7850646746313-3"><span class="crayon-h">        </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">destroyAllWindows</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7850646746313-4"> </p><p class="crayon-line" id="crayon-56d5b9d7d7850646746313-5"><span class="crayon-e">martianify</span><span class="crayon-sy">(</span><span class="crayon-s">'/path/to/selfie/image'</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>Change the image path to match your own, then run <code>python martianify.py</code> within your project directory to see the face. Remove them when you are ready to go on. I know the anticipation is killing you, but we will bring The Martian home y’all!</p>
<p>Now we resize the face to make sure it is fixed using <a href="http://docs.opencv.org/2.4.9/modules/imgproc/doc/geometric_transformations.html?highlight=cv2.resize#cv2.resize">cv2.resize</a>. We use the <a href="http://docs.opencv.org/2.4.9/modules/imgproc/doc/filtering.html?highlight=copymakeborder#cv2.copyMakeBorder">copyMakeBorder</a> function to add the padding we defined earlier around the background image.Then save the background image, which now has a border, as background_src that is the size and location of where we will place The Martian.</p>

		<div id="crayon-56d5b9d7d785b620589931" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b9d7d785b620589931-1"><span class="crayon-h">        </span><span class="crayon-c"># Resize image of face.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d785b620589931-2"><span class="crayon-h">        </span><span class="crayon-v">ratio</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">foreground_ratio</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-v">face_roi</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></p><p class="crayon-line" id="crayon-56d5b9d7d785b620589931-3"><span class="crayon-h">        </span><span class="crayon-v">dimension</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">foreground_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-k ">int</span><span class="crayon-sy">(</span><span class="crayon-v">face_roi</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">ratio</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d785b620589931-4"><span class="crayon-h">        </span><span class="crayon-v">face</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">resize</span><span class="crayon-sy">(</span><span class="crayon-v">face_roi</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dimension</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">interpolation</span><span class="crayon-o">=</span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">INTER_AREA</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b9d7d785b620589931-5"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d785b620589931-6"><span class="crayon-h">        </span><span class="crayon-c"># Add padding to background image</span></p><p class="crayon-line" id="crayon-56d5b9d7d785b620589931-7"><span class="crayon-h">        </span><span class="crayon-v">background_image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">copyMakeBorder</span><span class="crayon-sy">(</span><span class="crayon-v">face</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d785b620589931-8"><span class="crayon-h">                                              </span><span class="crayon-v">padding_top</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d5b9d7d785b620589931-9"><span class="crayon-h">                                              </span><span class="crayon-v">padding_bottom</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d785b620589931-10"><span class="crayon-h">                                              </span><span class="crayon-v">padding_left</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d5b9d7d785b620589931-11"><span class="crayon-h">                                              </span><span class="crayon-v">padding_right</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d785b620589931-12"><span class="crayon-h">                                              </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">BORDER_CONSTANT</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b9d7d785b620589931-13"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d785b620589931-14"><span class="crayon-h">        </span><span class="crayon-c"># Region of interest for Martian from background proportional to martian size.</span></p><p class="crayon-line" id="crayon-56d5b9d7d785b620589931-15"><span class="crayon-h">        </span><span class="crayon-v">background_src</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">background_image</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-v">background_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-v">background_size</span><span class="crayon-sy">]</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>You can check that the padding is added by inserting those 4 lines with <code>cv2.imshow(‘Face Only’, background_image)</code>. And again remove it when you wish to move on.</p>
<p><img class="&quot; aligncenter" title="" src="https://www.twilio.com/blog/wp-content/uploads/2015/11/Sxo_eKWpXrw0Puw516JBxXpTgVLPi1ULrvguWksNV8pL8uxyI4gQieKmPSIGxmWUTSZiILjUsXRC2Qap04A_MaGmw26RxJb8-ZaZTkpqoYs1J9CIzooVXMtPIEF7ArJvmlDxcZaN.png" alt=""/></p>
<p>Finally, use the <a href="http://docs.opencv.org/2.4.9/modules/core/doc/operations_on_arrays.html?highlight=cv2.bitwise_and#cv2.bitwise_and">cv2.bitwise_and</a> function with inverted mask to select the pixels in the background where The Martian is not. That’s a fancy way to say the face. Do the same thing with mask and The Martian image to select the pixels from The Martian that make up The Martian.</p>
<p>Lastly, merge the background region of interest with the foreground region of interest using <a href="http://docs.opencv.org/2.4.9/modules/core/doc/operations_on_arrays.html?highlight=add#cv2.add">cv2.add</a>. As the masks are an inverse of each other, the pixels selected in the bitwise_and operations will not overlap but will make one image when combined. For the curious, check roi_bg, roi_fg, and dst  respectively with cv2.imshow.</p>

		<div id="crayon-56d5b9d7d7867863997089" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b9d7d7867863997089-1"><span class="crayon-h">        </span><span class="crayon-p"># roi_bg contains the original image only where the martian is not</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7867863997089-2"><span class="crayon-h">        </span><span class="crayon-p"># in the region that is the size of the Martian.</span></p><p class="crayon-line" id="crayon-56d5b9d7d7867863997089-3"><span class="crayon-h">        </span><span class="crayon-v">roi_bg</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">bitwise_and</span><span class="crayon-sy">(</span><span class="crayon-v">background_src</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">background_src</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">mask</span><span class="crayon-o">=</span><span class="crayon-v">background_mask</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7867863997089-4"> </p><p class="crayon-line" id="crayon-56d5b9d7d7867863997089-5"><span class="crayon-h">        </span><span class="crayon-p"># roi_fg contains the image of the Martian only where the Martian is</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7867863997089-6"><span class="crayon-h">        </span><span class="crayon-v">roi_fg</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">bitwise_and</span><span class="crayon-sy">(</span><span class="crayon-v">foreground_image</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">foreground_image</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">mask</span><span class="crayon-o">=</span><span class="crayon-v">foreground_mask</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b9d7d7867863997089-7"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7867863997089-8"><span class="crayon-h">        </span><span class="crayon-p"># Join the roi_bg and roi_fg.</span></p><p class="crayon-line" id="crayon-56d5b9d7d7867863997089-9"><span class="crayon-h">        </span><span class="crayon-v">dst</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-v">roi_bg</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">roi_fg</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7867863997089-10"> </p><p class="crayon-line" id="crayon-56d5b9d7d7867863997089-11"><span class="crayon-h">        </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">imshow</span><span class="crayon-sy">(</span><span class="crayon-s">"Look mom, I'm the Martian!"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dst</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7867863997089-12"><span class="crayon-h">        </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">waitKey</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b9d7d7867863997089-13"><span class="crayon-h">        </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">destroyAllWindows</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7867863997089-14"> </p><p class="crayon-line" id="crayon-56d5b9d7d7867863997089-15"><span class="crayon-e">martianify</span><span class="crayon-sy">(</span><span class="crayon-s">'/path/to/selfie/image'</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>Once that’s done, replace the last 4 lines using <a href="http://docs.opencv.org/2.4.9/modules/highgui/doc/reading_and_writing_images_and_video.html?highlight=cv2.imwrite#cv2.imwrite">cv2.imwrite</a>, <code>cv2.imwrite(original_image_path, dst)</code> to write the new image back to the file path, overwriting the original image. You can also grab the code in full from <a href="https://gist.github.com/meganspeir/f1037370441360e81806">this gist</a>.</p>
<h3>THERE’S AN APP FOR THAT</h3>
<p>With the power of Twilio MMS we can get people to text us a selfie which we will martianify. Be sure to <code>pip install twilio</code> and create a new file called <code>app.py</code> where we will use Flask to build a route to handle incoming MMS/SMS.</p>
<p>You’ll want to configure your Twilio number with a publicly accessible URL. We’ll use the localhost tunneling service <a href="https://ngrok.com/">ngrok</a>. If you’ve never used it before, check out Phil’s ‘6 awesome reasons to use <a href="https://www.twilio.com/blog/2015/09/6-awesome-reasons-to-use-ngrok-when-testing-webhooks.html">ngrok</a>.’ Once you have ngrok set up, run it to listen to the port that we will run our Flask application on: 5000.</p>
<p>You should see a screen that looks like this with a link that we can visit to access our Flask app:</p>
<p><img class="&quot; aligncenter" title="" src="https://www.twilio.com/blog/wp-content/uploads/2015/11/D2Yn0SHeMre_FVReG1jmVOEI2hTlSOpyXXbVfa9bL3hIlRmbh8O4Sl4WgF0tw0MX9uo-zS5eQsOp-PPluznUsNKWdc5adHA7ESjNDw6OxthBA3lTeAm2opAWRUlSoBaQdyFrc6yc.png" alt=""/></p>
<p> </p>
<p>Grab that ngrok URL to configure your Twilio number. We’ll also use it in the code that follows.</p>
<p> </p>
<p><img class="&quot; aligncenter" title="" src="https://www.twilio.com/blog/wp-content/uploads/2015/11/0uRvxxkgfKXHHjY46yW85qJsxoG5t0RTlWyXn_dQpDc-hKAe1e1dzKPZl5DM03swDGmFB-s3hIxYrG8rYCKW4iYmGSBknZrQPe_WYB_nA45LqUMq7aW5mNcXVaSDtbz0J2frWV0.png" alt=""/></p>
<p> </p>
<p>Be sure to add ‘/sms’ to your request URL path in the box above.</p>

		<div id="crayon-56d5b9d7d7874547805872" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover expand">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-56d5b9d7d7874547805872-1">1</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7874547805872-2">2</p><p class="crayon-num" data-line="crayon-56d5b9d7d7874547805872-3">3</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7874547805872-4">4</p><p class="crayon-num" data-line="crayon-56d5b9d7d7874547805872-5">5</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7874547805872-6">6</p><p class="crayon-num" data-line="crayon-56d5b9d7d7874547805872-7">7</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7874547805872-8">8</p><p class="crayon-num" data-line="crayon-56d5b9d7d7874547805872-9">9</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7874547805872-10">10</p><p class="crayon-num" data-line="crayon-56d5b9d7d7874547805872-11">11</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7874547805872-12">12</p><p class="crayon-num" data-line="crayon-56d5b9d7d7874547805872-13">13</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7874547805872-14">14</p><p class="crayon-num" data-line="crayon-56d5b9d7d7874547805872-15">15</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7874547805872-16">16</p><p class="crayon-num" data-line="crayon-56d5b9d7d7874547805872-17">17</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7874547805872-18">18</p><p class="crayon-num" data-line="crayon-56d5b9d7d7874547805872-19">19</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7874547805872-20">20</p><p class="crayon-num" data-line="crayon-56d5b9d7d7874547805872-21">21</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7874547805872-22">22</p><p class="crayon-num" data-line="crayon-56d5b9d7d7874547805872-23">23</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7874547805872-24">24</p><p class="crayon-num" data-line="crayon-56d5b9d7d7874547805872-25">25</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7874547805872-26">26</p><p class="crayon-num" data-line="crayon-56d5b9d7d7874547805872-27">27</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7874547805872-28">28</p><p class="crayon-num" data-line="crayon-56d5b9d7d7874547805872-29">29</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7874547805872-30">30</p><p class="crayon-num" data-line="crayon-56d5b9d7d7874547805872-31">31</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7874547805872-32">32</p><p class="crayon-num" data-line="crayon-56d5b9d7d7874547805872-33">33</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7874547805872-34">34</p><p class="crayon-num" data-line="crayon-56d5b9d7d7874547805872-35">35</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7874547805872-36">36</p><p class="crayon-num" data-line="crayon-56d5b9d7d7874547805872-37">37</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7874547805872-38">38</p><p class="crayon-num" data-line="crayon-56d5b9d7d7874547805872-39">39</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7874547805872-40">40</p><p class="crayon-num" data-line="crayon-56d5b9d7d7874547805872-41">41</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7874547805872-42">42</p><p class="crayon-num" data-line="crayon-56d5b9d7d7874547805872-43">43</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7874547805872-44">44</p><p class="crayon-num" data-line="crayon-56d5b9d7d7874547805872-45">45</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b9d7d7874547805872-46">46</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b9d7d7874547805872-1"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">requests</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7874547805872-2"><span class="crayon-st">from</span><span class="crayon-h"> </span><span class="crayon-e">flask </span><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">Flask</span></p><p class="crayon-line" id="crayon-56d5b9d7d7874547805872-3"><span class="crayon-st">from</span><span class="crayon-h"> </span><span class="crayon-e">flask </span><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">request</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7874547805872-4"><span class="crayon-st">from</span><span class="crayon-h"> </span><span class="crayon-e">flask </span><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">send_from_directory</span></p><p class="crayon-line" id="crayon-56d5b9d7d7874547805872-5"><span class="crayon-st">from</span><span class="crayon-h"> </span><span class="crayon-e">twilio </span><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">twiml</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7874547805872-6"> </p><p class="crayon-line" id="crayon-56d5b9d7d7874547805872-7"><span class="crayon-st">from</span><span class="crayon-h"> </span><span class="crayon-e">martianify </span><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">martianify</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7874547805872-8"> </p><p class="crayon-line" id="crayon-56d5b9d7d7874547805872-9"><span class="crayon-v">UPLOAD_FOLDER</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'/path/to/your/project/'</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7874547805872-10"> </p><p class="crayon-line" id="crayon-56d5b9d7d7874547805872-11"><span class="crayon-c"># App declaration and configuration</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7874547805872-12"><span class="crayon-v">app</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Flask</span><span class="crayon-sy">(</span><span class="crayon-v">__name__</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b9d7d7874547805872-13"><span class="crayon-v">app</span><span class="crayon-sy">.</span><span class="crayon-v">config</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7874547805872-14"> </p><p class="crayon-line" id="crayon-56d5b9d7d7874547805872-15"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7874547805872-16"><span class="crayon-c"># SMS/MMS Request URL</span></p><p class="crayon-line" id="crayon-56d5b9d7d7874547805872-17"><span class="crayon-sy">@</span><span class="crayon-v">app</span><span class="crayon-sy">.</span><span class="crayon-e">route</span><span class="crayon-sy">(</span><span class="crayon-s">'/sms'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">methods</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'POST'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'GET'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7874547805872-18"><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">sms</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b9d7d7874547805872-19"><span class="crayon-h">    </span><span class="crayon-v">response</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">twiml</span><span class="crayon-sy">.</span><span class="crayon-e">Response</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7874547805872-20"> </p><p class="crayon-line" id="crayon-56d5b9d7d7874547805872-21"><span class="crayon-h">    </span><span class="crayon-v">response</span><span class="crayon-sy">.</span><span class="crayon-e">message</span><span class="crayon-sy">(</span><span class="crayon-s">"Please wait for launch 3, 2, 1..."</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7874547805872-22"> </p><p class="crayon-line" id="crayon-56d5b9d7d7874547805872-23"><span class="crayon-h">    </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">request</span><span class="crayon-sy">.</span><span class="crayon-v">form</span><span class="crayon-sy">[</span><span class="crayon-s">'NumMedia'</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-s">'0'</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7874547805872-24"><span class="crayon-h">        </span><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">request</span><span class="crayon-sy">.</span><span class="crayon-v">form</span><span class="crayon-sy">[</span><span class="crayon-s">'MessageSid'</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">'.jpg'</span></p><p class="crayon-line" id="crayon-56d5b9d7d7874547805872-25"><span class="crayon-h">        </span><span class="crayon-v">f</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'wb'</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7874547805872-26"><span class="crayon-h">        </span><span class="crayon-v">f</span><span class="crayon-sy">.</span><span class="crayon-e">write</span><span class="crayon-sy">(</span><span class="crayon-v">requests</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-v">request</span><span class="crayon-sy">.</span><span class="crayon-v">form</span><span class="crayon-sy">[</span><span class="crayon-s">'MediaUrl0'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-v">content</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b9d7d7874547805872-27"><span class="crayon-h">        </span><span class="crayon-v">f</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7874547805872-28"><span class="crayon-h">        </span><span class="crayon-e">martianify</span><span class="crayon-sy">(</span><span class="crayon-s">'{}/{}'</span><span class="crayon-sy">.</span><span class="crayon-k ">format</span><span class="crayon-sy">(</span><span class="crayon-v">UPLOAD_FOLDER</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b9d7d7874547805872-29"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7874547805872-30"><span class="crayon-h">        </span><span class="crayon-st">with</span><span class="crayon-h"> </span><span class="crayon-v">response</span><span class="crayon-sy">.</span><span class="crayon-e">message</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">as</span><span class="crayon-h"> </span><span class="crayon-v">message</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b9d7d7874547805872-31"><span class="crayon-h">            </span><span class="crayon-v">message</span><span class="crayon-sy">.</span><span class="crayon-v">body</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"{0}"</span><span class="crayon-sy">.</span><span class="crayon-k ">format</span><span class="crayon-sy">(</span><span class="crayon-s">"Welcome to Mars."</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7874547805872-32"><span class="crayon-h">            </span><span class="crayon-v">message</span><span class="crayon-sy">.</span><span class="crayon-e">media</span><span class="crayon-sy">(</span><span class="crayon-s">'http://YourNgrokURL/uploads/{}'</span><span class="crayon-sy">.</span><span class="crayon-k ">format</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b9d7d7874547805872-33"><span class="crayon-h">    </span><span class="crayon-st">else</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7874547805872-34"><span class="crayon-h">        </span><span class="crayon-v">response</span><span class="crayon-sy">.</span><span class="crayon-e">message</span><span class="crayon-sy">(</span><span class="crayon-s">"Face forward and text me a selfie!"</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b9d7d7874547805872-35"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7874547805872-36"><span class="crayon-h">    </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-k ">str</span><span class="crayon-sy">(</span><span class="crayon-v">response</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b9d7d7874547805872-37"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7874547805872-38"> </p><p class="crayon-line" id="crayon-56d5b9d7d7874547805872-39"><span class="crayon-c"># Martian Media URL</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7874547805872-40"><span class="crayon-sy">@</span><span class="crayon-v">app</span><span class="crayon-sy">.</span><span class="crayon-e">route</span><span class="crayon-sy">(</span><span class="crayon-s">'/uploads/&lt;filename&gt;'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">methods</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'GET'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'POST'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b9d7d7874547805872-41"><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">uploaded_file</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7874547805872-42"><span class="crayon-h">    </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">send_from_directory</span><span class="crayon-sy">(</span><span class="crayon-v">UPLOAD_FOLDER</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d5b9d7d7874547805872-43"><span class="crayon-h">                               </span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7874547805872-44"> </p><p class="crayon-line" id="crayon-56d5b9d7d7874547805872-45"><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">__name__</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">"__main__"</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b9d7d7874547805872-46"><span class="crayon-h">    </span><span class="crayon-v">app</span><span class="crayon-sy">.</span><span class="crayon-e">run</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>The /sms route responds to an incoming text message with some Twilio flavored XML called TwiML. Notice that the ‘NumMedia’ parameter is not zero, meaning we received an MMS. Twilio does not return an image itself, they return a URL to the image.</p>
<p>We create a string called <code>filename</code> using the <code>MessageSid</code> parameter to maintain a unique identifier for each image. Then we open the file to write the content of Twilo’s image to the file. Once The Martian is made, we respond with some more TwiML, including a message body and the media or image.</p>
<p>The second route, <code>/uploads/&lt;filename&gt;</code> handles the delivery of the <code>message.media</code> TwiML. We use that URL to retrieve the newly martianified image.</p>
<p>Make sure that you’ve changed the file paths and the URL to reflect your own. Again, you can grab the full code from <a href="https://gist.github.com/meganspeir/f1037370441360e81806">this gist</a>. With that, you should now be able to text a selfie to your Twilio number and get back The Martian.</p>
<h3>NEXT STEPS</h3>
<p>We’ve only scratched the surface of what we can do with OpenCV. But there are many other things you could do with this.</p>
<ol class="c9 lst-kix_276x1t21dwis-0 start" start="1">
<li>Set up Redis to more eloquently handle all the action this app is going to receive.</li>
<li>Remix The Martian and create your own characters.</li>
<li>Handle more than one face in an image.</li>
<li>Use other cascades to detect eyes, noses.</li>
<li>Create your own cascade to detect whatever you want!</li>
</ol>
<p>I’m excited to see what you build with OpenCV. If you want to check out more tutorials I would recommend <a href="http://www.pyimagesearch.com/2015/06/22/install-opencv-3-0-and-python-2-7-on-ubuntu/">these</a>. If you have any questions, want to share your build, or you’re already doing cool stuff with OpenCV feel free to leave a comment or reach out:</p>
<ul>
<li>Email: mspeir@twilio.com</li>
<li>GitHub: meganspeir</li>
<li>Twitter: @meganspeir</li>
</ul>
			</div>
					</div></body></html>