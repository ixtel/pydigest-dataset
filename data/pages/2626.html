<html><body><div><div class="post" id="post-1403">
            
            
			      <div class="entry">
              <p>Today I cleaned up the database for <a href="http://fiddlesalad.com/">Fiddle Salad</a> and <a href="http://pythonfiddle.com">Python Fiddle</a>. Both use <a href="https://github.com/yuguang/django-cloud-ide">the same Django back-end for code storage</a>. While browsing tags, I noticed that often both CamelCase and lowercase spellings were used for tags. Since I was working on a tag suggest feature earlier this week, I decided to convert all tags to lowercase so that tag suggestions would not be redundant. An additional benefit is further normalization of the data. Fortunately, I found a fork of django-taggit, the Django app I used for tagging, that supported enforcing lowercase tags everywhere. Two management commands were already present for normalizing data, <tt>mergetags</tt> and <tt>lowercasetags</tt>. django-taggit had two fields for each tag, a name and slug. <tt>lowercasetags</tt> converted all tag names to their lowercase form. <tt>mergetags</tt> takes at least two tag slugs and merges all tags into a single destination tag. The result is that all associations are moved to a single tag. While <tt>mergetags</tt> is suitable for manually resolving redundant data, the number of tags on Fiddle Salad is too large. I wrote an command to automate this process:</p>
<div class="codecolorer-container python default"><p class="python codecolorer"><span class="kw1">from</span> django.<span class="me1">core</span>.<span class="me1">management</span>.<span class="me1">base</span> <span class="kw1">import</span> BaseCommand<span class="sy0">,</span> CommandError<br/>
<span class="kw1">from</span> taggit.<span class="me1">models</span> <span class="kw1">import</span> Tag<span class="sy0">,</span> TaggedItem<br/>
<span class="kw1">from</span> django.<span class="me1">core</span>.<span class="kw3">exceptions</span> <span class="kw1">import</span> ObjectDoesNotExist<br/>
<br/>
<span class="kw1">class</span> Command<span class="br0">(</span>BaseCommand<span class="br0">)</span>:<br/>
    <span class="kw2">help</span> <span class="sy0">=</span> <span class="st0">'merges all tags automatically'</span><br/>
<br/>
    <span class="kw1">def</span> merge<span class="br0">(</span><span class="kw2">self</span><span class="sy0">,</span> extra_slugs<span class="sy0">,</span> dest_slug<span class="br0">)</span>:<br/>
        <span class="kw1">try</span>:<br/>
            dest_tag <span class="sy0">=</span> Tag.<span class="me1">objects</span>.<span class="me1">get</span><span class="br0">(</span>slug<span class="sy0">=</span>dest_slug<span class="br0">)</span><br/>
        <span class="kw1">except</span> ObjectDoesNotExist:<br/>
            <span class="kw1">raise</span> CommandError<span class="br0">(</span><span class="st0">'Destination Tag "%s" does not exist'</span> % dest_slug<span class="br0">)</span><br/>
<br/>
        <span class="kw1">for</span> slug <span class="kw1">in</span> extra_slugs:<br/>
            <span class="kw1">try</span>:<br/>
                tag <span class="sy0">=</span> Tag.<span class="me1">objects</span>.<span class="me1">get</span><span class="br0">(</span>slug<span class="sy0">=</span>slug<span class="br0">)</span><br/>
            <span class="kw1">except</span> ObjectDoesNotExist:<br/>
                <span class="kw1">raise</span> CommandError<span class="br0">(</span><span class="st0">'Tag "%s" does not exist'</span> % slug<span class="br0">)</span><br/>
<br/>
            items <span class="sy0">=</span> TaggedItem.<span class="me1">objects</span>.<span class="kw2">filter</span><span class="br0">(</span>tag<span class="sy0">=</span>tag<span class="br0">)</span><br/>
            count <span class="sy0">=</span> items.<span class="me1">count</span><span class="br0">(</span><span class="br0">)</span><br/>
            <span class="kw1">for</span> i<span class="sy0">,</span> item <span class="kw1">in</span> <span class="kw2">enumerate</span><span class="br0">(</span>items<span class="br0">)</span>:<br/>
                <span class="kw1">if</span> i % <span class="nu0">20</span> <span class="sy0">==</span> <span class="nu0">0</span>:<br/>
                    <span class="kw2">self</span>.<span class="me1">stdout</span>.<span class="me1">write</span><span class="br0">(</span><span class="st0">'Merging %s %d/%d<span class="es0">\n</span>'</span> % <span class="br0">(</span>slug<span class="sy0">,</span> i+<span class="nu0">1</span><span class="sy0">,</span> count<span class="br0">)</span><span class="br0">)</span><br/>
                obj <span class="sy0">=</span> item.<span class="me1">content_object</span><br/>
                <span class="kw1">if</span> <span class="kw1">not</span> obj:<br/>
                    <span class="kw1">return</span><br/>
                obj.<span class="me1">tags</span>.<span class="me1">remove</span><span class="br0">(</span>tag<span class="br0">)</span><br/>
                obj.<span class="me1">tags</span>.<span class="me1">add</span><span class="br0">(</span>dest_tag<span class="br0">)</span><br/>
            tag.<span class="me1">delete</span><span class="br0">(</span><span class="br0">)</span><br/>
<br/>
            <span class="kw2">self</span>.<span class="me1">stdout</span>.<span class="me1">write</span><span class="br0">(</span><span class="st0">'Successfully merged tags into "%s"<span class="es0">\n</span>'</span> % dest_slug<span class="br0">)</span><br/>
<br/>
<br/>
    <span class="kw1">def</span> handle<span class="br0">(</span><span class="kw2">self</span><span class="sy0">,</span> *args<span class="sy0">,</span> **options<span class="br0">)</span>:<br/>
        <span class="kw1">for</span> tag <span class="kw1">in</span> Tag.<span class="me1">objects</span>.<span class="kw2">all</span><span class="br0">(</span><span class="br0">)</span>:<br/>
            <span class="kw1">if</span> Tag.<span class="me1">objects</span>.<span class="kw2">filter</span><span class="br0">(</span>name<span class="sy0">=</span>tag.<span class="me1">name</span><span class="br0">)</span>.<span class="me1">count</span><span class="br0">(</span><span class="br0">)</span> <span class="sy0">&gt;</span> <span class="nu0">1</span>:<br/>
                tags <span class="sy0">=</span> Tag.<span class="me1">objects</span>.<span class="kw2">filter</span><span class="br0">(</span>name<span class="sy0">=</span>tag.<span class="me1">name</span><span class="br0">)</span>.<span class="me1">order_by</span><span class="br0">(</span><span class="st0">'id'</span><span class="br0">)</span><br/>
                dest <span class="sy0">=</span> tags<span class="br0">[</span><span class="nu0">0</span><span class="br0">]</span>.<span class="me1">slug</span><br/>
                extras <span class="sy0">=</span> <span class="br0">[</span><span class="br0">]</span><br/>
                <span class="kw1">for</span> tag <span class="kw1">in</span> tags<span class="br0">[</span><span class="nu0">1</span>::<span class="br0">]</span>:<br/>
                    extras.<span class="me1">append</span><span class="br0">(</span>tag.<span class="me1">slug</span><span class="br0">)</span><br/>
                <span class="kw2">self</span>.<span class="me1">merge</span><span class="br0">(</span>extras<span class="sy0">,</span> dest<span class="br0">)</span></p></div>
<p>Because performance is not a concern for a single-time data processing script, I did not bother to optimize the queries nor run-time. This script would be useful for anyone who wants to normalize tags in the same manner, so it is in a <a href="https://github.com/yuguang/django-taggit/blob/8e87af2d02adf7784a1c931764ee00dcb06d20ae/taggit/management/commands/mergealltags.py">git repository</a>. Finally, I tested the new command on a clone of the production database.</p>
<div class="codecolorer-container text default"><p class="text codecolorer">bash-4.1$ python manage.py lowercasetags<br/>
Lowercasing 1/1621<br/>
Lowercasing 21/1621<br/>
.<br/>
.<br/>
.<br/>
Lowercasing 1621/1621<br/>
bash-4.1$ python manage.py mergealltags <br/>
Merging jquery_1 1/46<br/>
Merging jquery_1 21/46<br/>
Merging jquery_1 41/46<br/>
Successfully merged tags into "jquery"<br/>
Successfully merged tags into "jquery"<br/>
Merging stylus_1 1/7<br/>
Successfully merged tags into "stylus"<br/>
Merging hello_1 1/10<br/>
Successfully merged tags into "hello"<br/>
Merging test_1 1/147<br/>
Merging test_1 21/147<br/>
Merging test_1 41/147<br/>
Merging test_1 61/147<br/>
Merging test_1 81/147<br/>
Merging test_1 101/147<br/>
Merging test_1 121/147<br/>
Merging test_1 141/147<br/>
Successfully merged tags into "test"<br/>
Merging me_1 1/2<br/>
Successfully merged tags into "me"<br/>
Merging no_1 1/5<br/>
Successfully merged tags into "no"<br/>
Merging one_1 1/16<br/>
Successfully merged tags into "one"<br/>
Merging things_1 1/3<br/>
Successfully merged tags into "things"<br/>
Merging learning_1 1/4<br/>
Successfully merged tags into "learning"<br/>
Successfully merged tags into "body"<br/>
Merging week-one_1 1/1<br/>
Successfully merged tags into "week-one"<br/>
Merging studio_1 1/33<br/>
Merging studio_1 21/33<br/>
Successfully merged tags into "studio"<br/>
Merging internet_1 1/36<br/>
Merging internet_1 21/36<br/>
Successfully merged tags into "internet"<br/>
Merging assignment_1 1/6<br/>
Successfully merged tags into "assignment"<br/>
Merging homework_1 1/6<br/>
Successfully merged tags into "homework"<br/>
Merging lessons_1 1/1<br/>
Successfully merged tags into "lessons"<br/>
Merging code_1 1/12<br/>
Merging tags_1 1/7<br/>
Successfully merged tags into "tags"<br/>
Merging two_1 1/6<br/>
Successfully merged tags into "two"<br/>
Merging salcedo_1 1/3<br/>
Successfully merged tags into "salcedo"<br/>
Merging page_1 1/15<br/>
Successfully merged tags into "page"<br/>
Merging music_1 1/4<br/>
Successfully merged tags into "music"<br/>
Merging table_1 1/7<br/>
Successfully merged tags into "table"<br/>
Merging band_1 1/9<br/>
Merging texas_1 1/1<br/>
Successfully merged tags into "texas"<br/>
Merging biography_1 1/2<br/>
Merging assignment-two_1 1/2<br/>
Successfully merged tags into "assignment-two"<br/>
Merging website_1 1/9<br/>
Merging a_1 1/2<br/>
Successfully merged tags into "a"<br/>
Merging words_1 1/1<br/>
Successfully merged tags into "words"<br/>
Merging section_1 1/2<br/>
Successfully merged tags into "section"<br/>
Merging header_1 1/1<br/>
Successfully merged tags into "header"<br/>
Merging ui_1 1/4<br/>
Successfully merged tags into "ui"<br/>
Merging first_1 1/8<br/>
Successfully merged tags into "first"<br/>
Merging random_1 1/1<br/>
Successfully merged tags into "random"<br/>
Merging internet-studio_1 1/5<br/>
Successfully merged tags into "internet-studio"<br/>
Merging angularjs_1 1/11<br/>
Successfully merged tags into "angularjs"<br/>
Merging i_1 1/2<br/>
Successfully merged tags into "i"<br/>
Merging lines_1 1/1<br/>
Successfully merged tags into "lines"<br/>
Merging row_1 1/1<br/>
Successfully merged tags into "row"<br/>
Merging alex-alpha_1 1/1<br/>
Successfully merged tags into "alex-alpha"<br/>
Merging assignment-one_1 1/2<br/>
Successfully merged tags into "assignment-one"<br/>
Merging google_1 1/1<br/>
Successfully merged tags into "google"<br/>
Merging man_1 1/4<br/>
Successfully merged tags into "man"<br/>
Merging nick_1 1/1<br/>
Successfully merged tags into "nick"<br/>
Merging cartoon_1 1/1<br/>
Successfully merged tags into "cartoon"<br/>
Merging batman_1 1/2<br/>
Successfully merged tags into "batman"<br/>
Merging code_1 1/7<br/>
Merging the_1 1/1<br/>
Successfully merged tags into "the"<br/>
Merging animation_1 1/2<br/>
Successfully merged tags into "animation"<br/>
Merging band_1 1/4<br/>
Merging assignment-one-of-three_1 1/2<br/>
Successfully merged tags into "assignment-one-of-three"<br/>
Merging status_1 1/1<br/>
Successfully merged tags into "status"<br/>
Merging python_1 1/2<br/>
Successfully merged tags into "python"<br/>
Merging cat_1 1/1<br/>
Successfully merged tags into "cat"<br/>
Merging none_1 1/7<br/>
Successfully merged tags into "none"<br/>
Merging adam_1 1/2<br/>
Successfully merged tags into "adam"<br/>
Merging school_1 1/3<br/>
Successfully merged tags into "school"<br/>
Merging website_1 1/9<br/>
Merging biography_1 1/2<br/>
Merging bootstrap_1 1/8<br/>
Successfully merged tags into "bootstrap"<br/>
Merging datamill_1 1/5<br/>
Successfully merged tags into "datamill"<br/>
Merging gentoo_1 1/2<br/>
Successfully merged tags into "gentoo"<br/>
Merging dobschal_1 1/1<br/>
Successfully merged tags into "dobschal"<br/>
Merging weimar_1 1/1<br/>
Successfully merged tags into "weimar"</p></div>
<p>When all went fine, I ran <tt>lowercasetags</tt> and <tt>mergealltags</tt> on both <a href="http://fiddlesalad.com/">Fiddle Salad</a> and <a href="http://pythonfiddle.com">Python Fiddle</a>. Now I was really impressed with the results as I clicked through the tags on both sites. <a href="http://fiddlesalad.com/fiddles/tags/">The tags on Fiddle Salad</a> were much better organized as they were ordered by popularity. While looking through the tags, I noticed that “test” was among the top. I decided to add ‘test’ to the list of stopwords for django-taggit. These stopwords are removed during save so that they are not associated with new snippets.<br/>
Now that the tags are normalized, I am ready to move on and deploy tag suggestions. </p>
                    			</div>
            <p class="comments">
              <a href="http://yuguangzhang.com/blog/merge-tags-with-django-taggit/#comments"><span class="dsq-postid" data-dsqidentifier="1403 http://yuguangzhang.com/blog/?p=1403">One response so far</span></a>            </p>	          
	        </div>
            </div></body></html>