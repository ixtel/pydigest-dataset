<html><body><div><article class="markdown-body entry-content" itemprop="text"><h1><a id="user-content-hypervault" class="anchor" href="#hypervault" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>hypervault</h1>

<p>pgsql connection manager for scalability freaks.</p>

<pre><code>pip install hv
</code></pre>

<p>This is the implementation of the pattern described by Instagram in <a href="http://instagram-engineering.tumblr.com/post/10853187575/sharding-ids-at-instagram">"Sharding &amp; IDs at Instagram"</a> article.</p>

<p>Besides for that, it wraps over <a href="http://initd.org/psycopg/">psycopg2</a> with custom connection pooling support and stores dicts in <a href="http://www.postgresql.org/docs/9.3/static/hstore.html">hstore</a> k/v pairs which may be indexed by PostgreSQL.</p>

<h2><a id="user-content-api" class="anchor" href="#api" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>api</h2>

<h3><a id="user-content-hventitykeyid" class="anchor" href="#hventitykeyid" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>hv.entity.Key(id)</h3>

<p>An instance of the <code>Key</code> represents a unique key (64-bits long) for an entity and has the following attributes:</p>

<p><code>created</code> returns the UTC datetime corresponding to the first 41-bits of the numeric id.</p>

<p><code>shard_id</code> holds a 13-bits integer and represents the logical shard.</p>

<p><code>added_id</code> is the remaining 10-bits and represents an auto-incrementing sequence, modulus 1024. This means we can generate 1024 IDs, per shard, per millisecond.</p>

<h3><a id="user-content-hvdatastoredatastoreconnections-pool_max-pool_block_timeout-logger" class="anchor" href="#hvdatastoredatastoreconnections-pool_max-pool_block_timeout-logger" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>hv.datastore.Datastore(connections, pool_max, pool_block_timeout, logger)</h3>

<p><code>connections</code> holds an array of dicts which are being passed to psycopg2 respectively. However those dicts should also contain a special <code>shards</code> value which adds meaning to all that fuss going around.</p>

<p>This example shows the bare minimum you need to create a <code>Datastore</code> instance:</p>

<div class="highlight highlight-source-python"><pre>connections <span class="pl-k">=</span> [
  <span class="pl-c1">dict</span>(<span class="pl-v">shards</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>1-9<span class="pl-pds">'</span></span>, <span class="pl-v">host</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>192.168.2.23<span class="pl-pds">'</span></span>, <span class="pl-v">port</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>5432<span class="pl-pds">'</span></span>, <span class="pl-v">user</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>x<span class="pl-pds">'</span></span>, <span class="pl-v">password</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>x<span class="pl-pds">'</span></span>, <span class="pl-v">database</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>x<span class="pl-pds">'</span></span>),
  <span class="pl-c1">dict</span>(<span class="pl-v">shards</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>9-17<span class="pl-pds">'</span></span>, <span class="pl-v">host</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>192.168.2.24<span class="pl-pds">'</span></span>, <span class="pl-v">port</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>5432<span class="pl-pds">'</span></span>, <span class="pl-v">user</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>x<span class="pl-pds">'</span></span>, <span class="pl-v">password</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>x<span class="pl-pds">'</span></span>, <span class="pl-v">database</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>x<span class="pl-pds">'</span></span>)
]
db <span class="pl-k">=</span> Datastore(connections)</pre></div>

<p>In this case, we assume PostgreSQL running on 192.168.2.23 contains shards (schemas) starting from 1 to 9 (9 not included) and on 192.168.2.24 we have shards from 9 to 17.</p>

<p><code>pool_max</code> is the maximum number of psycopg2 connections that are going to be kept alive for every <em>connection</em> we have passed. (default: 10)</p>

<p><code>pool_block_timeout</code> is the maximum number of seconds to wait for getting a connection from pool before the request is dropped. (default: 5)</p>

<p><code>logger</code> should hold a <a href="https://docs.python.org/2/library/logging.html#logger-objects">Logger object</a> if you want to use <a href="http://initd.org/psycopg/docs/extras.html#psycopg2.extras.LoggingConnection">LoggingConnection</a>. By default every connection is an instance of <a href="http://initd.org/psycopg/docs/extras.html#psycopg2.extras.DictConnection">DictConnection</a>.</p>

<p>A <code>Datastore</code> instance has the following methods:</p>

<h3><a id="user-content-get_connectionshard_id" class="anchor" href="#get_connectionshard_id" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>get_connection(shard_id)</h3>

<p>Returns a psycopg2 connection for the given <code>shard_id</code>. </p>

<p>Beware that this connection should be sent back into the pool when you are finished, or otherwise you know- universe will collapse and Trinity will die :(</p>

<h3><a id="user-content-put_connectionconnection" class="anchor" href="#put_connectionconnection" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>put_connection(connection)</h3>

<p>Sends <code>connection</code> back into the pool where it belonged.</p>

<h3><a id="user-content-cursorshard_id" class="anchor" href="#cursorshard_id" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>cursor(shard_id)</h3>

<p>Returns a context manager delivering a connection for the given <code>shard_id</code>.</p>

<p>This is a convenience method that saves you from forgetting to call <code>put_connection</code>.</p>

<p>Example:</p>

<div class="highlight highlight-source-python"><pre><span class="pl-k">with</span> db.cursor(<span class="pl-c1">5</span>) <span class="pl-k">as</span> cur:
  cur.execute(<span class="pl-s"><span class="pl-pds">'</span>SELECT version()<span class="pl-pds">'</span></span>)
  ver <span class="pl-k">=</span> cur.fetchone()</pre></div>

<h3><a id="user-content-putshard_id-kind-kwargs" class="anchor" href="#putshard_id-kind-kwargs" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>put(shard_id, kind, **kwargs)</h3>

<p>Writes data to the specified shard, where <code>kind</code> is an integer which is not stored within hstore field and used for differentiating between entity types.</p>

<p>Returns a <code>hv.entity.Key</code>.</p>

<p>Example:</p>

<div class="highlight highlight-source-python"><pre>data <span class="pl-k">=</span> <span class="pl-c1">dict</span>(<span class="pl-v">beep</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>boop<span class="pl-pds">'</span></span>)
key <span class="pl-k">=</span> db.put(<span class="pl-c1">12</span>, <span class="pl-c1">1</span>, <span class="pl-k">**</span>data)</pre></div>

<h3><a id="user-content-getkey" class="anchor" href="#getkey" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>get(key)</h3>

<p>Fetches the data with the given <code>key</code>.</p>

<p><code>key</code> must be of type <code>hv.entity.Key</code>.</p>

<p>Example:</p>

<div class="highlight highlight-source-python"><pre>key <span class="pl-k">=</span> Key(<span class="pl-c1">307821103844175873</span>)
res <span class="pl-k">=</span> db.get(key)</pre></div>

<h3><a id="user-content-disconnect" class="anchor" href="#disconnect" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>disconnect()</h3>

<p>Closes every connection in every pool.</p>

<h3><a id="user-content-reinstantiate" class="anchor" href="#reinstantiate" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>reinstantiate()</h3>

<p>Reinstantiates connection pools. Make sure you have closed every connection before calling this method.</p>

<h2><a id="user-content-license" class="anchor" href="#license" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>license</h2>

<p>mit</p>
</article>
  </div></body></html>