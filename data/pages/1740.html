<html><body><div><div class="entry-content">
						<p>In a nutshell <a href="https://coreos.com/using-coreos/etcd/">etcd</a> is an open-source distributed key value store and is written in <a href="http://golang.org/">Go</a>. You can run a single instance but it really shines when you set it up in a cluster and it will gracefully handle master election during network partitions and the loss of the current master. Today we are going to install etcd, use the CLI tool it ships with, and then do some simple Python scripts to interact with etcd.</p>
<p><span id="more-5146"/></p>
<p>I’m going to use <a href="https://www.vagrantup.com/">Vagrant</a> along with an Ubuntu 14.04 image to run <a href="https://github.com/coreos/etcd">etcd</a> on. Assuming you have Vagrant installed go ahead and run the following:</p>
<p><strong>Note:</strong> I keep my Vagrant projects in a folder called: <strong>VagrantBoxes</strong> – adjust as needed for your own system.</p>
<pre class="brush: plain; title: ; notranslate" title="">
$ cd VagrantBoxes
$ mkdir etcd
$ cd etcd
$ vagrant init ubuntu/trusty64
$ nano Vagrantfile
</pre>
<p>Inside the <strong>Vagrantfile</strong> add the following to the appropriate spot:</p>
<pre class="brush: plain; title: ; notranslate" title="">
  config.vm.provider "virtualbox" do |v|
    v.memory = 1024
    v.cpus = 2
  end
  config.vm.network "private_network", ip: "192.168.33.21"
</pre>
<p>Let’s spin up the VM now.</p>
<pre class="brush: plain; title: ; notranslate" title="">
vagrant up --provider=virtualbox
</pre>
<p>Once the VM us up and ready go ahead and ssh into it:</p>
<pre class="brush: plain; title: ; notranslate" title="">
$ vagrant ssh
</pre>
<p>Inside the VM we will fetch the latest etcd release from here: <a href="https://github.com/coreos/etcd/releases">https://github.com/coreos/etcd/releases</a> In the case of when this article was published the latest release was 0.4.6.</p>
<pre class="brush: plain; title: ; notranslate" title="">
$ wget https://github.com/coreos/etcd/releases/download/v0.4.6/etcd-v0.4.6-linux-amd64.tar.gz
$ tar xvf etcd-v0.4.6-linux-amd64.tar.gz
$ cd etcd-v0.4.6-linux-amd64/
</pre>
<p>To run etcd (for testing purposes) simply do this:</p>
<pre class="brush: plain; title: ; notranslate" title="">
$ ./etcd &amp;
</pre>
<p>etcd will now be running in the background which gives us a chance to test out the CLI tool that it ships with: <a href="https://github.com/coreos/etcdctl/">etcdctl</a></p>
<pre class="brush: plain; title: ; notranslate" title="">
$ ./etcdctl set /foo/bar "Hello world" --ttl 10
</pre>
<p>The key value pair you just entered will be stored for ten seconds. Let’s go ahead and retrieve it before it expires (keep in mind you don’t need to use time to live if you don’t want to).</p>
<pre class="brush: plain; title: ; notranslate" title="">
$ ./etcdctl get /foo/bar
</pre>
<p>There are plenty more commands you can explore, I <a href="https://github.com/coreos/etcdctl/">suggest reading over those</a> if your interested.</p>
<p>Now we will move onto the <a href="http://python.org">Python</a> part of this article. I like to have services running in a VM (or Docker) and run code from my laptop. This is why I ensured I could see the etcd service from my VM by adding this to the Vagrantfile earlier:</p>
<pre class="brush: plain; title: ; notranslate" title="">
config.vm.network "private_network", ip: "192.168.33.21"
</pre>
<p>Now I can hit that endpoint from my local machine using the Python tools I like to use.</p>
<p>I’m going to be using the <a href="https://github.com/jplana/python-etcd">python-etcd</a> client library to work with our new etcd install but first we will need to install it (its currently not on PyPi at this time). You can read the docs for <a href="http://python-etcd.readthedocs.org">python-etcd here</a>.</p>
<p>Find yourself a working folder for your Python project. In my case I keep my stuff in a folder called <a href="http://virtualenv.readthedocs.org">PythonProjects</a> with a virtualenv folder within that for each project. If your using Python 3.4.x you can use <a href="https://docs.python.org/3/library/venv.html">venv</a>.</p>
<pre class="brush: plain; title: ; notranslate" title="">
$ cd
$ cd PythonProjects
$ virtualenv etcd-example
$ cd etcd-example
$ source bin/activate
$ git clone https://github.com/jplana/python-etcd.git
$ cd python-etcd
$ python setup.py install
</pre>
<p>Create a Python file (in the <strong>python-etcd</strong> folder is fine for this example but you don’t want to do this for actual projects) called <strong>app.py</strong> and add the following code to it:</p>
<pre class="brush: python; title: ; notranslate" title="">
from __future__ import print_function
import etcd

if __name__ == "__main__":
    client = etcd.Client(host='192.168.33.21', port=4001)
    client.write('/foo/bar', 'hello from Python', ttl=10)
    print(client.read('/foo/bar').value)
</pre>
<p>We are basically doing the same thing that we did in the etcdctl CLI tool example before.</p>
<p>If you wait past the TTL of 10 seconds and comment out the <strong>client.write</strong> statement you will get an error since the value is gone. You can test for these sorts of things by doing the following:</p>
<pre class="brush: python; title: ; notranslate" title="">
from __future__ import print_function
import etcd

if __name__ == "__main__":
    client = etcd.Client(host='192.168.33.21', port=4001)
    try:
        print(client.read('/foo/bar').value)
    except KeyError as error:
        print(error.message)
</pre>
<p>Try storing a Python dictionary:</p>
<pre class="brush: python; title: ; notranslate" title="">
from __future__ import print_function
import etcd

if __name__ == "__main__":
    client = etcd.Client(host='192.168.33.21', port=4001)

    mydict = {
        'message': 'hello world',
        'something': 1234567890
    }

    client.write('/foo/bar', mydict, ttl=10)

    try:
        print(client.read('/foo/bar').value)
    except KeyError as error:
        print(error.message)
</pre>
<p>Obviously there are a lot more commands you can issue, see the API docs for <a href="https://github.com/coreos/etcd/blob/master/Documentation/api.md">etcd</a> as well as <a href="http://python-etcd.readthedocs.org">etcd-python</a> for more information.</p>
<p>One last code snippet – you can also get information on a cluster of etcd machines:</p>
<pre class="brush: python; title: ; notranslate" title="">
from __future__ import print_function
import etcd

if __name__ == "__main__":
    client = etcd.Client(host='192.168.33.21', port=4001)
    
    print(client.machines)
    print(client.leader)
</pre>
<p>To shutdown etcd in your VM simply run this:</p>
<pre class="brush: plain; title: ; notranslate" title="">
$ fg
CTRL-C
</pre>


											</div>


					</div></body></html>