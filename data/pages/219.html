<html><body><div><div class="entry-content"><p>Python’s <a href="http://docs.python.org/reference/compound_stmts.html#the-with-statement"><code>with</code></a> statement was first introduced five years ago, in Python 2.5. It’s handy when you have two related operations which you’d like to execute as a pair, with a block of code in between. The classic example is opening a file, manipulating the file, then closing it:</p>

<div><div class="CodeRay">
  <div class="code"><pre><span class="keyword">with</span> <span class="predefined">open</span>(<span class="string"><span class="delimiter">'</span><span class="content">output.txt</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">w</span><span class="delimiter">'</span></span>) <span class="keyword">as</span> f:
    f.write(<span class="string"><span class="delimiter">'</span><span class="content">Hi there!</span><span class="delimiter">'</span></span>)
</pre></div>
</div>
</div>

<p>The above <code>with</code> statement will automatically close the file after the nested block of code. (Continue reading to see exactly how the close occurs.) The advantage of using a <code>with</code> statement is that it is guaranteed to close the file no matter <em>how</em> the nested block exits. If an exception occurs before the end of the block, it will close the file before the exception is caught by an outer exception handler. If the nested block were to contain a <code>return</code> statement, or a <code>continue</code> or <code>break</code> statement, the <code>with</code> statement would automatically close the file in those cases, too.</p>


<p>Here’s another example. The <a href="http://cairographics.org/pycairo/">pycairo</a> drawing library contains a <code>Context</code> class which exposes a <a href="http://cairographics.org/documentation/pycairo/2/reference/context.html#cairo.Context.save"><code>save</code></a> method, to push the current drawing state on an internal stack, and a <a href="http://cairographics.org/documentation/pycairo/2/reference/context.html#cairo.Context.restore"><code>restore</code></a> method, to restore the drawing state from the stack. These two functions are always called in a pair, with some code in between.</p>

<p>This code sample uses a <code>Context</code> object (“cairo context”) to draw six rectangles, each with a different rotation. Each call to <a href="http://cairographics.org/documentation/pycairo/2/reference/context.html#cairo.Context.rotate"><code>rotate</code></a> is actually combined with the current transformation, so we use a pair of calls to <code>save</code> and <code>restore</code> to preserve the drawing state on each iteration of the loop. This prevents the rotations from combining with each other:</p>

<div><div class="CodeRay">
  <div class="code"><pre>cr.translate(<span class="integer">68</span>, <span class="integer">68</span>)
<span class="keyword">for</span> i <span class="keyword">in</span> <span class="predefined">xrange</span>(<span class="integer">6</span>):
    cr.<span class="highlight">save</span>()
    cr.<span class="highlight">rotate</span>(<span class="integer">2</span> * math.pi * i / <span class="integer">6</span>)
    cr.rectangle(-<span class="integer">25</span>, -<span class="integer">60</span>, <span class="integer">50</span>, <span class="integer">40</span>)
    cr.stroke()
    cr.<span class="highlight">restore</span>()
</pre></div>
</div>
</div>

<p><img class="center" src="/images/six-rectangles.png"/></p>

<p>That’s a fairly simple example, but for larger scripts, it can become cumbersome to keep track of which <code>save</code> goes with which <code>restore</code>, and to keep them correctly matched. The <code>with</code> statement can help tidy things up a bit.</p>

<p>By themselves, pycairo’s <code>save</code> and <code>restore</code> methods do not support the <code>with</code> statement, so we’ll have to add the support on our own. There are two ways to support the <code>with</code> statement: by implementing a context manager class, or by writing a generator function. I’ll demonstrate both approaches.</p>

<h2 id="implementing-the-context-manager-as-a-class">Implementing the Context Manager as a Class</h2>

<p>Here’s the first approach. To implement a context manager, we define a class containing an <code>__enter__</code> and <code>__exit__</code> method. The class below accepts a cairo context, <code>cr</code>, in its constructor:</p>

<div><div class="CodeRay">
  <div class="code"><pre><span class="keyword">class</span> <span class="class">Saved</span>():
    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>, cr):
        <span class="predefined-constant">self</span>.cr = cr
    <span class="keyword">def</span> <span class="highlight">__enter__</span>(<span class="predefined-constant">self</span>):
        <span class="predefined-constant">self</span>.cr.save()
        <span class="keyword">return</span> <span class="predefined-constant">self</span>.cr
    <span class="keyword">def</span> <span class="highlight">__exit__</span>(<span class="predefined-constant">self</span>, <span class="predefined">type</span>, value, traceback):
        <span class="predefined-constant">self</span>.cr.restore()
</pre></div>
</div>
</div>

<p>Thanks to those two methods, it’s valid to instantiate a <code>Saved</code> object and use it in a <code>with</code> statement. The <code>Saved</code> object is considered to be the <a href="http://docs.python.org/reference/datamodel.html#context-managers">context manager</a>.</p>

<div><div class="CodeRay">
  <div class="code"><pre>cr.translate(<span class="integer">68</span>, <span class="integer">68</span>)
<span class="keyword">for</span> i <span class="keyword">in</span> <span class="predefined">xrange</span>(<span class="integer">6</span>):
    <span class="highlight"><span class="keyword">with</span> Saved(cr):</span>
        cr.rotate(<span class="integer">2</span> * math.pi * i / <span class="integer">6</span>)
        cr.rectangle(-<span class="integer">25</span>, -<span class="integer">60</span>, <span class="integer">50</span>, <span class="integer">40</span>)
        cr.stroke()
</pre></div>
</div>
</div>

<p>Here are the exact steps taken by the Python interpreter when it reaches the <code>with</code> statement:</p>

<ol>
  <li>The <code>with</code> statement stores the <code>Saved</code> object in a temporary, hidden variable, since it’ll be needed later. (Actually, it only stores the bound <code>__exit__</code> method, but that’s a detail.)</li>
  <li>The <code>with</code> statement calls <code>__enter__</code> on the <code>Saved</code> object, giving the context manager a chance to do its job.</li>
  <li>The <code>__enter__</code> method calls <code>save</code> on the cairo context.</li>
  <li>The <code>__enter__</code> method returns the cairo context, but as you can see, we have not specified the optional <a href="http://docs.python.org/reference/compound_stmts.html#the-with-statement"><code>"as" target</code></a> part of the <code>with</code> statement. Therefore, the return value is not saved anywhere. We don’t need it; we know it’s the same cairo context that we passed in.</li>
  <li>The nested block of code is executed. It sets up the rotation and draws a rectangle.</li>
  <li>At the end of the nested block, the <code>with</code> statement calls the <code>Saved</code> object’s <code>__exit__</code> method, passing the arguments <code>(None, None, None)</code> to indicate that no exception occured.</li>
  <li>The <code>__exit__</code> method calls <code>restore</code> on the cairo context.</li>
</ol>

<p>Once we understand what the Python interpreter is doing, we can make better sense of the example at the beginning of this blog post, where we opened a file in the <code>with</code> statement: File objects expose their own <code>__enter__</code> and <code>__exit__</code> methods, and can therefore act as their own context managers. Specifically, the <code>__exit__</code> method closes the file.</p>

<h3 id="exception-handling">Exception Handling</h3>

<p>Returning to the drawing example, what happens if an exception occurs within the nested code block? For example, suppose we mistakenly passed the wrong number of arguments to the <code>rectangle</code> call. In that case, the steps taken by the Python interpreter would be:</p>

<ol>
  <li>The <code>rectangle</code> method raises a <code>TypeError</code> exception: “Context.rectangle() takes exactly 4 arguments.”</li>
  <li>The <code>with</code> statement catches this exception.</li>
  <li>The <code>with</code> statement calls <code>__exit__</code> on the <code>Saved</code> object. It passes information about the exception in three arguments: (<em>type</em>, <em>value</em>, <em>traceback</em>) – the same values you’d get by calling <a href="http://docs.python.org/library/sys.html#sys.exc_info"><code>sys.exc_info</code></a>. This tells the <code>__exit__</code> method everything it could possibly need to know about the exception that occurred.</li>
  <li>In this case, our <code>__exit__</code> method doesn’t particularly care. It calls <code>restore</code> on the cairo context anyway, and returns <code>None</code>. (In Python, when no <code>return</code> statement is specified, the function actually returns <code>None</code>.)</li>
  <li>The <code>with</code> statement checks to see whether this return value is true. Since it isn’t, the <code>with</code> statement re-raises the <code>TypeError</code> exception to be handled by someone else.</li>
</ol>

<p>In this manner, we can guarantee that <code>restore</code> will always be called on the cairo context, whether an exception occurs or not.</p>

<h2 id="implementing-the-context-manager-as-a-generator">Implementing the Context Manager as a Generator</h2>

<p>That brings us to the second approach for supporting the <code>with</code> statement. Instead of implementing a class for the context manager, we can write a <a href="http://docs.python.org/tutorial/classes.html#generators">generator function</a>. Here’s a simplified example of such a generator function. Let me point out right away that this example is incomplete, since it does not handle exceptions very well. Read on for more details:</p>

<div><div class="CodeRay">
  <div class="code"><pre><span class="keyword">from</span> <span class="include">contextlib</span> <span class="keyword">import</span> <span class="include">contextmanager</span>

<span class="decorator">@contextmanager</span>
<span class="keyword">def</span> <span class="function">saved</span>(cr):
    cr.save()
    <span class="highlight"><span class="keyword">yield</span></span> cr
    cr.restore()
</pre></div>
</div>
</div>

<p>There is a certain charm to writing a generator like this one. At first glance, it appears simpler than the previous approach: A single function takes the place of an entire class definition. But don’t be fooled! This approach involves many more steps, and a lot more complexity than the previous approach. It took me several reads of <a href="http://www.python.org/dev/peps/pep-0343/">PEP 343</a> –  which is more of a historical document than a reference – before I could claim to understand it completely. It requires familiarity with Python decorators, generators, iterators and functions-returning-functions, in addition to the object-oriented programming and exception handling we’ve already seen.</p>

<p>To make this generator work, two entities from <a href="http://docs.python.org/library/contextlib.html"><code>contextlib</code></a>, a standard Python module, are required: the <code>contextmanager</code> function, and an internal class named <code>GeneratorContextManager</code>. The source code, <a href="http://hg.python.org/cpython/file/2.7/Lib/contextlib.py"><code>contextlib.py</code></a>, is a bit hairy, but at least it’s short. I’ll simply describe what happens, and you are free to refer to the source code, and any other supplementary materials, as needed.</p>

<p>Let’s start with the generator itself. Here’s what happens when the above code snippet runs:</p>

<ol>
  <li>The Python interpreter recognizes the <a href="http://docs.python.org/reference/expressions.html#yield-expressions"><code>yield</code></a> statement in the middle of the function definition. As a result, the <code>def</code> statement does not create a normal function; it creates a generator function.</li>
  <li>Because of the presence of the <code>@contextmanager</code> <a href="http://docs.python.org/glossary.html#term-decorator">decorator</a>, <code>contextmanager</code> is called with the generator function as its argument.</li>
  <li>The <code>contextmanager</code> function returns a “factory” function, which creates <code>GeneratorContextManager</code> objects wrapped around the provided generator. (line 83 of <code>contextlib.py</code>)</li>
  <li>Finally, the factory function is assigned to <code>saved</code>. From this point on, when we call <code>saved</code>, we’ll actually be calling the factory function.</li>
</ol>

<p>Equipped with all that good stuff, we can now write:</p>

<div><div class="CodeRay">
  <div class="code"><pre><span class="keyword">for</span> i <span class="keyword">in</span> <span class="predefined">xrange</span>(<span class="integer">6</span>):
    <span class="highlight"><span class="keyword">with</span> saved(cr):</span>
        cr.rotate(<span class="integer">2</span> * math.pi * i / <span class="integer">6</span>)
        cr.rectangle(-<span class="integer">25</span>, -<span class="integer">60</span>, <span class="integer">50</span>, <span class="integer">40</span>)
        cr.stroke()
</pre></div>
</div>
</div>

<p>Here are all the steps taken by the Python interpreter when it reaches the <code>with</code> statement.</p>

<ol>
  <li>The <code>with</code> statement calls <code>saved</code>, which of course, calls the factory function, passing <code>cr</code>, a cairo context, as its only argument.</li>
  <li>The factory function passes the cairo context to our generator function, creating a <a href="http://docs.python.org/reference/expressions.html#yield-expressions">generator</a>.</li>
  <li>The generator is passed to the constructor of <code>GeneratorContextManager</code>, an internal class which will act as our context manager.</li>
  <li>The <code>with</code> statement saves the <code>GeneratorContextManager</code> object in a temporary hidden variable. (Actually, it only stores the bound <code>__exit__</code> method, but that’s a detail.)</li>
  <li>The <code>with</code> statement calls <code>__enter__</code> on the <code>GeneratorContextManager</code> object.</li>
  <li><code>__enter__</code> calls <a href="http://docs.python.org/reference/expressions.html#generator.next"><code>next</code></a> on the generator.</li>
  <li>Our generator function – the block of code we defined under <code>def saved(cr)</code> – runs up until the <code>yield</code> statement. This calls <code>save</code> on the cairo context.</li>
  <li>The <code>yield</code> statement yields the cairo context, which becomes the return value for the call to <code>next</code> on the iterator.</li>
  <li>The <code>__enter__</code> method returns the cairo context, but as you can see, we have not specified the optional <code>"as" target</code> part of the <code>with</code> statement. Therefore, the return value is not saved anywhere. We don’t need it; we know it’s the same cairo context that we passed in.</li>
  <li>The nested code block is executed. It sets up the rotation and draws a rectangle.</li>
  <li>At the end of the nested block, the <code>with</code> statement calls the <code>__exit__</code> method on the <code>GeneratorContextManager</code> object, passing the arguments <code>(None, None, None)</code> to indicate that no exception occured.</li>
  <li>The <code>__exit__</code> method calls <code>next</code> on the iterator (expecting a <code>StopIteration</code> exception).</li>
  <li>Our generator resumes execution after the <code>yield</code> statement. This calls <code>restore</code> on the cairo context.</li>
  <li>The generator returns, raising a <code>StopIteration</code> exception (as expected).</li>
  <li>The <code>__exit__</code> method catches the <code>StopIteration</code> exception, and returns normally.</li>
</ol>

<p>And that’s it! We’ve successfully used this generator function as a <code>with</code> statement context manager. In this example, it helped that no exceptions occured. To correctly deal with exceptions, we’ll have to improve the generator function a little bit.</p>

<h3 id="exception-handling-1">Exception Handling</h3>

<p>Now, what happens if an exception occurs within the nested block while using this approach? Again, let’s suppose we’ve mistakenly passed the wrong number of arguments to the <code>rectangle</code> call. Here’s what would happen:</p>

<ol>
  <li>The <code>rectangle</code> method raises a <code>TypeError</code> exception: “Context.rectangle() takes exactly 4 arguments.”</li>
  <li>The <code>with</code> statement catches this exception.</li>
  <li>The <code>with</code> statement calls <code>__exit__</code> on the <code>GeneratorContextManager</code> object. It passes information about the exception in three arguments: (<em>type</em>, <em>value</em>, <em>traceback</em>).</li>
  <li><code>__exit__</code> calls <a href="http://docs.python.org/reference/expressions.html#generator.throw"><code>throw</code></a> on the iterator, passing the same three arguments.</li>
  <li>The <code>TypeError</code> exception is raised in the context of our generator function, on the line containing the <code>yield</code> statement.</li>
</ol>

<p>Uh oh! At this point, our current generator function has a problem: <code>restore</code> will <em>not</em> be called on the cairo context. An exception has been raised on the line containing the <code>yield</code> statement, so the rest of the generator function will not be executed. We need to make the generator more robust, by inserting a <a href="http://docs.python.org/tutorial/errors.html#defining-clean-up-actions"><code>try/finally</code></a> block around the <code>yield</code>:</p>

<div><div class="CodeRay">
  <div class="code"><pre><span class="decorator">@contextmanager</span>
<span class="keyword">def</span> <span class="function">saved</span>(cr):
    cr.save()
    <span class="highlight"><span class="keyword">try</span></span>:
        <span class="keyword">yield</span> cr
    <span class="highlight"><span class="keyword">finally</span></span>:
        cr.restore()
</pre></div>
</div>
</div>

<p>Continuing where we left off:</p>

<ol>
  <li>Inside our generator, the <code>finally</code> block executes. This calls <code>restore</code> on the cairo context.</li>
  <li>The <code>TypeError</code> exception went unhandled by the generator, so it is re-raised in the <code>__exit__</code> method, on the line containing the call to <code>throw</code> on the iterator. (line 35 of <code>contextlib.py</code>)</li>
  <li>The <code>TypeError</code> exception is caught by <code>__exit__</code>.</li>
  <li><code>__exit__</code> sees that the exception caught is the same exception that was passed in, and as a result, returns <code>None</code>.</li>
  <li>The <code>with</code> statement checks to see whether this return value is true. Since it isn’t, the <code>with</code> statement re-raises the <code>TypeError</code> exception, to be handled by someone else.</li>
</ol>

<p>Thus concludes our journey through the Python <code>with</code> statement. If, like me, you’ve had a hard time understanding this statement completely – especially if you were attracted to the generator form of writing context managers – don’t feel bad. It’s complicated! It cleverly ties together several of Python’s language features, many of which were themselves introduced fairly recently in Python’s history. If any Pythonistas out there spot an error or oversight in the above explanation, please let me know in the comments.</p>

<h2 id="drawing-a-fractal-tree">Drawing a Fractal Tree</h2>

<p>For those of you who have endured the entire blog post up to this point, here’s a small bonus script. It uses our newly minted cairo context manager to recursively draw a fractal tree.</p>

<div><div class="CodeRay">
  <div class="code"><pre><span class="keyword">import</span> <span class="include">cairo</span>
<span class="keyword">from</span> <span class="include">contextlib</span> <span class="keyword">import</span> <span class="include">contextmanager</span>

<span class="decorator">@contextmanager</span>
<span class="keyword">def</span> <span class="function">saved</span>(cr):
    cr.save()
    <span class="keyword">try</span>:
        <span class="keyword">yield</span> cr
    <span class="keyword">finally</span>:
        cr.restore()

<span class="keyword">def</span> <span class="function">Tree</span>(angle):
    cr.move_to(<span class="integer">0</span>, <span class="integer">0</span>)
    cr.translate(<span class="integer">0</span>, -<span class="integer">65</span>)
    cr.line_to(<span class="integer">0</span>, <span class="integer">0</span>)
    cr.stroke()
    cr.scale(<span class="float">0.72</span>, <span class="float">0.72</span>)
    <span class="keyword">if</span> angle &gt; <span class="float">0.12</span>:
        <span class="keyword">for</span> a <span class="keyword">in</span> [-angle, angle]:
            <span class="highlight"><span class="keyword">with</span> saved(cr):</span>
                cr.rotate(a)
                Tree(angle * <span class="float">0.75</span>)

surf = cairo.ImageSurface(cairo.FORMAT_ARGB32, <span class="integer">280</span>, <span class="integer">204</span>)
cr = cairo.Context(surf)
cr.translate(<span class="integer">140</span>, <span class="integer">203</span>)
cr.set_line_width(<span class="integer">5</span>)
Tree(<span class="float">0.75</span>)
surf.write_to_png(<span class="string"><span class="delimiter">'</span><span class="content">fractal-tree.png</span><span class="delimiter">'</span></span>)
</pre></div>
</div>
</div>

<p><img class="center" src="/images/tree.png"/></p>

<p>For yet another example of <code>with</code> statement usage in Python, see <a href="http://preshing.com/20110924/timing-your-code-using-pythons-with-statement">Timing Your Code Using Pythonâs “with” Statement</a>.</p>
</div>



  

  </div></body></html>