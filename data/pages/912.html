<html><body><div><div class="content">
      
        <h1 class="content-title">Saturday morning hacks: Revisiting the notes app</h1>
      
      
      
  
  
  
    <p><a href="http://media.charlesleifer.com/blog/photos/coffee-cup-scaled.jpg" title="Saturday morning hacks"><img alt="Saturday morning hacks" class="img-responsive" src="http://m.charlesleifer.com/t/800x-/blog/photos/coffee-cup-scaled.jpg?key=xFJansgcRXa5MCBauZSUhQ"/></a></p>
<p>My post from last month, <a href="/blog/saturday-morning-hack-a-little-note-taking-app-with-flask/">Saturday Morning Hack, a Little Note-Taking App with Flask</a>, was pretty well-received. Since I've made a number of improvements to the app, I thought I would write one more post to share some of the updates I've made to this project, in the hopes that they may be of interest to you.</p>
<p>A live demo is up and running on Python Anywhere, so feel free to check that out before continuing on with the post: <a href="http://beetlejuicer.pythonanywhere.com/">http://beetlejuicer.pythonanywhere.com/</a></p>
<p>To briefly recap the previous post, I discussed how I built a lightweight note-taking app which I could use from my phone or desktop. It has a nice ajax-ey interface and some simple markdown helpers written with javascript. In addition to supporting markdown, it also supports <a href="http://micawber.readthedocs.org/en/latest/">oembed</a> for automatically embedding YouTube videos and the like. Here is what it looked like when we left off a few weeks ago:</p>
<p><a href="http://media.charlesleifer.com/blog/photos/s1398606107.86.png" title="Notes on Desktop"><img alt="Notes on Desktop" class="img-responsive" src="http://m.charlesleifer.com/t/800x-/blog/photos/s1398606107.86.png?key=QcgtYRlmhnJO4AHDSR1JsQ"/></a></p>
<p>And this is how it looks now!</p>
<p><a href="http://media.charlesleifer.com/blog/photos/s1401412049.61.png" title="New and improved notes app"><img alt="New and improved notes app" class="img-responsive" src="http://m.charlesleifer.com/t/800x-/blog/photos/s1401412049.61.png?key=LdrKFF3s4edQegczO_vI0A"/></a></p>
<p>So what's new? Well, I've made a couple changes under-the-hood, and added some entirely new features to the UI.</p>
<ul>
<li>Allow creation of <em>Task Lists</em> with checkbox inputs.</li>
<li>Create reminders that will send me an email at the appointed time.</li>
<li>Built a RESTful API to interact with the <code>Note</code> model. Thanks to <a href="http://flask-peewee.readthedocs.org">flask-peewee</a> everything comes "for free".</li>
<li>Added search.</li>
<li>Added pagination (using Ajax).</li>
</ul>
<p>This was super fun to hack on so I thought I'd share the new code and describe how I added these features. Honestly, I didn't really end up adding much in terms of implementation. Huey handles scheduling and sending the email reminders, even automatically retrying messages that fail to send. Similarly, Flask-Peewee's REST API provides search and pagination out-of-the-box, so all I had to do was write the JavaScript to communicate with it. Thanks to these libraries, I was able to focus on the things that made this project unique, and hopefully you enjoy reading about the code.</p>

<p>Here is the original bill of materials for the project:</p>

<p>To this list we will be adding:</p>
<ul>
<li><a href="http://huey.readthedocs.org">huey</a>, a task queue.</li>
<li><a href="http://flask-peewee.readthedocs.org">flask-peewee</a>, a flask extension for building RESTful APIs (among other things).</li>
<li><a href="http://redis.io">redis</a> and <a href="http://redis-py.readthedocs.org">redis-py</a> to provide the task queue (optional, huey works with sqlite3 as well).</li>
</ul>
<p>With those installed, let's get started!</p>
<h3>Tasks and Reminders</h3>
<p>Almost as soon as I finished the first version of the note-taking app, I realized that there were two features that would dramatically increase its usefulness to me: to-do lists and reminders.</p>
<p>I'll start with a discussion of the changes I made to the peewee database models. I added two new features that required schema changes: tasks and reminders. Tasks are lists of check-able boxes that appear along with a note (like a to-do list), and reminders allow a note to be emailed to me automatically at an appointed time.</p>
<p>Tasks are stored in a related table and consist of a title, an ordering (so tasks are displayed in the order they are entered), and a boolean value to indicate whether the task has been completed. Here is the task model:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Task</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">note</span> <span class="o">=</span> <span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">Note</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">'tasks'</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">IntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">finished</span> <span class="o">=</span> <span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">db</span>

    <span class="k">def</span> <span class="nf">html</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">rich_content</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
</pre></div>
<p>The <code>rich_content()</code> helper runs a chunk of text through markdown and oembed and returns the resulting HTML:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">rich_content</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">maxwidth</span><span class="o">=</span><span class="mi">300</span><span class="p">):</span>
    <span class="n">html</span> <span class="o">=</span> <span class="n">parse_html</span><span class="p">(</span>
        <span class="n">markdown</span><span class="p">(</span><span class="n">content</span><span class="p">),</span>
        <span class="n">oembed</span><span class="p">,</span>
        <span class="n">maxwidth</span><span class="o">=</span><span class="n">maxwidth</span><span class="p">,</span>
        <span class="n">urlize_all</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Markup</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
</pre></div>
<p>Tasks are created by placing an <code>@</code> symbol at the beginning of the line I wish to become a task. So this:</p>
<p><a href="http://media.charlesleifer.com/blog/photos/s1401455674.0.png" title="Task input in notes app"><img alt="Task input in notes app" class="img-responsive" src="http://m.charlesleifer.com/t/800x-/blog/photos/s1401455674.0.png?key=j5TkuGQ-tDz31ywDNO_cGw"/></a></p>
<p>Becomes this:</p>
<p><a href="http://media.charlesleifer.com/blog/photos/s1401455688.5.png" title="Task display in notes app"><img alt="Task display in notes app" class="img-responsive" src="http://m.charlesleifer.com/t/800x-/blog/photos/s1401455688.5.png?key=ZtnirduyqE4BjkMSa3FzUQ"/></a></p>
<p>Reminders were implemented by adding columns to the <code>Note</code> table to track when to send the reminder, and whether the reminder has been sent or not. I chose to use <a href="https://huey.readthedocs.org/">huey</a>, a lightweight python task queue, for sending the reminders. Reminders are created by clicking the <em>clock</em> icon and entering a date and time:</p>
<p><a href="http://media.charlesleifer.com/blog/photos/s1401460274.96.png" title="Specifying a reminder in the notes app"><img alt="Specifying a reminder in the notes app" class="img-responsive" src="http://m.charlesleifer.com/t/800x-/blog/photos/s1401460274.96.png?key=JUg9oDyVsBaJ9AaoA6NwZw"/></a></p>
<p>When a note has a reminder attached, the reminder time will be displayed in the note's footer. Reminders appear yellow in the notes list to increase their visual impact:</p>
<p><a href="http://media.charlesleifer.com/blog/photos/s1401460293.25.png" title="Reminder display in notes app"><img alt="Reminder display in notes app" class="img-responsive" src="http://m.charlesleifer.com/t/800x-/blog/photos/s1401460293.25.png?key=XKAYWOQFIeNAFb-amFy_eQ"/></a></p>
<h4>The Note model</h4>
<p>Below is the code for the updated <code>Note</code> model. When a note is saved, tasks are created by splitting the content and extracting lines that begin with the <code>@</code> symbol. In addition, if the note has a <code>reminder</code> timestamp present, a task will be scheduled to send the reminder.</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Note</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">STATUS_VISIBLE</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">STATUS_ARCHIVED</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">STATUS_DELETED</span> <span class="o">=</span> <span class="mi">9</span>

    <span class="n">content</span> <span class="o">=</span> <span class="n">TextField</span><span class="p">()</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">DateTimeField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">IntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">STATUS_VISIBLE</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">reminder</span> <span class="o">=</span> <span class="n">DateTimeField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">reminder_task_created</span> <span class="o">=</span> <span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">reminder_sent</span> <span class="o">=</span> <span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">db</span>

    <span class="k">def</span> <span class="nf">html</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">rich_content</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Task</span><span class="o">.</span><span class="n">finished</span> <span class="o">==</span> <span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Task</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">parse_content_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Split the list of tasks from the surrounding content.</span>
        <span class="n">content</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'@'</span><span class="p">):</span>
                <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">content</span><span class="p">),</span> <span class="n">tasks</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Split out the text content and any tasks.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_content_tasks</span><span class="p">()</span>

        <span class="c1"># Determine if we need to set a reminder.</span>
        <span class="n">set_reminder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reminder</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">reminder_task_created</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reminder_task_created</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c1"># Save the note.</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Note</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">set_reminder</span><span class="p">:</span>
            <span class="c1"># Set a reminder to go off by enqueueing a task with huey.</span>
            <span class="n">send_note_reminder</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,),</span> <span class="n">eta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reminder</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tasks</span><span class="p">:</span>
            <span class="c1"># Store the tasks.</span>
            <span class="n">Task</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Task</span><span class="o">.</span><span class="n">note</span> <span class="o">==</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tasks</span><span class="p">):</span>
                <span class="n">Task</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">note</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">idx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">public</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">Note</span>
                <span class="o">.</span><span class="n">select</span><span class="p">()</span>
                <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Note</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Note</span><span class="o">.</span><span class="n">STATUS_VISIBLE</span><span class="p">)</span>
                <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Note</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">desc</span><span class="p">()))</span>
</pre></div>
<p>I've also written a <a href="http://huey.readthedocs.org/en/latest/api.html#Huey.task">huey task</a> that will send the reminder email at the appointed time. Huey does all the hard work: scheduling the task, running it, and even automatically retrying the task in the event an error occurs sending the email.</p>
<div class="highlight"><pre><span class="nd">@huey.task</span><span class="p">(</span><span class="n">retries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">retry_delay</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">send_note_reminder</span><span class="p">(</span><span class="n">note_id</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">note</span> <span class="o">=</span> <span class="n">Note</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Note</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">note_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Note</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">'Attempting to send reminder for note id=</span><span class="si">%s</span><span class="s1">, but note '</span>
                <span class="s1">'was not found in the database.'</span><span class="p">,</span> <span class="n">note_id</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">note</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Note</span><span class="o">.</span><span class="n">STATUS_DELETED</span><span class="p">:</span>
            <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'Attempting to send a reminder for a deleted '</span>
                            <span class="s1">'note id=</span><span class="si">%s</span><span class="s1">. Skipping.'</span><span class="p">,</span> <span class="n">note_id</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># SEND AN EMAIL USING WHATEVER IMPLEMENTATION YOU PREFER.</span>
            <span class="c1"># You could also replace this with an SMS, tweet, whatever.</span>
            <span class="n">some_mailer</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
                <span class="n">to</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'REMINDER_EMAIL'</span><span class="p">],</span>
                <span class="n">subj</span><span class="o">=</span><span class="s1">'[notes] reminder'</span><span class="p">,</span>
                <span class="n">body</span><span class="o">=</span><span class="n">note</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'Sending reminder failed for id=</span><span class="si">%s</span><span class="s1">.'</span><span class="p">,</span> <span class="n">note_id</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">note</span><span class="o">.</span><span class="n">reminder_sent</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">note</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
<p>In order to use huey in our project, we need to put a <code>Huey</code> instance in our <code>app.py</code> module:</p>
<div class="highlight"><pre><span class="c1"># Add the following lines to the end of app.py</span>
<span class="c1"># Using huey with Redis:</span>
<span class="kn">from</span> <span class="nn">huey</span> <span class="kn">import</span> <span class="n">RedisHuey</span>
<span class="n">huey</span> <span class="o">=</span> <span class="n">RedisHuey</span><span class="p">()</span>

<span class="c1"># Using huey with sqlite3:</span>
<span class="kn">from</span> <span class="nn">huey</span> <span class="kn">import</span> <span class="n">SqliteHuey</span>
<span class="n">huey</span> <span class="o">=</span> <span class="n">SqliteHuey</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">APP_ROOT</span><span class="p">,</span> <span class="s1">'huey.db'</span><span class="p">))</span>
</pre></div>
<p>The huey consumer runs as a separate process, scheduling and executing tasks asynchronously. Check the <a href="http://huey.readthedocs.org">documentation</a> for instructions on setting it up.</p>
<h3>Flask-Peewee and REST</h3>
<p>Flask-Peewee, despite having languished a bit over the past year, is still pretty useful for throwing together a simple REST API. I decided to expose the <code>Note</code> model using a basic REST API, and then implement the saving and <em>archiving</em> functionality with a few simple JavaScript calls. Flask-peewee provides a number of desirable features out-of-the-box, saving me a lot of work:</p>
<ul>
<li>Pagination</li>
<li>Filtering (which I used to implement search)</li>
<li>Authentication</li>
<li>Serialization of notes and Deserialization of POST requests</li>
</ul>
<p>It's been some time since I wrote anything new with Flask-Peewee, but it was refreshingly easy to get the API up and running. After installing with <code>pip</code>, I created an <code>api</code> module and added the following code. I've overridden the <code>NoteResource.prepare_data()</code> method so I can includes an HTML representation of each <code>Note</code> along with the JSON data.</p>
<div class="highlight"><pre><span class="c1"># api.py</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span>
<span class="kn">from</span> <span class="nn">flask_peewee.rest</span> <span class="kn">import</span> <span class="n">Authentication</span>
<span class="kn">from</span> <span class="nn">flask_peewee.rest</span> <span class="kn">import</span> <span class="n">RestAPI</span>
<span class="kn">from</span> <span class="nn">flask_peewee.rest</span> <span class="kn">import</span> <span class="n">RestResource</span>

<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">app</span>
<span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">Note</span>
<span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">Task</span>


<span class="c1"># Allow GET and POST requests without requiring authentication.</span>
<span class="n">auth</span> <span class="o">=</span> <span class="n">Authentication</span><span class="p">(</span><span class="n">protected_methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'PUT'</span><span class="p">,</span> <span class="s1">'DELETE'</span><span class="p">])</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">RestAPI</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">default_auth</span><span class="o">=</span><span class="n">auth</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">NoteResource</span><span class="p">(</span><span class="n">RestResource</span><span class="p">):</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="s1">'content'</span><span class="p">,</span> <span class="s1">'timestamp'</span><span class="p">,</span> <span class="s1">'status'</span><span class="p">)</span>
    <span class="n">paginate_by</span> <span class="o">=</span> <span class="mi">30</span>

    <span class="k">def</span> <span class="nf">get_query</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Note</span><span class="o">.</span><span class="n">public</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">prepare_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">'rendered'</span><span class="p">]</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">'note.html'</span><span class="p">,</span> <span class="n">note</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

<span class="k">class</span> <span class="nc">TaskResource</span><span class="p">(</span><span class="n">RestResource</span><span class="p">):</span>
    <span class="n">paginate_by</span> <span class="o">=</span> <span class="mi">50</span>

<span class="n">api</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Note</span><span class="p">,</span> <span class="n">NoteResource</span><span class="p">)</span>
<span class="n">api</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Task</span><span class="p">,</span> <span class="n">TaskResource</span><span class="p">)</span>
</pre></div>
<p>In order to make use of the new REST API, we need to import it in the app's entry-point, <code>main.py</code> and call the <code>setup()</code> method to register the URL routes:</p>
<div class="highlight"><pre><span class="c1"># main.py</span>
<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">app</span>
<span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">Note</span>
<span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">Task</span>
<span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">api</span>
<span class="kn">import</span> <span class="nn">views</span>

<span class="n">api</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">Note</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">Task</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
<p>Now we can access <code>/api/note/</code> and view the serialized notes:</p>
<div class="highlight"><pre><span class="p">{</span>
  <span class="s2">"meta"</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">"model"</span><span class="o">:</span> <span class="s2">"note"</span><span class="p">,</span>
    <span class="s2">"next"</span><span class="o">:</span> <span class="s2">""</span><span class="p">,</span>
    <span class="s2">"page"</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">"previous"</span><span class="o">:</span> <span class="s2">""</span>
  <span class="p">},</span>
  <span class="s2">"objects"</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">"content"</span><span class="o">:</span> <span class="s2">"Code is available here: https://gist.github.com/coleifer/69ec9d09b2efe05527eb"</span><span class="p">,</span>
      <span class="s2">"timestamp"</span><span class="o">:</span> <span class="s2">"2014-05-30 15:55:12"</span><span class="p">,</span>
      <span class="s2">"rendered"</span><span class="o">:</span> <span class="s2">"&lt;li class=\"note col-xs-12 col-sm-6 col-lg-4\"&gt;...&lt;/li&gt;"</span><span class="p">,</span>
      <span class="s2">"status"</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="s2">"id"</span><span class="o">:</span> <span class="mi">6</span>
    <span class="p">},</span>
    <span class="p">...</span> <span class="nx">more</span> <span class="nx">notes</span> <span class="p">...</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
<p>This means that we can now greatly simplify the homepage view, since everything will be happening using the API via Ajax:</p>
<div class="highlight"><pre><span class="c1"># views.py -- yes, this is *it*.</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span>

<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">app</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">homepage</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">'homepage.html'</span><span class="p">)</span>
</pre></div>
<h3>Lots of JavaScript</h3>
<p>In order to load the notes from the API, I ended up rewriting much of the original JavaScript code. In order to use the API we need to make Ajax requests to it, so let's start with a helper function <code>makeRequest()</code>:</p>
<div class="highlight"><pre><span class="nx">Editor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">makeRequest</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">method</span> <span class="o">==</span> <span class="s1">'GET'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="p">{</span>
      <span class="s1">'contentType'</span><span class="o">:</span> <span class="s1">'application/json; charset=UTF-8'</span><span class="p">,</span>
      <span class="s1">'data'</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">),</span>
      <span class="s1">'dataType'</span><span class="o">:</span> <span class="s1">'json'</span><span class="p">,</span>
      <span class="s1">'headers'</span><span class="o">:</span> <span class="p">{},</span> <span class="cm">/* You might send authentication data here. */</span>
      <span class="s1">'success'</span><span class="o">:</span> <span class="nx">callback</span><span class="p">,</span>
      <span class="s1">'type'</span><span class="o">:</span> <span class="nx">method</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>Now that we can make requests, let's add code to retrieve lists of <code>Note</code> objects. Since the note's markdown content is rendered on the server, the JavaScript code has little to do besides adding the notes to the DOM and binding click handlers to allow deletion of the notes.</p>
<p>Here is the <code>getList()</code> method, which retrieves a list of notes using the REST API. If a particular page or a search term was specified, that information is relayed back to the API:</p>
<div class="highlight"><pre><span class="nx">Editor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getList</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">page</span><span class="p">,</span> <span class="nx">search</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">requestData</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">container</span><span class="p">.</span><span class="nx">empty</span><span class="p">();</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">page</span><span class="p">)</span> <span class="nx">requestData</span><span class="p">[</span><span class="s1">'page'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">page</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">search</span><span class="p">)</span> <span class="nx">requestData</span><span class="p">[</span><span class="s1">'content__ilike'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'%'</span> <span class="o">+</span> <span class="nx">search</span> <span class="o">+</span> <span class="s1">'%'</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">makeRequest</span><span class="p">(</span><span class="s1">'/api/note/'</span><span class="p">,</span> <span class="s1">'GET'</span><span class="p">,</span> <span class="nx">requestData</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">data</span><span class="p">.</span><span class="nx">objects</span><span class="p">.</span><span class="nx">reverse</span><span class="p">();</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">objects</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">idx</span><span class="p">,</span> <span class="nx">note</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">addNoteToList</span><span class="p">(</span><span class="nx">note</span><span class="p">.</span><span class="nx">rendered</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="nx">imagesLoaded</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">container</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">container</span><span class="p">.</span><span class="nx">masonry</span><span class="p">(</span><span class="s1">'layout'</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">updatePagination</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre></div>
<p>The code to add a note to the DOM is hopefully straightforward. The note is added, click handlers are bound to the archive and delete buttons, and if there are any tasks associate with the note, we'll bind handlers to trigger when the checkbox is clicked.</p>
<div class="highlight"><pre><span class="nx">Editor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addNoteToList</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">html</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">listElem</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">html</span><span class="p">);</span>
  <span class="nx">listElem</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">'a.delete-note,a.archive-note'</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">changeNote</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
  <span class="p">});</span>
  <span class="nx">listElem</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">'input[type="checkbox"]'</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">'change'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">updateTask</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
  <span class="p">});</span>
  <span class="nx">listElem</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">'img'</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">'img-responsive'</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">container</span><span class="p">.</span><span class="nx">prepend</span><span class="p">(</span><span class="nx">listElem</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">container</span><span class="p">.</span><span class="nx">masonry</span><span class="p">(</span><span class="s1">'prepended'</span><span class="p">,</span> <span class="nx">listElem</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>Since I use this app on my phone, it was important for me to add pagination so as not to spend lots of time transferring data over slow connections. Flask-Peewee's REST API comes with support for pagination, and even returns metadata to automatically generate the correct next/previous URLs (if they exist). Whenever a list of notes is loaded, a call is made to <code>updatePagination</code>, and this function in turn updates a <code>state</code> object which tracks the current page, whether there is a previous or next page, and whether there is a current search term. Here is how <code>updatePagination</code> is implemented:</p>
<div class="highlight"><pre><span class="nx">Editor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">updatePagination</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">meta</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">meta</span><span class="p">;</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">=</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">page</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'page'</span><span class="o">:</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">page</span><span class="p">};</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">[</span><span class="s1">'hasNext'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">next</span> <span class="o">!=</span> <span class="s1">''</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">[</span><span class="s1">'hasPrevious'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">previous</span> <span class="o">!=</span> <span class="s1">''</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">[</span><span class="s1">'search'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'input[name="q"]'</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>

  <span class="kd">var</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'ul.pager li.next'</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">hasNext</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">next</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">'disabled'</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">next</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">'disabled'</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">previous</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'ul.pager li.previous'</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">hasPrevious</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">previous</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">'disabled'</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">previous</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">'disabled'</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>The pagination links are bound when the editor is initialized. Here is the code for binding the pagination, which as you can see, is looking at the internal <code>state</code> object to generate the links:</p>
<div class="highlight"><pre><span class="nx">Editor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">bindPagination</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">makeHandler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">parent</span><span class="p">().</span><span class="nx">hasClass</span><span class="p">(</span><span class="s1">'disabled'</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">==</span> <span class="s1">'next'</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">page</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">state</span><span class="p">[</span><span class="s1">'page'</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">page</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">state</span><span class="p">[</span><span class="s1">'page'</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">getList</span><span class="p">(</span><span class="nx">page</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">state</span><span class="p">[</span><span class="s1">'search'</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'ul.pager li.next a'</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="nx">makeHandler</span><span class="p">(</span><span class="s1">'next'</span><span class="p">));</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'ul.pager li.previous a'</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="nx">makeHandler</span><span class="p">(</span><span class="s1">'previous'</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
<h4>Creating new notes</h4>
<p>To create a new note, we'll just <code>POST</code> the content to the API endpoint and let flask-peewee handle the rest. There's a little bit of work we need to do to correctly serialize the value of the <code>reminder</code> field, but that's about it. Flask-peewee returns a JSON representation of the new note, so we can immediately add the new note to the DOM using the <code>addNoteToList</code> method:</p>
<div class="highlight"><pre><span class="nx">Editor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addNote</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">val</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s1">'color'</span><span class="p">,</span> <span class="s1">'#dd1111'</span><span class="p">);</span>
    <span class="k">return</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">note</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'content'</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">val</span><span class="p">()};</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">reminder</span><span class="p">.</span><span class="nx">is</span><span class="p">(</span><span class="s1">':visible'</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">reminder</span><span class="p">.</span><span class="nx">val</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// Fix any bizarre date formats.</span>
    <span class="kd">var</span> <span class="nx">dateTime</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">reminder</span><span class="p">.</span><span class="nx">val</span><span class="p">().</span><span class="nx">replace</span><span class="p">(</span><span class="s1">'T'</span><span class="p">,</span> <span class="s1">' '</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s1">'Z'</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">dateTime</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">':'</span><span class="p">).</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">dateTime</span> <span class="o">=</span> <span class="nx">dateTime</span> <span class="o">+</span> <span class="s1">':00'</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">note</span><span class="p">[</span><span class="s1">'reminder'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">dateTime</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s1">'color'</span><span class="p">,</span> <span class="s1">'#464545'</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">makeRequest</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'action'</span><span class="p">),</span> <span class="s1">'POST'</span><span class="p">,</span> <span class="nx">note</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">val</span><span class="p">(</span><span class="s1">''</span><span class="p">).</span><span class="nx">focus</span><span class="p">();</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">resetReminder</span><span class="p">();</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">addNoteToList</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">rendered</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre></div>
<h3>All the JavaScript</h3>
<p>Unfortunately, the entire JavaScript file is just a bit too long for me to post it inline (~200 LOC). If you'd like, you can view the source code in <a href="https://gist.github.com/coleifer/69ec9d09b2efe05527eb#file-static-js-notes-js">this gist</a>. Things I did not cover in this post:</p>
<ul>
<li>Initializing the editor.</li>
<li>Reminder date widget.</li>
<li>Search event handler.</li>
<li>Archive / Delete note event handlers.</li>
<li>Task checkbox event handler.</li>
<li>Markdown helpers (covered in previous post).</li>
</ul>
<h3>Templates</h3>
<p>The <code>note.html</code> template partial needs to be updated to display the checkbox task widgets and the reminder information. Here is the updated <code>note.html</code>:</p>
<div class="highlight"><pre><span class="p">&lt;</span><span class="nt">li</span> <span class="na">class</span><span class="o">=</span><span class="s">"note col-xs-12 col-sm-6 col-lg-4"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"panel panel-{% if note.reminder %}warning{% else %}primary{% endif %}"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"panel-heading"</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">"btn btn-danger btn-xs delete-note pull-right"</span> <span class="na">data-note</span><span class="o">=</span><span class="s">"{{ note.id }}"</span> <span class="na">href</span><span class="o">=</span><span class="s">"/api/note/{{ note.id }}/"</span><span class="p">&gt;</span><span class="ni"></span><span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">"btn btn-info btn-xs archive-note pull-right"</span> <span class="na">data-note</span><span class="o">=</span><span class="s">"{{ note.id }}"</span> <span class="na">href</span><span class="o">=</span><span class="s">"/api/note/{{ note.id }}/"</span><span class="p">&gt;</span>a<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
      {{ note.timestamp.strftime('%b %d, %Y - %I:%M%p').lower() }}
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"panel-body"</span><span class="p">&gt;</span>
      {{ note.html() }}
      {% for task in note.get_tasks() %}
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"checkbox"</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">input</span> <span class="na">id</span><span class="o">=</span><span class="s">"task-{{ task.id }}"</span> <span class="err">{%</span> <span class="na">if</span> <span class="na">task</span><span class="err">.</span><span class="na">finished</span> <span class="err">%}</span><span class="na">checked</span><span class="o">=</span><span class="s">"checked"</span> <span class="err">{%</span> <span class="na">endif</span> <span class="err">%}</span><span class="na">name</span><span class="o">=</span><span class="s">"task"</span> <span class="na">type</span><span class="o">=</span><span class="s">"checkbox"</span> <span class="na">value</span><span class="o">=</span><span class="s">"{{ task.id }}"</span><span class="p">&gt;</span>
            {{ task.html() }}
          <span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      {% endfor %}
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    {% if note.reminder %}
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"panel-footer"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">"glyphicon glyphicon-time"</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
        {{ note.reminder.strftime('%m/%d/%Y %I:%M%p') }}
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    {% endif %}
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
</pre></div>
<p>The <code>homepage.html</code> template also changed to accomodate the search input and pagination links. Since this template is a bit long I won't include it's contents in this post, but you can find the code <a href="https://gist.github.com/coleifer/69ec9d09b2efe05527eb#file-templates-homepage-html">in this gist</a>.</p>
<h3>Live demo</h3>
<p>You can check out a live demo at <a href="http://beetlejuicer.pythonanywhere.com/">http://beetlejuicer.pythonanywhere.com/</a> (thanks to Python Anywhere for the free hosting!). As you might expect, the reminders will not actually send an email anywhere, but feel free to try creating one.</p>
<h3>Thanks for reading</h3>
<p>Thanks for taking the time to read this post, I hope you found it interesting. If you have any comments or suggestions on ways I could improve this project I'd love to hear them - please <a href="#comments">leave a comment</a> below.</p>
<p><em>Update</em>: check out the next post in the series, where we <a href="/blog/saturday-morning-hacks-adding-full-text-search-to-the-flask-note-taking-app/">add robust full-text search</a> to the note-taking app.</p>
<h3>Links</h3>

<p>Other posts in the series:</p>

<p>Or simply look at <a href="/blog/tags/saturday-morning-hacks/">all of the saturday-morning hack posts</a>.</p>
  
  

  
  
  


<hr/>

  <p>Commenting has been closed, but please feel free to <a href="/contact/">contact me</a></p>


    </div>

    </div></body></html>