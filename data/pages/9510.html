<html><body><div><div class="entry-content clearfix"><p>Last <a href="https://realpython.com/blog/python/development-and-deployment-of-cookiecutter-django-via-docker/">time</a> we set up a Django Project using Cookiecutter, managed the application environment via Docker, and then deployed the app to Digital Ocean. <strong>In this tutorial, we’ll shift away from Docker and detail a development to deployment workflow of a Cookiecutter-Django Project on Fedora 23.</strong></p>




<a name="Development"/>
<h2>Development</h2>

<p>Install <a href="https://github.com/audreyr/cookiecutter">cookiecutter</a> globally and then generate a bootstrapped Django project:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>pip install <span class="nv">cookiecutter</span><span class="o">==</span>1.3.0
</span><span class="line"><span class="nv">$ </span>cookiecutter https://github.com/pydanny/cookiecutter-django.git
</span></code></pre></td></tr></table></div></figure>


<p>This command runs cookiecutter with the <a href="https://github.com/pydanny/cookiecutter-django">cookiecutter-django</a> repo, allowing us to enter project-specific details. (We named the project and the repo <em>django_cookiecutter_fedora</em>.)</p>

<blockquote><p><strong>NOTE</strong>: Check out the <a href="https://realpython.com/blog/python/development-and-deployment-of-cookiecutter-django-via-docker/#local-setup">Local Setup</a> section from the previous post for more information on this command as well as the generated project structure.</p></blockquote>

<p>Before we can start our Django Project, we are still left with few steps…</p>

<a name="Database.Setup"/>
<h3>Database Setup</h3>

<p>First, we need to set up Postgres since cookiecutter-django uses it as its default database (see <em><a href="https://github.com/realpython/django_cookiecutter_fedora/blob/master/config/settings/common.py">django_cookiecutter_fedora/config/settings/common.py</a></em> for more info). Follow the steps to set up a Postgres database server, from any <a href="https://wiki.postgresql.org/wiki/Detailed_installation_guides">good resource</a> on the Internet or just scroll down to the <a href="#deployment">Deployment Section</a> for setting it up on <a href="https://getfedora.org/">Fedora</a>.</p>

<blockquote><p><strong>NOTE</strong>: If you’re on a Mac, check out <a href="http://postgresapp.com/">Postgres.app</a>.</p></blockquote>

<p>Once the Postgres server is running, create a new database from <a href="http://www.postgresql.org/docs/9.4/static/app-psql.html">psql</a> that shares the same name as your project name:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>create database django_cookiecutter_fedora<span class="p">;</span>
</span><span class="line">CREATE DATABASE
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><strong>NOTE</strong>: There may be some variation in the above command for creating a database based upon your version of Postgres. You can check for the correct command in Postgres’ latest documentation found <a href="http://www.postgresql.org/docs/9.5/interactive/manage-ag-createdb.html">here</a>.</p></blockquote>

<a name="Dependency.Setup"/>
<h3>Dependency Setup</h3>

<p>Next, in order to get your Django Project in a state ready for development, navigate to the root directory, create/activate a virtual environment, and then install the dependencies:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span><span class="nb">cd </span>django_cookiecutter_fedora
</span><span class="line"><span class="nv">$ </span>pyvenv-3.4 .env
</span><span class="line"><span class="nv">$ </span><span class="nb">source</span> .env/bin/activate
</span><span class="line"><span class="nv">$ </span>./install_python_dependencies.sh
</span></code></pre></td></tr></table></div></figure>


<a name="Sanity.Check"/>
<h2>Sanity Check</h2>

<p>Apply the migrations and then run the local development server:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>python manage.py makemigrations
</span><span class="line"><span class="nv">$ </span>python manage.py migrate
</span><span class="line"><span class="nv">$ </span>python manage.py runserver
</span></code></pre></td></tr></table></div></figure>


<p>Ensure all is well by navigating to <a href="http://localhost:8000/">http://localhost:8000/</a> in your browser to view the Project quick start page. Once done, kill the development server, initialize a new Git repo, commit, and PUSH to Github.</p>

<a name="Deployment"/>
<h2>Deployment</h2>

<p>With the Project setup and running locally, we can now move on to deployment where we will utilize the following tools:</p>




<a name="Fedora.23.Setup"/>
<h3>Fedora 23 Setup</h3>

<p>Set up a quick <a href="https://www.digitalocean.com/?refcode=d8f211a4b4c2">Digital Ocean</a> droplet, making sure to use a Fedora 23 image. For help, follow <a href="https://www.digitalocean.com/community/tutorials/how-to-create-your-first-digitalocean-droplet-virtual-server">this</a> tutorial. Make sure you <a href="https://www.digitalocean.com/community/tutorials/how-to-use-ssh-keys-with-digitalocean-droplets">set up an SSH key</a> for secure login.</p>

<p>Now let’s <a href="https://fedoraproject.org/wiki/DNF_system_upgrade">update</a> our server. SSH into the server as root, and then fire the update process:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>ssh root@SERVER_IP_ADDRESS
</span><span class="line"><span class="c"># dnf upgrade</span>
</span></code></pre></td></tr></table></div></figure>


<a name="Non-Root.User"/>
<h3>Non-Root User</h3>

<p>Next, let’s set up a non-root user so that applications are not run under administrative privileges, which makes the system more secure.</p>

<p>As a root user, follow these commands to set up a non-root user:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="c"># adduser &lt;name-of-user&gt;</span>
</span><span class="line"><span class="c"># passwd &lt;name-of-user&gt;</span>
</span><span class="line">Changing password <span class="k">for </span>user &lt;name-of-user&gt;.
</span><span class="line">New password:
</span><span class="line">Retype new password:
</span><span class="line">passwd: all authentication tokens updated successfully.
</span></code></pre></td></tr></table></div></figure>


<p>In the above snippet we created the new, non-root user user then specified a password for said user. We now need to <a href="http://fedoraproject.org/wiki/Configuring_Sudo">add this user to the administrative group</a> so that they can run commands that require admin privileges with <code>sudo</code>:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="c"># usermod &lt;name-of-user&gt; -a -G wheel</span>
</span></code></pre></td></tr></table></div></figure>


<p>Exit from the server and log back in again as the non-root user. Did you notice that the shell prompt changed from a <code>#</code> (pound-sign) to <code>$</code> (dollar-sign)? This indicates that we are logged in as a non-root user.</p>

<a name="Required.Packages"/>
<h3>Required Packages</h3>

<p>While logged in as the non-root user, download and install the following packages:</p>

<blockquote><p><strong>Note</strong>: Below we are giving our non-root user root rights (recommended!). If by any chance you wish to not give the non-root user root rights explicitly, you will have to prepend <code>sudo</code> keyword with every command you execute in the terminal.</p></blockquote>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>sudo su
</span><span class="line"><span class="c"># dnf install postgresql-server postgresql-contrib postgresql-devel python3-devel python-devel gcc nginx git</span>
</span></code></pre></td></tr></table></div></figure>


<a name="Postgres.Setup"/>
<h3>Postgres Setup</h3>

<p>With the dependencies downloaded and installed, we just need to set up our Postgres server and create a database.</p>

<p>Initialize Postgres and then manually start the server:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="c"># sudo postgresql-setup initdb</span>
</span><span class="line"><span class="c"># sudo systemctl start postgresql</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then log in to the Postgres server by switching (<code>su</code>) to the <code>postgres</code> user:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="c"># sudo su - postgres</span>
</span><span class="line"><span class="c"># psql</span>
</span><span class="line"><span class="nv">postgres</span><span class="o">=</span><span class="c">#</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now create a Postgres user and database required for our project, making sure that the username matches the name of the non-root user:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">postgres</span><span class="o">=</span><span class="c"># CREATE USER &lt;user-name&gt; WITH PASSWORD '&lt;password-for-user&gt;';</span>
</span><span class="line">CREATE ROLE
</span><span class="line"><span class="nv">postgres</span><span class="o">=</span><span class="c"># CREATE DATABASE django_cookiecutter_fedora;</span>
</span><span class="line">CREATE DATABASE
</span><span class="line"><span class="nv">postgres</span><span class="o">=</span><span class="c"># GRANT ALL ON DATABASE django_cookiecutter_fedora TO &lt;user-name&gt;;</span>
</span><span class="line">GRANT
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><strong>NOTE</strong>: If you need help, please follow the <a href="https://fedoraproject.org/wiki/PostgreSQL">official guide</a> for setting up Postgres on Fedora.</p></blockquote>

<p>Exit psql and return to your non-root user’s shell session:</p>

<figure class="code"><figcaption><span/></figcaption></figure>


<p>When you exit from the postgres session, you will return back to your non-root user prompt. <code>[username@django-cookiecutter-deploy ~]#</code>.</p>

<blockquote><p><strong>Note</strong>: Did you notice the <code>#</code> sign at the prompt? This is now appearing because we gave our non-root user the root rights before starting off with setting up our server.</p></blockquote>

<p>Configure Postgres so that it starts when the server boots/reboots:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="c"># systemctl enable postgresql</span>
</span><span class="line"><span class="c"># systemctl restart postgresql</span>
</span></code></pre></td></tr></table></div></figure>


<a name="Project.Setup"/>
<h3>Project Setup</h3>

<p>Clone the project structure from your GitHub repo to the <em>/opt</em> directory:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="c"># git clone &lt;github-repo-url&gt; /opt/&lt;name of the repo&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><strong>NOTE</strong>: Want to use the repo associated with this tutorial? Simply run: <code>sudo git clone https://github.com/realpython/django_cookiecutter_fedora /opt/django_cookiecutter_fedora</code></p></blockquote>

<a name="Dependency.Setup"/>
<h3>Dependency Setup</h3>

<p>Next, in order to get your Django Project in a state ready for deployment, create and active a virtualenv inside your project’s root directory:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="c"># cd /opt/django_cookiecutter_fedora/</span>
</span><span class="line"><span class="c"># pip3 install virtualenv</span>
</span><span class="line"><span class="c"># pyvenv-3.4 venv</span>
</span></code></pre></td></tr></table></div></figure>


<p>Before activating the virtualenv, give the current, non-root user admin rights (if not given):</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>sudo su
</span><span class="line"><span class="c"># source venv/bin/activate</span>
</span></code></pre></td></tr></table></div></figure>


<p>Unlike with the set up of the development environment from above, before installing the dependencies we need to install all of <a href="https://pillow.readthedocs.org/en/3.0.x/index.html">Pillow</a>’s external libraries. Check out this <a href="https://pillow.readthedocs.org/en/3.0.x/installation.html#basic-installation">resource</a> for more info.</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="c"># dnf install libtiff-devel libjpeg-devel libzip-devel freetype-devel \</span>
</span><span class="line">    lcms2-devel libwebp-devel tcl-devel tk-devel
</span></code></pre></td></tr></table></div></figure>


<p>Next, we need to install one more package in order to ensure that we do not get conflicts while installing dependencies in our virtualenv.</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="c"># dnf install redhat-rpm-config</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then run:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="c"># ./install_python_dependencies.sh</span>
</span></code></pre></td></tr></table></div></figure>


<p>Again, this will install all the base, local, and production requirements. This is just for a quick sanity check to ensure all is working. Since this is technically the production environment, we will change the environment shortly.</p>

<blockquote><p><strong>NOTE</strong>: Deactivate the virtualenv. Now if you issue an exit command – e.g., <code>exit</code> – the non-root user will no longer have root rights. Notice the change in prompt. That said, the user can still activate the virtualenv. Try it!</p></blockquote>

<a name="Sanity.Check..take.2."/>
<h2>Sanity Check (take 2)</h2>

<p>Apply all the migrations:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>python manage.py makemigrations
</span><span class="line"><span class="nv">$ </span>python manage.py migrate
</span></code></pre></td></tr></table></div></figure>


<p>Now run the server:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>python manage.py runserver 0.0.0.0:8000
</span></code></pre></td></tr></table></div></figure>


<p>To ensure things are working fine, just visit the server’s IP address in your browser – e.g., &lt;ip-address or hostname&gt;:8000.</p>

<a name="Gunicorn.Setup"/>
<h2>Gunicorn Setup</h2>

<p>Before setting up Gunicorn, we need to make some changes to the production settings, in the <em>/config/settings/production.py</em> module.</p>

<p>Take a look at the production settings <a href="https://github.com/realpython/django_cookiecutter_fedora/blob/master/config/settings/production.py">here</a>, which are the minimal settings needed for deploying our Django Project to a production server.</p>

<p>To update these, open the file in VI:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>sudo vi config/settings/production.py
</span></code></pre></td></tr></table></div></figure>


<p>First, select all and delete:</p>

<figure class="code"><figcaption><span/></figcaption></figure>


<p>And then copy the new settings and paste them into the now empty file by entering INSERT mode and then pasting. Make sure to update the <code>ALLOWED_HOSTS</code> variable as well (very, very important!) with your server’s IP address or hostname. Exit INSERT mode and then save and exit:</p>

<figure class="code"><figcaption><span/></figcaption></figure>


<p>Once done, we need to add some environment variables to the <em>.bashrc</em> file, since the majority of the config settings come from environment variables within the <em>production.py</em> file.</p>

<p>Again, use VI to edit this file:</p>

<figure class="code"><figcaption><span/></figcaption></figure>


<p>Enter INSERT mode and add the following:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="c"># Environment Variables</span>
</span><span class="line"><span class="nb">export </span><span class="nv">DJANGO_SETTINGS_MODULE</span><span class="o">=</span><span class="s1">'config.settings.production'</span>
</span><span class="line">
</span><span class="line"><span class="nb">export </span><span class="nv">DJANGO_SECRET_KEY</span><span class="o">=</span><span class="s1">'CHANGEME!!!m_-0-_)3&amp;-(+hn$!1i3$*$ujru4yw4@!u7048_(#1a*y_g2v3r'</span>
</span><span class="line">
</span><span class="line"><span class="nb">export </span><span class="nv">DATABASE_URL</span><span class="o">=</span><span class="s1">'postgres:///django_cookiecutter_fedora'</span>
</span></code></pre></td></tr></table></div></figure>


<p>Two things to note:</p>

<ol>
<li>Notice how we updated the <code>DJANGO_SETTINGS_MODULE</code> variable to use the production settings.</li>
<li>It’s a good <a href="https://www.quora.com/What-is-the-SECRET_KEY-in-Django-actually-used-for">practice</a> to change your <code>DJANGO_SECRET_KEY</code> to a <a href="http://stackoverflow.com/questions/15170637/effects-of-changing-djangos-secret-key">more complex</a> string. Do this now if you want.</li>
</ol>


<p>Again, exit INSERT mode, and then save and exit VI.</p>

<p>Now just reload the <em>.bashrc</em> file:</p>

<figure class="code"><figcaption><span/></figcaption></figure>


<p>Ready to test?! Inside the root directory, with the virtualenv activated, execute the gunicorn server:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>gunicorn --bind &lt;ip-address or hostname&gt;:8000 config.wsgi:application
</span></code></pre></td></tr></table></div></figure>


<p>This will make our web application, again, serve on &lt;ip-address or hostname&gt;:8000.</p>

<p>Keep in mind that as soon as we log out of our server this command will stop and hence we would no longer be able to serve our web app. So, we have to make our gunicorn server execute as a service so that it can be started, stopped, and monitored.</p>

<a name="Nginx.Config"/>
<h2>Nginx Config</h2>

<p>Follow these steps for adding a configuration file for making our Django Project serve via Nginx:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span><span class="nb">cd</span> /etc/nginx/conf.d
</span><span class="line"><span class="nv">$ </span>sudo vi django_cookiecutter_fedora.conf
</span></code></pre></td></tr></table></div></figure>


<p>Add the following, making sure to update the <code>server</code>, <code>server_name</code>, and <code>location</code> for project root:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line">upstream app_server <span class="o">{</span>
</span><span class="line">    server 192.241.166.11:8000 <span class="nv">fail_timeout</span><span class="o">=</span>0<span class="p">;</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line">server <span class="o">{</span>
</span><span class="line">    listen 80<span class="p">;</span>
</span><span class="line">    server_name 192.241.166.11<span class="p">;</span>
</span><span class="line">    access_log /var/log/nginx/django_project-access.log<span class="p">;</span>
</span><span class="line">    error_log /var/log/nginx/django_project-error.log info<span class="p">;</span>
</span><span class="line">
</span><span class="line">    keepalive_timeout 5<span class="p">;</span>
</span><span class="line">
</span><span class="line">    <span class="c"># path for staticfiles</span>
</span><span class="line">    location /static <span class="o">{</span>
</span><span class="line">            autoindex on<span class="p">;</span>
</span><span class="line">            <span class="nb">alias</span> /opt/django_cookiecutter_fedora/staticfiles/<span class="p">;</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">
</span><span class="line">    location / <span class="o">{</span>
</span><span class="line">        proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
</span><span class="line">        proxy_set_header Host <span class="nv">$http_host</span><span class="p">;</span>
</span><span class="line">        proxy_redirect off<span class="p">;</span>
</span><span class="line">
</span><span class="line">        <span class="k">if</span> <span class="o">(</span>!-f <span class="nv">$request_filename</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">            proxy_pass http://app_server<span class="p">;</span>
</span><span class="line">            <span class="nb">break</span><span class="p">;</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Save and exit VI, and then restart the Nginx server:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>sudo systemctl restart nginx.service
</span></code></pre></td></tr></table></div></figure>


<p>That’s it!</p>

<a name="Gunicorn.Start.Script"/>
<h2>Gunicorn Start Script</h2>

<p>Now let’s create a Gunicorn start script which will run as an executable, making our bootstrapped Django web application run via the Gunicorn server, routed through Nginx.</p>

<p>Within the project root, run:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>sudo mkdir deploy log
</span><span class="line"><span class="nv">$ </span><span class="nb">cd </span>deploy
</span><span class="line"><span class="nv">$ </span>sudo vi gunicorn_start
</span></code></pre></td></tr></table></div></figure>


<p>The contents of the <em>gunicorn_start</em> script can be found <a href="https://github.com/realpython/django_cookiecutter_fedora/blob/master/deploy/gunicorn_start">here</a>. It is divided into 3 significant parts, which are, for the most part, self-explanatory. For any questions, please comment below.</p>

<blockquote><p><strong>NOTE</strong>: Make sure the <code>USER</code> and <code>GROUP</code> variables match the same user and group for the non-root user.</p></blockquote>

<p>Paste the contents into VI, and then save and exit.</p>

<p>Finally, let’s make it executable:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>sudo chmod +x gunicorn_start
</span></code></pre></td></tr></table></div></figure>


<p>Start the server:</p>

<figure class="code"><figcaption><span/></figcaption></figure>


<p>Once again visit the your server’s ip address in the browser and you will see your Django web app running!</p>

<p>Did you get a 502 Bad gateway error? Just follow these steps and it will probably be enough to make your application work…</p>

<a name="Modifying.SELinux.Policy.Rules"/>
<h3>Modifying SELinux Policy Rules</h3>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>sudo dnf install policycoreutils-devel
</span><span class="line"><span class="nv">$ </span>sudo cat /var/log/audit/audit.log <span class="p">|</span> grep nginx <span class="p">|</span> grep denied <span class="p">|</span> audit2allow -M mynginx
</span><span class="line"><span class="nv">$ </span>sudo semodule -i mynginx.pp
</span></code></pre></td></tr></table></div></figure>


<p>Once done, make sure to restart your server via Digital Ocean’s dashboard utility.</p>

<a name="Systemd"/>
<h2>Systemd</h2>

<p>To make our <em>gunicorn_start</em> script run as a system service so that, even if we are no longer logged into the server, it still serves our Django web application, we need to create a <a href="https://fedoraproject.org/wiki/Systemd">systemd</a> service.</p>

<p>Just change the working directory to <em>/etc/systemd/system</em>, and then create a service file:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span><span class="nb">cd</span> /etc/systemd/system
</span><span class="line"><span class="nv">$ </span>sudo vi django-bootstrap.service
</span></code></pre></td></tr></table></div></figure>


<p>Add the following:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="c">#!/bin/sh</span>
</span><span class="line">
</span><span class="line"><span class="o">[</span>Unit<span class="o">]</span>
</span><span class="line"><span class="nv">Description</span><span class="o">=</span>Django Web App
</span><span class="line"><span class="nv">After</span><span class="o">=</span>network.target
</span><span class="line">
</span><span class="line"><span class="o">[</span>Service<span class="o">]</span>
</span><span class="line"><span class="nv">PIDFile</span><span class="o">=</span>/var/run/cric.pid
</span><span class="line"><span class="nv">ExecStart</span><span class="o">=</span>/opt/django_cookiecutter_fedora/deploy/gunicorn_start
</span><span class="line"><span class="nv">Restart</span><span class="o">=</span>on-abort
</span><span class="line">
</span><span class="line"><span class="o">[</span>Install<span class="o">]</span>
</span><span class="line"><span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</span></code></pre></td></tr></table></div></figure>


<p>Save and exit, and then start the service and enable it:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>sudo systemctl start django-bootstrap.service
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><strong>NOTE</strong>: If you encounter an error, run <code>journalctl -xe</code> to see more details.</p></blockquote>

<p>Finally, enable the service so that it runs forever and restarts on arbitrary shut downs:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>sudo systemctl <span class="nb">enable </span>django-bootstrap.service
</span></code></pre></td></tr></table></div></figure>


<a name="Sanity.Check..final.."/>
<h2>Sanity Check (final!)</h2>

<p>Check for the status of the service:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>sudo systemctl status django-bootstrap.service
</span></code></pre></td></tr></table></div></figure>


<p>Now just visit your server’s IP address (or hostname) and you will see a Django error page. To fix this, run the following command in your project’s root directory (with your virtualenv activated):</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>python manage.py collectstatic
</span></code></pre></td></tr></table></div></figure>


<p>Now you are good to go, and you will see the Django web app running on the web browser with all the static files (HTML/CSS/JS) files working.</p>

<hr/>


<p>For further reference grab the code from the <a href="https://github.com/realpython/django_cookiecutter_fedora/">repository</a>. Add your questions/comments/concerns below. Cheers!</p>
</div>


      </div></body></html>