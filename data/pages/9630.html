<html><body><div><div class="entry-content">
                <div class="panel">
                    <p class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"/><time datetime="2016-01-18T06:10:00-05:00"> Mon, January 18, 2016</time>
    </span>



    
</footer>                    </p>
                </div>
                    <p>Today we’ll talk about <strong>unary operators</strong>, namely unary plus (+) and unary minus  (-) operators.</p>
<p>A lot of today’s material is based on the material from the previous article, so if you need a refresher just head back to <a href="http://ruslanspivak.com/lsbasi-part7/" title="Part 7">Part 7</a> and go over it again. Remember: repetition is the mother of all learning.</p>
<p>Having said that, this is what you are going to do today:</p>
<ul>
<li>extend the grammar to handle unary plus and unary minus operators</li>
<li>add a new <em>UnaryOp</em> <span class="caps">AST</span> node class</li>
<li>extend the parser to generate an <span class="caps">AST</span> with <em>UnaryOp</em> nodes</li>
<li>extend the interpreter and add a new <em>visit_UnaryOp</em> method to interpret unary operators</li>
</ul>
<p>Let’s get started, shall we?</p>
<p>So far we’ve worked with binary operators only (+, -, *, /), that is, the operators that operate on two operands.</p>
<p>What is a unary operator then? A <em>unary operator</em> is an operator that operates on one <em>operand</em> only.</p>
<p>Here are the rules for unary plus and unary minus operators:</p>
<ul>
<li>The unary minus (-) operator produces the negation of its numeric operand</li>
<li>The unary plus (+) operator yields its numeric operand without change</li>
<li>The unary operators have higher precedence than the binary operators +, -, *, and /</li>
</ul>
<p>In the expression “+ - 3” the first ‘+’ operator represents the unary plus operation and the second ‘-‘ operator represents the unary minus operation. The expression “+ - 3” is equivalent to “+ (- (3))” which is equal to -3. One could also say that <strong>-3</strong> in the expression is a negative integer, but in our case we treat it as a unary minus operator with 3 as its positive integer operand:</p>
<p><img alt="" src="https://ruslanspivak.com/lsbasi-part8/lsbasi_part8_exp1.png"/></p>
<p>Let’s take a look at another expression, “5 - - 2”:</p>
<p><img alt="" src="https://ruslanspivak.com/lsbasi-part8/lsbasi_part8_exp2.png"/></p>
<p>In the expression “5 - - 2” the first ‘-‘ represents the <em>binary</em> subtraction operation and the second ‘-‘ represents the <em>unary</em> minus operation, the negation.</p>
<p>And some more examples:</p>
<p><img alt="" src="https://ruslanspivak.com/lsbasi-part8/lsbasi_part8_exp3.png"/></p>
<p><img alt="" src="https://ruslanspivak.com/lsbasi-part8/lsbasi_part8_exp4.png"/></p>
<p>Now let’s update our grammar to include unary plus and unary minus operators. We’ll modify the <em>factor</em> rule and add unary operators there because unary operators have higher precedence than binary +, -, * and / operators.</p>
<p>This is our current <em>factor</em> rule:</p>
<p><img alt="" src="https://ruslanspivak.com/lsbasi-part8/lsbasi_part8_factor_before.png"/></p>
<p>And this is our updated <em>factor</em> rule to handle unary plus and unary minus operators:</p>
<p><img alt="" src="https://ruslanspivak.com/lsbasi-part8/lsbasi_part8_factor_after.png"/></p>
<p>As you can see, I extended the <em>factor</em> rule to reference itself, which allows us to derive expressions like  “- - - + - 3”, a legitimate expression with a lot of unary operators.</p>
<p>Here is the full grammar that can now derive expressions with unary plus and unary minus operators:</p>
<p><img alt="" src="https://ruslanspivak.com/lsbasi-part8/lsbasi_part8_grammar.png"/></p>
<p>The next step is to add an <span class="caps">AST</span> node class to represent unary operators.</p>
<p>This one will do:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">UnaryOp</span><span class="p">(</span><span class="n">AST</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">expr</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">op</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span>
</pre></div>


<p>The constructor takes two parameters: <em>op</em>, which represents the unary operator token (plus or minus) and <em>expr</em>, which represents an <span class="caps">AST</span> node.</p>
<p>Our updated grammar had changes to the <em>factor</em> rule, so that’s what we’re going to modify in our parser - the <em>factor</em> method. We will add code to the method to handle the “(<span class="caps">PLUS</span> | <span class="caps">MINUS</span>) factor” sub-rule:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">factor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""factor : (PLUS | MINUS) factor | INTEGER | LPAREN expr RPAREN"""</span>
    <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_token</span>
    <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PLUS</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eat</span><span class="p">(</span><span class="n">PLUS</span><span class="p">)</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">UnaryOp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">node</span>
    <span class="k">elif</span> <span class="n">token</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">MINUS</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eat</span><span class="p">(</span><span class="n">MINUS</span><span class="p">)</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">UnaryOp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">node</span>
    <span class="k">elif</span> <span class="n">token</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">INTEGER</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eat</span><span class="p">(</span><span class="n">INTEGER</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Num</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">token</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">LPAREN</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eat</span><span class="p">(</span><span class="n">LPAREN</span><span class="p">)</span>
        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eat</span><span class="p">(</span><span class="n">RPAREN</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span>
</pre></div>


<p><br/>
And now we need to extend the <em>Interpreter</em> class and add a <em>visit_UnaryOp</em> method to interpret unary nodes:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">visit_UnaryOp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
    <span class="n">op</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">type</span>
    <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="n">PLUS</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">MINUS</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>
</pre></div>


<p>Onward!</p>
<p>Let’s manually build an <span class="caps">AST</span> for the expression “5 - - - 2” and pass it to our interpreter to verify that the new <em>visit_UnaryOp</em> method works. Here is how you can do it from the Python shell:</p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">spi</span> <span class="kn">import</span> <span class="n">BinOp</span><span class="p">,</span> <span class="n">UnaryOp</span><span class="p">,</span> <span class="n">Num</span><span class="p">,</span> <span class="n">MINUS</span><span class="p">,</span> <span class="n">INTEGER</span><span class="p">,</span> <span class="n">Token</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">five_tok</span> <span class="o">=</span> <span class="n">Token</span><span class="p">(</span><span class="n">INTEGER</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">two_tok</span> <span class="o">=</span> <span class="n">Token</span><span class="p">(</span><span class="n">INTEGER</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">minus_tok</span> <span class="o">=</span> <span class="n">Token</span><span class="p">(</span><span class="n">MINUS</span><span class="p">,</span> <span class="s">'-'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">expr_node</span> <span class="o">=</span> <span class="n">BinOp</span><span class="p">(</span>
<span class="o">...</span>     <span class="n">Num</span><span class="p">(</span><span class="n">five_tok</span><span class="p">),</span>
<span class="o">...</span>     <span class="n">minus_tok</span><span class="p">,</span>
<span class="o">...</span>     <span class="n">UnaryOp</span><span class="p">(</span><span class="n">minus_token</span><span class="p">,</span> <span class="n">UnaryOp</span><span class="p">(</span><span class="n">minus_token</span><span class="p">,</span> <span class="n">Num</span><span class="p">(</span><span class="n">two_tok</span><span class="p">)))</span>
<span class="o">...</span> <span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">spi</span> <span class="kn">import</span> <span class="n">Interpreter</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">inter</span> <span class="o">=</span> <span class="n">Interpreter</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">inter</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">expr_node</span><span class="p">)</span>
<span class="mi">3</span>
</pre></div>


<p>Visually the above <span class="caps">AST</span> tree looks like this:</p>
<p><img alt="" src="https://ruslanspivak.com/lsbasi-part8/lsbasi_part8_ast.png"/></p>
<p>Download the full source code of the interpreter for this article directly from <a href="https://github.com/rspivak/lsbasi/blob/master/part8/python/spi.py">GitHub</a>. Try it out and see for yourself that your updated tree-based interpreter properly evaluates arithmetic expressions containing unary operators.</p>
<p>Here is a sample session:</p>
<div class="highlight"><pre><span class="nv">$ </span>python spi.py
spi&gt; - 3
-3
spi&gt; + 3
3
spi&gt; <span class="m">5</span> - - - + - 3
8
spi&gt; <span class="m">5</span> - - - + - <span class="o">(</span><span class="m">3</span> + 4<span class="o">)</span> - +2
10
</pre></div>


<p><br/>
I also updated the <a href="https://github.com/rspivak/lsbasi/blob/master/part8/python/genastdot.py">genastdot.py</a> utility to handle unary operators. Here are some of the examples of the generated <span class="caps">AST</span> images for expressions with unary operators:</p>
<div class="highlight"><pre><span class="nv">$ </span>python genastdot.py <span class="s2">"- 3"</span> &gt; ast.dot <span class="o">&amp;&amp;</span> dot -Tpng -o ast.png ast.dot
</pre></div>


<p><img alt="" src="https://ruslanspivak.com/lsbasi-part8/lsbasi_part8_genastdot_01.png"/></p>
<div class="highlight"><pre><span class="nv">$ </span>python genastdot.py <span class="s2">"+ 3"</span> &gt; ast.dot <span class="o">&amp;&amp;</span> dot -Tpng -o ast.png ast.dot
</pre></div>


<p><img alt="" src="https://ruslanspivak.com/lsbasi-part8/lsbasi_part8_genastdot_02.png"/></p>
<div class="highlight"><pre><span class="nv">$ </span>python genastdot.py <span class="s2">"5 - - - + - 3"</span> &gt; ast.dot <span class="o">&amp;&amp;</span> dot -Tpng -o ast.png ast.dot
</pre></div>


<p><img alt="" src="https://ruslanspivak.com/lsbasi-part8/lsbasi_part8_genastdot_03.png"/></p>
<div class="highlight"><pre><span class="nv">$ </span>python genastdot.py <span class="s2">"5 - - - + - (3 + 4) - +2"</span> <span class="se">\</span>
  &gt; ast.dot <span class="o">&amp;&amp;</span> dot -Tpng -o ast.png ast.dot
</pre></div>


<p><img alt="" src="https://ruslanspivak.com/lsbasi-part8/lsbasi_part8_genastdot_04.png"/></p>
<p><br/>
<br/>
And here is a new exercise for you:</p>
<p><img alt="" src="https://ruslanspivak.com/lsbasi-part8/lsbasi_part8_exercises.png"/></p>

<p><br/>
That’s all for today. In the next article, we’ll tackle assignment statements. Stay tuned and see you soon.</p>
<p><br/>
Here is a list of books I recommend that will help you in your study of interpreters and compilers:</p>
<ol>
<li>
<p><a href="http://www.amazon.com/gp/product/193435645X/ref=as_li_tl?ie=UTF8&amp;camp=1789&amp;creative=9325&amp;creativeASIN=193435645X&amp;linkCode=as2&amp;tag=russblo0b-20&amp;linkId=MP4DCXDV6DJMEJBL">Language Implementation Patterns: Create Your Own Domain-Specific and General Programming Languages (Pragmatic Programmers)</a><img src="http://ir-na.amazon-adsystem.com/e/ir?t=russblo0b-20&amp;l=as2&amp;o=1&amp;a=193435645X" border="0" alt=""/></p>
<p><a href="http://www.amazon.com/gp/product/B00QMJQHYG/ref=as_li_tl?ie=UTF8&amp;camp=1789&amp;creative=9325&amp;creativeASIN=B00QMJQHYG&amp;linkCode=as2&amp;tag=russblo0b-20&amp;linkId=I53DN2FPOSCOLBXA"><img border="0" src="http://ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&amp;ASIN=B00QMJQHYG&amp;Format=_SL250_&amp;ID=AsinImage&amp;MarketPlace=US&amp;ServiceVersion=20070822&amp;WS=1&amp;tag=russblo0b-20"/></a><img src="http://ir-na.amazon-adsystem.com/e/ir?t=russblo0b-20&amp;l=as2&amp;o=1&amp;a=B00QMJQHYG" border="0" alt=""/></p>
</li>
<li>
<p><a href="http://www.amazon.com/gp/product/0470177071/ref=as_li_tl?ie=UTF8&amp;camp=1789&amp;creative=9325&amp;creativeASIN=0470177071&amp;linkCode=as2&amp;tag=russblo0b-20&amp;linkId=UCLGQTPIYSWYKRRM">Writing Compilers and Interpreters: A Software Engineering Approach</a><img src="http://ir-na.amazon-adsystem.com/e/ir?t=russblo0b-20&amp;l=as2&amp;o=1&amp;a=0470177071" border="0" alt=""/></p>
<p><a href="http://www.amazon.com/gp/product/0470177071/ref=as_li_tl?ie=UTF8&amp;camp=1789&amp;creative=9325&amp;creativeASIN=0470177071&amp;linkCode=as2&amp;tag=russblo0b-20&amp;linkId=FYAZBCVOB66PGR6J"><img border="0" src="http://ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&amp;ASIN=0470177071&amp;Format=_SL250_&amp;ID=AsinImage&amp;MarketPlace=US&amp;ServiceVersion=20070822&amp;WS=1&amp;tag=russblo0b-20"/></a><img src="http://ir-na.amazon-adsystem.com/e/ir?t=russblo0b-20&amp;l=as2&amp;o=1&amp;a=0470177071" border="0" alt=""/></p>
</li>
<li>
<p><a href="http://www.amazon.com/gp/product/052182060X/ref=as_li_tl?ie=UTF8&amp;camp=1789&amp;creative=9325&amp;creativeASIN=052182060X&amp;linkCode=as2&amp;tag=russblo0b-20&amp;linkId=ZSKKZMV7YWR22NMW">Modern Compiler Implementation in Java</a><img src="http://ir-na.amazon-adsystem.com/e/ir?t=russblo0b-20&amp;l=as2&amp;o=1&amp;a=052182060X" border="0" alt=""/></p>
<p><a href="http://www.amazon.com/gp/product/052182060X/ref=as_li_tl?ie=UTF8&amp;camp=1789&amp;creative=9325&amp;creativeASIN=052182060X&amp;linkCode=as2&amp;tag=russblo0b-20&amp;linkId=GPMSWTZYFC2M6MJE"><img border="0" src="http://ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&amp;ASIN=052182060X&amp;Format=_SL250_&amp;ID=AsinImage&amp;MarketPlace=US&amp;ServiceVersion=20070822&amp;WS=1&amp;tag=russblo0b-20"/></a><img src="http://ir-na.amazon-adsystem.com/e/ir?t=russblo0b-20&amp;l=as2&amp;o=1&amp;a=052182060X" border="0" alt=""/></p>
</li>
<li>
<p><a href="http://www.amazon.com/gp/product/1461446988/ref=as_li_tl?ie=UTF8&amp;camp=1789&amp;creative=9325&amp;creativeASIN=1461446988&amp;linkCode=as2&amp;tag=russblo0b-20&amp;linkId=PAXWJP5WCPZ7RKRD">Modern Compiler Design</a><img src="http://ir-na.amazon-adsystem.com/e/ir?t=russblo0b-20&amp;l=as2&amp;o=1&amp;a=1461446988" border="0" alt=""/></p>
<p><a href="http://www.amazon.com/gp/product/1461446988/ref=as_li_tl?ie=UTF8&amp;camp=1789&amp;creative=9325&amp;creativeASIN=1461446988&amp;linkCode=as2&amp;tag=russblo0b-20&amp;linkId=DZVYHZHDHYAPOQOD"><img border="0" src="http://ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&amp;ASIN=1461446988&amp;Format=_SL250_&amp;ID=AsinImage&amp;MarketPlace=US&amp;ServiceVersion=20070822&amp;WS=1&amp;tag=russblo0b-20"/></a><img src="http://ir-na.amazon-adsystem.com/e/ir?t=russblo0b-20&amp;l=as2&amp;o=1&amp;a=1461446988" border="0" alt=""/></p>
</li>
<li>
<p><a href="http://www.amazon.com/gp/product/0321486811/ref=as_li_tl?ie=UTF8&amp;camp=1789&amp;creative=9325&amp;creativeASIN=0321486811&amp;linkCode=as2&amp;tag=russblo0b-20&amp;linkId=GOEGDQG4HIHU56FQ">Compilers: Principles, Techniques, and Tools (2nd Edition)</a><img src="http://ir-na.amazon-adsystem.com/e/ir?t=russblo0b-20&amp;l=as2&amp;o=1&amp;a=0321486811" border="0" alt=""/></p>
<p><a href="http://www.amazon.com/gp/product/0321486811/ref=as_li_tl?ie=UTF8&amp;camp=1789&amp;creative=9325&amp;creativeASIN=0321486811&amp;linkCode=as2&amp;tag=russblo0b-20&amp;linkId=MD7L2CQHFXDYKOG6"><img border="0" src="http://ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&amp;ASIN=0321486811&amp;Format=_SL250_&amp;ID=AsinImage&amp;MarketPlace=US&amp;ServiceVersion=20070822&amp;WS=1&amp;tag=russblo0b-20"/></a><img src="http://ir-na.amazon-adsystem.com/e/ir?t=russblo0b-20&amp;l=as2&amp;o=1&amp;a=0321486811" border="0" alt=""/></p>
</li>
</ol>
<p><br/>
By the way, I’m writing a book <strong>“Let’s Build A Web Server: First Steps”</strong> that explains how to write a basic web server from scratch. You can get a feel for the book <a href="http://ruslanspivak.com/lsbaws-part1/" title="Part 1">here</a>, <a href="http://ruslanspivak.com/lsbaws-part2/" title="Part 2">here</a>, and <a href="http://ruslanspivak.com/lsbaws-part3/" title="Part 3">here</a>. Subscribe to the mailing list to get the latest updates about the book and the release date.</p>
<p>


</p>



<p><br/>
<strong>All articles in this series:</strong></p>

            </div>
            
    </div></body></html>