<html><body><div><div class="content-body" itemprop="text articleBody">
	<div class="section" id="introduction">
<h2>Introduction</h2>
<p>The purpose of this article is to show some common Excel tasks and how
you would execute similar tasks in <a class="reference external" href="http://pandas.pydata.org/">pandas</a>. Some of the examples are somewhat trivial
but I think it is important to show the simple as well as the more
complex functions you can find elsewhere. As an added bonus, I’m going to do some fuzzy string
matching to show a little twist to the process and show how pandas can
utilize the full python system of modules to do something simply in
python that would be complex in Excel.</p>
<p>Make sense? Let’s get started.</p>
</div>
<div class="section" id="adding-a-sum-to-a-row">
<h2>Adding a Sum to a Row</h2>
<p>The first task I’ll cover is summing some columns to add a total column.</p>
<p>We will start by importing our <a class="reference external" href="http://pbpython.com/extras/excel-comp-data.xlsx">excel data</a> into a pandas dataframe.</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s">"excel-comp-data.xlsx"</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
<div>
<table border="1" class="table table-condensed">
<thead>
<tr>
<th/>
<th>account</th>
<th>name</th>
<th>street</th>
<th>city</th>
<th>state</th>
<th>postal-code</th>
<th>Jan</th>
<th>Feb</th>
<th>Mar</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td> 211829</td>
<td>  Kerluke, Koepp and Hilpert</td>
<td>                   34456 Sean Highway</td>
<td>      New Jaycob</td>
<td>         Texas</td>
<td> 28752</td>
<td>  10000</td>
<td>  62000</td>
<td> 35000</td>
</tr>
<tr>
<th>1</th>
<td> 320563</td>
<td>              Walter-Trantow</td>
<td>                    1311 Alvis Tunnel</td>
<td>   Port Khadijah</td>
<td> NorthCarolina</td>
<td> 38365</td>
<td>  95000</td>
<td>  45000</td>
<td> 35000</td>
</tr>
<tr>
<th>2</th>
<td> 648336</td>
<td>  Bashirian, Kunde and Price</td>
<td> 62184 Schamberger Underpass Apt. 231</td>
<td>  New Lilianland</td>
<td>          Iowa</td>
<td> 76517</td>
<td>  91000</td>
<td> 120000</td>
<td> 35000</td>
</tr>
<tr>
<th>3</th>
<td> 109996</td>
<td> D’Amore, Gleichner and Bode</td>
<td>          155 Fadel Crescent Apt. 144</td>
<td>      Hyattburgh</td>
<td>         Maine</td>
<td> 46021</td>
<td>  45000</td>
<td> 120000</td>
<td> 10000</td>
</tr>
<tr>
<th>4</th>
<td> 121213</td>
<td>               Bauch-Goldner</td>
<td>                  7274 Marissa Common</td>
<td> Shanahanchester</td>
<td>    California</td>
<td> 49681</td>
<td> 162000</td>
<td> 120000</td>
<td> 35000</td>
</tr>
</tbody>
</table>
</div><p>We want to add a total column to show total sales for Jan, Feb and Mar.</p>
<p>This is straightforward in Excel and in pandas. For Excel, I have added the formula <code class="code">
sum(G2:I2)</code>
 in column J.
Here is what it looks like in Excel:</p>

<p>Next, here is how we do it in pandas:</p>
<div class="highlight"><pre><span class="n">df</span><span class="p">[</span><span class="s">"total"</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">"Jan"</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s">"Feb"</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s">"Mar"</span><span class="p">]</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
<div>
<table border="1" class="table table-condensed">
<thead>
<tr>
<th/>
<th>account</th>
<th>name</th>
<th>street</th>
<th>city</th>
<th>state</th>
<th>postal-code</th>
<th>Jan</th>
<th>Feb</th>
<th>Mar</th>
<th>total</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td> 211829</td>
<td>  Kerluke, Koepp and Hilpert</td>
<td>                   34456 Sean Highway</td>
<td>      New Jaycob</td>
<td>         Texas</td>
<td> 28752</td>
<td>  10000</td>
<td>  62000</td>
<td> 35000</td>
<td> 107000</td>
</tr>
<tr>
<th>1</th>
<td> 320563</td>
<td>              Walter-Trantow</td>
<td>                    1311 Alvis Tunnel</td>
<td>   Port Khadijah</td>
<td> NorthCarolina</td>
<td> 38365</td>
<td>  95000</td>
<td>  45000</td>
<td> 35000</td>
<td> 175000</td>
</tr>
<tr>
<th>2</th>
<td> 648336</td>
<td>  Bashirian, Kunde and Price</td>
<td> 62184 Schamberger Underpass Apt. 231</td>
<td>  New Lilianland</td>
<td>          Iowa</td>
<td> 76517</td>
<td>  91000</td>
<td> 120000</td>
<td> 35000</td>
<td> 246000</td>
</tr>
<tr>
<th>3</th>
<td> 109996</td>
<td> D’Amore, Gleichner and Bode</td>
<td>          155 Fadel Crescent Apt. 144</td>
<td>      Hyattburgh</td>
<td>         Maine</td>
<td> 46021</td>
<td>  45000</td>
<td> 120000</td>
<td> 10000</td>
<td> 175000</td>
</tr>
<tr>
<th>4</th>
<td> 121213</td>
<td>               Bauch-Goldner</td>
<td>                  7274 Marissa Common</td>
<td> Shanahanchester</td>
<td>    California</td>
<td> 49681</td>
<td> 162000</td>
<td> 120000</td>
<td> 35000</td>
<td> 317000</td>
</tr>
</tbody>
</table>
</div><p>Next, let’s get some totals and other values for each month. Here is what
we are trying to do as shown in Excel:</p>

<p>As you can see, we added a <code class="code">
SUM(G2:G16)</code>
 in row 17 in each of the columns to get
totals by month.</p>
<p>Performing column level analysis is easy in pandas. Here are a couple of examples.</p>
<div class="highlight"><pre><span class="n">df</span><span class="p">[</span><span class="s">"Jan"</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">df</span><span class="p">[</span><span class="s">"Jan"</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span><span class="n">df</span><span class="p">[</span><span class="s">"Jan"</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">df</span><span class="p">[</span><span class="s">"Jan"</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
<pre class="literal-block">
(1462000, 97466.666666666672, 10000, 162000)
</pre>
<p>Now, we want to add a total by month and grand total. This is where
pandas and Excel diverge a little. It is very simple to add totals in
cells in Excel for each month. Because pandas need to maintain the
integrity of the entire DataFrame, there are a couple more steps.</p>
<p>First, create a sum for the month and total columns.</p>
<div class="highlight"><pre><span class="n">sum_row</span><span class="o">=</span><span class="n">df</span><span class="p">[[</span><span class="s">"Jan"</span><span class="p">,</span><span class="s">"Feb"</span><span class="p">,</span><span class="s">"Mar"</span><span class="p">,</span><span class="s">"total"</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">sum_row</span>
</pre></div>
<pre class="literal-block">
Jan      1462000
Feb      1507000
Mar       717000
total    3686000
dtype: int64
</pre>
<p>This is fairly intuitive however, if you want to add totals as a row,
you need to do some minor manipulations.</p>
<p>We need to transpose the data and convert the Series to a DataFrame so
that it is easier to concat onto our existing data. The <code class="code">
T</code>
 function
allows us to switch the data from being row-based to column-based.</p>
<div class="highlight"><pre><span class="n">df_sum</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">sum_row</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<span class="n">df_sum</span>
</pre></div>
<div>
<table border="1" class="dataframe">
<thead>
<tr>
<th/>
<th>Jan</th>
<th>Feb</th>
<th>Mar</th>
<th>total</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td> 1462000</td>
<td> 1507000</td>
<td> 717000</td>
<td> 3686000</td>
</tr>
</tbody>
</table>
</div><p>The final thing we need to do before adding the totals back is to add
the missing columns. We use <code class="code">
reindex</code>
 to do this for us. The trick is to
add all of our columns and then allow pandas to fill in the values that
are missing.</p>
<div class="highlight"><pre><span class="n">df_sum</span><span class="o">=</span><span class="n">df_sum</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<span class="n">df_sum</span>
</pre></div>
<div>
<table border="1" class="dataframe">
<thead>
<tr>
<th/>
<th>account</th>
<th>name</th>
<th>street</th>
<th>city</th>
<th>state</th>
<th>postal-code</th>
<th>Jan</th>
<th>Feb</th>
<th>Mar</th>
<th>total</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td> 1462000</td>
<td> 1507000</td>
<td> 717000</td>
<td> 3686000</td>
</tr>
</tbody>
</table>
</div><p>Now that we have a nicely formatted DataFrame, we can add it to our
existing one using <code class="code">
append</code>
.</p>
<div class="highlight"><pre><span class="n">df_final</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_sum</span><span class="p">,</span><span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">df_final</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
<div>
<table border="1" class="dataframe">
<thead>
<tr>
<th/>
<th>account</th>
<th>name</th>
<th>street</th>
<th>city</th>
<th>state</th>
<th>postal-code</th>
<th>Jan</th>
<th>Feb</th>
<th>Mar</th>
<th>total</th>
</tr>
</thead>
<tbody>
<tr>
<th>11</th>
<td> 231907</td>
<td>                   Hahn-Moore</td>
<td> 18115 Olivine Throughway</td>
<td>   Norbertomouth</td>
<td> NorthDakota</td>
<td> 31415</td>
<td>  150000</td>
<td>   10000</td>
<td> 162000</td>
<td>  322000</td>
</tr>
<tr>
<th>12</th>
<td> 242368</td>
<td> Frami, Anderson and Donnelly</td>
<td>          182 Bertie Road</td>
<td>     East Davian</td>
<td>        Iowa</td>
<td> 72686</td>
<td>  162000</td>
<td>  120000</td>
<td>  35000</td>
<td>  317000</td>
</tr>
<tr>
<th>13</th>
<td> 268755</td>
<td>                  Walsh-Haley</td>
<td>     2624 Beatty Parkways</td>
<td>    Goodwinmouth</td>
<td> RhodeIsland</td>
<td> 31919</td>
<td>   55000</td>
<td>  120000</td>
<td>  35000</td>
<td>  210000</td>
</tr>
<tr>
<th>14</th>
<td> 273274</td>
<td>                McDermott <span class="caps">PLC</span></td>
<td>    8917 Bergstrom Meadow</td>
<td> Kathryneborough</td>
<td>    Delaware</td>
<td> 27933</td>
<td>  150000</td>
<td>  120000</td>
<td>  70000</td>
<td>  340000</td>
</tr>
<tr>
<th>15</th>
<td>    NaN</td>
<td>                          NaN</td>
<td>                      NaN</td>
<td>             NaN</td>
<td>         NaN</td>
<td>   NaN</td>
<td> 1462000</td>
<td> 1507000</td>
<td> 717000</td>
<td> 3686000</td>
</tr>
</tbody>
</table>
</div></div>
<div class="section" id="additional-data-transforms">
<h2>Additional Data Transforms</h2>
<p>For another example, let’s try to add a state abbreviation to the data set.</p>
<p>From an Excel perspective the easiest way is probably to add a new
column, do a vlookup on the state name and fill in the abbreviation.</p>
<p>I did this and here is a snapshot of what the results looks like:</p>

<p>You’ll notice that after performing the vlookup, there are some values that are not
coming through correctly. That’s because we misspelled some of the
states. Handling this in Excel would be really challenging (on big data sets).</p>
<p>Fortunately with pandas we have the full power of the python ecosystem
at our disposal. In thinking about how to solve this type of messy data problem,
I thought about trying to do some fuzzy text matching to determine the correct value.</p>
<p>Fortunately someone else has done a lot of work in this are. The <a class="reference external" href="http://chairnerd.seatgeek.com/fuzzywuzzy-fuzzy-string-matching-in-python/">fuzzy wuzzy</a> library has some pretty useful
functions for this type of situation. Make sure to get it and install it first.</p>
<p>The other piece of code we need is a state name to abbreviation mapping. Instead of trying to
type it myself, a little googling found this <a class="reference external" href="http://www.cmmichael.com/blog/2006/12/29/state-code-mappings-for-python">code</a>.</p>
<p>Get started by importing the appropriate fuzzywuzzy functions and define our state map dictionary.</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">fuzzywuzzy</span> <span class="kn">import</span> <span class="n">fuzz</span>
<span class="kn">from</span> <span class="nn">fuzzywuzzy</span> <span class="kn">import</span> <span class="n">process</span>
<span class="n">state_to_code</span> <span class="o">=</span> <span class="p">{</span><span class="s">"VERMONT"</span><span class="p">:</span> <span class="s">"VT"</span><span class="p">,</span> <span class="s">"GEORGIA"</span><span class="p">:</span> <span class="s">"GA"</span><span class="p">,</span> <span class="s">"IOWA"</span><span class="p">:</span> <span class="s">"IA"</span><span class="p">,</span> <span class="s">"Armed Forces Pacific"</span><span class="p">:</span> <span class="s">"AP"</span><span class="p">,</span> <span class="s">"GUAM"</span><span class="p">:</span> <span class="s">"GU"</span><span class="p">,</span>
                 <span class="s">"KANSAS"</span><span class="p">:</span> <span class="s">"KS"</span><span class="p">,</span> <span class="s">"FLORIDA"</span><span class="p">:</span> <span class="s">"FL"</span><span class="p">,</span> <span class="s">"AMERICAN SAMOA"</span><span class="p">:</span> <span class="s">"AS"</span><span class="p">,</span> <span class="s">"NORTH CAROLINA"</span><span class="p">:</span> <span class="s">"NC"</span><span class="p">,</span> <span class="s">"HAWAII"</span><span class="p">:</span> <span class="s">"HI"</span><span class="p">,</span>
                 <span class="s">"NEW YORK"</span><span class="p">:</span> <span class="s">"NY"</span><span class="p">,</span> <span class="s">"CALIFORNIA"</span><span class="p">:</span> <span class="s">"CA"</span><span class="p">,</span> <span class="s">"ALABAMA"</span><span class="p">:</span> <span class="s">"AL"</span><span class="p">,</span> <span class="s">"IDAHO"</span><span class="p">:</span> <span class="s">"ID"</span><span class="p">,</span> <span class="s">"FEDERATED STATES OF MICRONESIA"</span><span class="p">:</span> <span class="s">"FM"</span><span class="p">,</span>
                 <span class="s">"Armed Forces Americas"</span><span class="p">:</span> <span class="s">"AA"</span><span class="p">,</span> <span class="s">"DELAWARE"</span><span class="p">:</span> <span class="s">"DE"</span><span class="p">,</span> <span class="s">"ALASKA"</span><span class="p">:</span> <span class="s">"AK"</span><span class="p">,</span> <span class="s">"ILLINOIS"</span><span class="p">:</span> <span class="s">"IL"</span><span class="p">,</span>
                 <span class="s">"Armed Forces Africa"</span><span class="p">:</span> <span class="s">"AE"</span><span class="p">,</span> <span class="s">"SOUTH DAKOTA"</span><span class="p">:</span> <span class="s">"SD"</span><span class="p">,</span> <span class="s">"CONNECTICUT"</span><span class="p">:</span> <span class="s">"CT"</span><span class="p">,</span> <span class="s">"MONTANA"</span><span class="p">:</span> <span class="s">"MT"</span><span class="p">,</span> <span class="s">"MASSACHUSETTS"</span><span class="p">:</span> <span class="s">"MA"</span><span class="p">,</span>
                 <span class="s">"PUERTO RICO"</span><span class="p">:</span> <span class="s">"PR"</span><span class="p">,</span> <span class="s">"Armed Forces Canada"</span><span class="p">:</span> <span class="s">"AE"</span><span class="p">,</span> <span class="s">"NEW HAMPSHIRE"</span><span class="p">:</span> <span class="s">"NH"</span><span class="p">,</span> <span class="s">"MARYLAND"</span><span class="p">:</span> <span class="s">"MD"</span><span class="p">,</span> <span class="s">"NEW MEXICO"</span><span class="p">:</span> <span class="s">"NM"</span><span class="p">,</span>
                 <span class="s">"MISSISSIPPI"</span><span class="p">:</span> <span class="s">"MS"</span><span class="p">,</span> <span class="s">"TENNESSEE"</span><span class="p">:</span> <span class="s">"TN"</span><span class="p">,</span> <span class="s">"PALAU"</span><span class="p">:</span> <span class="s">"PW"</span><span class="p">,</span> <span class="s">"COLORADO"</span><span class="p">:</span> <span class="s">"CO"</span><span class="p">,</span> <span class="s">"Armed Forces Middle East"</span><span class="p">:</span> <span class="s">"AE"</span><span class="p">,</span>
                 <span class="s">"NEW JERSEY"</span><span class="p">:</span> <span class="s">"NJ"</span><span class="p">,</span> <span class="s">"UTAH"</span><span class="p">:</span> <span class="s">"UT"</span><span class="p">,</span> <span class="s">"MICHIGAN"</span><span class="p">:</span> <span class="s">"MI"</span><span class="p">,</span> <span class="s">"WEST VIRGINIA"</span><span class="p">:</span> <span class="s">"WV"</span><span class="p">,</span> <span class="s">"WASHINGTON"</span><span class="p">:</span> <span class="s">"WA"</span><span class="p">,</span>
                 <span class="s">"MINNESOTA"</span><span class="p">:</span> <span class="s">"MN"</span><span class="p">,</span> <span class="s">"OREGON"</span><span class="p">:</span> <span class="s">"OR"</span><span class="p">,</span> <span class="s">"VIRGINIA"</span><span class="p">:</span> <span class="s">"VA"</span><span class="p">,</span> <span class="s">"VIRGIN ISLANDS"</span><span class="p">:</span> <span class="s">"VI"</span><span class="p">,</span> <span class="s">"MARSHALL ISLANDS"</span><span class="p">:</span> <span class="s">"MH"</span><span class="p">,</span>
                 <span class="s">"WYOMING"</span><span class="p">:</span> <span class="s">"WY"</span><span class="p">,</span> <span class="s">"OHIO"</span><span class="p">:</span> <span class="s">"OH"</span><span class="p">,</span> <span class="s">"SOUTH CAROLINA"</span><span class="p">:</span> <span class="s">"SC"</span><span class="p">,</span> <span class="s">"INDIANA"</span><span class="p">:</span> <span class="s">"IN"</span><span class="p">,</span> <span class="s">"NEVADA"</span><span class="p">:</span> <span class="s">"NV"</span><span class="p">,</span> <span class="s">"LOUISIANA"</span><span class="p">:</span> <span class="s">"LA"</span><span class="p">,</span>
                 <span class="s">"NORTHERN MARIANA ISLANDS"</span><span class="p">:</span> <span class="s">"MP"</span><span class="p">,</span> <span class="s">"NEBRASKA"</span><span class="p">:</span> <span class="s">"NE"</span><span class="p">,</span> <span class="s">"ARIZONA"</span><span class="p">:</span> <span class="s">"AZ"</span><span class="p">,</span> <span class="s">"WISCONSIN"</span><span class="p">:</span> <span class="s">"WI"</span><span class="p">,</span> <span class="s">"NORTH DAKOTA"</span><span class="p">:</span> <span class="s">"ND"</span><span class="p">,</span>
                 <span class="s">"Armed Forces Europe"</span><span class="p">:</span> <span class="s">"AE"</span><span class="p">,</span> <span class="s">"PENNSYLVANIA"</span><span class="p">:</span> <span class="s">"PA"</span><span class="p">,</span> <span class="s">"OKLAHOMA"</span><span class="p">:</span> <span class="s">"OK"</span><span class="p">,</span> <span class="s">"KENTUCKY"</span><span class="p">:</span> <span class="s">"KY"</span><span class="p">,</span> <span class="s">"RHODE ISLAND"</span><span class="p">:</span> <span class="s">"RI"</span><span class="p">,</span>
                 <span class="s">"DISTRICT OF COLUMBIA"</span><span class="p">:</span> <span class="s">"DC"</span><span class="p">,</span> <span class="s">"ARKANSAS"</span><span class="p">:</span> <span class="s">"AR"</span><span class="p">,</span> <span class="s">"MISSOURI"</span><span class="p">:</span> <span class="s">"MO"</span><span class="p">,</span> <span class="s">"TEXAS"</span><span class="p">:</span> <span class="s">"TX"</span><span class="p">,</span> <span class="s">"MAINE"</span><span class="p">:</span> <span class="s">"ME"</span><span class="p">}</span>
</pre></div>
<p>Here are some example of how the fuzzy text matching function works.</p>
<div class="highlight"><pre><span class="n">process</span><span class="o">.</span><span class="n">extractOne</span><span class="p">(</span><span class="s">"Minnesotta"</span><span class="p">,</span><span class="n">choices</span><span class="o">=</span><span class="n">state_to_code</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</pre></div>
<pre class="literal-block">
('MINNESOTA', 95)
</pre>
<div class="highlight"><pre><span class="n">process</span><span class="o">.</span><span class="n">extractOne</span><span class="p">(</span><span class="s">"AlaBAMMazzz"</span><span class="p">,</span><span class="n">choices</span><span class="o">=</span><span class="n">state_to_code</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span><span class="n">score_cutoff</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
</pre></div>
<p>Now that we know how this works, we create our function to take the state column and convert it to a valid
abbreviation. We use the 80 score_cutoff for this data. You can play
with it to see what number works for your data. You’ll notice that we either return a valid
abbreviation or an <code class="code">
np.nan</code>
 so that we have some valid values in the field.</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">convert_state</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">abbrev</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">extractOne</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s">"state"</span><span class="p">],</span><span class="n">choices</span><span class="o">=</span><span class="n">state_to_code</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span><span class="n">score_cutoff</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">abbrev</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">state_to_code</span><span class="p">[</span><span class="n">abbrev</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</pre></div>
<p>Add the column in the location we want and fill it with NaN values</p>
<div class="highlight"><pre><span class="n">df_final</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">"abbrev"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="n">df_final</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
<div>
<table border="1" class="table table-condensed">
<thead>
<tr>
<th/>
<th>account</th>
<th>name</th>
<th>street</th>
<th>city</th>
<th>state</th>
<th>postal-code</th>
<th>abbrev</th>
<th>Jan</th>
<th>Feb</th>
<th>Mar</th>
<th>total</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td> 211829</td>
<td>  Kerluke, Koepp and Hilpert</td>
<td>                   34456 Sean Highway</td>
<td>      New Jaycob</td>
<td>         Texas</td>
<td> 28752</td>
<td>NaN</td>
<td>  10000</td>
<td>  62000</td>
<td> 35000</td>
<td> 107000</td>
</tr>
<tr>
<th>1</th>
<td> 320563</td>
<td>              Walter-Trantow</td>
<td>                    1311 Alvis Tunnel</td>
<td>   Port Khadijah</td>
<td> NorthCarolina</td>
<td> 38365</td>
<td>NaN</td>
<td>  95000</td>
<td>  45000</td>
<td> 35000</td>
<td> 175000</td>
</tr>
<tr>
<th>2</th>
<td> 648336</td>
<td>  Bashirian, Kunde and Price</td>
<td> 62184 Schamberger Underpass Apt. 231</td>
<td>  New Lilianland</td>
<td>          Iowa</td>
<td> 76517</td>
<td>NaN</td>
<td>  91000</td>
<td> 120000</td>
<td> 35000</td>
<td> 246000</td>
</tr>
<tr>
<th>3</th>
<td> 109996</td>
<td> D’Amore, Gleichner and Bode</td>
<td>          155 Fadel Crescent Apt. 144</td>
<td>      Hyattburgh</td>
<td>         Maine</td>
<td> 46021</td>
<td>NaN</td>
<td>  45000</td>
<td> 120000</td>
<td> 10000</td>
<td> 175000</td>
</tr>
<tr>
<th>4</th>
<td> 121213</td>
<td>               Bauch-Goldner</td>
<td>                  7274 Marissa Common</td>
<td> Shanahanchester</td>
<td>    California</td>
<td> 49681</td>
<td>NaN</td>
<td> 162000</td>
<td> 120000</td>
<td> 35000</td>
<td> 317000</td>
</tr>
</tbody>
</table>
</div><p>We use <code class="code">
apply</code>
 to add the abbreviations into the approriate column.</p>
<div class="highlight"><pre><span class="n">df_final</span><span class="p">[</span><span class="s">'abbrev'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_final</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">convert_state</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df_final</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
<div>
<table border="1" class="table table-condensed">
<thead>
<tr>
<th/>
<th>account</th>
<th>name</th>
<th>street</th>
<th>city</th>
<th>state</th>
<th>postal-code</th>
<th>abbrev</th>
<th>Jan</th>
<th>Feb</th>
<th>Mar</th>
<th>total</th>
</tr>
</thead>
<tbody>
<tr>
<th>11</th>
<td> 231907</td>
<td>                   Hahn-Moore</td>
<td> 18115 Olivine Throughway</td>
<td>   Norbertomouth</td>
<td> NorthDakota</td>
<td> 31415</td>
<td> <span class="caps">ND</span></td>
<td>  150000</td>
<td>   10000</td>
<td> 162000</td>
<td>  322000</td>
</tr>
<tr>
<th>12</th>
<td> 242368</td>
<td> Frami, Anderson and Donnelly</td>
<td>          182 Bertie Road</td>
<td>     East Davian</td>
<td>        Iowa</td>
<td> 72686</td>
<td> <span class="caps">IA</span></td>
<td>  162000</td>
<td>  120000</td>
<td>  35000</td>
<td>  317000</td>
</tr>
<tr>
<th>13</th>
<td> 268755</td>
<td>                  Walsh-Haley</td>
<td>     2624 Beatty Parkways</td>
<td>    Goodwinmouth</td>
<td> RhodeIsland</td>
<td> 31919</td>
<td> <span class="caps">RI</span></td>
<td>   55000</td>
<td>  120000</td>
<td>  35000</td>
<td>  210000</td>
</tr>
<tr>
<th>14</th>
<td> 273274</td>
<td>                McDermott <span class="caps">PLC</span></td>
<td>    8917 Bergstrom Meadow</td>
<td> Kathryneborough</td>
<td>    Delaware</td>
<td> 27933</td>
<td> <span class="caps">DE</span></td>
<td>  150000</td>
<td>  120000</td>
<td>  70000</td>
<td>  340000</td>
</tr>
<tr>
<th>15</th>
<td>    NaN</td>
<td>                          NaN</td>
<td>                      NaN</td>
<td>             NaN</td>
<td>         NaN</td>
<td>   NaN</td>
<td> NaN</td>
<td> 1462000</td>
<td> 1507000</td>
<td> 717000</td>
<td> 3686000</td>
</tr>
</tbody>
</table>
</div><p>I think this is pretty cool. We have developed a very simple process to intelligently clean up
this data. Obviously when you only have 15 or so rows, this is not a big deal. However, what if you had
15,000? You would have to do something manual in Excel to clean this up.</p>
</div>
<div class="section" id="subtotals">
<h2>Subtotals</h2>
<p>For the final section of this article, let’s get some subtotals by state.</p>
<p>In Excel, we would use the <code class="code">
subtotal</code>
 tool to do this for us.</p>

<p>The output would look like this:</p>

<p>Creating a subtotal in pandas, is accomplished using <code class="code">
groupby</code>
</p>
<div class="highlight"><pre><span class="n">df_sub</span><span class="o">=</span><span class="n">df_final</span><span class="p">[[</span><span class="s">"abbrev"</span><span class="p">,</span><span class="s">"Jan"</span><span class="p">,</span><span class="s">"Feb"</span><span class="p">,</span><span class="s">"Mar"</span><span class="p">,</span><span class="s">"total"</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'abbrev'</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">df_sub</span>
</pre></div>
<div>
<table border="1" class="dataframe">
<thead>
<tr>
<th/>
<th>Jan</th>
<th>Feb</th>
<th>Mar</th>
<th>total</th>
</tr>
<tr>
<th>abbrev</th>
<th/>
<th/>
<th/>
<th/>
</tr>
</thead>
<tbody>
<tr>
<th><span class="caps">AR</span></th>
<td> 150000</td>
<td> 120000</td>
<td>  35000</td>
<td> 305000</td>
</tr>
<tr>
<th><span class="caps">CA</span></th>
<td> 162000</td>
<td> 120000</td>
<td>  35000</td>
<td> 317000</td>
</tr>
<tr>
<th><span class="caps">DE</span></th>
<td> 150000</td>
<td> 120000</td>
<td>  70000</td>
<td> 340000</td>
</tr>
<tr>
<th><span class="caps">IA</span></th>
<td> 253000</td>
<td> 240000</td>
<td>  70000</td>
<td> 563000</td>
</tr>
<tr>
<th><span class="caps">ID</span></th>
<td>  70000</td>
<td> 120000</td>
<td>  35000</td>
<td> 225000</td>
</tr>
<tr>
<th><span class="caps">ME</span></th>
<td>  45000</td>
<td> 120000</td>
<td>  10000</td>
<td> 175000</td>
</tr>
<tr>
<th><span class="caps">MS</span></th>
<td>  62000</td>
<td> 120000</td>
<td>  70000</td>
<td> 252000</td>
</tr>
<tr>
<th><span class="caps">NC</span></th>
<td>  95000</td>
<td>  45000</td>
<td>  35000</td>
<td> 175000</td>
</tr>
<tr>
<th><span class="caps">ND</span></th>
<td> 150000</td>
<td>  10000</td>
<td> 162000</td>
<td> 322000</td>
</tr>
<tr>
<th><span class="caps">PA</span></th>
<td>  70000</td>
<td>  95000</td>
<td>  35000</td>
<td> 200000</td>
</tr>
<tr>
<th><span class="caps">RI</span></th>
<td> 200000</td>
<td> 215000</td>
<td>  70000</td>
<td> 485000</td>
</tr>
<tr>
<th><span class="caps">TN</span></th>
<td>  45000</td>
<td> 120000</td>
<td>  55000</td>
<td> 220000</td>
</tr>
<tr>
<th><span class="caps">TX</span></th>
<td>  10000</td>
<td>  62000</td>
<td>  35000</td>
<td> 107000</td>
</tr>
</tbody>
</table>
</div><p>Next, we want to format the data as currency by using <code class="code">
applymap</code>
 to all the values in the
data frame.</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">money</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">"${:,.0f}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">formatted_df</span> <span class="o">=</span> <span class="n">df_sub</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="n">money</span><span class="p">)</span>
<span class="n">formatted_df</span>
</pre></div>
<div>
<table border="1" class="dataframe">
<thead>
<tr>
<th/>
<th>Jan</th>
<th>Feb</th>
<th>Mar</th>
<th>total</th>
</tr>
<tr>
<th>abbrev</th>
<th/>
<th/>
<th/>
<th/>
</tr>
</thead>
<tbody>
<tr>
<th><span class="caps">AR</span></th>
<td> $150,000</td>
<td> $120,000</td>
<td>  $35,000</td>
<td> $305,000</td>
</tr>
<tr>
<th><span class="caps">CA</span></th>
<td> $162,000</td>
<td> $120,000</td>
<td>  $35,000</td>
<td> $317,000</td>
</tr>
<tr>
<th><span class="caps">DE</span></th>
<td> $150,000</td>
<td> $120,000</td>
<td>  $70,000</td>
<td> $340,000</td>
</tr>
<tr>
<th><span class="caps">IA</span></th>
<td> $253,000</td>
<td> $240,000</td>
<td>  $70,000</td>
<td> $563,000</td>
</tr>
<tr>
<th><span class="caps">ID</span></th>
<td>  $70,000</td>
<td> $120,000</td>
<td>  $35,000</td>
<td> $225,000</td>
</tr>
<tr>
<th><span class="caps">ME</span></th>
<td>  $45,000</td>
<td> $120,000</td>
<td>  $10,000</td>
<td> $175,000</td>
</tr>
<tr>
<th><span class="caps">MS</span></th>
<td>  $62,000</td>
<td> $120,000</td>
<td>  $70,000</td>
<td> $252,000</td>
</tr>
<tr>
<th><span class="caps">NC</span></th>
<td>  $95,000</td>
<td>  $45,000</td>
<td>  $35,000</td>
<td> $175,000</td>
</tr>
<tr>
<th><span class="caps">ND</span></th>
<td> $150,000</td>
<td>  $10,000</td>
<td> $162,000</td>
<td> $322,000</td>
</tr>
<tr>
<th><span class="caps">PA</span></th>
<td>  $70,000</td>
<td>  $95,000</td>
<td>  $35,000</td>
<td> $200,000</td>
</tr>
<tr>
<th><span class="caps">RI</span></th>
<td> $200,000</td>
<td> $215,000</td>
<td>  $70,000</td>
<td> $485,000</td>
</tr>
<tr>
<th><span class="caps">TN</span></th>
<td>  $45,000</td>
<td> $120,000</td>
<td>  $55,000</td>
<td> $220,000</td>
</tr>
<tr>
<th><span class="caps">TX</span></th>
<td>  $10,000</td>
<td>  $62,000</td>
<td>  $35,000</td>
<td> $107,000</td>
</tr>
</tbody>
</table>
</div><p>The formatting looks good, now we can get the totals like we did earlier.</p>
<div class="highlight"><pre><span class="n">sum_row</span><span class="o">=</span><span class="n">df_sub</span><span class="p">[[</span><span class="s">"Jan"</span><span class="p">,</span><span class="s">"Feb"</span><span class="p">,</span><span class="s">"Mar"</span><span class="p">,</span><span class="s">"total"</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">sum_row</span>
</pre></div>
<pre class="literal-block">
Jan      1462000
Feb      1507000
Mar       717000
total    3686000
dtype: int64
</pre>
<p>Convert the values to columns and format it.</p>
<div class="highlight"><pre><span class="n">df_sub_sum</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">sum_row</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<span class="n">df_sub_sum</span><span class="o">=</span><span class="n">df_sub_sum</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="n">money</span><span class="p">)</span>
<span class="n">df_sub_sum</span>
</pre></div>
<div>
<table border="1" class="dataframe">
<thead>
<tr>
<th/>
<th>Jan</th>
<th>Feb</th>
<th>Mar</th>
<th>total</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td> $1,462,000</td>
<td> $1,507,000</td>
<td> $717,000</td>
<td> $3,686,000</td>
</tr>
</tbody>
</table>
</div><p>Finally, add the total value to the DataFrame.</p>
<div class="highlight"><pre><span class="n">final_table</span> <span class="o">=</span> <span class="n">formatted_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_sub_sum</span><span class="p">)</span>
<span class="n">final_table</span>
</pre></div>
<div>
<table border="1" class="dataframe">
<thead>
<tr>
<th/>
<th>Jan</th>
<th>Feb</th>
<th>Mar</th>
<th>total</th>
</tr>
</thead>
<tbody>
<tr>
<th><span class="caps">AR</span></th>
<td>   $150,000</td>
<td>   $120,000</td>
<td>  $35,000</td>
<td>   $305,000</td>
</tr>
<tr>
<th><span class="caps">CA</span></th>
<td>   $162,000</td>
<td>   $120,000</td>
<td>  $35,000</td>
<td>   $317,000</td>
</tr>
<tr>
<th><span class="caps">DE</span></th>
<td>   $150,000</td>
<td>   $120,000</td>
<td>  $70,000</td>
<td>   $340,000</td>
</tr>
<tr>
<th><span class="caps">IA</span></th>
<td>   $253,000</td>
<td>   $240,000</td>
<td>  $70,000</td>
<td>   $563,000</td>
</tr>
<tr>
<th><span class="caps">ID</span></th>
<td>    $70,000</td>
<td>   $120,000</td>
<td>  $35,000</td>
<td>   $225,000</td>
</tr>
<tr>
<th><span class="caps">ME</span></th>
<td>    $45,000</td>
<td>   $120,000</td>
<td>  $10,000</td>
<td>   $175,000</td>
</tr>
<tr>
<th><span class="caps">MS</span></th>
<td>    $62,000</td>
<td>   $120,000</td>
<td>  $70,000</td>
<td>   $252,000</td>
</tr>
<tr>
<th><span class="caps">NC</span></th>
<td>    $95,000</td>
<td>    $45,000</td>
<td>  $35,000</td>
<td>   $175,000</td>
</tr>
<tr>
<th><span class="caps">ND</span></th>
<td>   $150,000</td>
<td>    $10,000</td>
<td> $162,000</td>
<td>   $322,000</td>
</tr>
<tr>
<th><span class="caps">PA</span></th>
<td>    $70,000</td>
<td>    $95,000</td>
<td>  $35,000</td>
<td>   $200,000</td>
</tr>
<tr>
<th><span class="caps">RI</span></th>
<td>   $200,000</td>
<td>   $215,000</td>
<td>  $70,000</td>
<td>   $485,000</td>
</tr>
<tr>
<th><span class="caps">TN</span></th>
<td>    $45,000</td>
<td>   $120,000</td>
<td>  $55,000</td>
<td>   $220,000</td>
</tr>
<tr>
<th><span class="caps">TX</span></th>
<td>    $10,000</td>
<td>    $62,000</td>
<td>  $35,000</td>
<td>   $107,000</td>
</tr>
<tr>
<th>0</th>
<td> $1,462,000</td>
<td> $1,507,000</td>
<td> $717,000</td>
<td> $3,686,000</td>
</tr>
</tbody>
</table>
</div><p>You’ll notice that the index is ‘0’ for the total line. We want to change
that using <code class="code">
rename</code>
.</p>
<div class="highlight"><pre><span class="n">final_table</span> <span class="o">=</span> <span class="n">final_table</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="s">"Total"</span><span class="p">})</span>
<span class="n">final_table</span>
</pre></div>
<div>
<table border="1" class="dataframe">
<thead>
<tr>
<th/>
<th>Jan</th>
<th>Feb</th>
<th>Mar</th>
<th>total</th>
</tr>
</thead>
<tbody>
<tr>
<th><span class="caps">AR</span></th>
<td>   $150,000</td>
<td>   $120,000</td>
<td>  $35,000</td>
<td>   $305,000</td>
</tr>
<tr>
<th><span class="caps">CA</span></th>
<td>   $162,000</td>
<td>   $120,000</td>
<td>  $35,000</td>
<td>   $317,000</td>
</tr>
<tr>
<th><span class="caps">DE</span></th>
<td>   $150,000</td>
<td>   $120,000</td>
<td>  $70,000</td>
<td>   $340,000</td>
</tr>
<tr>
<th><span class="caps">IA</span></th>
<td>   $253,000</td>
<td>   $240,000</td>
<td>  $70,000</td>
<td>   $563,000</td>
</tr>
<tr>
<th><span class="caps">ID</span></th>
<td>    $70,000</td>
<td>   $120,000</td>
<td>  $35,000</td>
<td>   $225,000</td>
</tr>
<tr>
<th><span class="caps">ME</span></th>
<td>    $45,000</td>
<td>   $120,000</td>
<td>  $10,000</td>
<td>   $175,000</td>
</tr>
<tr>
<th><span class="caps">MS</span></th>
<td>    $62,000</td>
<td>   $120,000</td>
<td>  $70,000</td>
<td>   $252,000</td>
</tr>
<tr>
<th><span class="caps">NC</span></th>
<td>    $95,000</td>
<td>    $45,000</td>
<td>  $35,000</td>
<td>   $175,000</td>
</tr>
<tr>
<th><span class="caps">ND</span></th>
<td>   $150,000</td>
<td>    $10,000</td>
<td> $162,000</td>
<td>   $322,000</td>
</tr>
<tr>
<th><span class="caps">PA</span></th>
<td>    $70,000</td>
<td>    $95,000</td>
<td>  $35,000</td>
<td>   $200,000</td>
</tr>
<tr>
<th><span class="caps">RI</span></th>
<td>   $200,000</td>
<td>   $215,000</td>
<td>  $70,000</td>
<td>   $485,000</td>
</tr>
<tr>
<th><span class="caps">TN</span></th>
<td>    $45,000</td>
<td>   $120,000</td>
<td>  $55,000</td>
<td>   $220,000</td>
</tr>
<tr>
<th><span class="caps">TX</span></th>
<td>    $10,000</td>
<td>    $62,000</td>
<td>  $35,000</td>
<td>   $107,000</td>
</tr>
<tr>
<th>Total</th>
<td> $1,462,000</td>
<td> $1,507,000</td>
<td> $717,000</td>
<td> $3,686,000</td>
</tr>
</tbody>
</table>
</div></div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>By now, most people know that pandas can do a lot of complex
manipulations on data - similar to Excel. As I have been learning about
pandas, I still find myself trying to remember how to do things that I
know how to do in Excel but not in pandas. I realize that this
comparison may not be exactly fair - they are different tools. However,
I hope to reach people that know Excel and want to learn what
alternatives are out there for their data processing needs. I hope
these examples will help others feel confident that they can replace a lot
of their crufty Excel data manipulations with pandas.</p>
<p>I found this exercise helpful to cement these ideas in my mind. I hope it works
for you as well. If you have other Excel tasks that you would like to learn how
to do in pandas, let me know via the comments below and I will try to help.</p>
</div>

  </div>
  
</div></body></html>