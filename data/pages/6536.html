<html><body><div><article class="markdown-body entry-content" itemprop="text"><h1><a id="user-content-minimal-docker-python-setup" class="anchor" href="#minimal-docker-python-setup" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Minimal Docker Python setup</h1>

<p>A demo of a minimal Nginx-uWSGI-Flask-Redis stack using Docker. The app 
counts amount of visits per IP and stores it in Redis before returning
it to the client.</p>

<p>Setup consists of 3 containers:</p>

<ul>
<li>Nginx</li>
<li>uWSGI, Flask app </li>
<li>Redis</li>
</ul>

<p>The whole setup runs with using less then 45 mb of disk space!</p>

<p><a href="/OrangeTux/minimal-docker-python-setup/blob/master/docker_images.png" target="_blank"><img src="/OrangeTux/minimal-docker-python-setup/raw/master/docker_images.png" alt="Image showing size of both containers." title="Size of images."/></a></p>

<h2><a id="user-content-quickstart" class="anchor" href="#quickstart" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Quickstart</h2>

<p>Create images with Nginx and Redis from the tarred filesystem:</p>

<div class="highlight highlight-source-shell"><pre>user@host $ docker import - orangetux/nginx <span class="pl-k">&lt;</span> nginx/rootfs.tar
user@host $ docker import - orangetux/redis <span class="pl-k">&lt;</span> redis/rootfs.tar</pre></div>

<p>Now build the other images and run them by using <code>docker-compose</code>:</p>

<div class="highlight highlight-source-shell"><pre>user@host $ docker-compose build
user@host $ docker-compose up</pre></div>

<p>And head over <code>http://localhost:1337</code> and you should see an IP address.</p>

<h2><a id="user-content-uwsgi-and-flask" class="anchor" href="#uwsgi-and-flask" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>uWSGI and Flask</h2>

<p>uWSGI and the Flask app are running from a custom image based on
<a href="https://hub.docker.com/r/advancedclimatesystems/python/">advancedclimatesystems/python:2.7.10</a>. The Dockerfile for this
image can be found <a href="https://github.com/OrangeTux/minimal-docker-python-setup/blob/master/app/Dockerfile">here</a>. See 
'Installing C extensions' for more information about how 
<code>uWSGI</code> is installed.</p>

<h2><a id="user-content-nginx" class="anchor" href="#nginx" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Nginx</h2>

<p>Nginx runs from an image which is based on a small filesystem. This filesystem
is built with <a href="https://github.com/AdvancedClimateSystems/docker-buildroot">Buildroot</a>. You can build the filesystem using the
supplied <a href="/OrangeTux/minimal-docker-python-setup/blob/master/nginx/docker_nginx_defconfig">defconfig</a>.</p>

<h2><a id="user-content-redis" class="anchor" href="#redis" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Redis</h2>

<p>Like Nginx, Redis runs from an very small, custom crafted Docker image. To
build the filesystem which this image is based on, use
<a href="/OrangeTux/minimal-docker-python-setup/blob/master/redis/docker_redis_defconfig">docker_redis_defconfig</a>.</p>

<h2><a id="user-content-installing-c-extensions" class="anchor" href="#installing-c-extensions" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Installing C extensions</h2>

<h3><a id="user-content-wheel" class="anchor" href="#wheel" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Wheel</h3>

<p>Installation of Python dependencies is done in 2 steps. First the dependency is
built. Compiling a C extension is one of the steps during this stage. After
building the depedency is installed. This step does't do much more than copying
files produced by the build phase to their correct location.</p>

<p>The Python image doesn't contain a C compiler. For pure Python dependencies
this is not a problem, but C extensions can't be built inside the image. These
dependencies must be built on the host before they can be installed inside the image.</p>

<p>Dependencies can be built using <a href="http://wheel.readthedocs.org/en/latest/">Wheel</a>: a built-package format for
Python. All required wheels are supplied and can be found at
<a href="/OrangeTux/minimal-docker-python-setup/blob/master/app/wheelhouse">app/wheelhouse</a>, but if you want to build the wheels yourself run
the following command. It requires pip, wheel and setuptools &gt;= 0.8.0.</p>

<div class="highlight highlight-source-shell"><pre>user@host $ pip wheel --wheel-dir=wheelhouse flask flask-redis uwsgi </pre></div>

<p>Installing depedencies from wheels is now simple:</p>

<div class="highlight highlight-source-shell"><pre>root@container <span class="pl-c"># pip install --find-links wheelhouse flask flask-redis uwsgi</span></pre></div>

<h3><a id="user-content-shared-libraries" class="anchor" href="#shared-libraries" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Shared libraries</h3>

<p><code>uWSGI</code> relies on a few shared libraries which are not all available in the
image. They need to be added. If you run <code>uWSGI</code> without supplying all
missing shared libraries you'll see see something like this:</p>

<div class="highlight highlight-source-shell"><pre>root@container <span class="pl-c"># uwsgi</span>
uwsgi: error <span class="pl-k">while</span> loading shared libraries: libpcre.so.3: cannot open shared object file: No such file or directory</pre></div>

<p>If you add this library to the Docker image and run <code>uwsgi</code> you'll find out
that another depedency is missing. The following shared libraries must be added
before <code>uWSGI</code> is able to run:</p>

<ul>
<li>liblzma.so.5<br/></li>
<li>libpcre.so.3<br/></li>
<li>libxml2.so.2</li>
</ul>

<p>These libraries are included in the repository and located at
<a href="/OrangeTux/minimal-docker-python-setup/blob/master/app/shared_libs">app/shared_libs</a>. But they can be copied from any x86_64 machine
to <code>/lib/</code> in the image. To locate them, use <code>ldd</code>:</p>

<div class="highlight highlight-source-shell"><pre>user@host $ ldd uwsgi <span class="pl-k">|</span> grep -e lzma -e xml -e pcre
libpcre.so.3 =<span class="pl-k">&gt;</span> /lib/x86_64-linux-gnu/libpcre.so.3 (0x00007f2ad8b91000)
libxml2.so.2 =<span class="pl-k">&gt;</span> /usr/lib/x86_64-linux-gnu/libxml2.so.2 (0x00007f2ad81d7000)
liblzma.so.5 =<span class="pl-k">&gt;</span> /lib/x86_64-linux-gnu/liblzma.so.5 (0x00007f2ad72ed000)</pre></div>

<h2><a id="user-content-demo" class="anchor" href="#demo" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Demo</h2>

<p><a href="https://asciinema.org/a/26061"><img src="https://camo.githubusercontent.com/0c3fc640482786e8d70088bdc7e09c4ac9b6b822/68747470733a2f2f61736369696e656d612e6f72672f612f32363036312e706e67" alt="asciicast" data-canonical-src="https://asciinema.org/a/26061.png"/></a></p>

<h2><a id="user-content-license" class="anchor" href="#license" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>License</h2>

<p>This software is licensed under the <a href="/OrangeTux/minimal-docker-python-setup/blob/master/LICENSE">MIT license</a>.</p>

<p>© 2015 Auke Willem Oosterhoff</p>
</article>
  </div></body></html>