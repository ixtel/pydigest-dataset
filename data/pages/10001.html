<html><body><div><div class="col-xs-12 single-content">
                <p class="meta">
                    
                    <i class="fa fa-bookmark"/> 2 февраля 2016 г.
                    <i class="link-spacer"/>
                    
                        <a href="/tag/django/">Django</a>
                        
                        <i class="link-spacer"/>
                        
                    
                        <a href="/tag/python/">Python</a>
                        
                        <i class="link-spacer"/>
                        
                    
                        <a href="/tag/uwsgi/">uWSGI</a>
                        
                    
                    
                </p>

                <h1>Django. Запуск проекта в связке uWSGI и Nginx</h1>
                

                <p><img src="http://adw0rd.com/media/uploads/logo_uWSGI.png" class="alignright"/>
Очень часто меня просят рассказать как запустить django-проект в продакшен. Я обычно кидаю несколько конфигов со своих проектов и пишу как все установить и запустить. В 2012-ом начал писать эту статью, но как и многие другие мои статьи она попала в бездну прокрастинации.</p>

<p>Пришло время дописать эту статью, чтобы больше не объяснять всем и каждому почему и как запустить проект на Django под uWSGI.</p>

<p><a name="more"/></p>

<h3>Почему uWSGI?</h3>

<p>Вкратце, он стабильный, гибкий в настройке и работает довольно быстро. По крайне мере, в большинстве бенчмарков, что я смотрел в своё время, он был быстрее его конкурентов. Например, в сравнении с Gunicorn:</p>

<p><a href="https://ivan-site.com/2012/09/benchmark-uwsgi-vs-gunicorn-for-async-workers/"><img src="http://adw0rd.com/media/uploads/pong_results.png"/></a></p>

<p>Гуглятся результаты тестов производительности довольно быстро, так что оставлю за вами выбор источников информации. Либо можете самостоятельно написать тесты и мы вместе позапускаем их :-)</p>

<h3>Настройка uWSGI</h3>

<p>Сначала установим uWSGI в ваше <a href="/2012/6/19/python-virtualenv/">виртуальное окружение</a>:</p>

<pre><pre><code>cd ~/&lt;project_name&gt;
source ~/&lt;venv_path&gt;/bin/activate
pip install uWSGI
</code></pre></pre>

<p>зафиксируем версию в файл зависимостей</p>

<pre><pre><code>pip freeze|grep -i uwsgi &gt;&gt; requirements.txt
</code></pre></pre>

<p>Добавим в проект файл <tt>uwsgi/production.ini</tt> (каталог "uwsgi" нужен, потому что у меня обычно несколько конфигов, например "test.conf" для тестового стенда):</p>

<pre><pre><code>[uwsgi]
chdir=/home/&lt;username&gt;/&lt;project_name&gt;
pidfile=/home/&lt;username&gt;/&lt;project_name&gt;_uwsgi.pid
socket=/home/&lt;username&gt;/&lt;project_name&gt;_uwsgi.sock
chmod-socket=750
virtualenv=/home/&lt;username&gt;/&lt;venv_path&gt;
pythonpath=.
pythonpath=&lt;project_name&gt;
module=&lt;project_name&gt;.wsgi:application
callable=app
master=true
processes=2
harakiri=30
buffer-size=32768
</code></pre></pre>

<p>Разберём опции:</p>

<ul>
<li><tt>chdir</tt> - путь до каталога с проектом;</li>
<li><tt>pidfile</tt> - путь до pid-файла;</li>
<li><tt>socket</tt> - файл UNIX или TCP сокета, рекомендую UNIX (работает немногим быстрее);</li>
<li><tt>chmod-socket</tt> - права на сокет-файл, позже добавим <strong>nginx</strong> в группу "&lt;usergroup&gt;" пользователя "&lt;username&gt;";</li>
<li><tt>virtualenv</tt> - путь до каталога окружения;</li>
<li><tt>pythonpath=.</tt> - добавим текущий от "chdir" каталог в "sys.path";</li>
<li><tt>pythonpath=&lt;project_name&gt;</tt> - и каталог с кодом Django-проекта тоже;</li>
<li><tt>module</tt> - наш wsgi-модуль (идет в поставке с Django-проектом)</li>
<li><tt>callable</tt> - WSGI имя;</li>
<li><tt>master</tt> - быть master-процессом;</li>
<li><tt>processes</tt> - количество воркеров (процессов), которые будут обрабатывать поступающие реквесты;</li>
<li><tt>harakiri</tt> - количество секунд после которых подвисший процес будет перезапущен; </li>
<li><tt>buffer-size</tt> - максимальный размер буфера реквеста (заголовки, например cookie и query string), не включает в себя размер тела зпроса.</li>
</ul>

<p>Ещё больше опций можете найти в <a href="http://uwsgi-docs.readthedocs.org/en/latest/Options.html">оф. документации</a></p>

<h3>Настройка Nginx</h3>

<p>Если вы еще не установили <strong>Nginx</strong>, то сделайте это:</p>

<pre><pre><code>sudo apt-get install nginx
</code></pre></pre>

<p>Создадим в корне проекта файл <tt>nginx/production.conf</tt>, со следующим содержимым:</p>

<pre><pre><code>server {
    listen 80;
    server_name example.org;

    location /media/ {
        root /home/&lt;username&gt;/&lt;project_name&gt;_storage;
    }
    location /static/ {
        root /home/&lt;username&gt;/&lt;project_name&gt;_storage;
    }
    # Иногда бывает нужно отдавать статику не из хранилища,
    # а прямо из каталога проекта. Но тогда престанет работать админ-панель Django,
    # поэтому надо будет добавить вот такой локейшен:
    # location /static/admin/ {
    #    root /home/&lt;username&gt;/&lt;project_name&gt;_storage;
    # }
    location / {
        uwsgi_pass unix:///home/&lt;username&gt;/&lt;project_name&gt;_uwsgi.sock;
        include uwsgi_params;
    }
}
</code></pre></pre>

<p>для того, чтобы <strong>Nginx</strong> смог работать с файлом uWSGI-сокета добавим его в группу вашего проекта, в Ubuntu это можно сделать так:</p>

<pre><pre><code>sudo usermod -a -G &lt;usergroup&gt; www-data
</code></pre></pre>

<h3>Настройка Supervisor</h3>

<p>Если он у вас ещё не установлен, то это можно сделать так:</p>

<pre><pre><code>sudo apt-get install supervisor
sudo service supervisor start
</code></pre></pre>

<p>Более <a href="http://adw0rd.com/tag/supervisor/">подробно про работу с Supervisor</a> я писал ранее.</p>

<p>На самом деле <strong>uWSGI</strong> может перезапускаться самостоятельно и его не надо контроллировать. Но я предпочитаю чтобы процессы контроллировались внешними утилитами, дабы избежать проблем автономности и всё унифицировать.</p>

<p>Создадим такой конфиг <tt>supervisor/production.conf</tt>:</p>

<pre><pre><code>[program:&lt;project_name&gt;_uwsgi]
environment=PATH="/home/&lt;username&gt;/&lt;venv_path&gt;/bin"
numprocs=1
directory=/home/&lt;username&gt;/&lt;project_name&gt;
command=/home/&lt;username&gt;/&lt;venv_path&gt;/bin/uwsgi uwsgi/production.ini
user=&lt;username&gt;
autostart=true
autorestart=true
redirect_stderr=true
stopwaitsecs=60
stopsignal=INT
stderr_logfile=/home/&lt;username&gt;/logs/%(program_name)s_err.log
stdout_logfile=/home/&lt;username&gt;/logs/%(program_name)s_out.log
stdout_logfile_maxbytes=100MB
stdout_logfile_backups=30
stdout_capture_maxbytes=1MB
</code></pre></pre>

<h3>Запускаем проект</h3>

<p>Создадим для логов каталог в директории пользователя:</p>

<pre><pre><code>mkdir -p /home/&lt;username&gt;/logs
</code></pre></pre>

<p>Сделаем симлинк на конфиг супервайзора нашего проекта, после чего дадим ему знать чтобы он обновился, он запустит по конфигу наш uWSGI-сервис:</p>

<pre><pre><code>sudo ln -s /home/&lt;username&gt;/&lt;project_name&gt;/supervisor/production.conf /etc/supervisor/conf.d/&lt;project_name&gt;.conf
sudo supervisorctl update
sudo supervisorctl status
</code></pre></pre>

<p>После чего сделаем симлинк на Nginx-конфиг и перезапустим его тоже:</p>

<pre><pre><code>sudo ln -s /home/&lt;username&gt;/&lt;project_name&gt;/nginx/production.conf /etc/nginx/sites-enable/&lt;project_name&gt;.conf
sudo nginx -t
sudo nginx -s reload
</code></pre></pre>

<p>Теперь должно работать, српашивайте что непонятно</p>

<h3>Мониторинг и статистика работы uWSGI воркеров</h3>

<p>Чуть позже расскажу про "uwsgi-top". Статья в доработке.</p>



                

            </div>
        </div></body></html>