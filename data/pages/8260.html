<html><body><div><div class="post-text" itemprop="text">

<p>Given a config file as such from the <a href="http://www.statmt.org/moses/" rel="nofollow">Moses Machine Translation Toolkit</a>:</p>

<pre><code>#########################
### MOSES CONFIG FILE ###
#########################

# input factors
[input-factors]
0

# mapping steps
[mapping]
0 T 0

[distortion-limit]
6

# feature functions
[feature]
UnknownWordPenalty
WordPenalty
PhrasePenalty
PhraseDictionaryMemory name=TranslationModel0 num-features=4 path=/home/gillin/jojomert/phrase-jojo/work.src-ref/training/model/phrase-table.gz input-factor=0 output-factor=0
LexicalReordering name=LexicalReordering0 num-features=6 type=wbe-msd-bidirectional-fe-allff input-factor=0 output-factor=0 path=/home/gillin/jojomert/phrase-jojo/work.src-ref/training/model/reordering-table.wbe-msd-bidirectional-fe.gz
Distortion
KENLM lazyken=0 name=LM0 factor=0 path=/home/gillin/jojomert/ru.kenlm order=5

# dense weights for feature functions
[weight]
UnknownWordPenalty0= 1
WordPenalty0= -1
PhrasePenalty0= 0.2
TranslationModel0= 0.2 0.2 0.2 0.2
LexicalReordering0= 0.3 0.3 0.3 0.3 0.3 0.3
Distortion0= 0.3
LM0= 0.5
</code></pre>

<p>I need to read the parameters from the <code>[weights]</code> section:</p>

<pre><code>UnknownWordPenalty0= 1
WordPenalty0= -1
PhrasePenalty0= 0.2
TranslationModel0= 0.2 0.2 0.2 0.2
LexicalReordering0= 0.3 0.3 0.3 0.3 0.3 0.3
Distortion0= 0.3
LM0= 0.5
</code></pre>

<p>I have been doing it as such:</p>

<pre><code>def read_params_from_moses_ini(mosesinifile):
    parameters_string = ""
    for line in reversed(open(mosesinifile, 'r').readlines()):
        if line.startswith('[weight]'):
            return parameters_string
        else:
            parameters_string+=line.strip() + ' ' 
</code></pre>

<p>to get this output: </p>

<pre><code>LM0= 0.5 Distortion0= 0.3 LexicalReordering0= 0.3 0.3 0.3 0.3 0.3 0.3 TranslationModel0= 0.2 0.2 0.2 0.2 PhrasePenalty0= 0.2 WordPenalty0= -1 UnknownWordPenalty0= 1 
</code></pre>

<p>Then using parsing the output with </p>

<pre><code>moses_param_pattern = re.compile(r'''([^\s=]+)=\s*((?:[^\s=]+(?:\s|$))*)''')

def parse_parameters(parameters_string):
    return dict((k, list(map(float, v.split())))
                   for k, v in moses_param_pattern.findall(parameters_string))


 mosesinifile = 'mertfiles/moses.ini'

 print (parse_parameters(read_params_from_moses_ini(mosesinifile)))
</code></pre>

<p>to get:</p>

<pre><code>{'UnknownWordPenalty0': [1.0], 'PhrasePenalty0': [0.2], 'WordPenalty0': [-1.0], 'Distortion0': [0.3], 'LexicalReordering0': [0.3, 0.3, 0.3, 0.3, 0.3, 0.3], 'TranslationModel0': [0.2, 0.2, 0.2, 0.2], 'LM0': [0.5]}
</code></pre>

<p>The current solution involve some crazy reversal line reading from the config file and then pretty complicated regex reading to get the parameters.</p>

<p><strong>Is there a simpler or less hacky/verbose way to read the file and achieve the desired parameter dictionary output?</strong> </p>

<p>Is it possible to change the configparser such that it reads the moses config file? It's pretty hard because it has some erroneous section that are actually parameters, e.g. <code>[distortion-limit]</code> and there's no key to the value <code>6</code>. In a validated configparse-able file, it would have been <code>distortion-limit = 6</code>.</p>

<hr/>

<p><strong>Note:</strong> The native python <code>configparser</code> is unable to handle a <code>moses.ini</code> config file. Answers from <a href="http://stackoverflow.com/questions/8884188/how-to-read-and-write-ini-file-with-python">how to read and write INI file with Python?</a> will not work. </p>
    </div>
    </div></body></html>