<html><body><div><div itemprop="articleBody">
      <p>So you have this Django app. If you are like me and don’t have quite the skills
for a good UI design, you probably stick to
<a href="http://getbootstrap.com/">bootstrap</a>. You know you will have a bunch of forms
and you don’t want to style them yourself. Let’s say, you came to the idea that
<a href="http://django-crispy-forms.rtfd.org">django-crispy-forms</a> fits your needs
perfectly (it definitely fits mine).</p>

<h3 id="how-it-all-began">How it all began</h3>

<p>This is a story about a model <em>Foo</em>.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># fairytale/characters/models.py</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>


<span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="s">"""A magical creature from Foo dynasty"""</span>
    <span class="n">mighty_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">kingdoms_count</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">EmailField</span><span class="p">()</span>  <span class="c"># What? Magical creatures also have emails.</span></code></pre></figure>

<p>Model <em>Foo</em> was lonely, so it summoned a view, a template and a url.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># fairytale/characters/views.py</span>
<span class="kn">from</span> <span class="nn">django.views.generic.edit</span> <span class="kn">import</span> <span class="n">CreateView</span>

<span class="kn">from</span> <span class="nn">characters.models</span> <span class="kn">import</span> <span class="n">Foo</span>


<span class="k">class</span> <span class="nc">CreateFooView</span><span class="p">(</span><span class="n">CreateView</span><span class="p">):</span>
    <span class="s">"""A create view for Foo model"""</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s">"characters/create_foo.html"</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Foo</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-html" data-lang="html"># fairytale/templates/characters/create_foo.html
{% extends "base.html" %}

{% load crispy_forms_tags %}
{% block content %}
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-6"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h1&gt;</span>Create Foo<span class="nt">&lt;/h1&gt;</span>
      <span class="nt">&lt;hr/&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"well"</span><span class="nt">&gt;</span>
        {% crispy form %}
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
{% endblock %}</code></pre></figure>

<p>The <code class="highlighter-rouge">base.html</code> contents are left out, as they include standard HTML markup,
bootstrap stylesheet include and a mandatory template block <code class="highlighter-rouge">content</code> (in our
specific case).</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># fairytale/fairytale/urls.py</span>
<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">url</span>

<span class="kn">from</span> <span class="nn">characters.views</span> <span class="kn">import</span> <span class="n">CreateFooView</span>


<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span>
    <span class="s">''</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^foo/create/$'</span><span class="p">,</span> <span class="n">CreateFooView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">"create_foo"</span><span class="p">),</span>
<span class="p">)</span></code></pre></figure>

<p>And this is what we created so far:</p>

<p><img src="/assets/img/dry-tale/create_form_no_submit.png" alt="Foo form without submit"/></p>

<p>Such cool, right?</p>

<p><img src="/assets/img/dry-tale/doge-meme.jpg" alt="Doge Django meme"/></p>

<p>Oh, wait! Where are the buttons? How do I submit this thing? <em>Foo the Emperor</em>
must live!</p>

<p>Ok, I will need a <em>Cancel</em> anchor tag that will look like a button, because I
want to redirect to some other page, and a <em>Submit</em> input. Easy!</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># fairytale/characters/forms.py</span>
<span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>
<span class="kn">from</span> <span class="nn">crispy_forms.helper</span> <span class="kn">import</span> <span class="n">FormHelper</span>
<span class="kn">from</span> <span class="nn">crispy_forms.layout</span> <span class="kn">import</span> <span class="n">Submit</span><span class="p">,</span> <span class="n">HTML</span>
<span class="kn">from</span> <span class="nn">crispy_forms.bootstrap</span> <span class="kn">import</span> <span class="n">FormActions</span>

<span class="kn">from</span> <span class="nn">characters.models</span> <span class="kn">import</span> <span class="n">Foo</span>


<span class="k">class</span> <span class="nc">FooForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">ModelForm</span><span class="p">):</span>
    <span class="s">"""Model Foo form"""</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Foo</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FooForm</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">helper</span> <span class="o">=</span> <span class="n">FormHelper</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">FormActions</span><span class="p">(</span>
                <span class="n">HTML</span><span class="p">(</span><span class="s">"""&lt;a role="button" class="btn btn-default"
                        href="{</span><span class="si">% </span><span class="s">url "some_cancel_url" </span><span class="si">%</span><span class="s">}"&gt;Cancel&lt;/a&gt;"""</span><span class="p">),</span>
                <span class="n">Submit</span><span class="p">(</span><span class="s">'save'</span><span class="p">,</span> <span class="s">'Submit'</span><span class="p">),</span>
        <span class="p">))</span></code></pre></figure>

<p>Meh, not the prettiest way to achieve what I want, but apparently this is the
only easy and straight-forward way. Also don’t forget to update the view.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># fairytale/characters/views.py</span>
<span class="n">ifrom</span> <span class="n">django</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">generic</span><span class="o">.</span><span class="n">edit</span> <span class="kn">import</span> <span class="nn">CreateView</span>

<span class="kn">from</span> <span class="nn">characters.models</span> <span class="kn">import</span> <span class="n">Foo</span>


<span class="k">class</span> <span class="nc">CreateFooView</span><span class="p">(</span><span class="n">CreateView</span><span class="p">):</span>
    <span class="s">"""A create view for Foo model"""</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s">"characters/create_foo.html"</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">FooForm</span>  <span class="c"># the change is over here</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Foo</span></code></pre></figure>

<p>And so this is what we get:</p>

<p><img src="/assets/img/dry-tale/create_form_with_submit.png" alt="Foo form with submit"/></p>

<p>The lack of space between the anchor tag and the input looks awful, right? This
tiny cosmetic issue was discussed in
<a href="https://github.com/maraujop/django-crispy-forms/issues/62">issue #62</a> and
solved for groups of buttons and inputs. Unfortunately it persists in case of
an input/button and anchor tag with <code class="highlighter-rouge">role="button"</code>. If it’s bugging you, add
some margin by yourself.</p>

<h3 id="the-misfortune">The misfortune</h3>

<p>Life goes on and <em>Foo</em> objects seem to be doing just fine. Until a great misfortune
takes over their destiny. It doesn’t seem like a big deal, since all that
happened was the addition of two more characters: <em>Bar</em> and <em>Baz</em>. What harm
can they potentially cause? Well, let’s see.</p>

<p><em>Bar</em> and <em>Baz</em> follow the same old path <em>Foo</em> did a long time ago:
model/form/view/template/url. The form again will initialize a <code class="highlighter-rouge">FormHelper</code> to
append those 2 elements. It seems like every form will need them (like duhh, how
can I get around the form without them?). And so we copy-pasty, we copy-paste.</p>

<p>And then the pressure of the invisible monster can be felt, crawling under the
skin and whispering to you: “You will do this over and over again. For every
form. And when you will want to change a tiny detail, you will change it for
every form, because you want to stay consistent. That can be the change in the
bootstrap anchor tag interface, class of the <em>Submit</em> input, text of the anchor
tag.”</p>

<p>This is the punishment for the violation of DRY (Don’t Repeat Yourself)
principle.</p>

<p>It’s not too late to fix the situation, until the quicksand doesn’t devour
all the codebase into the abyss of “refactoring is too expensive for us”.</p>

<h3 id="layout-objects-to-the-rescue">Layout objects to the rescue</h3>

<p>At first, it seems like a good idea to use
<a href="http://django-crispy-forms.readthedocs.org/en/latest/layouts.html#composing-layouts">Composing layouts</a>.
We take that chunk of layout and simply store it into a variable somewhere. But
how can we change that <em>Cancel</em> URL? Or maybe we plan to have different input
values for <em>submit</em> input for different forms. There might be several variables
that we would like to keep flexible for a more or less fixed piece of layout.</p>

<p>One of the solutions is to create our own custom <code class="highlighter-rouge">ObjectLayout</code>. It involves a
little bit of <code class="highlighter-rouge">django-crispy-forms</code> internals, but don’t worry, I’m here to
help.</p>

<p>This is where we start from -
<a href="http://django-crispy-forms.readthedocs.org/en/latest/layouts.html#creating-your-own-layout-objects">creating your own layout objects</a>.
As it says in the current section, we investigate the objects that live in
<code class="highlighter-rouge">layout.py</code> and <code class="highlighter-rouge">bootstrap.py</code>. We come up with the following cure for the
misfortune:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># fairytale/common/crispy_forms/bootstrap.py</span>
<span class="kn">from</span> <span class="nn">crispy_forms.bootstrap</span> <span class="kn">import</span> <span class="n">FormActions</span>
<span class="kn">from</span> <span class="nn">crispy_forms.layout</span> <span class="kn">import</span> <span class="n">LayoutObject</span><span class="p">,</span> <span class="n">Submit</span><span class="p">,</span> <span class="n">HTML</span>


<span class="k">class</span> <span class="nc">SubmitCancelFormActions</span><span class="p">(</span><span class="n">LayoutObject</span><span class="p">):</span>
    <span class="s">"""Custom bootstrap layout object. It wraps a Cancel anchor tag and a Submit
    input field in a &lt;div class="form-actions"&gt;.

    Example::

        SubmitCancelFormActions(cancel_href="/some/url/")
    """</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">fields</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cancel_href</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">'cancel_href'</span><span class="p">,</span> <span class="s">'#'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="n">form_style</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">layout_object</span> <span class="o">=</span> <span class="n">FormActions</span><span class="p">(</span>
            <span class="n">HTML</span><span class="p">(</span><span class="s">"""&lt;a role="button" class="btn btn-default" href="{0}"&gt;
                    Cancel&lt;/a&gt;"""</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cancel_href</span><span class="p">)),</span>
            <span class="n">Submit</span><span class="p">(</span><span class="s">'save'</span><span class="p">,</span> <span class="s">'Submit'</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">layout_object</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">form_style</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></code></pre></figure>

<p>In the <code class="highlighter-rouge">__init__</code> we extract all the arguments we are interested in, for example
the URL of the <em>Cancel</em> anchor tag. The <code class="highlighter-rouge">render</code> method produces the HTML string
with all the nodes translated. There is no need to create our own template to be
rendered, since we can reuse <code class="highlighter-rouge">render</code> method provided by the <code class="highlighter-rouge">django-crispy-forms</code>.
It already knows how to translate all those objects we have put together, to plain
HTML.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># fairytale/characters/forms.py</span>
<span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>
<span class="kn">from</span> <span class="nn">crispy_forms.helper</span> <span class="kn">import</span> <span class="n">FormHelper</span>

<span class="kn">from</span> <span class="nn">characters.models</span> <span class="kn">import</span> <span class="n">Foo</span>
<span class="kn">from</span> <span class="nn">common.crispy_forms.bootstrap</span> <span class="kn">import</span> <span class="n">SubmitCancelFormActions</span>


<span class="k">class</span> <span class="nc">FooForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">ModelForm</span><span class="p">):</span>
    <span class="s">"""Model Foo form"""</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Foo</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FooForm</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">helper</span> <span class="o">=</span> <span class="n">FormHelper</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">SubmitCancelFormActions</span><span class="p">(</span>
                <span class="n">cancel_href</span><span class="o">=</span><span class="s">"{</span><span class="si">% </span><span class="s">url 'some_cancel_url' </span><span class="si">%</span><span class="s">}"</span><span class="p">)</span>
        <span class="p">))</span></code></pre></figure>

<p>Maybe it doesn’t seem like a big deal, saves us maybe 2 lines of code in the
form and adds up lots of code some place else. As the monster warned us, the
real danger comes with the growth of objects and forms in number. At some point
it will become much more complicated to make any changes to those form actions.
It is a small enhancement that might save time for future <em>me</em>.</p>

<p>Alright, that looks much better. Both for <em>Foo</em>, <em>Bar</em> and <em>Baz</em>. Oh, and don’t
forget about unittest, otherwise another monster will come to bite your ass.</p>

<p>Let’s see how can we write a unittest for our little layout object. I will
cheat a bit and use some test tools and shortcuts created specifically for
<code class="highlighter-rouge">django-crispy-forms</code>.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># fairytale/common/tests.py</span>
<span class="kn">from</span> <span class="nn">django.template</span> <span class="kn">import</span> <span class="n">loader</span><span class="p">,</span> <span class="n">Context</span>
<span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">TestCase</span>
<span class="kn">from</span> <span class="nn">crispy_forms.tests.forms</span> <span class="kn">import</span> <span class="n">TestForm</span>
<span class="kn">from</span> <span class="nn">crispy_forms.helper</span> <span class="kn">import</span> <span class="n">FormHelper</span>
<span class="kn">from</span> <span class="nn">crispy_forms.layout</span> <span class="kn">import</span> <span class="n">Layout</span>

<span class="kn">from</span> <span class="nn">common.forms.bootstrap</span> <span class="kn">import</span> <span class="n">SubmitCancelFormActions</span>


<span class="k">class</span> <span class="nc">FormLayoutObjectsTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_submit_cancel_form_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Test custom SubmitCancelFormActions bootstrap layout object"""</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_template_from_string</span><span class="p">(</span><span class="s">u"""
            {</span><span class="si">% </span><span class="s">load crispy_forms_tags </span><span class="si">%</span><span class="s">}
            {</span><span class="si">% </span><span class="s">crispy form </span><span class="si">%</span><span class="s">}
        """</span><span class="p">)</span>

        <span class="n">test_form</span> <span class="o">=</span> <span class="n">TestForm</span><span class="p">()</span>
        <span class="n">test_form</span><span class="o">.</span><span class="n">helper</span> <span class="o">=</span> <span class="n">FormHelper</span><span class="p">()</span>
        <span class="n">test_form</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">Layout</span><span class="p">(</span>
            <span class="n">SubmitCancelFormActions</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">Context</span><span class="p">({</span><span class="s">'form'</span><span class="p">:</span> <span class="n">test_form</span><span class="p">})</span>

        <span class="n">html</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">html</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">'class="form-actions'</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">html</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">'role="button"'</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">html</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">'href="#"'</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">html</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">'Cancel'</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">html</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">'Submit'</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">test_form</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">Layout</span><span class="p">(</span>
            <span class="n">SubmitCancelFormActions</span><span class="p">(</span><span class="n">cancel_href</span><span class="o">=</span><span class="s">"/some/url/"</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">Context</span><span class="p">({</span><span class="s">'form'</span><span class="p">:</span> <span class="n">test_form</span><span class="p">})</span>

        <span class="n">html</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">html</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">'href="/some/url/'</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span></code></pre></figure>

<p>In the unittest we render the form with the custom layout object
<code class="highlighter-rouge">SubmitCancelFormActions</code> and check for some keywords if present in the rendered
HTML.</p>

<h3 id="happy-ending">Happy ending</h3>

<p>That’s all folks! Keep DRY and write unittests!</p>

<hr/>

<p>P.S. In case you are still in doubt about the provided solution, here is what
<a href="http://pydanny.com/">Daniel Greenfeld</a> says: “As one of the leads of
django-crispy-forms, I approve this blog post. :-)”</p>

<hr/>

<p>See <a href="/2015/03/18/the-tale-of-dry-with-django-crispy-forms-part-2/">The tale of DRY with django-crispy-forms | Part II</a>
for a better solution, if you wanna to go an extra mile.</p>


    </div>
    </div></body></html>