<html><body><div><div class="post-content" itemprop="articleBody">
    <p>Today it is quite common to write applications that depend on third-party
APIs, or even internal APIs, in this modularized digital world. But
it makes testing tricky because dependency has an impact during the testing
process:</p>

<ul>
  <li>Test cases will be slow</li>
  <li>Test cases might fail if the third-party service is down</li>
  <li>Test cases will consume resources in the external service (allowed
rate limits)</li>
  <li>Sensitive information must be available to make them work (API Keys,
secrets, etc)</li>
</ul>

<p>That’s enough reasons to think of better ways to improve the
process, and this is where <a href="http://falcao.it/HTTPretty/">HTTPretty</a> comes to the rescue.</p>

<h2 id="httpretty">HTTPretty</h2>

<p>HTTPretty is just a <a href="http://en.wikipedia.org/wiki/Mock_object">mocking</a> library for HTTP requests. Quoting their
original words:</p>

<blockquote>
  <p>Once upon a time a python developer wanted to use a RESTful api,
  everything was fine but until the day he needed to test the code
  that hits the RESTful API: what if the API server is down? What if
  its content has changed?</p>
</blockquote>

<p>Lucky for us HTTPretty has a really simple interface and since it
monkey patches Python’s socket module, it works independently of the
HTTP library used.</p>

<h3 id="example-usage">Example usage</h3>

<p>Lets start with a simple example, let’s <code>mock</code> a <code>200</code> response (we
will be using the <code>requests</code> library for its simplicity):</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">httpretty</span>

<span class="c"># First enable HTTPretty (will monkey patch the socket module)</span>
<span class="n">httpretty</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>
<span class="c"># Register an URI to patch</span>
<span class="n">httpretty</span><span class="o">.</span><span class="n">register_uri</span><span class="p">(</span><span class="n">httpretty</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span> <span class="s">'http://example.com/'</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://example.com/'</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
<span class="c"># Outputs: 200</span>
<span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
<span class="c"># Outputs: HTTPretty :)</span>

<span class="c"># Remove the patches</span>
<span class="n">httpretty</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span></code></pre></div>

<p>We can override the response content of course:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">httpretty</span>

<span class="n">httpretty</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>
<span class="n">httpretty</span><span class="o">.</span><span class="n">register_uri</span><span class="p">(</span><span class="n">httpretty</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span> <span class="s">'http://example.com/'</span><span class="p">,</span>
                       <span class="n">body</span><span class="o">=</span><span class="s">'Overriding the response body'</span><span class="p">,</span>
                       <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://example.com/'</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
<span class="c"># Outputs: 200</span>
<span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
<span class="c"># Outputs: Overriding the response body</span>

<span class="n">httpretty</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span></code></pre></div>

<p>We can make the response content to be of any type, JSON for example:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">httpretty</span>

<span class="n">httpretty</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>
<span class="n">json_body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">'status'</span><span class="p">:</span> <span class="s">'ok'</span><span class="p">,</span> <span class="s">'value'</span><span class="p">:</span> <span class="s">'123'</span><span class="p">})</span>
<span class="n">httpretty</span><span class="o">.</span><span class="n">register_uri</span><span class="p">(</span><span class="n">httpretty</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span> <span class="s">'http://example.com/'</span><span class="p">,</span>
                       <span class="n">body</span><span class="o">=</span><span class="n">json_body</span><span class="p">,</span>
                       <span class="n">content_type</span><span class="o">=</span><span class="s">'application/json'</span><span class="p">,</span>
                       <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://example.com/'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>

<span class="c"># Outputs: 200</span>
<span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
<span class="c"># Outputs: '{"status": "ok", "value": "123"}'</span>
<span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
<span class="c"># Outputs: {u'status': u'ok', u'value': u'123'}</span>

<span class="n">httpretty</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span></code></pre></div>

<p>For simplicity, there’s a decorator that will call <code>enable()</code> and
<code>disable()</code> for us:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">httpretty</span>

<span class="nd">@httpretty.activate</span>
<span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="n">httpretty</span><span class="o">.</span><span class="n">register_uri</span><span class="p">(</span><span class="n">httpretty</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span> <span class="s">'http://example.com'</span><span class="p">,</span>
                           <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="s">'Testing decorator'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://example.com'</span><span class="p">)</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">test</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
<span class="c"># Outputs: 200</span>
<span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
<span class="c"># Outputs: Testing decorator</span>
<span class="k">print</span><span class="p">(</span><span class="n">httpretty</span><span class="o">.</span><span class="n">is_enabled</span><span class="p">())</span>
<span class="c"># Outputs: False</span></code></pre></div>

<p>HTTPretty also support the many HTTP methods beside <code>GET</code>, they can be
accessed at:</p>

<ul>
  <li><code>httpretty.DELETE</code></li>
  <li><code>httpretty.PUT</code></li>
  <li><code>httpretty.GET</code></li>
  <li><code>httpretty.OPTIONS</code></li>
  <li><code>httpretty.HEAD</code></li>
  <li><code>httpretty.PATCH</code></li>
  <li><code>httpretty.POST</code></li>
</ul>

<p>Other features are:</p>

<ul>
  <li>Add custom headers with the <code>adding_headers</code> parameter.</li>
  <li>Define multiple response values with the <code>responses</code> parameter, the
responses will be returned in order they are defined.</li>
  <li>Set a function as <code>body</code> parameter.</li>
  <li>The <code>URI</code> can be defined as a regular expression.</li>
</ul>

<h2 id="conclusion">Conclusion</h2>

<p>HTTPretty is great tool that helps to speed up the test cases that
depend on external APIs. It also help to ensure that the application
logic is well defined with the expected responses from the services,
and if the third-party changes, it’s not a fault in your code.</p>


  </div>

  
  

  </div></body></html>