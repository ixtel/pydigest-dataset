<html><body><div><div class="post-content">
                    <p class="pull-quote">PEP8 or GTFO</p>

<p>Like many people in our profession, I am a bit of a stickler when it comes to style and consistency. I like my code (and my team’s code) to have a specific style, and to stick to it, which is why I love tools like <code>go fmt</code>.</p>
<p>The Python equivalent is, of course, <a href="http://www.python.org/dev/peps/pep-0008/">PEP 8</a>. Although I don’t agree with everything (I like spaces but think tabs make more sense in theory, because they separate presentation and formatting), I observe PEP 8 because I think it is important to have one consistent style, no matter what it is.</p>
<p>Sometimes, however, code which doesn’t follow that style slips past my editor. In those cases, I would like my git server to reject my commits and tell me what’s wrong so I can fix it. Luckily, we can combine two great things to form an awesome thing: The <a href="https://pypi.python.org/pypi/flake8">flake8</a> script and <a href="http://git-scm.com/book/en/Customizing-Git-Git-Hooks">git hooks</a>.</p>
<p>Flake8 not only checks your code for PEP8 compliance, but it also checks it for errors, which helps you quickly catch many bugs before it’s too late. We can use the git <code>pre-receive</code> hook to decide whether we want to accept or reject a specific commit.</p>
<p>Writing a <code>pre-receive</code> hook is rather obscure and not very well documented, but, fortunately, I found a <a href="https://github.com/blueicefield/PHP_CodeSniffer_GIT_Hook/blob/master/pre-receive">very nice hook</a> that checks PHP code, and modified it to my needs. Here it is:</p>
<div class="highlight"><pre><span class="c">#!/bin/bash</span>

<span class="nv">COMMAND</span><span class="o">=</span><span class="s1">'flake8'</span>
<span class="nv">TEMPDIR</span><span class="o">=</span><span class="sb">`</span>mktemp -d<span class="sb">`</span>

<span class="k">while</span> <span class="nb">read </span>oldrev newrev refname<span class="p">;</span> <span class="k">do</span>
    <span class="nv">files</span><span class="o">=</span><span class="sb">`</span>git diff --name-only <span class="si">${</span><span class="nv">oldrev</span><span class="si">}</span> <span class="si">${</span><span class="nv">newrev</span><span class="si">}</span><span class="sb">`</span>
    <span class="k">for</span> file in <span class="si">${</span><span class="nv">files</span><span class="si">}</span><span class="p">;</span> <span class="k">do</span>
        <span class="nv">object</span><span class="o">=</span><span class="sb">`</span>git ls-tree --full-name -r <span class="si">${</span><span class="nv">newrev</span><span class="si">}</span> <span class="p">|</span> egrep <span class="s2">"(\s)</span><span class="si">${</span><span class="nv">file</span><span class="si">}</span><span class="s2">\$"</span> <span class="p">|</span> awk <span class="s1">'{ print $3 }'</span><span class="sb">`</span>
        <span class="k">if</span> <span class="o">[</span> -z <span class="si">${</span><span class="nv">object</span><span class="si">}</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> <span class="k">continue</span><span class="p">;</span> <span class="k">fi</span>
        mkdir -p <span class="s2">"</span><span class="si">${</span><span class="nv">TEMPDIR</span><span class="si">}</span><span class="s2">/`dirname </span><span class="si">${</span><span class="nv">file</span><span class="si">}</span><span class="s2">`"</span> <span class="p">&amp;</span>&gt; /dev/null
        git cat-file blob <span class="si">${</span><span class="nv">object</span><span class="si">}</span> &gt; <span class="si">${</span><span class="nv">TEMPDIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">file</span><span class="si">}</span>
    <span class="k">done</span><span class="p">;</span>
<span class="k">done</span>

<span class="c"># Change the filename here if your flake8 configuration</span>
<span class="c"># has a different name.</span>
git show HEAD:tox.ini &gt; <span class="si">${</span><span class="nv">TEMPDIR</span><span class="si">}</span>/tox.ini
<span class="si">${</span><span class="nv">COMMAND</span><span class="si">}</span> <span class="si">${</span><span class="nv">TEMPDIR</span><span class="si">}</span>
<span class="nv">STATUS</span><span class="o">=</span><span class="nv">$?</span>
rm -rf <span class="si">${</span><span class="nv">TEMPDIR</span><span class="si">}</span> <span class="p">&amp;</span>&gt; /dev/null
<span class="nb">echo </span>status <span class="nv">$STATUS</span>
<span class="nb">exit</span> <span class="si">${</span><span class="nv">STATUS</span><span class="si">}</span>
</pre></div>


<p>You can paste the code above into the <code>.git/hooks/pre-receive</code> file, make it executable and try to push to that repo. The hook will:</p>
<ul>
<li>Check which files changed in the last commit.</li>
<li>Extract them all into a temporary directory.</li>
<li>Extract the <code>tox.ini</code> file from the repository to that directory (feel free to change that line if your file is called something else, or remove it entirely).</li>
<li>Run flake8 on that directory.</li>
<li>Reject the commit if there are errors, printing them, or accept it otherwise.</li>
</ul>
<p>That is, hopefully, pretty straightforward. The script can easily be adapted to any sort of tool or workflow, but be careful not to check <em>every</em> commit, because the only way for the user to pass the filter then would be to go back and change history.</p>
<p>Please let me know in the comments if you found this useful, or if you have any checking scripts of your own that you’d like to share.</p>
                </div>
            </div></body></html>