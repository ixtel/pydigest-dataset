<html><body><div><article class="markdown-body entry-content" itemprop="text"><h1><a id="user-content-spotify-postgresql-metrics" class="anchor" href="#spotify-postgresql-metrics" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Spotify PostgreSQL Metrics</h1>

<p>Service to extract and provide metrics on your PostgreSQL database.</p>

<p>This tool is a CLI (command line) tool that can be called to extract
statistics and create metrics regarding your PostgreSQL database cluster.
CLI is runnable in long running process mode, which will periodically
send the gathered metrics forward.</p>

<p>The default metrics format is a <a href="http://metrics20.org/">Metrics 2.0</a>
compatible JSON, which is created by a set of functions listed in
the configuration file.</p>

<p>The extracted metrics can be printed out as direct output of
the CLI tool or sent out of the host, where the postgresql-metrics
process is running using <a href="https://github.com/spotify/ffwd">FFWD</a>.</p>

<p>Notice that the <a href="https://github.com/spotify/ffwd">FFWD</a> format is
plain JSON sent over a UDP socket, so you can use whatever
UDP socket endpoint, which understands JSON, to consume the metrics.</p>

<h2><a id="user-content-prerequisites" class="anchor" href="#prerequisites" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Prerequisites</h2>

<p>The versions mentioned below are tested to work, but the code should
work on many unlisted versions as well. Just add an issue or send
a pull-request with missing prerequisites, if you test and confirm
postgresql-metrics to work on other versions of the mentioned
technologies.</p>

<ul>
<li>Python 2.7</li>
<li>PostgreSQL 9.3 or later</li>
<li>Debian based distribution with Upstart, if you want to use the packaging functionality</li>
</ul>

<h2><a id="user-content-building-and-installing" class="anchor" href="#building-and-installing" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Building and Installing</h2>

<p>You can build a Debian package out of this by calling <em>debuild</em> in project
root, e.g.:</p>

<pre><code>debuild -us -uc -b
</code></pre>

<p>Notice that postgresql-metrics includes by default an Upstart script to run
as long running process, pushing metrics to FFWD as gathered. You need to
stop the long running process after installing the package for configuration.</p>

<pre><code>sudo stop postgresql-metrics
</code></pre>

<p>Notice that by default Upstart processes log under <em>/var/log/upstart/</em>, if you
want to debug the process.</p>

<h3><a id="user-content-edit-configuration" class="anchor" href="#edit-configuration" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Edit Configuration</h3>

<p>Edit the configuration in <em>/etc/postgresql-metrics/postgresql-metrics.yml</em>
and in <em>/etc/postgresql-metrics/default/postgresql-metrics.yml</em>. Notice that
the configuration in the default folder will be overwritten value by value
from the configuration in the configuration root.</p>

<p>If you are not interested in using the default configuration overwriting
functionality, just delete one of the configurations mentioned above, and
keep using a single configuration file.</p>

<p>Edit at least the values under <em>postgres</em> section in the configuration to
match your PostgreSQL cluster setup. Remember also to list the <em>databases</em>
you want to gather metrics from. Notice that by database in this context
we mean a database name you created within your PostgreSQL cluster.</p>

<h3><a id="user-content-prepare-database" class="anchor" href="#prepare-database" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Prepare Database</h3>

<p>Before starting to extract the defined metrics, you need to setup your
database cluster using the <em>prepare-db</em> CLI call. This will create
the required extensions for your database, and a few functions that are
used by the statistics gathering queries from the metrics process.
The configured metrics user will be also granted access to the created
statistics functions and views.</p>

<p>You need to provide administrator user to the <em>prepare-db</em> call, which
the tool is kind enough to ask. You don't need to provide credentials, if
you are running the <em>prepare-db</em> with a local user that is configured to be
trusted locally by the PostgreSQL cluster (in <em>pg_hba.conf</em>), and is
a super user, like the default <em>postgres</em> user created by some distribution
packages (e.g. Debian). You can do the prepare-db call e.g. as follows:</p>

<pre><code>sudo su -c "postgresql-metrics prepare-db" postgres
</code></pre>

<p>It is safe to call the <em>prepare-db</em> multiple times for the same database
(the call is idempotent).</p>

<p>Notice that you can also run the SQL found in the <em>sql</em> folder
within this repository manually in your PostgreSQL cluster, which does
the same setup as the <em>prepare-db</em> call.</p>

<h3><a id="user-content-grant-access-for-metrics-user" class="anchor" href="#grant-access-for-metrics-user" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Grant Access for Metrics User</h3>

<p>In addition to granting access to the statistics gathering functions and views
within your PostgreSQL cluster (previous step), you need to also add access
to the metrics user into the host based access file (<em>pg_hba.conf</em>).</p>

<p>Add one line per database you are monitoring into the end of the <em>pg_hba.conf</em>
file for your cluster:</p>

<pre><code>host my_database_name metrics_user_name 127.0.0.1/32 md5  # metrics user access
</code></pre>

<p>Replace the <em>my_database_name</em> and <em>metrics_user_name</em> with the values you
configured into the postgresql-metrics configuration in <strong>Edit Configuration</strong>
step above.</p>

<p>You need to reload (or restart) your server after editing <em>pg_hba.conf</em> for
the changes to take effect.</p>

<h3><a id="user-content-getting-metrics" class="anchor" href="#getting-metrics" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Getting Metrics</h3>

<p>After you have the postgresql-metrics configured, and the database prepared,
you can print out all the metrics that will be extracted from your database
by calling:</p>

<pre><code>postgresql-metrics all
</code></pre>

<p>You need to call the command above as a user that has access to the WAL log
directory under PostgreSQL, or the metric gathering WAL file amounts will fail.
Single failed metric calls will not prevent the rest of gathering process.</p>

<p>You can also start the long running process again, if using Upstart:</p>

<pre><code>sudo start postgresql-metrics
</code></pre>

<h2><a id="user-content-explaining-the-gathered-metrics" class="anchor" href="#explaining-the-gathered-metrics" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Explaining the Gathered Metrics</h2>

<p>This section explains the metrics we gather using this tool.</p>

<p>Notice that there are many system specific metrics that you should gather
in addition to the Postgres specific metrics. These kind of metrics we do
not gather, that you should gather with other tools, are for example:</p>

<ul>
<li>CPU usage</li>
<li>Network usage, sent / received bytes per related network interface</li>
<li>Disk I/O operations</li>
<li>I/O await times</li>
<li>Disk usage amounts and free space left</li>
<li>Memory usage</li>
</ul>

<h3><a id="user-content-database-specific-metrics" class="anchor" href="#database-specific-metrics" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Database Specific Metrics</h3>

<p>Called once per configured database inside your Postgres cluster.</p>

<ul>
<li><p><strong>get_stats_disk_usage_for_database</strong>:
This metric shows the size of each of your databases in bytes.
Don't forget to measure the total disk usage of the disk your data
directory resides in as well.</p></li>
<li><p><strong>get_stats_tx_rate_for_database</strong>:
Shows the rate of transactions executed per second since the last call
of this function. Shows the rate of executed rollbacks also separately.</p></li>
<li><p><strong>get_stats_seconds_since_last_vacuum_per_table</strong>:
This metric shows the amount of time passed in seconds since the last
vacuum was run per table in your database.</p></li>
<li><p><strong>get_stats_oldest_transaction_timestamp</strong>:
This metric shows the time the longest running transaction has been open
in your database. This should be usually close to zero, but sometimes,
for example when an administrator forgets to close a maintenance connection,
you will see this value going up. Long running transactions are bad for
your database, so fix the issue as soon as you see this metric increase.</p></li>
<li><p><strong>get_stats_index_hit_rates</strong>:
This metric shows you the amount of reads hitting the table indexes
versus the amount of reads requiring sequential scan through the table.
Depending on your table, the amount of data, and the created indexes,
the index hit rate varies. You should understand your data well enough
to know when high index usage is desirable to low index usage.</p></li>
<li><p><strong>get_stats_table_bloat</strong>:
This metric shows the amount of wasted space in the database table due
to the MVCC process. Deletes and updates to the table just mark
the obsolete data free, but does not really delete it. Vacuums do free
some of this wasted data, but to get totally rid of table bloat you must
re-create the table with vacuum full.
The current implementation of table bloat metric is rather heavy, so you
might want to disable it in case you see issues with it.</p></li>
</ul>

<h3><a id="user-content-database-cluster-global-metrics" class="anchor" href="#database-cluster-global-metrics" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Database Cluster (Global) Metrics</h3>

<p>Called once per your Postgres cluster.</p>

<ul>
<li><p><strong>get_stats_client_connections</strong>:
This metrics shows the amount of connections open to the database
at the moment. The actual metrics gathering connections should be visible
here as well. Notice that having more than a hundred connections open is
usually a bad thing. Consider using a connection pooler, like pgbouncer.</p></li>
<li><p><strong>get_stats_lock_statistics</strong>:
This metric shows locks being waited upon by queries, and the amount of
locks granted. In general having any query waiting for locks for any
extended period of time is a sign of problems, like heavy lock contention.</p></li>
<li><p><strong>get_stats_heap_hit_statistics</strong>:
This metric shows the amount of reads hitting the memory buffers on your
cluster, and also the amount of reads hitting the disk (or disk caches on
the operating system). Also the heap hit ratio is calculated based on
these values.</p>

<p>Notice that the read amounts are not actual read queries, but the amount
of blocks read. You will get good idea of amount of reads hitting your
database, when comparing these values with the transaction rate.</p></li>
<li><p><strong>get_stats_replication_delays</strong>:
This metric shows the amount of bytes the replication delay is behind master
per each slave. If the slave and the master are in synchronous state,
the replication delay is zero.</p></li>
</ul>

<h3><a id="user-content-database-local-directory-based-global-metrics" class="anchor" href="#database-local-directory-based-global-metrics" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Database Local Directory Based (Global) Metrics</h3>

<ul>
<li><strong>get_stats_wal_file_amount</strong>:
This graph shows the amount of files in your database clusters WAL log
directory (pg_xlog). If the WAL file amount starts to suddenly increase,
you probably have issues with your WAL archiving process, which might
lead to the disk filling up, and you database cluster crashing.</li>
</ul>

<h2><a id="user-content-short-overview-of-python-modules" class="anchor" href="#short-overview-of-python-modules" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Short Overview of Python Modules</h2>

<ul>
<li><strong>common.py</strong>: Contains code common for the whole package, like logging and
configuration parsing.</li>
<li><strong>default_metrics.py</strong>: Is responsible for turning statistics values into
the default metrics JSON format.</li>
<li><strong>localhost_postgres_stats.py</strong>: Functions for statistics extraction from
local Postgres data directory. These calls are automatically global from
a database cluster perspective.</li>
<li><strong>metrics_gatherer.py</strong>: Functions for calling the statistics extraction
functions and converting the results into correct metrics format. Called
from the metrics_logic.py.</li>
<li><strong>metrics_logic.py</strong>: Contains the CLI tool, initialization, and
the scheduling logic.</li>
<li><strong>postgres_queries.py</strong>: Functions for statistics extraction from
the Postgres database.</li>
<li><strong>prepare_db.py</strong>: Code for preparing your databases for the metrics
gathering process.</li>
</ul>

<h2><a id="user-content-how-to-add-more-metrics" class="anchor" href="#how-to-add-more-metrics" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>How to Add More Metrics</h2>

<p>If you want to add more metrics into postgresql-metrics tool, you can do it
by making the following changes to the source:</p>

<ol>
<li><p>If you gather the metric using a Postgres SQL query, add the code into
<em>postgres_queries.py</em>, and if you gather the metric by accessing the local
Postgres data directory, add the code into <em>localhost_postgres_stats.py</em>.</p></li>
<li><p>Write a function for formatting your gathered metric values into wanted
format, as is done in <strong>default_metrics.py</strong>. You can either expand
the default metrics, or write your own format into another module.</p></li>
<li><p>Write a function into <strong>metrics_gatherer.py</strong>, which will call the metric
extraction functionality you wrote on the first step, and then the metric
value formatting function you wrote on the previous step.</p></li>
<li><p>Add the name of your metrics gatherer function, written in the previous
step, into <em>postgresql-metrics</em> configuration file, with wanted time
interval to call the metric gathering function. Notice that you need to
add the function into the correct list of functions depending on whether
you gather a metric that covers your whole database cluster, or a metric
that targets a single database in your cluster. Data directory based
metrics must be a 'global' metric.</p></li>
<li><p>Update this README with explanation on what your new metric is about.</p></li>
</ol>
</article>
  </div></body></html>