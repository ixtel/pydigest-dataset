<html><body><div><div class="entry-content">
					<p>Lots of OSINT investigations involve looking at companies, their structure, and of course their directors. Just yesterday, <a href="http://www.cbc.ca/news/business/kpmg-offshore-sham-deceived-tax-authorities-cra-alleges-1.3209838" target="_blank">CBC News here in Canada did a story</a> about a wealthy family allegedly using tax havens as a means to avoid paying taxes. As part of the news story the reporters at CBC posted some court documents and correspondence. Over my morning coffee I began reading through the court documents and wondered to myself what could be done to look at the timeline of events that some of the companies involved went through. Did they change corporate structure after being chased by the tax man? What could I do to visualize this information?</p>
<p>During previous investigations I had used <a href="http://opencorporates.com" target="_blank">OpenCorporates</a> to find information about companies operating in Canada and abroad. More recently I had discussions with <a href="https://www.twitter.com/rossimi01" target="_blank">Michael Rossi</a> (a student of mine) about mining through some of the OpenCorporate data using their <a href="https://api.opencorporates.com/" target="_blank">API</a>. This seemed like a perfect opportunity to begin learning it. At the same time, another student of mine <a href="https://www.twitter.com/syriadirect" target="_blank">Joseph Adams</a> had shown me how far TimelineJS in the last couple of releases. <a href="http://timeline3.knightlab.com/" target="_blank">TimelineJS</a> is a powerful tool for building timelines for journalists telling stories and Joseph did exactly that in an in-depth <a href="http://syriadirect.org/news/did-is-strike-marea-with-mustard-agent/" target="_blank">article</a> on a mustard gas attack investigation in Syria. This post is how we can begin to compile corporate record filing dates between multiple companies and overlay them on a timeline to look for patterns. Here we go.</p>
<p> </p>
<h2>OpenCorporates API Tutorial</h2>
<p>My original goal was to have a tool where I could punch in a company name and jurisdiction (2 letter country code) and have it automatically pull back all of the corporate filings for that company. The first step is resolving the company records in the API. You can see some documentation <a href="https://api.opencorporates.com/documentation/API-Reference" target="_blank">here</a>. There were two endpoints that it looked like I needed to use:</p>
<ol>
<li>GET companies/search – takes a <strong>q </strong>parameter for the query string and a <strong>jurisdiction_code </strong>for the jurisdiction (country) that you are searching within.</li>
<li>GET companies/<strong>jurisdiction_code</strong>/<strong>company_number</strong>/filings – again using the <strong>jurisdiction_code </strong>and the company number that gets returned from our original corporate search API call.</li>
</ol>
<p>These two small API calls can give us a wealth of information about a company, but there are lots of other API calls that we can use for OSINT purposes (stay tuned for more posts on this). Now we need to figure out how to get this data into a pretty timeline.</p>
<h2>Interfacing With TimelineJS</h2>
<p>As I mentioned previously, TimelineJS is an amazing tool that can take some normalized data and create really beautiful timeline visualizations that can include Tweets, YouTube videos, and has a tremendous amount of flexibility. Since I had only a lunch break to take a look at all of this, I opted to look at their spreadsheet format. What TimelineJS allows you to do is create a Google Spreadsheet in a specific format, publish that spreadsheet to the web, and then TimelineJS will automatically read the data in and create a timeline from the data. I literally just opened this <a href="https://drive.google.com/previewtemplate?id=1pHBvXN7nmGkiG8uQSUB82eNlnL8xHu6kydzH_-eguHQ&amp;mode=public" target="_blank">template</a>, and copied out the required header rows from the spreadsheet so that I could write it out with Python. Our script will simply output a CSV using this format and then we can upload the results to our Google Drive and begin exploring the data. Easy peasy.</p>
<h2>Coding It Up</h2>
<p>Alright let’s get down to business. Crack open your Python editor and start punching out the following code (you can download the source <a href="https://github.com/automatingosint/osint_public/blob/master/followthemoney/followthemoney.py" target="_blank">here</a>):</p>

		<div id="crayon-56d59b3f14a3b799504083" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-56d59b3f14a3b799504083-1">1</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a3b799504083-2">2</p><p class="crayon-num" data-line="crayon-56d59b3f14a3b799504083-3">3</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a3b799504083-4">4</p><p class="crayon-num" data-line="crayon-56d59b3f14a3b799504083-5">5</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a3b799504083-6">6</p><p class="crayon-num" data-line="crayon-56d59b3f14a3b799504083-7">7</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a3b799504083-8">8</p><p class="crayon-num" data-line="crayon-56d59b3f14a3b799504083-9">9</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a3b799504083-10">10</p><p class="crayon-num" data-line="crayon-56d59b3f14a3b799504083-11">11</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a3b799504083-12">12</p><p class="crayon-num" data-line="crayon-56d59b3f14a3b799504083-13">13</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a3b799504083-14">14</p><p class="crayon-num" data-line="crayon-56d59b3f14a3b799504083-15">15</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a3b799504083-16">16</p><p class="crayon-num" data-line="crayon-56d59b3f14a3b799504083-17">17</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a3b799504083-18">18</p><p class="crayon-num" data-line="crayon-56d59b3f14a3b799504083-19">19</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d59b3f14a3b799504083-1"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">requests</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a3b799504083-2"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-k ">json</span></p><p class="crayon-line" id="crayon-56d59b3f14a3b799504083-3"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-k ">argparse</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a3b799504083-4"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-k ">csv</span></p><p class="crayon-line" id="crayon-56d59b3f14a3b799504083-5"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-k ">urllib</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a3b799504083-6"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-k ">os</span></p><p class="crayon-line" id="crayon-56d59b3f14a3b799504083-7"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a3b799504083-8"><span class="crayon-v">ap</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">argparse</span><span class="crayon-sy">.</span><span class="crayon-e">ArgumentParser</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59b3f14a3b799504083-9"><span class="crayon-v">ap</span><span class="crayon-sy">.</span><span class="crayon-e">add_argument</span><span class="crayon-sy">(</span><span class="crayon-s">"-c"</span><span class="crayon-sy">,</span><span class="crayon-s">"--company"</span><span class="crayon-sy">,</span><span class="crayon-h">    </span><span class="crayon-v">required</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">,</span><span class="crayon-k ">help</span><span class="crayon-o">=</span><span class="crayon-s">"Pass in the exact corporate name to search for."</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a3b799504083-10"><span class="crayon-v">ap</span><span class="crayon-sy">.</span><span class="crayon-e">add_argument</span><span class="crayon-sy">(</span><span class="crayon-s">"-j"</span><span class="crayon-sy">,</span><span class="crayon-s">"--jurisdiction"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">required</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">,</span><span class="crayon-k ">help</span><span class="crayon-o">=</span><span class="crayon-s">"Pass in a two character jurisdiction code."</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59b3f14a3b799504083-11"><span class="crayon-v">ap</span><span class="crayon-sy">.</span><span class="crayon-e">add_argument</span><span class="crayon-sy">(</span><span class="crayon-s">"-t"</span><span class="crayon-sy">,</span><span class="crayon-s">"--timeline"</span><span class="crayon-sy">,</span><span class="crayon-h">     </span><span class="crayon-v">required</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">,</span><span class="crayon-k ">help</span><span class="crayon-o">=</span><span class="crayon-s">"Timeline file, will create if doesn't exist or add to existing spreadsheet."</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a3b799504083-12"> </p><p class="crayon-line" id="crayon-56d59b3f14a3b799504083-13"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a3b799504083-14"><span class="crayon-v">args</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">vars</span><span class="crayon-sy">(</span><span class="crayon-v">ap</span><span class="crayon-sy">.</span><span class="crayon-e">parse_args</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59b3f14a3b799504083-15"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a3b799504083-16"><span class="crayon-v">company</span><span class="crayon-h">       </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">args</span><span class="crayon-sy">[</span><span class="crayon-s">'company'</span><span class="crayon-sy">]</span></p><p class="crayon-line" id="crayon-56d59b3f14a3b799504083-17"><span class="crayon-v">jurisdiction</span><span class="crayon-h">  </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">args</span><span class="crayon-sy">[</span><span class="crayon-s">'jurisdiction'</span><span class="crayon-sy">]</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a3b799504083-18"><span class="crayon-v">timeline_file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">args</span><span class="crayon-sy">[</span><span class="crayon-s">'timeline'</span><span class="crayon-sy">]</span></p><p class="crayon-line" id="crayon-56d59b3f14a3b799504083-19"> </p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>Ok this is all setup code where we are just setting up our imports to pull in the required modules we need to use, create some commandline arguments we can pass in, and define some global variables to store the commandline information. Now let’s build our corporate name searching function:</p>

		<div id="crayon-56d59b3f14a4a823112708" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a4a823112708-20">20</p><p class="crayon-num" data-line="crayon-56d59b3f14a4a823112708-21">21</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a4a823112708-22">22</p><p class="crayon-num" data-line="crayon-56d59b3f14a4a823112708-23">23</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a4a823112708-24">24</p><p class="crayon-num" data-line="crayon-56d59b3f14a4a823112708-25">25</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a4a823112708-26">26</p><p class="crayon-num" data-line="crayon-56d59b3f14a4a823112708-27">27</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a4a823112708-28">28</p><p class="crayon-num" data-line="crayon-56d59b3f14a4a823112708-29">29</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a4a823112708-30">30</p><p class="crayon-num" data-line="crayon-56d59b3f14a4a823112708-31">31</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a4a823112708-32">32</p><p class="crayon-num" data-line="crayon-56d59b3f14a4a823112708-33">33</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a4a823112708-34">34</p><p class="crayon-num" data-line="crayon-56d59b3f14a4a823112708-35">35</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a4a823112708-36">36</p><p class="crayon-num" data-line="crayon-56d59b3f14a4a823112708-37">37</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a4a823112708-38">38</p><p class="crayon-num" data-line="crayon-56d59b3f14a4a823112708-39">39</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a4a823112708-40">40</p><p class="crayon-num" data-line="crayon-56d59b3f14a4a823112708-41">41</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a4a823112708-20"><span class="crayon-c">#</span></p><p class="crayon-line" id="crayon-56d59b3f14a4a823112708-21"><span class="crayon-c"># Do an initial corporate search</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a4a823112708-22"><span class="crayon-c">#</span></p><p class="crayon-line" id="crayon-56d59b3f14a4a823112708-23"><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">corporation_search</span><span class="crayon-sy">(</span><span class="crayon-v">corporation</span><span class="crayon-sy">,</span><span class="crayon-v">jurisdiction</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a4a823112708-24"><span class="crayon-h">    </span></p><p class="crayon-line" id="crayon-56d59b3f14a4a823112708-25"><span class="crayon-h">    </span><span class="crayon-v">url</span><span class="crayon-h">  </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"https://api.opencorporates.com/v0.4/companies/search?q=%s"</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-k ">urllib</span><span class="crayon-sy">.</span><span class="crayon-e">quote</span><span class="crayon-sy">(</span><span class="crayon-v">corporation</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a4a823112708-26"><span class="crayon-h">    </span><span class="crayon-v">url</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-s">"&amp;jurisdiction_code=%s"</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">args</span><span class="crayon-sy">[</span><span class="crayon-s">'jurisdiction'</span><span class="crayon-sy">]</span></p><p class="crayon-line" id="crayon-56d59b3f14a4a823112708-27"><span class="crayon-h">            </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a4a823112708-28"><span class="crayon-h">    </span><span class="crayon-v">response</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">requests</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-v">url</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59b3f14a4a823112708-29"><span class="crayon-h">    </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a4a823112708-30"><span class="crayon-h">    </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">response</span><span class="crayon-sy">.</span><span class="crayon-v">status_code</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-cn">200</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d59b3f14a4a823112708-31"><span class="crayon-h">        </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a4a823112708-32"><span class="crayon-h">        </span><span class="crayon-v">result</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">json</span><span class="crayon-sy">.</span><span class="crayon-e">loads</span><span class="crayon-sy">(</span><span class="crayon-v">response</span><span class="crayon-sy">.</span><span class="crayon-v">content</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59b3f14a4a823112708-33"><span class="crayon-h">        </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a4a823112708-34"><span class="crayon-h">        </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">company </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">result</span><span class="crayon-sy">[</span><span class="crayon-s">'results'</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-s">'companies'</span><span class="crayon-sy">]</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d59b3f14a4a823112708-35"><span class="crayon-h">            </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a4a823112708-36"><span class="crayon-h">            </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">corporation</span><span class="crayon-sy">.</span><span class="crayon-e">lower</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-v">company</span><span class="crayon-sy">[</span><span class="crayon-s">'company'</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-s">'name'</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">lower</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d59b3f14a4a823112708-37"><span class="crayon-h">                </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a4a823112708-38"><span class="crayon-h">                </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">company</span><span class="crayon-sy">[</span><span class="crayon-s">'company'</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-s">'company_number'</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">company</span><span class="crayon-sy">[</span><span class="crayon-s">'company'</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-s">'name'</span><span class="crayon-sy">]</span></p><p class="crayon-line" id="crayon-56d59b3f14a4a823112708-39"><span class="crayon-h">                </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a4a823112708-40"><span class="crayon-h">   </span></p><p class="crayon-line" id="crayon-56d59b3f14a4a823112708-41"><span class="crayon-h">    </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">None</span><span class="crayon-sy">,</span><span class="crayon-t">None</span><span class="crayon-h">   </span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>This is slightly more involved so let’s take a deeper look:</p>
<ul>
<li><strong>Line 23: </strong>we define our <strong>corporation_search </strong>function that takes in the <em>corporation </em>parameter that is going to be the company we are searching for as well as the <em>jurisdiction</em><strong> </strong>that is the two-letter country code.</li>
<li><strong>Lines 25-26: </strong>we build our API URL passing in a URL-encoded company name (25) and then adding the <em>jurisdiction_code </em>parameter to the URL to narrow the result (26).</li>
<li><strong>Lines 28-32: </strong>we send off the request (28) and if we receive a valid response back (30) we process the JSON we receive back (32).</li>
<li><strong>Lines 34-38: </strong>we iterate over all of the matches returned (34) and then check to see if we have an exact match to the company name we passed in to the script (36). If we have an exact match we return back the company number and the company name (38).</li>
</ul>
<p>Perfect, we have our corporate search function in place, now let’s write the code that will be responsible for pulling out the filings for this company.</p>

		<div id="crayon-56d59b3f14a54606830390" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-56d59b3f14a54606830390-43">43</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a54606830390-44">44</p><p class="crayon-num" data-line="crayon-56d59b3f14a54606830390-45">45</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a54606830390-46">46</p><p class="crayon-num" data-line="crayon-56d59b3f14a54606830390-47">47</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a54606830390-48">48</p><p class="crayon-num" data-line="crayon-56d59b3f14a54606830390-49">49</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a54606830390-50">50</p><p class="crayon-num" data-line="crayon-56d59b3f14a54606830390-51">51</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a54606830390-52">52</p><p class="crayon-num" data-line="crayon-56d59b3f14a54606830390-53">53</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a54606830390-54">54</p><p class="crayon-num" data-line="crayon-56d59b3f14a54606830390-55">55</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a54606830390-56">56</p><p class="crayon-num" data-line="crayon-56d59b3f14a54606830390-57">57</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a54606830390-58">58</p><p class="crayon-num" data-line="crayon-56d59b3f14a54606830390-59">59</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a54606830390-60">60</p><p class="crayon-num" data-line="crayon-56d59b3f14a54606830390-61">61</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a54606830390-62">62</p><p class="crayon-num" data-line="crayon-56d59b3f14a54606830390-63">63</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a54606830390-64">64</p><p class="crayon-num" data-line="crayon-56d59b3f14a54606830390-65">65</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a54606830390-66">66</p><p class="crayon-num" data-line="crayon-56d59b3f14a54606830390-67">67</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a54606830390-68">68</p><p class="crayon-num" data-line="crayon-56d59b3f14a54606830390-69">69</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a54606830390-70">70</p><p class="crayon-num" data-line="crayon-56d59b3f14a54606830390-71">71</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a54606830390-72">72</p><p class="crayon-num" data-line="crayon-56d59b3f14a54606830390-73">73</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a54606830390-74">74</p><p class="crayon-num" data-line="crayon-56d59b3f14a54606830390-75">75</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a54606830390-76">76</p><p class="crayon-num" data-line="crayon-56d59b3f14a54606830390-77">77</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a54606830390-78">78</p><p class="crayon-num" data-line="crayon-56d59b3f14a54606830390-79">79</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a54606830390-80">80</p><p class="crayon-num" data-line="crayon-56d59b3f14a54606830390-81">81</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a54606830390-82">82</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d59b3f14a54606830390-43"><span class="crayon-c">#</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a54606830390-44"><span class="crayon-c"># Retrieve corporate filings</span></p><p class="crayon-line" id="crayon-56d59b3f14a54606830390-45"><span class="crayon-c">#</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a54606830390-46"><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">corporate_filings</span><span class="crayon-sy">(</span><span class="crayon-v">corporation_id</span><span class="crayon-sy">,</span><span class="crayon-v">jurisdiction</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d59b3f14a54606830390-47"><span class="crayon-h">    </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a54606830390-48"><span class="crayon-h">    </span><span class="crayon-v">api_url</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"https://api.opencorporates.com/v0.4/companies/%s/%s/filings"</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">jurisdiction</span><span class="crayon-sy">,</span><span class="crayon-v">corporation_id</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59b3f14a54606830390-49"><span class="crayon-h">    </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a54606830390-50"><span class="crayon-h">    </span><span class="crayon-v">response</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">requests</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-v">api_url</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59b3f14a54606830390-51"><span class="crayon-h">    </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a54606830390-52"><span class="crayon-h">    </span><span class="crayon-v">filings</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">]</span></p><p class="crayon-line" id="crayon-56d59b3f14a54606830390-53"><span class="crayon-h">    </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a54606830390-54"><span class="crayon-h">    </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">response</span><span class="crayon-sy">.</span><span class="crayon-v">status_code</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-cn">200</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d59b3f14a54606830390-55"><span class="crayon-h">        </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a54606830390-56"><span class="crayon-h">        </span><span class="crayon-v">result</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">json</span><span class="crayon-sy">.</span><span class="crayon-e">loads</span><span class="crayon-sy">(</span><span class="crayon-v">response</span><span class="crayon-sy">.</span><span class="crayon-v">content</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59b3f14a54606830390-57"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a54606830390-58"><span class="crayon-h">        </span><span class="crayon-v">filings</span><span class="crayon-sy">.</span><span class="crayon-e">extend</span><span class="crayon-sy">(</span><span class="crayon-v">result</span><span class="crayon-sy">[</span><span class="crayon-s">'results'</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-s">'filings'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59b3f14a54606830390-59"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a54606830390-60"><span class="crayon-h">        </span><span class="crayon-c"># iterate over all filings</span></p><p class="crayon-line" id="crayon-56d59b3f14a54606830390-61"><span class="crayon-h">        </span><span class="crayon-v">total_pages</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">result</span><span class="crayon-sy">[</span><span class="crayon-s">'results'</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-s">'total_pages'</span><span class="crayon-sy">]</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a54606830390-62"><span class="crayon-h">        </span><span class="crayon-v">count</span><span class="crayon-h">       </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">2</span></p><p class="crayon-line" id="crayon-56d59b3f14a54606830390-63"><span class="crayon-h">        </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a54606830390-64"><span class="crayon-h">        </span><span class="crayon-st">while</span><span class="crayon-h"> </span><span class="crayon-v">count</span><span class="crayon-h"> </span><span class="crayon-o">&lt;=</span><span class="crayon-h"> </span><span class="crayon-v">total_pages</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d59b3f14a54606830390-65"><span class="crayon-h">            </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a54606830390-66"><span class="crayon-h">            </span><span class="crayon-v">url</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">api_url</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">"?page=%d"</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">count</span></p><p class="crayon-line" id="crayon-56d59b3f14a54606830390-67"><span class="crayon-e">            </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a54606830390-68"><span class="crayon-e">            </span><span class="crayon-v">response</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">requests</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-v">url</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59b3f14a54606830390-69"><span class="crayon-h">            </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a54606830390-70"><span class="crayon-h">            </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">response</span><span class="crayon-sy">.</span><span class="crayon-v">status_code</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-cn">200</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d59b3f14a54606830390-71"><span class="crayon-h">                </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a54606830390-72"><span class="crayon-h">                </span><span class="crayon-v">result</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">json</span><span class="crayon-sy">.</span><span class="crayon-e">loads</span><span class="crayon-sy">(</span><span class="crayon-v">response</span><span class="crayon-sy">.</span><span class="crayon-v">content</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59b3f14a54606830390-73"><span class="crayon-h">                </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a54606830390-74"><span class="crayon-h">                </span><span class="crayon-v">filings</span><span class="crayon-sy">.</span><span class="crayon-e">extend</span><span class="crayon-sy">(</span><span class="crayon-v">result</span><span class="crayon-sy">[</span><span class="crayon-s">'results'</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-s">'filings'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59b3f14a54606830390-75"><span class="crayon-h">                </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a54606830390-76"><span class="crayon-h">            </span><span class="crayon-v">count</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></p><p class="crayon-line" id="crayon-56d59b3f14a54606830390-77"><span class="crayon-h">            </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a54606830390-78"><span class="crayon-h">        </span><span class="crayon-k ">print</span><span class="crayon-h"> </span><span class="crayon-s">"[*] Retrieved %d filing records."</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-k ">len</span><span class="crayon-sy">(</span><span class="crayon-v">filings</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59b3f14a54606830390-79"><span class="crayon-h">        </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a54606830390-80"><span class="crayon-h">        </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">filings</span></p><p class="crayon-line" id="crayon-56d59b3f14a54606830390-81"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a54606830390-82"><span class="crayon-e">    </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">None</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>Ok, a bit more code to wrangle here but we’ll make it through it:</p>
<ul>
<li><strong>Line 46: </strong>we define our <strong>corporate_filings </strong>function to take in the <em>corporation_id </em>parameter returned from our corporate search and of course the <em>jurisdiction.</em></li>
<li><b>Line 48: </b>here we are constructing our API url that will tell OpenCorporates to shoot us back the first page of filings results.</li>
<li><strong>Line 58: </strong>we take the results from our search and store them in our <em>filings </em>variable that will hold all of the corporate filings.</li>
<li><strong>Line 61-62: </strong>as we can only retrieve 30 results from the API, we grab the total number of pages (61) and then initialize a counter (62) so that we can continue making calls to OpenCorporates to retrieve all of the records.</li>
<li><strong>Lines 64-76: </strong>this big <em>while </em>loop will just continually tack on the <em>page </em>parameter to our filings request (66), send off the request (68), parse (72) and store the results (74). Then we increment the page counter (76) and carry on until we have retrieved all of the filings.</li>
</ul>
<p>Once we have looped over all of the available filings, we return the list back. Now that we have a list of filings we need to massage them into a CSV file that has the proper structure that TimelineJS is looking for. Let’s implement this function now:</p>

		<div id="crayon-56d59b3f14a5e922316086" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a5e922316086-84">84</p><p class="crayon-num" data-line="crayon-56d59b3f14a5e922316086-85">85</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a5e922316086-86">86</p><p class="crayon-num" data-line="crayon-56d59b3f14a5e922316086-87">87</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a5e922316086-88">88</p><p class="crayon-num" data-line="crayon-56d59b3f14a5e922316086-89">89</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a5e922316086-90">90</p><p class="crayon-num" data-line="crayon-56d59b3f14a5e922316086-91">91</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a5e922316086-92">92</p><p class="crayon-num" data-line="crayon-56d59b3f14a5e922316086-93">93</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a5e922316086-94">94</p><p class="crayon-num" data-line="crayon-56d59b3f14a5e922316086-95">95</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a5e922316086-96">96</p><p class="crayon-num" data-line="crayon-56d59b3f14a5e922316086-97">97</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a5e922316086-98">98</p><p class="crayon-num" data-line="crayon-56d59b3f14a5e922316086-99">99</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a5e922316086-100">100</p><p class="crayon-num" data-line="crayon-56d59b3f14a5e922316086-101">101</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a5e922316086-102">102</p><p class="crayon-num" data-line="crayon-56d59b3f14a5e922316086-103">103</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a5e922316086-104">104</p><p class="crayon-num" data-line="crayon-56d59b3f14a5e922316086-105">105</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a5e922316086-106">106</p><p class="crayon-num" data-line="crayon-56d59b3f14a5e922316086-107">107</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a5e922316086-108">108</p><p class="crayon-num" data-line="crayon-56d59b3f14a5e922316086-109">109</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a5e922316086-110">110</p><p class="crayon-num" data-line="crayon-56d59b3f14a5e922316086-111">111</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a5e922316086-112">112</p><p class="crayon-num" data-line="crayon-56d59b3f14a5e922316086-113">113</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a5e922316086-114">114</p><p class="crayon-num" data-line="crayon-56d59b3f14a5e922316086-115">115</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a5e922316086-116">116</p><p class="crayon-num" data-line="crayon-56d59b3f14a5e922316086-117">117</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a5e922316086-118">118</p><p class="crayon-num" data-line="crayon-56d59b3f14a5e922316086-119">119</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a5e922316086-120">120</p><p class="crayon-num" data-line="crayon-56d59b3f14a5e922316086-121">121</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a5e922316086-122">122</p><p class="crayon-num" data-line="crayon-56d59b3f14a5e922316086-123">123</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a5e922316086-124">124</p><p class="crayon-num" data-line="crayon-56d59b3f14a5e922316086-125">125</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a5e922316086-126">126</p><p class="crayon-num" data-line="crayon-56d59b3f14a5e922316086-127">127</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a5e922316086-128">128</p><p class="crayon-num" data-line="crayon-56d59b3f14a5e922316086-129">129</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a5e922316086-84"><span class="crayon-c">#</span></p><p class="crayon-line" id="crayon-56d59b3f14a5e922316086-85"><span class="crayon-c"># Build a timeline using the TimelineJS template</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a5e922316086-86"><span class="crayon-c"># </span></p><p class="crayon-line" id="crayon-56d59b3f14a5e922316086-87"><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">build_timeline</span><span class="crayon-sy">(</span><span class="crayon-v">filings</span><span class="crayon-sy">,</span><span class="crayon-v">corporate_name</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a5e922316086-88"><span class="crayon-h">    </span></p><p class="crayon-line" id="crayon-56d59b3f14a5e922316086-89"><span class="crayon-h">    </span><span class="crayon-v">fields</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a5e922316086-90"><span class="crayon-h">        </span><span class="crayon-s">'Year'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'Month'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'Day'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'Time'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'End Year'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span></p><p class="crayon-line" id="crayon-56d59b3f14a5e922316086-91"><span class="crayon-h">        </span><span class="crayon-s">'End Month'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'End Day'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'End Time'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'Display Date'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a5e922316086-92"><span class="crayon-h">        </span><span class="crayon-s">'Headline'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'Text'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'Media'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'Media Credit'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'Media Caption'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span></p><p class="crayon-line" id="crayon-56d59b3f14a5e922316086-93"><span class="crayon-h">        </span><span class="crayon-s">'Media Thumbnail'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'Type'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'Group'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'Background'</span><span class="crayon-sy">]</span><span class="crayon-h"> </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a5e922316086-94"><span class="crayon-h">    </span></p><p class="crayon-line" id="crayon-56d59b3f14a5e922316086-95"><span class="crayon-h">    </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-k ">os.path</span><span class="crayon-sy">.</span><span class="crayon-e">exists</span><span class="crayon-sy">(</span><span class="crayon-v">timeline_file</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a5e922316086-96"><span class="crayon-h">        </span><span class="crayon-v">write_header</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">True</span></p><p class="crayon-line" id="crayon-56d59b3f14a5e922316086-97"><span class="crayon-h">    </span><span class="crayon-st">else</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a5e922316086-98"><span class="crayon-h">        </span><span class="crayon-v">write_header</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">False</span></p><p class="crayon-line" id="crayon-56d59b3f14a5e922316086-99"><span class="crayon-h">    </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a5e922316086-100"><span class="crayon-h">    </span><span class="crayon-st">with</span><span class="crayon-h"> </span><span class="crayon-k ">open</span><span class="crayon-sy">(</span><span class="crayon-v">timeline_file</span><span class="crayon-sy">,</span><span class="crayon-s">"ab"</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">as</span><span class="crayon-h"> </span><span class="crayon-v">output</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d59b3f14a5e922316086-101"><span class="crayon-h">        </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a5e922316086-102"><span class="crayon-h">        </span><span class="crayon-v">writer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">csv</span><span class="crayon-sy">.</span><span class="crayon-e">DictWriter</span><span class="crayon-sy">(</span><span class="crayon-v">output</span><span class="crayon-sy">,</span><span class="crayon-v">fieldnames</span><span class="crayon-o">=</span><span class="crayon-v">fields</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59b3f14a5e922316086-103"><span class="crayon-h">        </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a5e922316086-104"><span class="crayon-h">        </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">write_header </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-t">True</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d59b3f14a5e922316086-105"><span class="crayon-h">            </span><span class="crayon-v">writer</span><span class="crayon-sy">.</span><span class="crayon-e">writeheader</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a5e922316086-106"><span class="crayon-h">        </span></p><p class="crayon-line" id="crayon-56d59b3f14a5e922316086-107"><span class="crayon-h">        </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a5e922316086-108"><span class="crayon-h">        </span><span class="crayon-c"># add each corporate filing to the spreadsheet</span></p><p class="crayon-line" id="crayon-56d59b3f14a5e922316086-109"><span class="crayon-h">        </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">filing </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">filings</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a5e922316086-110"><span class="crayon-h">            </span></p><p class="crayon-line" id="crayon-56d59b3f14a5e922316086-111"><span class="crayon-h">            </span><span class="crayon-v">year</span><span class="crayon-sy">,</span><span class="crayon-v">month</span><span class="crayon-sy">,</span><span class="crayon-v">day</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">filing</span><span class="crayon-sy">[</span><span class="crayon-s">'filing'</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-s">'date'</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">"-"</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a5e922316086-112"><span class="crayon-h">            </span></p><p class="crayon-line" id="crayon-56d59b3f14a5e922316086-113"><span class="crayon-h">            </span><span class="crayon-v">record</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a5e922316086-114"><span class="crayon-h">            </span><span class="crayon-v">record</span><span class="crayon-sy">[</span><span class="crayon-s">'Year'</span><span class="crayon-sy">]</span><span class="crayon-h">  </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">year</span></p><p class="crayon-line" id="crayon-56d59b3f14a5e922316086-115"><span class="crayon-e">            </span><span class="crayon-v">record</span><span class="crayon-sy">[</span><span class="crayon-s">'Month'</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">month</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a5e922316086-116"><span class="crayon-e">            </span><span class="crayon-v">record</span><span class="crayon-sy">[</span><span class="crayon-s">'Day'</span><span class="crayon-sy">]</span><span class="crayon-h">   </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">day</span></p><p class="crayon-line" id="crayon-56d59b3f14a5e922316086-117"><span class="crayon-e">            </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a5e922316086-118"><span class="crayon-e">            </span><span class="crayon-v">record</span><span class="crayon-sy">[</span><span class="crayon-s">'Display Date'</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">filing</span><span class="crayon-sy">[</span><span class="crayon-s">'filing'</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-s">'date'</span><span class="crayon-sy">]</span></p><p class="crayon-line" id="crayon-56d59b3f14a5e922316086-119"><span class="crayon-h">            </span><span class="crayon-v">record</span><span class="crayon-sy">[</span><span class="crayon-s">'Headline'</span><span class="crayon-sy">]</span><span class="crayon-h">     </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"%s - %s"</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">corporate_name</span><span class="crayon-sy">,</span><span class="crayon-v">filing</span><span class="crayon-sy">[</span><span class="crayon-s">'filing'</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-s">'title'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a5e922316086-120"><span class="crayon-h">            </span><span class="crayon-v">record</span><span class="crayon-sy">[</span><span class="crayon-s">'Text'</span><span class="crayon-sy">]</span><span class="crayon-h">         </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"View record &lt;a href='%s'&gt;here&lt;/a&gt;"</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">filing</span><span class="crayon-sy">[</span><span class="crayon-s">'filing'</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-s">'opencorporates_url'</span><span class="crayon-sy">]</span></p><p class="crayon-line" id="crayon-56d59b3f14a5e922316086-121"><span class="crayon-h">            </span><span class="crayon-v">record</span><span class="crayon-sy">[</span><span class="crayon-s">'Group'</span><span class="crayon-sy">]</span><span class="crayon-h">        </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">corporate_name</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a5e922316086-122"><span class="crayon-e">            </span></p><p class="crayon-line" id="crayon-56d59b3f14a5e922316086-123"><span class="crayon-e">            </span><span class="crayon-v">writer</span><span class="crayon-sy">.</span><span class="crayon-e">writerow</span><span class="crayon-sy">(</span><span class="crayon-v">record</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a5e922316086-124"><span class="crayon-h">            </span></p><p class="crayon-line" id="crayon-56d59b3f14a5e922316086-125"><span class="crayon-h">        </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a5e922316086-126"><span class="crayon-h">        </span><span class="crayon-k ">print</span><span class="crayon-h"> </span><span class="crayon-s">"[*] Added records to spreadsheet: %s"</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">timeline_file</span></p><p class="crayon-line" id="crayon-56d59b3f14a5e922316086-127"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a5e922316086-128"> </p><p class="crayon-line" id="crayon-56d59b3f14a5e922316086-129"><span class="crayon-e">        </span><span class="crayon-st">return</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>Alright, let’s break this bad boy down a bit:</p>
<ul>
<li><strong>Line 87: </strong>here we define our <strong>build_timeline </strong>function to take in the list of <em>filings </em>and the<em> corporate_name </em>they are associated to<em>.</em></li>
<li><strong>Lines 89-93: </strong>this is the big list of fields that I copied from the TimelineJS spreadsheet template, these are required in order for your timeline to render correctly.</li>
<li><strong>Lines 95-98: </strong>here we are simply checking for the presence of the target CSV file. If the file does not exist, we will write the spreadsheet header, and if it does exist we’ll just start adding records to the end of the spreadsheet.</li>
<li><strong>Lines 100-105: </strong>we crack open our output file (100) and then initialize our CSV writer (102) passing in the file handle and our list of fields (102). As I mentioned, if this is a new file (104) we write out the header row in the spreadsheet (105).</li>
<li><b>Lines 109-123: </b>this is the real meat and potatoes of this function. We are looping over each filing (109), we split out the date field (111) that is stored in YYYY-MM-DD format and then populate our dictionary with all of the information we want to show in the timeline. The last step is to write out the data into the spreadsheet (123).</li>
</ul>
<p>The only thing left to do is to add the function calls in to the bottom of our script to kick the whole thing off:</p>

		<div id="crayon-56d59b3f14a68485898340" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-56d59b3f14a68485898340-131">131</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a68485898340-132">132</p><p class="crayon-num" data-line="crayon-56d59b3f14a68485898340-133">133</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a68485898340-134">134</p><p class="crayon-num" data-line="crayon-56d59b3f14a68485898340-135">135</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a68485898340-136">136</p><p class="crayon-num" data-line="crayon-56d59b3f14a68485898340-137">137</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a68485898340-138">138</p><p class="crayon-num" data-line="crayon-56d59b3f14a68485898340-139">139</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a68485898340-140">140</p><p class="crayon-num" data-line="crayon-56d59b3f14a68485898340-141">141</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59b3f14a68485898340-142">142</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d59b3f14a68485898340-131"><span class="crayon-c"># find the company</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a68485898340-132"><span class="crayon-v">corporate_id</span><span class="crayon-sy">,</span><span class="crayon-v">corporate_name</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">corporation_search</span><span class="crayon-sy">(</span><span class="crayon-v">company</span><span class="crayon-sy">,</span><span class="crayon-v">jurisdiction</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59b3f14a68485898340-133"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a68485898340-134"><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">corporate_id </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-t">None</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d59b3f14a68485898340-135"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a68485898340-136"><span class="crayon-h">    </span><span class="crayon-c"># extract all filings</span></p><p class="crayon-line" id="crayon-56d59b3f14a68485898340-137"><span class="crayon-h">    </span><span class="crayon-v">filings</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">corporate_filings</span><span class="crayon-sy">(</span><span class="crayon-v">corporate_id</span><span class="crayon-sy">,</span><span class="crayon-v">jurisdiction</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a68485898340-138"> </p><p class="crayon-line" id="crayon-56d59b3f14a68485898340-139"><span class="crayon-h">    </span><span class="crayon-c"># build a timeline</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a68485898340-140"><span class="crayon-h">    </span><span class="crayon-e">build_timeline</span><span class="crayon-sy">(</span><span class="crayon-v">filings</span><span class="crayon-sy">,</span><span class="crayon-v">corporate_name</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59b3f14a68485898340-141"><span class="crayon-st">else</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59b3f14a68485898340-142"><span class="crayon-h">    </span><span class="crayon-k ">print</span><span class="crayon-h"> </span><span class="crayon-s">"[!!!] Failed to retrieve corporation. Please check the name."</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>This code you can see is just simply calling our functions that we just poured all of that blood, sweat and tears into. Let’s see what happens when we give it a run.</p>
<h2>Let It Rip</h2>
<p>So if you have a quick review of the CBC article I mentioned earlier, there were three corporate entities that stuck out to me. There are likely more, but these are the ones that I started with:</p>
<ol>
<li>Lochside Limited</li>
<li>Korderry Limited</li>
<li>Ogral Company Limited</li>
</ol>
<p>They are all located in the very tax friendly Isle of Man (country code <strong>im</strong>). So my commandline arguments looked like so:</p>
<p># python followthemoney.py -c “Lochside Limited” -j im -t cbcstory.csv</p>
<p># python followthemoney.py -c “Korderry Limited” -j im -t cbcstory.csv</p>
<p># python followthemoney.py -c “Ogral Company Limited” -j im cbcstory.csv</p>
<p>Now I know we could build all kinds of intelligence into the commandline to handle multiple companies, etc. but this works perfectly fine for our purposes (feel free to do some homework and improve it my friends). Now go over to your Google Drive, create a new spreadsheet, go to the File menu and select import and use the “Replace current sheet” option.</p>
<p>Go to the TimelineJS page <a href="http://timeline3.knightlab.com/" target="_blank">here</a> and follow their steps to get your timeline spreadsheet published, and generate a preview.  When you’re done you should be able to explore the data and even embed it in your own website like so:</p>
<p> </p>
<p> </p>
<p/>
<p>Pretty neat stuff! You might want to zoom in a long ways if you have lots of records (as these companies do) but what looked pretty interesting to me is the patterns that come out, and then comparing dates in the revenue agency’s timelines in the court documents. There is a lot more we can do with the OpenCorporates API but building timelines around corporate filings when there is some legal scrutiny can definitely be interesting.</p>
				</div>
										</div></body></html>