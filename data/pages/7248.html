<html><body><div><div class="post-text" itemprop="text">

<p>I am developing a dll that should be used in Python. I have a callback function to send my parameters (defined in a separate header):</p>

<p><code>typedef int(*call_nBest)(char **OutList, float* confList, int nB);</code></p>

<p>So, I'm using this callback in this way:</p>

<pre><code>#define TEXT_BUFFER_MAX_SIZE 50
call_nBest nBestList;
void Xfunction(const char* aLineThatWillBeConvertedInAList){
    char **results;
    float *confidences;
    confidences=new float[nBest];
    results=new char*[nBest];
    for(int i=0; i&lt;nBest; i++) results[i]=new char[TEXT_BUFFER_MAX_SIZE];

    MakeLine2List(aLineThatWillBeConvertedInAList,results,confidences); 

    /*At this function I am having the error :(*/
    nBestList(results,confidences,nBest); // Passing the values to my callback

    for(int i=0; i&lt;nBest; i++) delete [] results[i];
    delete [] confidences;
    delete [] results;

}
</code></pre>

<p>And I'm exporting it in this way:</p>

<pre><code>__declspec(dllexport) int ResultCallback(call_nBest theList){
    nBestList = theList;
    return(0);
}
</code></pre>

<p>I tested my callback first in another C++ application in this way:</p>

<pre><code>int MyCallback(char **OutLi, float* confLi, int nB){
    printf("\n The nB results: %d \n",nB);
    for(int n=0; n&lt;nB; n++){
        std::cout &lt;&lt; *(confLi+n) &lt;&lt; "\t" &lt;&lt; OutLi[n] &lt;&lt; "\n";
    }
    return(0);
}
</code></pre>

<p>In <code>main()</code> I give the callback in this way:</p>

<pre><code>ResultCallback(MyCallback);
</code></pre>

<p>and it works pretty well. But I don't have any idea how to adapt this to Python. I have tried this: </p>

<p><strong>Note:</strong> I have changed the last way, because I resolved some mistakes, but I'm still getting an error. This is the current way of how I am loading <code>myDLL</code></p>

<pre><code>from ctypes import *
def callbackU(OutList,ConList,nB):
    for i in range(nB):
        print(OutList[i][0:50]) #I don't know how to print the values
return 0

myDLL = cdll.LoadLibrary("MyLibrary.dll")

calling = CFUNCTYPE(c_int,POINTER(POINTER(c_char)),POINTER(c_float),c_int)
theCall= calling(callbackU)
myDLL.ResultCallback(theCall)

myDLL.StartProcess(); #In this process the given callback will be invoqued
</code></pre>

<h2> ERROR </h2>

<p>And now I have this error:</p>

<blockquote>
  <p>Unhandled Exception: System.AccessViolationException: Attempted to
  read or write protected memory. This is often an indication that other
  memory is corrupt.    at Xfunction(SByte*
  aLineThatWillBeConvertedInAList)</p>
  
  <h3>Problem signature:</h3>
  
  <p>Problem Event Name:  APPCRASH<br/>
   Application Name:    python.exe<br/>
   Application Version: 0.0.0.0<br/>
   Application Timestamp:   54f9ed12<br/>
   Fault Module Name:   MSVCR100.dll<br/>
   Fault Module Version:    10.0.40219.325<br/>
   Fault Module Timestamp:  10.0.40219.325<br/>
   Exception Code:  c0000005<br/>
   Exception Offset:    00001ed7<br/>
   OS Version:  6.3.9600.2.0.0.256.4<br/>
   Locale ID:   1033<br/>
   Additional Information 1:    5861<br/>
   Additional Information 2:    5861822e1919d7c014bbb064c64908b2<br/>
   Additional Information 3:    a10f<br/>
   Additional Information 4:    a10ff7d2bb2516fdc753f9c34fc3b069</p>
</blockquote>

<h3>Things that I've done and are almost what I want:</h3>

<p>First I changed the callback Python function for this one:</p>

<pre><code>def callbackU(OutList,ConList,nB):
    for i in range(nB):
        print(i)
return 0
</code></pre>

<p>All works with no error and I can see this in the Console (in this case <code>nB</code> was <code>10</code>):</p>

<pre><code>0
1
...
9
</code></pre>

<p>Second, I changed the function as this one:</p>

<pre><code>def callbackU(OutList,ConList,nB):
    for i in range(nB):
        print (cast(OutList,c_char_p))
return 0
</code></pre>

<p>and, oh surprise this prints only the first word of the list (nB times)</p>
    </div>
    </div></body></html>