<html><body><div><div class="entry-content" itemprop="text"><h2>The Dashboard</h2>
<p>A few weeks ago, we thought about building a Google analytics dashboard to give us easy access to certain elements of our Google Analytics web traffic. We saw some custom dashboards for bloggers, but nothing quite right for our goal, since we wanted the data on a big screen for everyone in the office to view.</p>
<p>One solution would of been to install some browser add-on which would refresh that page, but that was just too easy and too boring and I wanted to make customisations. So I decided to check out <a href="https://developers.google.com/analytics/devguides/reporting/embed/v1/" target="_blank">Google Embed API</a>. You only have to serve your HTML files there with the code for dashboards and authorisation. Looks quite simple, although since I am a Python developer – I wanted to make it in Python.</p>
<p>Knowing that I will have to deal with multiple connections at once (making numerous queries for the dashboard) – I chose <a href="http://www.tornadoweb.org/en/stable/" target="_blank">Tornado web framework</a> which is almost ideal for such applications (and fun!). Making calls to external services asynchronously and waiting for response is what Tornado is really good at, and thus copes with multiple connections very well. By using it’s IO loop you can asynchronously query multiple external web services with only little footprint to your server’s performance. In this article – I will show you how to create this dashboard:</p>
<div id="attachment_27353" class="wp-caption alignnone"><a href="http://ocowl3a.wpengine.com/wp-content/uploads/2015/08/whole_dashboard.png" rel="attachment wp-att-27353"><img class="size-large wp-image-27353" src="http://ocowl3a.wpengine.com/wp-content/uploads/2015/08/whole_dashboard-1200x557.png" alt="Whole dashboard" srcset="https://opencredo.com/wp-content/uploads/2015/08/whole_dashboard-200x93.png 200w, https://opencredo.com/wp-content/uploads/2015/08/whole_dashboard-400x186.png 400w, https://opencredo.com/wp-content/uploads/2015/08/whole_dashboard-768x357.png 768w, https://opencredo.com/wp-content/uploads/2015/08/whole_dashboard-1200x557.png 1200w" sizes="(max-width: 1200px) 100vw, 1200px"/></a><p class="wp-caption-text">Click to view larger image</p></div>
<p>You can download full source code <a href="https://github.com/opencredo/tornado-analytics" target="_blank">here</a>. Pull requests with additional hacking are welcome! Or just fork it, make it better and share it:)</p>
<h2>Getting started with Google Analytics API</h2>
<p>To get started with Google Analytics API you will have to do several things first:</p>
<ul>
<li>Create a project in Google developer console.</li>
<li>Create new service account in APIs &amp; auth &gt; credentials (Service account here).</li>
<li>Generate and download client_secrets.p12 and put it somewhere where your application can find it.</li>
<li>In your Google Analytics dashboard you have to grant permissions to this service account. You can do this by using that email address that is assigned to your service account (…@developer.gserviceaccount.com)</li>
</ul>
<p>Having this done, you can start creating your authentication module in Python. I have created mine in utilities/gaclient.py :</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="python"><pre class="de1"><span class="kw1">class</span> GAcess:
   <span class="kw1">def</span> <span class="kw4">__init__</span><span class="br0">(</span><span class="kw2">self</span><span class="sy0">,</span> scope<span class="sy0">=</span><span class="br0">[</span><span class="st0">'https://www.googleapis.com/auth/analytics.readonly'</span><span class="br0">]</span><span class="sy0">,</span> key_file_location<span class="sy0">=</span><span class="kw2">None</span><span class="sy0">,</span>
                 service_account_email<span class="sy0">=</span><span class="kw2">None</span><span class="br0">)</span>:
        <span class="kw1">if</span> key_file_location <span class="kw1">is</span> <span class="kw2">None</span>:
            key_file_location <span class="sy0">=</span> <span class="kw3">os</span>.<span class="me1">path</span>.<span class="me1">dirname</span><span class="br0">(</span><span class="kw3">os</span>.<span class="me1">path</span>.<span class="me1">realpath</span><span class="br0">(</span>__file__<span class="br0">)</span><span class="br0">)</span> + <span class="st0">'/'</span> + <span class="st0">'client_secrets.p12'</span>
        <span class="co1"># getting service object</span>
        <span class="kw2">self</span>.<span class="me1">service</span> <span class="sy0">=</span> <span class="kw2">self</span>.<span class="me1">get_service</span><span class="br0">(</span><span class="st0">'analytics'</span><span class="sy0">,</span> <span class="st0">'v3'</span><span class="sy0">,</span> scope<span class="sy0">,</span> key_file_location<span class="sy0">,</span>
                                        service_account_email<span class="br0">)</span>
    <span class="kw1">def</span> get_service<span class="br0">(</span><span class="kw2">self</span><span class="sy0">,</span> api_name<span class="sy0">,</span> api_version<span class="sy0">,</span> scope<span class="sy0">,</span> key_file_location<span class="sy0">,</span>
                    service_account_email<span class="br0">)</span>:
        <span class="st0">"""Get a service that communicates to a Google API.
        Args:
          api_name: The name of the api to connect to.
          api_version: The api version to connect to.
          scope: A list auth scopes to authorize for the application.
          key_file_location: The path to a valid service account p12 key file.
          service_account_email: The service account email address.
        Returns:
          A service that is connected to the specified API.
        """</span>
        <span class="co1"># reusing saved credentials</span>
        storage <span class="sy0">=</span> Storage<span class="br0">(</span><span class="st0">"ta_saved_credentials.dat"</span><span class="br0">)</span>
        http <span class="sy0">=</span> httplib2.<span class="me1">Http</span><span class="br0">(</span><span class="br0">)</span>
        credentials <span class="sy0">=</span> storage.<span class="me1">get</span><span class="br0">(</span><span class="br0">)</span>
        <span class="kw1">if</span> credentials <span class="kw1">is</span> <span class="kw2">None</span> <span class="kw1">or</span> credentials.<span class="me1">invalid</span>:
            <span class="kw1">print</span><span class="br0">(</span><span class="st0">"credentials not found, authorizing"</span><span class="br0">)</span>
            f <span class="sy0">=</span> <span class="kw2">open</span><span class="br0">(</span>key_file_location<span class="sy0">,</span> <span class="st0">'rb'</span><span class="br0">)</span>
            key <span class="sy0">=</span> f.<span class="me1">read</span><span class="br0">(</span><span class="br0">)</span>
            f.<span class="me1">close</span><span class="br0">(</span><span class="br0">)</span>
            credentials <span class="sy0">=</span> SignedJwtAssertionCredentials<span class="br0">(</span>service_account_email<span class="sy0">,</span> key<span class="sy0">,</span> scope<span class="sy0">=</span>scope<span class="br0">)</span>
            storage.<span class="me1">put</span><span class="br0">(</span>credentials<span class="br0">)</span>
        <span class="kw1">else</span>:
            <span class="kw1">print</span><span class="br0">(</span><span class="st0">"credentials found"</span><span class="br0">)</span>
            credentials.<span class="me1">refresh</span><span class="br0">(</span>http<span class="br0">)</span>
        http <span class="sy0">=</span> credentials.<span class="me1">authorize</span><span class="br0">(</span>httplib2.<span class="me1">Http</span><span class="br0">(</span><span class="br0">)</span><span class="br0">)</span>
        <span class="co1"># Build the service object.</span>
        service <span class="sy0">=</span> build<span class="br0">(</span>api_name<span class="sy0">,</span> api_version<span class="sy0">,</span> http<span class="sy0">=</span>http<span class="br0">)</span>
        <span class="kw1">return</span> service</pre></div></div></div></div></div></div></div>


<p>This client is not thread-safe so you will have to initiate connection for each call, and you can’t just keep your communication object in app’s settings for all request handlers to use (since then they would be sharing the same connection and bad things start to happen). At least good guy Google doesn’t count authentication requests as API calls so you still have your 10 queries per second which is more than enough for this little application.</p>
<p>You also probably saw that I am storing credentials for faster access.</p>
<h3>Routing URLs to request handlers</h3>
<p>Let’s define some handlers and get some useful information about our webpage. In urls.py file we are defining all URLS that route users to specific handlers (or views if you are familiar with Django):</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="python"><pre class="de1">url_patterns <span class="sy0">=</span> <span class="br0">[</span>
    <span class="br0">(</span>r<span class="st0">"/people-sources"</span><span class="sy0">,</span> web_handlers.<span class="me1">PeopleSourcesHandler</span><span class="br0">)</span><span class="sy0">,</span>
<span class="br0">]</span></pre></div></div></div></div></div></div></div>


<p>Then, we create a BaseHandler class in handlers/base.py:</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="python"><pre class="de1"><span class="kw1">class</span> BaseHandler<span class="br0">(</span>CacheMixin<span class="sy0">,</span> tornado.<span class="me1">web</span>.<span class="me1">RequestHandler</span><span class="br0">)</span>:
    <span class="st0">"""A class to collect common handler methods - all other handlers should
    subclass this one.
    """</span>
    <span class="kw1">def</span> prepare<span class="br0">(</span><span class="kw2">self</span><span class="br0">)</span>:
        <span class="kw2">super</span><span class="br0">(</span>BaseHandler<span class="sy0">,</span> <span class="kw2">self</span><span class="br0">)</span>.<span class="me1">prepare</span><span class="br0">(</span><span class="br0">)</span>
 
    <span class="kw1">def</span> get_current_user<span class="br0">(</span><span class="kw2">self</span><span class="br0">)</span>:
        <span class="st0">"""
        Gets secure cookie containing user email address. Secure cookies are encrypted.
        :return:
        """</span>
        <span class="kw3">user</span> <span class="sy0">=</span> <span class="kw2">self</span>.<span class="me1">get_secure_cookie</span><span class="br0">(</span><span class="st0">'tracker'</span><span class="br0">)</span>
        <span class="kw1">if</span> <span class="kw3">user</span>:
            <span class="kw1">return</span> <span class="kw3">user</span>
        <span class="kw1">else</span>:
            <span class="kw1">return</span> <span class="kw2">None</span></pre></div></div></div></div></div></div></div>


<p>Don’t pay attention to CacheMixin or ‘get_current_user’ functions for now. We are basically subclassing Tornado’s default RequestHandler which carries all information about current incoming request, application settings and other useful things. Having this class defined, let’s create another file in handlers folder, called web_handlers.py. We will keep dashboard’s web handlers here, so it will be easier to separate different functionalities if we decide that this app should grow. Define a handler and corresponding gaclient function for that:</p>
<p>in gaclient.py GAcess class add additional function:</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="python"><pre class="de1"><span class="kw1">def</span> get_people_sources<span class="br0">(</span><span class="kw2">self</span><span class="sy0">,</span> profile_id<span class="sy0">=</span><span class="kw2">None</span><span class="sy0">,</span> days<span class="sy0">=</span><span class="nu0">30</span><span class="sy0">,</span> max_results<span class="sy0">=</span><span class="nu0">10</span><span class="br0">)</span>:
    results <span class="sy0">=</span> <span class="kw2">self</span>.<span class="me1">service</span>.<span class="me1">data</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">ga</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">get</span><span class="br0">(</span>
        ids<span class="sy0">=</span><span class="st0">'ga:'</span> + profile_id<span class="sy0">,</span>
        start_date<span class="sy0">=</span><span class="st0">'%sdaysAgo'</span> % days<span class="sy0">,</span>
        end_date<span class="sy0">=</span><span class="st0">'today'</span><span class="sy0">,</span>
        metrics<span class="sy0">=</span><span class="st0">'ga:sessions,ga:pageviews,ga:avgSessionDuration'</span><span class="sy0">,</span>
        dimensions<span class="sy0">=</span><span class="st0">'ga:source,ga:medium'</span><span class="sy0">,</span>
        sort<span class="sy0">=</span><span class="st0">'-ga:sessions'</span><span class="sy0">,</span>
        max_results<span class="sy0">=</span>max_results<span class="br0">)</span>.<span class="me1">execute</span><span class="br0">(</span><span class="br0">)</span>
    <span class="kw1">return</span> results</pre></div></div></div></div></div></div></div>


<p>It will execute this query and return a dictionary which we will be using in our request handler.</p>
<p>Then, define your PeopleSourcesHandler:</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="python"><pre class="de1"><span class="kw1">class</span> PeopleSourcesHandler<span class="br0">(</span>BaseHandler<span class="br0">)</span>:
    <span class="kw1">def</span> get<span class="br0">(</span><span class="kw2">self</span><span class="br0">)</span>:
        <span class="kw1">try</span>:
            service_account <span class="sy0">=</span> <span class="kw2">self</span>.<span class="me1">settings</span><span class="br0">[</span><span class="st0">'service_account_email'</span><span class="br0">]</span>
            <span class="kw2">self</span>.<span class="me1">service</span> <span class="sy0">=</span> GAcess<span class="br0">(</span>service_account_email<span class="sy0">=</span>service_account<span class="sy0">,</span>
                                  key_file_location<span class="sy0">=</span><span class="kw2">self</span>.<span class="me1">settings</span><span class="br0">[</span><span class="st0">'key_file_location'</span><span class="br0">]</span><span class="br0">)</span>
            query_result <span class="sy0">=</span> <span class="kw2">self</span>.<span class="me1">service</span>.<span class="me1">get_people_sources</span><span class="br0">(</span>profile_id<span class="sy0">=</span><span class="kw2">self</span>.<span class="me1">settings</span><span class="br0">[</span><span class="st0">'ga_profile_id'</span><span class="br0">]</span><span class="sy0">,</span>
                                                           days<span class="sy0">=</span><span class="kw2">self</span>.<span class="me1">settings</span><span class="br0">[</span><span class="st0">'start_days_ago'</span><span class="br0">]</span><span class="br0">)</span>
            <span class="kw1">try</span>:
                data <span class="sy0">=</span> query_result<span class="br0">[</span><span class="st0">'rows'</span><span class="br0">]</span>
            <span class="kw1">except</span> <span class="kw2">KeyError</span>:
                <span class="kw2">self</span>.<span class="me1">set_status</span><span class="br0">(</span><span class="nu0">400</span><span class="sy0">,</span> reason<span class="sy0">=</span><span class="st0">'Failed to fetch people source data'</span><span class="br0">)</span>
            <span class="kw1">else</span>:
                <span class="co1"># formatting seconds to more human readable version</span>
                <span class="kw1">for</span> row <span class="kw1">in</span> data:
                    m<span class="sy0">,</span> s <span class="sy0">=</span> <span class="kw2">divmod</span><span class="br0">(</span><span class="kw2">int</span><span class="br0">(</span><span class="kw2">float</span><span class="br0">(</span>row<span class="br0">[</span><span class="nu0">4</span><span class="br0">]</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">,</span> <span class="nu0">60</span><span class="br0">)</span>
                    h<span class="sy0">,</span> m <span class="sy0">=</span> <span class="kw2">divmod</span><span class="br0">(</span>m<span class="sy0">,</span> <span class="nu0">60</span><span class="br0">)</span>
                    row<span class="br0">[</span><span class="nu0">4</span><span class="br0">]</span> <span class="sy0">=</span> <span class="st0">"%d:%02d:%02d"</span> % <span class="br0">(</span>h<span class="sy0">,</span> m<span class="sy0">,</span> s<span class="br0">)</span>
                table_title <span class="sy0">=</span> <span class="st0">'How did people found our pages?'</span>
                headers <span class="sy0">=</span> <span class="br0">[</span><span class="st0">'Source'</span><span class="sy0">,</span> <span class="st0">'Medium'</span><span class="sy0">,</span> <span class="st0">'Sessions'</span><span class="sy0">,</span> <span class="st0">'Page views'</span><span class="sy0">,</span> <span class="st0">'Avg. duration'</span><span class="br0">]</span>
                <span class="kw1">return</span> <span class="kw2">self</span>.<span class="me1">render_string</span><span class="br0">(</span><span class="st0">'webhandler/data_table.html'</span><span class="sy0">,</span>
                                          data<span class="sy0">=</span>data<span class="sy0">,</span>
                                          table_title<span class="sy0">=</span>table_title<span class="sy0">,</span>
                                          headers<span class="sy0">=</span>headers<span class="br0">)</span>
        <span class="kw1">except</span> <span class="kw2">Exception</span> <span class="kw1">as</span> ex:
            <span class="kw2">self</span>.<span class="me1">set_status</span><span class="br0">(</span><span class="nu0">403</span><span class="br0">)</span>
            <span class="kw1">return</span> <span class="kw2">self</span>.<span class="me1">render_string</span><span class="br0">(</span><span class="st0">'error.html'</span><span class="sy0">,</span>
                                      error<span class="sy0">=</span>ex<span class="br0">)</span></pre></div></div></div></div></div></div></div>


<p>Notice, that we are taking ‘rows’ key from the query result, it’s the key which holds information that we need. This is a default place where you will be looking for results in your queries. Also, since API returns seconds<br/>
spent in your website. Luckily, there is an excellent function in python called divmod which is ideal for situations like this. Let’s change that to hours:minutes:seconds format which is a bit more pleasant for humans:</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="python"><pre class="de1"><span class="kw1">for</span> row <span class="kw1">in</span> data:
   m<span class="sy0">,</span> s <span class="sy0">=</span> <span class="kw2">divmod</span><span class="br0">(</span><span class="kw2">int</span><span class="br0">(</span><span class="kw2">float</span><span class="br0">(</span>row<span class="br0">[</span><span class="nu0">4</span><span class="br0">]</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">,</span> <span class="nu0">60</span><span class="br0">)</span>
   h<span class="sy0">,</span> m <span class="sy0">=</span> <span class="kw2">divmod</span><span class="br0">(</span>m<span class="sy0">,</span> <span class="nu0">60</span><span class="br0">)</span>
   row<span class="br0">[</span><span class="nu0">4</span><span class="br0">]</span> <span class="sy0">=</span> <span class="st0">"%d:%02d:%02d"</span> % <span class="br0">(</span>h<span class="sy0">,</span> m<span class="sy0">,</span> s<span class="br0">)</span></pre></div></div></div></div></div></div></div>


<p>For front-end we will be using Tornado’s native template engine which is quite powerful (and weird) since you can basically do anything you want there (oh, you can’t easily implement coroutines there if you were thinking about it and I am not sure why you were thinking about it). From my Django days I know that it’s not really a good thing to put too much logic in your templates so we will keep them as simple as possible. Create a new directory in your project root called templates, then sub directory webhandler and add new template called data_table.html. Copy template code from <a href="https://github.com/opencredo/tornado-analytics/blob/master/templates/webhandler/data_table.html" target="_blank">here</a>. We are making it as dynamic as possible so we can reuse it for all our tables. If you include base.html and index.html from my repo: you should see something like this:</p>
<p><img class="size-full wp-image-27356" src="http://ocowl3a.wpengine.com/wp-content/uploads/2015/08/people_sources.png" alt="people sources" srcset="https://opencredo.com/wp-content/uploads/2015/08/people_sources-200x122.png 200w, https://opencredo.com/wp-content/uploads/2015/08/people_sources-400x244.png 400w, https://opencredo.com/wp-content/uploads/2015/08/people_sources.png 626w" sizes="(max-width: 626px) 100vw, 626px"/></p>
<h3>Unblocking blocking functions</h3>
<p>If you keep adding more web handlers – you will notice that google python client only has a blocking version of it, so you have two options – use Requests module (or in our case we could use Tornado’s AsyncHTTPClient, which does the same, except it doesn’t block your application) or we could use native google-api-python-client and use Tornado’s function that allows executing these blocking calls in ThreadPoolExecutor. I chose going with the second option since there is quite an elegant way (you can find a blog post about it <a href="http://lbolla.info/blog/2013/01/22/blocking-tornado" target="_blank">here</a>) to do it, creating a decorator:</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="python"><pre class="de1"><span class="kw1">def</span> unblock<span class="br0">(</span>f<span class="br0">)</span>:
    <span class="sy0">@</span>tornado.<span class="me1">web</span>.<span class="me1">asynchronous</span>
    <span class="sy0">@</span>wraps<span class="br0">(</span>f<span class="br0">)</span>
    <span class="kw1">def</span> wrapper<span class="br0">(</span>*args<span class="sy0">,</span> **kwargs<span class="br0">)</span>:
        <span class="kw2">self</span> <span class="sy0">=</span> args<span class="br0">[</span><span class="nu0">0</span><span class="br0">]</span>
        <span class="kw1">def</span> callback<span class="br0">(</span>future<span class="br0">)</span>:
            <span class="kw2">self</span>.<span class="me1">write</span><span class="br0">(</span>future.<span class="me1">result</span><span class="br0">(</span><span class="br0">)</span><span class="br0">)</span>
            <span class="kw2">self</span>.<span class="me1">finish</span><span class="br0">(</span><span class="br0">)</span>
        EXECUTOR.<span class="me1">submit</span><span class="br0">(</span>
            partial<span class="br0">(</span>f<span class="sy0">,</span> *args<span class="sy0">,</span> **kwargs<span class="br0">)</span>
        <span class="br0">)</span>.<span class="me1">add_done_callback</span><span class="br0">(</span>
            <span class="kw1">lambda</span> future: tornado.<span class="me1">ioloop</span>.<span class="me1">IOLoop</span>.<span class="me1">instance</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">add_callback</span><span class="br0">(</span>
                partial<span class="br0">(</span>callback<span class="sy0">,</span> future<span class="br0">)</span><span class="br0">)</span><span class="br0">)</span>
    <span class="kw1">return</span> wrapper</pre></div></div></div></div></div></div></div>


<p>Then, we just wrap our handler with it:</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="python"><pre class="de1"><span class="kw1">class</span> PeopleSourcesHandler<span class="br0">(</span>BaseHandler<span class="br0">)</span>:
    <span class="sy0">@</span>unblock
    <span class="kw1">def</span> get<span class="br0">(</span><span class="kw2">self</span><span class="br0">)</span>:
      …</pre></div></div></div></div></div></div></div>


<p>And here it is, our blocking function becomes non-blocking.  However, keep in mind that this feature delegates task to another thread.</p>
<h3>Coroutines</h3>
<p>Unblocking one call is quite good with that little snippet, although you can run into callback hell if you would want to create multiple callbacks in one handler. That’s where coroutines come in. Let’s imagine a scenario where we would want to list our most viewed pages, and view how many times they were shared on Facebook, Twitter and LinkedIn. All these social networks provide lightweight and fast endpoints for this specific operation. So, if we have a list of our top 10 pages, then to get that list we need 1 call to Google API, and then 30 calls to those social networks. How long it would take to do that in synchronous fashion? I don’t know and I probably don’t want to find out.</p>
<p>First, let’s define a routing rule for this:</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="python"><pre class="de1"><span class="br0">(</span>r<span class="st0">"/top-pages"</span><span class="sy0">,</span> web_handlers.<span class="me1">TopPagesHandler</span><span class="br0">)</span><span class="sy0">,</span></pre></div></div></div></div></div></div></div>


<p>Then, create a function in our gaclient.py:</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="python"><pre class="de1"><span class="kw1">def</span> get_top_pages<span class="br0">(</span><span class="kw2">self</span><span class="sy0">,</span> profile_id<span class="sy0">=</span><span class="kw2">None</span><span class="sy0">,</span> days<span class="sy0">=</span><span class="nu0">30</span><span class="sy0">,</span> max_results<span class="sy0">=</span><span class="nu0">10</span><span class="br0">)</span>:
    results <span class="sy0">=</span> <span class="kw2">self</span>.<span class="me1">service</span>.<span class="me1">data</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">ga</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">get</span><span class="br0">(</span>
        ids<span class="sy0">=</span><span class="st0">'ga:'</span> + profile_id<span class="sy0">,</span>
        start_date<span class="sy0">=</span><span class="st0">'%sdaysAgo'</span> % days<span class="sy0">,</span>
        end_date<span class="sy0">=</span><span class="st0">'today'</span><span class="sy0">,</span>
 	  metrics<span class="sy0">=</span><span class="st0">'ga:pageviews,
                ga:uniquePageviews,
                ga:avgTimeOnPage,ga:bounces,ga:entrances,ga:exits'</span><span class="sy0">,</span>
        dimensions<span class="sy0">=</span><span class="st0">'ga:pagePath'</span><span class="sy0">,</span>
        max_results<span class="sy0">=</span>max_results<span class="sy0">,</span>
        sort<span class="sy0">=</span><span class="st0">'-ga:pageviews'</span><span class="br0">)</span>.<span class="me1">execute</span><span class="br0">(</span><span class="br0">)</span>
    <span class="kw1">return</span> results</pre></div></div></div></div></div></div></div>


<p>And a handler to call it:</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="python"><pre class="de1"><span class="kw1">class</span> TopPagesHandler<span class="br0">(</span>BaseHandler<span class="br0">)</span>:
    <span class="sy0">@</span>gen.<span class="me1">coroutine</span>
    <span class="kw1">def</span> get<span class="br0">(</span><span class="kw2">self</span><span class="br0">)</span>:
        <span class="kw1">try</span>:
            service_account <span class="sy0">=</span> <span class="kw2">self</span>.<span class="me1">settings</span><span class="br0">[</span><span class="st0">'service_account_email'</span><span class="br0">]</span>
            <span class="kw2">self</span>.<span class="me1">service</span> <span class="sy0">=</span> GAcess<span class="br0">(</span>service_account_email<span class="sy0">=</span>service_account<span class="sy0">,</span>
                                  key_file_location<span class="sy0">=</span><span class="kw2">self</span>.<span class="me1">settings</span><span class="br0">[</span><span class="st0">'key_file_location'</span><span class="br0">]</span><span class="br0">)</span>
            query_result <span class="sy0">=</span> <span class="kw2">self</span>.<span class="me1">service</span>.<span class="me1">get_top_pages</span><span class="br0">(</span>profile_id<span class="sy0">=</span><span class="kw2">self</span>.<span class="me1">settings</span><span class="br0">[</span><span class="st0">'ga_profile_id'</span><span class="br0">]</span><span class="sy0">,</span>
                                                      days<span class="sy0">=</span><span class="kw2">self</span>.<span class="me1">settings</span><span class="br0">[</span><span class="st0">'start_days_ago'</span><span class="br0">]</span><span class="br0">)</span>
            <span class="kw1">try</span>:
                data <span class="sy0">=</span> query_result<span class="br0">[</span><span class="st0">'rows'</span><span class="br0">]</span>
            <span class="kw1">except</span> <span class="kw2">KeyError</span>:
                <span class="kw2">self</span>.<span class="me1">set_status</span><span class="br0">(</span><span class="nu0">400</span><span class="sy0">,</span> reason<span class="sy0">=</span><span class="st0">'Failed to fetch top pages data'</span><span class="br0">)</span>
            <span class="kw1">else</span>:
                <span class="co1"># formatting seconds to more human readable version and creating urls list</span>
                urls <span class="sy0">=</span> <span class="br0">[</span><span class="br0">]</span>
                <span class="kw1">for</span> row <span class="kw1">in</span> data:
                    m<span class="sy0">,</span> s <span class="sy0">=</span> <span class="kw2">divmod</span><span class="br0">(</span><span class="kw2">int</span><span class="br0">(</span><span class="kw2">float</span><span class="br0">(</span>row<span class="br0">[</span><span class="nu0">3</span><span class="br0">]</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">,</span> <span class="nu0">60</span><span class="br0">)</span>
                    h<span class="sy0">,</span> m <span class="sy0">=</span> <span class="kw2">divmod</span><span class="br0">(</span>m<span class="sy0">,</span> <span class="nu0">60</span><span class="br0">)</span>
                    row<span class="br0">[</span><span class="nu0">3</span><span class="br0">]</span> <span class="sy0">=</span> <span class="st0">"%d:%02d:%02d"</span> % <span class="br0">(</span>h<span class="sy0">,</span> m<span class="sy0">,</span> s<span class="br0">)</span>
                    urls.<span class="me1">append</span><span class="br0">(</span><span class="kw2">self</span>.<span class="me1">settings</span><span class="br0">[</span><span class="st0">'website'</span><span class="br0">]</span> + row<span class="br0">[</span><span class="nu0">0</span><span class="br0">]</span><span class="br0">)</span>
                <span class="co1"># getting social networks shares for our precious blog</span>
                facebook_shares<span class="sy0">,</span> twitter_shares<span class="sy0">,</span> linkedin_shares <span class="sy0">=</span> <span class="kw1">yield</span> <span class="br0">[</span>get_facebook_results<span class="br0">(</span>urls<span class="br0">)</span><span class="sy0">,</span>
                                                                          get_twitter_results<span class="br0">(</span>urls<span class="br0">)</span><span class="sy0">,</span>
                                                                          get_linkedin_results<span class="br0">(</span>urls<span class="br0">)</span><span class="br0">]</span>
                <span class="co1"># updating list with data</span>
                <span class="kw1">for</span> idx<span class="sy0">,</span> row <span class="kw1">in</span> <span class="kw2">enumerate</span><span class="br0">(</span>data<span class="br0">)</span>:
                    row.<span class="me1">append</span><span class="br0">(</span>facebook_shares<span class="br0">[</span>idx<span class="br0">]</span><span class="br0">)</span>
                    row.<span class="me1">append</span><span class="br0">(</span>twitter_shares<span class="br0">[</span>idx<span class="br0">]</span><span class="br0">)</span>
                    row.<span class="me1">append</span><span class="br0">(</span>linkedin_shares<span class="br0">[</span>idx<span class="br0">]</span><span class="br0">)</span>
                headers <span class="sy0">=</span> <span class="br0">[</span><span class="st0">'Path'</span><span class="sy0">,</span> <span class="st0">'Page views'</span><span class="sy0">,</span> <span class="st0">'Unique views'</span><span class="sy0">,</span> <span class="st0">'Avg. time on page'</span><span class="sy0">,</span> <span class="st0">'Bounces'</span><span class="sy0">,</span> <span class="st0">'Ent.'</span><span class="sy0">,</span> <span class="st0">'Exits'</span><span class="sy0">,</span>
                           <span class="st0">'&lt;i class="fa fa-fw fa-facebook-official"&gt;&lt;/i&gt;'</span><span class="sy0">,</span> <span class="st0">'&lt;i class="fa fa-fw fa-twitter"&gt;&lt;/i&gt;'</span><span class="sy0">,</span>
                           <span class="st0">'&lt;i class="fa fa-fw fa-linkedin"&gt;&lt;/i&gt;'</span><span class="br0">]</span>
                table_title <span class="sy0">=</span> <span class="st0">'Which posts are most popular?'</span>
                <span class="kw1">return</span> <span class="kw2">self</span>.<span class="me1">render</span><span class="br0">(</span><span class="st0">'webhandler/data_table.html'</span><span class="sy0">,</span>
                                   data<span class="sy0">=</span>data<span class="sy0">,</span>
                                   table_title<span class="sy0">=</span>table_title<span class="sy0">,</span>
                                   headers<span class="sy0">=</span>headers<span class="sy0">,</span>
                                   website<span class="sy0">=</span><span class="kw2">self</span>.<span class="me1">settings</span><span class="br0">[</span><span class="st0">'website'</span><span class="br0">]</span><span class="br0">)</span>
        <span class="kw1">except</span> <span class="kw2">Exception</span> <span class="kw1">as</span> ex:
            <span class="kw2">self</span>.<span class="me1">set_status</span><span class="br0">(</span><span class="nu0">403</span><span class="br0">)</span>
            <span class="kw1">return</span> <span class="kw2">self</span>.<span class="me1">render</span><span class="br0">(</span><span class="st0">'error.html'</span><span class="sy0">,</span>
                               error<span class="sy0">=</span>ex<span class="br0">)</span></pre></div></div></div></div></div></div></div>


<p>Interesting part here is yielding a list of multiple coroutines:</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="python"><pre class="de1"><span class="co1"># getting social networks shares for our precious blog</span>
facebook_shares<span class="sy0">,</span> twitter_shares<span class="sy0">,</span> linkedin_shares <span class="sy0">=</span> <span class="kw1">yield</span> <span class="br0">[</span>get_facebook_results<span class="br0">(</span>urls<span class="br0">)</span><span class="sy0">,</span> get_twitter_results<span class="br0">(</span>urls<span class="br0">)</span><span class="sy0">,</span>        						       get_linkedin_results<span class="br0">(</span>urls<span class="br0">)</span><span class="br0">]</span></pre></div></div></div></div></div></div></div>


<p>This way Tornado is executing them all at once because basically it’s not a CPU intensive task, it’s making a lot of calls to APIs in parallel. Define all these functions in utilities/common.py since they don’t belong in web_handlers.py. Facebook shares functions looks like this:</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="python"><pre class="de1"><span class="sy0">@</span>gen.<span class="me1">coroutine</span>
<span class="kw1">def</span> get_facebook_results<span class="br0">(</span>urls<span class="br0">)</span>:
    <span class="st0">"""
    Gets statistics for given URLs in facebook, returns a list with results
    :param urls: list of urls
    :return: list with integers (how many shares)
    """</span>
    http_client <span class="sy0">=</span> AsyncHTTPClient<span class="br0">(</span><span class="br0">)</span>
    futures_list <span class="sy0">=</span> <span class="br0">[</span><span class="br0">]</span>
    results <span class="sy0">=</span> <span class="br0">[</span><span class="br0">]</span>
    <span class="kw1">for</span> url <span class="kw1">in</span> urls:
        futures_list.<span class="me1">append</span><span class="br0">(</span>http_client.<span class="me1">fetch</span><span class="br0">(</span><span class="st0">"http://graph.facebook.com/?id="</span>+url<span class="br0">)</span><span class="br0">)</span>
    responses <span class="sy0">=</span> <span class="kw1">yield</span> futures_list
    <span class="kw1">for</span> response <span class="kw1">in</span> responses:
        <span class="kw1">try</span>:
            results.<span class="me1">append</span><span class="br0">(</span>json.<span class="me1">loads</span><span class="br0">(</span>response.<span class="me1">body</span>.<span class="me1">decode</span><span class="br0">(</span><span class="st0">'utf-8'</span><span class="br0">)</span><span class="br0">)</span><span class="br0">[</span><span class="st0">'shares'</span><span class="br0">]</span><span class="br0">)</span>
        <span class="kw1">except</span> <span class="kw2">KeyError</span>:
            results.<span class="me1">append</span><span class="br0">(</span><span class="nu0">0</span><span class="br0">)</span>
        <span class="kw1">except</span> <span class="kw2">Exception</span> <span class="kw1">as</span> ex:
            <span class="kw1">print</span><span class="br0">(</span>ex<span class="br0">)</span>
            results.<span class="me1">append</span><span class="br0">(</span><span class="nu0">0</span><span class="br0">)</span>
    <span class="kw1">return</span> results</pre></div></div></div></div></div></div></div>


<p>Here we are creating a list of http_client instances and then yielding them together, so Tornado will execute them in parallel. Then, we will be extracting ‘shares’ values from these links and returning it back to our web handler function.</p>
<p>It takes several seconds to load, but results are really appealing:</p>
<div id="attachment_27358" class="wp-caption alignnone"><a href="http://ocowl3a.wpengine.com/wp-content/uploads/2015/08/most_popular.png" rel="attachment wp-att-27358"><img class="size-full wp-image-27358" src="http://ocowl3a.wpengine.com/wp-content/uploads/2015/08/most_popular.png" alt="most popular" srcset="https://opencredo.com/wp-content/uploads/2015/08/most_popular-200x89.png 200w, https://opencredo.com/wp-content/uploads/2015/08/most_popular-400x178.png 400w, https://opencredo.com/wp-content/uploads/2015/08/most_popular-768x342.png 768w, https://opencredo.com/wp-content/uploads/2015/08/most_popular.png 921w" sizes="(max-width: 921px) 100vw, 921px"/></a><p class="wp-caption-text">Click to view larger image</p></div>
<p>Here we have our improved analytics dashboard. It was quite easy to get it, wasn’t it? Also, look at the code structure, it’s like writing your function from top to bottom without even thinking about callbacks and futures. The code is really explicit and you are always aware of what is happening.</p>
<h3>Caching</h3>
<p>Since Google API only allows 10 requests per second – we have to introduce some kind of caching. You can find CacheMixin in utilities/cache.py folder, what it does is basically check whether the request was successful and if it was – caches it to Redis.</p>
<p>I chose Redis because it can be easily integrated into any Python application and it’s also available on OpenShift. You only have to add additional decorators to your “get” methods:</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="python"><pre class="de1"><span class="kw1">class</span> TopPagesHandler<span class="br0">(</span>BaseHandler<span class="br0">)</span>:
    <span class="sy0">@</span>cache<span class="br0">(</span>CACHE_EXPIRES<span class="br0">)</span>  <span class="co1"># set the cache expires in your settings</span>
    <span class="sy0">@</span>gen.<span class="me1">coroutine</span></pre></div></div></div></div></div></div></div>


<h3>Google OAuth2</h3>
<p>You probably want to incorporate authentication/authorisation to your application? Tornado helps a lot here since it already has integrations with major players in this field. Use your google developer console to enable G+ API (find it under APIs section in your navigation bar) and then create Client ID for web application. Keep in mind that Redirect URL should point either to your web server or to your “<a href="http://localhost/">http://localhost</a>” if you you are developing! It should match your application’s redirect URL as well.</p>
<p>For our application we will be using GoogleOAuth2Mixin and have an ability whitelist people from our chosen domain. First, we have to define a handler that will be responsible for login:</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="python"><pre class="de1"><span class="kw1">class</span> GAuthLoginHandler<span class="br0">(</span>BaseHandler<span class="sy0">,</span> tornado_auth.<span class="me1">GoogleOAuth2Mixin</span><span class="br0">)</span>:
    <span class="sy0">@</span>tornado.<span class="me1">gen</span>.<span class="me1">coroutine</span>
    <span class="kw1">def</span> get<span class="br0">(</span><span class="kw2">self</span><span class="br0">)</span>:
        <span class="co1"># if user is authenticated - redirect them</span>
        <span class="kw1">if</span> <span class="kw2">self</span>.<span class="me1">get_current_user</span><span class="br0">(</span><span class="br0">)</span>:
            <span class="kw2">self</span>.<span class="me1">redirect</span><span class="br0">(</span><span class="st0">'/'</span><span class="br0">)</span>
            <span class="kw1">return</span>
        <span class="kw1">if</span> <span class="kw2">self</span>.<span class="me1">get_argument</span><span class="br0">(</span><span class="st0">'code'</span><span class="sy0">,</span> <span class="kw2">False</span><span class="br0">)</span>:
            <span class="kw3">user</span> <span class="sy0">=</span> <span class="kw1">yield</span> <span class="kw2">self</span>.<span class="me1">get_authenticated_user</span><span class="br0">(</span>redirect_uri<span class="sy0">=</span><span class="kw2">self</span>.<span class="me1">settings</span><span class="br0">[</span><span class="st0">"google_redirect_url"</span><span class="br0">]</span><span class="sy0">,</span>
                                                     <span class="kw3">code</span><span class="sy0">=</span><span class="kw2">self</span>.<span class="me1">get_argument</span><span class="br0">(</span><span class="st0">'code'</span><span class="br0">)</span><span class="br0">)</span>
            <span class="kw1">if</span> <span class="kw1">not</span> <span class="kw3">user</span>:
                <span class="kw2">self</span>.<span class="me1">clear_all_cookies</span><span class="br0">(</span><span class="br0">)</span>
                <span class="kw1">raise</span> tornado.<span class="me1">web</span>.<span class="me1">HTTPError</span><span class="br0">(</span><span class="nu0">500</span><span class="sy0">,</span> <span class="st0">'Google authentication failed'</span><span class="br0">)</span>
            access_token <span class="sy0">=</span> <span class="kw2">str</span><span class="br0">(</span><span class="kw3">user</span><span class="br0">[</span><span class="st0">'access_token'</span><span class="br0">]</span><span class="br0">)</span>
            http_client <span class="sy0">=</span> <span class="kw2">self</span>.<span class="me1">get_auth_http_client</span><span class="br0">(</span><span class="br0">)</span>
            response <span class="sy0">=</span> <span class="kw1">yield</span> http_client.<span class="me1">fetch</span><span class="br0">(</span>
                <span class="st0">'https://www.googleapis.com/oauth2/v1/userinfo?access_token='</span>+access_token<span class="br0">)</span>
            <span class="co1"># decoding bytecode to utf-8</span>
            <span class="kw3">user</span> <span class="sy0">=</span> json.<span class="me1">loads</span><span class="br0">(</span>response.<span class="me1">body</span>.<span class="me1">decode</span><span class="br0">(</span><span class="st0">'utf-8'</span><span class="br0">)</span><span class="br0">)</span>
            <span class="kw2">self</span>.<span class="me1">set_secure_cookie</span><span class="br0">(</span><span class="st0">'tracker'</span><span class="sy0">,</span> <span class="kw3">user</span><span class="br0">[</span><span class="st0">'email'</span><span class="br0">]</span><span class="br0">)</span>
            <span class="kw2">self</span>.<span class="me1">redirect</span><span class="br0">(</span><span class="st0">'/'</span><span class="br0">)</span>
            <span class="kw1">return</span>
        <span class="kw1">elif</span> <span class="kw2">self</span>.<span class="me1">get_secure_cookie</span><span class="br0">(</span><span class="st0">'tracker'</span><span class="br0">)</span>:
            <span class="kw2">self</span>.<span class="me1">redirect</span><span class="br0">(</span><span class="st0">'/'</span><span class="br0">)</span>
            <span class="kw1">return</span>
        <span class="kw1">else</span>:
            <span class="kw1">yield</span> <span class="kw2">self</span>.<span class="me1">authorize_redirect</span><span class="br0">(</span>
                redirect_uri<span class="sy0">=</span><span class="kw2">self</span>.<span class="me1">settings</span><span class="br0">[</span><span class="st0">"google_redirect_url"</span><span class="br0">]</span><span class="sy0">,</span>
                client_id<span class="sy0">=</span><span class="kw2">self</span>.<span class="me1">settings</span><span class="br0">[</span><span class="st0">'google_oauth'</span><span class="br0">]</span><span class="br0">[</span><span class="st0">'key'</span><span class="br0">]</span><span class="sy0">,</span>
                scope<span class="sy0">=</span><span class="br0">[</span><span class="st0">'email'</span><span class="br0">]</span><span class="sy0">,</span>
                response_type<span class="sy0">=</span><span class="st0">'code'</span><span class="sy0">,</span>
                extra_params<span class="sy0">=</span><span class="br0">{</span><span class="st0">'approval_prompt'</span>: <span class="st0">'auto'</span><span class="sy0">,</span>
                              <span class="st0">'hd'</span>: <span class="kw2">self</span>.<span class="me1">settings</span><span class="br0">[</span><span class="st0">'allowed_domain'</span><span class="br0">]</span><span class="br0">}</span><span class="br0">)</span>  <span class="co1"># passing 'hd' parameter to whitelist this domain</span></pre></div></div></div></div></div></div></div>


<p>We are storing user’s email secure cookie which is supposed to be secure (what a relief). You should also notice that we are passing ‘hd’ parameter to whitelist our chosen domain. Then, we define some more URL routes for users:</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="python"><pre class="de1"><span class="br0">(</span>r<span class="st0">"/login-page"</span><span class="sy0">,</span> web_handlers.<span class="me1">LoginPage</span><span class="br0">)</span><span class="sy0">,</span>
<span class="br0">(</span>r<span class="st0">"/login"</span><span class="sy0">,</span> GAuthLoginHandler<span class="br0">)</span><span class="sy0">,</span>
<span class="br0">(</span>r<span class="st0">"/logout"</span><span class="sy0">,</span> AuthLogoutHandler<span class="br0">)</span><span class="sy0">,</span></pre></div></div></div></div></div></div></div>


<p>login-page here acts as a place were unregistered users can wander around without being automatically redirected to Google’s auth page. Now, go to your web_handlers.py and add new decorator over your every (OK, except LoginPage handler) handler get function: @web.authenticated. That’s it, authentication enabled.</p>
<h2>Deploying on OpenShift</h2>
<p>You are probably tired by now but we are almost finished :). Since OpenShift Origin (with Kubernetes and all the new good things) isn’t live in RedHat’s online PaaS – we will be using current online version which is cool as well. You can get three gears for free what is more than enough for our little application. Just go here: <a href="https://www.openshift.com/products/online" target="_blank">https://www.openshift.com/products/online</a> for a free account. Then, create a native Python 3.3 application (or you can do it from command line using rhc client). Add Redis cartridge to your application:</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="bash"><pre class="de1">rhc add-cartridge http:<span class="sy0">//</span>cartreflect-claytondev.rhcloud.com<span class="sy0">/</span>reflect?<span class="re2">github</span>=smarterclayton<span class="sy0">/</span>openshift-redis-cart</pre></div></div></div></div></div></div></div>


<p>What’s different about Tornado applications in OpenShift is that we should use Tornado (to enable our coroutines and other good things) as an HTTP server and override OpenShift WSGI server. To do that – create new app.py file inside your project’s root:</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="python"><pre class="de1"><span class="kw1">from</span> utilities.<span class="me1">cache</span> <span class="kw1">import</span> RedisCacheBackend
<span class="kw1">import</span> redis
<span class="kw1">import</span> tornado
<span class="kw1">from</span> run <span class="kw1">import</span> TornadoApplication
<span class="kw1">if</span> __name__ <span class="sy0">==</span> <span class="st0">'__main__'</span>:
    ip <span class="sy0">=</span> <span class="kw3">os</span>.<span class="me1">environ</span><span class="br0">[</span><span class="st0">'OPENSHIFT_PYTHON_IP'</span><span class="br0">]</span>
    port <span class="sy0">=</span> <span class="kw2">int</span><span class="br0">(</span><span class="kw3">os</span>.<span class="me1">environ</span><span class="br0">[</span><span class="st0">'OPENSHIFT_PYTHON_PORT'</span><span class="br0">]</span><span class="br0">)</span>
    app <span class="sy0">=</span> TornadoApplication<span class="br0">(</span><span class="br0">)</span>
    <span class="co1"># overriding default redis settings with openshift ones.</span>
    app.<span class="me1">redis</span> <span class="sy0">=</span> redis.<span class="me1">Redis</span><span class="br0">(</span>host<span class="sy0">=</span><span class="kw3">os</span>.<span class="me1">environ</span><span class="br0">[</span><span class="st0">'OPENSHIFT_REDIS_HOST'</span><span class="br0">]</span><span class="sy0">,</span> port<span class="sy0">=</span><span class="kw3">os</span>.<span class="me1">environ</span><span class="br0">[</span><span class="st0">'OPENSHIFT_REDIS_PORT'</span><span class="br0">]</span><span class="sy0">,</span> password<span class="sy0">=</span><span class="kw3">os</span>.<span class="me1">environ</span><span class="br0">[</span><span class="st0">'REDIS_PASSWORD'</span><span class="br0">]</span><span class="br0">)</span>
    app.<span class="me1">cache</span> <span class="sy0">=</span> RedisCacheBackend<span class="br0">(</span>app.<span class="me1">redis</span><span class="br0">)</span>
    <span class="co1"># overriding google oauth callback url</span>
    app.<span class="me1">settings</span><span class="br0">[</span><span class="st0">'google_redirect_url'</span><span class="br0">]</span> <span class="sy0">=</span> <span class="st0">'http://%s/login'</span> % <span class="kw3">os</span>.<span class="me1">environ</span><span class="br0">[</span><span class="st0">'OPENSHIFT_APP_DNS'</span><span class="br0">]</span>
    http_server <span class="sy0">=</span> tornado.<span class="me1">httpserver</span>.<span class="me1">HTTPServer</span><span class="br0">(</span>app<span class="br0">)</span>
    http_server.<span class="me1">listen</span><span class="br0">(</span>port<span class="sy0">=</span>port<span class="sy0">,</span> address<span class="sy0">=</span>ip<span class="br0">)</span>
    tornado.<span class="me1">ioloop</span>.<span class="me1">IOLoop</span>.<span class="me1">instance</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">start</span><span class="br0">(</span><span class="br0">)</span></pre></div></div></div></div></div></div></div>


<p>Here we grab some parameters from OpenShift environment variables for Redis and also for API callbacks. I should mention again that your redirect value in app.settings[‘google_redirect_url’] should be the same as the one in your service account which you have created in google’s developer console.<br/>
This function is also starting tornado’s IOLoop so our web server is started. You can now go and check out your application online! If it fails to start – you can use rhc ssh [application_name] to quickly connect to your application and go to ‘logs’ folder for some information.</p>
<p>That’s it. Tornado is fun, you should use more of it!</p>

</div></div></body></html>