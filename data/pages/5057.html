<html><body><div><p>
ChatOps все еще свежее и редкое явление в мире DevOps, когда работа с инфраструктурой переносится в общий чат. Вы можете запускать команды прямо из чата, при этом разработчики/сисадмины видят что происходит в режиме реального времени, могут просматривать историю изменений, запускать свои команды, поддерживать коммуникацию вокруг работы и даже обмениваться опытом. Таким образом информация и рабочий процесс принадлежит всей команде — а это несет в себе много преимуществ.
</p><p>
Можно придумать такие вещи как деплой кода или развертывание серверов из чата, просмотр графиков мониторинга, отправку SMS, управление кластерами или просто запуск shell команд. ChatOps может быть высокоуровневым представлением вашей действительно сложной </p><code><a href="http://stackstorm.com/"/><a href="http://stackstorm.com/2015/06/05/new-in-stackstorm-ansible-integration/"/><a href="http://stackstorm.com/2015/06/08/enhanced-chatops-from-stackstorm/"/><a href="https://ru.wikipedia.org/wiki/%D0%A2%D0%B5%D1%85%D0%BD%D0%BE%D0%BB%D0%BE%D0%B3%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B0%D1%8F_%D1%81%D0%B8%D0%BD%D0%B3%D1%83%D0%BB%D1%8F%D1%80%D0%BD%D0%BE%D1%81%D1%82%D1%8C"/><a href="http://slack.com/"/><a href="https://hubot.github.com/"/><pre><code class="bash">!deploy . Такой подход делает чудеса для улучшения видимости и снижения сложности вокруг процесса развертываний.<br/>
<br/>
<a name="habracut"/><br/>
<h2>Улучшенный ChatOps</h2><br/>
StackStorm - OpenSource проект с особым вниманием к автоматизации и ChatOps. Платформа связывает то огромное количество существующих DevOps инструментов вроде управления конфигурацией, мониторинга, графиков, оповещения итд. вместе, позволяя править всем из единого контрольного пункта. И это идеально с точки зрения ChatOps, - можно создавать и автоматизировать мыслимые и немыслимые рабочие процессы, контролируя любые наборы инструментов прямо из чата.<br/>
<br/>
Недавно StackStorm добавили поддержку Ansible и дополнительные ChatOps возможности, открывая дорогу для реального применения ChatOps, не просто постинг фотографий забавных котиков с помощью бота. В этом материале мы расскажем как заставить работать ChatOps и Ansible с помощью StackStorm платформы.<br/>
<blockquote>Кстати, StackStorm как и Ansible декларативен, написан на Python и использует Yaml + Jinja, что позволит вам легче во всем разобраться.</blockquote><br/>
<br/>
<h2>План</h2><br/>
Вначале мы собираемся установить контрольную машину, которая будет работать под Ubuntu. Затем мы настроим на ней StackStorm платформу, в том числе пакеты управления Ansible и ChatOps фреймворком Hubot. И наконец, мы подключим всю систему к Slack чату, и покажем несколько простых, но реальных примеров интерактивного использования Ansible.<br/>
<br/>
Давайте начнем, а заодно проверим как далеко мы зашли и наступила ли технологическая сингулярность, давая root доступ каким-то чат ботам и позволяя им управлять нашими 100+ серверами или даже датацентрами (кстати RackSpace работают с ChatOps).<br/>
<br/>
<h2>Шаг 0. Подготовка Slack</h2><br/>
Как уже было сказано, мы будем использовать Slack.com как чат платформу (хотя доступны другие интеграции). Зарегистрируйте Slack аккаунт, если у вас его еще нет. Включите интеграцию Hubot в настройках.<br/>
<blockquote>Hubot - фреймворк бота от GitHub, созданный специально для ChatOps</blockquote><br/>
<img src="https://habrastorage.org/files/c5f/ab7/b80/c5fab7b80cba447a901ec57d4d34c9de.png" alt="Включите Hubot интеграцию в Slack"/><br/>
В итоге Slack выдаст вам API токен вроде: <br/>

HUBOT_SLACK_TOKEN=xoxb-5187818172-I7wLh4oqzhAScwXZtPcHyxCu
</code></pre><br/>
Далее мы настроим StackStorm платформу, покажем реальные примеры использования, и конечно же, расскажем как создать собственные ChatOps команды.<br/>
Но подождите, есть простой способ!<br/>
<br/>
<h2>Для самых ленивых</h2><br/>
Для тех кто ленив (большинство DevOps разработчиков такие), есть специально подготовленный репозиторий с Vagrant, который установит все необходимое с помощью простейших bash скриптов, доставив вас с линии старта прямо на финиш, давая возможность после автоматической установки сразу запускать ChatOps команды из Slack чата <a href="https://github.com/StackStorm/showcase-ansible-chatops">showcase-ansible-chatops</a>:<br/>
<pre><code class="bash">
# Замените на свой токен
export HUBOT_SLACK_TOKEN=xoxb-5187818172-I7wLh4oqzhAScwXZtPcHyxCu
git clone https://github.com/StackStorm/showcase-ansible-chatops.git
cd showcase-ansible-chatops
vagrant up
</code></pre><br/>
Для тех же кому интересны подробности - переключимся из автоматического режима в ручной и пройдемся по всем шагам. Просто имейте ввиду, если что-то не получается - сверьтесь с примерами из <a href="https://github.com/StackStorm/showcase-ansible-chatops">ansible &amp; chatops демо репозитория</a>.<br/>
<br/>
<h2>Шаг 1. Установка StackStorm</h2><br/>
Установка проста. Всего 1 команда: <br/>
<pre><code class="bash">
curl -s https://downloads.stackstorm.net/releases/st2/scripts/st2_deploy.sh latest | sudo bash
</code></pre><br/>
<blockquote>Имейте ввиду, это для демонстрационных целей. При развертывании продакшена используйте Ansible, сверяйте подписи и не доверяйте установочным командам в одну строчку!</blockquote><br/>
После завершения установки (а StackStorm тянет кучу Python пакетов, RabbitMQ, PostgreSQL, MongoDB, OpenStack), для простоты демонстрации отключите механизм StackStorm авторизации в файле: <code>/etc/st2/st2/conf</code>. Можно выставить в секции <code>[auth]</code> вручную <code>enable = False</code>, либо воспользоваться магическим хаком:<br/>
<pre><code class="bash">
sudo sed -i '/^\[auth\]$/,/^\[/ s/^enable = True/enable = False/' /etc/st2/st2.conf
</code></pre><br/>
Далее перезагрузим StackStorm:<br/>
<pre><code class="bash">
sudo st2ctl restart
</code></pre><br/>
<br/>
<h2>Шаг 2. Установка StackStorm плагинов: Ansible и Hubot</h2><br/>
Поставим необходимые плагины от StackStorm, связывающие Ansible и Hubot:<br/>
<pre><code class="bash">
sudo st2 run packs.install packs=hubot,ansible register=all
</code></pre><br/>
Кроме самих пакетов, будет еще установлен и сам Ansible в Python virtualenv: <code>/opt/stackstorm/virtualenvs/ansible/bin</code><br/>
<br/>
<h2>Шаг 3. Установка Hubot</h2><br/>
Установим <a href="https://hubot.github.com/">Hubot</a> и плагины: Slack и StackStorm, позволяющие запускать команды в Slack чате и перенаправлять их в st2. Цепочка выглядит так:<br/>
<pre><code class="bash">
Slack -&gt; Hubot -&gt; StackStorm -&gt; Ansible
</code></pre><br/>
Redis - место, где Hubot держит свои мозги. Понимайте как хотите, но мозги нам нужны:<br/>
<pre><code class="bash">
sudo apt-get install build-essential redis-server
</code></pre><br/>
Hubot сделан на Nodejs, необходимая зависимость:<br/>
<pre><code class="bash">
curl -sL https://deb.nodesource.com/setup_0.12 | sudo bash -
sudo apt-get install nodejs
</code></pre><br/>
Установка самого Hubot:<br/>
<pre><code class="bash">
sudo npm install -g hubot coffee-script yo generator-hubot
</code></pre><br/>
Создадим персональную hubot сборку из-под <code>stanley</code> linux юзера (он ранее был создан StackStorm). В будущем мы будем запускать бота с правами <code>stanley</code>:<br/>
<pre><code class="bash">
sudo mkdir -p /opt/hubot
sudo chown stanley:stanley /opt/hubot
sudo -H -u stanley bash -c 'cd /opt/hubot &amp;&amp; echo "n" | yo hubot --name=stanley --description="Stanley StackStorm bot" --defaults'
</code></pre><br/>
Установим <abbr title="Node Package Manager">npm</abbr> плагины <a href="https://github.com/StackStorm/hubot-stackstorm">hubot-stackstorm</a> и <a href="https://github.com/slackhq/hubot-slack">hubot-slack</a>:<br/>
<pre><code class="bash">
sudo -H -u stanley bash -c 'cd /opt/hubot &amp;&amp; npm install hubot-slack hubot-stackstorm --save'
</code></pre><br/>
Для того чтобы <code>hubot-stackstorm</code> подгружался при старте бота, добавьте запись <code>hubot-stackstorm</code> в файл: <code>/opt/hubot/external-scripts.json</code>:<br/>
<pre><code class="bash">
sed -i 's/.*\[.*/&amp;\n  "hubot-stackstorm",/' /opt/hubot/external-scripts.json
</code></pre><br/>
И наконец, можно запускать бота (не забудьте заменить API токен на свой):<br/>
<pre><code class="bash">
cd /opt/hubot &amp;&amp; HUBOT_SLACK_TOKEN=xoxb-5187818172-I7wLh4oqzhAScwXZtPcHyxCu ST2_WEBUI_URL=http://chatops:8080 PORT=8181 bin/hubot --name "stanley" --adapter slack --alias !
</code></pre><br/>
<br/>
<h2>Шаг 4. Первый ChatOps опыт</h2><br/>
На данном этапе Stanley бот должен быть онлайн в чате. Чтобы пригласить его в определенную Slack комнату:<br/>
<pre><code class="bash">
/invite @stanley
</code></pre><br/>
Получить список доступных команд:<br/>
<pre><code class="bash">
!help
</code></pre><br/>
Наверняка вам понравится:<br/>
<pre><code class="bash">
!ship it
</code></pre><br/>
Вдоволь наигравшись с существующими командами, займемся действительно серьезными вещами.<br/>
<br/>
<h2>Шаг 5. Создание собственных ChatOps команд</h2><br/>
Одна из возможностей StackStorm - это способность создавать простые алиасы/обертки вокруг команд, упрощая работу с ChatOps. Вместо того чтобы набирать длинную команду, вы можете просто забиндить ее на что-то более дружественное и легкое, синтаксический сахар.<br/>
<br/>
Итак, создадим свой собственный StackStorm пак который будет содержать нужные нам команды. Форкните <a href="https://github.com/StackStorm/st2-pack-template">StackStorm template pack</a> на GitHub. Наш первый action alias <a href="https://github.com/armab/st2-chatops-aliases/blob/master/aliases/ansible.yaml"><code>/aliases/ansible.yaml</code></a>:<br/>
<pre><code class="python">---
name: "chatops.ansible_local"
action_ref: "ansible.command_local"
description: "Run ansible command on local machine"
formats:
  - "ansible {{args}}"
</code></pre><br/>
<blockquote>Для справки: вышеуказанный алиас использует <a href="https://github.com/StackStorm/st2contrib/tree/master/packs/ansible">ansible st2 integration pack</a></blockquote><br/>
Отправляем изменения в недавно созданный <a href="https://github.com/armab/st2-chatops-aliases">GitHub репозиторий</a> и можно устанавливать наш пак. Для этого уже есть ChatOps алиас:<br/>
<pre><code class="bash">
!pack deploy st2-ansible-aliases repo_url=armab/st2-ansible-aliases
</code></pre><br/>
где <code>repo_url</code> - ваш github репозиторий.<br/>
<br/>
Теперь можно запускать простые <a href="http://docs.ansible.com/intro_adhoc.html">Ansible ad-hoc команды</a> прямо из Slack чата:<br/>
<pre><code class="bash">
!ansible "uname -a"
</code></pre><br/>
<img src="https://habrastorage.org/files/d49/9f2/4fb/d499f24fb2254e1a90d8942432080653.png" alt="Запуск ansible команд - ChatOps"/><br/>
На низком уровне это тоже самое что:<br/>
<pre><code class="bash">
/opt/stackstorm/virtualenvs/ansible/bin/ansible all --connection=local --args='uname -a' --inventory-file='127.0.0.1,'
</code></pre><br/>
Но давайте рассмотрим более полезные примеры интерактивного ChatOps.<br/>
<br/>
<h3>Пример 1. Получаем статус серверов</h3><br/>
У Ansible есть <a href="http://docs.ansible.com/ping_module.html">ping модуль</a> который подключается к хостам и возвращает <code>pong</code> в случае успеха. Простой, но мощный пример, позволяющий понять состояние серверов прямо из чата за считанные секунды без необходимости заходить в терминал.<br/>
<br/>
Для этого создадим в нашем паке <code>action</code>, запускающий реальную команду и <code>action alias</code>, являющийся синтаксическим сахаром для экшна и позволяющий создать такую ChatOps конструкцию:<br/>
<pre><code class="bash">
!status 'web'
</code></pre><br/>
Action <a href="https://github.com/armab/st2-chatops-aliases/blob/master/actions/server_status.yaml"><code>actions/server-status.yaml</code></a>:<br/>
<pre><code class="python">---
name: server_status
description: Show server status by running ansible ping ad-hoc command
runner_type: local-shell-cmd
entry_point: ""
enabled: true
parameters:
  sudo:
    description: "Run command with sudo"
    type: boolean
    immutable: true
    default: true
  kwarg_op:
    immutable: true
  cmd:
    description: "Command to run"
    type: string
    immutable: true
    default: "/opt/stackstorm/virtualenvs/ansible/bin/ansible {{hosts}} --module-name=ping"
  hosts:
    description: "Ansible hosts to ping"
    type: string
    required: true
</code></pre><br/>
<blockquote>Кстати, кроме bash скриптов, Action может работать с <a href="http://docs.stackstorm.com/runners.html">Python runner</a>, - здесь вся гибкость использования.</blockquote><br/>
<br/>
Action alias <a href="https://github.com/armab/st2-chatops-aliases/blob/master/aliases/server_status.yaml"><code>aliases/server_status.yaml</code></a>:<br/>
<pre><code class="bash">
---
name: chatops.ansible_server_status
action_ref: st2-chatops-aliases.server_status
description: Show status for hosts (ansible ping module)
formats:
- "status {{hosts}}"
</code></pre><br/>
Убедитесь, что вы добавили нужные хосты в Ansible inventory файл: <code>/etc/ansible/hosts</code><br/>
<br/>
После отправки кода в репозиторий, не забудьте перезагрузить ваш пак из чата:<br/>
<pre><code class="bash">
!pack deploy st2-chatops-aliases repo_url=armab/st2-chatops-aliases
</code></pre><br/>
Очень удобно что мы можем хранить все наши ChatOps настройки в виде st2 пака и подхватывать изменения из репозитория, - инфраструктура как код. Результат только что созданной команды в Slack:<br/>
<img src="https://habrastorage.org/files/5fb/742/0e9/5fb7420e950b42a4bfa15588370766d0.png" alt="Показать статус серверов - ChatOps"/><br/>
<br/>
Это действительно удобно, даже ваш <abbr title="Chief Executive Officer">CEO</abbr> может посмотреть статус не имея доступа к серверам! С таким подходом общение, развертывание и работа вокруг инфраструктуры может происходить прямо в чате: находитесь ли вы в офисе или работаете удаленно (некоторые из нас могут работать прямо с пляжа).<br/>
<br/>
<h3>Пример 2. Перезагрузка сервисов</h3><br/>
С вами когда-то случалось так, что простая перезагрузка сервиса помогала? Не идеальный способ, но зачастую быстрое решение просто необходимо. Давайте создадим ChatOps команду которая бы перегружала указанный сервис на определенных серверах.<br/>
Задача получить такую конструкцию:<br/>
<pre><code class="bash">
!service restart "gearmand" on "MQ-server"
</code></pre><br/>
Для этого в уже существующем st2 паке создайте <a href="https://github.com/armab/st2-chatops-aliases/blob/master/actions/service_restart.yaml"><code>actions/service_restart.yaml</code></a>:<br/>
<pre><code class="python">---
name: service_restart
description: Restart service on remote hosts
runner_type: local-shell-cmd
entry_point: ""
enabled: true
parameters:
  sudo:
    description: "Run command with sudo"
    type: boolean
    immutable: true
    default: true
  kwarg_op:
    immutable: true
  cmd:
    description: "Command to run"
    type: string
    immutable: true
    default: "/opt/stackstorm/virtualenvs/ansible/bin/ansible {{hosts}} --become --module-name=service --args='name={{service_name}} state=restarted'"
  hosts:
    description: "Ansible hosts"
    type: string
    required: true
  service_name:
    description: "Service to restart"
    type: string
    required: true
</code></pre><br/>
ChatOps алиас <a href="https://github.com/armab/st2-chatops-aliases/blob/master/aliases/service_restart.yaml"><code>aliases/service_restart.yaml</code></a>:<br/>
<pre><code class="python">---
name: chatops.ansible_service_restart
action_ref: st2-chatops-aliases.service_restart
description: Restart service on remote hosts
formats:
  - "service restart {{service_name}} on {{hosts}}"
</code></pre><br/>
Результат:<br/>
<img src="https://habrastorage.org/files/12c/116/f01/12c116f010b240a9a2b91a4bb208749d.png" alt="Перезагрузка MySQL сервиса на удаленных серверах - ChatOps"/><br/>
И знаете что? Благодаря мобильному приложению Slack вы можете перезагружать сервисы прямо с вашего телефона!<br/>
<br/>
<h3>Пример 3. MySQL processlist</h3><br/>
Мы хотим создать простую Slack команду, которая бы отображала список выполняемых SQL запросов на MySQL сервере:<br/>
<pre><code class="bash">
!show mysql processlist
</code></pre><br/>
Action <a href="https://github.com/armab/st2-chatops-aliases/blob/master/actions/mysql_processlist.yaml"><code>actions/mysql_processlist.yaml</code></a>:<br/>
<pre><code class="python">---
name: mysql_processlist
description: Show MySQL processlist
runner_type: local-shell-cmd
entry_point: ""
enabled: true
parameters:
  sudo:
    immutable: true
    default: true
  kwarg_op:
    immutable: true
  cmd:
    description: "Command to run"
    type: string
    immutable: true
    default: "/opt/stackstorm/virtualenvs/ansible/bin/ansible {{ hosts }} --become --become-user=root -m shell -a \"mysql --execute='SHOW PROCESSLIST;' | expand -t 10\""
  hosts:
    description: "Ansible hosts"
    type: string
    default: db
</code></pre><br/>
Action alias для ChatOps: <a href="https://github.com/armab/st2-chatops-aliases/blob/master/aliases/mysql_processlist.yaml"><code>aliases/mysql_processlist.yaml</code></a>:<br/>
<pre><code class="python">---
name: chatops.mysql_processlist
action_ref: st2-chatops-aliases.mysql_processlist
description: Show MySQL processlist
formats:
  - "show mysql processlist {{hosts=db}}"
</code></pre><br/>
Заметьте, что мы сделали <code>hosts</code> параметр опциональным (<code>db</code> по умолчанию), так что эти две команды эквивалентны:<br/>
<pre><code class="bash">
!show mysql processlist
!show mysql processlist 'db'
</code></pre><br/>
<img src="https://habrastorage.org/files/02d/fbb/4c0/02dfbb4c06d04502a55cb00d40c1aa66.png" alt="Показать список выполняемых SQL запросов - ChatOps"/><br/>
Ваш <abbr title="Database Administrator">DBA</abbr> будет счастлив!<br/>
<br/>
<h3>Пример 4. Получаем HTTP статистику из nginx</h3><br/>
Мы хотим получить массив HTTP статус кодов из nginx лога, отсортировать их в зависимости от количества и красиво отобразить в чате, чтоб понять как много <code>200</code> или <code>50x</code> ошибок на веб серверах, находятся ли они в пределах нормы или нет:<br/>
<pre><code class="bash">
!show nginx stats on 'web'
</code></pre><br/>
Для этого создадим action, который запускает bash команду, <a href="https://github.com/armab/st2-chatops-aliases/blob/master/actions/http_status_codes.yaml"><code>actions/http_status_codes.yaml</code></a>:<br/>
<pre><code class="python">---
name: http_status_codes
description: Show sorted http status codes from nginx logs
runner_type: local-shell-cmd
entry_point: ""
enabled: true
parameters:
  sudo:
    immutable: true
    default: true
  kwarg_op:
    immutable: true
  cmd:
    description: "Command to run"
    type: string
    immutable: true
    default: "/opt/stackstorm/virtualenvs/ansible/bin/ansible {{ hosts }} --become -m shell -a \"awk '{print \\$9}' /var/log/nginx/access.log|sort |uniq -c |sort -k1,1nr 2&gt;/dev/null|column -t\""
  hosts:
    description: "Ansible hosts"
    type: string
    required: true
</code></pre><br/>
Alias <a href="https://github.com/armab/st2-chatops-aliases/blob/master/aliases/http_status_codes.yaml"><code>aliases/http_status_codes.yaml</code></a>:<br/>
<pre><code class="python">---
name: chatops.http_status_codes
action_ref: st2-chatops-aliases.http_status_codes
description: Show sorted http status codes from nginx on hosts
formats:
  - "show nginx stats on {{hosts}}"
</code></pre><br/>
<blockquote>Спасибо <a href="https://github.com/bcoca">Brian Coca</a>, Ansible core разработчику за великолепную идею!</blockquote><br/>
<img src="https://habrastorage.org/files/4b3/5a4/0b2/4b35a40b2a7d4cb289e8a6a82de5604f.png" alt="Показать список nginx статус кодов на серверах - ChatOps"/><br/>
Все больше и больше это выглядит как контрольный центр <s>управления полетами</s>. Вы можете запускать целые цепочки команд на серверах прямо из чата и каждый может видеть результат в режиме реального времени. Отлично!<br/>
<br/>
<h3>Пример 5. Security patching</h3><br/>
Представьте что вам необходимо срочно устранить очередную критическую уязвимость вроде <a href="https://en.wikipedia.org/wiki/Shellshock_%28software_bug%29">Shellshock</a>. Для этого надо обновить <code>bash</code> на всех серверах. Ansible пожалуй идеальный инструмент для таких операций. Но вместо запуска однострочной ansible команды, давайте создадим добротный playbook: <br/>
<a href="https://github.com/armab/st2-chatops-aliases/blob/master/playbooks/update_package.yaml"><code>playbooks/update_package.yaml</code></a>:<br/>
<pre><code class="python">---
- name: Update package on remote hosts, run on 25% of servers at a time
  hosts: "{{ hosts }}"
  serial: "20%"
  sudo: yes
  tasks:
    - name: Check if Package is installed
      command: dpkg-query -l {{ package }}
      register: is_installed
      failed_when: is_installed.rc &gt; 1
      changed_when: no

    - name: Update Package only if installed
      apt: name={{ package }}
        state=latest
        update_cache=yes
      when: is_installed.rc == 0
</code></pre><br/>
<code>Playbook</code> обновит пакет только если он уже установлен, операция производится на 20% хостов за раз, те в 5 шагов. Полезно, когда надо обновить что-то более серьезное вроде <code>nginx</code> на действительно большом количестве серверов. Таким образом мы не отправляем весь веб кластер в даун. Дополнительно можно добавить отключение от балансировщика нагрузки группами. Пример из реальной жизни.<br/>
<br/>
Видно, что playbook переменные <code>{{hosts}}</code> и <code>{{package}}</code> приходят откуда-то извне, а именно из экшена в нашем StackStorm паке <a href="https://github.com/armab/st2-chatops-aliases/blob/master/actions/update_package.yaml"><code>actions/update_package.yaml</code></a>:<br/>
<pre><code class="python">---
name: update_package
description: Update package on remote hosts
runner_type: local-shell-cmd
entry_point: ""
enabled: true
parameters:
  sudo:
    immutable: true
    default: true
  kwarg_op:
    immutable: true
  timeout:
    default: 6000
  cmd:
    description: "Command to run"
    immutable: true
    # эта строчка
    default: "/opt/stackstorm/virtualenvs/ansible/bin/ansible-playbook /opt/stackstorm/packs/${ST2_ACTION_PACK_NAME}/playbooks/update_package.yaml --extra-vars='hosts={{ hosts }} package={{ package }}'"
  hosts:
    description: "Ansible hosts"
    type: string
    required: true
  package:
    description: "Package to upgrade"
    type: string
    required: true
</code></pre><br/>
Action alias, дающий возможность запускать playbook в виде простой ChatOps команды, <br/>
<a href="https://github.com/armab/st2-chatops-aliases/blob/master/aliases/update_package.yaml"><code>aliases/update_package.yaml</code></a>:<br/>
<pre><code class="python">---
name: chatops.ansible_package_update
action_ref: st2-chatops-aliases.update_package
description: Update package on remote hosts
formats:
  - "update {{package}} on {{hosts}}"
</code></pre><br/>
Вот она:<br/>
<pre><code class="bash">
!update 'bash' on 'all'
</code></pre><br/>
<img src="https://habrastorage.org/files/cdf/6a1/ea1/cdf6a1ea131b4c80b7ec0963faa21d23.png" title="Обновление установленных пакетов на удаленных хостах с помощью Ansible и Chat-Ops"/><br/>
Важная часть работы DevOps инженера - это улучшение процессов, делая работу разработчиков проще, общение в команде лучше, диагностику проблем быстрее за счет автоматизации и использования правильных инструментов, - все для того, чтобы сделать компанию успешнее.<br/>
ChatOps помогает решить эти проблемы совершенно новым, эффективным способом!<br/>
<br/>
<h3>В завершение. Священная корова</h3><br/>
Как вы знаете, у Ansible <a href="https://github.com/ansible/ansible/issues/10530">известная любовь к утилите <code>cowsay</code></a>. Давайте перенесем ее в ChatOps!<br/>
<br/>
Установим для начала саму утилиту:<br/>
<pre><code class="bash">
sudo apt-get install cowsay
</code></pre><br/>
Экшн <a href="https://github.com/armab/st2-chatops-aliases/blob/master/actions/cowsay.yaml"><code>actions/cowsay.yaml</code></a>:<br/>
<pre><code class="python">---
name: cowsay
description: Draws a cow that says what you want
runner_type: local-shell-cmd
entry_point: ""
enabled: true
parameters:
  sudo:
    immutable: true
  kwarg_op:
    immutable: true
  cmd:
    description: "Command to run"
    type: string
    immutable: true
    default: "/usr/games/cowsay {{message}}"
  message:
    description: "Message to say"
    type: string
    required: true
</code></pre><br/>
Alias <a href="https://github.com/armab/st2-chatops-aliases/blob/master/aliases/cowsay.yaml"><code>aliases/cowsay.yaml</code></a>:<br/>
<pre><code class="python">---
name: chatops.cowsay
action_ref: st2-chatops-aliases.cowsay
description: Draws a cow that says what you want
formats:
  - "cowsay {{message}}"
</code></pre><br/>
Вызов священной ChatOps коровы:<br/>
<pre><code class="bash">
!cowsay 'Holy ChatOps Cow!'
</code></pre><br/>
<img src="https://habrastorage.org/files/ec8/060/aaf/ec8060aaf1614fb9bcc25bd4c771efb9.png" alt="Священная ChatOps корова"/><br/>
<blockquote>Для справки: Все результаты выполнения команд можно посмотреть в панели управления StackStorm<br/>
<a href="http://www.chatops:8080/">http://www.chatops:8080/</a> логин: <code>testu</code> пароль: <code>testp</code><br/>
(замените hostname на IP если не воспользовались <a href="https://github.com/StackStorm/showcase-ansible-chatops">Vagrant демо</a>):<br/>
</blockquote><br/>
<br/>
<h2>Не останавливайтесь на достигнутом!</h2><br/>
Это были простые, но боевые примеры использования. Более сложные вещи когда несколько DevOps инструментов соединены в динамический рабочий процесс будут показаны в следующих статьях. Здесь <a href="http://stackstorm.com/">StackStorm</a> демонстрирует всю свою мощь, принимая решения в зависимости от ситуации: это называется <a href="https://ru.wikipedia.org/wiki/%D0%A1%D0%BE%D0%B1%D1%8B%D1%82%D0%B8%D0%B9%D0%BD%D0%BE-%D0%BE%D1%80%D0%B8%D0%B5%D0%BD%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%BD%D0%B0%D1%8F_%D0%B0%D1%80%D1%85%D0%B8%D1%82%D0%B5%D0%BA%D1%82%D1%83%D1%80%D0%B0">событийно-ориентированной архитектурой</a> вроде самовосстанавливающихся после инцидента систем.<br/>
<blockquote>Если не нашли нужного функционала в StackStorm, предложите идею или добавьте <a href="https://github.com/StackStorm/st2">Pull Request на GitHub</a> (Python наш основной язык). Так же есть коммьюнити где можно задать вопрос или поделиться своим опытом: <a href="https://stackstorm.typeform.com/to/K76GRP">публичный Slack канал</a> (с предустановленным демо ботом) и IRC: <a href="http://webchat.freenode.net/?channels=stackstorm"><code>#StackStorm</code> на freenode.net</a> .<br/>
</blockquote><br/>
<br/>
Спасибо за внимание, надеюсь получилось осветить особенности этого достаточно нового подхода в мире DevOps.<br/>
А для каких случаев вы бы использовали ChatOps? Прошу делиться идеями в комментариях.</code>
      </div></body></html>