<html><body><div><div id="buildout">

<p>We recommend to setup up a buildout for your project. First it will install all required dependencies and the scripts needed to run a server. The boostrap file can be downloaded at <a href="https://bootstrap.pypa.io/bootstrap-buildout.py" rel="nofollow">https://bootstrap.pypa.io/bootstrap-buildout.py</a>.</p>
<p>File structure:</p>
<pre>buildout
├── bootstrap.py
├── buildout.cfg
├── etc
│   ├── deploy.ini.in
│   └── site.zcml.in
└── dev
    └── myproject
</pre>
<p>buildout.cfg</p>
<pre><span class="k">[buildout]</span>

<span class="na">extends</span> <span class="o">=</span><span class="s">
    https://raw.githubusercontent.com/bielbienne/bst.pygasus.demo/master/sources.cfg
    https://raw.githubusercontent.com/bielbienne/bst.pygasus.demo/master/versions.cfg</span>

<span class="na">develop</span> <span class="o">=</span> <span class="s">dev/myproject</span>
<span class="na">parts</span> <span class="o">=</span><span class="s">
    app
    zcml
    lingua</span>

<span class="na">extensions</span> <span class="o">=</span> <span class="s">mr.developer</span>
<span class="na">auto-checkout</span> <span class="o">=</span><span class="s">
    js.extjs
    bst.pygasus.core
    bst.pygasus.wsgi
    bst.pygasus.scaffolding
    bst.pygasus.datamanager
    bst.pygasus.resources
    bst.pygasus.security
    bst.pygasus.session
    bst.pygasus.i18n
    bst.pygasus.demo</span>

<span class="k">[debug_ini]</span>
<span class="na">recipe</span> <span class="o">=</span> <span class="s">collective.recipe.template</span>
<span class="na">input</span> <span class="o">=</span> <span class="s">etc/deploy.ini.in</span>
<span class="na">output</span> <span class="o">=</span> <span class="s">${buildout:parts-directory}/etc/${:outfile}</span>
<span class="na">outfile</span> <span class="o">=</span> <span class="s">debug.ini</span>

<span class="k">[zcml]</span>
<span class="na">recipe</span> <span class="o">=</span> <span class="s">collective.recipe.template</span>
<span class="na">input</span> <span class="o">=</span> <span class="s">etc/site.zcml.in</span>
<span class="na">output</span> <span class="o">=</span> <span class="s">${buildout:parts-directory}/etc/${:outfile}</span>
<span class="na">outfile</span> <span class="o">=</span> <span class="s">site.zcml</span>

<span class="k">[app]</span>
<span class="na">recipe</span> <span class="o">=</span> <span class="s">zc.recipe.egg:script</span>
<span class="na">arguments</span><span class="o">=</span><span class="s">"${debug_ini:output}"</span>
<span class="na">eggs</span> <span class="o">=</span><span class="s">
    bst.pygasus.wsgi
    myproject</span>

<span class="k">[lingua]</span>
<span class="na">unzip</span> <span class="o">=</span> <span class="s">true</span>
<span class="na">recipe</span> <span class="o">=</span> <span class="s">zc.recipe.egg</span>
<span class="na">eggs</span> <span class="o">=</span><span class="s">
    lingua
    bst.pygasus.i18n</span>
</pre>
<p>etc/deploy.ini.in</p>
<pre><span class="k">[zcml]</span>
<span class="na">path</span> <span class="o">=</span> <span class="s">${zcml:output}</span>

<span class="k">[app:main]</span>
<span class="na">use</span> <span class="o">=</span> <span class="s">egg:bst.pygasus.wsgi#main</span>

<span class="k">[server:debug]</span>
<span class="na">use</span> <span class="o">=</span> <span class="s">egg:waitress#http</span>
<span class="na">host</span> <span class="o">=</span> <span class="s">127.0.0.1</span>
<span class="na">port</span> <span class="o">=</span> <span class="s">5000</span>
<span class="na">threadpool_workers</span> <span class="o">=</span> <span class="s">1</span>
<span class="na">threadpool_spawn_if_under</span> <span class="o">=</span> <span class="s">1</span>
<span class="na">threadpool_max_requests</span> <span class="o">=</span> <span class="s">0</span>
</pre>
<p>etc/site.zcml.in</p>
<pre><span class="nt">&lt;configure</span> <span class="na">xmlns=</span><span class="s">"http://namespaces.zope.org/zope"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;include</span> <span class="na">package=</span><span class="s">"myproject"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/configure&gt;</span>
</pre>
<p>Run your buildout. (You must first create your own project as shown in next part)</p>
<pre>$ <span class="nb">cd</span> buildout
$ python3 boostrap.py
$ ./bin/buildout
</pre>
</div>
<div id="create-an-application">

<div id="proposed-file-structure">

<p>We propose the following file structure inside your python egg:</p>
<pre>├── app
│   ├── application.js
│   ├── controller
│   │   ├── Card.js
│   │   └── Main.js
│   ├── resources
│   │   └── css
│   │       └── styles.css
│   └── view
│       ├── CardView.js
│       └── MainView.js
├── configure.zcml
├── extjs.py
├── handler.py
├── __init__.py
├── locales
│   ├── bb.extjs.demo.pot
│   └── fr
│       └── LC_MESSAGES
│           ├── bst.pygasus.demo.mo
│           └── bst.pygasus.demo.po
├── model.py
└── schema.py
</pre>
</div>
<div id="setup-configure-zcml">

<pre><span class="nt">&lt;configure</span> <span class="na">xmlns=</span><span class="s">"http://namespaces.zope.org/zope"</span>
           <span class="na">xmlns:grok=</span><span class="s">"http://namespaces.zope.org/grok"</span>
           <span class="na">xmlns:i18n=</span><span class="s">"http://namespaces.zope.org/i18n"</span>
           <span class="na">i18n_domain=</span><span class="s">"myproject"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;include</span> <span class="na">package=</span><span class="s">"bst.pygasus.core"</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;grok:grok</span> <span class="na">package=</span><span class="s">"."</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;i18n:registerTranslations</span> <span class="na">directory=</span><span class="s">"locales"</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;/configure&gt;</span>
</pre>
</div>
<div id="create-an-application-context-extjs-py">

<pre><span class="kn">from</span> <span class="nn">fanstatic</span> <span class="kn">import</span> <span class="n">Library</span>
<span class="kn">from</span> <span class="nn">fanstatic</span> <span class="kn">import</span> <span class="n">Resource</span>
<span class="kn">from</span> <span class="nn">bst.pygasus.core</span> <span class="kn">import</span> <span class="n">ext</span>

<span class="n">library</span> <span class="o">=</span> <span class="n">Library</span><span class="p">(</span><span class="s1">'demo'</span><span class="p">,</span> <span class="s1">'app'</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">DemoContext</span><span class="p">(</span><span class="n">ext</span><span class="o">.</span><span class="n">ApplicationContext</span><span class="p">):</span>

    <span class="n">title</span> <span class="o">=</span> <span class="s1">'Demo'</span>
    <span class="n">application</span> <span class="o">=</span> <span class="s1">'bst.pygasus.demo.Application'</span>
    <span class="n">namespace</span> <span class="o">=</span> <span class="s1">'bst.pygasus.demo'</span>
    <span class="n">resources</span> <span class="o">=</span> <span class="n">Resource</span><span class="p">(</span><span class="n">library</span><span class="p">,</span> <span class="s1">'application.js'</span><span class="p">,</span>
                         <span class="n">depends</span><span class="o">=</span><span class="p">[</span><span class="n">ext</span><span class="o">.</span><span class="n">extjs_resources</span><span class="p">])</span>
</pre>
</div>
<div id="register-additional-extjs-paths-extjs-py">

<p>ExtJS needs to know where additional ExtJS-Classes can be loaded. This is why each namespace used in ExtJS needs to be registred. In this example we regstister two namespaces for ‘bst.pygasus.demo.view’ and ‘bst.pygasus.demo.controller’. The path usually begins with ‘fanstatic’, followed by your library name (e.g. “demo”) ( <code><span class="n">Library</span><span class="p">(</span><span class="s1">‘demo’</span><span class="p">,</span> <span class="s1">‘app’</span><span class="p">)</span></code> ) and then, at the end, a subdirectory.</p>
<pre><span class="k">class</span> <span class="nc">ViewClassPathMapping</span><span class="p">(</span><span class="n">ext</span><span class="o">.</span><span class="n">ClassPathMapping</span><span class="p">):</span>
    <span class="n">namespace</span> <span class="o">=</span> <span class="s1">'bst.pygasus.demo.view'</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s1">'fanstatic/demo/view'</span>

<span class="k">class</span> <span class="nc">ViewClassPathMapping</span><span class="p">(</span><span class="n">ext</span><span class="o">.</span><span class="n">ClassPathMapping</span><span class="p">):</span>
    <span class="n">namespace</span> <span class="o">=</span> <span class="s1">'bst.pygasus.demo.contoller'</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s1">'fanstatic/demo/controller'</span>
</pre>
</div>
<div id="define-a-schema-schema-py">

<p>With this schema different ExtJS-Classes like form, store or model, are auto generated on the fly. Look at the package bst.pygasus.scaffolding for the supported types and class generation. Feel free to extend this with your own generators of ExtJS classes for your project. This schema will also be used to transform json to a python model or vice versa.</p>
<pre><span class="kn">from</span> <span class="nn">bst.pygasus.core</span> <span class="kn">import</span> <span class="n">ext</span>

<span class="kn">from</span> <span class="nn">zope</span> <span class="kn">import</span> <span class="n">schema</span>
<span class="kn">from</span> <span class="nn">zope.interface</span> <span class="kn">import</span> <span class="n">Interface</span>

<span class="nd">@ext.scaffolding</span><span class="p">(</span><span class="s1">'Card'</span><span class="p">,</span> <span class="s1">'Magic the Gathering'</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ICard</span><span class="p">(</span><span class="n">Interface</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Id</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">'ID'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">TextLine</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">'Name'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">costs</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">'Costs'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">publication</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">'Publication'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre>
</div>
<div id="create-a-model-model-py">

<p>The model is used to transfer data from the server to client and back.</p>
<pre><span class="kn">from</span> <span class="nn">bst.pygasus.core</span> <span class="kn">import</span> <span class="n">ext</span>
<span class="kn">from</span> <span class="nn">bst.pygasus.demo</span> <span class="kn">import</span> <span class="n">schema</span>
<span class="kn">from</span> <span class="nn">zope.schema.fieldproperty</span> <span class="kn">import</span> <span class="n">FieldProperty</span>

<span class="k">class</span> <span class="nc">Card</span><span class="p">(</span><span class="n">ext</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">ext</span><span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">schema</span><span class="o">.</span><span class="n">ICard</span><span class="p">)</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="n">ICard</span><span class="p">[</span><span class="s1">'id'</span><span class="p">])</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="n">ICard</span><span class="p">[</span><span class="s1">'name'</span><span class="p">])</span>
    <span class="n">costs</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="n">ICard</span><span class="p">[</span><span class="s1">'costs'</span><span class="p">])</span>
    <span class="n">publication</span> <span class="o">=</span> <span class="n">FieldProperty</span><span class="p">(</span><span class="n">ICard</span><span class="p">[</span><span class="s1">'publication'</span><span class="p">])</span>
</pre>
</div>
<div id="create-a-handler-for-crud-requests-handler-py">

<p>The handler for an definded model provides the CRUD operations. Now it is up to you to implement whatever you need in these methods.</p>
<pre><span class="k">class</span> <span class="nc">CardHandler</span><span class="p">(</span><span class="n">ext</span><span class="o">.</span><span class="n">AbstractModelHandler</span><span class="p">):</span>
    <span class="n">ext</span><span class="o">.</span><span class="n">adapts</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Card</span><span class="p">,</span> <span class="n">IRequest</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice</span><span class="p">()</span>
        <span class="nb">property</span><span class="p">,</span> <span class="n">direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">cardIndexer</span><span class="o">.</span><span class="n">search_index</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="nb">property</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">cardIndexer</span><span class="o">.</span><span class="n">get_next_id</span><span class="p">()</span>
        <span class="n">cardIndexer</span><span class="o">.</span><span class="n">extend_index</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">model</span><span class="p">],</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="n">cardIndexer</span><span class="o">.</span><span class="n">update_index</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">model</span><span class="p">],</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="n">cardIndexer</span><span class="o">.</span><span class="n">reduce_index</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">model</span><span class="p">],</span> <span class="mi">1</span>
</pre>
</div>
<div id="i18n-internationalization">

<p>Usually you define a domain name for each package. In order to do that you create an instance of MessageFactory in the __init__.py file:</p>
<pre><span class="kn">from</span> <span class="nn">zope.i18nmessageid</span> <span class="kn">import</span> <span class="n">MessageFactory</span>

<span class="n">_</span> <span class="o">=</span> <span class="n">MessageFactory</span><span class="p">(</span><span class="s1">'bst.pygasus.demo'</span><span class="p">)</span>
</pre>
<p>Now you can use translation messages anywhere you want to translate a string to multiple languages:</p>
<pre><span class="n">publication</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">'publication_title'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">'Publication'</span><span class="p">),</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre>
<p>If you want use translations in ExtJS, it works similar to translations in python. Simply write a variable at the top of the file and pass the domain name in the MessageFactory:</p>
<pre><span class="kd">var</span> <span class="nx">_</span> <span class="o">=</span> <span class="nx">i18n</span><span class="p">(</span><span class="s1">'bst.pygasus.demo'</span><span class="p">);</span>

<span class="nx">Ext</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s1">'bst.pygasus.demo.view.MainView'</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">extend</span><span class="o">:</span> <span class="s1">'Ext.container.Viewport'</span><span class="p">,</span>

    <span class="p">....</span>
</pre>
<p>Now you can translate messages with the variable defined anywhere in the class:</p>
<pre><span class="nx">items</span><span class="o">:</span> <span class="p">[{</span>
    <span class="nx">xtype</span><span class="o">:</span> <span class="s1">'button'</span><span class="p">,</span>
    <span class="nx">action</span><span class="o">:</span> <span class="s1">'save'</span><span class="p">,</span>
    <span class="nx">text</span><span class="o">:</span> <span class="nx">_</span><span class="p">(</span><span class="s1">'tr_save'</span><span class="p">,</span> <span class="s1">'Save'</span><span class="p">),</span>
<span class="p">},</span>
</pre>
<p>You can use the lingua package to crawl translation from python and ExtJS files and generate a .pot file with it. This application is already installed by  buildout. After generating a .pot file you can use different kinds of gettext tools to merge and build the final .po and .mo files for each language:</p>
<pre>./bin/pot-create –d &lt;domain&gt; -o &lt;filename&gt;.pot &lt;source&gt;
</pre>
</div>
<div id="using-scaffolding">

<p>Scaffolding provides default ExtJS-classes that can be directly used. Use the the “required” attribute to load a scaffolding class. In follow example we have defined the xtype to “DisplayCard”. This will generate a read only view with all fields from the schema ICard.</p>
<pre><span class="nx">Ext</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s1">'bst.pygasus.demo.view.CardView'</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">extend</span><span class="o">:</span> <span class="s1">'Ext.window.Window'</span><span class="p">,</span>

    <span class="nx">requires</span><span class="o">:</span> <span class="p">[</span>
        <span class="s1">'scaffolding.display.Card'</span>
    <span class="p">],</span>

    <span class="nx">itemId</span><span class="o">:</span> <span class="s1">'cardView'</span><span class="p">,</span>
    <span class="nx">layout</span><span class="o">:</span> <span class="s1">'vbox'</span><span class="p">,</span>

    <span class="nx">initComponent</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">me</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

        <span class="nx">me</span><span class="p">.</span><span class="nx">items</span> <span class="o">=</span> <span class="p">[{</span>
            <span class="nx">xtype</span><span class="o">:</span> <span class="s1">'DisplayCard'</span><span class="p">,</span>
            <span class="nx">itemId</span><span class="o">:</span> <span class="s1">'displayCard'</span><span class="p">,</span>
            <span class="nx">title</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
            <span class="nx">maxWidth</span><span class="o">:</span> <span class="s1">'500'</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nx">xtype</span><span class="o">:</span> <span class="s1">'button'</span><span class="p">,</span>
            <span class="nx">text</span><span class="o">:</span> <span class="s1">'Delete'</span><span class="p">,</span>
            <span class="nx">action</span><span class="o">:</span> <span class="s1">'delete'</span>
        <span class="p">}];</span>

        <span class="nx">me</span><span class="p">.</span><span class="nx">bodyPadding</span> <span class="o">=</span> <span class="s1">'5 5 5 5'</span><span class="p">;</span>

        <span class="nx">me</span><span class="p">.</span><span class="nx">callParent</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">});</span>
</pre>
<p>As an another example we use buffered store from scaffolding:</p>
<pre><span class="nx">Ext</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s1">'bst.pygasus.demo.controller.Main'</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">extend</span><span class="o">:</span> <span class="s1">'Ext.app.Controller'</span><span class="p">,</span>

    <span class="nx">requires</span><span class="o">:</span> <span class="p">[</span>
        <span class="s1">'scaffolding.bufferedstore.Card'</span>
    <span class="p">],</span>

    <span class="p">....</span>
</pre>
</div>
</div>
</div></body></html>