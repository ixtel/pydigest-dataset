<html><body><div><article id="post-1121" class="post-1121 post type-post status-publish format-standard hentry category-uncategorized">
	<header class="entry-header">
				<h1 class="entry-title">Django persistent memcached connections</h1>	</header>

	<div class="entry-content">
		<p>Recently we diagnosed an issue for several of our customers who were using the python Django web-framework. They were all experiencing performance issues and a reasonable amount of broken connections to our servers. The issue was that by default Django uses a new connection to memcached for each request. This is terrible for performance in general, paying the cost of an extra round-trip to setup the TCP connection, but is far worse with cloud-services like MemCachier that have an security layer and require new connections to be authenticated. A new connection to a MemCachier server takes at least 3 round-trips, which increases the time to execute a single <code>get</code> request by 4x.</p>
<p>It turned out this situation is the result of a very old and long-standing bug in Django (<a href="https://code.djangoproject.com/ticket/11331#no1" title="bug">#11331</a>). This bug arose due to a incorrect fix for another bug that Django had, one where it could continually create new connections to the memcached server without ever closing any of them until it eventually consumed all the available file descriptors at the server. Unfortunately this fix for this file descriptor leak was to simply close the memcached connection after all requests.</p>
<p>Thankfully we can fix this by monkey-patching Django and disabling the close method of the Memcached class. The best place to do this is in your Django <code>wsgi.py</code> file, inserting the code below before you create your application:</p>
<p/>
<p>That is, the full file may look something like follows:</p>
<p/>
<p>We’ve advised several customers to use this fix and they’ve had great results! We will soon be adding it to our docs as a recommended practice for Django.</p>
<div id="jp-post-flair" class="sharedaddy sd-like-enabled sd-sharing-enabled"><div class="sharedaddy sd-block sd-like jetpack-likes-widget-wrapper jetpack-likes-widget-unloaded" id="like-post-wrapper-63103873-1121-56d598fc8faf0" data-src="//widgets.wp.com/likes/#blog_id=63103873&amp;post_id=1121&amp;origin=blogdotmemcachierdotcom.wordpress.com&amp;obj_id=63103873-1121-56d598fc8faf0" data-name="like-post-frame-63103873-1121-56d598fc8faf0"><h3 class="sd-title">Like this:</h3><p class="likes-widget-placeholder post-likes-widget-placeholder"><span class="button"><span>Like</span></span> <span class="loading">Loading...</span></p><span class="sd-text-color"/><a class="sd-link-color"/></div>
<p id="jp-relatedposts" class="jp-relatedposts">
	<h3 class="jp-relatedposts-headline"><em>Related</em></h3>
</p></div>			</div>

	<footer class="entry-meta">
		<span class="post-date"><a href="http://blog.memcachier.com/2014/12/12/django-persistent-memcached-connections/" title="5:33 pm" rel="bookmark"><time class="entry-date" datetime="2014-12-12T17:33:33+00:00">December 12, 2014</time></a></span><span class="byline"><span class="author vcard"><a class="url fn n" href="http://blog.memcachier.com/author/memcachier/" title="View all posts by MemCachier" rel="author">MemCachier</a></span></span>					</footer>
</article>

				</div></body></html>