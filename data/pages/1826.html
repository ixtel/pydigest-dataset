<html><body><div><div class="content">
							
							
							
		
							<p><a href="http://t.umblr.com/redirect?z=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FFluent_interface&amp;t=OGRmM2M0ZjdlNWVjMmUzNTdlZjM5NjQyNjk4ZGVhY2JiNmVkOTY2OSxtTlRweHBGRQ%3D%3D" target="_blank">Fluent Interface</a> is an implementation of API which improves readability.</p>

<h3>Example</h3>

<p><code>Poem('The Road Not Taken').indent(4).suffix('Robert Frost')</code>.</p>

<p>Fluent Interface is similar to method chaining. I was wondering how to implement this in <code>Python</code>.
Returning <code>self</code> during method call seemed good idea .</p>

<pre><code>class Poem(object):
    def __init__(self, content):
        self.content = content

    def indent(self, spaces=4):
        self.content = " " * spaces + self.content
        return self

    def suffix(self, content):
        self.content += " - {}".format(content)
        return self

    def __str__(self):
        return self.content

&gt;&gt;&gt;print Poem('Road Not Taken').indent(4).suffix('Rober Frost').content
    Road Not Taken - Rober Frost
</code></pre>

<p>Everything seems to be ok here.</p>

<h3>Side effects</h3>

<p>Above approach has side effect. We are mutating the same object during every method call.
Consider the following code</p>

<pre><code>&gt;&gt;&gt;p = Poem('Road Not Taken')
&gt;&gt;&gt;q = p.indent(4)
&gt;&gt;&gt;r = p.indent(2)
&gt;&gt;&gt;print str(q) == str(r)
True
&gt;&gt;&gt;print id(q), id(r)
4459640464 4459640464
</code></pre>

<p>Clearly this isnâ€™t expected. <code>q</code> and <code>r</code> is pointing to same instance.
Ideally we should create a new instance during every method call and return the object.</p>

<h3>New object</h3>

<p><code>Decorator</code> is a function which takes a <code>function</code> as argument and returns a <code>function</code> (most cases).</p>

<pre><code>from functools import wraps

def newobj(method):
    @wraps(method)
    # Well, newobj can be decorated with function, but we will cover the case
    # where it decorated with method
    def inner(self, *args, **kwargs):
        obj = self.__class__.__new__(self.__class__)
        obj.__dict__ = self.__dict__.copy()
        method(obj, *args, **kwargs)
        return obj
    return inner


class NPoem(object):
    def __init__(self, content):
        self.content = content

    @newobj
    def indent(self, spaces=4):
        self.content = " " * spaces + self.content

    @newobj
    def suffix(self, content):
        self.content += " - {}".format(content)

    def __str__(self):
        return self.content

&gt;&gt;&gt;p = NPoem("foo")
&gt;&gt;&gt;q = p.indent(4)
&gt;&gt;&gt;r = p.indent(2)
&gt;&gt;&gt;print str(q) == str(r)
False
&gt;&gt;&gt;print(q)
    foo
&gt;&gt;&gt;print(r)
  foo
&gt;&gt;&gt;print id(q), id(r)
 4459642640 4459639248
</code></pre>

<p>In the above approach <code>newobj</code> decorator creates a new instance, copies all the atrributes,
calls the method with arguments and returns new <code>instance</code>. Rather than using decorator
private function can do the same.</p>

<p>Fluent Interface is used heavily in SQLAlchemy and Django. <a href="http://t.umblr.com/redirect?z=https%3A%2F%2Fgithub.com%2Fdjango%2Fdjango%2Fblob%2Fmaster%2Fdjango%2Fdb%2Fmodels%2Fquery.py%23L954&amp;t=MDA3M2RmMGVkZmI0YWVhMTUzMzA0YTQzMDYxOWZhZDg4OTVkODM2NSxtTlRweHBGRQ%3D%3D" target="_blank">Django</a>
uses <code>_clone</code> method to create new <code>QuerySet</code> and
<a href="http://t.umblr.com/redirect?z=https%3A%2F%2Fgithub.com%2Fzzzeek%2Fsqlalchemy%2Fblob%2F1cb94d89d5c4db7a914d9f30ebe0b676ab4e175b%2Flib%2Fsqlalchemy%2Fsql%2Fbase.py%23L308&amp;t=ZGQ0MWI4NmIyMDY1ZDU0OTkwYzE3YzZkYTFkZWE1ZjE1MTZmMWQ4NSxtTlRweHBGRQ%3D%3D" target="_blank">SQLAlchemy</a> uses
decorator based approach to create new <code>Query</code> instance.</p>

<p>Thanks <a href="https://twitter.com/kracetheking/status/525207441206558722" target="_blank">Mike Bayer</a> and <a href="https://twitter.com/kracetheking/status/525206909612085248" target="_blank">Daniel Roy Greenfeld</a>
helping me understand this.</p>

<p>Do you know any other way to implement this ? Feel free to comment.</p>
						</div>
						
						</div></body></html>