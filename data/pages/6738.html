<html><body><div><div class="entry-content"><p>Рассказывает автор блога <a href="https://nickdesaulniers.github.io/blog/" target="_blank" class="broken_link">Nick Desaulniers</a></p><hr/><p>Интерпретаторы и компиляторы — программы, которые используются для трансляции или запуска других программ. Интерпретируемые программы пишутся на языках вроде JavaScript, Ruby, Python, PHP и Perl. Программы, которым требуется компиляция — на C, C++ и, в какой-то степени, Java и C#.</p><p>Перевод в машинный код перед запуском (AOT — Ahead-Of-Time) занимает дополнительное время, однако даёт выигрыш в скорости работы. С другой стороны, интерпретатор может приступать к работе без задержек. Между этими двумя мирами есть золотая середина — JIT (Just-In-Time) компиляция. Интерпретация, обычная и JIT компиляция — эти способы могут выглядеть совершенно разными, но, на самом деле, они поразительно похожи. В этой статье я докажу это, продемонстрировав программные коды всех троих (для языка Brainfuck). Каждый занимает примерно 100 строк кода на C и доступен на <a href="https://github.com/nickdesaulniers/bf_interpreter_jit_compiler" target="_blank">GitHub</a>.<span id="more-8036"/></p><h3>Немного о самом Brainfuck</h3><p>Brainfuck — очень интересный (правда, сложный для чтения) полный по Тьюрингу язык. У него есть всего 8 операторов — <code>&gt; &lt; + - . , [ ]</code>. Всё просто, каждый оператор — это символ, посторонние символы игнорируются. В этой статье мы пропустим валидацию кода, сосредоточившиь на интерпретации и компиляции.</p><p>Программы на Brainfuck работают с массивом байтов из 30 000 ячеек, инициализированных нулями. Есть также указатель, который изначально указывает на первый элемент этого массива. Операторы же выполняют следующее:</p><ul><li><code>&gt; &lt;</code> — сдвигают указатель на одну ячейку вправо или влево соответственно;</li><li><code>+ -</code> — увеличивают или уменьшают значение в ячейке на единицу;</li><li><code>.</code> — выводит в виде символа значение ячейки, на которой находится указатель;</li><li><code>,</code> — записывает в виде ASCII кода введённое значение в ячейку, на которой находится указатель;</li><li><code>[</code> — если значение текущей ячейки нулевое, перейти вперёд к оператору <code>]</code> (с учётом вложенности);</li><li><code>]</code> — если значение текущей ячейки не нулевое, перейти назад к оператору <code>[</code> (c учётом вложенности).</li></ul><h3>Интерпретатор</h3><ul><li>Инициализация массива и указателя:<br/><div id="crayon-56d5b321697bb816910073" class="crayon-syntax crayon-theme-classic crayon-font-courier-new crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"/><div class="crayon-main"><table class="crayon-table"><tr class="crayon-row"><td class="crayon-nums " data-settings="show"/><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b321697bb816910073-1"><span class="crayon-c">// Создание массива из 30 000 нулей</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b321697bb816910073-2"><span class="crayon-t">unsigned</span><span class="crayon-h"> </span><span class="crayon-t">char</span><span class="crayon-h"> </span><span class="crayon-i">tape</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-cn">30000</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-sy">}</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d5b321697bb816910073-3"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b321697bb816910073-4"><span class="crayon-c">// Установка указателя на первый элемент</span></p><p class="crayon-line" id="crayon-56d5b321697bb816910073-5"><span class="crayon-t">unsigned</span><span class="crayon-h"> </span><span class="crayon-t">char</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">ptr</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tape</span><span class="crayon-sy">;</span></p></div></td></tr></table></div></div></li><li>Операторы перемещения указателя:<br/><div id="crayon-56d5b321697cf242130430" class="crayon-syntax crayon-theme-classic crayon-font-courier-new crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"/><div class="crayon-main"><table class="crayon-table"><tr class="crayon-row"><td class="crayon-nums " data-settings="show"/><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b321697cf242130430-1"><span class="crayon-st">case</span><span class="crayon-h"> </span><span class="crayon-s">'&gt;'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-o">++</span><span class="crayon-v">ptr</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-st">break</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b321697cf242130430-2"><span class="crayon-st">case</span><span class="crayon-h"> </span><span class="crayon-s">'&lt;'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">ptr</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-st">break</span><span class="crayon-sy">;</span></p></div></td></tr></table></div></div></li><li>Инкремент и декремент:<br/><div id="crayon-56d5b321697d5986954561" class="crayon-syntax crayon-theme-classic crayon-font-courier-new crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"/><div class="crayon-main"><table class="crayon-table"><tr class="crayon-row"><td class="crayon-nums " data-settings="show"/><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b321697d5986954561-1"><span class="crayon-st">case</span><span class="crayon-h"> </span><span class="crayon-s">'+'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-o">++</span><span class="crayon-sy">(</span><span class="crayon-o">*</span><span class="crayon-v">ptr</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-st">break</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b321697d5986954561-2"><span class="crayon-st">case</span><span class="crayon-h"> </span><span class="crayon-s">'-'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-sy">(</span><span class="crayon-o">*</span><span class="crayon-v">ptr</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-st">break</span><span class="crayon-sy">;</span></p></div></td></tr></table></div></div></li><li>Ввод и вывод:<br/><div id="crayon-56d5b321697d9142131325" class="crayon-syntax crayon-theme-classic crayon-font-courier-new crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"/><div class="crayon-main"><table class="crayon-table"><tr class="crayon-row"><td class="crayon-nums " data-settings="show"/><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b321697d9142131325-1"><span class="crayon-st">case</span><span class="crayon-h"> </span><span class="crayon-s">'.'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">putchar</span><span class="crayon-sy">(</span><span class="crayon-o">*</span><span class="crayon-v">ptr</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-st">break</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b321697d9142131325-2"><span class="crayon-st">case</span><span class="crayon-h"> </span><span class="crayon-s">','</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-v">ptr</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">getchar</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-st">break</span><span class="crayon-sy">;</span></p></div></td></tr></table></div></div></li><li>Операторы цикла:<br/><div id="crayon-56d5b321697de154590320" class="crayon-syntax crayon-theme-classic crayon-font-courier-new crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"/><div class="crayon-main"><table class="crayon-table"><tr class="crayon-row"><td class="crayon-nums " data-settings="show"><div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-56d5b321697de154590320-1">1</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b321697de154590320-2">2</p><p class="crayon-num" data-line="crayon-56d5b321697de154590320-3">3</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b321697de154590320-4">4</p><p class="crayon-num" data-line="crayon-56d5b321697de154590320-5">5</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b321697de154590320-6">6</p><p class="crayon-num" data-line="crayon-56d5b321697de154590320-7">7</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b321697de154590320-8">8</p><p class="crayon-num" data-line="crayon-56d5b321697de154590320-9">9</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b321697de154590320-10">10</p><p class="crayon-num" data-line="crayon-56d5b321697de154590320-11">11</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b321697de154590320-12">12</p><p class="crayon-num" data-line="crayon-56d5b321697de154590320-13">13</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b321697de154590320-14">14</p><p class="crayon-num" data-line="crayon-56d5b321697de154590320-15">15</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b321697de154590320-16">16</p><p class="crayon-num" data-line="crayon-56d5b321697de154590320-17">17</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b321697de154590320-18">18</p><p class="crayon-num" data-line="crayon-56d5b321697de154590320-19">19</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b321697de154590320-20">20</p><p class="crayon-num" data-line="crayon-56d5b321697de154590320-21">21</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b321697de154590320-22">22</p><p class="crayon-num" data-line="crayon-56d5b321697de154590320-23">23</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b321697de154590320-24">24</p><p class="crayon-num" data-line="crayon-56d5b321697de154590320-25">25</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b321697de154590320-26">26</p></div></td><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b321697de154590320-1"><span class="crayon-st">case</span><span class="crayon-h"> </span><span class="crayon-s">'['</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b321697de154590320-2"><span class="crayon-h">  </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-o">!</span><span class="crayon-sy">(</span><span class="crayon-o">*</span><span class="crayon-v">ptr</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-56d5b321697de154590320-3"><span class="crayon-h">    </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">loop</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">// Используется для хранения уровня вложенности</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b321697de154590320-4"><span class="crayon-h">    </span><span class="crayon-st">while</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">loop</span><span class="crayon-h"> </span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-56d5b321697de154590320-5"><span class="crayon-h">      </span><span class="crayon-t">unsigned</span><span class="crayon-h"> </span><span class="crayon-t">char</span><span class="crayon-h"> </span><span class="crayon-v">current_char</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">input</span><span class="crayon-sy">[</span><span class="crayon-o">++</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">// i - номер исполняемого опреатора</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b321697de154590320-6"><span class="crayon-h">      </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">current_char</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">']'</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-56d5b321697de154590320-7"><span class="crayon-h">        </span><span class="crayon-o">--</span><span class="crayon-v">loop</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b321697de154590320-8"><span class="crayon-h">      </span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">current_char</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">'['</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-56d5b321697de154590320-9"><span class="crayon-h">        </span><span class="crayon-o">++</span><span class="crayon-v">loop</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b321697de154590320-10"><span class="crayon-h">      </span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-56d5b321697de154590320-11"><span class="crayon-h">    </span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b321697de154590320-12"><span class="crayon-h">  </span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-56d5b321697de154590320-13"><span class="crayon-h">  </span><span class="crayon-st">break</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b321697de154590320-14"><span class="crayon-st">case</span><span class="crayon-h"> </span><span class="crayon-s">']'</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b321697de154590320-15"><span class="crayon-h">  </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-o">*</span><span class="crayon-v">ptr</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b321697de154590320-16"><span class="crayon-h">    </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">loop</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">// Используется для хранения уровня вложенности</span></p><p class="crayon-line" id="crayon-56d5b321697de154590320-17"><span class="crayon-h">    </span><span class="crayon-st">while</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">loop</span><span class="crayon-h"> </span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b321697de154590320-18"><span class="crayon-h">      </span><span class="crayon-t">unsigned</span><span class="crayon-h"> </span><span class="crayon-t">char</span><span class="crayon-h"> </span><span class="crayon-v">current_char</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">input</span><span class="crayon-sy">[</span><span class="crayon-o">--</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span><span class="crayon-c">// i - номер исполняемого опреатора</span></p><p class="crayon-line" id="crayon-56d5b321697de154590320-19"><span class="crayon-h">      </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">current_char</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">'['</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b321697de154590320-20"><span class="crayon-h">        </span><span class="crayon-o">--</span><span class="crayon-v">loop</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d5b321697de154590320-21"><span class="crayon-h">      </span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">current_char</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">']'</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b321697de154590320-22"><span class="crayon-h">        </span><span class="crayon-o">++</span><span class="crayon-v">loop</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d5b321697de154590320-23"><span class="crayon-h">      </span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b321697de154590320-24"><span class="crayon-h">    </span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-56d5b321697de154590320-25"><span class="crayon-h">  </span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b321697de154590320-26"><span class="crayon-h">  </span><span class="crayon-st">break</span><span class="crayon-sy">;</span></p></div></td></tr></table></div></div></li></ul><p>Как видите, в интерпретаторе нет ничего сложного. Получившийся <a href="https://github.com/nickdesaulniers/bf_interpreter_jit_compiler/blob/master/interpreter.c" target="_blank">код</a> занимает порядка пятидесяти строк и может выполнить все необходимые операции (правда, не слишком быстро).</p><h3>Компилятор</h3><p><em>Примечание:</em> нижеследующий код предполагает, что вы работаете с x86-64 ISA (Instruction Set Architecture — Архитектура набора команд) и UNIX ABI (Application Binary Interface — Двоичный интерфейс приложений).</p><p>В нашем компиляторе мы снова будем проходить по всем символам данной программы, пропуская их через <code>switch</code>. Но вместо того, чтобы выполнять действие, мы будем выводить в <code>stdout</code> инструкции ассемблера. Такой подход требует перенаправления <code>stdout</code> в файл, после чего на этом файле нужно будет запустить ассемблер и компоновщик. Мы с вами сосредоточимся именно на компилировании, а не на ассемблировании и компоновке.</p><ul><li>Для начала подготовим память для нашего компилятора:<br/><div id="crayon-56d5b321697e6776864276" class="crayon-syntax crayon-theme-classic crayon-font-courier-new crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"/><div class="crayon-main"><table class="crayon-table"><tr class="crayon-row"><td class="crayon-nums " data-settings="show"/><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b321697e6776864276-1"><span class="crayon-r">const</span><span class="crayon-h"> </span><span class="crayon-t">char</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-r">const</span><span class="crayon-h"> </span><span class="crayon-v">prologue</span><span class="crayon-h"> </span><span class="crayon-o">=</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b321697e6776864276-2"><span class="crayon-h">  </span><span class="crayon-s">".text\n"</span></p><p class="crayon-line" id="crayon-56d5b321697e6776864276-3"><span class="crayon-h">  </span><span class="crayon-s">".globl _main\n"</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b321697e6776864276-4"><span class="crayon-h">  </span><span class="crayon-s">"_main:\n"</span></p><p class="crayon-line" id="crayon-56d5b321697e6776864276-5"><span class="crayon-h">  </span><span class="crayon-s">"  pushq %rbp\n"</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b321697e6776864276-6"><span class="crayon-h">  </span><span class="crayon-s">"  movq %rsp, %rbp\n"</span></p><p class="crayon-line" id="crayon-56d5b321697e6776864276-7"><span class="crayon-h">  </span><span class="crayon-s">"  pushq %r12\n"</span><span class="crayon-h">        </span><span class="crayon-c">// Это будет нашим указателем</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b321697e6776864276-8"><span class="crayon-h">  </span><span class="crayon-s">"  subq $30008, %rsp\n"</span><span class="crayon-h"> </span><span class="crayon-c">// Размещаем 30 008 байтов в стеке</span></p><p class="crayon-line" id="crayon-56d5b321697e6776864276-9"><span class="crayon-h">  </span><span class="crayon-s">"  leaq (%rsp), %rdi\n"</span><span class="crayon-h"> </span><span class="crayon-c">// Адрес начала нашего хранилища</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b321697e6776864276-10"><span class="crayon-h">  </span><span class="crayon-s">"  movl $0, %esi\n"</span><span class="crayon-h">     </span><span class="crayon-c">// Заполняем нулями</span></p><p class="crayon-line" id="crayon-56d5b321697e6776864276-11"><span class="crayon-h">  </span><span class="crayon-s">"  movq $30000, %rdx\n"</span><span class="crayon-h"> </span><span class="crayon-c">// На 30 000 байтов</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b321697e6776864276-12"><span class="crayon-h">  </span><span class="crayon-s">"  call _memset\n"</span><span class="crayon-h">      </span><span class="crayon-c">// Вызываем memset</span></p><p class="crayon-line" id="crayon-56d5b321697e6776864276-13"><span class="crayon-h">  </span><span class="crayon-s">"  movq %rsp, %r12"</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b321697e6776864276-14"><span class="crayon-e">puts</span><span class="crayon-sy">(</span><span class="crayon-v">prologue</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p></div></td></tr></table></div></div>Если бы мы выделили 30000 байтов, то результатом выполнения <code>memset</code> стал бы segfault, ведь нам нужно место под указатели. Подробнее о работе со стеком в ассемблере вы можете прочитать в <a href="https://nickdesaulniers.github.io/blog/2014/04/18/lets-write-some-x86-64/" target="_blank">моей предыдущей статье</a> <sub>(англ.)</sub></li><li>С операторами сдвига указателя (<code>&gt; &lt;</code>) и инкремента\декремента (<code>+ -</code>) всё просто:<br/><div id="crayon-56d5b321697ef408262435" class="crayon-syntax crayon-theme-classic crayon-font-courier-new crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"/><div class="crayon-main"><table class="crayon-table"><tr class="crayon-row"><td class="crayon-nums " data-settings="show"/><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b321697ef408262435-1"><span class="crayon-st">case</span><span class="crayon-h"> </span><span class="crayon-s">'&gt;'</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b321697ef408262435-2"><span class="crayon-h">  </span><span class="crayon-e">puts</span><span class="crayon-sy">(</span><span class="crayon-s">"  inc %r12"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d5b321697ef408262435-3"><span class="crayon-h">  </span><span class="crayon-st">break</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b321697ef408262435-4"><span class="crayon-st">case</span><span class="crayon-h"> </span><span class="crayon-s">'&lt;'</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b321697ef408262435-5"><span class="crayon-h">  </span><span class="crayon-e">puts</span><span class="crayon-sy">(</span><span class="crayon-s">"  dec %r12"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b321697ef408262435-6"><span class="crayon-h">  </span><span class="crayon-st">break</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d5b321697ef408262435-7"><span class="crayon-st">case</span><span class="crayon-h"> </span><span class="crayon-s">'+'</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b321697ef408262435-8"><span class="crayon-h">  </span><span class="crayon-e">puts</span><span class="crayon-sy">(</span><span class="crayon-s">"  incb (%r12)"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d5b321697ef408262435-9"><span class="crayon-h">  </span><span class="crayon-st">break</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b321697ef408262435-10"><span class="crayon-st">case</span><span class="crayon-h"> </span><span class="crayon-s">'-'</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b321697ef408262435-11"><span class="crayon-h">  </span><span class="crayon-e">puts</span><span class="crayon-sy">(</span><span class="crayon-s">"  decb (%r12)"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b321697ef408262435-12"><span class="crayon-h">  </span><span class="crayon-st">break</span><span class="crayon-sy">;</span></p></div></td></tr></table></div></div></li><li>Для вывода (<code>.</code>) нам нужно скопировать байт с места, на котором стоит указатель, в место для первого аргумента <code>putchar</code>. Однако <code>putchar</code> принимает в качестве аргумента <code>int</code>. В x86-64 есть инструкция, котрая нам нужна — <code>movzXX</code>, где первый X — начальный размер (<code>b, w</code>), а второй — конечный (<code>w, l, q</code>).<br/><div id="crayon-56d5b321697f5652109137" class="crayon-syntax crayon-theme-classic crayon-font-courier-new crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"/><div class="crayon-main"><table class="crayon-table"><tr class="crayon-row"><td class="crayon-nums " data-settings="show"/><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b321697f5652109137-1"><span class="crayon-st">case</span><span class="crayon-h"> </span><span class="crayon-s">'.'</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b321697f5652109137-2"><span class="crayon-h">  </span><span class="crayon-e">puts</span><span class="crayon-sy">(</span><span class="crayon-s">"  movzbl (%r12), %edi"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d5b321697f5652109137-3"><span class="crayon-h">  </span><span class="crayon-e">puts</span><span class="crayon-sy">(</span><span class="crayon-s">"  call _putchar"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b321697f5652109137-4"><span class="crayon-h">  </span><span class="crayon-st">break</span><span class="crayon-sy">;</span></p></div></td></tr></table></div></div></li><li>Со вводом (<code>,</code>) всё тоже просто — вызываем <code>getchar</code>, перемещаем первые восемь бит в ячейку, помеченную указателем.<br/><div id="crayon-56d5b321697fe057291125" class="crayon-syntax crayon-theme-classic crayon-font-courier-new crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"/><div class="crayon-main"><table class="crayon-table"><tr class="crayon-row"><td class="crayon-nums " data-settings="show"/><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b321697fe057291125-1"><span class="crayon-st">case</span><span class="crayon-h"> </span><span class="crayon-s">','</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b321697fe057291125-2"><span class="crayon-h">  </span><span class="crayon-e">puts</span><span class="crayon-sy">(</span><span class="crayon-s">"  call _getchar"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d5b321697fe057291125-3"><span class="crayon-h">  </span><span class="crayon-e">puts</span><span class="crayon-sy">(</span><span class="crayon-s">"  movb %al, (%r12)"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">//%al - первые восемь бит из 64 %rax</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b321697fe057291125-4"><span class="crayon-h">  </span><span class="crayon-st">break</span><span class="crayon-sy">;</span></p></div></td></tr></table></div></div></li><li>Как и в прошлый раз, с операторами цикла (<code>[</code> и <code>]</code>) работы будет больше. Хорошим решением будет использовать прыжки к соответствующим меткам, но проблема в том, что имена меток должны быть уникальными. Я предлагаю следующее — у нас будет переменная, в которой будет хранится количество встреченых открывающих скобок, и стек, в который каждый раз, когда будет встречена открывающая скобка, будет записываться её номер. Когда же будет встречена закрывающая скобка — ей будет соответствовать индекс верхнего элемента стека. Вот, как это выглядит в коде:<br/><div id="crayon-56d5b32169804363396263" class="crayon-syntax crayon-theme-classic crayon-font-courier-new crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"/><div class="crayon-main"><table class="crayon-table"><tr class="crayon-row"><td class="crayon-nums " data-settings="show"/><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b32169804363396263-1"><span class="crayon-st">case</span><span class="crayon-h"> </span><span class="crayon-s">'['</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169804363396263-2"><span class="crayon-h">  </span><span class="crayon-e">stack_push</span><span class="crayon-sy">(</span><span class="crayon-o">&amp;</span><span class="crayon-v">stack</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">num_brackets</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">// Записываем номер последней встреченной открывающей скобки</span></p><p class="crayon-line" id="crayon-56d5b32169804363396263-3"><span class="crayon-h">  </span><span class="crayon-e">puts</span><span class="crayon-sy">(</span><span class="crayon-s">"  cmpb $0, (%r12)"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">/// Условие: если в текущей ячейке ноль...</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169804363396263-4"><span class="crayon-h">  </span><span class="crayon-r">printf</span><span class="crayon-sy">(</span><span class="crayon-s">"  je bracket_%d_end\n"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">num_brackets</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">// Если условие выполняется, осуществить прыжок к соответсвующей метке ниже</span></p><p class="crayon-line" id="crayon-56d5b32169804363396263-5"><span class="crayon-h">  </span><span class="crayon-r">printf</span><span class="crayon-sy">(</span><span class="crayon-s">"bracket_%d_start:\n"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">num_brackets</span><span class="crayon-o">++</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">// Поставить метку начала цикла с соответствующим номером</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169804363396263-6"><span class="crayon-h">  </span><span class="crayon-st">break</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d5b32169804363396263-7"><span class="crayon-st">case</span><span class="crayon-h"> </span><span class="crayon-s">']'</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169804363396263-8"><span class="crayon-h">  </span><span class="crayon-e">stack_pop</span><span class="crayon-sy">(</span><span class="crayon-o">&amp;</span><span class="crayon-v">stack</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">matching_bracket</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">// Достаём из стека номер последней открытой скобки</span></p><p class="crayon-line" id="crayon-56d5b32169804363396263-9"><span class="crayon-h">  </span><span class="crayon-e">puts</span><span class="crayon-sy">(</span><span class="crayon-s">"  cmpb $0, (%r12)"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">// Условие: если в текущей ячейке ноль...</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169804363396263-10"><span class="crayon-h">  </span><span class="crayon-r">printf</span><span class="crayon-sy">(</span><span class="crayon-s">"  jne bracket_%d_start\n"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">matching_bracket</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">// Если условие НЕ выолняется, осуществить прыжок к соответствующей метке выше</span></p><p class="crayon-line" id="crayon-56d5b32169804363396263-11"><span class="crayon-h">  </span><span class="crayon-r">printf</span><span class="crayon-sy">(</span><span class="crayon-s">"bracket_%d_end:\n"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">matching_bracket</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">// Поставить метку конца с соответствующим номером</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169804363396263-12"><span class="crayon-h">  </span><span class="crayon-st">break</span><span class="crayon-sy">;</span></p></div></td></tr></table></div></div>Таким образом, для соседствующих циклов (<code>[][]</code>) ассемблерный код будет следующим:<br/><div id="crayon-56d5b3216980b916881364" class="crayon-syntax crayon-theme-classic crayon-font-courier-new crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"/><div class="crayon-main"><table class="crayon-table"><tr class="crayon-row"><td class="crayon-nums " data-settings="show"/><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b3216980b916881364-1"><span class="crayon-r "> cmpb</span><span class="crayon-h"> </span><span class="crayon-cn">$0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v ">%r</span>12<span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b3216980b916881364-2"><span class="crayon-r ">  je</span><span class="crayon-h"> </span><span class="crayon-v ">bracket</span><span class="crayon-sy">_</span>0<span class="crayon-sy">_</span><span class="crayon-v ">end</span></p><p class="crayon-line" id="crayon-56d5b3216980b916881364-3"><span class="crayon-r ">bracket_0_start</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b3216980b916881364-4"> </p><p class="crayon-line" id="crayon-56d5b3216980b916881364-5"><span class="crayon-r ">  cmpb</span><span class="crayon-h"> </span><span class="crayon-cn">$0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v ">%r</span>12<span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b3216980b916881364-6"><span class="crayon-r ">  jne</span><span class="crayon-h"> </span><span class="crayon-v ">bracket</span><span class="crayon-sy">_</span>0<span class="crayon-sy">_</span><span class="crayon-v ">start</span></p><p class="crayon-line" id="crayon-56d5b3216980b916881364-7"><span class="crayon-r ">bracket_0_end</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b3216980b916881364-8"> </p><p class="crayon-line" id="crayon-56d5b3216980b916881364-9"><span class="crayon-r ">  cmpb</span><span class="crayon-h"> </span><span class="crayon-cn">$0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v ">%r</span>12<span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b3216980b916881364-10"><span class="crayon-r ">  je</span><span class="crayon-h"> </span><span class="crayon-v ">bracket</span><span class="crayon-sy">_</span>1<span class="crayon-sy">_</span><span class="crayon-v ">end</span></p><p class="crayon-line" id="crayon-56d5b3216980b916881364-11"><span class="crayon-r ">bracket_1_start</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b3216980b916881364-12"> </p><p class="crayon-line" id="crayon-56d5b3216980b916881364-13"><span class="crayon-r ">  cmpb</span><span class="crayon-h"> </span><span class="crayon-cn">$0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v ">%r</span>12<span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b3216980b916881364-14"><span class="crayon-r ">  jne</span><span class="crayon-h"> </span><span class="crayon-v ">bracket</span><span class="crayon-sy">_</span>1<span class="crayon-sy">_</span><span class="crayon-v ">start</span></p><p class="crayon-line" id="crayon-56d5b3216980b916881364-15"><span class="crayon-r ">bracket_1_end</span><span class="crayon-o">:</span></p></div></td></tr></table></div></div>…А для вложенных (<code>[[]]</code>) — следующим (обратите внимание на индексы):<br/><div id="crayon-56d5b32169810868587254" class="crayon-syntax crayon-theme-classic crayon-font-courier-new crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"/><div class="crayon-main"><table class="crayon-table"><tr class="crayon-row"><td class="crayon-nums " data-settings="show"/><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b32169810868587254-1"><span class="crayon-r "> cmpb</span><span class="crayon-h"> </span><span class="crayon-cn">$0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v ">%r</span>12<span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169810868587254-2"><span class="crayon-r ">  je</span><span class="crayon-h"> </span><span class="crayon-v ">bracket</span><span class="crayon-sy">_</span>0<span class="crayon-sy">_</span><span class="crayon-v ">end</span></p><p class="crayon-line" id="crayon-56d5b32169810868587254-3"><span class="crayon-r ">bracket_0_start</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169810868587254-4"> </p><p class="crayon-line" id="crayon-56d5b32169810868587254-5"><span class="crayon-r ">  cmpb</span><span class="crayon-h"> </span><span class="crayon-cn">$0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v ">%r</span>12<span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169810868587254-6"><span class="crayon-r ">  je</span><span class="crayon-h"> </span><span class="crayon-v ">bracket</span><span class="crayon-sy">_</span>1<span class="crayon-sy">_</span><span class="crayon-v ">end</span></p><p class="crayon-line" id="crayon-56d5b32169810868587254-7"><span class="crayon-r ">bracket_1_start</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169810868587254-8"> </p><p class="crayon-line" id="crayon-56d5b32169810868587254-9"><span class="crayon-r ">  cmpb</span><span class="crayon-h"> </span><span class="crayon-cn">$0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v ">%r</span>12<span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169810868587254-10"><span class="crayon-r ">  jne</span><span class="crayon-h"> </span><span class="crayon-v ">bracket</span><span class="crayon-sy">_</span>1<span class="crayon-sy">_</span><span class="crayon-v ">start</span></p><p class="crayon-line" id="crayon-56d5b32169810868587254-11"><span class="crayon-r ">bracket_1_end</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169810868587254-12"> </p><p class="crayon-line" id="crayon-56d5b32169810868587254-13"><span class="crayon-r ">  cmpb</span><span class="crayon-h"> </span><span class="crayon-cn">$0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v ">%r</span>12<span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169810868587254-14"><span class="crayon-r ">  jne</span><span class="crayon-h"> </span><span class="crayon-v ">bracket</span><span class="crayon-sy">_</span>0<span class="crayon-sy">_</span><span class="crayon-v ">start</span></p><p class="crayon-line" id="crayon-56d5b32169810868587254-15"><span class="crayon-r ">bracket_0_end</span><span class="crayon-o">:</span></p></div></td></tr></table></div></div></li><li>В конце нам нужно высвободить ресурсы:<br/><div id="crayon-56d5b32169815889982220" class="crayon-syntax crayon-theme-classic crayon-font-courier-new crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"/><div class="crayon-main"><table class="crayon-table"><tr class="crayon-row"><td class="crayon-nums " data-settings="show"/><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b32169815889982220-1"><span class="crayon-r">const</span><span class="crayon-h"> </span><span class="crayon-t">char</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-r">const</span><span class="crayon-h"> </span><span class="crayon-v">epilogue</span><span class="crayon-h"> </span><span class="crayon-o">=</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169815889982220-2"><span class="crayon-h">  </span><span class="crayon-s">"  addq $30008, %rsp\n"</span></p><p class="crayon-line" id="crayon-56d5b32169815889982220-3"><span class="crayon-h">  </span><span class="crayon-s">"  popq %r12\n"</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169815889982220-4"><span class="crayon-h">  </span><span class="crayon-s">"  popq %rbp\n"</span></p><p class="crayon-line" id="crayon-56d5b32169815889982220-5"><span class="crayon-h">  </span><span class="crayon-s">"  ret\n"</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169815889982220-6"><span class="crayon-e">puts</span><span class="crayon-sy">(</span><span class="crayon-v">epilogue</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p></div></td></tr></table></div></div></li></ul><p>Если вам понадобится отладить ваш Brainfuck код, с компилятором это будет ужасно — вам нужно будет компилировать код Brainfuck в код ассемблера, затем ассемблировать его, затем компоновать, и лишь потом вы сможете его запустить. Конечно, с интерперетатором всё проще — он выполняет код сразу же, платя за это быстродействием. Насколько велика разница в скорости, я напишу ниже.</p><p>Разве не было бы великолепно, если был бы способ совместить быстродействие компилятора и удобство интерпретатора? Такой способ есть — JIT компиляция.</p><h3>JIT компилятор</h3><p>Вы можете ознакомиться с моей <a href="https://nickdesaulniers.github.io/blog/2013/04/03/basic-jit/" target="_blank">предыдущей статьёй</a> <sub>(англ.)</sub> на эту тему, сейчас мы будем делать ровно то же самое — создадим выполняемую память, запишем туда байткод, потом приведём эту память к ссылке на функцию и вызовем её. Как и в предыдущих разделах, мы будем выполнять действия по мере чтения символов из Brainfuck исходника, однако теперь мы будем записывать опкоды в динамический массив. Он будет равномерно увеличиваться по мере нашего чтения, что в дальнейшем упростит вычисление оффсетов для операторов ветвления.</p><p>Ещё одна особенность заключается в том, что мы будем передавать адреса наших libc функций (<code>memset</code>, <code>putchar</code> и <code>getchar</code>) нашим JIT функциям прямо во время исполнения. Я имею в виду, что мы будем делать так:</p><div id="crayon-56d5b32169820266538446" class="crayon-syntax crayon-theme-classic crayon-font-courier-new crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"/><div class="crayon-main"><table class="crayon-table"><tr class="crayon-row"><td class="crayon-nums " data-settings="show"/><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b32169820266538446-1"><span class="crayon-r">typedef</span><span class="crayon-h"> </span><span class="crayon-t">void</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-e">fn_memset</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-t">void</span><span class="crayon-o">*</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">size_t</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169820266538446-2"><span class="crayon-r">typedef</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-e">fn_putchar</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d5b32169820266538446-3"><span class="crayon-r">typedef</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-e">fn_getchar</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169820266538446-4"><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-o">*</span><span class="crayon-v">jitted_func</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">fn_memset</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">fn_putchar</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">fn_getchar</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">mem</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d5b32169820266538446-5"><span class="crayon-e">jitted_func</span><span class="crayon-sy">(</span><span class="crayon-v">memset</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">putchar</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">getchar</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p></div></td></tr></table></div></div><p> Итак, приступим.</p><p>Наш «пролог» — операции для подготовки памяти — достаточно сложный, поэтому я буду расписывать его пошагово.</p><div id="crayon-56d5b32169825436742339" class="crayon-syntax crayon-theme-classic crayon-font-courier-new crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"/><div class="crayon-main"><table class="crayon-table"><tr class="crayon-row"><td class="crayon-nums " data-settings="show"/><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b32169825436742339-1"><span class="crayon-t">char</span><span class="crayon-h"> </span><span class="crayon-i">prologue</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169825436742339-2"> </p><p class="crayon-line" id="crayon-56d5b32169825436742339-3"><span class="crayon-h">  </span><span class="crayon-cn">0x55</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-c">// push rbp</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169825436742339-4"><span class="crayon-h">  </span><span class="crayon-cn">0x48</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x89</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0xE5</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-c">// mov rsp, rbp</span></p></div></td></tr></table></div></div><ul><li>Теперь нам нужно сохранить указатели на наши функции:<br/><div id="crayon-56d5b3216982a390364122" class="crayon-syntax crayon-theme-classic crayon-font-courier-new crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"/><div class="crayon-main"><table class="crayon-table"><tr class="crayon-row"><td class="crayon-nums " data-settings="show"/><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b3216982a390364122-1"><span class="crayon-h">  </span><span class="crayon-cn">0x41</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x54</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-c">// pushq %r12</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b3216982a390364122-2"><span class="crayon-h">  </span><span class="crayon-cn">0x41</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x55</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-c">// pushq %r13</span></p><p class="crayon-line" id="crayon-56d5b3216982a390364122-3"><span class="crayon-h">  </span><span class="crayon-cn">0x41</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x56</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-c">// pushq %r14</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b3216982a390364122-4"><span class="crayon-h">  </span><span class="crayon-cn">0x49</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x89</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0xFC</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-c">// movq %rdi, %r12 (memset)</span></p><p class="crayon-line" id="crayon-56d5b3216982a390364122-5"><span class="crayon-h">  </span><span class="crayon-cn">0x49</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x89</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0xF5</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-c">// movq %rsi, %r13 (putchar)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b3216982a390364122-6"><span class="crayon-h">  </span><span class="crayon-cn">0x49</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x89</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0xD6</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-c">// movq %rdx, %r14 (getchar)</span></p></div></td></tr></table></div></div></li><li>Затем выделим 30 008 байт на стеке:<br/><div id="crayon-56d5b3216982f543789804" class="crayon-syntax crayon-theme-classic crayon-font-courier-new crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"/><div class="crayon-main"><table class="crayon-table"><tr class="crayon-row"><td class="crayon-nums " data-settings="show"/><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b3216982f543789804-1"><span class="crayon-h">  </span><span class="crayon-cn">0x48</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x81</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0xEC</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x38</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x75</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x00</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x00</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-c">// subq $30008, %rsp</span></p></div></td></tr></table></div></div>Здесь мы столкнулись с числом больше байта. Где же в этой инструкции число 30 008? Оно в следующих четырёх байтах: <code>0x38, 0x75, 0x00, 0x00</code>. Замечу, что если человек привык воспринимать числа в системе «Big Endian», в которой младшие разряды находятся справа, то здесь необходимо использовать «Little Endian». То есть, <code>0x38, 0x75, 0x00, 0x00</code> в «Little Endian» — это <code>0x00, 0x00, 0x75, 0x38</code> в «Big Endian», оба обозначают <code>7*16^3+5*16^2+3*16^1+8*16^0</code> или 30008 в десятичной системе.</li><li>Теперь подготавливаем и запускаем <code>memset</code>:<br/><div id="crayon-56d5b32169838814161445" class="crayon-syntax crayon-theme-classic crayon-font-courier-new crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"/><div class="crayon-main"><table class="crayon-table"><tr class="crayon-row"><td class="crayon-nums " data-settings="show"/><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b32169838814161445-1"><span class="crayon-h">  </span><span class="crayon-c">// Адрес начала хранилища</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169838814161445-2"><span class="crayon-h">  </span><span class="crayon-cn">0x48</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x8D</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x3C</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x24</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-c">// leaq (%rsp), %rdi</span></p><p class="crayon-line" id="crayon-56d5b32169838814161445-3"><span class="crayon-h">  </span><span class="crayon-c">// Заполняем нулями</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169838814161445-4"><span class="crayon-h">  </span><span class="crayon-cn">0xBE</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x00</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x00</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x00</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x00</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-c">// movl $0, %esi</span></p><p class="crayon-line" id="crayon-56d5b32169838814161445-5"><span class="crayon-h">  </span><span class="crayon-c">// Длина 30,000 байтов</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169838814161445-6"><span class="crayon-h">  </span><span class="crayon-cn">0x48</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0xC7</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0xC2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x30</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x75</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x00</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x00</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-c">// movq $30000, %rdx</span></p><p class="crayon-line" id="crayon-56d5b32169838814161445-7"><span class="crayon-h">  </span><span class="crayon-c">// Вызываем memset</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169838814161445-8"><span class="crayon-h">  </span><span class="crayon-cn">0x41</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0xFF</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0xD4</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-c">// callq *%r12</span></p></div></td></tr></table></div></div></li><li>На этом этапе нам больше не нужен <code>memset</code>, поэтому его место (<code>%r12</code>) занимает указатель на текущую ячейку:<br/><div id="crayon-56d5b3216983e428671563" class="crayon-syntax crayon-theme-classic crayon-font-courier-new crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"/><div class="crayon-main"><table class="crayon-table"><tr class="crayon-row"><td class="crayon-nums " data-settings="show"/><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b3216983e428671563-1"><span class="crayon-h">  </span><span class="crayon-cn">0x49</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x89</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0xE4</span><span class="crayon-h"> </span><span class="crayon-c">// movq %rsp, %r12</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b3216983e428671563-2"><span class="crayon-sy">}</span><span class="crayon-sy">;</span></p></div></td></tr></table></div></div></li></ul><p>С «прологом» на этом всё.</p><ul><li>Добавим «пролог» в наш динамический массив:<br/><div id="crayon-56d5b32169843383417058" class="crayon-syntax crayon-theme-classic crayon-font-courier-new crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"/><div class="crayon-main"><table class="crayon-table"><tr class="crayon-row"><td class="crayon-nums " data-settings="show"/><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b32169843383417058-1"><span class="crayon-e">vector_push</span><span class="crayon-sy">(</span><span class="crayon-o">&amp;</span><span class="crayon-v">instruction_stream</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">prologue</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">sizeof</span><span class="crayon-sy">(</span><span class="crayon-v">prologue</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p></div></td></tr></table></div></div></li><li>Теперь перебираем символы Brainfuck программы. С инкрементом и декрементом всё по-старому:<br/><div id="crayon-56d5b32169848202920554" class="crayon-syntax crayon-theme-classic crayon-font-courier-new crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"/><div class="crayon-main"><table class="crayon-table"><tr class="crayon-row"><td class="crayon-nums " data-settings="show"/><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b32169848202920554-1"><span class="crayon-st">case</span><span class="crayon-h"> </span><span class="crayon-s">'+'</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169848202920554-2"><span class="crayon-h">  </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-56d5b32169848202920554-3"><span class="crayon-h">    </span><span class="crayon-t">char</span><span class="crayon-h"> </span><span class="crayon-i">opcodes</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169848202920554-4"><span class="crayon-h">      </span><span class="crayon-cn">0x41</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0xFE</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x04</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x24</span><span class="crayon-h"> </span><span class="crayon-c">// incb (%r12)</span></p><p class="crayon-line" id="crayon-56d5b32169848202920554-5"><span class="crayon-h">    </span><span class="crayon-sy">}</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169848202920554-6"><span class="crayon-h">    </span><span class="crayon-e">vector_push</span><span class="crayon-sy">(</span><span class="crayon-o">&amp;</span><span class="crayon-v">instruction_stream</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">opcodes</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">sizeof</span><span class="crayon-sy">(</span><span class="crayon-v">opcodes</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d5b32169848202920554-7"><span class="crayon-h">  </span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169848202920554-8"><span class="crayon-h">  </span><span class="crayon-st">break</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d5b32169848202920554-9"><span class="crayon-st">case</span><span class="crayon-h"> </span><span class="crayon-s">'-'</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169848202920554-10"><span class="crayon-h">  </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-56d5b32169848202920554-11"><span class="crayon-h">    </span><span class="crayon-t">char</span><span class="crayon-h"> </span><span class="crayon-i">opcodes</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169848202920554-12"><span class="crayon-h">      </span><span class="crayon-cn">0x41</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0xFE</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x0C</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x24</span><span class="crayon-h"> </span><span class="crayon-c">// decv (%r12)</span></p><p class="crayon-line" id="crayon-56d5b32169848202920554-13"><span class="crayon-h">    </span><span class="crayon-sy">}</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169848202920554-14"><span class="crayon-h">    </span><span class="crayon-e">vector_push</span><span class="crayon-sy">(</span><span class="crayon-o">&amp;</span><span class="crayon-v">instruction_stream</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">opcodes</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">sizeof</span><span class="crayon-sy">(</span><span class="crayon-v">opcodes</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d5b32169848202920554-15"><span class="crayon-h">  </span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169848202920554-16"><span class="crayon-h">  </span><span class="crayon-st">break</span><span class="crayon-sy">;</span></p></div></td></tr></table></div></div>Дополнительный блок кода (<code>{ char opcodes...}</code>) нужен из-за того, что в C\C++ мы <a href="http://stackoverflow.com/questions/92396/why-cant-variables-be-declared-in-a-switch-statement/8550253#8550253" target="_blank">не можем</a> создавать переменные прямо внутри <code>switch</code>.</li><li>Сдвиги указателя:<br/><div id="crayon-56d5b3216984d397475967" class="crayon-syntax crayon-theme-classic crayon-font-courier-new crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"/><div class="crayon-main"><table class="crayon-table"><tr class="crayon-row"><td class="crayon-nums " data-settings="show"/><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b3216984d397475967-1">с<span class="crayon-i">ase</span><span class="crayon-h"> </span><span class="crayon-s">'&gt;'</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b3216984d397475967-2"><span class="crayon-h">  </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-56d5b3216984d397475967-3"><span class="crayon-h">    </span><span class="crayon-t">char</span><span class="crayon-h"> </span><span class="crayon-i">opcodes</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b3216984d397475967-4"><span class="crayon-h">      </span><span class="crayon-cn">0x49</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0xFF</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0xC4</span><span class="crayon-h"> </span><span class="crayon-c">// inc %r12</span></p><p class="crayon-line" id="crayon-56d5b3216984d397475967-5"><span class="crayon-h">    </span><span class="crayon-sy">}</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b3216984d397475967-6"><span class="crayon-h">    </span><span class="crayon-e">vector_push</span><span class="crayon-sy">(</span><span class="crayon-o">&amp;</span><span class="crayon-v">amp</span><span class="crayon-sy">;</span><span class="crayon-v">instruction_stream</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">opcodes</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">sizeof</span><span class="crayon-sy">(</span><span class="crayon-v">opcodes</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d5b3216984d397475967-7"><span class="crayon-h">  </span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b3216984d397475967-8"><span class="crayon-h">  </span><span class="crayon-st">break</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d5b3216984d397475967-9"><span class="crayon-st">case</span><span class="crayon-h"> </span><span class="crayon-s">'&lt;'</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b3216984d397475967-10"><span class="crayon-h">  </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-56d5b3216984d397475967-11"><span class="crayon-h">    </span><span class="crayon-t">char</span><span class="crayon-h"> </span><span class="crayon-i">opcodes</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b3216984d397475967-12"><span class="crayon-h">      </span><span class="crayon-cn">0x49</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0xFF</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0xCC</span><span class="crayon-h"> </span><span class="crayon-c">// dec %r12</span></p><p class="crayon-line" id="crayon-56d5b3216984d397475967-13"><span class="crayon-h">    </span><span class="crayon-sy">}</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b3216984d397475967-14"><span class="crayon-h">    </span><span class="crayon-e">vector_push</span><span class="crayon-sy">(</span><span class="crayon-o">&amp;</span><span class="crayon-v">amp</span><span class="crayon-sy">;</span><span class="crayon-v">instruction_stream</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">opcodes</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">sizeof</span><span class="crayon-sy">(</span><span class="crayon-v">opcodes</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d5b3216984d397475967-15"><span class="crayon-h">  </span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b3216984d397475967-16"><span class="crayon-h">  </span><span class="crayon-st">break</span><span class="crayon-sy">;</span></p></div></td></tr></table></div></div></li><li>Ввод и вывод:<br/><div id="crayon-56d5b32169852017489703" class="crayon-syntax crayon-theme-classic crayon-font-courier-new crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"/><div class="crayon-main"><table class="crayon-table"><tr class="crayon-row"><td class="crayon-nums " data-settings="show"><div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-56d5b32169852017489703-1">1</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b32169852017489703-2">2</p><p class="crayon-num" data-line="crayon-56d5b32169852017489703-3">3</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b32169852017489703-4">4</p><p class="crayon-num" data-line="crayon-56d5b32169852017489703-5">5</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b32169852017489703-6">6</p><p class="crayon-num" data-line="crayon-56d5b32169852017489703-7">7</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b32169852017489703-8">8</p><p class="crayon-num" data-line="crayon-56d5b32169852017489703-9">9</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b32169852017489703-10">10</p><p class="crayon-num" data-line="crayon-56d5b32169852017489703-11">11</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b32169852017489703-12">12</p><p class="crayon-num" data-line="crayon-56d5b32169852017489703-13">13</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b32169852017489703-14">14</p><p class="crayon-num" data-line="crayon-56d5b32169852017489703-15">15</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b32169852017489703-16">16</p><p class="crayon-num" data-line="crayon-56d5b32169852017489703-17">17</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5b32169852017489703-18">18</p></div></td><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b32169852017489703-1"><span class="crayon-st">case</span><span class="crayon-h"> </span><span class="crayon-s">'.'</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169852017489703-2"><span class="crayon-h">  </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-56d5b32169852017489703-3"><span class="crayon-h">    </span><span class="crayon-t">char</span><span class="crayon-h"> </span><span class="crayon-i">opcodes</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169852017489703-4"><span class="crayon-h">      </span><span class="crayon-cn">0x41</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x0F</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0xB6</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x3C</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x24</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-c">// movzbl (%r12), %edi</span></p><p class="crayon-line" id="crayon-56d5b32169852017489703-5"><span class="crayon-h">      </span><span class="crayon-cn">0x41</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0xFF</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0xD5</span><span class="crayon-h"> </span><span class="crayon-c">// callq *%r13</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169852017489703-6"><span class="crayon-h">    </span><span class="crayon-sy">}</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d5b32169852017489703-7"><span class="crayon-h">    </span><span class="crayon-e">vector_push</span><span class="crayon-sy">(</span><span class="crayon-o">&amp;</span><span class="crayon-v">instruction_stream</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">opcodes</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">sizeof</span><span class="crayon-sy">(</span><span class="crayon-v">opcodes</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169852017489703-8"><span class="crayon-h">  </span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-56d5b32169852017489703-9"><span class="crayon-h">  </span><span class="crayon-st">break</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169852017489703-10"><span class="crayon-st">case</span><span class="crayon-h"> </span><span class="crayon-s">','</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5b32169852017489703-11"><span class="crayon-h">  </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169852017489703-12"><span class="crayon-h">    </span><span class="crayon-t">char</span><span class="crayon-h"> </span><span class="crayon-i">opcodes</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-56d5b32169852017489703-13"><span class="crayon-h">      </span><span class="crayon-cn">0x41</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0xFF</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0xD6</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-c">// callq *%r14</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169852017489703-14"><span class="crayon-h">      </span><span class="crayon-cn">0x41</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x88</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x04</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x24</span><span class="crayon-h"> </span><span class="crayon-c">// movb %al, (%r12)</span></p><p class="crayon-line" id="crayon-56d5b32169852017489703-15"><span class="crayon-h">    </span><span class="crayon-sy">}</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169852017489703-16"><span class="crayon-h">    </span><span class="crayon-e">vector_push</span><span class="crayon-sy">(</span><span class="crayon-o">&amp;</span><span class="crayon-v">instruction_stream</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">opcodes</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">sizeof</span><span class="crayon-sy">(</span><span class="crayon-v">opcodes</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d5b32169852017489703-17"><span class="crayon-h">  </span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169852017489703-18"><span class="crayon-h">  </span><span class="crayon-st">break</span><span class="crayon-sy">;</span></p></div></td></tr></table></div></div></li><li>Мы дошли до операторов цикла — это самая интересная часть. При написании компилятора мы оставили вычисление оффсетов (отступов) ассемблеру. Теперь нам придётся самим решать следующую проблему: <em>на сколько байтов нам нужно перескочить вперёд, чтоб мы попали к закрывающей скобке, которую мы ещё не видели</em>? Мы поступим следующим образом:<br/><div id="crayon-56d5b32169858671640035" class="crayon-syntax crayon-theme-classic crayon-font-courier-new crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"/><div class="crayon-main"><table class="crayon-table"><tr class="crayon-row"><td class="crayon-nums " data-settings="show"/><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b32169858671640035-1"><span class="crayon-st">case</span><span class="crayon-h"> </span><span class="crayon-s">'['</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169858671640035-2"><span class="crayon-h">  </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-56d5b32169858671640035-3"><span class="crayon-h">    </span><span class="crayon-t">char</span><span class="crayon-h"> </span><span class="crayon-i">opcodes</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169858671640035-4"><span class="crayon-h">      </span><span class="crayon-cn">0x41</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x80</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x3C</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x24</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x00</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-c">// cmpb $0, (%r12)</span></p><p class="crayon-line" id="crayon-56d5b32169858671640035-5"><span class="crayon-h">      </span><span class="crayon-c">// Будет исправлено:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169858671640035-6"><span class="crayon-h">      </span><span class="crayon-cn">0x0F</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x84</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x00</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x00</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x00</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x00</span><span class="crayon-h"> </span><span class="crayon-c">// je &lt;32b relative offset, 2's compliment, LE&gt;</span></p><p class="crayon-line" id="crayon-56d5b32169858671640035-7"><span class="crayon-h">    </span><span class="crayon-sy">}</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169858671640035-8"><span class="crayon-h">    </span><span class="crayon-e">vector_push</span><span class="crayon-sy">(</span><span class="crayon-o">&amp;</span><span class="crayon-v">instruction_stream</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">opcodes</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">sizeof</span><span class="crayon-sy">(</span><span class="crayon-v">opcodes</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d5b32169858671640035-9"><span class="crayon-h">  </span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169858671640035-10"><span class="crayon-h">  </span><span class="crayon-e">stack_push</span><span class="crayon-sy">(</span><span class="crayon-o">&amp;</span><span class="crayon-v">relocation_table</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">instruction_stream</span><span class="crayon-sy">.</span><span class="crayon-v">size</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">// создаём метку</span></p><p class="crayon-line" id="crayon-56d5b32169858671640035-11"><span class="crayon-h">  </span><span class="crayon-st">break</span><span class="crayon-sy">;</span></p></div></td></tr></table></div></div>Сейчас мы оставили оффсет пустым (четыре нулевых байта), но мы позже вернёмся к этому. Сейчас мы записываем в <code>relocation_table</code> текущий размер массива инструкций, а по совместительству — место последней встреченной открывающей скобки. Вся магия раскрывается, когда мы встретим закрывающую скобку. Сначала мы просто записываем незаконченные инструкции в динамический массив, как и в случае с открывающей скобкой:<br/><div id="crayon-56d5b32169861056905686" class="crayon-syntax crayon-theme-classic crayon-font-courier-new crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"/><div class="crayon-main"><table class="crayon-table"><tr class="crayon-row"><td class="crayon-nums " data-settings="show"/><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b32169861056905686-1"><span class="crayon-i">ase</span><span class="crayon-h"> </span><span class="crayon-s">']'</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169861056905686-2"><span class="crayon-h">  </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-56d5b32169861056905686-3"><span class="crayon-h">    </span><span class="crayon-t">char</span><span class="crayon-h"> </span><span class="crayon-i">opcodes</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169861056905686-4"><span class="crayon-h">      </span><span class="crayon-cn">0x41</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x80</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x3C</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x24</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x00</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-c">// cmpb $0, (%r12)</span></p><p class="crayon-line" id="crayon-56d5b32169861056905686-5"><span class="crayon-h">      </span><span class="crayon-c">// Будет исправлено:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169861056905686-6"><span class="crayon-h">      </span><span class="crayon-cn">0x0F</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x85</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x00</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x00</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x00</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x00</span><span class="crayon-h"> </span><span class="crayon-c">// jne &lt;33b relative offset, 2's compliment, LE&gt;</span></p><p class="crayon-line" id="crayon-56d5b32169861056905686-7"><span class="crayon-h">    </span><span class="crayon-sy">}</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169861056905686-8"><span class="crayon-h">    </span><span class="crayon-e">vector_push</span><span class="crayon-sy">(</span><span class="crayon-o">&amp;</span><span class="crayon-v">instruction_stream</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">opcodes</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">sizeof</span><span class="crayon-sy">(</span><span class="crayon-v">opcodes</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d5b32169861056905686-9"><span class="crayon-h">  </span><span class="crayon-sy">}</span></p></div></td></tr></table></div></div>…Затем мы вычисляем оффсет:<br/><div id="crayon-56d5b32169867361642490" class="crayon-syntax crayon-theme-classic crayon-font-courier-new crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"/><div class="crayon-main"><table class="crayon-table"><tr class="crayon-row"><td class="crayon-nums " data-settings="show"/><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b32169867361642490-1"><span class="crayon-h">  </span><span class="crayon-c">// ...</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169867361642490-2"><span class="crayon-h">  </span><span class="crayon-e">stack_pop</span><span class="crayon-sy">(</span><span class="crayon-o">&amp;</span><span class="crayon-v">relocation_table</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">relocation_site</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d5b32169867361642490-3"><span class="crayon-h">  </span><span class="crayon-v">relative_offset</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">instruction_stream</span><span class="crayon-sy">.</span><span class="crayon-v">size</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">relocation_site</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169867361642490-4"><span class="crayon-h">  </span><span class="crayon-c">// ...</span></p></div></td></tr></table></div></div>…А теперь записываем его вместо нулей (4 — не магическая константа, это количество байт, которые мы оставили пустыми):<br/><div id="crayon-56d5b3216986c502906238" class="crayon-syntax crayon-theme-classic crayon-font-courier-new crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"/><div class="crayon-main"><table class="crayon-table"><tr class="crayon-row"><td class="crayon-nums " data-settings="show"/><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b3216986c502906238-1"><span class="crayon-h"> </span><span class="crayon-c">// ...</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b3216986c502906238-2"><span class="crayon-h">  </span><span class="crayon-e">vector_write32LE</span><span class="crayon-sy">(</span><span class="crayon-o">&amp;</span><span class="crayon-v">instruction_stream</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">instruction_stream</span><span class="crayon-sy">.</span><span class="crayon-v">size</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-cn">4</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">relative_offset</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d5b3216986c502906238-3"><span class="crayon-h">  </span><span class="crayon-e">vector_write32LE</span><span class="crayon-sy">(</span><span class="crayon-o">&amp;</span><span class="crayon-v">instruction_stream</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">relocation_site</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-cn">4</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">relative_offset</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b3216986c502906238-4"><span class="crayon-h">  </span><span class="crayon-st">break</span><span class="crayon-sy">;</span></p></div></td></tr></table></div></div></li><li>Снова подчищаем за собой:<br/><div id="crayon-56d5b32169871774202604" class="crayon-syntax crayon-theme-classic crayon-font-courier-new crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"/><div class="crayon-main"><table class="crayon-table"><tr class="crayon-row"><td class="crayon-nums " data-settings="show"/><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b32169871774202604-1"><span class="crayon-t">char</span><span class="crayon-h"> </span><span class="crayon-i">epilogue</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169871774202604-2"><span class="crayon-h">  </span><span class="crayon-cn">0x48</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x81</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0xC4</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x38</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x75</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x00</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x00</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-c">// addq $30008, %rsp</span></p><p class="crayon-line" id="crayon-56d5b32169871774202604-3"><span class="crayon-h">  </span><span class="crayon-cn">0x41</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x5E</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-c">// popq %r14</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169871774202604-4"><span class="crayon-h">  </span><span class="crayon-cn">0x41</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x5D</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-c">// popq %r13</span></p><p class="crayon-line" id="crayon-56d5b32169871774202604-5"><span class="crayon-h">  </span><span class="crayon-cn">0x41</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x5C</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-c">// popq %r12</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169871774202604-6"><span class="crayon-h">  </span><span class="crayon-cn">0x5d</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-c">// pop rbp</span></p><p class="crayon-line" id="crayon-56d5b32169871774202604-7"><span class="crayon-h">  </span><span class="crayon-cn">0xC3</span><span class="crayon-h"> </span><span class="crayon-c">// ret</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169871774202604-8"><span class="crayon-sy">}</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d5b32169871774202604-9"><span class="crayon-e">vector_push</span><span class="crayon-sy">(</span><span class="crayon-o">&amp;</span><span class="crayon-v">instruction_stream</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epilogue</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">sizeof</span><span class="crayon-sy">(</span><span class="crayon-v">epilogue</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p></div></td></tr></table></div></div></li><li>Теперь запускаем наши инструкции и чистим всё в последний раз:<br/><div id="crayon-56d5b32169876755509000" class="crayon-syntax crayon-theme-classic crayon-font-courier-new crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"/><div class="crayon-main"><table class="crayon-table"><tr class="crayon-row"><td class="crayon-nums " data-settings="show"/><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b32169876755509000-1"><span class="crayon-t">void</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">mem</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">mmap</span><span class="crayon-sy">(</span><span class="crayon-t">NULL</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">instruction_stream</span><span class="crayon-sy">.</span><span class="crayon-v">size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">PROT_WRITE</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">PROT_EXEC</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169876755509000-2"><span class="crayon-h">  </span><span class="crayon-v">MAP_ANON</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">MAP_PRIVATE</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d5b32169876755509000-3"><span class="crayon-e">memcpy</span><span class="crayon-sy">(</span><span class="crayon-v">mem</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">instruction_stream</span><span class="crayon-sy">.</span><span class="crayon-v">data</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">instruction_stream</span><span class="crayon-sy">.</span><span class="crayon-v">size</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169876755509000-4"><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-o">*</span><span class="crayon-v">jitted_func</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">fn_memset</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">fn_putchar</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">fn_getchar</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">mem</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d5b32169876755509000-5"><span class="crayon-e">jitted_func</span><span class="crayon-sy">(</span><span class="crayon-v">memcpy</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">putchar</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">getchar</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169876755509000-6"><span class="crayon-e">munmap</span><span class="crayon-sy">(</span><span class="crayon-v">mem</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">instruction_stream</span><span class="crayon-sy">.</span><span class="crayon-v">size</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d5b32169876755509000-7"><span class="crayon-e">vector_destroy</span><span class="crayon-sy">(</span><span class="crayon-o">&amp;</span><span class="crayon-v">instruction_stream</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p></div></td></tr></table></div></div></li></ul><h3>Тесты, сравнение и заключение</h3><p>Теперь уже должно быть понятно, что интерпретатор, обычный и JIT компиляторы по своей структуре не сильно-то различаются. Сравните сдвиг указателя вправо во всех трёх:</p><ul><li>Интерпретатор:<br/></li><li>Компилятор:<br/><div id="crayon-56d5b32169884547729073" class="crayon-syntax crayon-theme-classic crayon-font-courier-new crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"/><div class="crayon-main"><table class="crayon-table"><tr class="crayon-row"><td class="crayon-nums " data-settings="show"/><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b32169884547729073-1"><span class="crayon-st">case</span><span class="crayon-h"> </span><span class="crayon-s">'&gt;'</span><span class="crayon-o">:</span><span class="crayon-h">  </span><span class="crayon-e">puts</span><span class="crayon-sy">(</span><span class="crayon-s">"  inc %r12"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h">  </span><span class="crayon-st">break</span><span class="crayon-sy">;</span></p></div></td></tr></table></div></div></li><li>JIT компилятор:<br/><div id="crayon-56d5b32169889184469185" class="crayon-syntax crayon-theme-classic crayon-font-courier-new crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"/><div class="crayon-main"><table class="crayon-table"><tr class="crayon-row"><td class="crayon-nums " data-settings="show"/><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b32169889184469185-1"><span class="crayon-st">case</span><span class="crayon-h"> </span><span class="crayon-s">'&gt;'</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169889184469185-2"><span class="crayon-h">  </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-56d5b32169889184469185-3"><span class="crayon-h">    </span><span class="crayon-t">char</span><span class="crayon-h"> </span><span class="crayon-i">opcodes</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169889184469185-4"><span class="crayon-h">      </span><span class="crayon-cn">0x49</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0xFF</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0xC4</span><span class="crayon-h"> </span><span class="crayon-c">// inc %r12</span></p><p class="crayon-line" id="crayon-56d5b32169889184469185-5"><span class="crayon-h">    </span><span class="crayon-sy">}</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169889184469185-6"><span class="crayon-h">    </span><span class="crayon-e">vector_push</span><span class="crayon-sy">(</span><span class="crayon-o">&amp;</span><span class="crayon-v">instruction_stream</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">opcodes</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">sizeof</span><span class="crayon-sy">(</span><span class="crayon-v">opcodes</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-56d5b32169889184469185-7"><span class="crayon-h">  </span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169889184469185-8"><span class="crayon-h">  </span><span class="crayon-st">break</span><span class="crayon-sy">;</span></p></div></td></tr></table></div></div></li></ul><p>Или сравните исходники <a href="https://github.com/nickdesaulniers/bf_interpreter_jit_compiler/blob/master/interpreter.c" target="_blank">интерпретатора</a>, <a href="https://github.com/nickdesaulniers/bf_interpreter_jit_compiler/blob/master/compiler.c" target="_blank">обычного</a> и <a href="https://github.com/nickdesaulniers/bf_interpreter_jit_compiler/blob/master/jit.c" target="_blank">JIT</a> компиляторов.</p><p>Давайте теперь проверим их быстродействие. Одна из самых «тяжёлых» программ, которую я смог найти — <a href="https://github.com/nickdesaulniers/bf_interpreter_jit_compiler/blob/master/samples/mandelbrot.b" target="_blank">вывод в консоль множества Мандельброта в виде ASCII арта</a>.</p><div id="crayon-56d5b3216988e909463255" class="crayon-syntax crayon-theme-classic crayon-font-courier-new crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"/><div class="crayon-main"><table class="crayon-table"><tr class="crayon-row"><td class="crayon-nums " data-settings="show"/><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b3216988e909463255-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-i">time</span><span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-o">/</span><span class="crayon-i">interpreter</span><span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-o">/</span><span class="crayon-v">samples</span><span class="crayon-o">/</span><span class="crayon-v">mandelbrot</span><span class="crayon-sy">.</span><span class="crayon-i">b</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b3216988e909463255-2"><span class="crayon-cn">43.54s</span><span class="crayon-h"> </span><span class="crayon-i">user</span><span class="crayon-h"> </span><span class="crayon-cn">0.03s</span><span class="crayon-h"> </span><span class="crayon-i">system</span><span class="crayon-h"> </span><span class="crayon-cn">99</span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-i">cpu</span><span class="crayon-h"> </span><span class="crayon-cn">43.581</span><span class="crayon-h"> </span><span class="crayon-i">total</span></p><p class="crayon-line" id="crayon-56d5b3216988e909463255-3"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b3216988e909463255-4"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-o">/</span><span class="crayon-i">compiler</span><span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-o">/</span><span class="crayon-v">samples</span><span class="crayon-o">/</span><span class="crayon-v">mandelbrot</span><span class="crayon-sy">.</span><span class="crayon-v">b</span><span class="crayon-h"> </span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">temp</span><span class="crayon-sy">.</span><span class="crayon-v">s</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-o">/</span><span class="crayon-v">assemble</span><span class="crayon-sy">.</span><span class="crayon-e">sh </span><span class="crayon-v">temp</span><span class="crayon-sy">.</span><span class="crayon-v">s</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-i">time</span><span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-o">/</span><span class="crayon-v">a</span><span class="crayon-sy">.</span><span class="crayon-i">out</span></p><p class="crayon-line" id="crayon-56d5b3216988e909463255-5"><span class="crayon-cn">3.24s</span><span class="crayon-h"> </span><span class="crayon-i">user</span><span class="crayon-h"> </span><span class="crayon-cn">0.01s</span><span class="crayon-h"> </span><span class="crayon-i">system</span><span class="crayon-h"> </span><span class="crayon-cn">99</span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-i">cpu</span><span class="crayon-h"> </span><span class="crayon-cn">3.254</span><span class="crayon-h"> </span><span class="crayon-i">total</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b3216988e909463255-6"> </p><p class="crayon-line" id="crayon-56d5b3216988e909463255-7"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-i">time</span><span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-o">/</span><span class="crayon-i">jit</span><span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-o">/</span><span class="crayon-v">samples</span><span class="crayon-o">/</span><span class="crayon-v">mandelbrot</span><span class="crayon-sy">.</span><span class="crayon-i">b</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b3216988e909463255-8"><span class="crayon-cn">3.27s</span><span class="crayon-h"> </span><span class="crayon-i">user</span><span class="crayon-h"> </span><span class="crayon-cn">0.01s</span><span class="crayon-h"> </span><span class="crayon-i">system</span><span class="crayon-h"> </span><span class="crayon-cn">99</span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-i">cpu</span><span class="crayon-h"> </span><span class="crayon-cn">3.282</span><span class="crayon-h"> </span><span class="crayon-v">total</span></p></div></td></tr></table></div></div><p> Интерпретатор оказался гораздо медленнее остальных — это из-за того, что его переходы по <code>[ ]</code> выполняются за О(N), когда остальные имеют возможность выполнить прыжок за О(1). Интерпретатор просматривает исходник в поисках оператора, затем его выполняет, после чего снова возращается к файлу. Компиляторы сначала транслируют код, затем выполняют его, не смешивая.</p><p>Обычный компилятор, как и предполагалось, оказался самым быстрым. Однако что, если мы попробуем посчитать время вместе с компиляцией?</p><div id="crayon-56d5b32169894584729292" class="crayon-syntax crayon-theme-classic crayon-font-courier-new crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"/><div class="crayon-main"><table class="crayon-table"><tr class="crayon-row"><td class="crayon-nums " data-settings="show"/><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b32169894584729292-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">time</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">.</span><span class="crayon-o">/</span><span class="crayon-i">compiler</span><span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-o">/</span><span class="crayon-v">samples</span><span class="crayon-o">/</span><span class="crayon-v">mandelbrot</span><span class="crayon-sy">.</span><span class="crayon-v">b</span><span class="crayon-h"> </span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">temp</span><span class="crayon-sy">.</span><span class="crayon-v">s</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-o">/</span><span class="crayon-v">assemble</span><span class="crayon-sy">.</span><span class="crayon-e">sh </span><span class="crayon-v">temp</span><span class="crayon-sy">.</span><span class="crayon-v">s</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-o">/</span><span class="crayon-v">a</span><span class="crayon-sy">.</span><span class="crayon-v">out</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b32169894584729292-2"><span class="crayon-cn">3.27s</span><span class="crayon-h"> </span><span class="crayon-i">user</span><span class="crayon-h"> </span><span class="crayon-cn">0.08s</span><span class="crayon-h"> </span><span class="crayon-i">system</span><span class="crayon-h"> </span><span class="crayon-cn">99</span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-i">cpu</span><span class="crayon-h"> </span><span class="crayon-cn">3.353</span><span class="crayon-h"> </span><span class="crayon-v">total</span></p></div></td></tr></table></div></div><p> Теперь он работает чуть-чуть дольше, чем JIT. Какой из этого можно сделать вывод? Если время компиляции невелико (как у Brainfuck) — стоит выбирать JIT компилятор. Однако, если вам необходимо выполнять массивные программы на настоящих языках, а время компиляции будет значительным — вы явно захотите потратить время на компиляцию лишь один раз, а значит — выберете обычный компилятор.</p><p><sub>Перевод статьи <a href="https://nickdesaulniers.github.io/blog/2015/05/25/interpreter-compiler-jit/" target="_blank">«Interpreter, Compiler, JIT»</a></sub></p><p class="mistape_caption"/><footer class="entry-meta clearfix"><p class="vk_like" id="vk_like_bottom_8036"/></footer></div></div></body></html>