<html><body><div><div class="entry-content">
<p>You must have seen this XKCD comic:</p>
<p><img class=" aligncenter" src="//imgs.xkcd.com/comics/exploits_of_a_mom.png" alt=""/></p>
<p>Source: https://xkcd.com/327/</p>
<p>We are going to replicate this exact hack using Python and SQlite.</p>
<p><strong>Learning Goal</strong>: To see how easy it is to destroy your database and all its data, if you don’t follow simple rules. Also, pay homage to Little Bobby Tables!</p>
<p>Before we start, download the <a href="http://sqlitebrowser.org/">DB browser for SqLite</a>.</p>
<p><strong>Create a simple database</strong></p>
<p>Let’s create the database first:</p>
<p/> 
<div id="crayon-56d5b96278a61499747650" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">

<p class="crayon-info"/>
<p class="crayon-plain-wrap"/>
<div class="crayon-main">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">

</td>
<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b96278a61499747650-1"><span class="crayon-p">#!/usr/bin/python3</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a61499747650-2"><span class="crayon-e">import </span><span class="crayon-i">sqlite3</span></p><p class="crayon-line" id="crayon-56d5b96278a61499747650-3"> </p></div></td>
</tr>
</table>
</div>
</div>
 
<p/>
<p>We are using sqlite3, which comes inbuilt with Python.</p>
<p/> 

 
<p/>
<p>The name of our database is <em>students.db</em>.</p>
<p/> 
<div id="crayon-56d5b96278a70597784355" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">

<p class="crayon-info"/>
<p class="crayon-plain-wrap"/>
<div class="crayon-main">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">

</td>
<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b96278a70597784355-1"><span class="crayon-v">conn</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">sqlite3</span><span class="crayon-sy">.</span><span class="crayon-e">connect</span><span class="crayon-sy">(</span><span class="crayon-v">db</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a70597784355-2"><span class="crayon-v">c</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">conn</span><span class="crayon-sy">.</span><span class="crayon-e">cursor</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b96278a70597784355-3"> </p></div></td>
</tr>
</table>
</div>
</div>
 
<p/>
<p>We connect to our students database. SqLite will create a database file for you, if it doesn’t exist.</p>
<p/> 
<div id="crayon-56d5b96278a73821923331" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">

<p class="crayon-info"/>
<p class="crayon-plain-wrap"/>
<div class="crayon-main">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">

</td>
<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b96278a73821923331-1"><span class="crayon-v">cmd</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"CREATE TABLE students (Name TEXT, Age INT)"</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a73821923331-2"><span class="crayon-v">c</span><span class="crayon-sy">.</span><span class="crayon-e">execute</span><span class="crayon-sy">(</span><span class="crayon-v">cmd</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b96278a73821923331-3"><span class="crayon-v">conn</span><span class="crayon-sy">.</span><span class="crayon-e">commit</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a73821923331-4"> </p></div></td>
</tr>
</table>
</div>
</div>
 
<p/>
<p>We create a Table <em>students</em> with 2 values: Name and age.</p>
<p>The <em>execute()</em> command runns the SQL instruction, while the <em>commit()</em> writes it to the database. You don’t need to commit after every instruction, you can do it at the end, if you want.</p>
<p/> 
<div id="crayon-56d5b96278a77900783982" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">

<p class="crayon-info"/>
<p class="crayon-plain-wrap"/>
<div class="crayon-main">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">

</td>
<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b96278a77900783982-1"><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">(</span><span class="crayon-s">"Robert"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-s">"Sally"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">15</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-s">"Matthew"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">7</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a77900783982-2"> </p><p class="crayon-line" id="crayon-56d5b96278a77900783982-3"><span class="crayon-v">c</span><span class="crayon-sy">.</span><span class="crayon-e">executemany</span><span class="crayon-sy">(</span><span class="crayon-s">"INSERT INTO students VALUES (?,?)"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a77900783982-4"> </p></div></td>
</tr>
</table>
</div>
</div>
 
<p/>
<p>We create some dummy data, and write it into our database. The <em>executemany()</em> function allows you to add multiple values in one go.</p>
<p/> 
<div id="crayon-56d5b96278a7a893471608" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">

<p class="crayon-info"/>
<p class="crayon-plain-wrap"/>
<div class="crayon-main">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">

</td>
<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b96278a7a893471608-1"><span class="crayon-v">conn</span><span class="crayon-sy">.</span><span class="crayon-e">commit</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a7a893471608-2"> </p><p class="crayon-line" id="crayon-56d5b96278a7a893471608-3"><span class="crayon-v">conn</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a7a893471608-4"> </p></div></td>
</tr>
</table>
</div>
</div>
 
<p/>
<p>And we commit the database, and close it.</p>
<p>Open up the DB browser you downloaded, and open the database we just created.</p>
<p>On the main tab, you should see our table:</p>
<p><a href="http://i2.wp.com/pythonforengineers.com/wp-content/uploads/2015/07/sqli_15.png" class="grouped_elements" rel="tc-fancybox-group1604"><img class="aligncenter size-large wp-image-1610" src="//i2.wp.com/pythonforengineers.com/wp-content/uploads/2015/07/sqli_15.png?resize=1024%2C650" alt="sqli_15" srcset="http://i2.wp.com/pythonforengineers.com/wp-content/uploads/2015/07/sqli_15.png?resize=300%2C190 300w, http://i2.wp.com/pythonforengineers.com/wp-content/uploads/2015/07/sqli_15.png?resize=1024%2C650 1024w, http://i2.wp.com/pythonforengineers.com/wp-content/uploads/2015/07/sqli_15.png?w=1053 1053w" sizes="(max-width: 1024px) 100vw, 1024px" data-recalc-dims="1"/></a></p>
<p>And if you go to the <em>Browse Data</em> tab, you should see our data too:</p>
<p><a href="http://i0.wp.com/pythonforengineers.com/wp-content/uploads/2015/07/sqli_16.png" class="grouped_elements" rel="tc-fancybox-group1604"><img class="aligncenter wp-image-1610 size-large" src="//i0.wp.com/pythonforengineers.com/wp-content/uploads/2015/07/sqli_16.png?resize=1024%2C650" alt="sqli_15" data-recalc-dims="1"/></a></p>
<p>So far, so good. We have created a simple database. Now let’s hack it.</p>
<p><strong>Xkcd style hack on our database</strong></p>
<p/> 
<div id="crayon-56d5b96278a7d217837751" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">

<p class="crayon-info"/>
<p class="crayon-plain-wrap"/>
<div class="crayon-main">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">

</td>
<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b96278a7d217837751-1"><span class="crayon-p">#!/usr/bin/python3</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a7d217837751-2"><span class="crayon-e">import </span><span class="crayon-e">sqlite3</span></p><p class="crayon-line" id="crayon-56d5b96278a7d217837751-3"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a7d217837751-4"><span class="crayon-v">db</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"./students.db"</span></p><p class="crayon-line" id="crayon-56d5b96278a7d217837751-5"><span class="crayon-v">conn</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">sqlite3</span><span class="crayon-sy">.</span><span class="crayon-e">connect</span><span class="crayon-sy">(</span><span class="crayon-v">db</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a7d217837751-6"><span class="crayon-v">c</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">conn</span><span class="crayon-sy">.</span><span class="crayon-e">cursor</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b96278a7d217837751-7"> </p></div></td>
</tr>
</table>
</div>
</div>
 
<p/>
<p>We are just opening the database we created.</p>
<p>First, we will do a normal read:</p>
<p/> 
<div id="crayon-56d5b96278a81954614382" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">

<p class="crayon-info"/>
<p class="crayon-plain-wrap"/>
<div class="crayon-main">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">

</td>
<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b96278a81954614382-1"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">"Without Hack: \n"</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a81954614382-2"> </p><p class="crayon-line" id="crayon-56d5b96278a81954614382-3"><span class="crayon-v">c</span><span class="crayon-sy">.</span><span class="crayon-e">execute</span><span class="crayon-sy">(</span><span class="crayon-s">"SELECT * from students WHERE Name='Robert'"</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a81954614382-4"><span class="crayon-v">result</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">c</span><span class="crayon-sy">.</span><span class="crayon-e">fetchall</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b96278a81954614382-5"><span class="crayon-e">print </span><span class="crayon-i">result</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a81954614382-6"> </p></div></td>
</tr>
</table>
</div>
</div>
 
<p/>
<p>We select all students whose name is Robert, and fetch the results, and print them.</p>
<p/> 
<div id="crayon-56d5b96278a84115527930" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">

<p class="crayon-info"/>
<p class="crayon-plain-wrap"/>
<div class="crayon-main">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">

</td>
<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b96278a84115527930-1"><span class="crayon-e">Without </span><span class="crayon-v">Hack</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a84115527930-2"><span class="crayon-sy">[</span><span class="crayon-sy">(</span><span class="crayon-s">'Robert'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></p><p class="crayon-line" id="crayon-56d5b96278a84115527930-3"> </p></div></td>
</tr>
</table>
</div>
</div>
 
<p/>
<p>We got the correct result- remember, this was the data we entered. So far, our code is working as expected.</p>
<p>Now, let’s hack it.</p>
<p/> 
<div id="crayon-56d5b96278a87804855194" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">

<p class="crayon-info"/>
<p class="crayon-plain-wrap"/>
<div class="crayon-main">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">

</td>
<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b96278a87804855194-1"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">"With Hack: \n"</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a87804855194-2"><span class="crayon-v">Name</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"Robert'; DROP TABLE students;--"</span></p><p class="crayon-line" id="crayon-56d5b96278a87804855194-3"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">"SELECT * from students WHERE Name='%s'"</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">Name</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a87804855194-4"> </p></div></td>
</tr>
</table>
</div>
</div>
 
<p/>
<p>We have created the name exactly as per the xkcd script. To see why it works, we also print the exact SQL statement that will be executed.</p>
<p/> 
<div id="crayon-56d5b96278a8b348630519" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">

<p class="crayon-info"/>
<p class="crayon-plain-wrap"/>
<div class="crayon-main">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">

</td>
<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b96278a8b348630519-1"><span class="crayon-e ">SELECT *</span><span class="crayon-h"> </span><span class="crayon-e">from </span><span class="crayon-e">students </span><span class="crayon-e">WHERE </span><span class="crayon-v">Name</span><span class="crayon-o">=</span><span class="crayon-s">'Robert'</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-e">DROP </span><span class="crayon-e">TABLE </span><span class="crayon-v">students</span><span class="crayon-sy">;</span><span class="crayon-o">--</span>'</p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a8b348630519-2"> </p></div></td>
</tr>
</table>
</div>
</div>
 
<p/>
<p>If you look at the SQL command above, you see we end the SQL instruction with a <em>;</em>. That means that <em>DROP TABLE students;</em> is now a new instruction. The <em>drop</em> command will delete our table. The <em>– –</em>  is a comment in SQL, and is needed to comment out the last quote symbol <em>‘</em> in our instruction.</p>
<p>Now that we know how the instruction works, let’s run it:</p>
<p/> 
<div id="crayon-56d5b96278a8e118861089" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">

<p class="crayon-info"/>
<p class="crayon-plain-wrap"/>
<div class="crayon-main">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">

</td>
<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b96278a8e118861089-1"><span class="crayon-v">c</span><span class="crayon-sy">.</span><span class="crayon-e">executescript</span><span class="crayon-sy">(</span><span class="crayon-s">"SELECT * from students WHERE Name='%s'"</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">Name</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a8e118861089-2"> </p><p class="crayon-line" id="crayon-56d5b96278a8e118861089-3"><span class="crayon-v">result</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">c</span><span class="crayon-sy">.</span><span class="crayon-e">fetchall</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a8e118861089-4"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">result</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b96278a8e118861089-5"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a8e118861089-6"><span class="crayon-sy">[</span><span class="crayon-sy">]</span></p><p class="crayon-line" id="crayon-56d5b96278a8e118861089-7"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a8e118861089-8"> </p></div></td>
</tr>
</table>
</div>
</div>
 
<p/>
<p>This time we get an empty result. Why is that? Open up our database in the browser.</p>
<p><a href="http://i0.wp.com/pythonforengineers.com/wp-content/uploads/2015/07/sqli_17.png" class="grouped_elements" rel="tc-fancybox-group1604"><img class="aligncenter size-large wp-image-1610" src="//i0.wp.com/pythonforengineers.com/wp-content/uploads/2015/07/sqli_17.png?resize=1024%2C650" alt="sqli_15" data-recalc-dims="1"/></a></p>
<p><a href="http://i0.wp.com/pythonforengineers.com/wp-content/uploads/2015/07/sqli_18.png" class="grouped_elements" rel="tc-fancybox-group1604"><img class="aligncenter size-large wp-image-1610" src="//i0.wp.com/pythonforengineers.com/wp-content/uploads/2015/07/sqli_18.png?resize=1024%2C650" alt="sqli_15" data-recalc-dims="1"/></a></p>
<p>We see the database is empty! Our hack has deleted everything.</p>
<p>I hope <strong>you</strong> learnt to sanitise <strong>your</strong> database input, little Bobby Tables!</p>
<p><strong>Fixing our hack</strong></p>
<p>Create the database again, and check it exists by opening it in the browser.</p>
<p><a href="http://i2.wp.com/pythonforengineers.com/wp-content/uploads/2015/07/sqli_15.png" class="grouped_elements" rel="tc-fancybox-group1604"><img class="aligncenter size-large wp-image-1610" src="//i2.wp.com/pythonforengineers.com/wp-content/uploads/2015/07/sqli_15.png?resize=1024%2C650" alt="sqli_15" srcset="http://i2.wp.com/pythonforengineers.com/wp-content/uploads/2015/07/sqli_15.png?resize=300%2C190 300w, http://i2.wp.com/pythonforengineers.com/wp-content/uploads/2015/07/sqli_15.png?resize=1024%2C650 1024w, http://i2.wp.com/pythonforengineers.com/wp-content/uploads/2015/07/sqli_15.png?w=1053 1053w" sizes="(max-width: 1024px) 100vw, 1024px" data-recalc-dims="1"/></a></p>
<p>So how do you prevent SQL injection hacks?</p>
<p>Well, you read the bloody documentation, don’t you?</p>
<p>Right in the <a href="https://docs.python.org/2/library/sqlite3.html">documentation</a>, it tells you what not to do:</p>
<p/> 
<div id="crayon-56d5b96278a92674426611" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">

<p class="crayon-info"/>
<p class="crayon-plain-wrap"/>
<div class="crayon-main">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">

</td>
<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b96278a92674426611-1"><span class="crayon-p"># Never do this -- insecure!</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a92674426611-2"><span class="crayon-v">symbol</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'RHAT'</span></p><p class="crayon-line" id="crayon-56d5b96278a92674426611-3"><span class="crayon-v">c</span><span class="crayon-sy">.</span><span class="crayon-e">execute</span><span class="crayon-sy">(</span><span class="crayon-s">"SELECT * FROM stocks WHERE symbol = '%s'"</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">symbol</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a92674426611-4"> </p><p class="crayon-line" id="crayon-56d5b96278a92674426611-5"><span class="crayon-p"># Do this instead</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a92674426611-6"><span class="crayon-v">t</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-s">'RHAT'</span><span class="crayon-sy">,</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b96278a92674426611-7"><span class="crayon-v">c</span><span class="crayon-sy">.</span><span class="crayon-e">execute</span><span class="crayon-sy">(</span><span class="crayon-s">'SELECT * FROM stocks WHERE symbol=?'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">t</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a92674426611-8"><span class="crayon-i">print</span><span class="crayon-h"> </span><span class="crayon-v">c</span><span class="crayon-sy">.</span><span class="crayon-e">fetchone</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b96278a92674426611-9"> </p></div></td>
</tr>
</table>
</div>
</div>
 
<p/>
<p>What is the difference? In the first one, we are using the Python <em>%s</em> formatter to create the SQL instruction. That is because Python doesn’t know about SQL injection, and that allows our hack to work.</p>
<p>SqLite does. Which is why you use the <em>?</em> character (instead of <em>%s</em>) to pass in values. This way, SqLite will escape any special characters we put in.</p>
<p>Let’s give it a roll, and write the fixed code. The first half of the code is the same as before:</p>
<p/> 
<div id="crayon-56d5b96278a95473077565" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">

<p class="crayon-info"/>
<p class="crayon-plain-wrap"/>
<div class="crayon-main">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">

</td>
<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b96278a95473077565-1"><span class="crayon-p">#!/usr/bin/python3</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a95473077565-2"><span class="crayon-e">import </span><span class="crayon-e">sqlite3</span></p><p class="crayon-line" id="crayon-56d5b96278a95473077565-3"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a95473077565-4"><span class="crayon-v">db</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"./students.db"</span></p><p class="crayon-line" id="crayon-56d5b96278a95473077565-5"><span class="crayon-v">conn</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">sqlite3</span><span class="crayon-sy">.</span><span class="crayon-e">connect</span><span class="crayon-sy">(</span><span class="crayon-v">db</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a95473077565-6"><span class="crayon-v">c</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">conn</span><span class="crayon-sy">.</span><span class="crayon-e">cursor</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b96278a95473077565-7"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a95473077565-8"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">"Without Hack: \n"</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b96278a95473077565-9"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a95473077565-10"><span class="crayon-v">c</span><span class="crayon-sy">.</span><span class="crayon-e">execute</span><span class="crayon-sy">(</span><span class="crayon-s">"SELECT * from students WHERE Name='Robert'"</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b96278a95473077565-11"><span class="crayon-v">result</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">c</span><span class="crayon-sy">.</span><span class="crayon-e">fetchall</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a95473077565-12"><span class="crayon-e">print </span><span class="crayon-i">result</span></p><p class="crayon-line" id="crayon-56d5b96278a95473077565-13"> </p></div></td>
</tr>
</table>
</div>
</div>
 
<p/>
<p>Now to the relevant part:</p>
<p/> 
<div id="crayon-56d5b96278a98450027988" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">

<p class="crayon-info"/>
<p class="crayon-plain-wrap"/>
<div class="crayon-main">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">

</td>
<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b96278a98450027988-1"><span class="crayon-v">Name</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"Robert'; DROP TABLE students;--"</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a98450027988-2"><span class="crayon-v">Name_to_use</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">Name</span><span class="crayon-sy">,</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b96278a98450027988-3"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">"Name to use:"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">Name_to_use</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a98450027988-4"> </p><p class="crayon-line" id="crayon-56d5b96278a98450027988-5"><span class="crayon-e">Name </span><span class="crayon-st">to</span><span class="crayon-h"> </span><span class="crayon-st">use</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-s">"Robert'; DROP TABLE students;--"</span><span class="crayon-sy">,</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a98450027988-6"> </p></div></td>
</tr>
</table>
</div>
</div>
 
<p/>
<p>And this time, we will use the syntax recommended by the SqLite documentation:</p>
<p/> 
<div id="crayon-56d5b96278a9c903870407" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">

<p class="crayon-info"/>
<p class="crayon-plain-wrap"/>
<div class="crayon-main">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">

</td>
<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b96278a9c903870407-1"><span class="crayon-v">c</span><span class="crayon-sy">.</span><span class="crayon-e">execute</span><span class="crayon-sy">(</span><span class="crayon-s">"SELECT * from students WHERE Name=(?)"</span><span class="crayon-h"> </span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">Name_to_use</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a9c903870407-2"> </p></div></td>
</tr>
</table>
</div>
</div>
 
<p/>
<p>If this works, our database should not be deleted. Open up the browser to check:</p>
<p><a href="http://i0.wp.com/pythonforengineers.com/wp-content/uploads/2015/07/sqli_16.png" class="grouped_elements" rel="tc-fancybox-group1604"><img class="aligncenter size-large wp-image-1610" src="//i0.wp.com/pythonforengineers.com/wp-content/uploads/2015/07/sqli_16.png?resize=1024%2C650" alt="sqli_15" data-recalc-dims="1"/></a></p>
<p>Nope, still there. SqLite escaped the name, so it no longer runs as a SQL instruction.</p>
<p>To see why this works, let’s try to add this name to our database:</p>
<p/> 
<div id="crayon-56d5b96278a9f714067120" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">

<p class="crayon-info"/>
<p class="crayon-plain-wrap"/>
<div class="crayon-main">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">

</td>
<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5b96278a9f714067120-1"><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">(</span><span class="crayon-s">"Robert'; DROP TABLE students;--"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a9f714067120-2"><span class="crayon-v">c</span><span class="crayon-sy">.</span><span class="crayon-e">executemany</span><span class="crayon-sy">(</span><span class="crayon-s">"INSERT INTO students VALUES (?,?)"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5b96278a9f714067120-3"><span class="crayon-v">conn</span><span class="crayon-sy">.</span><span class="crayon-e">commit</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5b96278a9f714067120-4"> </p></div></td>
</tr>
</table>
</div>
</div>
 
<p/>
<p>This is the same code as the one we used earlier, except we are using our hacky name now. Run this code, and open the DB browser:</p>
<p><a href="http://i0.wp.com/pythonforengineers.com/wp-content/uploads/2015/07/sqli_19.png" class="grouped_elements" rel="tc-fancybox-group1604"><img class="aligncenter size-full wp-image-1614" src="//i0.wp.com/pythonforengineers.com/wp-content/uploads/2015/07/sqli_19.png?resize=615%2C319" alt="sqli_19" srcset="http://i0.wp.com/pythonforengineers.com/wp-content/uploads/2015/07/sqli_19.png?resize=300%2C156 300w, http://i0.wp.com/pythonforengineers.com/wp-content/uploads/2015/07/sqli_19.png?w=615 615w" sizes="(max-width: 615px) 100vw, 615px" data-recalc-dims="1"/></a></p>
<p>As you can see, our injection code is now just treated as a normal string.</p>
<p>Which means Bobby Tables will be bullied at school for having such a loser name.</p>
<p><em>This is an extract from my book, <a href="http://pythonforengineers.com/python-for-hackers/">Python For Hackers</a>.<br/>
</em></p>

 
<em>I will never spam you. Unsubscribe anytime.
</em>
</div>
</div></body></html>