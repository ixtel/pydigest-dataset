<html><body><div><article class="markdown-body entry-content" itemprop="text"><h1><a id="user-content-castra" class="anchor" href="#castra" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Castra</h1>
<p><a href="https://travis-ci.org/blaze/castra"><img alt="Build Status" src="https://camo.githubusercontent.com/3ce5f1844059c59cd3091123a48e6d3a849d18fb/68747470733a2f2f7472617669732d63692e6f72672f626c617a652f6361737472612e737667" data-canonical-src="https://travis-ci.org/blaze/castra.svg"/>
</a></p>
<p>Castra is an on-disk, partitioned, compressed, column store.
Castra provides efficient columnar range queries.</p>
<ul>
<li><strong>Efficient on-disk:</strong>  Castra stores data on your hard drive in a way that you can load it quickly, increasing the comfort of inconveniently large data.</li>
<li><strong>Partitioned:</strong>  Castra partitions your data along an index, allowing rapid loads of ranges of data like "All records between January and March"</li>
<li><strong>Compressed:</strong>  Castra uses <a href="https://github.com/Blosc">Blosc</a> to compress data, increasing effective disk bandwidth and decreasing storage costs</li>
<li><strong>Column-store:</strong>  Castra stores columns separately, drastically reducing I/O costs for analytic queries</li>
<li><strong>Tabular data:</strong>  Castra plays well with Pandas and is an ideal fit for append-only applications like time-series</li>
</ul>
<a name="user-content-example"/>
<h2><a id="user-content-example" class="anchor" href="#example" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Example</h2>
<p>Consider some Pandas DataFrames</p>
<div class="highlight highlight-source-python"><pre>In [<span class="pl-c1">1</span>]: <span class="pl-k">import</span> pandas <span class="pl-k">as</span> pd
In [<span class="pl-c1">2</span>]: <span class="pl-c1">A</span> <span class="pl-k">=</span> pd.DataFrame({<span class="pl-s"><span class="pl-pds">'</span>price<span class="pl-pds">'</span></span>: [<span class="pl-c1">10.0</span>, <span class="pl-c1">11.0</span>], <span class="pl-s"><span class="pl-pds">'</span>volume<span class="pl-pds">'</span></span>: [<span class="pl-c1">100</span>, <span class="pl-c1">200</span>]},
   <span class="pl-c1">...</span>:                  <span class="pl-v">index</span><span class="pl-k">=</span>pd.DatetimeIndex([<span class="pl-s"><span class="pl-pds">'</span>2010<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>2011<span class="pl-pds">'</span></span>]))

In [<span class="pl-c1">3</span>]: <span class="pl-c1">B</span> <span class="pl-k">=</span> pd.DataFrame({<span class="pl-s"><span class="pl-pds">'</span>price<span class="pl-pds">'</span></span>: [<span class="pl-c1">12.0</span>, <span class="pl-c1">13.0</span>], <span class="pl-s"><span class="pl-pds">'</span>volume<span class="pl-pds">'</span></span>: [<span class="pl-c1">300</span>, <span class="pl-c1">400</span>]},
   <span class="pl-c1">...</span>:                  <span class="pl-v">index</span><span class="pl-k">=</span>pd.DatetimeIndex([<span class="pl-s"><span class="pl-pds">'</span>2012<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>2013<span class="pl-pds">'</span></span>]))</pre></div>
<p>We create a Castra with a filename and a template dataframe from which to get
column name, index, and dtype information</p>
<div class="highlight highlight-source-python"><pre>In [<span class="pl-c1">4</span>]: <span class="pl-k">from</span> castra <span class="pl-k">import</span> Castra
In [<span class="pl-c1">5</span>]: c <span class="pl-k">=</span> Castra(<span class="pl-s"><span class="pl-pds">'</span>data.castra<span class="pl-pds">'</span></span>, <span class="pl-v">template</span><span class="pl-k">=</span><span class="pl-c1">A</span>)</pre></div>
<p>The castra starts empty but we can extend it with new dataframes:</p>
<div class="highlight highlight-source-python"><pre>In [<span class="pl-c1">6</span>]: c.extend(<span class="pl-c1">A</span>)

In [<span class="pl-c1">7</span>]: c[:]
Out[<span class="pl-c1">7</span>]:
            price  volume
<span class="pl-c1">2010</span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">1</span></span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">1</span></span>     <span class="pl-c1">10</span>     <span class="pl-c1">100</span>
<span class="pl-c1">2011</span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">1</span></span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">1</span></span>     <span class="pl-c1">11</span>     <span class="pl-c1">200</span>

In [<span class="pl-c1">8</span>]: c.extend(<span class="pl-c1">B</span>)

In [<span class="pl-c1">9</span>]: c[:]
Out[<span class="pl-c1">9</span>]:
            price  volume
<span class="pl-c1">2010</span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">1</span></span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">1</span></span>     <span class="pl-c1">10</span>     <span class="pl-c1">100</span>
<span class="pl-c1">2011</span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">1</span></span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">1</span></span>     <span class="pl-c1">11</span>     <span class="pl-c1">200</span>
<span class="pl-c1">2012</span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">1</span></span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">1</span></span>     <span class="pl-c1">12</span>     <span class="pl-c1">300</span>
<span class="pl-c1">2013</span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">1</span></span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">1</span></span>     <span class="pl-c1">13</span>     <span class="pl-c1">400</span></pre></div>
<p>We can select particular columns</p>
<div class="highlight highlight-source-python"><pre>In [<span class="pl-c1">10</span>]: c[:, <span class="pl-s"><span class="pl-pds">'</span>price<span class="pl-pds">'</span></span>]
Out[<span class="pl-c1">10</span>]:
<span class="pl-c1">2010</span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">1</span></span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">1</span></span>    <span class="pl-c1">10</span>
<span class="pl-c1">2011</span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">1</span></span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">1</span></span>    <span class="pl-c1">11</span>
<span class="pl-c1">2012</span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">1</span></span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">1</span></span>    <span class="pl-c1">12</span>
<span class="pl-c1">2013</span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">1</span></span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">1</span></span>    <span class="pl-c1">13</span>
Name: price, dtype: float64</pre></div>
<p>Particular ranges</p>
<div class="highlight highlight-source-python"><pre>In [<span class="pl-c1">12</span>]: c[<span class="pl-s"><span class="pl-pds">'</span>2011<span class="pl-pds">'</span></span>:<span class="pl-s"><span class="pl-pds">'</span>2013<span class="pl-pds">'</span></span>]
Out[<span class="pl-c1">12</span>]:
            price  volume
<span class="pl-c1">2011</span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">1</span></span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">1</span></span>     <span class="pl-c1">11</span>     <span class="pl-c1">200</span>
<span class="pl-c1">2012</span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">1</span></span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">1</span></span>     <span class="pl-c1">12</span>     <span class="pl-c1">300</span>
<span class="pl-c1">2013</span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">1</span></span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">1</span></span>     <span class="pl-c1">13</span>     <span class="pl-c1">400</span></pre></div>
<p>Or both</p>
<div class="highlight highlight-source-python"><pre>In [<span class="pl-c1">13</span>]: c[<span class="pl-s"><span class="pl-pds">'</span>2011<span class="pl-pds">'</span></span>:<span class="pl-s"><span class="pl-pds">'</span>2013<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>volume<span class="pl-pds">'</span></span>]
Out[<span class="pl-c1">13</span>]:
<span class="pl-c1">2011</span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">1</span></span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">1</span></span>    <span class="pl-c1">200</span>
<span class="pl-c1">2012</span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">1</span></span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">1</span></span>    <span class="pl-c1">300</span>
<span class="pl-c1">2013</span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">1</span></span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">1</span></span>    <span class="pl-c1">400</span>
Name: volume, dtype: int64</pre></div>
<a name="user-content-storage"/>
<h2><a id="user-content-storage" class="anchor" href="#storage" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Storage</h2>
<p>Castra stores your dataframes as they arrived, you can see the divisions along
which you data is divided.</p>
<div class="highlight highlight-source-python"><pre>In [<span class="pl-c1">14</span>]: c.partitions
Out[<span class="pl-c1">14</span>]:
<span class="pl-c1">2011</span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">1</span></span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">1</span></span>    <span class="pl-c1">2009</span><span class="pl-k">-</span><span class="pl-c1">12</span><span class="pl-k">-</span><span class="pl-ii">31T16</span>:<span class="pl-c1">00</span>:<span class="pl-c1">00.000000000</span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">800</span></span><span class="pl-ii">--</span><span class="pl-c1">2010</span><span class="pl-k">-</span><span class="pl-c1">12</span><span class="pl-k">-</span><span class="pl-c1">31</span><span class="pl-c1">...</span>
<span class="pl-c1">2013</span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">1</span></span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">1</span></span>    <span class="pl-c1">2011</span><span class="pl-k">-</span><span class="pl-c1">12</span><span class="pl-k">-</span><span class="pl-ii">31T16</span>:<span class="pl-c1">00</span>:<span class="pl-c1">00.000000000</span><span class="pl-k">-</span><span class="pl-c1">0<span class="pl-ii">800</span></span><span class="pl-ii">--</span><span class="pl-c1">2012</span><span class="pl-k">-</span><span class="pl-c1">12</span><span class="pl-k">-</span><span class="pl-c1">31</span><span class="pl-c1">...</span>
dtype: <span class="pl-c1">object</span></pre></div>
<p>Each column in each partition lives in a separate compressed file:</p>
<pre>$ ls -a data.castra/2011-12-31T16:00:00.000000000-0800--2012-12-31T16:00:00.000000000-0800
.  ..  .index  price  volume
</pre>
<a name="user-content-restrictions"/>
<h2><a id="user-content-restrictions" class="anchor" href="#restrictions" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Restrictions</h2>
<p>Castra is both fast and restrictive.</p>
<ul>
<li>You must always give it dataframes that match its template (same column
names, index type, dtypes).</li>
<li>You can only give castra dataframes with <strong>increasing index values</strong>.  For
example you can give it one dataframe a day for values on that day.  You can
not go back and update previous days.</li>
</ul>
<a name="user-content-text-and-categoricals"/>
<h2><a id="user-content-text-and-categoricals" class="anchor" href="#text-and-categoricals" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Text and Categoricals</h2>
<p>Castra tries to encode text and object dtype columns with
<a href="http://msgpack.org/index.html">msgpack</a>, using the implementation found in
the Pandas library.  It falls back to pickle with a high protocol if that
fails.</p>
<p>Alternatively, Castra can categorize your data as it receives it</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> c <span class="pl-k">=</span> Castra(<span class="pl-s"><span class="pl-pds">'</span>data.castra<span class="pl-pds">'</span></span>, <span class="pl-v">template</span><span class="pl-k">=</span>df, <span class="pl-v">categories</span><span class="pl-k">=</span>[<span class="pl-s"><span class="pl-pds">'</span>list<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>of<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>columns<span class="pl-pds">'</span></span>])

<span class="pl-k">or</span>

<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> c <span class="pl-k">=</span> Castra(<span class="pl-s"><span class="pl-pds">'</span>data.castra<span class="pl-pds">'</span></span>, <span class="pl-v">template</span><span class="pl-k">=</span>df, <span class="pl-v">categories</span><span class="pl-k">=</span><span class="pl-c1">True</span>) <span class="pl-c"># all object dtype columns</span></pre></div>
<p>Categorizing columns that have repetitive text, like <code>'sex'</code> or
<code>'ticker-symbol'</code> can greatly improve both read times and computational
performance with Pandas.  See this <a href="http://matthewrocklin.com/blog/work/2015/06/18/Categoricals/">blogpost</a> for more information.</p>
<a name="user-content-dask-dataframe"/>
<h2><a id="user-content-dask-dataframe" class="anchor" href="#dask-dataframe" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Dask dataframe</h2>
<p>Castra interoperates smoothly with <a href="https://dask.pydata.org/en/latest/dataframe.html">dask.dataframe</a></p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">import</span> dask.dataframe <span class="pl-k">as</span> dd
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> df <span class="pl-k">=</span> dd.read_csv(<span class="pl-s"><span class="pl-pds">'</span>myfiles.*.csv<span class="pl-pds">'</span></span>)
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> df.set_index(<span class="pl-s"><span class="pl-pds">'</span>timestamp<span class="pl-pds">'</span></span>, <span class="pl-v">compute</span><span class="pl-k">=</span><span class="pl-c1">False</span>).to_castra(<span class="pl-s"><span class="pl-pds">'</span>myfile.castra<span class="pl-pds">'</span></span>, <span class="pl-v">categories</span><span class="pl-k">=</span><span class="pl-c1">True</span>)

<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> df <span class="pl-k">=</span> dd.from_castra(<span class="pl-s"><span class="pl-pds">'</span>myfile.castra<span class="pl-pds">'</span></span>)</pre></div>
<a name="user-content-work-in-progress"/>
<h2><a id="user-content-work-in-progress" class="anchor" href="#work-in-progress" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Work in Progress</h2>
<p>Castra is immature and largely for experimental use.</p>
<p>The developers do not promise backwards compatibility with future versions.
You should treat castra as a very efficient temporary format and archive your
data with some other system.</p>

</article>
  </div></body></html>