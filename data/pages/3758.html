<html><body><div><div class="content html_format"><p>
      Всем привет! Все началось с того, что у нас в компании развелось очень много доменов которые нужно вовремя продлевать. И вот, после одного провала с продлением доменов, было принято решение начать мониторить дату истечения домена и выводить его в мониторинге Nagios.</p>

<a name="habracut"/>
<h4>Как мониторить?</h4>
<p>
У нас было несколько доменов в зонах kz, ru, kg, ge, com.
</p><p>
Самый простой способ узнать всю нужную информацию о домене — запустить whois. Это по идее должен знать каждый. Но как все это дело внедрить в мониторинг?

</p><h4>Чем мониторить?</h4><p>
Покопавшись по просторам интернета, был найден модуль </p><a href="https://pypi.python.org/pypi/python-whois">python-whois</a><p>. Он хорошо выполнял свою работу для доменов com, net и кучи других доменов, описанных в описании к модулю.
</p><p>
Не хватало функционала для нескольких доменов в зонах kg.</p><p>
В итоге появился форк проекта </p><a href="https://pypi.python.org/pypi/python-whois-extended">python-whois-extended</a><p> который расширяет функционал для больших TLD.

</p><h4>Ок, как внедрить в нагиос?</h4>
<p>
Все просто, пишем простой чек
</p><pre><code class="python">#!/usr/bin/env python
#
# Usage:
# python check_domain.py -d DOMAIN
import whois
from datetime import datetime
 
from sys import exit
from optparse import OptionParser
 
 
def check_domain(domain):
    q = whois.query(domain)
    if (q.expiration_date - datetime.now()).days &lt;= 30:
        print "CRITICAL: Domain: {0} expires on {1}".format(domain, q.expiration_date)
        exit(2)
    print "OK: Domain: {0} expires on {1}".format(domain, q.expiration_date)
 
if __name__ == '__main__':
    parser = OptionParser()
    parser.add_option("-d", "--domain", dest="domain", help="Domain to monitor expiry date")
    (options, args) = parser.parse_args()
    if not options.domain:
        print parser.print_help()
        exit(0)
 
    check_domain(options.domain)
</code></pre>
<p>
Что он делает? Светит красным в мониторинге за месяц до истечения домена.
</p><p>
Что интересно, появился еще один мейнтейнер, который добавил поддержку для hk, cn и kr TLD.
</p><p>
Текущий список поддерживаемых доменов такой:</p><p>
com, net, org, uk, pl, ru, lv, jp, co_jp, de, at, eu, biz, info, name, us, co, me, be, nz, cz, it, fr, kg, vc, fm, tv, edu, ca, cn, kr, hk
</p><p>
Код модуля </p><a href="https://github.com/gen1us2k/python-whois">тут</a><p>
Пул-реквесты, запросы фич привествуются!</p><p>
Надеюсь, мой опыт поможет избавиться от подобной проблемы

      
      </p><p class="clear"/>
    </div>

    
  </div></body></html>