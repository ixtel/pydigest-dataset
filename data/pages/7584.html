<html><body><div><div class="content html_format">
      <img src="https://habrastorage.org/files/0e5/2ca/a0f/0e52caa0f53b40fda0a1770760c7cfd3.jpg"/>
<i>Это достаточно вольный перевод статьи об основных новшествах асинхронного драйвера для <code>mongodb</code> используемого в <code>tornado</code>. Основной мотив, который послужил для написания этого перевода — новшества, появившиеся в этой версии, такие как поддержка <code>asyncio</code>, <code>async</code>, <code>await</code> и <code>Python 3.5</code>. Сама статья не сколько перечисление новшеств, сколько лаконичные примеры асинхронной работы с <code>MongoDB</code>. <br/>
</i>

<a href="#0">Введение</a>
<a href="#1"> asyncio</a>
<a href="#2"> aggregate</a>
<a href="#3"> Python 3.5 </a>
<a href="#4"> async and await</a>

<a name="habracut"/>
<h3><a name="0"/><font>Введение</font></h3><p>
Недавно была опубликована новая </p><code>Beta</code><p> версия </p><code>Python</code><p> драйвера для </p><code>Mongodb</code><p>, </p><code>Motor</code><p>. В этой версии содержится одно из самых больших обновлений. Для установки можно использовать:
</p><code>python -m pip install --pre motor==0.5b0<br/>
</code>
<code>Motor 0.5</code><p> по прежнему зависит от </p><code>PyMongo 2.8.0</code><p>. Это устаревшая версия </p><code>PyMongo</code><p>, но сейчас не было достаточно времени чтоб полностью перейти на третью версию, что простительно, так как этот релиз достаточно большой.

</p><h3><a name="1"/><font>asyncio</font></h3>
<code>Motor</code><p> теперь может интегрироваться с </p><code>asyncio</code><p>, как альтернатива </p><code>Tornado</code><p>. Большая благодарность Реми Джолину, Андрею Светлову  </p><a href="https://habrahabr.ru/users/svetlov/" class="user_link">svetlov</a><p> и Николаю Новику за их огромный вклад в интеграцию </p><code>Motor</code><p> для работы с </p><code>asyncio</code><p>.
</p><p>
API-Интерфейсы </p><code>Tornado</code><p> и </p><code>asyncio</code><p> являются родственными. Пример </p><code>Motor</code><p> с </p><code>Tornado</code><p>:
</p><pre><code class="python"># Tornado API
from tornado import gen, ioloop
from motor.motor_tornado import MotorClient

@gen.coroutine
def f():
    result = yield client.db.collection.insert({'_id': 1})
    print(result)

client = MotorClient()
ioloop.IOLoop.current().run_sync(f)
</code></pre><p>
И здесь пример для asyncio:
</p><pre><code class="python">import asyncio
from motor.motor_asyncio import AsyncIOMotorClient

@asyncio.coroutine
def f():
    result = yield from client.db.collection.insert({'_id': 1})
    print(result)

client = AsyncIOMotorClient()
asyncio.get_event_loop().run_until_complete(f())
</code></pre><p>
В отличие от </p><code>Tornado</code><p>, </p><code>asyncio</code><p> не включает реализацию </p><code>http</code><p>, а тем более не является фреймворком. Для этого используйте библиотеку </p><code>aiohttp</code><p> Андрея Светлова. Небольшой </p><a href="http://motor.readthedocs.org/en/latest/tutorial-asyncio.html#a-web-application-with-aiohttp">пример для работы Motor с aiohttp</a><p>.

</p><h3><a name="2"/><font>aggregate</font></h3>
<a href="http://motor.readthedocs.org/en/latest/api/motor_collection.html#motor.motor_tornado.MotorCollection.aggregate">MotorCollection.aggregate</a><p> теперь по умолчанию возвращает курсор, и курсор возвращается непосредственно без </p><code>yield</code><p>. Старый синтаксис больше не поддерживается:
</p><pre><code class="python"># Motor 0.4 and older, no longer supported.
cursor = yield collection.aggregate(pipeline, cursor={})
while (yield cursor.fetch_next):
    doc = cursor.next_object()
    print(doc)
</code></pre><p>
В </p><code>Motor 0.5</code><p> просто сделайте:
</p><pre><code class="python"># Motor 0.5: no "cursor={}", no "yield".
cursor = collection.aggregate(pipeline)
while (yield cursor.fetch_next):
    doc = cursor.next_object()
    print(doc)
</code></pre><p>
В </p><code>asyncio</code><p> для этого используется </p><code>yield from</code><p>:
</p><pre><code class="python"># Motor 0.5 with asyncio.
cursor = collection.aggregate(pipeline)
while (yield from cursor.fetch_next):
    doc = cursor.next_object()
    print(doc)
</code></pre>
<h3><a name="3"/><font>Python 3.5</font></h3><p>
Сейчас </p><code>Motor</code><p> совместим с </p><code>Python 3.5</code><p>, что потребовало определённых усилий. Это было трудно, потому что </p><code>Motor</code><p> не просто работает с сопрограммами (coroutines), он использует сопрограммы внутри себя для реализации некоторых из своих функций, таких как </p><a href="http://motor.readthedocs.org/en/latest/api/motor_client.html#motor.motor_tornado.MotorClient.open">MotorClient.open</a><p> и </p><a href="http://motor.readthedocs.org/en/latest/api/gridfs.html#motor.motor_tornado.MotorGridFS.put">MotorGridFS.put</a><p>.</p><p>
Был метод для написания сопрограмм, которые работают в </p><code>Python 2.6</code><p> c </p><code>Python 3.4</code><p>, но в </p><code>Python 3.5</code><p> это было окончательно поломано. Нет единого пути для возвращения значений из </p><code>Python 3.5</code><p> нативной сопрограмме или </p><code>Python 2</code><p> генератора базирующегося на сопрограмме, так что все внутренние сопрограммы </p><code>motor</code><p>, которые возвращают значения, были переписаны с помощью обратных вызовов.

</p><h3><a name="4"/><font>async and await</font></h3><p>
Награда за усилия потраченные на интеграцию с </p><code>Python 3.5</code><p>, состоит в том что теперь </p><code>motor</code><p> работает с родной сопрограммой, написанной с учетом ключевых слов </p><code>async</code><p> и </p><code>await</code><p> синтаксис:
</p><pre><code class="python">async def f():
    await collection.insert({'_id': 1})
</code></pre><p>
Курсор из </p><a href="http://motor.readthedocs.org/en/latest/api/motor_collection.html#motor.motor_tornado.MotorCollection.find">MotorCollection.find</a><p>, </p><a href="http://motor.readthedocs.org/en/latest/api/motor_collection.html#motor.motor_tornado.MotorCollection.aggregate">MotorCollection.aggregate</a><p>, или </p><a href="http://motor.readthedocs.org/en/latest/api/gridfs.html#motor.motor_tornado.MotorGridFS.find">MotorGridFS.find</a><p> может быть красиво и очень эффективно итегрирован в нативных сопрограммах (coroutines) с </p><code>async for</code><p>:
</p><pre><code class="python">async def f():
    async for doc in collection.find():
        print(doc)
</code></pre><p>
Насколько эффективно? Для коллекции из 10 000 документов этот пример кода выполнялся за 0.14 секунды.
</p><pre><code class="python"># Motor 0.5 with Tornado.
@gen.coroutine
def f():
    cursor = collection.find()
    while (yield cursor.fetch_next):
        doc = cursor.next_object()
        print(doc)
</code></pre>
<p>
Следующий код, в котором просто заменены </p><code>gen.coroutine</code><p> и </p><code>yield</code><p> на </p><code>async</code><p> и </p><code>await</code><p> и выполняет примерно тоже.
</p><pre><code class="python"># Motor 0.5 with Tornado, using async and await.
async def f():
    cursor = collection.find()
    while (await cursor.fetch_next):
        doc = cursor.next_object()
        print(doc)
</code></pre><p>
Но с </p><code>async for</code><p> время работы занимает 0.04 секунды, то есть в три раза быстрее.
</p><pre><code class="python"># Motor 0.5 with Tornado, using async for.
async def f():
    cursor = collection.find()
    async for doc in cursor:
        print(doc)
</code></pre><p>
Однако, MotorCursor в </p><a href="http://motor.readthedocs.org/en/latest/api/motor_cursor.html#motor.motor_tornado.MotorCursor.to_list">to_list</a><p> прежнему играет основную роль:
</p><pre><code class="python"># Motor 0.5 with Tornado, using to_list.
async def f():
    cursor = collection.find()
    docs = await cursor.to_list(length=100)
    while docs:
        for doc in docs:
            print(doc)
        docs = await cursor.to_list(length=100)
</code></pre><p>
Функция с </p><code>to_list</code><p> в два раза быстрее чем асинхронные, но это выглядит не так красиво и требует указания размера чанка. Я думаю, что </p><code>async for</code><p> выглядит довольно стильно и работает достаточно быстро для того, чтобы его применять в большинстве случаев.
</p><p>
Бета версии релизов </p><code>motor</code><p> публиковались далеко не всегда, но в этот раз по-другому. Интеграция </p><code>asyncio</code><p> в </p><code>motor</code><p> является совершенно новой. И поскольку это потребовало повсеместного рефакторинга ядра </p><code>motor</code><p>, и переписывания существующей интеграции </p><code>tornado</code><p>, была выпущена бета-версия для того, чтобы исправить все упущения.

</p><i>P.S. Просьба о грамматических ошибках и ошибках перевода писать в личку. </i>
      <p class="clear"/>
    </div>

    
  </div></body></html>