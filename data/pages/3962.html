<html><body><div><div id="main_content">
  <p>Detecting a responding to filesystem events is a difficult, but (more or less) solved, problem, and I have no interest in resolving it myself. As I'm building my current project, though, I found that there wasn't a good asyncio-compatible solution available. The standard seemed to be <a href="https://github.com/gorakhargosh/watchdog">Watchdog</a>, but out of the box it doesn't work with asyncio because it calls its handler functions on a seperate thread, which asyncio strictly forbids (and indeed throws exceptions in your face when you try to make it happen).</p>

<p>Thankfully Watchdog accepts an event handler object as an argument, so you can write you own to define custom behavior. To that end, I wrote <a href="https://github.com/biesnecker/hachiko">hachiko</a>, a simple wrapper around Watchdog that forces event handler function calls back onto the thread on which asyncio is running via <code>call_soon_threadsafe</code>. The handler functions themselves are coroutines, so you can use <code>yield from</code> inside them to plug into the rest of your asyncio-based application.</p>

<h3>Example usage</h3>

<p>I wrote a wrapper class called <code>AIOWatchdog</code> to simplify using Watchdog in an asyncio-environment, but you don't have to use it -- you can simply give an instance of a subclass of <code>AIOEventHandler</code> to a Watchdog <code>Observer</code> object and use it directly. In this examples, though, I use <code>AIOWatchdog</code>.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">hachiko.hachiko</span> <span class="kn">import</span> <span class="n">AIOWatchdog</span>

<span class="c"># Watches the filesystem for events for 20 seconds.</span>
<span class="nd">@asyncio.coroutine</span>
<span class="k">def</span> <span class="nf">watch_fs</span><span class="p">():</span>
    <span class="n">watch</span> <span class="o">=</span> <span class="n">AIOWatchdog</span><span class="p">(</span><span class="s">'/path/to/your/files'</span><span class="p">)</span>
    <span class="n">watch</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
        <span class="k">yield from</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">watch</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">watch_fs</span><span class="p">())</span></code></pre></div>

<p>There's not much more to it. <a href="https://github.com/biesnecker/hachiko/blob/master/hachiko/hachiko.py">Check out the code</a>, subclass <code>AIOEventHandler</code> to do interesting things with the filesystem events you care about (see <a href="https://pythonhosted.org/watchdog/api.html">Watchdog's documentation</a> for what the events are, etc.).</p>

<p>To get started with it, either check out the source from Github, or <code>pip install hachiko</code>. Enjoy!</p>

  </div>

  
  <p>If you enjoyed this post, please share it with others who would also enjoy it.</p>
  </div></body></html>