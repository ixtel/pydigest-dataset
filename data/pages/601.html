<html><body><div><article class="markdown-body entry-content" itemprop="text"><h1><a id="user-content-easy-parallel-python-with-concurrentfutures" class="anchor" href="#easy-parallel-python-with-concurrentfutures" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" role="img" version="1.1" viewbox="0 0 16 16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"/></svg></a>Easy parallel python with concurrent.futures</h1>

<p>As of version 3.3, python includes the very promising <code>concurrent.futures</code> <a href="http://docs.python.org/3.3/library/concurrent.futures.html">module</a>, with elegant context managers for running tasks concurrently. Thanks to the simple and consistent interface you can use both threads and processes with minimal effort.</p>

<p>For most CPU bound tasks - anything that is heavy number crunching - you want your program to use all the CPUs in your PC. The simplest way to get a CPU bound task to run in parallel is to use the ProcessPoolExecutor, which will create enough sub-processes to keep all your CPUs busy.</p>

<p>We use the context manager thusly:</p>

<div class="highlight highlight-source-python"><pre><span class="pl-k">with</span> concurrent.futures.ProcessPoolExecutor() <span class="pl-k">as</span> executor:
     result <span class="pl-k">=</span> executor.map(function, iterable)</pre></div>

<p>The snippet above uses the map() function which is by far the easiest way to split up a parallel taks. It simply appies the function provided to each element in iterable. The function could be complex and the iterable could be a list of large data tables - or even the same table, for instance, if you want to run a function 10 times on the same data, you could do:</p>

<p><code>executor.map(fun, [data] * 10)</code></p>

<p>I’ve found this is one of the easiest and most reliable approaches. Functionally it appears to be equivalent to using the multiprocessing module in this way:</p>

<div class="highlight highlight-source-python"><pre>pool <span class="pl-k">=</span> multiprocessing.Pool()
pool.map(…)</pre></div>

<p>However when using this in combination with pandas I have run into odd, hard to track down bugs where <code>pool.map</code> sometimes refused to work with an iterator longer than the number of processes - even though other times it worked fine. I haven’t yet had this problem with concurrent.futures and I suspect it’s a result of some strange interaction between pandas data and the internal mechanisms used to pass python objects between processes.</p>

<p>By using the ProcessPoolExecutor we are creating new processes and so circumventing the GIL (Global Interpreter Lock). We wont go into the GIL just now - basically it means you can't use Threads for CPU intensive parallel processing in the way you might in other languages</p>

<p>You can use Threads via the ThreadPoolExecutor, like so:</p>

<div class="highlight highlight-source-python"><pre><span class="pl-k">with</span> concurrent.futures.ThreadPoolExecutor() <span class="pl-k">as</span> executor:
     result <span class="pl-k">=</span> executor.map(function, iterable)</pre></div>

<p>You just change the class name and you are good to go. Using Threads you run into the GIL - your threads won’t run truely in parallel. However if you are doing IO-bound work (like reading in files or accessing the network) these usually release the GIL, so in fact you will see a performance improvement. For example say you have to make 1000 network requests, using concurrent.futures will make it so you don’t get stuck waiting for a few slow network responses when you could be running all the other ones. Because you just have to change one bit of code, you can easily experiment to see what works.</p>
</article>
  </div></body></html>