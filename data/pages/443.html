<html><body><div><div class="entry-content clearfix"><p>Please note: This is a collaboration piece between Michael Herman, from Real Python, and Sean Vieira, a Python developer from <a href="http://dedeodesigns.com/">De Deo Designs</a>.</p>

<hr/>


<a name="Articles.in.this.series:"/>
<h3>Articles in this series:</h3>

<ol>
<li>Part I: <a href="http://www.realpython.com/blog/python/python-web-applications-with-flask-part-i/#.Uu6GOHddUp8">Application setup</a></li>
<li>Part II: <a href="http://www.realpython.com/blog/python/python-web-applications-with-flask-part-ii/#.Uu5-EHddUp8">Setup user accounts, Templates, Static files</a></li>
<li><strong>Part III: Testing (unit and integration), Debugging, and Error handling &lt;— CURRENT ARTICLE</strong></li>
</ol>


<p>Welcome back to the Flask-Tracking development series! For those of you who are just joining us, we are implementing a web analytics application that conforms to <a href="http://www.realpython.com/blog/python/python-web-applications-with-flask-part-i/#toc_1">this napkin specification</a>.  For all those of you following along at home, you may check out today’s code with-</p>

<figure class="code"><figcaption><span/></figcaption></figure>


<p>-or you may download it from the <a href="https://github.com/mjhea0/flask-tracking/releases">releases page on Github</a>. Those of you who are just joining us may wish to read <a href="http://www.realpython.com/blog/python/python-web-applications-with-flask-part-i/#toc_5">a note on the repository structure</a> as well.</p>

<p><a href="http://www.realpython.com/blog/python/python-web-applications-with-flask-part-ii-app-creation/">In the previous segment</a> we added user accounts to our application. This week we’ll work on implementing a testing framework, talk a bit about why testing is important and then write some tests for our application. After, we’ll talk a bit about debugging errors in our application and logging.</p>

<a name="Why.Testing"/>
<h2>Why Testing</h2>

<p>Before we actually write any of our tests lets talk about why testing is important. If you remember the Zen of Python from <a href="http://www.realpython.com/blog/python/python-web-applications-with-flask-part-i/">Part 1</a>, you may have noticed that “Simple is better than complex” is right above “Complex is better than complicated”.  <em>Simple is the ideal, complex is often a reality.</em> Web applications, in particular, have many moving parts, and can very quickly move from simple to complex.</p>

<p>As the complexity of our application grows we want to ensure that the various moving parts we create continue to work together in a harmonious fashion.  We don’t want to change the signature of a utility function that breaks a seemingly unrelated feature in production. Moreover, we want to ensure that our changes still preserve <em>correct</em> (not simply valid) functionality. A method that always returns the same <code>datetime</code> instance is valid and correct twice a day, but valid and <em>incorrect</em> all the rest of the time.</p>

<p>Tests are a great debugging aid. Writing a test that produces the invalid behavior we are seeing helps us look at our code from a different perspective. In addition, once we have the test passing we have ensured that we will not re-introduce this bug again (at least in that particular way).</p>

<p>Tests are also an excellent source of documentation.  Since they have to deal with expected inputs and outputs reading a test suite will clarify what the code under test is expected to do.  This will illuminate unclear segments of the documentation that we have written (or in simple cases, even substitute for it).</p>

<p>Finally, tests can be a wonderful exploratory aid – sketching out how we <em>want</em> to interact with our code before we write it reveals simpler APIs, and helps us paper over the internal complexity of a domain.  <a href="http://en.wikipedia.org/wiki/Test-driven_development">“Test Driven Development”</a> is the ultimate commitment to this process.  In TDD we first write tests to cover our code’s functionality and only then do we write that code.</p>

<p>Tests will make it obvious:</p>

<ul>
<li>When code isn’t working,</li>
<li>What code is broken, and</li>
<li>Why we wrote this code in the first place.</li>
</ul>


<p>Every time we go to add a feature to our application, fix a bug or change some code we should make sure our code is adequately covered by tests and that the tests all pass after we’re done.</p>

<p>Do:</p>

<ul>
<li>Add tests to cover the basic functionality of your code.</li>
<li>Add tests to cover as many corner/edge cases of your code that you can think of.</li>
<li>Add tests to cover the corner/edge cases you didn’t think of after you go back and fix them.</li>
<li>Remind your coding peers to adequately test their code.</li>
<li>Bug people about code that doesn’t pass tests.</li>
</ul>


<p>Do Not:</p>

<ul>
<li>Commit code without tests.</li>
<li>Commit code that doesn’t pass or breaks tests.</li>
<li>Change your tests so your code passes without fixing the problem.</li>
</ul>


<p>Now that we’ve worked out why testing is so important lets start writing some tests for our application.</p>

<a name="Setting.up"/>
<h2>Setting up</h2>

<p>Each chunk of functionality needs to have tests. To do this in a neat and concise way each package will get a <code>tests.py</code> module in it. This way we know where the tests for each package are and that they’re contained in the package if we ever need to break it out of our application.</p>

<p>We’ll use <a href="http://pythonhosted.org/Flask-Testing/"><code>Flask-Testing</code></a> extension because it has a bunch of useful testing features that we’d be setting up anyways. Go ahead and add <code>Flask-Testing==0.4</code> to the bottom of <code>requirements.txt</code> then run <code>pip install -r requirements.txt</code>.</p>

<p>Flask-Testing eliminates almost all of the boilerplate of setting up Flask for unit testing.  The little bit that remains we will place in a new module <code>test_base.py</code>:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c"># flask_testing/test_base.py</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">flask.ext.testing</span> <span class="kn">import</span> <span class="n">TestCase</span>
</span><span class="line">
</span><span class="line"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">db</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">BaseTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
</span><span class="line">    <span class="sd">"""A base test case for flask-tracking."""</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">create_app</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="s">'config.TestConfiguration'</span><span class="p">)</span>
</span><span class="line">        <span class="k">return</span> <span class="n">app</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
</span><span class="line">        <span class="n">db</span><span class="o">.</span><span class="n">drop_all</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>This test case doesn’t do anything spectacular – it just configures the application with our test configuration, creates all of our tables at the start of every test and deletes all of our tables at the end of every test.  This way every test case starts out with a clean slate and we can spend more time writing tests and less time debugging our test cases.  Since every test case will inherit from our new <code>BaseTestCase()</code> class we will avoid copying and pasting this configuration into every package we create for our application.</p>

<p>One additional thing we have done is modularize our configurations.  The original <code>config.py</code> module supported only one configuration – we can update that to allow for differences between environments.  As a reminder, this is what <code>config.py</code> looked like in <a href="http://www.realpython.com/blog/python/python-web-applications-with-flask-part-ii-app-creation/">Part 2</a>:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c"># config.py</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">abspath</span><span class="p">,</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">join</span>
</span><span class="line">
</span><span class="line"><span class="n">_cwd</span> <span class="o">=</span> <span class="n">dirname</span><span class="p">(</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
</span><span class="line">
</span><span class="line"><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s">'flask-session-insecure-secret-key'</span>
</span><span class="line"><span class="n">SQLALCHEMY_DATABASE_URI</span> <span class="o">=</span> <span class="s">'sqlite:///'</span> <span class="o">+</span> <span class="n">join</span><span class="p">(</span><span class="n">_cwd</span><span class="p">,</span> <span class="s">'flask-tracking.db'</span><span class="p">)</span>
</span><span class="line"><span class="n">SQLALCHEMY_ECHO</span> <span class="o">=</span> <span class="bp">True</span>
</span></code></pre></td></tr></table></div></figure>


<p>It looks almost the same now – we simply created a class that holds all of these configuration values:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">abspath</span><span class="p">,</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">join</span>
</span><span class="line">
</span><span class="line"><span class="n">_cwd</span> <span class="o">=</span> <span class="n">dirname</span><span class="p">(</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">BaseConfiguration</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class="line">    <span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class="line">    <span class="n">TESTING</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class="line">    <span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s">'flask-session-insecure-secret-key'</span>
</span><span class="line">    <span class="n">HASH_ROUNDS</span> <span class="o">=</span> <span class="mi">100000</span>
</span><span class="line">    <span class="c"># ... etc. ...</span>
</span></code></pre></td></tr></table></div></figure>


<p>which we can then inherit from:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">class</span> <span class="nc">TestConfiguration</span><span class="p">(</span><span class="n">BaseConfiguration</span><span class="p">):</span>
</span><span class="line">    <span class="n">TESTING</span> <span class="o">=</span> <span class="bp">True</span>
</span><span class="line">    <span class="n">WTF_CSRF_ENABLED</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class="line">
</span><span class="line">    <span class="n">SQLALCHEMY_DATABASE_URI</span> <span class="o">=</span> <span class="s">'sqlite:///:memory:'</span>  <span class="c"># + join(_cwd, 'testing.db')</span>
</span><span class="line">
</span><span class="line">    <span class="c"># Since we want our unit tests to run quickly</span>
</span><span class="line">    <span class="c"># we turn this down - the hashing is still done</span>
</span><span class="line">    <span class="c"># but the time-consuming part is left out.</span>
</span><span class="line">    <span class="n">HASH_ROUNDS</span> <span class="o">=</span> <span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure>


<p>This way settings that are common to all environments can be easily shared, and we can easily override what we need to in our environment specific configurations.  (This pattern comes directly from <a href="http://flask.pocoo.org/docs/config/#development-production">Flask’s excellent documentation</a>.)</p>

<p>We are using an in-memory SQLite database for our tests to ensure that our tests execute as quickly as possible.  We want to enjoy running our tests, and we can only do that if they execute in a reasonable amount of time.  If we really need access to the result of the test run we can override the <code>:memory:</code> setting with the calculated path to <code>tests.db</code>. (That’s the commented out <code>+ join(_cwd, 'testing.db')</code> in our <code>TestConfiguration</code>).</p>

<p>We have also added a <code>HASH_ROUNDS</code> key to our configuration to control how many times a user’s password should be hashed before it is stored.  We can change <code>flask_tracking.users.models.User</code>’s <code>_hash_password</code> method to use this key:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">current_app</span>
</span><span class="line">
</span><span class="line"><span class="c"># ... snip ...</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">_hash_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
</span><span class="line">    <span class="c"># ... snip ...</span>
</span><span class="line">    <span class="n">rounds</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">"HASH_ROUNDS"</span><span class="p">,</span> <span class="mi">100000</span><span class="p">)</span>
</span><span class="line">    <span class="n">buff</span> <span class="o">=</span> <span class="n">pbkdf2_hmac</span><span class="p">(</span><span class="s">"sha512"</span><span class="p">,</span> <span class="n">pwd</span><span class="p">,</span> <span class="n">salt</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="n">rounds</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This ensures that our unit tests will run quickly – otherwise, every time we need to create or log in a user we will have to wait for 100,000 rounds of sha512 to complete before we can continue our test.</p>

<p>Finally, we will need to update our <code>app.from_object</code> call in <code>flask_tracking/__init__.py</code>.  Before, we were loading the config using <code>app.from_object('config')</code>.  Now that we have two configurations in our config module we will want to change that to <code>app.from_object('config.BaseConfiguration')</code>.</p>

<p>Now we are ready to test our application.</p>

<a name="The.Tests"/>
<h2>The Tests</h2>

<p>We’ll start with the <code>users</code> package.</p>

<p>From <a href="http://www.realpython.com/blog/python/python-web-applications-with-flask-part-ii-app-creation/">last time</a> we know that the <code>users</code> package is responsible for:</p>

<ul>
<li>Registration,</li>
<li>Logging in, and</li>
<li>Logging out.</li>
</ul>


<p>So we need to write tests that cover users signing up, users logging in and then users logging out.  Let’s start with a simple case – an existing user attempting to log in:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c"># flask_tracking/users/tests.py</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">url_for</span>
</span><span class="line">
</span><span class="line"><span class="kn">from</span> <span class="nn">flask_tracking.test_base</span> <span class="kn">import</span> <span class="n">BaseTestCase</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">User</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">UserViewsTests</span><span class="p">(</span><span class="n">BaseTestCase</span><span class="p">):</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">test_users_can_login</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="n">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'Joe'</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s">'joe@joes.com'</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">'12345'</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'users.login'</span><span class="p">),</span>
</span><span class="line">                                    <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">'email'</span><span class="p">:</span> <span class="s">'joe@joes.com'</span><span class="p">,</span> <span class="s">'password'</span><span class="p">:</span> <span class="s">'12345'</span><span class="p">})</span>
</span><span class="line">
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">assert_redirects</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">url_for</span><span class="p">(</span><span class="s">'tracking.index'</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Since every test case starts out with a completely clean database we have to create an existing user first.  We can then submit the same request that our user (Joe) would submit if he were trying to log in.  We want to ensure that if Joe logs in successfully, he will be redirected back to the home page.</p>

<p>We can run our tests with the <a href="http://docs.python.org/2/library/unittest.html"><code>unittest</code></a> test runner, which comes built-in with Python.  Run the following command from the root of the project:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>python -m unittest discover
</span></code></pre></td></tr></table></div></figure>


<p>That results in the following output:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line">----------------------------------------------------------------------
</span><span class="line">Ran 1 <span class="nb">test </span>in 0.045s
</span><span class="line">
</span><span class="line">OK
</span></code></pre></td></tr></table></div></figure>


<p>Hurray! We now have a passing test! Let’s also test that our integration with Flask-Login is working. <code>current_user</code> should be Joe, so we should be able to do the following:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">flask.ext.login</span> <span class="kn">import</span> <span class="n">current_user</span>
</span><span class="line">
</span><span class="line"><span class="c"># And then inside of our test_users_can_login function:</span>
</span><span class="line"><span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">'Joe'</span><span class="p">)</span>
</span><span class="line"><span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">is_anonymous</span><span class="p">())</span>
</span></code></pre></td></tr></table></div></figure>


<p>However, if we were to try this we would get the following error:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line">AttributeError: <span class="s1">'AnonymousUserMixin'</span> object has no attribute <span class="s1">'name'</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>current_user</code> needs to be accessed within the context of a request (it is a thread-local object, just like <code>flask.request</code>).  When <code>self.client.post</code> completes the request and every thread-local object is torn down.  We need to preserve the request context so we can test our integration with Flask-Login.  Fortunately, <code>Flask</code>’s <a href="http://flask.pocoo.org/docs/api/#flask.Flask.test_client"><code>test_client</code></a> is a <a href="http://flask.pocoo.org/docs/testing/#keeping-the-context-around">context manager</a>, which means that we can use it in a <code>with</code> statement and it will keep the context around as long as we need it:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
</span><span class="line">    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'users.login'</span><span class="p">),</span>
</span><span class="line">                                <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">'email'</span><span class="p">:</span> <span class="s">'joe@joes.com'</span><span class="p">,</span> <span class="s">'password'</span><span class="p">:</span> <span class="s">'12345'</span><span class="p">})</span>
</span><span class="line">
</span><span class="line">    <span class="bp">self</span><span class="o">.</span><span class="n">assert_redirects</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">url_for</span><span class="p">(</span><span class="s">'index'</span><span class="p">))</span>
</span><span class="line">    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">'Joe'</span><span class="p">)</span>
</span><span class="line">    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">is_anonymous</span><span class="p">())</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, when we run our test again, we pass!</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line">----------------------------------------------------------------------
</span><span class="line">Ran 1 <span class="nb">test </span>in 0.053s
</span></code></pre></td></tr></table></div></figure>


<p>Let’s ensure that when Joe is logged in, he can log out:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">test_users_can_logout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">    <span class="n">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">"Joe"</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s">"joe@joes.com"</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">"12345"</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">"users.login"</span><span class="p">),</span>
</span><span class="line">                         <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">"email"</span><span class="p">:</span> <span class="s">"joe@joes.com"</span><span class="p">,</span>
</span><span class="line">                               <span class="s">"password"</span><span class="p">:</span> <span class="s">"12345"</span><span class="p">})</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">"users.logout"</span><span class="p">))</span>
</span><span class="line">
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">is_anonymous</span><span class="p">())</span>
</span></code></pre></td></tr></table></div></figure>


<p>Once again, we create Joe (remember, the database is reset at the end of every test).  Then we log him in (which we know works because our first test is passing).  Finally, we log him out by requesting the logout page via <code>self.client.get(url_for("users.logout"))</code> and ensure that the user we have is once again anonymous.  Run the tests again and bask in the satisfaction of having two passing tests.</p>

<p>A couple of other things that we will want to check:</p>

<ul>
<li>Can a user register and then log into the application?</li>
<li>When a user logs out, do they get redirected back to the index page?</li>
</ul>


<p>These tests are available in <a href="https://github.com/mjhea0/flask-tracking">the <code>flask-tracking</code> repository</a>, should you want to review them.  Since they are similar to what we have already written, we will skip them here.</p>

<a name="Mocks.and.Integration.Tests"/>
<h2>Mocks and Integration Tests</h2>

<p>There is one part of our application though, which is a little different from the rest – our <code>add_visit</code> endpoint in the <code>tracking</code> package not only interacts with the database and the user – it also interacts with the third-party service <a href="http://freegeoip.net/">Free GeoIP</a>.  As this is a potential source of breakage, we will want to test it thoroughly.  Since Free GeoIP is a third party service (which we might not always have access to) it also gives us a good opportunity to talk about the difference between unit and integration tests.</p>

<a name="Unit.vs..Integration.Tests"/>
<h3>Unit vs. Integration Tests</h3>

<p>Everything that we have written so far has fallen under the heading of a unit test. A <strong>unit test</strong> is a test of the smallest possible piece of functionality of <em>our</em> code – a test of an indivisible section of code (generally a function or method).</p>

<p><strong>Integration tests</strong>, on the other hand, test our application at its boundaries – does our application interact correctly with this other application (which may well be something we have written)?  Testing that our application properly calls and interacts with Free GeoIP is an integration test.  These sorts of tests are very important, as they let us know that the features that we are depending on still work the way we expect them to. (Yes, that doesn’t help us if Free GeoIP changes its contract (API), or goes down completely, while we are running our application in production but that is what logging is for – which we will cover a little later on.)</p>

<p>However, the issue with integration tests is that they are often more than an order of magnitude slower than unit tests.  A large number of integration tests can slow down our test suite to the point where it takes more than a minute to run – once it crosses that boundary, our test suite starts to be a hindrance rather than an assistant.  Taking the time to run our tests now breaks our flow of concentration, rather than simply verifying that we are on the right track.  Also, in the case of distributed services like Free GeoIP, it means we cannot actually run our test suite if we are offline or if Free GeoIP is down.</p>

<p>This leaves us in a fine quandary – on the one hand, integration tests are very important, and on the other hand, running integration tests is likely to break our work flow.</p>

<p>The solution is simple – we can create a bare-bones local implementation of the service we are calling (which is called a mock in testing parlance) and run our unit tests using this mock.  We can separate out our integration tests into a separate file and run those before we commit changes to our code.  That way, we get the speed of good unit tests and retain the certainty that integration tests provide.</p>

<a name="Mocking.Free.GeoIP"/>
<h3>Mocking Free GeoIP</h3>

<p>If you remember from <a href="http://www.realpython.com/blog/python/python-web-applications-with-flask-part-ii-app-creation/">Part 2</a> we added a <code>geodata</code> module to our <code>tracking</code> package which implemented a single function <code>get_geodata</code>.  We use this function in our <code>tracking.add_visit</code> view:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">ip_address</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">access_route</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span>
</span><span class="line"><span class="n">geodata</span> <span class="o">=</span> <span class="n">get_geodata</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>What we want to do in our <em>unit</em> test is ensure that when <code>get_geodata</code> works as expected we will properly record the visit in the database.  However, we don’t want to call Free GeoIP (otherwise, our test will be slow in comparison to our other tests and we will not be able to run the tests when offline.)  We need to replace <code>get_geodata</code> with another function (a mock).</p>

<p>First, let’s install <a href="http://mock.readthedocs.org/en/latest/">a mocking library</a> to make this easier.  Add <a href="http://mock.readthedocs.org/en/latest/"><code>mock==1.0.1</code></a> to requirements.txt and <code>pip install -r requirements.txt</code> again. (If you are using Python 3.3 or greater, you already have mock installed as <code>unittest.mock</code>.)</p>

<p>Now we can write our unit test:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c"># flask_tracking/tracking/tests.py</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">decimal</span> <span class="kn">import</span> <span class="n">Decimal</span>
</span><span class="line">
</span><span class="line"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">url_for</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">mock</span> <span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">patch</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">werkzeug.datastructures</span> <span class="kn">import</span> <span class="n">Headers</span>
</span><span class="line">
</span><span class="line"><span class="kn">from</span> <span class="nn">flask_tracking.test_base</span> <span class="kn">import</span> <span class="n">BaseTestCase</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">flask_tracking.users.models</span> <span class="kn">import</span> <span class="n">User</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Site</span><span class="p">,</span> <span class="n">Visit</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">..tracking</span> <span class="kn">import</span> <span class="n">views</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">TrackingViewsTests</span><span class="p">(</span><span class="n">BaseTestCase</span><span class="p">):</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">test_visitors_location_is_derived_from_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'Joe'</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s">'joe@joe.com'</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">'12345'</span><span class="p">)</span>
</span><span class="line">        <span class="n">site</span> <span class="o">=</span> <span class="n">Site</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">        <span class="n">mock_geodata</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'get_geodata'</span><span class="p">)</span>
</span><span class="line">        <span class="n">mock_geodata</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
</span><span class="line">            <span class="s">'city'</span><span class="p">:</span> <span class="s">'Los Angeles'</span><span class="p">,</span>
</span><span class="line">            <span class="s">'zipcode'</span><span class="p">:</span> <span class="s">'90001'</span><span class="p">,</span>
</span><span class="line">            <span class="s">'latitude'</span><span class="p">:</span> <span class="s">'34.05'</span><span class="p">,</span>
</span><span class="line">            <span class="s">'longitude'</span><span class="p">:</span> <span class="s">'-118.25'</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">
</span><span class="line">        <span class="n">url</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s">'tracking.add_visit'</span><span class="p">,</span> <span class="n">site_id</span><span class="o">=</span><span class="n">site</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span class="line">        <span class="n">wsgi_environment</span> <span class="o">=</span> <span class="p">{</span><span class="s">'REMOTE_ADDR'</span><span class="p">:</span> <span class="s">'1.2.3.4'</span><span class="p">}</span>
</span><span class="line">        <span class="n">headers</span> <span class="o">=</span> <span class="n">Headers</span><span class="p">([(</span><span class="s">'Referer'</span><span class="p">,</span> <span class="s">'/some/url'</span><span class="p">)])</span>
</span><span class="line">
</span><span class="line">        <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">views</span><span class="p">,</span> <span class="s">'get_geodata'</span><span class="p">,</span> <span class="n">mock_geodata</span><span class="p">):</span>
</span><span class="line">            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
</span><span class="line">                <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">environ_overrides</span><span class="o">=</span><span class="n">wsgi_environment</span><span class="p">,</span>
</span><span class="line">                                <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">                <span class="n">visits</span> <span class="o">=</span> <span class="n">Visit</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span class="line">
</span><span class="line">                <span class="n">mock_geodata</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s">'1.2.3.4'</span><span class="p">)</span>
</span><span class="line">                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">visits</span><span class="p">))</span>
</span><span class="line">
</span><span class="line">                <span class="n">first_visit</span> <span class="o">=</span> <span class="n">visits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class="line">                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s">"/some/url"</span><span class="p">,</span> <span class="n">first_visit</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
</span><span class="line">                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s">'Los Angeles, 90001'</span><span class="p">,</span> <span class="n">first_visit</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
</span><span class="line">                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mf">34.05</span><span class="p">,</span> <span class="n">first_visit</span><span class="o">.</span><span class="n">latitude</span><span class="p">)</span>
</span><span class="line">                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="o">-</span><span class="mf">118.25</span><span class="p">,</span> <span class="n">first_visit</span><span class="o">.</span><span class="n">longitude</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Don’t worry – the pain of testing these sorts of integrations is mitigated by the fact that you generally have fewer of them in your application than you have units of code.  Let’s walk through this code section by section and break it down into digestible chunks.</p>

<a name="Set.up.the.test.data.and.mocks"/>
<h3>Set up the test data and mocks</h3>

<p>First, we set up a user and a site since the database is empty at the start of every test:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">test_visitors_location_is_derived_from_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'Joe'</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s">'joe@joe.com'</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">'12345'</span><span class="p">)</span>
</span><span class="line">    <span class="n">site</span> <span class="o">=</span> <span class="n">Site</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then, we create a mock function, and specify that it should return a dictionary containing the coordinates for Los Angeles every time it is called (we could have simply created a simple function that always returned the dictionary, but mock also provides the <a href="http://mock.readthedocs.org/en/latest/patch.html"><code>patch.*</code></a> context managers, which are extremely useful, so we’ll go the whole nine yards with the library):</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">mock_geodata</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'get_geodata'</span><span class="p">)</span>
</span><span class="line"><span class="n">mock_geodata</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
</span><span class="line">    <span class="s">'city'</span><span class="p">:</span> <span class="s">'Los Angeles'</span><span class="p">,</span>
</span><span class="line">    <span class="s">'zipcode'</span><span class="p">:</span> <span class="s">'90001'</span><span class="p">,</span>
</span><span class="line">    <span class="s">'latitude'</span><span class="p">:</span> <span class="s">'34.05'</span><span class="p">,</span>
</span><span class="line">    <span class="s">'longitude'</span><span class="p">:</span> <span class="s">'-118.25'</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, we set up the URL that we are going to visit and the parts of the WSGI environment that we need for <code>tracking.add_visit</code> to work (which, in this case is just the IP address of our fake end user’s visitor and the URL they supposedly came from):</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">url</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s">'tracking.add_visit'</span><span class="p">,</span> <span class="n">site_id</span><span class="o">=</span><span class="n">site</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span class="line"><span class="n">wsgi_environment</span> <span class="o">=</span> <span class="p">{</span><span class="s">'REMOTE_ADDR'</span><span class="p">:</span> <span class="s">'1.2.3.4'</span><span class="p">}</span>
</span><span class="line"><span class="n">headers</span> <span class="o">=</span> <span class="n">Headers</span><span class="p">([(</span><span class="s">'Referer'</span><span class="p">,</span> <span class="s">'/some/url'</span><span class="p">)])</span>
</span></code></pre></td></tr></table></div></figure>


<a name="Patch.the.mock.into.our.tracking.module"/>
<h3>Patch the mock into our tracking module</h3>

<p>We explicitly imported the <code>flask_tracking.tracking.views</code> module into our <code>tests</code> module with:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">..tracking</span> <span class="kn">import</span> <span class="n">views</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we patch that module’s <code>get_views</code> name to point to our <code>mock_geodata</code> object rather than the <code>flask_tracking.tracking.geodata.get_geodata</code> function:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">views</span><span class="p">,</span> <span class="s">'get_geodata'</span><span class="p">,</span> <span class="n">mock_geodata</span><span class="p">):</span>
</span></code></pre></td></tr></table></div></figure>


<p>By using <code>patch.object</code> as a context manager, we ensure that after we exit this <code>with</code> block <code>flask_tracking.tracking.views.get_geodata</code> will once again point to <code>flask_tracking.tracking.geodata.get_geodata</code>.  We could also have used <code>patch.object</code> as a decorator:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">mock_geodata</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'get_geodata'</span><span class="p">)</span>
</span><span class="line"><span class="c"># ... snip return setup ...</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">TrackingViewsTests</span><span class="p">(</span><span class="n">BaseTestCase</span><span class="p">):</span>
</span><span class="line">    <span class="nd">@patch.object</span><span class="p">(</span><span class="n">views</span><span class="p">,</span> <span class="s">'get_geodata'</span><span class="p">,</span> <span class="n">mock_geodata</span><span class="p">)</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">test_visitors_location_is_derived_from_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></code></pre></td></tr></table></div></figure>


<p>or even a class decorator:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="nd">@patch.object</span><span class="p">(</span><span class="n">views</span><span class="p">,</span> <span class="s">'get_geodata'</span><span class="p">,</span> <span class="n">mock_geodata</span><span class="p">)</span>
</span><span class="line"><span class="k">class</span> <span class="nc">TrackingViewsTests</span><span class="p">(</span><span class="n">BaseTestCase</span><span class="p">):</span>
</span></code></pre></td></tr></table></div></figure>


<p>The only difference is the scope of the patch.  The function decorator version ensures that as long as we are inside the <code>test_visitors_location_is_derived_from_ip</code> function <code>get_geodata</code> points at our mock, while the class decorator version ensures that every function that starts with <code>test</code> inside of <code>TrackingViewsTests</code> will see the mocked version of <code>get_geodata</code>.</p>

<p><em>Personally, I prefer to keep the scope of my mocks as limited as possible. It helps ensure that I keep my testing scope in mind, and saves me from surprises where I was expecting to have access to the real object and have to de-patch it.</em></p>

<a name="Run.the.test"/>
<h3>Run the test</h3>

<p>Having set up everything we need we can now make our request:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
</span><span class="line">    <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">environ_overrides</span><span class="o">=</span><span class="n">wsgi_environment</span><span class="p">,</span>
</span><span class="line">                    <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>We provide our controller with the viewer’s IP address through the <code>wsgi_environment</code> dictionary we created (<code>wsgi_environment = {'REMOTE_ADDR': '1.2.3.4'}</code>).  Flask’s test client is an instance of Werkzeug’s test client – which supports all of the arguments that you can pass to <a href="http://werkzeug.pocoo.org/docs/test/#werkzeug.test.EnvironBuilder"><code>EnvironmentBuilder</code></a>.</p>

<a name="Assert.that.everything.worked"/>
<h3>Assert that everything worked</h3>

<p>Finally, we fetch all of the visits from the <code>tracking_visit</code> table:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">visits</span> <span class="o">=</span> <span class="n">Visit</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>and verify that:</p>

<ul>
<li>We used the user’s IP address to lookup his geodata:</li>
</ul>


<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">mock_geodata</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s">'1.2.3.4'</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>The request only generated one visit:</li>
</ul>


<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">visits</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>The location data was properly persisted:</li>
</ul>


<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">first_visit</span> <span class="o">=</span> <span class="n">visits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class="line"><span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s">"/some/url"</span><span class="p">,</span> <span class="n">first_visit</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
</span><span class="line"><span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s">'Los Angeles, 90001'</span><span class="p">,</span> <span class="n">first_visit</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
</span><span class="line"><span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s">"34.05"</span><span class="p">),</span> <span class="n">first_visit</span><span class="o">.</span><span class="n">latitude</span><span class="p">)</span>
</span><span class="line"><span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s">"-118.25"</span><span class="p">),</span> <span class="n">first_visit</span><span class="o">.</span><span class="n">longitude</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>When we run <code>python -m unittest discover</code> we get the following output:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line">F.....
</span><span class="line"><span class="o">======================================================================</span>
</span><span class="line">FAIL: test_visitors_location_is_derived_from_ip <span class="o">(</span>flask_tracking.tracking.tests.TrackingViewsTests<span class="o">)</span>
</span><span class="line">----------------------------------------------------------------------
</span><span class="line">Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
</span><span class="line">  File <span class="s2">"~/dev/flask-tracking/flask_tracking/tracking/tests.py"</span>, line 41, in test_visitors_location_is_derived_from_ip
</span><span class="line">    self.assertEqual<span class="o">(</span><span class="s1">'Los Angeles, 90001'</span>, first_visit.location<span class="o">)</span>
</span><span class="line">AssertionError: <span class="s1">'Los Angeles, 90001'</span> !<span class="o">=</span> None
</span><span class="line">
</span><span class="line">----------------------------------------------------------------------
</span><span class="line">Ran 6 tests in 0.147s
</span><span class="line">
</span><span class="line">FAILED <span class="o">(</span><span class="nv">failures</span><span class="o">=</span>1<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ah, a failure! Apparently, we are not mapping location properly, as the <code>Visit</code>’s location is not being persisted in the database.  Checking our view code reveals that we are indeed setting <code>location</code> when we construct our <code>VisitForm</code> … but that we do not actually <em>have</em> a <code>location</code> field set up for our <code>VisitForm</code>!  Good thing we caught that before we went live! (This duplication of fields causes problems, and should suggest something to you all – when it does I suggest you take a look at <a href="http://wtforms-alchemy.readthedocs.org/en/latest/"><code>wtforms-alchemy</code></a>.)</p>

<p>Once we add <code>location</code>, <code>latitude</code>, and <code>longitude</code> fields to our <code>VisitForm</code> we should be able to run our tests and get:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line">.....
</span><span class="line">----------------------------------------------------------------------
</span><span class="line">Ran 5 tests in 0.150s
</span><span class="line">
</span><span class="line">OK
</span></code></pre></td></tr></table></div></figure>


<p>And that completes our first test with mocks.</p>

<a name="Debugging"/>
<h2>Debugging</h2>

<p>Our unit tests are very useful – but what happens when we try to test something and the test code does not do what we expect it to do? Or even worse, when a user calls us up and complains that he has encountered an error?  If it is a system-wide problem, running our unit tests might reveal the issue … but that could only happen if we checked in <em>and deployed</em> code without running our tests (and we would never do that, now would we?)</p>

<p>Assume that we always run our tests before committing and deploying, then our unit tests cannot help us when something breaks in production.  Instead, we will need to ask the user to provided us with a complete example, so that we can debug it locally.</p>

<p>Let’s say that we engaged in a little bit of refactoring of our login form-</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c"># If you can see what's broken already, give yourself a prize</span>
</span><span class="line"><span class="c"># and write a test to ensure it never happens again :-)</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">LoginForm</span><span class="p">(</span><span class="n">Form</span><span class="p">):</span>
</span><span class="line">    <span class="n">email</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">InputRequired</span><span class="p">(),</span> <span class="n">Email</span><span class="p">()])</span>
</span><span class="line">    <span class="n">password</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">InputRequired</span><span class="p">()])</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">validate_login</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
</span><span class="line">        <span class="k">try</span><span class="p">:</span>
</span><span class="line">            <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">form</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
</span><span class="line">        <span class="k">except</span> <span class="p">(</span><span class="n">MultipleResultsFound</span><span class="p">,</span> <span class="n">NoResultFound</span><span class="p">):</span>
</span><span class="line">            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">"Invalid user"</span><span class="p">)</span>
</span><span class="line">        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span class="line">            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">"Invalid user"</span><span class="p">)</span>
</span><span class="line">        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_valid_password</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
</span><span class="line">            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">"Invalid password"</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">        <span class="c"># Make the current user available</span>
</span><span class="line">        <span class="c"># to calling code.</span>
</span><span class="line">        <span class="n">form</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
</span></code></pre></td></tr></table></div></figure>


<p>-and when we push it to production our first user sends us an email to let us know that he mis-typed his password and was still logged into the system.  We verify that this is the case on our live site. Woah, Nelly, that is not at all acceptable!  So we quickly take down the login page and replace it with a message saying we are down for maintenance and we’ll be back as soon as possible (<em>Rule #0 of SaaS – always treat your customers the way you would want to be treated</em>).</p>

<p>Looking at it locally, we don’t see any reason that users <em>should</em> be able to log in without a password.  However, we haven’t written any tests to test that a mis-typed password is rejected with an error message, so we can’t be 100% sure that this isn’t an error in our code.  So let’s write a test case and see what happens:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">test_invalid_password_is_rejected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">    <span class="n">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">"Joe"</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s">"joe@joes.com"</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">"12345"</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
</span><span class="line">        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">"users.login"</span><span class="p">),</span>
</span><span class="line">                                    <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">"email"</span><span class="p">:</span> <span class="s">"joe@joes.com"</span><span class="p">,</span>
</span><span class="line">                                          <span class="s">"password"</span><span class="p">:</span> <span class="s">"*****"</span><span class="p">})</span>
</span><span class="line">
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">is_anonymous</span><span class="p">())</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">assert_200</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">"Invalid password"</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running the tests results in a failure:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line">.F....
</span><span class="line"><span class="o">======================================================================</span>
</span><span class="line">FAIL: test_invalid_password_is_rejected <span class="o">(</span>app.users.tests.UserViewsTests<span class="o">)</span>
</span><span class="line">----------------------------------------------------------------------
</span><span class="line">Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
</span><span class="line">  File <span class="s2">"~/dev/flask-tracking/flask_tracking/users/tests.py"</span>, line 34, in test_invalid_password_is_rejected
</span><span class="line">    self.assertTrue<span class="o">(</span>current_user.is_anonymous<span class="o">())</span>
</span><span class="line">AssertionError: False is not <span class="nb">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>Okay, so we can reproduce it locally.  And we have a test case to yell at us until we fix the problem.  Good. We’re on our way!</p>

<p>There are several ways we could debug the problem:</p>

<ul>
<li>We could scatter <code>print</code> statements throughout the application until we find the source of the error.</li>
<li>We could generate intentional errors in our code and look at the existing environment using Flask’s built-in debugger.</li>
<li>We could step through the code using a debugger.</li>
</ul>


<p>We’ll use all three techniques.  First, let’s add a simple <code>print</code> statement to our <code>app.users.models.LoginForm#validate_login</code> method:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">validate_login</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
</span><span class="line">    <span class="k">print</span> <span class="s">'Validating login'</span>
</span></code></pre></td></tr></table></div></figure>


<p>When we run our tests again we do not see the “Validating login” message at all.  That tells us that our method is not being called.  Let’s add an intentional error to our view and make use of Flask’s internal debugger to verify the state of the world.  First, we’ll create a new configuration for debugging:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c"># config.py</span>
</span><span class="line"><span class="k">class</span> <span class="nc">DebugConfiguration</span><span class="p">(</span><span class="n">BaseConfiguration</span><span class="p">):</span>
</span><span class="line">    <span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">True</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then we will update <code>flask_tracking.__init__</code> to use the new debug configuration:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="s">'config.DebugConfiguration'</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>And finally, we will add a Arithmetic error to our <code>login_view</code> method:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">login_view</span><span class="p">():</span>
</span><span class="line">    <span class="n">form</span> <span class="o">=</span> <span class="n">LoginForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
</span><span class="line">    <span class="mi">1</span> <span class="o">/</span> <span class="mi">0</span>  <span class="c"># KABOOM!</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, if we run:</p>

<figure class="code"><figcaption><span/></figcaption></figure>


<p>And navigate to the login page we will see a nice traceback.  Clicking on the shell icon on the right of the last line of the traceback (<code>1 / 0</code>) will get us an interactive REPL that we can use to test our function:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line">&gt;&gt;&gt; form.validate_login<span class="o">(</span><span class="nv">field</span><span class="o">=</span>None<span class="o">)</span>  <span class="c"># We don't use the field argument</span>
</span></code></pre></td></tr></table></div></figure>


<p>This results in:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line">Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
</span><span class="line">    File <span class="s2">"&lt;debugger&gt;"</span>, line 1, in &lt;module&gt;
</span><span class="line">    form.validate_login<span class="o">(</span>None<span class="o">)</span>
</span><span class="line">    File <span class="s2">"~/dev/flask-tracking/flask_tracking/users/forms.py"</span>, line 15, in validate_login
</span><span class="line">    raise validators.ValidationError<span class="o">(</span><span class="s1">'Invalid user'</span><span class="o">)</span>
</span><span class="line">    ValidationError: Invalid user
</span></code></pre></td></tr></table></div></figure>


<p>So now we know that our validation function <em>works</em> – it simply is not being called.  Let’s remove that division by zero error from our login view and replace it with a call to <a href="http://docs.python.org/2/library/pdb.html">the Python debugger <code>pdb</code></a>.</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">login_view</span><span class="p">():</span>
</span><span class="line">    <span class="n">form</span> <span class="o">=</span> <span class="n">LoginForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
</span><span class="line">    <span class="kn">import</span> <span class="nn">pdb</span><span class="p">;</span> <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, when we run our tests again we get a debugger:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line">python -m unittest discover .
</span><span class="line">.&gt; ~/dev/flask-tracking/app/users/views.py<span class="o">(</span>18<span class="o">)</span>login_view<span class="o">()</span>
</span><span class="line">-&gt; <span class="k">if </span>form.validate_on_submit<span class="o">()</span>:
</span><span class="line"><span class="o">(</span>Pdb<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can step into the <code>validate_on_submit</code> method by typing “s” for “step”, and step over calls we are not interested in with “n” for “next” (a full introduction to PDB is beyond the scope of this tutorial – for more information on PDB see it’s <a href="http://docs.python.org/2/library/pdb.html">documentation</a> or type “h” while inside of <code>pdb</code>):</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="o">(</span>Pdb<span class="o">)</span> s
</span><span class="line">--Call--
</span><span class="line">&gt; ~/.virtualenvs/realpython/lib/python2.7/site-packages/flask_wtf/form.py<span class="o">(</span>120<span class="o">)</span>validate_on_submit<span class="o">()</span>
</span><span class="line">-&gt; def validate_on_submit<span class="o">(</span>self<span class="o">)</span>:
</span></code></pre></td></tr></table></div></figure>


<p>I won’t walk you through the whole debugging session, but needless to say, the issue was with our code. WTForms allows for inline validators in the form <code>validate_[fieldname]</code>.  Our <code>validate_login</code> method is never called because we don’t have a field named <code>login</code> in our form.  Let’s remove the <code>set_trace</code> call from our controller and rename our <code>flask_tracking.users.forms.LoginForm.validate_login</code> method back to <code>LoginForm.validate_password</code> so that WTForms will pick it up as an inline validator for our <code>password</code> field. This ensures that it only gets called after both the name and password fields have been validated to contain user-supplied data.</p>

<p>Now, when we run our unit tests again, they <em>should</em> pass.  Testing locally reveals that we did indeed fix the issue.  We can now safely deploy and take down our maintenance message.</p>

<a name="Error.Handling"/>
<h2>Error Handling</h2>

<p>As we have discovered, a test suite does not guarantee that we will have no bugs in our application.  It is possible for users to still come across errors in production.  For example, if we simply blindly accessed <code>request.args['some_optional_key']</code> in one of our controllers and we only wrote tests with that optional key set in the request, the end user would get a <code>400 Bad Request</code> response from Flask by default. We want to show a <em>helpful</em> error message to the user in such cases. We also want to avoid showing the users unbranded or out-of-date pages without much help on where to go, or what to do next.</p>

<p>We can register error handlers with Flask to explicitly handle these sorts of issues.  Let’s register one for the most common error – a mis-typed or no-longer existing link:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="nd">@app.errorhandler</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
</span><span class="line"><span class="k">def</span> <span class="nf">page_not_found</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
</span><span class="line">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'404.html'</span><span class="p">),</span> <span class="mi">404</span>
</span></code></pre></td></tr></table></div></figure>


<p>We may want to explicitly handle other kinds of errors as well, such as the 400 Bad Request errors that Flask generates for missing keys and the 500 Internal Server errors that are generated for uncaught exceptions:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="nd">@app.errorhandler</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
</span><span class="line"><span class="k">def</span> <span class="nf">key_error</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
</span><span class="line">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'400.html'</span><span class="p">),</span> <span class="mi">400</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="nd">@app.errorhandler</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
</span><span class="line"><span class="k">def</span> <span class="nf">internal_server_error</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
</span><span class="line">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'generic.html'</span><span class="p">),</span> <span class="mi">500</span>
</span></code></pre></td></tr></table></div></figure>


<p>In addition to the HTTP errors that we might have to deal with, Flask also allows us to display different error pages when an uncaught exception bubbles up to its level.  For now, let’s just register a generic error handler for all uncaught exceptions (but later we may want to register specific ones for more-common error conditions that we cannot do anything about):</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="nd">@app.errorhandler</span><span class="p">(</span><span class="ne">Exception</span><span class="p">)</span>
</span><span class="line"><span class="k">def</span> <span class="nf">unhandled_exception</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
</span><span class="line">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'generic.html'</span><span class="p">),</span> <span class="mi">500</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now all the most common cases of errors should be handled gracefully by our application.</p>

<p>However, we can do even better – let’s ensure that <em>every</em> error is nicely styled we could register the same error handler for every possible error condition:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c"># flask_tracking/errors.py</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">current_app</span><span class="p">,</span> <span class="n">Markup</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">werkzeug.exceptions</span> <span class="kn">import</span> <span class="n">default_exceptions</span><span class="p">,</span> <span class="n">HTTPException</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">error_handler</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
</span><span class="line">    <span class="n">msg</span> <span class="o">=</span> <span class="s">"Request resulted in {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
</span><span class="line">    <span class="n">current_app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">):</span>
</span><span class="line">        <span class="n">description</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">get_description</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
</span><span class="line">        <span class="n">code</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">code</span>
</span><span class="line">        <span class="n">name</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">name</span>
</span><span class="line">    <span class="k">else</span><span class="p">:</span>
</span><span class="line">        <span class="n">description</span> <span class="o">=</span> <span class="p">(</span><span class="s">"We encountered an error "</span>
</span><span class="line">                       <span class="s">"while trying to fulfill your request"</span><span class="p">)</span>
</span><span class="line">        <span class="n">code</span> <span class="o">=</span> <span class="mi">500</span>
</span><span class="line">        <span class="n">name</span> <span class="o">=</span> <span class="s">'Internal Server Error'</span>
</span><span class="line">
</span><span class="line">    <span class="c"># Flask supports looking up multiple templates and rendering the first</span>
</span><span class="line">    <span class="c"># one it finds.  This will let us create specific error pages</span>
</span><span class="line">    <span class="c"># for errors where we can provide the user some additional help.</span>
</span><span class="line">    <span class="c"># (Like a 404, for example).</span>
</span><span class="line">    <span class="n">templates_to_try</span> <span class="o">=</span> <span class="p">[</span><span class="s">'errors/{}.html'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code</span><span class="p">),</span> <span class="s">'errors/generic.html'</span><span class="p">]</span>
</span><span class="line">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="n">templates_to_try</span><span class="p">,</span>
</span><span class="line">                           <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">,</span>
</span><span class="line">                           <span class="n">name</span><span class="o">=</span><span class="n">Markup</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
</span><span class="line">                           <span class="n">description</span><span class="o">=</span><span class="n">Markup</span><span class="p">(</span><span class="n">description</span><span class="p">),</span>
</span><span class="line">                           <span class="n">error</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
</span><span class="line">    <span class="k">for</span> <span class="n">exception</span> <span class="ow">in</span> <span class="n">default_exceptions</span><span class="p">:</span>
</span><span class="line">        <span class="n">app</span><span class="o">.</span><span class="n">register_error_handler</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">error_handler</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="n">app</span><span class="o">.</span><span class="n">register_error_handler</span><span class="p">(</span><span class="ne">Exception</span><span class="p">,</span> <span class="n">error_handler</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="c"># This can be used in __init__ with a</span>
</span><span class="line"><span class="c"># import .errors</span>
</span><span class="line"><span class="c"># errors.init_app(app)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This ensures that all the HTTP error conditions that Flask knows how to handle (4XX and 5XX level errors) have the <code>error_handler</code> function registered as their handler.  Coupled with a <code>app.register_error_handler(Exception, error_handler)</code>, this will cover almost every error that our application might throw.  (There are a few exceptions, such as <code>SystemExit</code> that will not be caught this way and C-level segfaults or OS-level events will obviously not be caught and handled in this way, but those sorts of catastrophic events should be act-of-God occasions, not something that our application needs to be prepared to handle on a semi-regular basis).</p>

<a name="Logging"/>
<h2>Logging</h2>

<p>Finally, let’s talk about logging. Users will not always have enough time to reach out to us with a fully fleshed-out bug report (not to mention, bad actors will be actively looking for ways to take advantage of us.)  We need a way to ensure that we can look back in time and see what happened and when.</p>

<p>Fortunately, both Python and Flask have logging capabilities, so we do not need to re-invent the wheel here either.  A standard Python <code>logging</code> logger is available on the Flask object at <code>app.logger</code>.</p>

<p>The first place where we could use some logging is in our error handlers.  We don’t need to log 404s as the proxy server will do that for us if we set it up right, but we will want to log the reasons for our other exceptions (400, 500 and Exception).  Let’s go ahead and add some more detailed logging to those handlers.  Since we are doing using the same handler for all our errors, this is easy:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">error_handler</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
</span><span class="line">    <span class="n">error_name</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">__name__</span> <span class="k">if</span> <span class="n">error</span> <span class="k">else</span> <span class="s">"Unknown-Error"</span>
</span><span class="line">    <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">'Request resulted in {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">error_name</span><span class="p">),</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
</span><span class="line">    <span class="c"># ... etc. ...</span>
</span></code></pre></td></tr></table></div></figure>


<p>Python’s documentation on the logging module has a good breakdown of the various available <a href="http://docs.python.org/2/howto/logging.html#when-to-use-logging">logging levels</a> and what they are most appropriate for.</p>

<p>For those times when we don’t have access to the <code>app</code> (say, inside of our <code>view</code> modules) we can use the thread-local <code>current_app</code> in the exact same way as we would use <code>app</code>.  For an example, let’s also add a bit of logging to our login and logout handlers:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">current_app</span>
</span><span class="line">
</span><span class="line"><span class="nd">@users.route</span><span class="p">(</span><span class="s">'/logout/'</span><span class="p">)</span>
</span><span class="line"><span class="k">def</span> <span class="nf">logout_view</span><span class="p">():</span>
</span><span class="line">    <span class="n">current_app</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">'Attempting to log out the current user'</span><span class="p">)</span>
</span><span class="line">    <span class="n">logout_user</span><span class="p">()</span>
</span><span class="line">    <span class="n">current_app</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">'Successfully logged out the current user'</span><span class="p">)</span>
</span><span class="line">    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'tracking.index'</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>This code nicely demonstrates an issue we can run into with logging – having too much of it can be as bad as having too little.</em>  In this case, we have as much debugging code as we have application code, and it is difficult to follow the flow of the code any more.  We’ll go ahead and remove this particular logging code, as it doesn’t add anything above and beyond what we would see in our proxy server’s access logs.</p>

<p>If we needed to log the entry and exit of each controller, we could add handlers for <a href="http://flask.pocoo.org/docs/api/#flask.Flask.before_request"><code>app.before_request</code></a> and <a href="http://flask.pocoo.org/docs/api/#flask.Flask.teardown_request"><code>app.teardown_request</code></a>. Just for fun, here’s how we might log every access to our application:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="nd">@app.before_request</span>
</span><span class="line"><span class="k">def</span> <span class="nf">log_entry</span><span class="p">():</span>
</span><span class="line">    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
</span><span class="line">        <span class="s">'url'</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
</span><span class="line">        <span class="s">'method'</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
</span><span class="line">        <span class="s">'ip'</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">"REMOTE_ADDR"</span><span class="p">)</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">"Handling </span><span class="si">%(method)s</span><span class="s"> request from </span><span class="si">%(ip)s</span><span class="s"> for </span><span class="si">%(url)s</span><span class="s">"</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>If we run our application in debug mode and access our home page then we will see:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="o">--------------------------------------------------------------------------------</span>
</span><span class="line"><span class="n">DEBUG</span> <span class="ow">in</span> <span class="n">__init__</span> <span class="p">[</span><span class="o">~/</span><span class="n">dev</span><span class="o">/</span><span class="n">flask</span><span class="o">-</span><span class="n">tracking</span><span class="o">/</span><span class="n">flask_tracking</span><span class="o">/</span><span class="n">__init__</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">68</span><span class="p">]:</span>
</span><span class="line"><span class="n">Handling</span> <span class="n">GET</span> <span class="n">request</span> <span class="kn">from</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="k">for</span> <span class="o">/</span>
</span><span class="line"><span class="o">--------------------------------------------------------------------------------</span>
</span></code></pre></td></tr></table></div></figure>


<p>As was said above, in production logging this sort of information would be duplicating the logs that our proxy server (Apache with mod_wsgi, ngnix with uwsgi, etc.) will be generating.  We should only do this if we are generating a unique value for each request that we absolutely need to keep track of.</p>

<a name="Adding.context.and.formatting.to.our.logs"/>
<h3>Adding context and formatting to our logs</h3>

<p>However, it would be nice to have the context from our <code>log_entry</code> handler (above) in our exception handlers.  Let’s go ahead and add a <a href="http://docs.python.org/2/library/logging.html#filter-objects"><code>Filter</code></a> instance to the logger to provide the url, method, IP address, and user id to all loggers that are interested in them (this is called <a href="http://docs.python.org/2/howto/logging-cookbook.html#filters-contextual">“contextual logging”</a>:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c"># flask_tracking/logs.py</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">logging</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">ContextualFilter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Filter</span><span class="p">):</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_record</span><span class="p">):</span>
</span><span class="line">        <span class="n">log_record</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span>
</span><span class="line">        <span class="n">log_record</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span>
</span><span class="line">        <span class="n">log_record</span><span class="o">.</span><span class="n">ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">"REMOTE_ADDR"</span><span class="p">)</span>
</span><span class="line">        <span class="n">log_record</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_anonymous</span><span class="p">()</span> <span class="k">else</span> <span class="n">current_user</span><span class="o">.</span><span class="n">get_id</span><span class="p">()</span>
</span><span class="line">
</span><span class="line">        <span class="k">return</span> <span class="bp">True</span>
</span></code></pre></td></tr></table></div></figure>


<p>This filter doesn’t actually filter any of our messages – instead, it provides some additional information that we can make use of in our logs.  Here’s an example of how we might use this filter:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c"># Create the filter and add it to the base application logger</span>
</span><span class="line"><span class="n">context_provider</span> <span class="o">=</span> <span class="n">ContextualFilter</span><span class="p">()</span>
</span><span class="line"><span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addFilter</span><span class="p">(</span><span class="n">context_provider</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="c"># Optionally, remove Flask's default debug handler</span>
</span><span class="line"><span class="c"># del app.logger.handlers[:]</span>
</span><span class="line">
</span><span class="line"><span class="c"># Create a new handler for log messages that will send them to standard error</span>
</span><span class="line"><span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
</span><span class="line">
</span><span class="line"><span class="c"># Add a formatter that makes use of our new contextual information</span>
</span><span class="line"><span class="n">log_format</span> <span class="o">=</span> <span class="s">"</span><span class="si">%(asctime)s</span><span class="se">\t</span><span class="si">%(levelname)s</span><span class="se">\t</span><span class="si">%(user_id)s</span><span class="se">\t</span><span class="si">%(ip)s</span><span class="se">\t</span><span class="si">%(method)s</span><span class="se">\t</span><span class="si">%(url)s</span><span class="se">\t</span><span class="si">%(message)s</span><span class="s">"</span>
</span><span class="line"><span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="n">log_format</span><span class="p">)</span>
</span><span class="line"><span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="c"># Finally, attach the handler to our logger</span>
</span><span class="line"><span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>And here’s what a log message might look like:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line">2013-10-12 09:22:52,764    DEBUG   1   127.0.0.1   GET / Some additional message
</span></code></pre></td></tr></table></div></figure>


<p>One thing to note is that the message we pass to <code>app.logger.[LOGLEVEL]</code> is not expanded with the values in the context.  So if we had kept our <code>before_request</code> log call and changed our before request log call to just be-</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c"># Note the missing context argument</span>
</span><span class="line"><span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">"Handling </span><span class="si">%(method)s</span><span class="s"> request from </span><span class="si">%(ip)s</span><span class="s"> for </span><span class="si">%(url)s</span><span class="s">"</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>-the format strings will be passed through unaltered.  But since we have them in our <a href="http://docs.python.org/2/library/logging.html#formatter-objects"><code>Formatter</code></a>, we can remove them from our individual message, leaving just:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="nd">@app.before_request</span>
</span><span class="line"><span class="k">def</span> <span class="nf">log_entry</span><span class="p">():</span>
</span><span class="line">    <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">"Handling request"</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is the advantage of contextual logging – we can include important information in all our log entries without needing to collect it manually at the site of every log call.</p>

<a name="Directing.logs.to.different.places"/>
<h3>Directing logs to different places</h3>

<p>Most of the information we will be logging is not immediately actionable.  However, there are certain kinds of errors we want to know about immediately.  A rash of 500 errors probably means that something is broken with our application, for example.  We cannot stay glued to our logs 24/7 so we need to have severe errors shipped to us.</p>

<p>Fortunately, adding new handlers to our application logger is easy – and since each handler can filter log entries down to only the ones it finds interesting, we can avoid getting deluged by logs, but still get alerts when something breaks horribly.</p>

<p>By way of an example, let’s add another handler that will log ERROR and CRITICAL log messages to a special file.  This will not give us the alerting we want, but email or SMS setup depends on your host (we’ll do such a setup in a later article for Heroku).  To whet your appetite see the example of how to log to email in <a href="http://flask.pocoo.org/docs/errorhandling/#error-mails">Flask’s documentation on logging</a> or <a href="http://stackoverflow.com/q/8616617/135978">these recipes</a>:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">logging</span> <span class="kn">import</span> <span class="n">ERROR</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">logging.handlers</span> <span class="kn">import</span> <span class="n">TimedRotatingFileHandler</span>
</span><span class="line">
</span><span class="line"><span class="c"># Only set up a file handler if we know where to put the logs</span>
</span><span class="line"><span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">"ERROR_LOG_PATH"</span><span class="p">):</span>
</span><span class="line">
</span><span class="line">    <span class="c"># Create one file for each day. Delete logs over 7 days old.</span>
</span><span class="line">    <span class="n">file_handler</span> <span class="o">=</span> <span class="n">TimedRotatingFileHandler</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">"ERROR_LOG_PATH"</span><span class="p">],</span> <span class="n">when</span><span class="o">=</span><span class="s">"D"</span><span class="p">,</span> <span class="n">backupCount</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="c"># Use a multi-line format for this logger, for easier scanning</span>
</span><span class="line">    <span class="n">file_formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s">'''</span>
</span><span class="line"><span class="s">    Time: </span><span class="si">%(asctime)s</span><span class="s"/>
</span><span class="line"><span class="s">    Level: </span><span class="si">%(levelname)s</span><span class="s"/>
</span><span class="line"><span class="s">    Method: </span><span class="si">%(method)s</span><span class="s"/>
</span><span class="line"><span class="s">    Path: </span><span class="si">%(url)s</span><span class="s"/>
</span><span class="line"><span class="s">    IP: </span><span class="si">%(ip)s</span><span class="s"/>
</span><span class="line"><span class="s">    User ID: </span><span class="si">%(user_id)s</span><span class="s"/>
</span><span class="line">
</span><span class="line"><span class="s">    Message: </span><span class="si">%(message)s</span><span class="s"/>
</span><span class="line">
</span><span class="line"><span class="s">    ---------------------'''</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="c"># Filter out all log messages that are lower than Error.</span>
</span><span class="line">    <span class="n">file_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="n">file_handler</span><span class="o">.</span><span class="n">addFormatter</span><span class="p">(</span><span class="n">file_formatter</span><span class="p">)</span>
</span><span class="line">    <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">file_handler</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>If we use this setup ERROR and CRITICAL log messages will appear both on the console and in the file specified in our configuration.</p>

<a name="Wrapping.Up"/>
<h2>Wrapping Up</h2>

<p>We have covered a great deal in this article.</p>

<ol>
<li>Starting out with unit testing, we covered what testing is and why we need it.</li>
<li>We moved on to writing tests, both with and without mocks.</li>
<li>We briefly covered three methods of debugging errors locally (<code>print</code>, intentional errors to trigger Flask’s debugger, and <code>pdb</code>.)</li>
<li>We covered error handling and ensured that our end users should only see styled error pages.</li>
<li>Finally, we went over logging setups.</li>
</ol>


<p>In Part IV we’ll do some Test Driven Development to enable our application to accept payments and display simple reports.</p>

<p>In Part V we will write a RESTful JSON API for others to consume.</p>

<p>In Part VI we will cover automating deployments (on Heroku) with Fabric and basic A/B Feature Testing.</p>

<p>Finally, in Part VII we will cover preserving your application for the future with documentation, code coverage and quality metric tools.</p>

<p>As always, the code is available from <a href="https://github.com/mjhea0/flask-tracking">the repository</a>.  Looking forward to continuing this journey with you.</p>
</div>


      </div></body></html>