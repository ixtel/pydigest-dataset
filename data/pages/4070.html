<html><body><div><div class="entry-content">
            <p>Порой возникает задача выполнить некоторые действия в момент, когда в модели произошло конкретное определённое изменение. В описанном примере рассматривается модель заказа, и нужно записать время оплаты заказа в момент, когда статус оплаты изменился с «не оплачено» на «оплачено». Сама модель:</p>
<pre><code>class Order(models.Model):
    user = models.ForeignKey(User)
    paid = models.BooleanField(“оплачено”, default=False)
    paid_time = models.DateTimeField(“время оплаты”, blank=True, null=True)
</code></pre>
<p>При создании заказа поле <code>paid</code> принимает значение <code>False</code>. При оплате через интегрированную с сайтом платёжную систему это поле устанавливается в <code>True</code>. А также можно через админку вручную установить этот флажок. В любом случае должно записываться время этого действия.
Есть несколько способов выполнить задачу, включая сигналы и обработку во вьюхах или формах. Но рассмотрим решение испключительно на уровне модели.</p>
<p>Очевидно, что нужно переопределить метод <code>save()</code>. И в нём нужно отследить случай, когда поле <code>paid</code> было установлено в <code>False</code>, а стало установлено в <code>True</code>. Новое значение уже есть в <code>self.paid</code>. Осталось получить старое.</p>
<p>Старое значение можно сохранить в отдельном поле при инициализации объекта, в методе <code>__init__</code>. В итоге получим код:</p>
<pre><code>class Order(models.Model):
    user = models.ForeignKey(User)
    paid = models.BooleanField(“оплачено”, default=False)
    paid_time = models.DateTimeField(“время оплаты”, blank=True, null=True)

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.was_paid = self.paid

    def save(self, *args, **kwargs):
        if self.paid and not self.was_paid:
            self.paid_time = timezone.now()
        return super().save(*args, **kwargs)
</code></pre>
        </div>
        

        

        </div></body></html>