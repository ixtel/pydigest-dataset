<html><body><div><article id="post-462" class="post-462 post type-post status-publish format-standard hentry category-tutorials category-vision tag-cars tag-opencv tag-python tag-tracking"><header class="entry-header"><h1 class="entry-title">Car tracking with cascades</h1> <span class="meta-date"><span class="meta-date-prep">Published on</span> <time datetime="2015-04-21T21:38:46+00:00">April 21, 2015</time></span> <span class="meta-author"><span class="author vcard"><span class="meta-author-prep">Author </span><a href="https://pythonspot.com/author/admin/" class="url fn n" title="View all posts by Frank">Frank</a></span></span><span class="meta-comments"><a href="https://pythonspot.com/car-tracking-with-cascades/#comments" class="meta-comments-link">9 Comments</a></span></header><div class="entry-content"><figure id="attachment_466" class="wp-caption alignnone"><a href="https://pythonspot.com/wp-content/uploads/2015/04/output1.gif"><img class="wp-image-466 size-full" src="https://pythonspot.com/wp-content/uploads/2015/04/output1.gif" alt="vehicle tracking opencv"/></a><figcaption class="wp-caption-text">vehicle tracking opencv</figcaption></figure><p>In this tutorial we will look at vehicle tracking using haar features. We have a haar cascade file trained on cars.  You can get the video<a href="http://code.google.com/p/opencv-lane-vehicle-track/source/browse/trunk/bin/road.avi" target="_blank"> from here</a> and the<a href="http://code.google.com/p/opencv-lane-vehicle-track/source/browse/trunk/bin/haar/cars3.xml" target="_blank"> cascade file from here</a>. Lets start with the basic cascade detection program:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="python"><span>#! /usr/bin/python</span>
 
<span>import</span> cv2
 
face_cascade <span>=</span> cv2.<span>CascadeClassifier</span><span>(</span><span>'cars.xml'</span><span>)</span>
vc <span>=</span> cv2.<span>VideoCapture</span><span>(</span><span>'video2.avi'</span><span>)</span>
 
<span>if</span> vc.<span>isOpened</span><span>(</span><span>)</span>:
    rval <span>,</span> frame <span>=</span> vc.<span>read</span><span>(</span><span>)</span>
<span>else</span>:
    rval <span>=</span> <span>False</span>
 
<span>while</span> rval:
    rval<span>,</span> frame <span>=</span> vc.<span>read</span><span>(</span><span>)</span>
 
    <span># car detection.</span>
    cars <span>=</span> face_cascade.<span>detectMultiScale</span><span>(</span>frame<span>,</span> <span>1.1</span><span>,</span> <span>2</span><span>)</span>
 
    ncars <span>=</span> <span>0</span>
    <span>for</span> <span>(</span>x<span>,</span>y<span>,</span>w<span>,</span>h<span>)</span> <span>in</span> cars:
        cv2.<span>rectangle</span><span>(</span>frame<span>,</span><span>(</span>x<span>,</span>y<span>)</span><span>,</span><span>(</span>x+w<span>,</span>y+h<span>)</span><span>,</span><span>(</span><span>0</span><span>,</span><span>0</span><span>,</span><span>255</span><span>)</span><span>,</span><span>2</span><span>)</span>
        ncars <span>=</span> ncars + <span>1</span>
 
    <span># show result</span>
    cv2.<span>imshow</span><span>(</span><span>"Result"</span><span>,</span>frame<span>)</span>
    cv2.<span>waitKey</span><span>(</span><span>1</span><span>)</span><span>;</span>
vc.<span>release</span><span>(</span><span>)</span></pre></td></tr></table></div><p>This will detect cars in the screen but also noise and the screen will be jittering sometimes. To avoid all of these, we have to improve our car tracking algorithm.  We decided to come up with a simple solution.</p><p>If a car is detected in the last few frames, we will draw it at its last position. This avoids flickering.  To avoid the false positives, we simply track a smaller region of the screen: we are not interesting in detecting flying cars <img src="https://pythonspot.com/wp-includes/images/smilies/simple-smile.png" alt=":-)" class="wp-smiley"/>   We decided to detect only a small region of the screen: the region right in front of us.  We ignore cars on the left or right of the lane. The algorithm will at best, tell us if there is a car in front of us and if so where it is.</p><div class="wp_syntax"><table><tr><td class="code"><pre class="python"><span>#! /usr/bin/python</span>
 
<span>import</span> cv2
 
face_cascade <span>=</span> cv2.<span>CascadeClassifier</span><span>(</span><span>'cars.xml'</span><span>)</span>
vc <span>=</span> cv2.<span>VideoCapture</span><span>(</span><span>'video2.avi'</span><span>)</span>
 
<span>if</span> vc.<span>isOpened</span><span>(</span><span>)</span>:
    rval <span>,</span> frame <span>=</span> vc.<span>read</span><span>(</span><span>)</span>
<span>else</span>:
    rval <span>=</span> <span>False</span>
 
 
roi <span>=</span> <span>[</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>]</span>
lastdetected <span>=</span> <span>0</span>
detections <span>=</span> <span>0</span>
 
<span>while</span> rval:
    rval<span>,</span> frame <span>=</span> vc.<span>read</span><span>(</span><span>)</span>
    fheight<span>,</span> fwidth<span>,</span> fdepth <span>=</span> frame.<span>shape</span> 
 
    <span># car detection.</span>
    cars <span>=</span> face_cascade.<span>detectMultiScale</span><span>(</span>frame<span>,</span> <span>1.1</span><span>,</span> <span>1</span><span>)</span>
 
    ncars <span>=</span> <span>0</span>
    <span>for</span> <span>(</span>x<span>,</span>y<span>,</span>w<span>,</span>h<span>)</span> <span>in</span> cars:
 
        <span># do not detect cars in the sky. </span>
        <span>if</span> x &amp;gt<span>;</span> fwidth*<span>0.4</span> <span>and</span> x &amp;lt<span>;</span> fwidth*<span>0.5</span> <span>and</span> y &amp;gt<span>;</span> fheight*<span>0.25</span> <span>and</span> w &amp;gt<span>;</span> <span>30</span> <span>and</span> h &amp;gt<span>;</span> <span>30</span>:
 
                <span>if</span> <span>(</span> <span>abs</span><span>(</span>x-roi<span>[</span><span>0</span><span>]</span><span>)</span> &amp;lt<span>;</span> <span>20</span> <span>)</span>:
                    x <span>=</span> roi<span>[</span><span>0</span><span>]</span>
 
                <span>if</span> <span>(</span> <span>abs</span><span>(</span>y-roi<span>[</span><span>1</span><span>]</span><span>)</span> &amp;lt<span>;</span> <span>20</span> <span>)</span>:
                    y <span>=</span> roi<span>[</span><span>1</span><span>]</span>
 
                <span>if</span> <span>(</span> <span>abs</span><span>(</span>w-roi<span>[</span><span>2</span><span>]</span><span>)</span> &amp;lt<span>;</span> <span>20</span> <span>)</span>:
                    w <span>=</span> roi<span>[</span><span>2</span><span>]</span>
 
                <span>if</span> <span>(</span> <span>abs</span><span>(</span>h-roi<span>[</span><span>3</span><span>]</span><span>)</span> &amp;lt<span>;</span> <span>50</span> <span>)</span>:
                    h <span>=</span> roi<span>[</span><span>3</span><span>]</span>
 
                roi <span>=</span> <span>[</span>x<span>,</span>y<span>,</span>w<span>,</span>h<span>]</span>
                ncars <span>=</span> ncars + <span>1</span>
                lastdetected <span>=</span> <span>0</span>
                detections <span>=</span> detections + <span>1</span>
 
    <span># seen in the last 50 frames</span>
    <span>if</span> lastdetected &amp;lt<span>;</span> <span>5</span>:
         cv2.<span>rectangle</span><span>(</span>frame<span>,</span><span>(</span>roi<span>[</span><span>0</span><span>]</span><span>,</span>roi<span>[</span><span>1</span><span>]</span><span>)</span><span>,</span><span>(</span>roi<span>[</span><span>0</span><span>]</span>+roi<span>[</span><span>2</span><span>]</span><span>,</span>roi<span>[</span><span>1</span><span>]</span>+roi<span>[</span><span>3</span><span>]</span><span>)</span><span>,</span><span>(</span><span>0</span><span>,</span><span>0</span><span>,</span><span>255</span><span>)</span><span>,</span><span>2</span><span>)</span>
 
    lastdetected <span>=</span> lastdetected + <span>1</span>
 
    <span># show result</span>
    cv2.<span>imshow</span><span>(</span><span>"Result"</span><span>,</span>frame<span>)</span>
    cv2.<span>waitKey</span><span>(</span><span>1</span><span>)</span><span>;</span>
vc.<span>release</span><span>(</span><span>)</span></pre></td></tr></table></div><p>Running this will result in the screen above.  It works O.K. but it is not perfect. The cascades are not  rotation invariant, scale and translation invariant. In addition, the size of the box is shaking slightly even after our algorithm improvement.  We can state that to detect vehicles with haar cascades may work reasonably well.</p><p id="epoch-width-sniffer"/></div><footer class="entry-footer"> <span class="meta-categories"><span class="meta-categories-prep">Categories </span><a href="https://pythonspot.com/category/tutorials/" rel="category tag">Tutorials</a>, <a href="https://pythonspot.com/category/vision/" rel="category tag">Vision</a></span><span class="meta-tags"><span class="meta-tags-prep">Tags </span><a href="https://pythonspot.com/tag/cars/" rel="tag">cars</a>, <a href="https://pythonspot.com/tag/opencv/" rel="tag">opencv</a>, <a href="https://pythonspot.com/tag/python/" rel="tag">python</a>, <a href="https://pythonspot.com/tag/tracking/" rel="tag">tracking</a></span></footer></article></div></body></html>