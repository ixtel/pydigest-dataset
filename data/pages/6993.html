<html><body><div><div class="entry-content" itemprop="articleBody">
                    <p>In the world of testing it is important to write tests that are both easy to read and covering a wide range of scenarios. Often one of these will be sacrificed to facilitate the other, such as hard coding your examples so that your test logic remains clear or by creating an overly complicated setup so that multiple scenarios can be explored. Here we discuss two tools that, when combined, will allow you to explore more of the test surface of your web API while still creating clear and maintainable tests.</p>

<h3>Hypothesis</h3>

<p>Hypothesis is a library that, when provided with a description of the parameters for your API will explore many situations that will stress your system allowing you to explore your API more thoroughly. When you have errors, hypothesis will then work to simplify the failing example to show you the simplest failing case and then keep this failing case in it's database to use until the problem is resolved.</p>

<p>Hypothesis uses, what it calls strategies to inject parameters into your test cases. These strategies produce 200 different random examples values from across the variable space (including 'nasty' values such as min, max, nan and inf) and your test is run for each example. In general this is done using a single decorator, <code>@given</code>, on your test case which passes the parameters into the test via the argument list. In the following example two float values are passed to <code>test_float_addition_is_commutative</code>.</p>

<div class="codehilite"><pre><code>    <span class="kn">from</span> <span class="nn">hypothesis</span> <span class="kn">import</span> <span class="n">given</span>
    <span class="kn">from</span> <span class="nn">hypothesis.strategies</span> <span class="kn">import</span> <span class="n">floats</span>

    <span class="kn">from</span> <span class="nn">my.module</span> <span class="kn">import</span> <span class="n">add</span>


    <span class="nd">@given</span><span class="p">(</span><span class="n">floats</span><span class="p">(),</span> <span class="n">floats</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">test_float_addition_is_commutative</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">add</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">)</span> <span class="o">==</span> <span class="n">add</span><span class="p">(</span><span class="n">second</span><span class="p">,</span> <span class="n">first</span><span class="p">)</span>
</code></pre></div>

<p>These can be passed in as either positional or named parameters (though
it is not advised to mix) so the previous test can be defined as:</p>

<div class="codehilite"><pre><code>    <span class="kn">from</span> <span class="nn">hypothesis</span> <span class="kn">import</span> <span class="n">given</span>
    <span class="kn">from</span> <span class="nn">hypothesis.strategies</span> <span class="kn">import</span> <span class="n">floats</span>

    <span class="kn">from</span> <span class="nn">my.module</span> <span class="kn">import</span> <span class="n">add</span>


    <span class="nd">@given</span><span class="p">(</span><span class="n">first</span><span class="o">=</span><span class="n">floats</span><span class="p">(),</span> <span class="n">second</span><span class="o">=</span><span class="n">floats</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">test_float_addition_is_commutative</span><span class="p">(</span><span class="n">first</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">add</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">)</span> <span class="o">==</span> <span class="n">add</span><span class="p">(</span><span class="n">second</span><span class="p">,</span> <span class="n">first</span><span class="p">)</span>
</code></pre></div>

<p>Hypothesis comes with strategies for all built in python types as well as mechanisms for creating complex data structures. It is simple to
chain strategies together to produce new strategies. For example, if we had an object that could be costructed with two keyword parameters <code>text_param</code> and <code>float_param</code> we could create a strategy for it by chaining dictionary, text and float strategies.</p>

<div class="codehilite"><pre><code>    <span class="kn">from</span> <span class="nn">hypothesis.strategies</span> <span class="kn">import</span> <span class="n">floats</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">fixed_dictionaries</span><span class="p">,</span> <span class="n">just</span>


    <span class="k">class</span> <span class="nc">MyObj</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">text_param</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">float_param</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="o">...</span>


    <span class="k">def</span> <span class="nf">my_objs</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">fixed_dicts</span><span class="p">({</span>
            <span class="s">'text_param'</span><span class="p">:</span> <span class="n">text</span><span class="p">(),</span>
            <span class="s">'float_param'</span><span class="p">:</span> <span class="n">floats</span><span class="p">(),</span>
        <span class="p">})</span><span class="o">.</span><span class="n">flatmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">just</span><span class="p">(</span><span class="n">MyObj</span><span class="p">(</span><span class="o">**</span><span class="n">x</span><span class="p">)))</span>
</code></pre></div>

<p>This will take an example from the <code>fixed_dictionary</code> strategy which has\ <code>text_param</code> and <code>float_param</code> fields and pass it into the <code>flatmap</code> function. This will then be used to generate a new strategy that consists of our new instance of <code>MyObj</code>. It is also possible to create entirely new strategies - a good description of this can be found
in the docs <a href="https://hypothesis.readthedocs.org/en/latest/data.html?highlight=flatmap#defining-entirely-new-strategies">here</a>. There is also built in support for generating django models in the <code>hypothesis.extra.django</code> module.</p>

<h4>Constructing Hypothesis Tests</h4>

<p>In general we want to test properties of our methods using hypothesis to avoid replicating the implementation in the test itself, this will help keep tests clear and independent of the implementation. For example we would probably not want to test:</p>

<div class="codehilite"><pre><code>    <span class="nd">@given</span><span class="p">(</span><span class="n">floats</span><span class="p">(),</span> <span class="n">floats</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">test_result_is_sum_of_first_and_second</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">add</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">)</span> <span class="o">==</span> <span class="n">first</span> <span class="o">+</span> <span class="n">second</span>
</code></pre></div>

<p>While it would be ok to write this test as it is sufficiently simple, for more complex examples such as encoding and decoding data you would likely not want to test the encoded result, instead you would test that given a value, encoding and decoding gives the original result:</p>

<div class="codehilite"><pre><code>    <span class="nd">@given</span><span class="p">(</span><span class="n">floats</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">test_encoding_and_decoding_a_value_gives_the_original_value</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="n">encoded</span> <span class="o">=</span> <span class="n">encode</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">decode</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span> <span class="o">==</span> <span class="n">value</span> 
</code></pre></div>

<p>Testing like this gives us two major advantages:</p>

<ol>
<li>The test is very clear and concise helping document the code.</li>
<li>We are testing the behaviour we are actually interested in. Generally we are not interested in the encoded value, just that when we decode an encoded value we get the original value.</li>
</ol>

<p>There are many good articles on property driven testing so we will not go into it any further here. The full documentation for hypothesis can be found <a href="https://hypothesis.readthedocs.org/en/latest/index.html">here</a>.</p>

<h3>Gabbi</h3>

<p>Often when testing APIs we fall into the trap of testing that in a given situation the API call will be successful or error and let the test framework hide all the nasty details from us. While this is usually ok for your javascript application, where we will either display the data on success or give some kind of error on failure, in the more general case http offers a lot of information to your API consumer, which we should make sure is present and correct if we want our APIs to be used by a wider audience.</p>

<p>It is also easy to hide away request construction in the test framework. By doing this it is difficult to know whether we are actually testing the API in a way it will be used by the consumers or whether we are just hiding in some ideal world. Remember, we need to be nasty to our applications in order to test them correctly. Of cource we can enforce all of this in our testing framework but often this makes the test a lot harder to read.</p>

<p>Gabbi is a tool for declaratively creating tests for web APIs. It hopes to solve these problems. To do this Gabbi uses yaml files to declare the test API calls and the expected response which can be run using <code>gabbi-run</code>. For example, lets take a look at a simple web service which has a database of <code>Thing</code>\ s. To test the creation of a thing we may have something like:</p>

<div class="codehilite"><pre><code>    <span class="l-Scalar-Plain">tests</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">create thing</span>
        <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/app/api/things/</span>
        <span class="l-Scalar-Plain">method</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">POST</span>
        <span class="l-Scalar-Plain">status</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">201</span>
        <span class="l-Scalar-Plain">request_headers</span><span class="p-Indicator">:</span>
          <span class="l-Scalar-Plain">content-type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">application/json,</span>
        <span class="l-Scalar-Plain">data</span><span class="p-Indicator">:</span>
          <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">my things name</span>

      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">fetch thing,</span>
        <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/app/api/things/$RESPONSE["$.id"]/,</span>
        <span class="l-Scalar-Plain">response_json_paths</span><span class="p-Indicator">:</span>
          <span class="l-Scalar-Plain">$.name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">my things name</span>
</code></pre></div>

<p>Here we are creating a <code>Thing</code>, making sure the request is a <code>POST</code>, the response code is 201 and that the correct content type is being sent. We also make sure that if we make a <code>GET</code> (default) request for the <code>Thing</code> created in the previous request by using <code>$RESPONSE</code>, we get a 200 status code (default) with json data that has the correct <code>name</code>. In this example <code>$.name</code> is used to reference the <code>name</code> property from the responses json data. This is json path lookup notation, for more information take a look at the <code>JSONPath RW docs pages &lt;http://jsonpath-rw.readthedocs.org/en/latest/&gt;</code>__.</p>

<p>Full Gabbi documentation can be found <a href="https://gabbi.readthedocs.org/en/latest/index.html">here</a>.</p>

<h3>Combining The Two</h3>

<p>The rest of this post will explore how these two tools can be used to create readable, parameterised tests for http API methods. The example is for a django project using django rest framework for the web API and can be found at <a href="https://github.com/wildfish/gabbi-hypothesis-demo">https://github.com/wildfish/gabbi-hypothesis-demo</a>.</p>

<h4>Custom Test Case</h4>

<p>First thing we need to do is create a custom test case that will handle the hard work by creating the Gabbi test cases from a python dictionary rather than yaml files:</p>

<div class="codehilite"><pre><code>    <span class="kn">import</span> <span class="nn">unittest</span>

    <span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">LiveServerTestCase</span>
    <span class="kn">from</span> <span class="nn">gabbi</span> <span class="kn">import</span> <span class="n">case</span>
    <span class="kn">from</span> <span class="nn">gabbi.driver</span> <span class="kn">import</span> <span class="n">test_suite_from_yaml</span><span class="p">,</span> <span class="n">RESPONSE_HANDLERS</span>
    <span class="kn">from</span> <span class="nn">gabbi.reporter</span> <span class="kn">import</span> <span class="n">ConciseTestRunner</span>
    <span class="kn">from</span> <span class="nn">hypothesis.extra.django</span> <span class="kn">import</span> <span class="n">TestCase</span>
    <span class="kn">from</span> <span class="nn">six</span> <span class="kn">import</span> <span class="n">StringIO</span>


    <span class="k">class</span> <span class="nc">GabbiHypothesisTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">,</span> <span class="n">LiveServerTestCase</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Test case to handle running gabbi tests along with hypothesis in django applications.</span>
<span class="sd">        """</span>
        <span class="k">def</span> <span class="nf">run_gabi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gabbi_declaration</span><span class="p">):</span>
            <span class="c"># initialise the gabbi handlers</span>
            <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">RESPONSE_HANDLERS</span><span class="p">:</span>
                <span class="n">handler</span><span class="p">(</span><span class="n">case</span><span class="o">.</span><span class="n">HTTPTestCase</span><span class="p">)</span>

            <span class="c"># take only the host name and port from the live server</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">live_server_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'://'</span><span class="p">)</span>

            <span class="c"># use gabbi to create the test suite from our declaration</span>
            <span class="n">suite</span> <span class="o">=</span> <span class="n">test_suite_from_yaml</span><span class="p">(</span>
                <span class="n">unittest</span><span class="o">.</span><span class="n">defaultTestLoader</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">(),</span>
                <span class="n">gabbi_declaration</span><span class="p">,</span>
                <span class="s">'.'</span><span class="p">,</span>
                <span class="n">host</span><span class="p">,</span>
                <span class="bp">None</span><span class="p">,</span>
                <span class="bp">None</span><span class="p">,</span>
                <span class="bp">None</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c"># run the test (we store the the output into a custom stream so that hypothesis can display only the simple</span>
            <span class="c"># case test result on failure rather than every failing case)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">ConciseTestRunner</span><span class="p">(</span><span class="n">stream</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">suite</span><span class="p">)</span>

            <span class="c"># if we weren't successfull we need to fail the test case with the error string from gabbi</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">wasSuccessful</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
</code></pre></div>

<p>First thing to note, our test case inherits from the django <code>TestCase</code> supplied by Hypothesis as well as the <code>LiveServerTestCase</code> which will handle the database between Hypothesis runs as well as creating the
server to test against. Next we initialise the Gabbi request handlers. Third we build the Gabbi test suite from the declaration and finally run the tests reporting any errors so that Hypothesis can try and find a simpler error case.</p>

<h4>Building Tests</h4>

<p>If we go back to the example from above with a web app that stores <code>Thing</code>\ s we would start by writing:</p>

<div class="codehilite"><pre><code>    <span class="kn">from</span> <span class="nn">hypothesis</span> <span class="kn">import</span> <span class="n">given</span>
    <span class="kn">from</span> <span class="nn">hypothesis.strategies</span> <span class="kn">import</span> <span class="n">text</span>
    <span class="kn">from</span> <span class="nn">.test_case</span> <span class="kn">import</span> <span class="n">GabbiHypothesisTestCase</span>

    <span class="k">class</span> <span class="nc">ThingApi</span><span class="p">(</span><span class="n">GabbiHypothesisTestCase</span><span class="p">):</span>
        <span class="nd">@given</span><span class="p">(</span><span class="n">text</span><span class="p">())</span>
        <span class="k">def</span> <span class="nf">test_object_is_created___object_has_correct_name_when_fetched</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_gabi</span><span class="p">({</span>
                <span class="s">'tests'</span><span class="p">:</span> <span class="p">[{</span>
                    <span class="s">'name'</span><span class="p">:</span> <span class="s">'create thing'</span><span class="p">,</span>
                    <span class="s">'url'</span><span class="p">:</span> <span class="s">'/app/api/things/'</span><span class="p">,</span>
                    <span class="s">'method'</span><span class="p">:</span> <span class="s">'POST'</span><span class="p">,</span>
                    <span class="s">'status'</span><span class="p">:</span> <span class="mi">201</span><span class="p">,</span>
                    <span class="s">'request_headers'</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s">'content-type'</span><span class="p">:</span> <span class="s">'application/json'</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="s">'data'</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s">'name'</span><span class="p">:</span> <span class="n">name</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s">'name'</span><span class="p">:</span> <span class="s">'fetch thing'</span><span class="p">,</span>
                    <span class="s">'url'</span><span class="p">:</span> <span class="s">'/app/api/things/$RESPONSE["$.id"]/'</span><span class="p">,</span>
                    <span class="s">'response_json_paths'</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s">'$.name'</span><span class="p">:</span> <span class="n">name</span>
                    <span class="p">}</span>
                <span class="p">}],</span>
            <span class="p">})</span>
</code></pre></div>

<p>This is exactly the same test as above except we are taking the name for our object from Hypothesis. When we run the test we get the following output:</p>

<div class="codehilite"><pre><code><span class="go">    $ python manage.py test</span>
<span class="go">    Creating test database for alias 'default'...</span>
<span class="go">    Falsifying example: test_object_is_created___object_has_correct_name_when_fetched(self=&lt;app.tests.ThingApi testMethod=test_object_is_created___object_has_correct_name_when_fetched&gt;, name='')</span>
<span class="go">    F</span>
<span class="go">    ...</span>
<span class="go">    AssertionError: FAIL: create thing</span>
<span class="go">        '400' not found in ['201'], response:\r{\r  "name": [\r    "This field may not be blank."\r  ]\r}</span>
<span class="go">    FAIL: fetch thing</span>
<span class="go">        unable to replace $RESPONSE in /app/api/things/$RESPONSE["$.id"]/, data unavailable: JSONPath '$.id' failed to match on data: '{'name': ['This field may not be blank.']}'</span>
</code></pre></div>

<p>This gives us 2 pieces of information, firstly that it failed and secondly, that it failed because the API was passed an empty string. This has shown us that our assumptions about what data can be handled by our API were false. Now we can add a new test case to cover the empty string example and refine our original test to ignore the value. It turns out that django rest framework will strip input of white space on cleaning the data so we will modify our tests to account for all 'empty' strings. </p>

<p>To update our test we will introduce <code>filter</code> and <code>assume</code> from Hypothesis.
<code>filter</code> as you may expect, only gives values that match the filter function. <code>assume</code> fails the test in a way that Hypothesis will catch and then learn to favour giving examples that match the assumption. This failure is not recorded as a failure and does not take up one of the test examples:</p>

<div class="codehilite"><pre><code>    <span class="kn">from</span> <span class="nn">hypothesis</span> <span class="kn">import</span> <span class="n">given</span><span class="p">,</span> <span class="n">assume</span>
    <span class="kn">from</span> <span class="nn">hypothesis.strategies</span> <span class="kn">import</span> <span class="n">text</span>
    <span class="kn">from</span> <span class="nn">.test_case</span> <span class="kn">import</span> <span class="n">GabbiHypothesisTestCase</span>


    <span class="k">class</span> <span class="nc">ThingApi</span><span class="p">(</span><span class="n">GabbiHypothesisTestCase</span><span class="p">):</span>
        <span class="nd">@given</span><span class="p">(</span><span class="n">text</span><span class="p">())</span>
        <span class="k">def</span> <span class="nf">test_object_is_created___object_has_correct_name_when_fetched</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="n">assume</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">run_gabi</span><span class="p">({</span>
                <span class="s">'tests'</span><span class="p">:</span> <span class="p">[{</span>
                    <span class="s">'name'</span><span class="p">:</span> <span class="s">'create thing'</span><span class="p">,</span>
                    <span class="s">'url'</span><span class="p">:</span> <span class="s">'/app/api/things/'</span><span class="p">,</span>
                    <span class="s">'method'</span><span class="p">:</span> <span class="s">'POST'</span><span class="p">,</span>
                    <span class="s">'status'</span><span class="p">:</span> <span class="mi">201</span><span class="p">,</span>
                    <span class="s">'request_headers'</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s">'content-type'</span><span class="p">:</span> <span class="s">'application/json'</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="s">'data'</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s">'name'</span><span class="p">:</span> <span class="n">name</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s">'name'</span><span class="p">:</span> <span class="s">'fetch thing'</span><span class="p">,</span>
                    <span class="s">'url'</span><span class="p">:</span> <span class="s">'/app/api/things/$RESPONSE["$.id"]/'</span><span class="p">,</span>
                    <span class="s">'response_json_paths'</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s">'$.name'</span><span class="p">:</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="p">}</span>
                <span class="p">}],</span>
            <span class="p">})</span>

        <span class="nd">@given</span><span class="p">(</span><span class="n">text</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
        <span class="k">def</span> <span class="nf">test_object_name_is_blank___bad_request_status_is_given</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_gabi</span><span class="p">({</span>
                <span class="s">'tests'</span><span class="p">:</span> <span class="p">[{</span>
                    <span class="s">'name'</span><span class="p">:</span> <span class="s">'create thing'</span><span class="p">,</span>
                    <span class="s">'url'</span><span class="p">:</span> <span class="s">'/app/api/things/'</span><span class="p">,</span>
                    <span class="s">'method'</span><span class="p">:</span> <span class="s">'POST'</span><span class="p">,</span>
                    <span class="s">'status'</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
                    <span class="s">'request_headers'</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s">'content-type'</span><span class="p">:</span> <span class="s">'application/json'</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="s">'data'</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s">'name'</span><span class="p">:</span> <span class="n">name</span>
                    <span class="p">},</span>
                    <span class="s">'response_json_paths'</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s">'$.name'</span><span class="p">:</span> <span class="p">[</span><span class="s">'This field may not be blank.'</span><span class="p">]</span>
                    <span class="p">}</span>
                <span class="p">}],</span>
            <span class="p">})</span>
</code></pre></div>

<p>Now, in the first test case any empty strings will fail the assumption and be reported to Hypothesis. In the second test case we are pre filtering the examples so that only empty strings are passed in. When we run these tests we get:</p>

<div class="codehilite"><pre><code><span class="go">    $ python manage.py test</span>
<span class="go">    Creating test database for alias 'default'...</span>
<span class="go">    Falsifying example: test_object_is_created___object_has_correct_name_when_fetched(self=&lt;app.tests.ThingApi testMethod=test_object_is_created___object_has_correct_name_when_fetched&gt;, name='0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000')</span>
<span class="go">    F.</span>
<span class="go">    ...</span>
<span class="go">    AssertionError: FAIL: create thing</span>
<span class="go">        '400' not found in ['201'], response:\r{\r  "name": [\r    "Ensure this field has no more than 255 characters."\r  ]\r}</span>
<span class="go">    FAIL: fetch thing</span>
<span class="go">        unable to replace $RESPONSE in /app/api/things/$RESPONSE["$.id"]/, data unavailable: JSONPath '$.id' failed to match on data: '{'name': ['Ensure this field has no more than 255 characters.']}'</span>
<span class="go">    ----------------------------------------------------------------------</span>
<span class="go">    Ran 2 tests in 0.016s</span>

<span class="go">    FAILED (failures=2)</span>


<span class="go">    ----------------------------------------------------------------------</span>
<span class="go">    Ran 2 tests in 7.159s</span>

<span class="go">    FAILED (failures=1)</span>
<span class="go">    Destroying test database for alias 'default'...</span>
</code></pre></div>

<p>So another assumption about our API was not correct. Our API cannot handle arbitrarily long names. Again we add a test to cover this example
and refine the original test:</p>

<div class="codehilite"><pre><code>    <span class="k">class</span> <span class="nc">ThingApi</span><span class="p">(</span><span class="n">GabbiHypothesisTestCase</span><span class="p">):</span>
        <span class="nd">@given</span><span class="p">(</span><span class="n">text</span><span class="p">())</span>
        <span class="k">def</span> <span class="nf">test_object_is_created___object_has_correct_name_when_fetched</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="n">assume</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">255</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">run_gabi</span><span class="p">({</span>
                <span class="o">...</span>
            <span class="p">})</span>

        <span class="o">...</span>

        <span class="nd">@given</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">min_size</span><span class="o">=</span><span class="mi">256</span><span class="p">))</span>
        <span class="k">def</span> <span class="nf">test_object_name_too_long___bad_request_status_is_given</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="n">assume</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">run_gabi</span><span class="p">({</span>
                <span class="s">'tests'</span><span class="p">:</span> <span class="p">[{</span>
                    <span class="s">'name'</span><span class="p">:</span> <span class="s">'create thing'</span><span class="p">,</span>
                    <span class="s">'url'</span><span class="p">:</span> <span class="s">'/app/api/things/'</span><span class="p">,</span>
                    <span class="s">'method'</span><span class="p">:</span> <span class="s">'POST'</span><span class="p">,</span>
                    <span class="s">'status'</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
                    <span class="s">'request_headers'</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s">'content-type'</span><span class="p">:</span> <span class="s">'application/json'</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="s">'data'</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s">'name'</span><span class="p">:</span> <span class="n">name</span>
                    <span class="p">},</span>
                    <span class="s">'response_json_paths'</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s">'$.name'</span><span class="p">:</span> <span class="p">[</span><span class="s">'Ensure this field has no more than 255 characters.'</span><span class="p">]</span>
                    <span class="p">}</span>
                <span class="p">}],</span>
            <span class="p">})</span>
</code></pre></div>

<p>When we run this we now all tests pass.</p>

<div class="codehilite"><pre><code><span class="go">    $ python manage.py test</span>
<span class="go">    Creating test database for alias 'default'...</span>
<span class="go">    ...</span>
<span class="go">    ----------------------------------------------------------------------</span>
<span class="go">    Ran 3 tests in 10.809s</span>

<span class="go">    OK</span>
<span class="go">    Destroying test database for alias 'default'...</span>
</code></pre></div>

<h3>A Note On Versioning</h3>

<p>Let's assume that this API was to be used by a wide audience and we wanted to change our model so that <code>name</code> was actually stored as <code>first_name</code>, <code>middle_names</code> and <code>last_name</code>. We would be safe in making that change because our tests never use the model directly, the only thing we state in our tests is that using this version of the API our consumers will be able to create an object by supplying the <code>name</code> parameter and when retrieving the object the <code>name</code> parameter will be present with the correct value. If all tests pass we should be able to roll out our model change safe in the knowledge our users using the old API will not have their applications immediately break.</p>

<h3>Conclusion</h3>

<p>We have seen how to combine Hypothesis and Gabbi to create tests for our API that are both readable and have high coverage by delegating the value selection. We have also seen how using these methods we can check and improve the assumptions we have made about our API. Finally, property based tesing can be used to help keep test faith for older versions of you API.</p>

<p>Using these tools along with test driven development can ensure we get the API that we want to use and have great test coverage.</p>

<h3>Update</h3>

<p>It turns out some of our hypothesis examples can be made simpler. Our chaining example can be created using the 
<code>builds</code> strategy:</p>

<div class="codehilite"><pre><code>    <span class="n">builds</span><span class="p">(</span><span class="n">MyObj</span><span class="p">,</span> <span class="n">float_param</span><span class="o">=</span><span class="n">floats</span><span class="p">(),</span> <span class="n">text_param</span><span class="o">=</span><span class="n">text</span><span class="p">())</span>
</code></pre></div>

<p>We can also make the 'empty' string case simpler by specifying an <code>alphabet</code> rather than using <code>filter</code> so:</p>

<div class="codehilite"><pre><code>    <span class="n">text</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</code></pre></div>

<p>becomes: </p>

<div class="codehilite"><pre><code>    <span class="n">text</span><span class="p">(</span><span class="n">alphabet</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">whitespace</span><span class="p">)</span>
</code></pre></div>

                </div>
            

            
                
            
        </div></body></html>