<html><body><div><article class="card post-331 post type-post status-publish format-standard hentry category-cherrypy category-container category-docker category-python tag-cherrypy tag-docker tag-python" id="post-331">

                <h2>A more concrete example of a complete web application with CherryPy, PostgreSQL and haproxy</h2>
                

                
<p class="topsy_widget_data topsy_theme_blue"/>
<p>In the previous <a title="Create a docker container for your CherryPy application" href="http://www.defuze.org/archives/315-create-a-docker-container-for-your-cherrypy-application.html" target="_blank">post</a>, I described how to setup a docker image to host your <a href="http://www.cherrypy.org" target="_blank">CherryPy</a> application. In this installment, I will present a complete – although simple – web application made of a database, two web application servers and a load-balancer.</p>
<h2>Setup a database service</h2>
<p>We are going to create a docker image to host our database instance, but because we are lazy and because it has been done already, we will be using <a href="https://registry.hub.docker.com/_/postgres/" target="_blank">an official image</a> of PostgreSQL.</p>

		<div id="crayon-56d5a0db699fa121261210" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5a0db699fa121261210-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">docker </span><span class="crayon-v">run</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">name </span><span class="crayon-v">webdb</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">e</span><span class="crayon-h"> </span><span class="crayon-v">POSTGRES_PASSWORD</span><span class="crayon-o">=</span><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">e</span><span class="crayon-h"> </span><span class="crayon-v">POSTGRES_USER</span><span class="crayon-o">=</span><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">d</span><span class="crayon-h"> </span><span class="crayon-v">postgres</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>As you can see, we run the official, latest, PostgreSQL image. By setting the POSTGRES_USER and POSTGRES_PASSWORD, we make sure the container creates the according account for us. We also set a name for this container, this will be useful when we link to it from another container as we will see later on.</p>
<blockquote><p>A word of warning, this image is not necessarily secure. I would advise you to consider this question prior to using it in production.</p></blockquote>
<p>Now that the server is running, let’s create a database for our application. Run a new container which will execute the psql shell:</p>

		<div id="crayon-56d5a0db69a2b152344459" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5a0db69a2b152344459-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">docker </span><span class="crayon-v">run</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">it</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">link </span><span class="crayon-v">webdb</span><span class="crayon-o">:</span><span class="crayon-v">postgres</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">rm </span><span class="crayon-e">postgres </span><span class="crayon-v">sh</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">c</span><span class="crayon-h"> </span><span class="crayon-s">'exec psql -h "$POSTGRES_PORT_5432_TCP_ADDR" -p "$POSTGRES_PORT_5432_TCP_PORT" -U test'</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a0db69a2b152344459-2"><span class="crayon-h"> </span><span class="crayon-e">Password </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">user </span><span class="crayon-v">test</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5a0db69a2b152344459-3"><span class="crayon-h"> </span><span class="crayon-e">psql</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">9.4.0</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a0db69a2b152344459-4"><span class="crayon-h"> </span><span class="crayon-i">Type</span><span class="crayon-h"> </span><span class="crayon-s">"help"</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">help</span><span class="crayon-sy">.</span></p><p class="crayon-line" id="crayon-56d5a0db69a2b152344459-5"><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-o">=</span><span class="crayon-p"># CREATE DATABASE notes;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a0db69a2b152344459-6"><span class="crayon-h"> </span><span class="crayon-e">CREATE </span><span class="crayon-e">DATABASE</span></p><p class="crayon-line" id="crayon-56d5a0db69a2b152344459-7"><span class="crayon-e"> </span><span class="crayon-v">test</span><span class="crayon-o">=</span><span class="crayon-p"># \c notes \dt</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a0db69a2b152344459-8"><span class="crayon-h"> </span><span class="crayon-e">You </span><span class="crayon-e">are </span><span class="crayon-e">now </span><span class="crayon-e">connected </span><span class="crayon-st">to</span><span class="crayon-h"> </span><span class="crayon-i">database</span><span class="crayon-h"> </span><span class="crayon-s">"notes"</span><span class="crayon-h"> </span><span class="crayon-st">as</span><span class="crayon-h"> </span><span class="crayon-i">user</span><span class="crayon-h"> </span><span class="crayon-s">"test"</span><span class="crayon-sy">.</span></p><p class="crayon-line" id="crayon-56d5a0db69a2b152344459-9"><span class="crayon-h"> </span><span class="crayon-e">List </span><span class="crayon-e">of </span><span class="crayon-e">relations</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a0db69a2b152344459-10"><span class="crayon-e"> </span><span class="crayon-v">Schema</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">Name</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">Type</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">Owner</span></p><p class="crayon-line" id="crayon-56d5a0db69a2b152344459-11"><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">+</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">+</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">-</span><span class="crayon-o">+</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">-</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a0db69a2b152344459-12"><span class="crayon-h"> </span><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">note</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">table</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-e">test</span></p><p class="crayon-line" id="crayon-56d5a0db69a2b152344459-13"><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-h"> </span><span class="crayon-v">row</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a0db69a2b152344459-14"><span class="crayon-h"> </span><span class="crayon-v">notes</span><span class="crayon-o">=</span><span class="crayon-p">#</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>We have connected to the server, we then create the “<em>notes</em>” database and connect to it.</p>
<p>How did this work? Well, the magic happens through the <strong><em>–link wedb:postgres</em></strong> we provided to the run command. This tells the new container we are <a href="https://docs.docker.com/userguide/dockerlinks/" target="_blank">linking</a> to a container named webdb and that we create an alias for it inside that new container. That alias is used by docker to initialize a few environment variables such as:</p>

		<div id="crayon-56d5a0db69a34425489234" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5a0db69a34425489234-1"><span class="crayon-v">POSTGRES_PORT_5432_TCP_ADDR</span><span class="crayon-o">:</span><span class="crayon-h"> </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a0db69a34425489234-2"><span class="crayon-h">   </span><span class="crayon-e">the </span><span class="crayon-e">IP </span><span class="crayon-e">address </span><span class="crayon-e">of </span><span class="crayon-e">the </span><span class="crayon-e">linked </span><span class="crayon-e">container</span></p><p class="crayon-line" id="crayon-56d5a0db69a34425489234-3"><span class="crayon-v">POSTGRES_PORT_5432_TCP_PORT</span><span class="crayon-o">:</span><span class="crayon-h"> </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a0db69a34425489234-4"><span class="crayon-h">   </span><span class="crayon-e">the </span><span class="crayon-e">exposed </span><span class="crayon-i">port</span><span class="crayon-h"> </span><span class="crayon-cn">5432</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e">which </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-e">quite </span><span class="crayon-e">obviously </span><span class="crayon-e">the </span><span class="crayon-i">server</span>'<span class="crayon-i">s</span><span class="crayon-h"> </span><span class="crayon-v">port</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>Notice the <em>POSTGRES_</em> prefix? This is exactly the alias we gave in the command’s argument. This is the mechanism by which you will link your containers so that they can talk to each other.</p>
<p>Note that there are alternatives, such as <a href="http://weave.works/" target="_blank">weave</a>, that may be a little more complex but probably more powerful. Make sure to check them out at some point.</p>
<h2>Setup our web application service</h2>
<p>We are going to run a very basic <a href="https://bitbucket.org/Lawouach/cherrypy-recipes/src/tip/deployment/container/webapp_with_load_balancing/?at=default" target="_blank">web application</a>. It will be a form to take notes. The application will display them and you will be able to delete each note. The notes are posted via javascript through a simple <a href="https://bitbucket.org/Lawouach/cherrypy-recipes/src/tip/deployment/container/webapp_with_load_balancing/webapp/api.py?at=default" target="_blank">REST API</a>. Nothing fancy. Here is a screenshot for you:</p>
<p><a href="http://www.defuze.org/wp-content/uploads/2015/01/notes_screen.png"><img class="aligncenter size-medium wp-image-333" src="http://www.defuze.org/wp-content/uploads/2015/01/notes_screen-300x172.png" alt="notes_screen" srcset="http://www.defuze.org/wp-content/uploads/2015/01/notes_screen-300x172.png 300w, http://www.defuze.org/wp-content/uploads/2015/01/notes_screen-624x358.png 624w, http://www.defuze.org/wp-content/uploads/2015/01/notes_screen.png 923w" sizes="(max-width: 300px) 100vw, 300px"/></a></p>
<p>By the way, the application uses <a href="http://purecss.io/" target="_blank">Yahoo’s Pure.css framework</a> to change from bootstrap.</p>
<p>Simply clone the mercurial repository to fetch the code.</p>

		<div id="crayon-56d5a0db69a3d875574357" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5a0db69a3d875574357-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">hg </span><span class="crayon-r">clone</span> <span class="crayon-v">https</span><span class="crayon-o">:</span><span class="crayon-c">//Lawouach@bitbucket.org/Lawouach/cherrypy-recipes</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a0db69a3d875574357-2"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">cd </span><span class="crayon-v">cherrypy</span><span class="crayon-o">-</span><span class="crayon-v">recipes</span><span class="crayon-o">/</span><span class="crayon-v">deployment</span><span class="crayon-o">/</span><span class="crayon-v">container</span><span class="crayon-o">/</span><span class="crayon-v">webapp_with_load_balancing</span><span class="crayon-o">/</span><span class="crayon-i">notesapp</span></p><p class="crayon-line" id="crayon-56d5a0db69a3d875574357-3"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">ls</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a0db69a3d875574357-4"><span class="crayon-e">Dockerfile </span><span class="crayon-v">webapp</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>This will download the whole repository but fear not, it’s rather lightweight. You can review the <a href="https://bitbucket.org/Lawouach/cherrypy-recipes/src/tip/deployment/container/webapp_with_load_balancing/notesapp/Dockerfile?at=default" target="_blank">Dockerfile</a> which is rather similar to what was described in my previous post. Notice how we copy the webapp subdirectory onto the image.</p>
<p>We can now create our image from that directory:</p>

		<div id="crayon-56d5a0db69a44004455781" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5a0db69a44004455781-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">docker </span><span class="crayon-v">build</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">t</span><span class="crayon-h"> </span><span class="crayon-v">lawouach</span><span class="crayon-o">/</span><span class="crayon-v">webapp</span><span class="crayon-o">:</span><span class="crayon-i">latest</span><span class="crayon-h"> </span><span class="crayon-sy">.</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>As usual, change the tag to whatever suits you.</p>
<p>Let’s now run two containers from that image:</p>

		<div id="crayon-56d5a0db69a4c125797606" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5a0db69a4c125797606-1"><span class="crayon-sy">$</span> <span class="crayon-e">docker </span><span class="crayon-v">run</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">link </span><span class="crayon-v">webdb</span><span class="crayon-o">:</span><span class="crayon-v">postgres</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">name </span><span class="crayon-v">notes1</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">rm</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">p</span><span class="crayon-h"> </span><span class="crayon-cn">8080</span><span class="crayon-o">:</span><span class="crayon-cn">8080</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">t</span><span class="crayon-h"> </span><span class="crayon-v">lawouach</span><span class="crayon-o">/</span><span class="crayon-v">webapp</span><span class="crayon-o">:</span><span class="crayon-i">latest</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a0db69a4c125797606-2"><span class="crayon-sy">$</span> <span class="crayon-e">docker </span><span class="crayon-v">run</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">link </span><span class="crayon-v">webdb</span><span class="crayon-o">:</span><span class="crayon-v">postgres</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">name </span><span class="crayon-v">notes2</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">rm</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">p</span><span class="crayon-h"> </span><span class="crayon-cn">8081</span><span class="crayon-o">:</span><span class="crayon-cn">8080</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">t</span><span class="crayon-h"> </span><span class="crayon-v">lawouach</span><span class="crayon-o">/</span><span class="crayon-v">webapp</span><span class="crayon-o">:</span><span class="crayon-v">latest</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>We link those two containers with the container running our database. We can therefore use that <a href="https://bitbucket.org/Lawouach/cherrypy-recipes/src/tip/deployment/container/webapp_with_load_balancing/notesapp/webapp/server.py?at=default#cl-28" target="_blank">knowledge to connect to the database</a> via SQLAlchemy. We also publish the application’s port to two distinct ports on the host. Finally, we name our containers so that can we reference them in the next container we will be creating.</p>
<p>At this stage, you ought to see that your application is running by going either to http://localhost:8080/ or http://localhost:8081/.</p>
<h2>Setup a load balancer service</h2>
<p>Our last service – microservice should I say – is a simple load-balancer between our two web applications. To support this feature, we will be using <a href="http://www.haproxy.org/" target="_blank">haproxy</a>. Well-known, reliable and lean component for such a task.</p>

		<div id="crayon-56d5a0db69a54168789998" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5a0db69a54168789998-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">cd </span><span class="crayon-v">cherrypy</span><span class="crayon-o">-</span><span class="crayon-v">recipes</span><span class="crayon-o">/</span><span class="crayon-v">deployment</span><span class="crayon-o">/</span><span class="crayon-v">container</span><span class="crayon-o">/</span><span class="crayon-v">webapp_with_load_balancing</span><span class="crayon-o">/</span><span class="crayon-v">load</span><span class="crayon-sy">_</span>balancing</p><p class="crayon-line crayon-striped-line" id="crayon-56d5a0db69a54168789998-2"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">ls</span></p><p class="crayon-line" id="crayon-56d5a0db69a54168789998-3"><span class="crayon-e">Dockerfile </span><span class="crayon-v">haproxy</span><span class="crayon-sy">.</span><span class="crayon-v">cfg</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>Tak some time to review the <a href="https://bitbucket.org/Lawouach/cherrypy-recipes/src/tip/deployment/container/webapp_with_load_balancing/load_balancing/Dockerfile?at=default" target="_blank">Dockerfile</a>. Notice how we copy the local haproxy.cfg file as the configuration for our load-balancer. Build your image like this:</p>

		<div id="crayon-56d5a0db69a5b789892602" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5a0db69a5b789892602-1"><span class="crayon-sy">$</span> <span class="crayon-e">docker </span><span class="crayon-v">build</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">t</span><span class="crayon-h"> </span><span class="crayon-v">lawouach</span><span class="crayon-o">/</span><span class="crayon-v">haproxy</span><span class="crayon-o">:</span><span class="crayon-i">latest</span><span class="crayon-h"> </span><span class="crayon-sy">.</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>And now run it to start load balancing between your two web application containers:</p>

		<div id="crayon-56d5a0db69a62674594304" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5a0db69a62674594304-1"><span class="crayon-sy">$</span> <span class="crayon-e">docker </span><span class="crayon-v">run</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">link </span><span class="crayon-v">notes1</span><span class="crayon-o">:</span><span class="crayon-v">n1</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">link </span><span class="crayon-v">notes2</span><span class="crayon-o">:</span><span class="crayon-v">n2</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">name </span><span class="crayon-v">haproxy</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">p</span><span class="crayon-h"> </span><span class="crayon-cn">8090</span><span class="crayon-o">:</span><span class="crayon-cn">8090</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">p</span><span class="crayon-h"> </span><span class="crayon-cn">8091</span><span class="crayon-o">:</span><span class="crayon-cn">8091</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">d</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">t</span><span class="crayon-h"> </span><span class="crayon-v">lawouach</span><span class="crayon-o">/</span><span class="crayon-v">haproxy</span><span class="crayon-o">:</span><span class="crayon-v">latest</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>In this case, we will be executing the container in the background because we are blocking on haproxy and it won’t lok to the console anyway.</p>
<p>Notice how we link to both web application containers. We set short alias just by pure lazyness. We publish two ports to the host. The 8090 port will be necessary to access the stats page of the haproxy server itself. The 8091 port will be used to access our application.</p>
<p>To understand how we reuse the the aliases, please refer to the the<a href="https://bitbucket.org/Lawouach/cherrypy-recipes/src/tip/deployment/container/webapp_with_load_balancing/load_balancing/haproxy.cfg?at=default" target="_blank"> haproxy.cfg configuration</a>. More precisely to those two lines:</p>

		<div id="crayon-56d5a0db69a6a192139223" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5a0db69a6a192139223-1"><span class="crayon-e">server</span><span class="crayon-h"> </span><span class="crayon-e">notes1</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">{</span><span class="crayon-v">N1_PORT_8080_TCP_ADDR</span><span class="crayon-sy">}</span><span class="crayon-o">:</span><span class="crayon-sy">$</span><span class="crayon-sy">{</span><span class="crayon-v">N1_PORT_8080_TCP_PORT</span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-e">check</span><span class="crayon-h"> </span><span class="crayon-e">inter</span><span class="crayon-h"> </span><span class="crayon-cn">4000</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5a0db69a6a192139223-2"><span class="crayon-e">server</span><span class="crayon-h"> </span><span class="crayon-e">notes2</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">{</span><span class="crayon-v">N2_PORT_8080_TCP_ADDR</span><span class="crayon-sy">}</span><span class="crayon-o">:</span><span class="crayon-sy">$</span><span class="crayon-sy">{</span><span class="crayon-v">N2_PORT_8080_TCP_PORT</span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-e">check </span><span class="crayon-i">inter</span><span class="crayon-h"> </span><span class="crayon-cn">4000</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>We load-balance between our two backend servers and we do not have to know their address at the time when we build the image, but only when the container is started.</p>
<p>That’s about it really. At this stage, you ought to connect to http://localhost:8091/ to see use your application. Each request will be sent to each web application’s instances in turn. You may check the status of your load-balancing by connecting to http://localhost:8090/.</p>
<p>Obviously, this just a basic example. For instance, you could extend it by setting another service to manage your syslog and configure haproxy to send its log to it.</p>
<p>Next time, we will be exploring the world of CoreOS and clustering before moving on to service and resource management via Kubernetes and MesOS.</p>


                
                                <hr/>
            
			

	 	

                

            </article>

    
</div></body></html>