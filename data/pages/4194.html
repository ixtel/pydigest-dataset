<html><body><div><div class="post-body">
          
      <p><img src="https://s3.amazonaws.com/f.cl.ly/items/00450o1J3n2o2a1X1Y1v/out4.gif" alt="godebug screen capture"/></p>

<p>We use Go for a lot of our server development here at Mailgun, and it’s great. Coming from Python, though, there is one thing I really missed:</p>

<pre><code>import pdb; pdb.set_trace()
</code></pre>

<p>I could insert this little line whenever I was confused about what was happening in the code and see exactly what was going on. But in Go? Not so much. When I started this project in January, gdb failed on every program I tried it on. delve didn’t work on OS X, and print-statement-debugging was too slow and limited. What's a developer to do?</p>

<p>Make my own debugger, of course.</p>

<h2 id="godebug">godebug</h2>

<blockquote>
  <p>All that stands in the way [of a good Go debugger] is the writing of a lot of non-portable low-level code talking to buggy undocumented interfaces.
  <br/> <br/>
  - Rob Pike</p>
</blockquote>

<p><a href="https://github.com/mailgun/godebug">godebug</a> is a different kind of debugger. Traditional debuggers for compiled languages use low-level system calls and read binary files for debugging symbols. They’re hard to get right and they’re hard to port.</p>

<p>godebug takes a different approach: take the source code of a target program, insert debugging code between every line, then compile and run that instead. The result is a fully-functional debugger that is extremely portable. In fact, thanks to <a href="http://www.gopherjs.org/">gopherjs</a>, you can run it right here in your browser!</p>



<p>You can edit the program and relaunch it with the "DEBUG IT!" button as many times as you like. </p>

<h2 id="howdidthatwork">How did that work?</h2>

<p>Here's a quick diagram of the above demo:</p>

<p><img src="http://cl.ly/35000g2q0s1Z/download/godebug-diagram.svg" alt="diagram"/></p>

<p>The original code gets transformed twice. First godebug inserted debugging instrumentation. Then gopherjs compiled the result to javascript.</p>

<p>Let's take a look at the instrumentation step. (To learn more about the gopherjs part (which is awesome) checkout its <a href="http://www.gopherjs.org/">website</a>.) Here are some of the calls that godebug inserts: </p>

<ul>
<li><p><code>godebug.EnterFunc</code> lets the godebug runtime library know that we are entering a function. Since "next" doesn't stop inside function calls, the runtime library takes note of these calls so it knows when to skip over lines.</p></li>
<li><p><code>godebug.ExitFunc</code> lets the runtime library know we are leaving a function. Omitted in <code>main</code>.</p></li>
<li><p><code>godebug.Line</code> causes the program to pause and wait for input if and only if a user command or a breakpoint told it to. When it pauses, it prompts the user for input and responds to any commands.</p></li>
<li><p><code>godebug.Declare</code> records the mapping of variable names to their values. This mapping is used by the print command.</p></li>
</ul>

<p>This is an abridged overview. There are other functions that godebug inserts and many details of the above functions have been omitted. But these are the basic pieces of how godebug works.</p>

<h2 id="usinggodebug">Using godebug</h2>

<p>All of the above (minus the server &amp; javascript stuff) is packaged into the <code>godebug</code> command line tool. Here's how to use it:</p>

<h3 id="step1installit">Step 1. Install it</h3>

<pre><code>$ go get -u github.com/mailgun/godebug
</code></pre>

<h3 id="step2setbreakpoints">Step 2. Set breakpoints</h3>

<p>Add this marker anywhere you want a breakpoint: </p>

<pre><code>_ = "breakpoint"
</code></pre>

<p>This statement becomes a breakpoint when running under godebug and is a no-op otherwise.</p>

<p>Since breakpoints are part of the source code, you can wrap your own logic around them. Let's say you are running a <a href="http://dave.cheney.net/2013/06/09/writing-table-driven-tests-in-go">table driven test</a> with dozens of cases, and one of the test cases fails: the one that tested the input <code>"weird string"</code>. You can add this breakpoint to your test:</p>

<pre><code>for _, tt := range myTestCases {  
    if tt.in == "weird string" {
        _ = "breakpoint"
    }
    ...
}
</code></pre>

<p><code>godebug test</code> will pause the program at the marker statement, which is conveniently positioned just before the failing test case runs.</p>

<h3 id="step3runyourprogram">Step 3. Run your program</h3>

<p>Use the godebug run command:</p>

<pre><code>godebug run &lt;gofiles...&gt;
</code></pre>

<p>Or, for tests, use the godebug test command:</p>

<pre><code>godebug test
</code></pre>

<p>By default, godebug will only add debugging instrumentation to package main (for godebug run) or the package under test (for godebug test). It will not instrument any imported packages. This is to decrease the overhead of the debugger -- any packages you are not interested in will run as normal, at full speed.</p>

<p>This means that <strong>by default you can not step into function calls from imported packages</strong>. But sometimes you will need to do that! To debug other packages, pass the <code>-instrument</code> flag to <code>godebug run</code> or <code>godebug test</code>:</p>

<pre><code>godebug test -instrument=pkgA,pkgB,pkgC pkg/under/test
</code></pre>

<p>The above command will instrument (and thus allow you to step into) <code>pkgA</code>, <code>pkgB</code>, <code>pkgC</code>, and <code>pkg/under/test</code>. It will then build and run the tests for <code>pkg/under/test</code>. Similar semantics apply for <code>godebug run</code>.</p>

<h2 id="tryitout">Try it out!</h2>

<p>Next time you want to understand what is happening in a Go program, try <a href="https://github.com/mailgun/godebug">godebug</a>. Keep in mind that it is still a new tool that needs some polish. In particular, some known limitations are:</p>

<ul>
<li>performance overhead</li>
<li>may cause read conflicts if your program reads from stdin</li>
<li>can’t attach to a running process</li>
<li>must know the packages you want to debug before starting the session</li>
</ul>

<p>That said, I'm excited about this tool and hope it can provide a lot of value to the Go community. Try it out and let me know what you think! If you have any problems I would be happy to hear about them. File an issue at <a href="https://github.com/mailgun/godebug/issues">https://github.com/mailgun/godebug/issues</a> or send an email to: </p>

<p><img src="https://s3.amazonaws.com/f.cl.ly/items/3a0f0j081R2E1i0i1f1N/dev.png" alt="contact"/></p>

<p>Hope you enjoy it!</p>

<p><a href="https://github.com/mailgun/godebug">https://github.com/mailgun/godebug</a></p>

<hr/>

<p><small><em>Want to learn more about godebug? Here is a talk I gave at GoSF, including more depth on code generation and concurrency management:</em></small></p>

<iframe src="https://www.youtube.com/embed/qo4RAPxCTa0" frameborder="0" allowfullscreen="">VIDEO</iframe>
          

          

          <div class="post-author">
            <a href=""><img src="http://www.mailgun.com/static/img/team/jeremy.jpg" alt="Jeremy Schlatter" class="author-avatar"/></a>
            <h3>Jeremy Schlatter</h3>
            <p/>
          </div>
        </div> 

        </div></body></html>