<html><body><div><div class="content html_format">
      <img src="http://habrastorage.org/getpro/habr/comment_images/61e/de0/326/61ede032691ef46e25cab19587aa682b.png" alt="image"/> <img src="https://habrastorage.org/getpro/habr/post_images/a22/122/644/a221226446afedd055b333e560e6474f.png" alt="image"/> <img src="https://habrastorage.org/getpro/habr/post_images/fed/8fb/6d0/fed8fb6d091b7ea35ff82ae956cf2f3e.png" alt="image"/><p>
Давно уже до пятой версии обновился Qt и вместе с ним PyQt, но найти информацию по ним в русскоязычном сегменте — задача не из простых. Под катом подробный туториал для тех, кто только начинает знакомиться со связкой Qt + python3.
</p><p>
Цель: собрать и настроить окружение, пройти путь от установки PyQt5 и создания формы в Qt Designer до запуска переносимого бинарника под Windows (да, всё верно, разрабатываем под Mint, собираем для linux и windows).

</p><a name="habracut"/>

<h2>Пути установки</h2><p>
Исходя из того, что мы — совсем новички, я постараюсь использовать пути в системе, которые используются по-умолчанию, или которые мы создадим исходя из следующей логики размещения:
</p><ul>
<li>Все необходимые файлы и папки хранятся в директории dev в домашней директории пользователя, т.е. <i>~/dev/</i></li>
<li>Мы будем использовать виртуальные окружения для питона, и хранить их будем в директории envs, т.е. <i>~/dev/envs/</i></li>
<li>Наши проекты будут храниться в директории src, т.е. <i>~/dev/src/</i></li>
</ul><p>
Если у вас уже сложилась собственная иерархия размещения файлов, то придётся скорректировать пути в командах, приведённых ниже.

</p><h2>Настройка окружения</h2><p>
Создаём структуру директорий. Откройте консоль и выполните:
</p><pre><code class="bash">cd ~
mkdir -p dev/envs dev/src
cd dev/envs
</code></pre><p>
Ставим пакет, который потребуется нам для сборки в будущем:
</p><pre><code class="bash">sudo apt-get install python3-dev
</code></pre><p>
Ставим pip и virtualenv:
</p><pre><code class="bash">wget https://bootstrap.pypa.io/get-pip.py
sudo python3 get-pip.py
rm get-pip.py
sudo pip install virtualenv
</code></pre><p>
Создаём виртуальное окружение, активируем его и обновляем пакеты:
</p><pre><code class="bash">virtualenv --prompt="[pyqt5] " pyqt5
source pyqt5/bin/activate
pip install -U pip setuptools
</code></pre><p>
Ставим Qt5. При выборе пути установки я оставил «по-умолчанию» </p><i>~/Qt</i><p>. Если Вы выберите другой, то необходимо менять пути в командах ниже:
</p><pre><code class="bash"># Для x64-архитектуры
# http://www.qt.io/download-open-source/#section-2
wget http://download.qt-project.org/official_releases/online_installers/qt-opensource-linux-x64-online.run
chmod u+x qt-opensource-linux-x64-online.run
./qt-opensource-linux-x64-online.run
rm qt-opensource-linux-x64-online.run

# Для x86-архитектуры
# http://www.qt.io/download-open-source/#section-2
# wget http://download.qt-project.org/official_releases/online_installers/qt-opensource-linux-x86-online.run
# chmod u+x qt-opensource-linux-x86-online.run
# ./qt-opensource-linux-x86-online.run
# rm qt-opensource-linux-x86-online.run
</code></pre><p>
Ставим SIP — модуль, необходимый для работы PyQt:
</p><pre><code class="bash"># http://www.riverbankcomputing.com/software/sip/download
wget http://sourceforge.net/projects/pyqt/files/sip/sip-4.16.5/sip-4.16.5.tar.gz
tar xvzf sip-4.16.5.tar.gz
cd sip-4.16.5/
python configure.py -d ~/dev/envs/pyqt5/lib/python3.4/site-packages/
make
sudo make install
sudo make clean
cd ..
rm -rf sip*
</code></pre><p>
Ставим PyQt:
</p><pre><code class="bash">wget http://sourceforge.net/projects/pyqt/files/PyQt5/PyQt-5.4/PyQt-gpl-5.4.tar.gz
tar xvzf PyQt-gpl-5.4.tar.gz
cd PyQt-gpl-5.4/
# У меня под рукой только x64-архитектура, поэтому моя команда выглядит именно так.
# Если же у вас x86, то путь ~/Qt/5.4/gcc_64/bin/qmake будет выглядеть иначе.
# Буду признателен, если в комментариях подскажут, как именно
python configure.py --destdir ~/dev/envs/pyqt5/lib/python3.4/site-packages/ --qmake ~/Qt/5.4/gcc_64/bin/qmake
make
sudo make install
sudo make clean
cd ..
rm -rf PyQt*
</code></pre><p>
На этом всё. Окружение установлено и готово к работе. Для проверки выполните команду:
</p><pre><code class="bash">python -c "from PyQt5.QtCore import QT_VERSION_STR;from PyQt5.Qt import PYQT_VERSION_STR;from sip import SIP_VERSION_STR;print('Qt version: ',QT_VERSION_STR);print('SIP version: ',SIP_VERSION_STR);print('PyQt version: ',PYQT_VERSION_STR)"
</code></pre><p>
Ответ должен выглядеть следующим образом:
</p><pre><code class="bash">Qt version:  5.4.0
SIP version:  4.16.5
PyQt version:  5.4
</code></pre><p>
Для проверки, что всё действительно установилось в виртуальное окружение, откройте новое окно терминала и повторите команду проверки:
</p><p>
В ответ должна появиться ошибка ImportError. Новое окно терминала после этого можно закрыть.

</p><h2>Создание приложения</h2><p>
Перейдём в директорию с нашими исходниками и создадим директорию проекта:
</p><pre><code class="bash">cd ../src/
mkdir pyqt_test
cd pyqt_test/
</code></pre><p>
Далее нам потребуется Qt Designer. Если Вы не меняли пусть установки Qt, то запустить его можно командой:
</p><pre><code class="bash"># И вновь эта команда будет работать только для x64-архитектуры.
# Для x86 вместо gcc_64 вероятнее всего будет иная директория.
~/Qt/5.4/gcc_64/bin/designer
</code></pre><p>
Вот так выглядит запущенный Qt Designer на моей системе:
</p><img src="https://habrastorage.org/files/78f/5a9/2b9/78f5a92b953743439f7cb6f79216dd15.png"/><p>
В данном руководстве я не буду подробно останавливаться на описании интерфейса дизайнера, мы пройдём простейший путь до минимальной готовой формы. Если Вам необходима более подробная информация — Google It!
</p><p>
В диалоговом окне выбираем «Widget» (последний пункт в списке «templates/forms») и нажимаем кнопку «Создать». Откроется форма редактирования виджета:
</p><img src="https://habrastorage.org/files/724/e2e/1ea/724e2e1ea23f4cc1bb66cbe50a50667a.png"/>
<p>
Перетащите на форму кнопку из меню слева и сохраните полученную форму с именем test.ui в директорию </p><i>~/dev/src/pyqt_test/</i><p>:
</p><img src="https://habrastorage.org/files/9cf/f5a/1fd/9cff5a1fdd7042ee8f3643e9bcfc3e65.png"/>
<b>Tips&amp;Tricks:</b><p> Нажав [Crtl + R] Вы можете запустить свою форму и «потрогать» её в режиме реального времени.
</p><p>
Конвертируем файл интерфейса из XML формы в понятную python форму:
</p><pre><code class="bash">pyuic5 test.ui &gt; test_ui.py
</code></pre><p>
Я не хочу редактировать что-либо в файле, созданном конвертером PyQt, поэтому наши слоты мы опишем в отдельном файле. Создайте файл test_slots.py и откройте его в любимом Вами редакторе. Наполнение файла должно выглядеть примерно так:
</p><pre><code class="python">"""
Пользовательские слоты для виджетов.
"""
# Импортируем модуль времени
from datetime import datetime
# Импортируем класс интерфейса из созданного конвертером модуля 
from test_ui import Ui_Form


# Создаём собственный класс, наследуясь от автоматически сгенерированного
class MainWindowSlots(Ui_Form):
    
    # Определяем пользовательский слот
    def set_time(self):
        # Получаем текущую метку времени в формате 'Ч:М:С'
        str_time = datetime.now().strftime('%H:%M:%S')
        # Присваиваем надписи на кнопке метку времени
        self.pushButton.setText(str_time)
        return None

</code></pre><p>
Затем, создайте ещё один файл с именем main.py, в котором мы опишем основную логику:
</p><pre><code class="python">"""
Основной скрипт программы.
Запускает конфигуратор окна, подключает слоты и отображает окно.
"""
# Импортируем системый модуль для корректного закрытия программы
import sys
# Импортируем минимальный набор виджетов
from PyQt5.QtWidgets import QApplication, QWidget
# Импортируем созданный нами класс со слотами
from test_slots import MainWindowSlots


# Создаём ещё один класс, наследуясь от класса со слотами
class MainWindow(MainWindowSlots):

    # При инициализации класса нам необходимо выпонить некоторые операции
    def __init__(self, form):
        # Сконфигурировать интерфейс методом из базового класса Ui_Form
        self.setupUi(form)
        # Подключить созданные нами слоты к виджетам
        self.connect_slots()

    # Подключаем слоты к виджетам
    def connect_slots(self):
        self.pushButton.clicked.connect(self.set_time)
        return None

if __name__ == '__main__':
    # Создаём экземпляр приложения
    app = QApplication(sys.argv)
    # Создаём базовое окно, в котором будет отображаться наш UI
    window = QWidget()
    # Создаём экземпляр нашего UI
    ui = MainWindow(window)
    # Отображаем окно
    window.show()
    # Обрабатываем нажатие на кнопку окна "Закрыть"
    sys.exit(app.exec_())
</code></pre><p>
На этом наше приложение завершено. Выполнив из консоли
</p><pre><code class="bash">python main.py
</code></pre><p>
мы должны увидеть форму с кнопкой посередине, нажатие на которую меняет название кнопки на системную дату.
</p><img src="https://habrastorage.org/files/816/ca6/d5d/816ca6d5da324e8a82cfd6c72f5db4b4.png"/>
<a name="build"/>
<h2>Упаковка в исполняемый файл для Linux</h2><p>
Упаковщик потребует некоторой магии при установке.</p><p>
Скачиваем пакет, не устанавливая его и распаковываем:
</p><pre><code class="bash">cd ../../envs/pyqt/
pip install -d . cx_freeze
tar xvfz cx_Freeze-4.3.4.tar.gz
</code></pre><p>
Открываем любимым редактором файл cx_Freeze-4.3.4/setup.py. Я использую SublimeText:
</p><pre><code class="bash">subl cx_Freeze-4.3.4/setup.py
</code></pre><p>
Правим строку №84, чтобы она выглядела, как на картинке:
</p><img src="https://habrastorage.org/files/b06/557/93e/b0655793e7f649c684e3b6ddba34c152.png"/>
<b>Tips&amp;Tricks:</b><p> А вы знали, что если запустить SublimeText из виртуального окружения, то интерпретатором по-умолчанию будет из виртуального окружения?
</p><p>
Сохраняем изменения, закрываем редактор, устанавливаем пакет, возвращаемся в папку с исходниками, запускаем упаковку:
</p><pre><code class="bash">cd cx_Freeze-4.3.4
python setup.py install
rm ../cx_Freeze-4.3.4.tar.gz
cd ../../../src/pyqt_test
cxfreeze main.py --target-dir=nix_build
</code></pre><p>
После этого в директории с исходниками появится директория dist, в которой среди множества файлов можно заметить файл без расширения main — это и есть наш бинарник, готовый для запуска и переноски. Откровенно говоря, немного расстраивает размер дистрибьютива: на моей машине это — 70,1 Мб, но не стоит забывать, что туда упакованы: python, PyQt, Qt и некоторые общесистемные библиотеки. Сборочный скрипт cxfreeze достаточно гибко конфигурируется, но подбор оптимальных параметров я оставлю на совести читателя. Скажу только, что счастье кроется в сжатии, оптимизации и ручном ограничении зависимостей.

</p><h2>Упаковка в исполняемый файл для Windows</h2><p>
К сожалению, чуда не будет. Мне не известен способ собрать exe напрямую из-под Linux-системы. Поэтому, придётся потанцевать с wine.</p><p>
Закрываем открытый в самом начале терминал:
</p><pre><code class="bash">deactivate
exit
</code></pre><p>
Открываем новый, ставим последнюю версию wine:
</p><pre><code class="bash">cd dev
sudo add-apt-repository ppa:ubuntu-wine/ppa
sudo apt-get update
sudo apt-get install wine1.7
</code></pre><p>
После этого скачиваем windows-версии уже знакомых нам пакетов и запускаем установку из-под wine:
</p><pre><code class="bash"># https://www.python.org/downloads/windows/
wget https://www.python.org/ftp/python/3.4.2/python-3.4.2.msi
wine msiexec /i python-3.4.2.msi
rm python-3.4.2.msi
# http://www.riverbankcomputing.com/software/pyqt/download5
wget http://sourceforge.net/projects/pyqt/files/PyQt5/PyQt-5.4/PyQt5-5.4-gpl-Py3.4-Qt5.4.0-x32.exe
wine PyQt5-5.4-gpl-Py3.4-Qt5.4.0-x32.exe
rm PyQt5-5.4-gpl-Py3.4-Qt5.4.0-x32.exe
# http://sourceforge.net/projects/cx-freeze/files/
wget http://downloads.sourceforge.net/project/cx-freeze/4.3.3/cx_Freeze-4.3.3.win32-py3.4.msi
wine msiexec /i cx_Freeze-4.3.3.win32-py3.4.msi
rm cx_Freeze-4.3.3.win32-py3.4.msi
</code></pre><p>
А дальше немного магии. Идём по ссылке:
</p><pre><code class="html">http://www.lfd.uci.edu/~gohlke/pythonlibs/#cx_freeze
</code></pre><p>
Качаем актуальную версию cx_Freeze для нашего интерпретатора и ставим поверх официальной:
</p><pre><code class="bash">wine cx_Freeze-4.3.4.win32-py3.4.exe
rm cx_Freeze-4.3.4.win32-py3.4.exe
</code></pre><p>
После этого остаётся проверить работоспособность. Переходим в каталог с исходником, открываем терминал wine, выполняем уже знакомую команду сборки:
</p><pre><code class="bash">cd src/pyqt_test
wine cmd
cxfreeze main.py --target-dir=win_build
</code></pre><p>
Оказалось, что у меня в распоряжении нет windows-машины, поэтому смог протестировать результат только под wine. Выходим из терминала wine (команда exit), закрываем терминал. Идём раздавать нашу программу всем желающим.
</p><p>
P.S.: Все исходники </p><a href="https://github.com/zaharsk/pyqt_test">на GitHub`е</a>

      
      <p class="clear"/>
    </div>

    
  </div></body></html>