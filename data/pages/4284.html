<html><body><div><div class="content html_format">
      <img src="https://habrastorage.org/getpro/habr/post_images/1e9/487/009/1e948700995555f0c7512350c77ab485.jpg" alt="tux in egg in python"/>
<p>
Hello, {{username}}
</p><p>
Я DevOps и очень люблю Linux. Понятное дело, что с такой связкой я просто не мог не полюбить LinuX Containers (тем более, что BSD и Solaris давно радуют аналогичными возможностями своих пользователей).
</p><p>
Естественно, бизнес тоже увидел привлекательную возможность и программы для управления контейнерами стали расти и множиться: </p><a href="https://github.com/docker/docker">docker </a><p>, </p><a href="https://github.com/coreos/rkt">rocket</a><p>, </p><a href="https://github.com/tailhook/vagga">vagga</a><p>, </p><a href="https://linuxcontainers.org">lxc</a><p>, </p><a href="https://wiki.archlinux.org/index.php/Systemd-nspawn">systemd-nspawn</a><p>, etc…
</p><p>
Docker стал стандартом де-факто в первую очередь благодаря системе создания и доставки контента. Но главный демон докера запускается от root, и, на мой взгляд, это минус этого проекта (</p><a href="https://fosterelli.co/privilege-escalation-via-docker.html">Пруф</a><p>).
</p><p>
Rocket и vagga пошли другим путем, и путь этот носит название unprivileged containers. Вам больше не нужны root привилегии, чтобы запустить процесс в новых namespaces, и это открывает интересные перспективы для построения тестовых площадок и безопасного окружения.
</p><p>
Но во всех этих проектах есть один фатальный недостаток: они все написаны с использованием c, go и rust, а я люблю python и не могу поучаствовать в их разработке. Согласитесь, довольно обидно пропускать все веселье.
</p><p>
Так что под катом вас ждет библиотека для запуска процессов в новых </p><a href="http://man7.org/linux/man-pages/man7/user_namespaces.7.html">linux user namespaces</a><p>:
</p><a name="habracut"/>

<i>Детка, Ты просто космос</i>

<h5><b>Goals</b></h5><p>
Сейчас нет удобного способа работать с linux namespaces из python:
</p><ul>
<li>можно использовать <a href="https://pypi.python.org/pypi/asylum/0.4.1">asylum</a> — проект выглядит мертвым и хостится непонятно где </li>
<li>или можно попробовать <a href="https://pypi.python.org/pypi/libvirt-python/1.2.13">python-libvirt</a> биндинги с большим уровнем абстракции </li>
<li>использовать код на c, как это делают vagga и lxc</li>
<li>или дергать glibc вызовы с помощью ctypes</li>
<li>в противном случае остается subprocess.Popen</li>
</ul><p>
Я хочу изменить это: я хочу создать native python bindings к билбиотеке glibc с интерфейсом как в multiprocessing.Process. И еще немножко целей:
</p><ul>
<li>популяризировать linux</li>
<li>популяризировать python</li>
<li>поучаствовать в создании популярного open source проекта</li>
<li>прославиться</li>
<li>популярность и девушки будут приятным бонусом</li>
</ul><p>
ЗЫ: так же посмотрите на </p><a href="https://github.com/zalando/python-nsenter">python-nsenter</a><p> — выглядит здорово!

</p><h5><b>Example</b></h5>
<pre><code class="python">import os
from pyspaces import Container


def execute(argv):
    os.execvp(argv[0], argv)

cmd = "mount -t proc proc /proc; ps ax"
c = Container(target=execute, args=(('bash', '-c', cmd),),
              uid_map='0 1000 1',
              newpid=True, newuser=True, newns=True
              )
c.start()
print("PID of child created by clone() is %ld\n" % c.pid)
c.join()
print("Child returned: pid %s, status %s" % (c.pid, c.exitcode))
</code></pre>
<pre><code class="bash">PID of child created by clone() is 15978

PID TTY      STAT   TIME COMMAND
1   pts/19   S+     0:00 bash -c mount -t proc proc /proc; ps ax
3   pts/19   R+     0:00 ps ax

Child returned: pid 15978, status 0
</code></pre>
<h5><b>CLI</b></h5>
<pre><code class="bash">space -v execute --pid --fs --user --uid '0 1000 1' bash -c 'mount -t proc /proc; ps ax'
space chroot --pid --uid '0 1000 1' ~/.local/share/lxc/ubuntu/rootfs/ /bin/ls /home/
</code></pre>
<h5><b>TODO</b></h5>
<ol>
<li> [x] clone &amp; Container</li>
<li> [x] CLI</li>
<li> [x] Chroot</li>
<li> [ ] process list</li>
<li> [ ] inject</li>
<li> [ ] move CLI to separate package</li>
<li> [ ] addons</li>
<li> [ ] support for lxc, vagga, rocket, docker, etc...</li>
<li> [ ] ...</li>
<li> [ ] one tool for rule them all!!1</li>
</ol>
<h5><b>Links</b></h5>
<a href="https://github.com/Friz-zy/pyspaces"><img src="https://habrastorage.org/getpro/habr/post_images/63a/010/b5e/63a010b5e29ee3678e4e2a257f8fdeb9.png" alt="github"/></a> <a href="https://pypi.python.org/pypi/pyspaces/"><img src="https://pypip.in/download/pyspaces/badge.svg" alt="pypi"/></a> <a href="https://pyspaces.readthedocs.org/en/latest/"><img src="https://readthedocs.org/projects/pyspaces/badge/" alt="docs"/></a>
<p>
Лицензия — MIT, но так же собираюсь добавить BSD и Apache 2.0

</p><h5><b>It's not the end</b></h5><p>
Работы предстоит очень много: нужны нормальные тесты, документация, новые фичи и приятное cli. Откладывание анонса в долгий ящик прервали ребята из </p><a href="https://ru-ru.facebook.com/MinskPythonMeetup">Minsk Python Meetup</a><p>, за что им большое спасибо. Теперь я надеюсь на поддержку и интерес у сообщества ;)
</p><p>
И в завершение хотелось бы привести цитату создателя scipy &amp; numpy:
</p><blockquote>Keys to success: Hard work — specially up front<br/>
Often lonely — initially nobody believes in your idea more than you do. Others need some 'proof' before they join you.<br/>
The more complicated what you are doing is the lonelier it will be initially.<br/>
<br/>
I spent 18 months not publishing papers to write NumPy<br/>
(despite many people telling me it was foolish)<br/>
<a href="https://youtu.be/oXRvpBJ-Dkc?t=967">Travis Oliphant</a><br/>
</blockquote><p>
ЗЫ: в живую со мной можно пообщаться по теме и не только на очередном </p><a href="https://ru-ru.facebook.com/MinskPythonMeetup">Minsk Python Meetup</a>

      
      <p class="clear"/>
    </div>

    
  </div></body></html>