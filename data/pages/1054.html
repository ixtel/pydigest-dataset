<html><body><div><div class="post">
<p><img src="http://theasder.github.io/img/8387270418a6.png" class="img-responsive"/><br/></p>

<p>Для всех нетерпеливых есть <a href="https://gist.github.com/theasder/73c3f0a9270ebe611a80">ссылка</a> на скрипт. UPD: была предложена версия для Python 3, вот <a href="http://pastebin.com/Px81WfEe">ссылка</a>. Чтобы его запустить требуется интерпретатор языка Python 3, и нужно написать в консоли <code class="highlighter-rouge">python3 название_скрипта.py</code></p>

<p>Для запуска нужен интерпретатор языка Python 2, в консоли нужно ввести <code class="highlighter-rouge">python название_скрипта.py</code>. Чтобы скачать прикрепленную музыку из конкретного поста, достаточно ввести два последних числа из него, разделенные знаком _ . Например, мы хотим скачать музыку от сюда: <a href="http://vk.com/wall-35193970_951">http://vk.com/wall-35193970_951</a>. Достаточно ввести <code class="highlighter-rouge">-35193970_951</code>.</p>

<h2 id="api">Работа с API</h2>
<p>API ВКонтакте предоставляет достаточно много методов, достаточно лишь посмотреть в <a href="http://vk.com/dev/methods">документацию</a>. Мы будем в данном случае пользоваться методом <code class="highlighter-rouge">wall.getById</code>, предоставляющий нам полную информацию о записи с заданным адресом.</p>

<p>Как этим пользоваться? Чтобы получить то, что выведет данный метод нам нужно посмотреть в аргументы и присвоить им значения: в первом аргументе <code class="highlighter-rouge">post</code> мы должны присвоить адрес поста, аргументу <code class="highlighter-rouge">extended</code> присвоим 1, <code class="highlighter-rouge">copy_history_depth</code> присвоим 2. Нам два последних аргумента не так важны, оставим их такими, какие они в примере на странице <a href="http://vk.com/dev/wall.getById">документации</a>. Теперь мы должны оформить ссылку с данным методом, его аргументами и переданными значениями. Она будет выглядеть так: https://api.vk.com/method/<strong>wall.getById</strong>?<strong>posts</strong>=_адрес_поста_ &amp;<strong>extended</strong>=1&amp;<strong>copy_history_depth</strong>=2</p>

<h2 id="section">Обрабатываем запрос</h2>

<p>Напомним, что адресом поста будет два последних числа из ссылки на него (например, <code class="highlighter-rouge">-35193970_951</code>). У нас есть функция <code class="highlighter-rouge">urlopen</code> библиотеки <code class="highlighter-rouge">urllib2</code>, позволяющая скачать все содержание страницы, а также метод <code class="highlighter-rouge">read</code>, позволяющий записать все содержание в одну переменную:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre><span class="c"># !/usr/bin/python</span>
<span class="c">#  -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">urllib2</span>
<span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">re</span>
 
<span class="k">def</span> <span class="nf">get_items_of_post</span><span class="p">(</span><span class="n">address</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s">"https://api.vk.com/method/wall.getById?posts="</span> <span class="o">+</span> <span class="n">address</span> <span class="o">+</span> <span class="s">"&amp;extended=1&amp;copy_history_depth=2"</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Итак, в переменной <code class="highlighter-rouge">text</code> у нас записано содержание вывода метода <code class="highlighter-rouge">wall.getById</code> в виде строки(ее можно увидеть на <a href="http://vk.com/dev/wall.getById">странице метода в документации</a>). Со строкой работать неудобно, её можно преобразовать в словарь с помощью функции <code class="highlighter-rouge">literal_eval</code> библиотеки <code class="highlighter-rouge">ast</code>. Пишем:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table><tbody><tr><td class="gutter gl"><pre class="lineno">1</pre></td><td class="code"><pre><span class="n">post_info</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Функция будет вовращать массив с всеми прикрепленными файлами в записи. Если записи не существует, то пустой массив:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre><span class="k">if</span> <span class="n">post_info</span><span class="p">[</span><span class="s">'response'</span><span class="p">][</span><span class="s">'wall'</span><span class="p">]</span> <span class="o">==</span> <span class="p">[]:</span>
    <span class="k">return</span> <span class="p">[]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">post_info</span><span class="p">[</span><span class="s">'response'</span><span class="p">][</span><span class="s">'wall'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">'attachments'</span><span class="p">]</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Дальше пишем то, что будем выполняться программой при ее запуске:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table><tbody><tr><td class="gutter gl"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="n">address</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">"Enter string of two right numbers of url of post</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span> <span class="c">#  ввод адреса</span>
<span class="n">music</span> <span class="o">=</span> <span class="n">get_items_of_post</span><span class="p">(</span><span class="n">address</span><span class="p">)</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Дальше мы должны просмотреть каждый из прикреплений к записи и, если это аудиозапись, мы должны обработать ссылку на нее, скачать содержимое файла и записать его в новый файл, который будет находиться там же, где и программа.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18</pre></td><td class="code"><pre><span class="k">for</span> <span class="n">attachment</span> <span class="ow">in</span> <span class="n">music</span><span class="p">:</span>
	<span class="n">type_of_attachment</span> <span class="o">=</span> <span class="n">attachment</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span>
	<span class="k">if</span> <span class="n">type_of_attachment</span> <span class="o">!=</span> <span class="s">'audio'</span><span class="p">:</span>
		<span class="k">pass</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">artist</span> <span class="o">=</span> <span class="n">attachment</span><span class="p">[</span><span class="n">type_of_attachment</span><span class="p">][</span><span class="s">'artist'</span><span class="p">]</span>
		<span class="n">title</span> <span class="o">=</span> <span class="n">attachment</span><span class="p">[</span><span class="n">type_of_attachment</span><span class="p">][</span><span class="s">'title'</span><span class="p">]</span>
		<span class="n">name_of_file</span> <span class="o">=</span> <span class="n">artist</span> <span class="o">+</span> <span class="s">' - '</span> <span class="o">+</span> <span class="n">title</span> <span class="o">+</span> <span class="s">'.mp3'</span>
		<span class="n">url</span> <span class="o">=</span> <span class="n">attachment</span><span class="p">[</span><span class="n">type_of_attachment</span><span class="p">][</span><span class="s">'url'</span><span class="p">]</span>
		<span class="k">if</span> <span class="n">url</span> <span class="o">==</span> <span class="s">''</span><span class="p">:</span> <span class="c">#  предусмотрен случай, когда аудиозапись удалена из общего доступа</span>
			<span class="k">print</span> <span class="n">name_of_file</span> <span class="o">+</span> <span class="s">" was removed from public access"</span>
			<span class="k">continue</span>
		<span class="n">url</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">'</span><span class="se">\\\\</span><span class="err">\</span><span class="s">/'</span><span class="p">,</span> <span class="s">'/'</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span> <span class="c">#  вместо простых слэшей изначально записываются `\\/`, поэтому нужно их заменить на просто слэши во всей строке</span>
		<span class="n">url</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">'</span><span class="err">\</span><span class="s">?.*'</span><span class="p">,</span> <span class="s">''</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span> <span class="c">#  убираем все символы после расширения `.mp3`, они нам не нужны</span>
		<span class="n">response</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
		<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">name_of_file</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span>
		<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
		<span class="k">print</span> <span class="n">name_of_file</span> <span class="o">+</span> <span class="s">" was downloaded"</span> <span class="c">#  оповещаем о том, что файл успешно скачался</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>


<p class="time"/>
      <h4>Поделиться статьей</h4>
      
      <p class="yashare-auto-init" data-yasharel10n="ru" data-yasharequickservices="vkontakte,facebook,twitter,gplus" data-yasharetheme="counter"/> 


<ins class="adsbygoogle" data-ad-client="ca-pub-6621414197364714" data-ad-slot="2171694982" data-ad-format="auto"/>

    <p id="disqus_thread"/>
    
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

			</div></body></html>