<html><body><div><div class="post-content" itemprop="articleBody">
    <p>This post explains how to add <a href="https://developers.google.com/identity/protocols/OAuth2?hl=en">Google Oauth2</a> login in a <a href="http://flask.pocoo.org/">Flask</a> web app using the <a href="https://github.com/requests/requests-oauthlib">requests-oauthlib</a> package for OAuth 2.0 and <a href="https://pythonhosted.org/Flask-SQLAlchemy/">flask-sqlalchemy</a>.</p>

<p>To get started, first we have to create a project in Google Developers Console to get client key and secret.</p>

<h3 id="creating-a-google-project">Creating a Google project</h3>

<ol>
  <li>
    <p>First go to <a href="https://console.developers.google.com/">Google Developers Console</a>. Sign in using your Google credentials if you havenâ€™t already. There will be a list of projects(if you have previously created any).</p>
  </li>
  <li>
    <p>Click on <strong>Create Project</strong> to create a new project.
<img src="http://i1051.photobucket.com/albums/s432/brijeshb42/ghost-blog/1.png" alt="Project Screen"/></p>
  </li>
  <li>
    <p>Provide a project name in the dialog box and press enter. For explanation purposes, lets say the project name is <strong>test-project-123xyz</strong>. <code>test-project-123xyz</code> will appear in the list of projects after creation.
<img src="http://i1051.photobucket.com/albums/s432/brijeshb42/ghost-blog/2.png" alt="Create New projects"/></p>
  </li>
  <li>
    <p>Now go to the project page. Click <code>APIs and Auth -&gt; Credentials</code> in the sidebar. Then goto the <code>OAuth Consent Screen</code>. Provide the <code>Product Name</code>(you can also provide other details but they are optional). <code>Product Name</code> is what users see when they are logging into your application using Google.
<img src="http://i1051.photobucket.com/albums/s432/brijeshb42/ghost-blog/3.png" alt="Product Name"/></p>
  </li>
  <li>
    <p>Now click on the <code>Credentials</code> part of the same page. Then click on <code>Add Credentials</code> and then select <code>OAuth 2.0 client ID</code>.
<img src="http://i1051.photobucket.com/albums/s432/brijeshb42/ghost-blog/4.png" alt="OAuth Credentials"/></p>
  </li>
  <li>
    <p>Select <code>Application Type</code> as <strong>Web Application</strong>, Provide a <code>Name</code>, <code>Authorized Javascript origins</code> and <code>Authorized redirect URIs</code> and click on <code>Create</code>. During development, we will use <code>localhost</code> as our URL. Later, for production, we can add our original URL. The <code>redirect URIs</code> is important here as this is the URL the users will be redirected to after Google Login. Make sure that all the urls use <code>https</code> protocol as <code>OAuth2</code> supports only <code>https</code>.
<img src="http://i1051.photobucket.com/albums/s432/brijeshb42/ghost-blog/5.png" alt="Create credentials"/></p>
  </li>
  <li>
    <p>After the above step, you will be presented with a dialog box having your <code>client ID</code> and <code>client secret</code>. Copy both the strings and save in a text file as we will be needing these later.
<img src="http://i1051.photobucket.com/albums/s432/brijeshb42/ghost-blog/6.png" alt="Copy credentials"/></p>
  </li>
</ol>

<h3 id="creating-a-user-table-in-database">Creating a User table in Database</h3>

<p>We will be using <a href="https://pythonhosted.org/Flask-SQLAlchemy/">flask-sqlalchemy</a> to handle DB operations.
This is what our <code>User</code> table looks like.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">"users"</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">avatar</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">200</span><span class="p">))</span>
    <span class="n">active</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Text</span><span class="p">)</span>
    <span class="n">created_at</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">())</span></code></pre></div>

<p>The <code>tokens</code> column stores the access and refresh tokens JSON, dumped as string.</p>

<h3 id="creating-configuration-for-our-app">Creating configuration for our app.</h3>

<p>If using <code>flask-login</code> to manage user sessions, we can check whether a user is logged in or not. If not logged in, we redirect the user to a login page that contains the link to Google login.
Lets create a <code>config.py</code> that has our Google OAuth credentials and our app configuration.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">os</span>

<span class="n">basedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">Auth</span><span class="p">:</span>
    <span class="n">CLIENT_ID</span> <span class="o">=</span> <span class="p">(</span><span class="s">'688061596571-3c13n0uho6qe34hjqj2apincmqk86ddj'</span>
                 <span class="s">'.apps.googleusercontent.com'</span><span class="p">)</span>
    <span class="n">CLIENT_SECRET</span> <span class="o">=</span> <span class="s">'JXf7Ic_jfCam1S7lBJalDyPZ'</span>
    <span class="n">REDIRECT_URI</span> <span class="o">=</span> <span class="s">'https://localhost:5000/gCallback'</span>
    <span class="n">AUTH_URI</span> <span class="o">=</span> <span class="s">'https://accounts.google.com/o/oauth2/auth'</span>
    <span class="n">TOKEN_URI</span> <span class="o">=</span> <span class="s">'https://accounts.google.com/o/oauth2/token'</span>
    <span class="n">USER_INFO</span> <span class="o">=</span> <span class="s">'https://www.googleapis.com/userinfo/v2/me'</span>


<span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
    <span class="n">APP_NAME</span> <span class="o">=</span> <span class="s">"Test Google Login"</span>
    <span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">"SECRET_KEY"</span><span class="p">)</span> <span class="ow">or</span> <span class="s">"somethingsecret"</span>


<span class="k">class</span> <span class="nc">DevConfig</span><span class="p">(</span><span class="n">Config</span><span class="p">):</span>
    <span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">SQLALCHEMY_DATABASE_URI</span> <span class="o">=</span> <span class="s">'sqlite:///'</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s">"test.db"</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ProdConfig</span><span class="p">(</span><span class="n">Config</span><span class="p">):</span>
    <span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">SQLALCHEMY_DATABASE_URI</span> <span class="o">=</span> <span class="s">'sqlite:///'</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s">"prod.db"</span><span class="p">)</span>


<span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"dev"</span><span class="p">:</span> <span class="n">DevConfig</span><span class="p">,</span>
    <span class="s">"prod"</span><span class="p">:</span> <span class="n">ProdConfig</span><span class="p">,</span>
    <span class="s">"default"</span><span class="p">:</span> <span class="n">DevConfig</span>
<span class="p">}</span></code></pre></div>

<p>Here,</p>

<ul>
  <li><code>REDIRECT_URI</code> is what we set in Google Developers Console,</li>
  <li><code>AUTH_URI</code> is where the user is taken to for Google login,</li>
  <li><code>TOKEN_URI</code> is used to exchange a temporary token for an <code>access_token</code> and</li>
  <li><code>USER_INFO</code> is the URL used for retrieving user information like <em>name</em>, <em>email</em>, etc after successful authentication.</li>
  <li><code>SCOPE</code> is the types of user information that we will be accessing after the user authenticates our app. <a href="https://developers.google.com/oauthplayground/">Google OAuth2 Playground</a> has a list of scopes that can be added.</li>
</ul>

<h3 id="implementing-the-url-routes-for-login-and-callback">Implementing the URL routes for login and callback</h3>

<p>After the configuration is done, we have to create a <code>Flask</code> app, load configurations and finally define our routes.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s">'dev'</span><span class="p">])</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="n">login_manager</span> <span class="o">=</span> <span class="n">LoginManager</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="n">login_manager</span><span class="o">.</span><span class="n">login_view</span> <span class="o">=</span> <span class="s">"login"</span>
<span class="n">login_manager</span><span class="o">.</span><span class="n">session_protection</span> <span class="o">=</span> <span class="s">"strong"</span></code></pre></div>

<h3 id="requestsoauthliboauth2session-helper"><code>requests_oauthlib.OAuth2Session</code> helper:</h3>
<p>We create a helper function <code>get_google_auth</code> that we will use to create <code>OAuth2Session</code> object based on the arguments provided.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">get_google_auth</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">token</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">OAuth2Session</span><span class="p">(</span><span class="n">Auth</span><span class="o">.</span><span class="n">CLIENT_ID</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">state</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">OAuth2Session</span><span class="p">(</span>
            <span class="n">Auth</span><span class="o">.</span><span class="n">CLIENT_ID</span><span class="p">,</span>
            <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
            <span class="n">redirect_uri</span><span class="o">=</span><span class="n">Auth</span><span class="o">.</span><span class="n">REDIRECT_URI</span><span class="p">)</span>
    <span class="n">oauth</span> <span class="o">=</span> <span class="n">OAuth2Session</span><span class="p">(</span>
        <span class="n">Auth</span><span class="o">.</span><span class="n">CLIENT_ID</span><span class="p">,</span>
        <span class="n">redirect_uri</span><span class="o">=</span><span class="n">Auth</span><span class="o">.</span><span class="n">REDIRECT_URI</span><span class="p">,</span>
        <span class="n">scope</span><span class="o">=</span><span class="n">Auth</span><span class="o">.</span><span class="n">SCOPE</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">oauth</span></code></pre></div>

<ul>
  <li>When none of the parameters are provided, e.g. <code>google = get_google_auth()</code>, it creates a new <code>OAuth2Session</code> with a new state.</li>
  <li>If <code>state</code> is provided, that means we have to get a <code>token</code>.</li>
  <li>If <code>token</code> is provided, that means we only have to get an <code>access_token</code> and this is the final step.</li>
</ul>

<h3 id="root-url">Root URL:</h3>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'index.html'</span><span class="p">)</span></code></pre></div>

<p>This route is only served to logged in user. If a user is not logged in, they are redirected to <code>login</code> route as set previously using <code>login_manager.login_view = "login"</code>.</p>

<h3 id="login-url">Login URL:</h3>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="nd">@app.route</span><span class="p">(</span><span class="s">'/login'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'index'</span><span class="p">))</span>
    <span class="n">google</span> <span class="o">=</span> <span class="n">get_google_auth</span><span class="p">()</span>
    <span class="n">auth_url</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">google</span><span class="o">.</span><span class="n">authorization_url</span><span class="p">(</span>
        <span class="n">Auth</span><span class="o">.</span><span class="n">AUTH_URI</span><span class="p">,</span> <span class="n">access_type</span><span class="o">=</span><span class="s">'offline'</span><span class="p">)</span>
    <span class="n">session</span><span class="p">[</span><span class="s">'oauth_state'</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'login.html'</span><span class="p">,</span> <span class="n">auth_url</span><span class="o">=</span><span class="n">auth_url</span><span class="p">)</span></code></pre></div>

<p>Here we save the value of <code>state</code> in cookie using <code>session['oauth_state'] = state</code> to be used later.</p>

<h3 id="callback-url">Callback URL:</h3>
<p>Here, the route <code>gCallback</code> must be the same as we mentioned in our project page in Google Developers Console.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="nd">@app.route</span><span class="p">(</span><span class="s">'/gCallback'</span><span class="p">)</span>
<span class="lineno"> 2</span> <span class="k">def</span> <span class="nf">callback</span><span class="p">():</span>
<span class="lineno"> 3</span>     <span class="c"># Redirect user to home page if already logged in.</span>
<span class="lineno"> 4</span>     <span class="k">if</span> <span class="n">current_user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
<span class="lineno"> 5</span>         <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'index'</span><span class="p">))</span>
<span class="lineno"> 6</span>     <span class="k">if</span> <span class="s">'error'</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
<span class="lineno"> 7</span>         <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'error'</span><span class="p">)</span> <span class="o">==</span> <span class="s">'access_denied'</span><span class="p">:</span>
<span class="lineno"> 8</span>             <span class="k">return</span> <span class="s">'You denied access.'</span>
<span class="lineno"> 9</span>         <span class="k">return</span> <span class="s">'Error encountered.'</span>
<span class="lineno">10</span>     <span class="k">if</span> <span class="s">'code'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span> <span class="ow">and</span> <span class="s">'state'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
<span class="lineno">11</span>         <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'login'</span><span class="p">))</span>
<span class="lineno">12</span>     <span class="k">else</span><span class="p">:</span>
<span class="lineno">13</span>         <span class="c"># Execution reaches here when user has</span>
<span class="lineno">14</span>         <span class="c"># successfully authenticated our app.</span>
<span class="lineno">15</span>         <span class="n">google</span> <span class="o">=</span> <span class="n">get_google_auth</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">session</span><span class="p">[</span><span class="s">'oauth_state'</span><span class="p">])</span>
<span class="lineno">16</span>         <span class="k">try</span><span class="p">:</span>
<span class="lineno">17</span>             <span class="n">token</span> <span class="o">=</span> <span class="n">google</span><span class="o">.</span><span class="n">fetch_token</span><span class="p">(</span>
<span class="lineno">18</span>                 <span class="n">Auth</span><span class="o">.</span><span class="n">TOKEN_URI</span><span class="p">,</span>
<span class="lineno">19</span>                 <span class="n">client_secret</span><span class="o">=</span><span class="n">Auth</span><span class="o">.</span><span class="n">CLIENT_SECRET</span><span class="p">,</span>
<span class="lineno">20</span>                 <span class="n">authorization_response</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
<span class="lineno">21</span>         <span class="k">except</span> <span class="n">HTTPError</span><span class="p">:</span>
<span class="lineno">22</span>             <span class="k">return</span> <span class="s">'HTTPError occurred.'</span>
<span class="lineno">23</span>         <span class="n">google</span> <span class="o">=</span> <span class="n">get_google_auth</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>
<span class="lineno">24</span>         <span class="n">resp</span> <span class="o">=</span> <span class="n">google</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Auth</span><span class="o">.</span><span class="n">USER_INFO</span><span class="p">)</span>
<span class="lineno">25</span>         <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
<span class="lineno">26</span>             <span class="n">user_data</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<span class="lineno">27</span>             <span class="n">email</span> <span class="o">=</span> <span class="n">user_data</span><span class="p">[</span><span class="s">'email'</span><span class="p">]</span>
<span class="lineno">28</span>             <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="lineno">29</span>             <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
<span class="lineno">30</span>                 <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">()</span>
<span class="lineno">31</span>                 <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>
<span class="lineno">32</span>             <span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">user_data</span><span class="p">[</span><span class="s">'name'</span><span class="p">]</span>
<span class="lineno">33</span>             <span class="k">print</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
<span class="lineno">34</span>             <span class="n">user</span><span class="o">.</span><span class="n">tokens</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
<span class="lineno">35</span>             <span class="n">user</span><span class="o">.</span><span class="n">avatar</span> <span class="o">=</span> <span class="n">user_data</span><span class="p">[</span><span class="s">'picture'</span><span class="p">]</span>
<span class="lineno">36</span>             <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="lineno">37</span>             <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="lineno">38</span>             <span class="n">login_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="lineno">39</span>             <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'index'</span><span class="p">))</span>
<span class="lineno">40</span>         <span class="k">return</span> <span class="s">'Could not fetch your information.'</span></code></pre></div>

<p>In the above code,</p>

<ul>
  <li>We check if a user is already logged in. If yes, we then redirect them to the home page.</li>
  <li>Then we check if the url has an <code>error</code> query parameter. This check is done to handle cases where a user after going to the Google login page, denies access. We then return an appropriate message to the user.</li>
  <li>We then check if the url contains <code>code</code> and <code>state</code> parameters or not. If these are not in the URL, this means that someone tried to access the URL directly. So we redirect them to the login page.</li>
  <li>After handling all the side cases, we finally handle the case where the user has successfully authenticated our app.
    <ul>
      <li>In this case, we create a new <code>OAuth2Session</code> object by passing the <code>state</code> parameter.</li>
      <li>Then we try to get an <code>access_token</code> from Google using</li>
    </ul>
  </li>
</ul>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">token</span> <span class="o">=</span> <span class="n">google</span><span class="o">.</span><span class="n">fetch_token</span><span class="p">(</span>
    <span class="n">Auth</span><span class="o">.</span><span class="n">TOKEN_URI</span><span class="p">,</span>
    <span class="n">client_secret</span><span class="o">=</span><span class="n">Auth</span><span class="o">.</span><span class="n">CLIENT_SECRET</span><span class="p">,</span>
    <span class="n">authorization_response</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span></code></pre></div>

<p>If error occurs, we return appropriate message to user.</p>

<ul>
  <li>After getting the <code>token</code> successfully, we again create a new <code>OAuth2Session</code> by setting the <code>token</code> parameter.</li>
  <li>Finally we try to access the user information using</li>
</ul>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">google</span> <span class="o">=</span> <span class="n">get_google_auth</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>
<span class="n">resp</span> <span class="o">=</span> <span class="n">google</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Auth</span><span class="o">.</span><span class="n">USER_INFO</span><span class="p">)</span></code></pre></div>

<p>The user information is a JSON of the form:</p>

<div class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">"family_name"</span><span class="p">:</span> <span class="s2">"Doe"</span><span class="p">,</span> 
  <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"John Doe"</span><span class="p">,</span> 
  <span class="nt">"picture"</span><span class="p">:</span> <span class="s2">"https://lh3.googleusercontent.com/-asdasdas/asdasdad/asdasd/daadsas/photo.jpg"</span><span class="p">,</span> 
  <span class="nt">"locale"</span><span class="p">:</span> <span class="s2">"en"</span><span class="p">,</span> 
  <span class="nt">"gender"</span><span class="p">:</span> <span class="s2">"male"</span><span class="p">,</span> 
  <span class="nt">"email"</span><span class="p">:</span> <span class="s2">"john@gmail.com"</span><span class="p">,</span> 
  <span class="nt">"link"</span><span class="p">:</span> <span class="s2">"https://plus.google.com/+JohnDoe"</span><span class="p">,</span> 
  <span class="nt">"given_name"</span><span class="p">:</span> <span class="s2">"John"</span><span class="p">,</span> 
  <span class="nt">"id"</span><span class="p">:</span> <span class="s2">"1109367330250025112153346"</span><span class="p">,</span> 
  <span class="nt">"verified_email"</span><span class="p">:</span> <span class="kc">true</span>
<span class="p">}</span></code></pre></div>

<p>After getting the user information, its upto us to how to handle the information. In the callback code, we handle the information by:</p>

<ul>
  <li>First we check if a user with the retrieved <code>email</code> is already in the DB or not. If user is not found, we create a new <code>user</code> and assign the <code>email</code> to it.</li>
  <li>Then we set the other attributes like <code>avatar</code>, <code>tokens</code> and then finally commit the changes to DB.</li>
  <li>After commiting the changes, we login the user using <code>login_user(user)</code> and then redirect the user to home page.</li>
</ul>



<p>To run the above code, first create the DB by opening the python console and executing:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">db</span>
<span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span></code></pre></div>

<p>Then create a test ssl certificate using <code>werkzeug</code>:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">werkzeug.serving</span> <span class="kn">import</span> <span class="n">make_ssl_devcert</span>
<span class="n">make_ssl_devcert</span><span class="p">(</span><span class="s">'./ssl'</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s">'localhost'</span><span class="p">)</span></code></pre></div>

<p>Finally create a file <code>run.py</code> in the same directory as <code>app.py</code> and add the following code and finally run <code>python run.py</code>:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">app</span>
<span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">ssl_context</span><span class="o">=</span><span class="p">(</span><span class="s">'./ssl.crt'</span><span class="p">,</span> <span class="s">'./ssl.key'</span><span class="p">))</span></code></pre></div>


  </div>
  
  </div></body></html>