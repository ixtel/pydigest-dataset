<html><body><div><div class="entry-content clearfix"><p><img src="https://raw.githubusercontent.com/realpython/django-form-fun/master/images/drf-cbv.png" alt="drf-cbv-image"/></p>




<p>In this post let’s continue our development of the Django Talk project along with <a href="http://www.django-rest-framework.org/">Django Rest Framework</a> as we implement <a href="http://www.django-rest-framework.org/api-guide/views#class-based-views">class based views</a>, along with some simple refactoring to keep our code Dry. <strong>Essentially, we’re migrating an existing RESTful API based on function based views to class based views.</strong></p>

<blockquote><p>This is part four of this tutorial series.</p>

<p><strong>Need to catch up?</strong> Check out parts <a href="https://realpython.com/blog/python/django-and-ajax-form-submissions/">one</a> and <a href="https://realpython.com/blog/python/django-and-ajax-form-submissions-more-practice/">two</a> where we tackle Django and AJAX as well as part <a href="https://realpython.com/blog/python/django-rest-framework-quick-start/">three</a> where we introduce the Django Rest Framework.</p>

<p><strong>Need the code?</strong> Download it from the <a href="https://github.com/realpython/django-form-fun">repo</a>.</p></blockquote>

<p><strong>For a more in-depth tutorial on Django Rest Framework, be sure to check out the third <a href="https://realpython.com">Real Python</a> course.</strong></p>

<a name="Refactor"/>
<h2>Refactor</h2>

<p>Before jumping into class based views, let’s do a quick refactor of our current code. Within the <code>def post_element()</code> view, make the following updates:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">post</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Post</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="c"># try:</span>
</span><span class="line"><span class="c">#     post = Post.objects.get(pk=pk)</span>
</span><span class="line"><span class="c"># except Post.DoesNotExist:</span>
</span><span class="line"><span class="c">#     return HttpResponse(status=404)</span>
</span></code></pre></td></tr></table></div></figure>


<p>So here we are using the <a href="https://docs.djangoproject.com/en/1.6/topics/http/shortcuts/#get-object-or-404">get_object_or_404</a> shortcut to raise a 404 error instead of an exception.</p>

<p>Make sure to also update the imports:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span><span class="p">,</span> <span class="n">get_object_or_404</span>
</span></code></pre></td></tr></table></div></figure>


<p>Test it out. Try viewing an element that does not exist – i.e., <a href="http://localhost:8000/api/v1/posts/202?format=json">http://localhost:8000/api/v1/posts/202?format=json</a>. You should see the following response in your browser:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="nx">detail</span><span class="o">:</span> <span class="s2">"Not found"</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you open the <em>Network</em> tab within <em>Chrome Developer Tools</em>, you should see a 404 status code. Pretty cool, right? Unfortunately, we won’t be using it much longer, as it’s time to say goodbye to our current function based views and add in class based views.</p>

<a name="Class.Based.Views"/>
<h2>Class Based Views</h2>

<p>While functions are easy to work with, it’s often beneficial to use class based views to reuse functionality, especially for large APIs with a number of endpoints.</p>

<p>Comment out the code for the function based views.</p>

<a name="Collection"/>
<h3>Collection</h3>

<p>Add in the following code for the class based views for the collection:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">class</span> <span class="nc">PostCollection</span><span class="p">(</span><span class="n">mixins</span><span class="o">.</span><span class="n">ListModelMixin</span><span class="p">,</span>
</span><span class="line">                     <span class="n">mixins</span><span class="o">.</span><span class="n">CreateModelMixin</span><span class="p">,</span>
</span><span class="line">                     <span class="n">generics</span><span class="o">.</span><span class="n">GenericAPIView</span><span class="p">):</span>
</span><span class="line">
</span><span class="line">    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span class="line">    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">PostSerializer</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span class="line">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span class="line">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Welcome to the power of <a href="https://docs.djangoproject.com/en/1.6/ref/class-based-views/mixins/">mixins</a>!</p>

<ol>
<li>The <code>ListModelMixin</code> provides the <code>list()</code> function for serializing a collection to JSON and then returning it as a response to a GET request.</li>
<li>The <code>CreateModelMixin</code> meanwhile provides the <code>create()</code> function for creating a new object in response to a POST request.</li>
<li>Finally, the <code>GenericAPIView</code> mixin provides the “core” functionality needed for a RESTful API.</li>
</ol>


<p>Please consult the official DRF <a href="http://www.django-rest-framework.org/api-guide/generic-views#mixins">documentation</a> for more info on these mixins.</p>

<a name="Member"/>
<h3>Member</h3>

<p>Now add the code for the member:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">class</span> <span class="nc">PostMember</span><span class="p">(</span><span class="n">mixins</span><span class="o">.</span><span class="n">RetrieveModelMixin</span><span class="p">,</span>
</span><span class="line">                   <span class="n">mixins</span><span class="o">.</span><span class="n">DestroyModelMixin</span><span class="p">,</span>
</span><span class="line">                   <span class="n">generics</span><span class="o">.</span><span class="n">GenericAPIView</span><span class="p">):</span>
</span><span class="line">
</span><span class="line">    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span class="line">    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">PostSerializer</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span class="line">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span class="line">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">destroy</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here, we simply use the <code>GenericAPIView</code> for the “core functionality” and the remaining mixins to provide the needed functionality to handle GET and DELETE requests.</p>

<a name="URLs"/>
<h3>URLs</h3>

<p>Finally, let’s update <em>urls.py</em> to account for the class based views:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">url</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">talk</span> <span class="kn">import</span> <span class="n">views</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span>
</span><span class="line">    <span class="s">'talk.views'</span><span class="p">,</span>
</span><span class="line">    <span class="n">url</span><span class="p">(</span><span class="s">r'^$'</span><span class="p">,</span> <span class="s">'home'</span><span class="p">),</span>
</span><span class="line">
</span><span class="line">    <span class="c"># api</span>
</span><span class="line">    <span class="n">url</span><span class="p">(</span><span class="s">r'^api/v1/posts/$'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">PostCollection</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</span><span class="line">    <span class="n">url</span><span class="p">(</span><span class="s">r'^api/v1/posts/(?P&lt;pk&gt;[0-9]+)/$'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">PostMember</span><span class="o">.</span><span class="n">as_view</span><span class="p">())</span>
</span><span class="line"><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Take note of the <code>as_view()</code> method, which provides a bit of magic to treat the class as a view function.</p>

<p>Test this out. Launch the development server, then:</p>

<ol>
<li>Make sure all posts load</li>
<li>Add a new post</li>
<li>Remove a post</li>
</ol>


<p>What happened? You should have seen the following error when trying to add a new post:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="mi">400</span><span class="o">:</span> <span class="p">{</span>
</span><span class="line">    <span class="s2">"text"</span><span class="o">:</span> <span class="p">[</span><span class="s2">"This field is required."</span><span class="p">],</span>
</span><span class="line">    <span class="s2">"author"</span><span class="o">:</span> <span class="p">[</span><span class="s2">"This field is required."</span><span class="p">]</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Fortunately, this is an easy fix.</p>

<a name="Refactor.the.AJAX"/>
<h3>Refactor the AJAX</h3>

<p>We need to change the way we’re sending the data with the POST request. First, update <code>the_post</code> key to <code>text</code>:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nx">data</span> <span class="o">:</span> <span class="p">{</span> <span class="nx">text</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#post-text'</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span> <span class="p">},</span> <span class="c1">// data sent with the post request</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you test it out now, the error should just indicate that we’re missing the <code>author</code> field. We can grab the logged in user a number of ways, but the easiest is directly from the DOM.</p>

<blockquote><p>It’s worth noting that we can override the default functionality in the views to grab the username from the request object. However, it’s best to use DRF class based views as intended: Passing all the appropriate parameters – e.g., <code>text</code> and <code>author</code> – in the JSON request and then using the serializer to save them.</p></blockquote>

<p>Open <em>index.html</em> within the “templates/talk” directory. At the top of the file, you’ll see that we’re accessing the username directly from the <code>request</code> object:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="html"><span class="line"><span class="nt">&lt;h2&gt;</span>Hi, {{request.user.username}}<span class="nt">&lt;/h2&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let’s isolate the actual username to make it easier to grab with jQuery:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="html"><span class="line"><span class="nt">&lt;h2&gt;</span>Hi, <span class="nt">&lt;span</span> <span class="na">id=</span><span class="s">"user"</span><span class="nt">&gt;</span>{{request.user.username}}<span class="nt">&lt;/span&gt;&lt;/h2&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now update <code>data</code> again:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nx">data</span> <span class="o">:</span> <span class="p">{</span> <span class="nx">text</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#post-text'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span> <span class="nx">author</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#user'</span><span class="p">).</span><span class="nx">text</span><span class="p">()}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Test it out; all should be well.</p>

<a name="Generic.Based.Views"/>
<h2>Generic Based Views</h2>

<p>Want even more with less? Check this out. Comment out the code we just added, and then update the views like so:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">talk.models</span> <span class="kn">import</span> <span class="n">Post</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">talk.forms</span> <span class="kn">import</span> <span class="n">PostForm</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">talk.serializers</span> <span class="kn">import</span> <span class="n">PostSerializer</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">generics</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">home</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
</span><span class="line">    <span class="n">tmpl_vars</span> <span class="o">=</span> <span class="p">{</span><span class="s">'form'</span><span class="p">:</span> <span class="n">PostForm</span><span class="p">()}</span>
</span><span class="line">    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'talk/index.html'</span><span class="p">,</span> <span class="n">tmpl_vars</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="c">#########################</span>
</span><span class="line"><span class="c">### class based views ###</span>
</span><span class="line"><span class="c">#########################</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">PostCollection</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">ListCreateAPIView</span><span class="p">):</span>
</span><span class="line">    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span class="line">    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">PostSerializer</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">PostMember</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">RetrieveUpdateDestroyAPIView</span><span class="p">):</span>
</span><span class="line">    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span class="line">    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">PostSerializer</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, not only can we still handle all the same requests as before, but we can now handle PUT requests to update each member. More. For <strong>a lot</strong> less.</p>

<p><em>Before moving on jump back to the function based views and compare the code with the class based views. Which is easier to read? Actually, which is easier to understand? Add comments if necessary to help you better understanding what’s happening under the hood with the class based views. Not only do you sacrifice readability with class based views, but testing is slightly more difficult as well. However, we’re now taking advantage of inheritance, and for larger projects that have a number of similar views, class based views are perfect since you don’t have to write the same code over and over again. <strong>Make sure to weigh the pros and cons before jumping to class based views.</strong></em></p>

<p>Be sure to test the endpoints before moving on.</p>

<ol>
<li>Make sure all posts load</li>
<li>Add a new post</li>
<li>Remove a post</li>
</ol>


<p>Curious about the PUT request? Test it out from the Browsable API – i.e., <a href="http://localhost:8000/api/v1/posts/1/">http://localhost:8000/api/v1/posts/1/</a> – via the HTML form. Want to remove the PUT method handler altogether? Update the code like so:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">class</span> <span class="nc">PostMember</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">RetrieveDestroyAPIView</span><span class="p">):</span>
</span><span class="line">    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span class="line">    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">PostSerializer</span>
</span></code></pre></td></tr></table></div></figure>


<p>Test it out now. Questions? Check out the <a href="http://www.django-rest-framework.org/api-guide/generic-views#retrievedestroyapiview">documentation</a>.</p>

<a name="Conclusion"/>
<h2>Conclusion</h2>

<p>This is all for now. We may jump back to the Django Rest Framework in a future post to look at pagination, permissions, and basic validation, but before that we’ll add on AngularJS to the front-end to consume the data.</p>

<p>Cheers!</p>
</div>


      </div></body></html>