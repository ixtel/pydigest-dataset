<html><body><div><div class="post-meta">
        <p>In my previous <a href="https://www.doconnor.org/entry/parsing-server-logs-regular-expressions">post</a> we covered how to extract individual pieces of data from an Nginx log entry. This post will focus on saving that data to MongoDB for future analysis. </p>
<p><a href="https://www.mongodb.org/">MongoDB</a> is an open-source, NoSQL, schemaless, document database. It provides high availability and is capable of handling a high write load, albeit at the expense of data safety. Safety can be increased with validation checks, but this will increase the time it takes to complete an insert. Since access logs are not high value and can be generated at a high rate, MongoDB is a fine candidate for storing log entries. </p>
<p><a href="http://api.mongodb.org/python/current/#overview">PyMongo</a> is a Python wrapper for the MongoDB API. It facilitates the insertion and retrieval of JSON from the database. It is simple to use and is generally the quickest way to begin interfacing with MongoDB. </p>
<p><br/></p>
<h4>Requirements</h4>
<ol>
<li>MongoDB <a href="http://docs.mongodb.org/manual/installation/">installed</a> and waiting for connections</li>
<li><a href="http://api.mongodb.org/python/current/installation.html">PyMongo</a> </li>
</ol>
<p><br/></p>
<h4>Defining a Schema</h4>
<p>Even though MongoDB is schemaless, we should do our best to organize our data in a way that makes sense. Although one of the key selling points of MongoDB is that the schema can be altered in the future, failure to define the structure of our document could lead to decreased performance or needlessly complicated queries. For reference, this is the log entry that we will be breaking apart:</p>
<div class="codehilite"><pre><span class="s1">'192.168.1.12 - - [23/Jun/2015:11:10:57 +0000] "GET /entry/how-create-configure-free-ssl-certificate-using-django-and-pythonanywhere HTTP/1.1" 302 5 "http://www.reddit.com/r/Python/" "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/44.0.2403.18 Safari/537.36" "192.168.1.12"'</span>
</pre></div>


<p><br/>
The components we are interested in storing are:</p>
<div class="codehilite"><pre><span class="nv">$http_x_real_ip</span> <span class="o">[</span><span class="nv">$time_local</span><span class="o">]</span> <span class="s2">"</span><span class="nv">$request</span><span class="s2">"</span> <span class="nv">$status</span> <span class="nv">$body_bytes_sent</span> <span class="s2">"</span><span class="nv">$http_referer</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$http_user_agent</span><span class="s2">"</span>
</pre></div>


<p><br/>
Our schema should be pretty straightforward. Something like this mock entry should meet our needs:</p>
<div class="codehilite"><pre><span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"_id"</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">"5596c5603c2a3505e35f0622"</span><span class="p">),</span>
    <span class="s">"real_ip"</span><span class="p">:</span> <span class="s">"192.168.1.12"</span><span class="p">,</span>
    <span class="s">"time"</span><span class="p">:</span> <span class="n">ISODate</span><span class="p">(</span><span class="s">"2015-06-27T10:06:26Z"</span><span class="p">),</span>
    <span class="s">"request"</span><span class="p">:</span> <span class="s">"GET"</span><span class="p">,</span>
    <span class="s">"page"</span><span class="p">:</span> <span class="s">"/entry/how-create-configure-free-ssl-certificate-using-django-and-pythonanywhere"</span><span class="p">,</span>
    <span class="s">"status"</span><span class="p">:</span> <span class="s">"302"</span><span class="p">,</span>
    <span class="s">"bytes_sent"</span><span class="p">:</span> <span class="s">"5"</span><span class="p">,</span>
    <span class="s">"referer"</span><span class="p">:</span> <span class="s">"http://www.reddit.com/r/Python/"</span><span class="p">,</span>
    <span class="s">"user_agent"</span><span class="p">:</span> <span class="s">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/44.0.2403.18 Safari/537.36"</span><span class="p">,</span>
    <span class="s">"mobile"</span><span class="p">:</span> <span class="n">false</span>
<span class="p">}</span>
</pre></div>


<p><br/></p>
<h4>Polishing the Data</h4>
<p>We already covered how to create a regex for the above log entry in a previous <a href="https://www.doconnor.org/entry/parsing-server-logs-regular-expressions">post</a>. I tweaked the statement a little bit since then so that the request is split into into two pieces: the request method and the page requested. Here is everything we will need to fill in the document:</p>
<div class="codehilite"><pre><span class="p">(</span>\<span class="n">d</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">}</span>\<span class="o">.</span>\<span class="n">d</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">}</span><span class="o">.</span>\<span class="n">d</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">}</span><span class="o">.</span>\<span class="n">d</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">})</span> <span class="o">-</span> <span class="o">-</span> \<span class="p">[(</span><span class="o">.*</span><span class="p">)</span>\<span class="p">]</span> \<span class="s">"(\w{3,6}) (.*) \w{0,4}/\d\.\d</span><span class="se">\"</span><span class="s"> (\d+) (\d+) "</span><span class="p">(</span>\<span class="n">S</span><span class="o">+</span><span class="p">)</span><span class="s">" ["</span><span class="p">](</span><span class="o">.*</span><span class="p">)[</span><span class="s">"] ["</span><span class="p">]</span>
</pre></div>


<p><br/>
You may notice that there is no clearly defined mobile component. This information will be loosely inferred by the user agent prior to insertion. Moreover, the local_time field should be converted to a format natively supported by MongoDB. Doing so will require less storage space and allow for date and time queries.  </p>
<p>To convert the time field we can use the datetime library. On insertion this will yield the desired ISODate() format as depicted in the above mock entry.</p>
<div class="codehilite"><pre><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>


<span class="n">time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s">"23/Jun/2015:11:10:57 +0000"</span><span class="p">,</span> <span class="s">"</span><span class="si">%d</span><span class="s">/%b/%Y:%H:%M:%S %z"</span><span class="p">)</span>
</pre></div>


<p><br/>
There is no sure fire way to discover mobile agents, but if we search for "Mobi" in the user agent string we should be able to get a good idea of which agents are mobile and which are not.</p>
<div class="codehilite"><pre><span class="n">mobile</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">user_agent</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">"Mobi"</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="bp">False</span>
</pre></div>


<p><br/></p>
<h4>Final Product</h4>
<p>With our schema defined and our data cleaned up, we can open our text file, parse each line and insert the log entry into MongoDB. Each entry will require a unique <a href="http://docs.mongodb.org/manual/reference/object-id/">BSON ObjectID</a>, so we will generate one on insertion using the bson library that comes with PyMongo. We will also compile our regex prior to searching the access log. This should increase the speed of our program if we have a ton of entries to parse.</p>
<p>You can use the following sample log file for testing purposes: <a href="https://doconnor.s3.amazonaws.com/media/examples/www.doconnor.org.access.log">download</a>. Make sure to run the below while in the same directory as the log file. </p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">bson.objectid</span> <span class="kn">import</span> <span class="n">ObjectId</span>
<span class="kn">from</span> <span class="nn">pymongo</span> <span class="kn">import</span> <span class="n">MongoClient</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="c"># Connect to local MongoDB instance and select nginx_db</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">()</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">nginx_db</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"www.doconnor.org.access.log"</span><span class="p">,</span> <span class="s">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">access_log</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

<span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r'(\d{1,3}\.\d{1,3}.\d{1,3}.\d{1,3}) - - \[(.*)\] \"(\w{3,6}) (.*) \w{0,4}/\d\.\d\" (\d+) (\d+) "(\S+)" ["](.*)["] ["]'</span><span class="p">)</span>

<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">access_log</span><span class="p">:</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"_id"</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(),</span>
        <span class="s">"real_ip"</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s">"time"</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="s">"</span><span class="si">%d</span><span class="s">/%b/%Y:%H:%M:%S %z"</span><span class="p">),</span>
        <span class="s">"request"</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">2</span><span class="p">],</span>
        <span class="s">"page"</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">3</span><span class="p">],</span>
        <span class="s">"status"</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">4</span><span class="p">],</span>
        <span class="s">"bytes_sent"</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">5</span><span class="p">],</span>
        <span class="s">"referer"</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">6</span><span class="p">],</span>
        <span class="s">"user_agent"</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">7</span><span class="p">],</span>
        <span class="s">"mobile"</span><span class="p">:</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">"Mobi"</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="bp">False</span>
    <span class="p">}</span>
    <span class="n">db</span><span class="o">.</span><span class="n">access</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>


<p><br/>
If we were concerned about data loss we could use w=1 on our insert instead of w=0. This would force MongoDB to acknowledge the insert completed. Again, since these are just access logs we will focus on performance and accept any potential data loss. </p>
<p><br/></p>
<h4>Verification</h4>
<p>We can verify that our data has been successfully inserted by opening the mongo shell and running the following queries:</p>
<div class="codehilite"><pre><span class="o">&gt;</span> <span class="nx">use</span> <span class="nx">nginx_db</span>
<span class="o">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">access</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="s2">"status"</span><span class="o">:</span> <span class="s2">"200"</span><span class="p">})</span>
<span class="p">{</span>
    <span class="s2">"_id"</span> <span class="o">:</span> <span class="nx">ObjectId</span><span class="p">(</span><span class="s2">"5596c5603c2a3505e35f0623"</span><span class="p">),</span>
    <span class="s2">"status"</span> <span class="o">:</span> <span class="s2">"200"</span><span class="p">,</span>
    <span class="s2">"mobile"</span> <span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="s2">"referer"</span> <span class="o">:</span> <span class="s2">"-"</span><span class="p">,</span>
    <span class="s2">"bytes_sent"</span> <span class="o">:</span> <span class="s2">"5781"</span><span class="p">,</span>
    <span class="s2">"page"</span> <span class="o">:</span> <span class="s2">"/entry/how-create-configure-free-ssl-certificate-using-django-and-pythonanywhere"</span><span class="p">,</span>
    <span class="s2">"request"</span> <span class="o">:</span> <span class="s2">"GET"</span><span class="p">,</span>
    <span class="s2">"user_agent"</span> <span class="o">:</span> <span class="s2">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.9; rv:28.0) Gecko/20100101 Firefox/28.0 (FlipboardProxy/1.1; +http://flipboard.com/browserproxy)"</span><span class="p">,</span>
    <span class="s2">"real_ip"</span> <span class="o">:</span> <span class="s2">"192.168.11.234"</span><span class="p">,</span>
    <span class="s2">"time"</span> <span class="o">:</span> <span class="nx">ISODate</span><span class="p">(</span><span class="s2">"2015-06-27T10:06:27Z"</span><span class="p">)</span>
<span class="p">}</span>
<span class="o">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">access</span><span class="p">.</span><span class="nx">count</span><span class="p">()</span>
<span class="mi">258</span> 
<span class="o">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">access</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="s1">'time'</span><span class="o">:</span> <span class="p">{</span><span class="nx">$lt</span><span class="o">:</span> <span class="nx">ISODate</span><span class="p">(</span><span class="s2">"2015-06-26T00:00:00Z"</span><span class="p">)}}).</span><span class="nx">count</span><span class="p">()</span>
<span class="mi">160</span>
<span class="o">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">access</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="s1">'mobile'</span><span class="o">:</span> <span class="kc">true</span><span class="p">}).</span><span class="nx">count</span><span class="p">()</span>
<span class="mi">25</span>
</pre></div>


<p><br/>
If an entry populates and the counts return positive numbers then everything has been inserted successfully. For more information on sharding, replication and data safety please see check the MongoDB <a href="http://docs.mongodb.org/ecosystem/use-cases/storing-log-data/">documentation</a>. In future posts we will look at automating this process and building upon it so that queries can be visualized. </p>
    </div>




               
           </div></body></html>