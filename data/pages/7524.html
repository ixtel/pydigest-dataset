<html><body><div><div id="article_text">
    <p>When writing unit tests in Django using <cite>django.test.TestCase</cite> the database will be flushed after each test. If you're not using an in-memory database this will create a lot of overhead writing to disk.</p>
<p>PostgreSQL is a popular database used in many Django projects but it's default behaviour is to write data to disk which makes it much slower then running SQLite in memory. The default SQLite3 driver will run in memory but it won't be able to test PostgreSQL-specific aspects of your models (such as foreign key integrity on by default when loading in fixtures). MySQL supports an in-memory backend but among other things it does not support <a class="reference external" href="http://dev.mysql.com/doc/refman/5.6/en/memory-storage-engine.html">foriegn keys, blob / text columns or transactions</a>. Using a RAM drive as a storage area for the test database is a good way to test all applicable aspects of PostgreSQL and get the performance of an in-memory database.</p>
<div class="section" id="setup-a-ram-drive">
<h2>Setup a RAM Drive</h2>
<p>The following commands were all run on Ubuntu Server 15.10.</p>
<p>To start, I'll create a 512MB RAM drive.</p>
<div class="highlight"><pre>➫ sudo mkdir -p /media/pg_ram_drive
➫ sudo mount -t tmpfs -o <span class="nv">size</span><span class="o">=</span>512M tmpfs /media/pg_ram_drive/
</pre></div>
<p>I'll confirm I can see the drive mentioned among the mounting points on my system.</p>
<div class="highlight"><pre>➫ mount <span class="p">|</span> grep pg_ram_drive
tmpfs on /media/pg_ram_drive <span class="nb">type </span>tmpfs <span class="o">(</span>rw,relatime,size<span class="o">=</span>524288k<span class="o">)</span>
</pre></div>
</div>
<div class="section" id="benchmark-comparison-between-an-ssd-the-ram-drive">
<h2>Benchmark comparison between an SSD &amp; the RAM drive</h2>
<p>The following benchmarks the RAM drive to see what sort of write performance it offers over the SSD drive on my system.</p>
<div class="highlight"><pre>➫ dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="se">\</span>
      <span class="nv">of</span><span class="o">=</span>/tmp/benchmark <span class="se">\</span>
      <span class="nv">conv</span><span class="o">=</span>fdatasync <span class="se">\</span>
      <span class="nv">bs</span><span class="o">=</span>4k <span class="se">\</span>
      <span class="nv">count</span><span class="o">=</span><span class="m">100000</span> <span class="se">\</span>
      <span class="o">&amp;&amp;</span> rm -f /tmp/benchmark
</pre></div>
<div class="highlight"><pre>100000+0 records in
100000+0 records out
409600000 bytes (410 MB) copied, 0.801915 s, 511 MB/s
</pre></div>
<div class="highlight"><pre>➫ dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="se">\</span>
      <span class="nv">of</span><span class="o">=</span>/media/pg_ram_drive/benchmark <span class="se">\</span>
      <span class="nv">conv</span><span class="o">=</span>fdatasync <span class="se">\</span>
      <span class="nv">bs</span><span class="o">=</span>4k <span class="se">\</span>
      <span class="nv">count</span><span class="o">=</span><span class="m">100000</span> <span class="se">\</span>
      <span class="o">&amp;&amp;</span> rm -f /media/pg_ram_drive/benchmark
</pre></div>
<div class="highlight"><pre>100000+0 records in
100000+0 records out
409600000 bytes (410 MB) copied, 0.129084 s, 3.2 GB/s
</pre></div>
<p>The SSD drive managed to write at 511 MB/s while the RAM drive was 6.4x faster at 3.2 GB/s.</p>
</div>
<div class="section" id="install-postgresql-and-setup-the-ram-drive-tablespace">
<h2>Install PostgreSQL and setup the RAM Drive Tablespace</h2>
<p>The following will install the PostgreSQL 9.4 packages we need:</p>
<div class="highlight"><pre>➫ sudo apt-get update
➫ sudo apt-get install postgresql-server-dev-9.4 <span class="se">\</span>
                        postgresql-client-9.4 <span class="se">\</span>
                        postgresql-contrib-9.4 <span class="se">\</span>
                        libpq-dev
</pre></div>
<p>I'll then make sure PostgreSQL's user has ownership over the RAM drive, create the regular django project's database (which will sit on my SSD drive), create the table space for the RAM drive and create a user account for Django to use which will have permissions to create and drop databases.</p>
<div class="highlight"><pre>➫ sudo chown -R postgres /media/pg_ram_drive/
➫ sudo -u postgres psql
</pre></div>
<div class="highlight"><pre><span class="n">postgres</span><span class="o">=#</span> <span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">django</span><span class="p">;</span>
<span class="n">postgres</span><span class="o">=#</span> <span class="k">CREATE</span> <span class="n">TABLESPACE</span> <span class="n">ram_disk</span> <span class="k">LOCATION</span> <span class="s1">'/media/pg_ram_drive'</span><span class="p">;</span>
<span class="n">postgres</span><span class="o">=#</span> <span class="k">CREATE</span> <span class="k">USER</span> <span class="n">django</span> <span class="k">WITH</span> <span class="n">SUPERUSER</span> <span class="n">PASSWORD</span> <span class="s1">'django'</span><span class="p">;</span>
</pre></div>
<p>There should be a folder on the RAM drive now with a <cite>PG_</cite> prefix that looks something like the following:</p>
<div class="highlight"><pre>➫ sudo find /media/pg_ram_drive
/media/pg_ram_drive
/media/pg_ram_drive/PG_9.4_201409291 <span class="c"># This folder should be empty</span>
</pre></div>
</div>
<div class="section" id="testing-a-django-project-on-the-ram-drive">
<h2>Testing a Django project on the RAM drive</h2>
<p>I'll install all the packages needed to test an example Django project:</p>
<div class="highlight"><pre>➫ sudo apt-get install python-virtualenv python-pip python-dev git-core
</pre></div>
<p>In a <a class="reference external" href="/file-uploads-amazon-s3-django.html">previous blog post</a> I created a project where a Django model is tested, I'll run these tests on the RAM drive.</p>
<div class="highlight"><pre>➫ git clone https://github.com/marklit/meetup-testing.git
➫ virtualenv venv
➫ <span class="nb">source </span>venv/bin/activate
➫ pip install -r meetup-testing/requirements.txt
➫ pip install psycopg2
➫ <span class="nb">cd </span>meetup-testing
</pre></div>
<p>This code base has a convention that settings that need to be overridden are done so in a <cite>base/local_settings.py</cite> file which is not kept in the git repo. In this file I'll set both the regular and test database settings.</p>
<p>The most important setting is the <cite>DEFAULT_TABLESPACE</cite> attribute which should be the name of the RAM disk tablespace that was created in PostgreSQL.</p>
<div class="highlight"><pre>➫ vi base/local_settings.py
</pre></div>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">sys</span>


<span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'default'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'ENGINE'</span><span class="p">:</span> <span class="s">'django.db.backends.postgresql_psycopg2'</span><span class="p">,</span>
        <span class="s">'HOST'</span><span class="p">:</span> <span class="s">'localhost'</span><span class="p">,</span>
        <span class="s">'PORT'</span><span class="p">:</span> <span class="mi">5432</span><span class="p">,</span>
        <span class="s">'NAME'</span><span class="p">:</span> <span class="s">'django'</span><span class="p">,</span>
        <span class="s">'USER'</span><span class="p">:</span> <span class="s">'django'</span><span class="p">,</span>
        <span class="s">'PASSWORD'</span><span class="p">:</span> <span class="s">'django'</span><span class="p">,</span>
        <span class="s">'TEST'</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">'NAME'</span><span class="p">:</span> <span class="s">'django_test'</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="k">if</span> <span class="s">'test'</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">:</span>
    <span class="n">DEFAULT_TABLESPACE</span> <span class="o">=</span> <span class="s">'ram_disk'</span>

<span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s">'a'</span> <span class="o">*</span> <span class="mi">21</span>
</pre></div>
<p>Now when the tests run they're using the RAM drive.</p>
<div class="highlight"><pre>➫ python manage.py <span class="nb">test</span>
Creating <span class="nb">test </span>database <span class="k">for</span> <span class="nb">alias</span> <span class="s1">'default'</span>...
.
----------------------------------------------------------------------
Ran <span class="m">1</span> <span class="nb">test </span>in 0.027s

OK
Destroying <span class="nb">test </span>database <span class="k">for</span> <span class="nb">alias</span> <span class="s1">'default'</span>...
</pre></div>
<p>This code base only has one test but on projects with a lot of tests there should be a significant decrease in the amount of time it takes to run the test suite.</p>
</div>
<div class="section" id="make-the-ram-drive-permanent">
<h2>Make the RAM drive permanent</h2>
<p>To make sure the RAM drive is available if the system restarts add the following line to your <cite>/etc/fstab</cite> file:</p>
<div class="highlight"><pre><span class="n">tmpfs</span>           <span class="o">/</span><span class="n">media</span><span class="o">/</span><span class="n">pg_ram_drive</span>  <span class="n">tmpfs</span>   <span class="n">defaults</span><span class="p">,</span><span class="n">noatime</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="mi">1777</span> <span class="mi">0</span> <span class="mi">0</span>
</pre></div>
<p>After a reboot the drive will be mounted and empty. When you run Django's test runner it'll create a test database from scratch on the drive again.</p>
<div class="highlight"><pre>➫ sudo reboot
...
➫ python manage.py <span class="nb">test</span>
Creating <span class="nb">test </span>database <span class="k">for</span> <span class="nb">alias</span> <span class="s1">'default'</span>...
.
----------------------------------------------------------------------
Ran <span class="m">1</span> <span class="nb">test </span>in 0.059s

OK
Destroying <span class="nb">test </span>database <span class="k">for</span> <span class="nb">alias</span> <span class="s1">'default'</span>...
</pre></div>
</div>

  </div>

   <div id="support_text"><p>
    Thank you for taking the time to read this post. If you're considering using </p><a href="https://www.digitalocean.com/?refcode=074ce6598105">Digital Ocean</a><p>, the hosting provider this blog is hosted on, please consider using </p><a href="https://www.digitalocean.com/?refcode=074ce6598105">this link to sign up</a><p>.
  </p></div>


  
</div></body></html>