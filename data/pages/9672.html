<html><body><div><div class="content html_format"><p>
      SikuliX (старое название Sikuli) — это инструмент, который позволяет автоматизировать то, что вы видите на экране с помощью визуального распознавания (картинок). На хабре уже есть достаточно информации по </p><a href="http://habrahabr.ru/search/?q=Sikuli">нему</a><p>, но все примеры подразумевают использование реального экрана.
</p><p>
Здесь же я опишу свой опыт использования SikuliX в фоновом режиме на облачной IDE </p><a href="https://c9.io">Cloud9</a><p>. В процессе работы с данным инструментом набил немного шишек, поэтому возможно, мой опыт будет кому-то полезен.
</p><p>
Вариантов использования SikuliX достаточно много, вот некоторые из действий, которые вы можете автоматизировать:
</p><ul>
<li>Работа с флеш сайтами (и любими другими)</li>
<li>Автоматизация браузерных игр (собирать урожай на ферме)</li>
<li>Работа с десктопными приложениями</li>
<li>Настройка компьютера</li>
<li>Разнообразные боты</li>
<li>Всякого рода рутинная работа с сайтами/документами</li>
</ul><a name="habracut"/><p>
В моем случае, было необходимо автоматизировать рутинную работу с флеш сайтом, залогиниться, выбрать в выпадающем списке определенный пункт и понажимать несколько кнопочек. Занимало это порядка 1-3х минут по несколько раз в день. После задействования SikuliX это можно делать через простой запуск скрипта, и тратить свободное время на более полезные вещи (например подучить английский).

</p><h3>Установка зависимостей</h3><p>
SikuliX зависит от таких инструментов, как OpenCV (компьютерное зрение) и Tesseract (распознавание текста). Поэтому, их мы и установим. Начнем с OpenCV.
</p><p>
Установка OpenCV оказалась не очень простой, поэтому я использовал </p><a href="https://gist.github.com/dynamicguy/3d1fce8dae65e765f7c4">этот</a><p> скрипт, который установит и сбилдит все необходимое. Склонируем его, дадим права на исполнение и запустим.

</p><pre><code class="bash">git clone git@gist.github.com:3d1fce8dae65e765f7c4.git
cd 3d1fce8dae65e765f7c4
chmod +x install-opencv-2.4.11-in-ubuntu.sh
./install-opencv-2.4.11-in-ubuntu.sh
</code></pre><p>
Надо сказать, что установка OpenCV “выедает” почти все ресурсы которые cloud9 предоставляет в бесплатном режиме. С платным планом было бы проще, но мне хватило и того что есть. Процесс билда составил 2.15 часа, в это время можете заниматься своими делами, проблем возникнуть не должно. После установки, папку 3d1fce8dae65e765f7c4 можно удалить (освободит почти всю память).
</p><p>
С установкой Tesseract все просто:

</p><pre><code class="bash">sudo apt-get install tesseract-ocr
</code></pre><p>
Для установки самого SikuliX нам все же понадобится реальный экран (ограничение Java). Решением стал запуск X11. Чтобы поставить необходимые компоненты, можем использовать </p><a href="https://github.com/fjakobs/cloud9-vnc">этот</a><p> скрипт. В состав входят supervisor, xvfb, fluxbox, x11vnc. Для запуска мы можем перенести файлы run.sh и supervisord.conf в корень, или поправить путь к supervisord.conf в файле run.sh

</p><pre><code class="bash">git clone git@github.com:fjakobs/cloud9-vnc.git
cd cloud9-vnc/
./install.sh
./run.sh
</code></pre><p>
Если все прошло успешно, то после запуска run.sh терминал выдаст ссылку. Перейдем по ней в браузере. Что-то на подобии </p><font>your-workspace/vnc.html</font><p>. Там, нажмем “Connect” и попадем в оконный менеджер fluxbox.

</p><img src="https://habrastorage.org/files/99a/1bd/5e9/99a1bd5e9d67462ab55dc9d9fa83961e.png" alt="image"/>

<h3>Установка SikuliX</h3><p>
Для установки нам понадобится SikuliX 1.1.1 (версии выше не пробовал), так как в версии 1.1.0 был баг, который не позволял запустить sikuli в фоне. Нам нужно скачать sikulixsetup, возьмем его </p><a href="http://nightly.sikuli.de/">здесь</a><p>.
</p><p>
В fluxbox откроем терминал и запустим скачанный файл на установку. У меня было так:

</p><pre><code class="bash">java -jar sikulixsetup-1.1.1-20151126.001204-18-forsetup.jar
</code></pre><p>
Должно открыться окно с вариантами установки SikuliX.

</p><img src="https://habrastorage.org/files/ebb/bd6/f41/ebbbd6f4160448ff8c2112ff03b093ac.png" alt="image"/>

<img src="https://habrastorage.org/files/f98/ef0/0da/f98ef00da57548918bdea6179e18419b.png" alt="image"/>
<p>
Я выбрал первый вариант, который установит sikulix.jar, включающий в себя SikuliX IDE. Скрипты, написанные в нем, потом можно будет запустить в терминале без необходимости открывать IDE. Как подпункт я выбрал Python. Вы можете выбрать иной вариант установки, исходя из своих нужд.
</p><p>
На этапе установки Jython возможны проблемы с установкой Jython 2.7.0 (у меня они были, скрипт просто не запускался). Поэтому лучше нажать кнопку “NO” и установить Jython 2.5.4rc1.
</p><p>
Если все прошло успешно, то вы должны увидеть такое всплывающее окно:

</p><img src="https://habrastorage.org/files/56a/8bb/96c/56a8bb96c40f4f91920bc5962380b1e8.png" alt="image"/>

<h3>Запуск Sikuli IDE</h3><p>
Теперь можем запустить IDE. В ней мы будем писать и отлаживать наши скрипты для дальнейшего их запуска в фоновом режиме.

</p><pre><code class="bash">java -jar sikulix.jar
</code></pre>
<img src="https://habrastorage.org/files/83a/b0a/5ba/83ab0a5bab4a4a88af2415137b7c2f30.png" alt="image"/>

<h3>Пример</h3><p>
Для примера давайте напишем простой скрипт, который проверяет находится ли хабр в топе выдачи гугла по запросу “как пасти котов”. Включим пользовательские логи и запишем наши действия в файл.

</p><img src="https://habrastorage.org/files/44e/d4e/c9e/44ed4ec9ef1b489c9be5f389cc0e2778.png" alt="image"/>
<p>
Скрипт написали, отладили.
</p><p>
В процессе отладки в терминал и лог сыпались некоторые ошибки, типа:

</p><code>[error] command 'wmctrl' is not executable<br/>
</code>
<code>command 'xdotool' is not executable<br/>
</code>
<code>Failed to initialize libdc1394<br/>
</code>
<p>
Ошибки не критичны и можем их просто игнорировать.
</p><p>
После визуальной отладки можем закрыть fluxbox и перейти в терминал IDE Cloud9.
</p><p>
Запустить скрипт в фоне нам поможет </p><a href="http://en.wikipedia.org/wiki/Xvfb">Xvfb</a><p> (X virtual framebuffer). Это виртуальный X-сервер, который выполняет все графические операции в памяти. Почитать можно </p><a href="http://habrahabr.ru/post/113928/">тут</a><p>. Пропишем параметры виртуального экрана, путь к сохраненному проекту, название файла логов и попробуем запустить.

</p><pre><code class="bash">xvfb-run --server-num=10 --server-args="-screen 0 1280x864x16" ./runsikulix -r project.sikuli/ -f SikuliLog.txt
</code></pre>

<img src="https://habrastorage.org/files/94d/a4f/85d/94da4f85daf74b388df78b9ea270e0b4.png" alt="image"/>
<p>
Если все прошло гладко, то в нашем файле логов можно будет прочитать “Success. Habrahabr is in Google's first page”. Профит.

</p><h4>Что дальше:</h4><p>
Дальше можно написать небольшое API и запускать наши скрипты/автотесты, например с консоли рабочего компьютера. 

</p><h4>Источники:</h4>
<a href="http://www.sikulix.com/">Официальный сайт проекта.</a>

      
      <p class="clear"/>
    </div>

    
  </div></body></html>