<html><body><div><div class="entry-content"><p>Heroku is an excellent platform for deploying apps. In <a href="https://blog.heroku.com/archives/2012/5/3/announcing_better_ssl_for_your_app">2012</a>, they annouced free SSL for apps on their subdomains. I have a new Pyramid app ready to deploy after implementing user authentication via a great <a href="http://michael.merickel.org/projects/pyramid_auth_demo/">tutorial</a> (thanks Michael!).</p>

<p>Deploying to Heroku was mostly swift. I followed the <a href="http://pyramid-cookbook.readthedocs.org/en/latest/deployment/heroku.html">instructions</a> given in the <a href="http://pyramid-cookbook.readthedocs.org/en/latest/index.html">Pyramid Cookbook</a>. I had to wrangle a bit with my requirements.txt file so that Heroku would resolve my dependencies correctly.</p>

<p>However, after using the user auth form of the deployed app, I discovered that Heroku was forwarding the url scheme that a user was requesting (via the X-Forwarded-Proto header documented <a href="https://devcenter.heroku.com/articles/http-routing#heroku-headers">here</a>). So, someone could put a link with <code>http</code> as the scheme into the address bar of their browser, and that scheme would be forwarded resulting in insecure transmission of pages. Links on your pages back to your site must have a scheme of <code>https</code> as well. While <a href="http://waitress.readthedocs.org/en/latest/#using-url-scheme-to-set-wsgi-url-scheme">this solution</a> covers that single issue, I wanted redirects from <code>http</code> to <code>https</code> similar to how Rails’ <code>config.force_ssl</code> option works.</p>

<p>After searching hard on Google and the pylons-discuss group, I couldn’t find a complete solution. I took to #pyramid on freenode IRC. After discussing the situation with <a href="https://github.com/mmerickel">Michael Merickel</a> (who surprised me with his identity after the chat), he came up with an excellent solution. You must wrap your app object in <code>runapp.py</code> (as from the Heroku deploy example above) with a wsgi middleware that redirects insecure requests and changes every secure request’s scheme to <code>https</code>, all based on <code>X-Forwarded-Proto</code>.</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
</pre></td><td class="code"><pre><code class="Python"><span class="line"><span class="kn">import</span> <span class="nn">os</span>
</span><span class="line">
</span><span class="line"><span class="kn">from</span> <span class="nn">webob.dec</span> <span class="kn">import</span> <span class="n">wsgify</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">webob.exc</span> <span class="kn">import</span> <span class="n">HTTPMovedPermanently</span>
</span><span class="line">
</span><span class="line"><span class="kn">from</span> <span class="nn">paste.deploy</span> <span class="kn">import</span> <span class="n">loadapp</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">waitress</span> <span class="kn">import</span> <span class="n">serve</span>
</span><span class="line">
</span><span class="line"><span class="nd">@wsgify.middleware</span>
</span><span class="line"><span class="k">def</span> <span class="nf">ForceSSLMiddleware</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
</span><span class="line">    <span class="c"># check that the incoming request was using https</span>
</span><span class="line">    <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">'X-Forwarded-Proto'</span><span class="p">]</span> <span class="o">!=</span> <span class="s">'https'</span><span class="p">:</span>
</span><span class="line">        <span class="n">https_url</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'http://'</span><span class="p">,</span> <span class="s">'https://'</span><span class="p">)</span>
</span><span class="line">        <span class="k">return</span> <span class="n">HTTPMovedPermanently</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">https_url</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="c"># override the request scheme to tell the app that we are using https</span>
</span><span class="line">    <span class="n">req</span><span class="o">.</span><span class="n">scheme</span> <span class="o">=</span> <span class="s">'https'</span>
</span><span class="line">
</span><span class="line">    <span class="n">resp</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</span><span class="line">    <span class="k">return</span> <span class="n">resp</span>
</span><span class="line">
</span><span class="line"><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
</span><span class="line">    <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">"PORT"</span><span class="p">,</span> <span class="mi">5000</span><span class="p">))</span>
</span><span class="line">    <span class="n">app</span> <span class="o">=</span> <span class="n">loadapp</span><span class="p">(</span><span class="s">'config:production.ini'</span><span class="p">,</span> <span class="n">relative_to</span><span class="o">=</span><span class="s">'.'</span><span class="p">)</span>
</span><span class="line">    <span class="n">app</span> <span class="o">=</span> <span class="n">ForceSSLMiddleware</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="n">serve</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s">'0.0.0.0'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>I’m using this in production. If you’re deploying Pyramid to Heroku and test this out, please comment or email me to let me know it works.</p>
</div>


  </div></body></html>