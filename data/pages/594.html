<html><body><div><div class="post-body entry-content" id="post-body-1683670547166640090" itemprop="description articleBody"><p>
Epiphany.</p>
<p>
In Python, with iterators, the </p><b>Visitor</b><p> design pattern is useless. And a strongly-ingrained habit. Which I'm trying to break.
</p><p>
Here's a common </p><b>Visitor</b><p> approach:
</p><code/>
<pre><code>class Visitor:
    def __init__( self ): ...
    def visit( self, some_target_thing ): ...
    def all_done( self ): ...

v = Visitor()
for thing in some_iterator():
    v.visit(thing)
v.all_done()
</code></pre>
<p>
If we refactor the </p><span>for</span><p> statement into the </p><b>Visitor</b><p>, then it's just a </p><b>Command</b><p> or something.
</p><p>
Here's the refactored </p><b>Iterating Visitor</b><p>:
</p><code/>
<pre><code>class Command:
    def __init__( self ): ...
    def process_all( self, iterable ):
        for thing in iterable:
            self.visit( thing )
    def visit( self, thing ): ...
    def all_done( self ): ...

c=Command()
c.process_all( some_iterator() )
c.all_done()
</code></pre>

<b>Possible Objection</b>
<b><br/></b><p>
The one possible objection is this: "What if our data structure is so hellishly complex that we can't reduce it to a simple iterator?"
</p><p>
That's perfectly silly. Any hyper-complex algorithm to walk any hyper-complex data structure, no matter how hyper complex, can always be recast into a generator function which uses </p><span>yield</span><p> to iterate over the objects.

</p><b>Better Design</b>
<p>
Once we start down this road, we can generally simplify processing into a kind of </p><b>Command</b><p> that looks something like this.

</p><code/>
<pre><code>class Command:
    def __init__( self ): ...
    def run( self ): 
        for thing in self.iterable:
            ....

c= Command()
c.iterable= some_iterator()
c.run()
</code></pre>

<p>
I find that this interface is somewhat easier to deal with when composing large commands from individual
small commands. It follows a </p><b>Create-Configure-Run </b><p>pattern that seems to work out well. I just wish I would start with this rather than start with a </p><b>Visitor</b><p>, refactor, and end up with this.

</p><p/>
</div>
</div></body></html>