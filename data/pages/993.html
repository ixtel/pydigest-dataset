<html><body><div><div class="section" id="sh-version">
<h1>sh 1.11</h1>
<p>sh (previously <a class="reference external" href="http://pypi.python.org/pypi/pbs">pbs</a>) is a full-fledged
subprocess interface for Python that
allows you to call any program as if it were a function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sh</span> <span class="kn">import</span> <span class="n">ifconfig</span>
<span class="k">print</span><span class="p">(</span><span class="n">ifconfig</span><span class="p">(</span><span class="s">"wlan0"</span><span class="p">))</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-python"><div class="highlight"><pre>wlan0   Link encap:Ethernet  HWaddr 00:00:00:00:00:00
        inet addr:192.168.1.100  Bcast:192.168.1.255  Mask:255.255.255.0
        inet6 addr: ffff::ffff:ffff:ffff:fff/64 Scope:Link
        UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
        RX packets:0 errors:0 dropped:0 overruns:0 frame:0
        TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
        collisions:0 txqueuelen:1000
        RX bytes:0 (0 GB)  TX bytes:0 (0 GB)
</pre></div>
</div>
<p>More examples:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># checkout master branch</span>
<span class="n">git</span><span class="o">.</span><span class="n">checkout</span><span class="p">(</span><span class="s">"master"</span><span class="p">)</span>

<span class="c"># print(the contents of this directory</span>
<span class="k">print</span><span class="p">(</span><span class="n">ls</span><span class="p">(</span><span class="s">"-l"</span><span class="p">))</span>

<span class="c"># get the longest line of this file</span>
<span class="n">longest_line</span> <span class="o">=</span> <span class="n">wc</span><span class="p">(</span><span class="n">__file__</span><span class="p">,</span> <span class="s">"-L"</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that these aren’t Python functions, these are running the binary
commands on your system dynamically by resolving your $PATH, much like Bash does.
In this way, all the programs on your system are easily available to you
from within Python.</p>
<p>To install:</p>

<p>Follow it on Github: <a class="reference external" href="http://github.com/amoffat/sh">http://github.com/amoffat/sh</a></p>
</div>
<div class="section" id="basic-features">
<h1>Basic Features</h1>
<div class="section" id="command-execution">
<h2>Command execution</h2>
<p>Commands are called just like functions.  They may be executed on the sh
namespace, or imported directly from sh:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">sh</span>
<span class="k">print</span><span class="p">(</span><span class="n">sh</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="s">"/"</span><span class="p">))</span>

<span class="c"># same thing as above</span>
<span class="kn">from</span> <span class="nn">sh</span> <span class="kn">import</span> <span class="n">ls</span>
<span class="k">print</span><span class="p">(</span><span class="n">ls</span><span class="p">(</span><span class="s">"/"</span><span class="p">))</span>
</pre></div>
</div>
<p>For commands that have dashes in their names, for example <code class="docutils literal"><span class="pre">/usr/bin/google-chrome</span></code>,
substitute the dash for an underscore:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">sh</span>
<span class="n">sh</span><span class="o">.</span><span class="n">google_chrome</span><span class="p">(</span><span class="s">"http://google.com"</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>For commands with more exotic characters in their names, like <code class="docutils literal"><span class="pre">.</span></code>, or
if you just don’t like the “magic”-ness of dynamic lookups, you
may use sh’s <code class="docutils literal"><span class="pre">Command</span></code> wrapper and pass in the command name or
the absolute path of the executable:</p>
<div class="last highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">sh</span>
<span class="n">run</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">Command</span><span class="p">(</span><span class="s">"/home/amoffat/run.sh"</span><span class="p">)</span> <span class="c"># Absolute path</span>
<span class="n">run</span><span class="p">()</span>
<span class="n">lscmd</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">Command</span><span class="p">(</span><span class="s">"ls"</span><span class="p">)</span>  <span class="c"># Absolute path not needed</span>
<span class="n">lscmd</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="multiple-arguments">
<h2>Multiple arguments</h2>
<p>Commands that take multiple arguments, need to be invoked using separate
string for each argument rather than single string for all the arguments
together. One might expect the following to work, the way it works in
<a href="#id1"><span class="problematic" id="id2">*</span></a>nix shell, but it doesn’t:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sh</span> <span class="kn">import</span> <span class="n">tar</span>
<span class="n">tar</span><span class="p">(</span><span class="s">"cvf /tmp/test.tar /my/home/directory"</span><span class="p">)</span>
</pre></div>
</div>
<p>You will run into error that may seem baffling:</p>
<div class="highlight-python"><div class="highlight"><pre>RAN: '/bin/tar cvf /tmp/test.tar /my/home/directory'

STDOUT:

STDERR:
/bin/tar: Old option 'f' requires an argument.
Try '/bin/tar --help' or '/bin/tar --usage' for more information.
</pre></div>
</div>
<p>Right way to do this is to break up your arguments before passing them into a program.
A shell (bash) typically does this for you. It turns “tar cvf /tmp/test.tar /my/home/directory/”
into 4 strings: “tar”, “cvf”, “/tmp/test.tar” and “/my/home/directory/” before
passing them into the binary. You have to do this manually with sh.py.:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sh</span> <span class="kn">import</span> <span class="n">tar</span>
<span class="n">tar</span><span class="p">(</span><span class="s">"cvf"</span><span class="p">,</span> <span class="s">"/tmp/test.tar"</span><span class="p">,</span> <span class="s">"/my/home/directory/"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="arguments-to-sh-s-command-wrapper">
<h2>Arguments to sh’s <code class="docutils literal"><span class="pre">Command</span></code> wrapper</h2>
<p>Similar to the above, arguments to the <code class="docutils literal"><span class="pre">sh.Command</span></code> must be separate.
e.g. the following does not work:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">lscmd</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">Command</span><span class="p">(</span><span class="s">"/bin/ls -l"</span><span class="p">)</span>
<span class="n">tarcmd</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">Command</span><span class="p">(</span><span class="s">"/bin/tar cvf /tmp/test.tar /my/home/directory/"</span><span class="p">)</span>
</pre></div>
</div>
<p>You will run into <code class="docutils literal"><span class="pre">CommandNotFound(path)</span></code> exception even when correct full path is specified.
The correct way to do this is to :</p>
<ol class="arabic simple">
<li>build <code class="docutils literal"><span class="pre">Command</span></code> object using <em>only</em> the binary</li>
<li>pass the arguments to the object <em>when invoking</em></li>
</ol>
<p>as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">lscmd</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">Command</span><span class="p">(</span><span class="s">"/bin/ls"</span><span class="p">)</span>
<span class="n">lscmd</span><span class="p">(</span><span class="s">"-l"</span><span class="p">)</span>
<span class="n">tarcmd</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">Command</span><span class="p">(</span><span class="s">"/bin/tar"</span><span class="p">)</span>
<span class="n">tarcmd</span><span class="p">(</span><span class="s">"cvf"</span><span class="p">,</span> <span class="s">"/tmp/test.tar"</span><span class="p">,</span> <span class="s">"/my/home/directory/"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="keyword-arguments">
<h2>Keyword arguments</h2>
<p>Commands support short-form <code class="docutils literal"><span class="pre">-a</span></code> and long-form <code class="docutils literal"><span class="pre">--arg</span></code> arguments as
keyword arguments:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># resolves to "curl http://duckduckgo.com/ -o page.html --silent"</span>
<span class="n">curl</span><span class="p">(</span><span class="s">"http://duckduckgo.com/"</span><span class="p">,</span> <span class="n">o</span><span class="o">=</span><span class="s">"page.html"</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c"># or if you prefer not to use keyword arguments, this does the same thing:</span>
<span class="n">curl</span><span class="p">(</span><span class="s">"http://duckduckgo.com/"</span><span class="p">,</span> <span class="s">"-o"</span><span class="p">,</span> <span class="s">"page.html"</span><span class="p">,</span> <span class="s">"--silent"</span><span class="p">)</span>

<span class="c"># resolves to "adduser amoffat --system --shell=/bin/bash --no-create-home"</span>
<span class="n">adduser</span><span class="p">(</span><span class="s">"amoffat"</span><span class="p">,</span> <span class="n">system</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="s">"/bin/bash"</span><span class="p">,</span> <span class="n">no_create_home</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c"># or</span>
<span class="n">adduser</span><span class="p">(</span><span class="s">"amoffat"</span><span class="p">,</span> <span class="s">"--system"</span><span class="p">,</span> <span class="s">"--shell"</span><span class="p">,</span> <span class="s">"/bin/bash"</span><span class="p">,</span> <span class="s">"--no-create-home"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="background-processes">
<span id="background"/><h2>Background processes</h2>
<p>By default, each command runs and completes its process before returning.  If
you have a long-running command, you can put it in the background with the
<code class="docutils literal"><span class="pre">_bg=True</span></code> <a class="reference internal" href="special_arguments.html#special-arguments"><span>special keyword argument</span></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># blocks</span>
<span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"...3 seconds later"</span><span class="p">)</span>

<span class="c"># doesn't block</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">_bg</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"prints immediately!"</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s">"...and 3 seconds later"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="piping">
<h2>Piping</h2>
<p>Bash style piping is performed using function composition.  Just pass
one command as the input to another, and sh will create a pipe between the two:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># sort this directory by biggest file</span>
<span class="k">print</span><span class="p">(</span><span class="n">sort</span><span class="p">(</span><span class="n">du</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="s">"*"</span><span class="p">),</span> <span class="s">"-sb"</span><span class="p">),</span> <span class="s">"-rn"</span><span class="p">))</span>

<span class="c"># print(the number of folders and files in /etc</span>
<span class="k">print</span><span class="p">(</span><span class="n">wc</span><span class="p">(</span><span class="n">ls</span><span class="p">(</span><span class="s">"/etc"</span><span class="p">,</span> <span class="s">"-1"</span><span class="p">),</span> <span class="s">"-l"</span><span class="p">))</span>
</pre></div>
</div>
<p>By default, any command that is piping another command in waits for it to
complete.  This behavior can be changed with the <code class="docutils literal"><span class="pre">_piped</span></code>
<a class="reference internal" href="special_arguments.html#special-arguments"><span>special keyword argument</span></a> on the command being
piped, which tells it not to complete before sending its data, but to send
its data incrementally.  See <a class="reference internal" href="#advanced-piping"><span>Advanced piping</span></a> for examples of this.</p>
</div>
<div class="section" id="redirection">
<span id="id3"/><h2>Redirection</h2>
<p>sh can redirect the standard and error output streams of a process to a file
or file-like object.  This is done with the special <code class="docutils literal"><span class="pre">_out</span></code> and <code class="docutils literal"><span class="pre">_err</span></code>
<a class="reference internal" href="special_arguments.html#special-arguments"><span>special keyword argument</span></a>. You can pass a filename
or a file object as the argument value.
When the name of an already existing file is passed, the contents of the file
will be overwritten:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">ls</span><span class="p">(</span><span class="n">_out</span><span class="o">=</span><span class="s">"files.list"</span><span class="p">)</span>
<span class="n">ls</span><span class="p">(</span><span class="s">"nonexistent"</span><span class="p">,</span> <span class="n">_err</span><span class="o">=</span><span class="s">"error.txt"</span><span class="p">)</span>
</pre></div>
</div>
<p>You can also redirect to a function.  See <a class="reference internal" href="#callbacks"><span>STDOUT/ERR callbacks</span></a>.</p>
</div>
<div class="section" id="stdin-processing">
<span id="stdin"/><h2>STDIN Processing</h2>
<p>STDIN is sent to a process directly by using a command’s <code class="docutils literal"><span class="pre">_in</span></code>
<a class="reference internal" href="special_arguments.html#special-arguments"><span>special keyword argument</span></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">print</span><span class="p">(</span><span class="n">cat</span><span class="p">(</span><span class="n">_in</span><span class="o">=</span><span class="s">"test"</span><span class="p">))</span> <span class="c"># prints "test"</span>
</pre></div>
</div>
<p>Any command that takes input from STDIN can be used this way:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">print</span><span class="p">(</span><span class="n">tr</span><span class="p">(</span><span class="s">"[:lower:]"</span><span class="p">,</span> <span class="s">"[:upper:]"</span><span class="p">,</span> <span class="n">_in</span><span class="o">=</span><span class="s">"sh is awesome"</span><span class="p">))</span> <span class="c"># SH IS AWESOME</span>
</pre></div>
</div>
<p>You’re also not limited to using just strings.  You may use a file object,
a <a class="reference external" href="http://docs.python.org/library/queue.html#queue-objects">Queue</a>, or any iterable
(list, set, dictionary, etc):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">stdin</span> <span class="o">=</span> <span class="p">[</span><span class="s">"sh"</span><span class="p">,</span> <span class="s">"is"</span><span class="p">,</span> <span class="s">"awesome"</span><span class="p">]</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">tr</span><span class="p">(</span><span class="s">"[:lower:]"</span><span class="p">,</span> <span class="s">"[:upper:]"</span><span class="p">,</span> <span class="n">_in</span><span class="o">=</span><span class="n">stdin</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="sub-commands">
<span id="subcommands"/><h2>Sub-commands</h2>
<p>Many programs have their own command subsets, like git (branch, checkout),
svn (update, status), and sudo (where any command following sudo is considered
a sub-command).  sh handles subcommands through attribute access:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sh</span> <span class="kn">import</span> <span class="n">git</span><span class="p">,</span> <span class="n">sudo</span>

<span class="c"># resolves to "git branch -v"</span>
<span class="k">print</span><span class="p">(</span><span class="n">git</span><span class="o">.</span><span class="n">branch</span><span class="p">(</span><span class="s">"-v"</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">git</span><span class="p">(</span><span class="s">"branch"</span><span class="p">,</span> <span class="s">"-v"</span><span class="p">))</span> <span class="c"># the same command</span>

<span class="c"># resolves to "sudo /bin/ls /root"</span>
<span class="k">print</span><span class="p">(</span><span class="n">sudo</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="s">"/root"</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">sudo</span><span class="p">(</span><span class="s">"/bin/ls"</span><span class="p">,</span> <span class="s">"/root"</span><span class="p">))</span> <span class="c"># the same command</span>
</pre></div>
</div>
<p>Sub-commands are mainly syntax sugar that makes calling some programs look conceptually nicer.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you use sudo, the user executing the script must have the NOPASSWD option
set for whatever command that user is running, otherwise <code class="docutils literal"><span class="pre">sudo</span></code> will hang.</p>
</div>
</div>
<div class="section" id="exit-codes">
<span id="id4"/><h2>Exit codes</h2>
<p>Normal processes exit with exit code 0.  This can be seen through a
command’s <code class="docutils literal"><span class="pre">exit_code</span></code> property:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">output</span> <span class="o">=</span> <span class="n">ls</span><span class="p">(</span><span class="s">"/"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">exit_code</span><span class="p">)</span> <span class="c"># should be 0</span>
</pre></div>
</div>
<p>If a process ends with an error, and the exit code is not 0, an exception
is generated dynamically.
This lets you catch a specific return code, or catch all error return codes
through the base class ErrorReturnCode:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">try</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="n">ls</span><span class="p">(</span><span class="s">"/some/non-existant/folder"</span><span class="p">))</span>
<span class="k">except</span> <span class="n">ErrorReturnCode_2</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"folder doesn't exist!"</span><span class="p">)</span>
    <span class="n">create_the_folder</span><span class="p">()</span>
<span class="k">except</span> <span class="n">ErrorReturnCode</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"unknown error"</span><span class="p">)</span>
    <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Signals <strong>will not</strong> raise an ErrorReturnCode.  The command will return
as if it succeeded, but its <code class="docutils literal"><span class="pre">exit_code</span></code> property will be set to
-signal_num.  So, for example, if a command is killed with a SIGHUP, its
return code will be -1.</p>
</div>
<p>Some programs return strange error codes even though they succeed.  If you know
which code a program might returns and you don’t want to deal with doing
no-op exception handling, you can use the <code class="docutils literal"><span class="pre">_ok_code</span></code>
<a class="reference internal" href="special_arguments.html#special-arguments"><span>special keyword argument</span></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">sh</span>
<span class="n">sh</span><span class="o">.</span><span class="n">weird_program</span><span class="p">(</span><span class="n">_ok_code</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>
</pre></div>
</div>
<p>This means that the command will not generate an exception if the process
exits with 0, 3, or 5 exit code.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you use <code class="docutils literal"><span class="pre">_ok_code</span></code>, you must specify <strong>all</strong> the exit codes that are
considered “ok”, like (typically) 0.</p>
</div>
</div>
<div class="section" id="glob-expansion">
<h2>Glob expansion</h2>
<p>Glob expansion is not performed on your arguments, for example, this will
not work:</p>

<p>You’ll get an error to the effect of <code class="docutils literal"><span class="pre">cannot</span> <span class="pre">access</span> <span class="pre">'\*.py':</span> <span class="pre">No</span> <span class="pre">such</span> <span class="pre">file</span> <span class="pre">or</span> <span class="pre">directory</span></code>.
This is because the <code class="docutils literal"><span class="pre">*.py</span></code> needs to be glob expanded, not passed in literally:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">sh</span>
<span class="n">sh</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="n">sh</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s">"*.py"</span><span class="p">))</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Don’t use Python’s <code class="docutils literal"><span class="pre">glob.glob</span></code> function, use <code class="docutils literal"><span class="pre">sh.glob</span></code>.  Python’s
has edge cases that break with sh.</p>
</div>
</div>
</div>
<div class="section" id="advanced-features">
<h1>Advanced Features</h1>
<div class="section" id="baking">
<span id="id5"/><h2>Baking</h2>
<p>sh is capable of “baking” arguments into commands.  This is similar to the
stdlib functools.partial wrapper.  Example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sh</span> <span class="kn">import</span> <span class="n">ls</span>

<span class="n">ls</span> <span class="o">=</span> <span class="n">ls</span><span class="o">.</span><span class="n">bake</span><span class="p">(</span><span class="s">"-la"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span> <span class="c"># "/usr/bin/ls -la"</span>

<span class="c"># resolves to "ls -la /"</span>
<span class="k">print</span><span class="p">(</span><span class="n">ls</span><span class="p">(</span><span class="s">"/"</span><span class="p">))</span>
</pre></div>
</div>
<p>The idea here is that now every call to <code class="docutils literal"><span class="pre">ls</span></code> will have the “-la” arguments
already specified.  This gets <em>really interesting</em> when you combine this with
subcommand via attribute access:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sh</span> <span class="kn">import</span> <span class="n">ssh</span>

<span class="c"># calling whoami on a server.  this is a lot to type out, especially if</span>
<span class="c"># you wanted to call many commands (not just whoami) back to back on</span>
<span class="c"># the same server</span>
<span class="n">iam1</span> <span class="o">=</span> <span class="n">ssh</span><span class="p">(</span><span class="s">"myserver.com"</span><span class="p">,</span> <span class="s">"-p 1393"</span><span class="p">,</span> <span class="s">"whoami"</span><span class="p">)</span>

<span class="c"># wouldn't it be nice to bake the common parameters into the ssh command?</span>
<span class="n">myserver</span> <span class="o">=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">bake</span><span class="p">(</span><span class="s">"myserver.com"</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">1393</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">myserver</span><span class="p">)</span> <span class="c"># "/usr/bin/ssh myserver.com -p 1393"</span>

<span class="c"># resolves to "/usr/bin/ssh myserver.com -p 1393 whoami"</span>
<span class="n">iam2</span> <span class="o">=</span> <span class="n">myserver</span><span class="o">.</span><span class="n">whoami</span><span class="p">()</span>

<span class="k">assert</span><span class="p">(</span><span class="n">iam1</span> <span class="o">==</span> <span class="n">iam2</span><span class="p">)</span> <span class="c"># True!</span>
</pre></div>
</div>
<p>Now that the “myserver” callable represents a baked ssh command, you
can call anything on the server easily:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># resolves to "/usr/bin/ssh myserver.com -p 1393 tail /var/log/dumb_daemon.log -n 100"</span>
<span class="k">print</span><span class="p">(</span><span class="n">myserver</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="s">"/var/log/dumb_daemon.log"</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">100</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="with-contexts">
<span id="id6"/><h2>‘With’ contexts</h2>
<p>Commands can be run within a <code class="docutils literal"><span class="pre">with</span></code> context.  Popular commands using this
might be <code class="docutils literal"><span class="pre">sudo</span></code> or <code class="docutils literal"><span class="pre">fakeroot</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">with</span> <span class="n">sudo</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ls</span><span class="p">(</span><span class="s">"/root"</span><span class="p">))</span>
</pre></div>
</div>
<p>If you need
to run a command in a with context and pass in arguments, for example, specifying
a -p prompt with sudo, you need to use the <code class="docutils literal"><span class="pre">_with</span></code> <a class="reference internal" href="special_arguments.html#special-arguments"><span>special keyword argument</span></a>.
This let’s the command know that it’s being run from a with context so
it can behave correctly:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">with</span> <span class="n">sudo</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">_with</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ls</span><span class="p">(</span><span class="s">"/root"</span><span class="p">))</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you use sudo, the user executing the script must have the NOPASSWD option
set for whatever command that user is running, otherwise <code class="docutils literal"><span class="pre">sudo</span></code> will hang.</p>
</div>
</div>
<div class="section" id="iterating-over-output">
<span id="iterable"/><h2>Iterating over output</h2>
<p>You can iterate over long-running commands with the <code class="docutils literal"><span class="pre">_iter</span></code>
<a class="reference internal" href="special_arguments.html#special-arguments"><span>special keyword argument</span></a>.  This creates an iterator
(technically, a generator) that you can
loop over:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sh</span> <span class="kn">import</span> <span class="n">tail</span>

<span class="c"># runs forever</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">tail</span><span class="p">(</span><span class="s">"-f"</span><span class="p">,</span> <span class="s">"/var/log/some_log_file.log"</span><span class="p">,</span> <span class="n">_iter</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</pre></div>
</div>
<p>By default, <code class="docutils literal"><span class="pre">_iter</span></code> iterates over stdout, but you can change set this specifically
by passing either “err” or “out” to <code class="docutils literal"><span class="pre">_iter</span></code> (instead of True).  Also by default,
output is line-buffered, but you can change this by changing <a class="reference internal" href="#buffer-sizes"><span>Buffer sizes</span></a></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you need a non-blocking iterator, use <code class="docutils literal"><span class="pre">_iter_noblock</span></code>.  If the current
iteration would block, <code class="docutils literal"><span class="pre">errno.EWOULDBLOCK</span></code> will be returned, otherwise
you’ll receive a chunk of output, as normal.</p>
</div>
</div>
<div class="section" id="stdout-err-callbacks">
<span id="callbacks"/><h2>STDOUT/ERR callbacks</h2>
<p>sh can use callbacks to process output incrementally.  This is done much like
redirection: by passing an argument to either the <code class="docutils literal"><span class="pre">_out</span></code> or <code class="docutils literal"><span class="pre">_err</span></code> (or both)
<a class="reference internal" href="special_arguments.html#special-arguments"><span>special keyword arguments</span></a>, <strong>except this time, you pass
a callable.</strong>  This callable
will be called for each line (or chunk) of data that your command outputs:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sh</span> <span class="kn">import</span> <span class="n">tail</span>

<span class="k">def</span> <span class="nf">process_output</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">tail</span><span class="p">(</span><span class="s">"-f"</span><span class="p">,</span> <span class="s">"/var/log/some_log_file.log"</span><span class="p">,</span> <span class="n">_out</span><span class="o">=</span><span class="n">process_output</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</pre></div>
</div>
<p>To control whether the callback receives a line or a chunk, please see
<a class="reference internal" href="#buffer-sizes"><span>Buffer sizes</span></a>.  To “quit” your callback, simply return True.  This
tells the command not to call your callback anymore.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Returning True does not kill the process, it only keeps the callback from being
called again.  See <a class="reference internal" href="#interactive-callbacks"><span>Interactive callbacks</span></a> for how to kill a process
from a callback.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">_out</span></code> and <code class="docutils literal"><span class="pre">_err</span></code> don’t have to specify callables.  It can be a file-like
object, a Queue, a StringIO instance, or a filename.  See <a class="reference internal" href="#redirection"><span>Redirection</span></a>
for examples.</p>
</div>
</div>
<div class="section" id="interactive-callbacks">
<span id="id7"/><h2>Interactive callbacks</h2>
<p>Each command launched through sh has an internal STDIN
<a class="reference external" href="http://docs.python.org/library/queue.html#queue-objects">Queue</a>
that can be used from callbacks:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">interact</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">stdin</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s">"What... is the air-speed velocity of an unladen swallow?"</span><span class="p">:</span>
        <span class="n">stdin</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">"What do you mean? An African or European swallow?"</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">line</span> <span class="o">==</span> <span class="s">"Huh? I... I don't know that....AAAAGHHHHHH"</span><span class="p">:</span>
        <span class="n">cross_bridge</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">stdin</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">"I don't know....AAGGHHHHH"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>

<span class="n">sh</span><span class="o">.</span><span class="n">bridgekeeper</span><span class="p">(</span><span class="n">_out</span><span class="o">=</span><span class="n">interact</span><span class="p">)</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</pre></div>
</div>
<p>You can also kill or terminate your process (or send any signal, really) from
your callback by adding a third argument to receive the process object:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">process_output</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">stdin</span><span class="p">,</span> <span class="n">process</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">if</span> <span class="s">"ERROR"</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
        <span class="n">process</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">True</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">tail</span><span class="p">(</span><span class="s">"-f"</span><span class="p">,</span> <span class="s">"/var/log/some_log_file.log"</span><span class="p">,</span> <span class="n">_out</span><span class="o">=</span><span class="n">process_output</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</pre></div>
</div>
<p>The above code will run, printing lines from <code class="docutils literal"><span class="pre">some_log_file.log</span></code> until the
word “ERROR” appears in a line, at which point the tail process will be killed
and the script will end.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You may also use <code class="docutils literal"><span class="pre">.terminate()</span></code> to send a SIGTERM, or <code class="docutils literal"><span class="pre">.signal(sig)</span></code> to
send a general <a class="reference external" href="http://docs.python.org/library/signal.html">signal</a>.</p>
</div>
</div>
<div class="section" id="buffer-sizes">
<span id="id9"/><h2>Buffer sizes</h2>
<p>Buffer sizes are important to consider when you begin to use
<a class="reference internal" href="#iterable"><span>iterators</span></a>,
<a class="reference internal" href="#advanced-piping"><span>advanced piping</span></a>,
or <a class="reference internal" href="#callbacks"><span>callbacks</span></a>.  <a class="reference internal" href="tutorials/2-interacting_with_processes.html#tutorial2"><span>Tutorial 2: Entering an SSH password</span></a> has a good example of why
different buffering modes are needed.
Buffer sizes control how STDIN is read and how STDOUT/ERR
are written to.  Consider the following:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">tr</span><span class="p">(</span><span class="s">"[:lower:]"</span><span class="p">,</span> <span class="s">"[:upper:]"</span><span class="p">,</span> <span class="n">_in</span><span class="o">=</span><span class="s">"testing"</span><span class="p">,</span> <span class="n">_iter</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
</pre></div>
</div>
<p>STDIN is, by default, unbuffered, so the string “testing” is read character
by character.  But the result is still “TESTING”, not “T”, “E”, “S”, “T”, “I”,
“N”, “G”.  Why?  Because although STDIN is unbuffered, STDOUT is not.  STDIN
is being read character by character, but all of those single characters are
being aggregated to STDOUT, whose default buffering is line buffering.  Try
this instead:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">tr</span><span class="p">(</span><span class="s">"[:lower:]"</span><span class="p">,</span> <span class="s">"[:upper:]"</span><span class="p">,</span> <span class="n">_in</span><span class="o">=</span><span class="s">"testing"</span><span class="p">,</span> <span class="n">_iter</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">_out_bufsize</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
</pre></div>
</div>
<p>Because now we set STDOUT to also be unbuffered with <code class="docutils literal"><span class="pre">_out_bufsize=0</span></code> the result is
“T”, “E”, “S”, “T”, “I”, “N”, “G”, as expected.</p>
<p>There are 2 bufsize <a class="reference internal" href="special_arguments.html#special-arguments"><span>special keyword arguments</span></a>:
<code class="docutils literal"><span class="pre">_in_bufsize</span></code> and <code class="docutils literal"><span class="pre">_out_bufsize</span></code>.  They may be set to the following values:</p>
<dl class="glossary docutils">
<dt id="term-">0</dt>
<dd>Unbuffered.  For STDIN, strings and file objects will be read character-by-character,
while Queues, callables, and iterables will be read item by item.</dd>
<dt id="term-1">1</dt>
<dd>Line buffered.  For STDIN, data will be passed into the process line-by-line.
For STDOUT/ERR, data will be output line-by-line.  If any data is remaining
in the STDOUT or STDIN buffers after all the lines have been consumed, it
is also consumed/flushed.</dd>
<dt id="term-n">N</dt>
<dd>Buffered by N characters.  For STDIN, data will be passed into the process
&lt;=N characters at a time.  For STDOUT/ERR, data will be output &lt;=N characters
at a time.  If any data is remaining
in the STDOUT or STDIN buffers after all the lines have been consumed, it
is also consumed/flushed.</dd>
</dl>
</div>
<div class="section" id="advanced-piping">
<span id="id10"/><h2>Advanced piping</h2>
<p>By default, all piped commands execute sequentially.  What this means is that the
inner command executes first, then sends its data to the outer command:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">print</span><span class="p">(</span><span class="n">wc</span><span class="p">(</span><span class="n">ls</span><span class="p">(</span><span class="s">"/etc"</span><span class="p">,</span> <span class="s">"-1"</span><span class="p">),</span> <span class="s">"-l"</span><span class="p">))</span>
</pre></div>
</div>
<p>In the above example, <code class="docutils literal"><span class="pre">ls</span></code> executes, gathers its output, then sends that output
to <code class="docutils literal"><span class="pre">wc</span></code>.  This is fine for simple commands, but for commands where you need
parallelism, this isn’t good enough.  Take the following example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">tr</span><span class="p">(</span><span class="n">tail</span><span class="p">(</span><span class="s">"-f"</span><span class="p">,</span> <span class="s">"test.log"</span><span class="p">),</span> <span class="s">"[:upper:]"</span><span class="p">,</span> <span class="s">"[:lower:]"</span><span class="p">,</span> <span class="n">_iter</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>This won’t work</strong> because the <code class="docutils literal"><span class="pre">tail</span> <span class="pre">-f</span></code> command never finishes.  What you
need is for <code class="docutils literal"><span class="pre">tail</span></code> to send its output to <code class="docutils literal"><span class="pre">tr</span></code> as it receives it.  This is where
the <code class="docutils literal"><span class="pre">_piped</span></code> <a class="reference internal" href="special_arguments.html#special-arguments"><span>special keyword argument</span></a> comes in handy:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">tr</span><span class="p">(</span><span class="n">tail</span><span class="p">(</span><span class="s">"-f"</span><span class="p">,</span> <span class="s">"test.log"</span><span class="p">,</span> <span class="n">_piped</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="s">"[:upper:]"</span><span class="p">,</span> <span class="s">"[:lower:]"</span><span class="p">,</span> <span class="n">_iter</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</pre></div>
</div>
<p>This works by telling <code class="docutils literal"><span class="pre">tail</span> <span class="pre">-f</span></code> that it is being used in a pipeline, and that
it should send its output line-by-line to <code class="docutils literal"><span class="pre">tr</span></code>.  By default, <code class="docutils literal"><span class="pre">_piped</span></code> sends
stdout, but you can easily make it send stderr instead by using <code class="docutils literal"><span class="pre">_piped="err"</span></code></p>
</div>
<div class="section" id="environments">
<span id="id11"/><h2>Environments</h2>
<p>The <a class="reference internal" href="special_arguments.html#special-arguments"><span>special keyword argument</span></a> <code class="docutils literal"><span class="pre">_env</span></code> allows you
to pass a dictionary of environement variables and their corresponding values:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">sh</span>
<span class="n">sh</span><span class="o">.</span><span class="n">google_chrome</span><span class="p">(</span><span class="n">_env</span><span class="o">=</span><span class="p">{</span><span class="s">"SOCKS_SERVER"</span><span class="p">:</span> <span class="s">"localhost:1234"</span><span class="p">})</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><code class="docutils literal"><span class="pre">_env</span></code> replaces your process’s environment completely.  Only the key-value
pairs in <code class="docutils literal"><span class="pre">_env</span></code> will be used for its environment.  If you want to add new
environment variables for a process <em>in addition to</em> your existing environment,
try something like this:</p>
<div class="last highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sh</span>

<span class="n">new_env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">new_env</span><span class="p">[</span><span class="s">"SOCKS_SERVER"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"localhost:1234"</span>

<span class="n">sh</span><span class="o">.</span><span class="n">google_chrome</span><span class="p">(</span><span class="n">_env</span><span class="o">=</span><span class="n">new_env</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="ttys">
<span id="id12"/><h2>TTYs</h2>
<p>Some applications behave differently depending on whether their standard file
descriptors are attached to a <a class="reference external" href="http://en.wikipedia.org/wiki/Pseudo_terminal#Applications">TTY</a> or not. For
example, <a class="reference external" href="http://git-scm.com/">git</a> will disable features intended for humans
such as colored and paged output when STDOUT is not attached to a TTY. Other
programs may disable interactive input if a TTY is not attached to STDIN. Still
other programs, such as SSH (without <code class="docutils literal"><span class="pre">-n</span></code>), <em>expect</em> their input to come from a
TTY/terminal.</p>
<p>By default, sh emulates a TTY for STDOUT but not for STDIN. You can change
the default behavior by passing in extra
<a class="reference internal" href="special_arguments.html#special-arguments"><span>special keyword arguments</span></a>, as such:</p>
<table border="1" class="docutils">
<colgroup>
<col/>
<col/>
<col/>
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">FD</th>
<th class="head">KEYWORD</th>
<th class="head">DEFAULT</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>STDOUT</td>
<td>_tty_out</td>
<td>True (tty)</td>
</tr>
<tr class="row-odd"><td>STDIN</td>
<td>_tty_in</td>
<td>False (pipe)</td>
</tr>
</tbody>
</table>
</div>
</div>


          </div></body></html>