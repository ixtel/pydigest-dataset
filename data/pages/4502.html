<html><body><div><div class="post-content">
						    		            			            	                                                                                            
						<p>I’ll open up with the money-shot – these are all of the clusters that I was able to find using the whole Harry Potter and grouping by chapter:</p>
<div id="attachment_242" class="wp-caption alignnone"><a href="http://i1.wp.com/dogdogfish.com/wp-content/uploads/2015/05/all_clusters_subplot.png"><img class="size-full wp-image-242" src="http://i1.wp.com/dogdogfish.com/wp-content/uploads/2015/05/all_clusters_subplot.png?resize=660%2C349" alt="all_clusters_subplot" data-recalc-dims="1"/></a><p class="wp-caption-text">Every cluster plotted separately.</p></div>
<p>That’s far too messy to be of any practical use so let’s have a look at a couple of those clusters in more detail:</p>
<div id="attachment_240" class="wp-caption alignnone"><a href="http://i0.wp.com/dogdogfish.com/wp-content/uploads/2015/05/cluster-5.png"><img class="size-full wp-image-240" src="http://i0.wp.com/dogdogfish.com/wp-content/uploads/2015/05/cluster-5.png?resize=660%2C349" alt="Privet Drive Cluster" data-recalc-dims="1"/></a><p class="wp-caption-text">One of the clusters – a Dursley/Privet Drive heavy cluster!</p></div>
<p>and</p>
<div id="attachment_241" class="wp-caption alignnone"><a href="http://i2.wp.com/dogdogfish.com/wp-content/uploads/2015/05/cluster-23.png"><img class="size-full wp-image-241" src="http://i2.wp.com/dogdogfish.com/wp-content/uploads/2015/05/cluster-23.png?resize=660%2C349" alt="Cluster-23" data-recalc-dims="1"/></a><p class="wp-caption-text">This is a pretty Griphook/Goblin heavy cluster featured on the storyline in book 7.</p></div>
<p>Hopefully that’s piqued your interest enough to continue on scrolling and see how we got these clusters – and see the words that tie them all together! The code for generating these is on my Github (<a href="https://github.com/Kali89/HarryPotterClusters">https://github.com/Kali89/HarryPotterClusters</a>) and all the graphs and documents are contained there.</p>
<p>I went to a really interesting talk at <a href="http://www.meetup.com/PyData-London-Meetup/">PyData</a> that was about Latent Dirichlet Allocation, a topic entirely new to me. I thought I’d love to apply it to my favourite book series – Harry Potter. However, that didn’t happen…instead you get this. A heavy rip off of an excellent post (<a href="http://brandonrose.org/clustering">http://brandonrose.org/clustering</a>) that walks through how to cluster documents using a bunch of techniques including K-Means.</p>
<p><strong>Step 1</strong></p>
<p>Get plain text copies of all the Harry Potter books and make sure they’re all formatted in roughly the same way. As is often the case, this step took bloody ages.</p>
<p><strong>Step 2</strong></p>
<p>I want a few different documents – more than 7 (the number of Harry Potter books for the heathens out there) but substantially less than the number of sentences in all 7 books. Treating each chapter as a separate document seemed to make most sense and so here I initialise everything I need and split my books into chapter.</p>
<p>So at this point we’ve nicely got ourselves a list of chapter titles and a list of the associated text (as a string).</p>
<p><strong>Step 3</strong></p>
<p>Now we’ve got our chapters we’re going to want to tokenise the text in them. Basically this means converting a string into discrete tokens – what we’d think of as words. The reason it’s got a fancy name and I’m being a bit careful about my terminology is because tokenisation also takes care of things like punctuation and isn’t as simple as just splitting a string into separate words. Having said that, I’ve basically taken the path of least resistance and so have gone with a very simple tokenisation scheme. I’m also going to skip over the pain of utf-8 encoding/decoding/recoding. I’ve basically just dropped any character that I’ve found in the least bit complicated.</p>
<p><strong>Step 4</strong></p>
<p>Next I’m going to perform TF-IDF on my chapters. Here, I convert each token into a number and look at how many times that token appears in a given document, and how many documents that token appears in overall. So in this instance I’m looking to see how often a given word appears in this particular chapter and in how many chapters throughout all 7 books the token appears in. This gives us an idea of how important/prominent a word is in a given chapter, taking into account how common the word is throughout all the chapters. As an example ‘Harry’ is likely to feature a lot in a given chapter but also is likely to feature in every chapter and so probably isn’t especially important to any given chapter’s classification. ‘Nicolas Flamel’, however, is going to appear a reasonable amount in a few chapters but not at all in all the rest. We therefore know that Nicolas Flamel is important in the chapters he does appear in.</p>
<p>Luckily, I don’t have to worry about the implementation of TF-IDF – sklearn has got it.</p>
<p>This gives me a large sparse matrix with the TF-IDF score for each word in each document as the entries. If you pay close attention to the parameters I’ve passed along to TfidfVectorizer as they are ripe for the changing. Firstly, `max_df=0.75` is saying that I don’t care about words that appear in more than 75% of the chapters. `min_df=0.05` is saying that I don’t care about words that appear in fewer than 5% of chapters. You can see I passed along my tokeniser and that I’m using English stop-words (that is, I’m removing the most common English words). Finally, I’m generating n-grams between 1 and 4.</p>
<p>For those uninitiated with n-grams they’re basically a way of splitting text up into handy little chunks. As an example, 3-grams of the following sentence:</p>
<p>“This is not the greatest song in the world”</p>
<p>would be:</p>
<p>“This is not”, “is not the”, “not the greatest”, “the greatest song”, e.t.c.</p>
<p>This allows me to pick out common phrases such as “Snape said” and “wizarding world”. Again, that’s a setting that is begging to be played about with.</p>
<p><strong>Step 5</strong></p>
<p>Performing K-means clustering we get output like so:</p>
<p><code><br/>
Cluster 18 words:<br/>
Top words: maxime,madame maxime,karkaroff,madame,hagrid,cedric,moody,krum,champions,tournament</code></p>
<p>Chapter: the hungarian horntail, Book: gobletOfFire<br/>
Chapter: the goblet of fire, Book: gobletOfFire<br/>
Chapter: the four champions, Book: gobletOfFire<br/>
Chapter: beauxbatons and durmstrang, Book: gobletOfFire<br/>
Chapter: the beginning, Book: gobletOfFire<br/>
Chapter: the yule ball, Book: gobletOfFire<br/>
</p>
<p>which is obviously quite a handy little cluster. It’s successfully managed to only take chapters from one book (given that we’ve not allowed K-means access to the book information that is a bit of a triumph). For those aware of Harry Potter you’ll see this is a Triwizard Tournament heavy cluster. Another example:</p>
<p><code><br/>
Cluster 10 words:<br/>
Top words: wormtail,cold voice,voldemort,lord,cauldron,riddle,cedric,man,master,faithful</code></p>
<p>Chapter: the riddle house, Book: gobletOfFire<br/>
Chapter: flesh, blood, and bone, Book: gobletOfFire<br/>
Chapter: the death eaters, Book: gobletOfFire</p>
<p><br/>
Again, all the clusters are from one book – I’m counting that as a result. Added bonus, they’re not sequential chapters! I happen to know (by being a massive Harry Potter geek) that these chapters are towards the start and end of book 4 and focus heavily on Voldemort and Peter Pettigrew.</p>
<p>So far so good and in fact I could stop here but wouldn’t it be nice to visualise those clusters so we can see the topics we’ve picked out graphically? Even if you said no then it doesn’t really matter. I’m still going to do it.</p>
<p><strong> Step 6</strong></p>
<p>First things first, let’s plot all of the chapters on one graph and colour code them with the book from which they came. It’s not a great way of visualising clusters but it is a great way of seeing how everything is laid out:</p>
<div id="attachment_243" class="wp-caption alignnone"><a href="http://i2.wp.com/dogdogfish.com/wp-content/uploads/2015/05/all_clusters.png"><img class="size-full wp-image-243" src="http://i2.wp.com/dogdogfish.com/wp-content/uploads/2015/05/all_clusters.png?resize=660%2C349" alt="all_clusters" data-recalc-dims="1"/></a><p class="wp-caption-text">A messy picture of all the chapters projected into 2d space.</p></div>
<p>Again, this section is shamelessly copied from the aforementioned blog but ultimately we’re projecting the cosine differences between the tf-idf matrix terms into 2-dimensional space. I declare a colour dictionary for each of the books and then rattle through the chapters plotting them.<br/>
I’m sure you’ll agree that’s far too messy for anybody to really do anything with. If you’re following along with the code you’ll see that next I generate the subplot figure shown at the top.</p>
<p>Finally, I create plots for each of the clusters – a few examples of which are:</p>
<p><code><br/>
Cluster 3 words:<br/>
Top words: umbridge,professor,dont,professor umbridge,snape,sirius,im,said hermione,harrys,youre</code></p>
<p>Chapter: the muggle born registration commission, Book: deathlyHallows<br/>
Chapter: the hogwarts high inquisitor, Book: orderOfThePhoenix<br/>
Chapter: o.w.l.s, Book: orderOfThePhoenix<br/>
Chapter: the second war begins, Book: orderOfThePhoenix<br/>
Chapter: educational decree number twenty four, Book: orderOfThePhoenix<br/>
Chapter: the centaur and the sneak, Book: orderOfThePhoenix<br/>
Chapter: percy and padfoot, Book: orderOfThePhoenix<br/>
Chapter: detention with dolores, Book: orderOfThePhoenix<br/>
Chapter: occlumency, Book: orderOfThePhoenix<br/>
Chapter: in the hogs head, Book: orderOfThePhoenix<br/>
Chapter: out of the fire, Book: orderOfThePhoenix<br/>
Chapter: professor umbridge, Book: orderOfThePhoenix<br/>
Chapter: fight and flight, Book: orderOfThePhoenix<br/>
Chapter: seen and unforeseen, Book: orderOfThePhoenix<br/>
Chapter: career advice, Book: orderOfThePhoenix<br/>
Chapter: snapes worst memory, Book: orderOfThePhoenix</p>
<p/>
<p>generates:</p>
<div id="attachment_244" class="wp-caption alignnone"><a href="http://i2.wp.com/dogdogfish.com/wp-content/uploads/2015/05/cluster-3.png"><img class="size-full wp-image-244" src="http://i2.wp.com/dogdogfish.com/wp-content/uploads/2015/05/cluster-3.png?resize=660%2C349" alt="Umbridge's cluster" data-recalc-dims="1"/></a><p class="wp-caption-text">Umbridge’s cluster</p></div>
<p>Everybody’s favourite professor – Dolores Umbridge!</p>
<p>And another:</p>
<p><code/></p>
<p>Top words: hagrid,yeh,ter,said hagrid,professor,said hermione,malfoy,o,professor trelawney,trelawney</p>
<p>Chapter: professor trelawney's prediction, Book: prisonerOfAzkaban<br/>
Chapter: talons and tea leaves, Book: prisonerOfAzkaban<br/>
Chapter: the firebolt, Book: prisonerOfAzkaban<br/>
Chapter: diagon alley, Book: philosophersStone<br/>
Chapter: the foribidden forest, Book: philosophersStone<br/>
Chapter: the keeper of the keys, Book: philosophersStone<br/>
Chapter: norbert the norwegian ridgeback, Book: philosophersStone<br/>
Chapter: hagrids tale, Book: orderOfThePhoenix<br/>
Chapter: the eye of the snake, Book: orderOfThePhoenix<br/>
Chapter: grawp, Book: orderOfThePhoenix<br/>
Chapter: hermione's helping hand, Book: halfBloodPrince<br/>
Chapter: rita skeeter's scoop, Book: gobletOfFire</p>
<p><br/>
and visually:</p>
<div id="attachment_245" class="wp-caption alignnone"><a href="http://i1.wp.com/dogdogfish.com/wp-content/uploads/2015/05/cluster-4.png"><img class="size-full wp-image-245" src="http://i1.wp.com/dogdogfish.com/wp-content/uploads/2015/05/cluster-4.png?resize=660%2C349" alt="Grawp's brother" data-recalc-dims="1"/></a><p class="wp-caption-text">Keeper of the Keys</p></div>
<p>The anti-Umbridge – it’s Hagrid’s cluster!</p>
<p>I’ll stop on the random copy/pasting of the clusters and stick them all on my Github – I think you’ve got the idea! All in all I’m pretty happy with how this has worked but I am very dependent on individual character names. I tried just looking at 2-grams but it usually just gave me ” said” with a few exceptions (‘wizarding world’, ‘said softly’, ‘death eater’, ‘godrics hollow’). I’ve also put almost zero effort into formatting the images – you know roughly what it’s meant to look like: having the pictures look good is an exercise I’m leaving to the reader’s imagination.</p>
<p>There’s loads more stuff I could do but I’m going to eat a chicken and go swimming so it’ll have to wait.</p>
<p>All was well.</p>

<p id="jp-relatedposts" class="jp-relatedposts">
	<h3 class="jp-relatedposts-headline"><em>Related</em></h3>
</p>								
															        
					</div> 
					            
					</div></body></html>