<html><body><div><div class="entry-content clearfix"><p><strong>Today we are going to learn how to work with large files in <a href="http://pandas.pydata.org/">Pandas</a>, focusing on reading and analyzing an Excel file and then working with a subset of the original data.</strong></p>









<blockquote><p>This tutorial utilizes Python (tested with 64-bit versions of v2.7.9 and v3.4.3), <a href="http://pandas.pydata.org/pandas-docs/version/0.16.1/">Pandas</a> (v0.16.1), and <a href="https://xlsxwriter.readthedocs.org/">XlsxWriter</a> (v0.7.3). We recommend using the <a href="http://continuum.io/downloads">Anaconda</a> distribution to quickly get started, as it comes pre-installed with all the needed libraries.</p></blockquote>

<p><em>This is a collaboration piece between Shantnu Tiwari, founder of <a href="http://pythonforengineers.com/">Python For Engineers</a>, and the fine folks at Real Python.</em></p>

<a name="Reading.the.File"/>
<h2>Reading the File</h2>

<p>The first file we’ll work with is a compilation of all the car accidents in England from 1979-2004, to extract all accidents that happened in London in the year 2000.</p>

<a name="Excel"/>
<h3>Excel</h3>

<p>Start by downloading the source ZIP file from <a href="http://data.gov.uk/dataset/road-accidents-safety-data/resource/80b76aec-a0a1-4e14-8235-09cc6b92574a">data.gov.uk</a>, and extract the contents. Then <em>try</em> to open <em>Accidents7904.csv</em> in Excel. <em>Be careful. If you don’t have enough memory, this could very well crash your computer.</em></p>

<p>What happens?</p>

<p>You should see a “File Not Loaded Completely” error since Excel can only <a href="http://superuser.com/questions/366468/what-is-the-maximum-allowed-rows-in-a-microsoft-excel-xls-or-xlsx">handle</a> one million rows at a time.</p>

<blockquote><p>We tested this in <a href="https://www.libreoffice.org/">LibreOffice</a> as well and received a similar error – “The data could not be loaded completely because the maximum number of rows per sheet was exceeded.”</p></blockquote>

<p>To solve this, we can open the file in Pandas. Before we start, the source code is on <a href="https://github.com/shantnu/PandasLargeFiles">Github</a>.</p>

<a name="Pandas"/>
<h3>Pandas</h3>

<p>Within a new project directory, activate a virtualenv, and then install Pandas:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>pip install <span class="nv">pandas</span><span class="o">==</span>0.16.1
</span></code></pre></td></tr></table></div></figure>


<p>Now let’s build the script. Create a file called <em>pandas_accidents.py</em> and the add the following code:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="c"># Read the file</span>
</span><span class="line"><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">"Accidents7904.csv"</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span class="line"><span class="c"># Output the number of rows</span>
</span><span class="line"><span class="k">print</span><span class="p">(</span><span class="s">"Total rows: {0}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
</span><span class="line"><span class="c"># See which headers are available</span>
</span><span class="line"><span class="k">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here, we imported Pandas, read in the file – which could take some time, depending on how much memory your system has – and outputted the total number of rows the file has as well as the available headers (e.g., column titles).</p>

<p>When ran, you should see:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line">Total rows: 6224198
</span><span class="line"><span class="o">[</span><span class="s1">'\xef\xbb\xbfAccident_Index'</span>, <span class="s1">'Location_Easting_OSGR'</span>, <span class="s1">'Location_Northing_OSGR'</span>,
</span><span class="line"> <span class="s1">'Longitude'</span>, <span class="s1">'Latitude'</span>, <span class="s1">'Police_Force'</span>, <span class="s1">'Accident_Severity'</span>, <span class="s1">'Number_of_Vehicles'</span>,
</span><span class="line"> <span class="s1">'Number_of_Casualties'</span>, <span class="s1">'Date'</span>, <span class="s1">'Day_of_Week'</span>, <span class="s1">'Time'</span>, <span class="s1">'Local_Authority_(District)'</span>,
</span><span class="line"> <span class="s1">'Local_Authority_(Highway)'</span>, <span class="s1">'1st_Road_Class'</span>, <span class="s1">'1st_Road_Number'</span>, <span class="s1">'Road_Type'</span>,
</span><span class="line"> <span class="s1">'Speed_limit'</span>, <span class="s1">'Junction_Detail'</span>, <span class="s1">'Junction_Control'</span>, <span class="s1">'2nd_Road_Class'</span>,
</span><span class="line"> <span class="s1">'2nd_Road_Number'</span>, <span class="s1">'Pedestrian_Crossing-Human_Control'</span>,
</span><span class="line"> <span class="s1">'Pedestrian_Crossing-Physical_Facilities'</span>, <span class="s1">'Light_Conditions'</span>, <span class="s1">'Weather_Conditions'</span>,
</span><span class="line"> <span class="s1">'Road_Surface_Conditions'</span>, <span class="s1">'Special_Conditions_at_Site'</span>, <span class="s1">'Carriageway_Hazards'</span>,
</span><span class="line"> <span class="s1">'Urban_or_Rural_Area'</span>, <span class="s1">'Did_Police_Officer_Attend_Scene_of_Accident'</span>,
</span><span class="line"> <span class="s1">'LSOA_of_Accident_Location'</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, there are over six millions rows! No wonder Excel choked. Turn your attention to the list of headers, the first one in particular:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="s">'</span><span class="se">\xef\xbb\xbf</span><span class="s">Accident_Index'</span><span class="p">,</span>
</span></code></pre></td></tr></table></div></figure>


<p>This should read <code>Accident_Index</code>. What’s with the extra <code>\xef\xbb\xbf</code> at the beginning? Well, the <code>\x</code> actually means that the value is <a href="http://en.wikipedia.org/wiki/Hexadecimal">hexadecimal</a>, which is a <a href="http://stackoverflow.com/a/18664752/1799408">Byte Order Mark</a>, indicating that the text is Unicode.</p>

<p>Why does it matter to us?</p>

<p><em>You cannot assume the files you read are clean. They might contain extra symbols like this that can throw your scripts off.</em></p>

<p>This file is good, in that it is otherwise clean – but many files have missing data, data in internal inconsistent format, etc.. So any time you have a file to analyze, the first thing you must do is clean it. How much cleaning? Enough to allow you to do some analysis. Follow the <a href="http://en.wikipedia.org/wiki/KISS_principle">KISS</a> principle.</p>

<p><strong>What sort of cleanup might you require?</strong></p>

<ul>
<li><em>Fix date/time.</em> The same file might have dates in different formats, like the American (mm-dd-yy) or European (dd-mm-yy) formats. These need to be brought into a common format.</li>
<li><em>Remove any empty values.</em> The file might have blank columns and/or rows, and this will come up as <em>NaN</em> (Not a number) in Pandas. Pandas provides a simple way to remove these: the <code>dropna()</code> function. We saw an example of this in the <a href="https://realpython.com/blog/python/analyzing-obesity-in-england-with-python/">last blog post</a>.</li>
<li><em>Remove any garbage values that have made their way into the data.</em> These are values which do not make sense (like the byte order mark we saw earlier). Sometimes, it might be possible to work around them. For example, there could be a dataset where the age was entered as a floating point number (by mistake). The <code>int()</code> function then could be used to make sure all ages are in integer format.</li>
</ul>


<a name="Analyzing"/>
<h2>Analyzing</h2>

<p>For those of you who know SQL, you can use the SELECT, WHERE, AND/OR statements with different keywords to refine your search. We can do the same in Pandas, and in a way that is <a href="http://pandas.pydata.org/pandas-docs/version/0.16.1/comparison_with_sql.html">more programmer friendly</a>.</p>

<p>To start off, let’s find all the accidents that happened on a Sunday. Looking at the headers above, there is a <code>Day_of_Weeks</code> field, which we will use.</p>

<p>In the ZIP file you downloaded, there’s a file called <em>Road-Accident-Safety-Data-Guide-1979-2004.xls</em>, which contains extra info on the codes used. If you open it up, you will see that <em>Sunday</em> has the code <code>1</code>.</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Accidents"</span><span class="p">)</span>
</span><span class="line"><span class="k">print</span><span class="p">(</span><span class="s">"-----------"</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="c"># Accidents which happened on a Sunday</span>
</span><span class="line"><span class="n">accidents_sunday</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">Day_of_Week</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
</span><span class="line"><span class="k">print</span><span class="p">(</span><span class="s">"Accidents which happened on a Sunday: {0}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span class="line">    <span class="nb">len</span><span class="p">(</span><span class="n">accidents_sunday</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>That’s how simple it is.</p>

<p>Here, we targeted the <code>Day_of_Weeks</code> field and returned a DataFrame with the condition we checked for – <code>day of week == 1</code>.</p>

<p>When ran you should see:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line">Accidents
</span><span class="line">-----------
</span><span class="line">Accidents which happened on a Sunday: 693847
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, there were 693,847 accidents that happened on a Sunday.</p>

<p>Let’s make our query more complicated: Find out all accidents that happened on a Sunday and involved more than twenty cars:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c"># Accidents which happened on a Sunday, &gt; 20 cars</span>
</span><span class="line"><span class="n">accidents_sunday_twenty_cars</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span>
</span><span class="line">    <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Day_of_Week</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Number_of_Vehicles</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)]</span>
</span><span class="line"><span class="k">print</span><span class="p">(</span><span class="s">"Accidents which happened on a Sunday involving &gt; 20 cars: {0}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span class="line">    <span class="nb">len</span><span class="p">(</span><span class="n">accidents_sunday_twenty_cars</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Run the script. Now we have 10 accidents:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line">Accidents
</span><span class="line">-----------
</span><span class="line">Accidents which happened on a Sunday: 693847
</span><span class="line">Accidents which happened on a Sunday involving &gt; 20 cars: 10
</span></code></pre></td></tr></table></div></figure>


<p>Let’s add another condition – weather.</p>

<p>Open the Road-Accident-Safety-Data-Guide-1979-2004.xls, and go to the <em>Weather</em> sheet. You’ll see that the code <code>2</code> means, “Raining with no heavy winds”.</p>

<p>Add that to our query:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c"># Accidents which happened on a Sunday, &gt; 20 cars, in the rain</span>
</span><span class="line"><span class="n">accidents_sunday_twenty_cars_rain</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span>
</span><span class="line">    <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Day_of_Week</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Number_of_Vehicles</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span>
</span><span class="line">    <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Weather_Conditions</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)]</span>
</span><span class="line"><span class="k">print</span><span class="p">(</span><span class="s">"Accidents which happened on a Sunday involving &gt; 20 cars in the rain: {0}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span class="line">    <span class="nb">len</span><span class="p">(</span><span class="n">accidents_sunday_twenty_cars_rain</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>So there were four accidents that happened on a Sunday, involving more than twenty cars, while it was raining:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line">Accidents
</span><span class="line">-----------
</span><span class="line">Accidents which happened on a Sunday: 693847
</span><span class="line">Accidents which happened on a Sunday involving &gt; 20 cars: 10
</span><span class="line">Accidents which happened on a Sunday involving &gt; 20 cars in the rain: 4
</span></code></pre></td></tr></table></div></figure>


<p>We could continue making this more and more complicated, as needed. For now, we’ll stop since our main interest is to look at accidents in London.</p>

<p>If you look at <em>Road-Accident-Safety-Data-Guide-1979-2004.xls</em> again, there is a sheet called <em>Police Force</em>. The code for <code>1</code> says, “Metropolitan Police”. This is what is more commonly known as <em>Scotland Yard</em>, and is the police force responsible for most (though not all) of London. For our case, this is good enough, and we can extract this info like so:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c"># Accidents in London on a Sunday</span>
</span><span class="line"><span class="n">london_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s">'Police_Force'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Day_of_Week</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span>
</span><span class="line"><span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Accidents in London from 1979-2004 on a Sunday: {0}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span class="line">    <span class="nb">len</span><span class="p">(</span><span class="n">london_data</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Run the script. This created a new DataFrame with the accidents handled by the “Metropolitan Police” from 1979 to 2004 on a Sunday:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line">Accidents
</span><span class="line">-----------
</span><span class="line">Accidents which happened on a Sunday: 693847
</span><span class="line">Accidents which happened on a Sunday involving &gt; 20 cars: 10
</span><span class="line">Accidents which happened on a Sunday involving &gt; 20 cars in the rain: 4
</span><span class="line">
</span><span class="line">Accidents in London from 1979-2004 on a Sunday: 114624
</span></code></pre></td></tr></table></div></figure>


<p>What if you wanted to create a new DataFrame that only contains accidents in the year 2000?</p>

<p>The first thing we need to do is convert the date format to one which Python can understand using the <code>pd.to_datetime()</code> <a href="http://pandas.pydata.org/pandas-docs/version/0.16.1/generated/pandas.to_datetime.html?highlight=to_datetime#pandas.to_datetime">function</a>. This takes a date in any format and converts it to a format that we can understand (<em>yyyy-mm-dd</em>). Then we can create another DataFrame that only contains accidents for 2000:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c"># Convert date to Pandas date/time</span>
</span><span class="line"><span class="n">london_data_2000</span> <span class="o">=</span> <span class="n">london_data</span><span class="p">[</span>
</span><span class="line">    <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">london_data</span><span class="p">[</span><span class="s">'Date'</span><span class="p">],</span> <span class="nb">coerce</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">&gt;</span>
</span><span class="line">        <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s">'2000-01-01'</span><span class="p">,</span> <span class="nb">coerce</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span> <span class="o">&amp;</span>
</span><span class="line">    <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">london_data</span><span class="p">[</span><span class="s">'Date'</span><span class="p">],</span> <span class="nb">coerce</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">&lt;</span>
</span><span class="line">        <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s">'2000-12-31'</span><span class="p">,</span> <span class="nb">coerce</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
</span><span class="line"><span class="p">]</span>
</span><span class="line"><span class="k">print</span><span class="p">(</span><span class="s">"Accidents in London in the year 2000 on a Sunday: {0}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span class="line">    <span class="nb">len</span><span class="p">(</span><span class="n">london_data_2000</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>When ran, you should see:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line">Accidents which happened on a Sunday: 693847
</span><span class="line">Accidents which happened on a Sunday involving &gt; 20 cars: 10
</span><span class="line">Accidents which happened on a Sunday involving &gt; 20 cars in the rain: 4
</span><span class="line">
</span><span class="line">Accidents in London from 1979-2004 on a Sunday: 114624
</span><span class="line">Accidents in London in the year 2000 on a Sunday: 3889
</span></code></pre></td></tr></table></div></figure>


<p>So, this is a bit confusing at first. Normally, to filter an array you would just use a <code>for</code> loop with a conditional:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">array</span><span class="p">:</span>
</span><span class="line">    <span class="k">if</span> <span class="n">data</span> <span class="o">&gt;</span> <span class="n">X</span> <span class="ow">and</span> <span class="n">data</span> <span class="o">&lt;</span> <span class="n">X</span><span class="p">:</span>
</span><span class="line">        <span class="c"># do something</span>
</span></code></pre></td></tr></table></div></figure>


<p>However, you really shouldn’t define your own loop since many high-performance libraries, like Pandas, have helper functions in place. In this case, the above code loops over all the elements and filters out data outside the set dates, and then returns the data points that do fall within the dates.</p>

<p>Nice!</p>

<a name="Converting"/>
<h2>Converting</h2>

<p>Chances are that, while using Pandas, everyone else in your organization is stuck with Excel. Want to share the DataFrame with those using Excel?</p>

<p>First, we need to do some cleanup. Remember the byte order mark we saw earlier? That causes problems when writing this data to an Excel file – Pandas throws a <em>UnicodeDecodeError</em>. Why? Because the rest of the text is decoded as ASCII, but the hexadecimal values can’t be represented in ASCII.</p>

<p>We could write everything as Unicode, but remember this byte order mark is an unnecessary (to us) extra we don’t want or need. So we will get rid of it by renaming the column header:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">london_data_2000</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
</span><span class="line">    <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s">'</span><span class="se">\xef\xbb\xbf</span><span class="s">Accident_Index'</span><span class="p">:</span> <span class="s">'Accident_Index'</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is the way to rename a column in Pandas; a bit complicated, to be honest. <code>inplace = True</code> is needed because we want to modify the existing structure, and not create a copy, which is what Pandas does by default.</p>

<p>Now we can save the data to Excel:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c"># Save to Excel</span>
</span><span class="line"><span class="n">writer</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span>
</span><span class="line">    <span class="s">'London_Sundays_2000.xlsx'</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s">'xlsxwriter'</span><span class="p">)</span>
</span><span class="line"><span class="n">london_data_2000</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="s">'Sheet1'</span><span class="p">)</span>
</span><span class="line"><span class="n">writer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Make sure to install <a href="https://xlsxwriter.readthedocs.org/">XlsxWriter</a> before running:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line">pip install <span class="nv">XlsxWriter</span><span class="o">==</span>0.7.3
</span></code></pre></td></tr></table></div></figure>


<p>If all went well, this should have created a file called <em>London_Sundays_2000.xlsx</em>, and then saved our data to <em>Sheet1</em>. Open this file up in Excel or LibreOffice, and confirm that the data is correct.</p>

<a name="Conclusion"/>
<h2>Conclusion</h2>

<p>So, what did we accomplish? Well, we took a very large file that Excel could not open and utilized Pandas to-</p>

<ol>
<li>Open the file.</li>
<li>Perform SQL-like queries against the data.</li>
<li>Create a new XLSX file with a subset of the original data.</li>
</ol>


<p>Keep in mind that even though this file is nearly 800MB, in the age of big data, it’s still quite small. What if you wanted to open a 4GB file? Even if you have 8GB or more of RAM, that might still not be possible since much of your RAM is reserved for the OS and other system processes. In fact, my laptop froze a few times when first reading in the 800MB file. If I opened a 4GB file, it would have a heart attack.</p>

<p>So how do we proceed?</p>

<p>The trick is not to open the whole file in one go. That’s what we’ll look at in the next blog post. Until then, analyze your own data. Leave questions/comments below. Grab the code from the <a href="https://github.com/shantnu/PandasLargeFiles">repo</a>.</p>
</div>


      </div></body></html>