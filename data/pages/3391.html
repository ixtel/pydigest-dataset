<html><body><div><div class="entry-content"><p>
</p><div class="text_cell_render border-box-sizing rendered_html">


<p>Donald Knuth famously quipped that "premature optimization is the root of all evil." The reasons are straightforward: optimized code tends to be much more difficult to read and debug than simpler implementations of the same algorithm, and optimizing too early leads to greater costs down the road. In the Python world, there is another cost to optimization: optimized code often is written in a compiled language like Fortran or C, and this leads to barriers to its development, use, and deployment.</p>
<p>Too often, tutorials about optimizing Python use trivial or toy examples which may not map well to the real world. I've certainly been <a href="https://jakevdp.github.io/blog/2012/08/24/numba-vs-cython/">guilty</a> of this <a href="https://jakevdp.github.io/blog/2013/06/15/numba-vs-cython-take-2/">myself</a>. Here, I'm going to take a different route: in this post I will outline the process of understanding, implementing, and optimizing a non-trivial algorithm in Python, in this case the <a href="http://www.cims.nyu.edu/cmcl/nufft/nufft.html">Non-uniform Fast Fourier Transform</a> (NUFFT). Along the way, we'll dig into the process of optimizing Python code, and see how a relatively straightforward pure Python implementation, with a little help from <a href="http://numba.pydata.org">Numba</a>, can be made to nearly match the performance of a highly-optimized Fortran implementation of the same algorithm.</p>

</div>
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="why-a-python-implementation">Why a Python Implementation?</h2>
<p>First, I want to answer the inevitable question: why spend the time to make a Python implementation of an algorithm that's already out there in Fortran? The reason is that I've found in my research and teaching that pure-Python implementations of algorithms are far more valuable than C or Fortran implementations, even if they might be a bit slower. This is for a number of reasons:</p>
<ul>
<li><p><strong>Pure-Python code is easier to read, understand, and contribute to.</strong> Good Python implementations are much higher-level than C or Fortran, and abstract-away loop indices, bit twiddling, workspace arrays, and other sources of code clutter. A typical student reading good Python code can immediately understand and modify the algorithm, while the same student would be lost trying to understand typical optimized Fortran code.</p></li>
<li><p><strong>Pure-python packages are much easier to install than Python-wrapped C or Fortran code.</strong> This is especially true on non-Linux systems. Fortran in particular can require some installation prerequisites that are non-trivial for many users. In practice, I've seen people give up on better tools when there is an installation barrier for those tools.</p></li>
<li><p><strong>Pure-python code often works for many data types.</strong> Because of the way it is written, pure Python code is often automatically applicable to single or double precision, and perhaps even to extensions to complex numbers. For compiled packages, supporting and compiling for all possible types can be a burden.</p></li>
<li><p><strong>Pure-python is easier to use at scale.</strong> Because it does not require complicated installation, pure Python packages can be much easier to install on cloud VMs and/or shared clusters for computation at scale. If you can easily pip-install a pure-Python package on a VM, then services like AWS and TravisCI are much easier to set up.</p></li>
</ul>
<p>Certainly code speed will overcome these considerations if the performance gap is great enough, but I've found that for many applications a pure Python package, cleverly designed and optimized, can be made fast enough that these larger considerations win-out. The challenge is making the Python fast. We'll explore this below.</p>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="background-the-non-uniform-fast-fourier-transform">Background: The Non-Uniform Fast Fourier Transform</h2>
<p>The Fast Fourier Transform (FFT) is perhaps the most important and fundamental of modern numerical algorithms. It provides a fast, <span class="math">\(O[N\log N]\)</span> method of computing the discrete Fourier transform: <span class="math">\[
Y_k^\pm = \sum_{n=0}^{N-1} y_n e^{\pm i k n / N}
\]</span> You can read more about the FFT in <a href="https://jakevdp.github.io/blog/2013/08/28/understanding-the-fft/">my previous post</a> on the subject.</p>
<p>One important limitation of the FFT is that it requires that input data be evenly-spaced: that is, we can think of the values <span class="math">\(y_n\)</span> as samples of a function <span class="math">\(y_n = y(x_n)\)</span> where <span class="math">\(x_n = x_0 + n\Delta x\)</span> is a regular grid of points. But what about when your grid is not uniform? That is, what if you want to compute this result: <span class="math">\[
Y_k^\pm = \sum_{j=1}^N y(x_j) e^{\pm i k x_j}
\]</span> where <span class="math">\(y(x)\)</span> is evaluated at an arbitrary set of points <span class="math">\(x_j\)</span>? In this case, the FFT is no longer directly applicable, and you're stuck using a much slower <span class="math">\(O[N^2]\)</span> direct summation.</p>
<p>Stuck, that is, until the NUFFT came along.</p>
<p>The NUFFT is an algorithm which converts the non-uniform transform into an approximate uniform transform, not with error-prone interpolation, but instead using a clever "gridding" operation motivated by the convolution theorem. If you'd like to read about the algorithm in detail, the Courant Institute's <a href="http://www.cims.nyu.edu/cmcl/nufft/nufft.html">NUFFT page</a> has a nice set of resources.</p>
<p>Below we'll take a look at implementing this algorithm in Python.</p>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="direct-non-uniform-fourier-transform">Direct Non-Uniform Fourier Transform</h2>
<p>When developing optimized code, it is important to start with something easy to make sure you're on the right track. Here we'll start with a straightforward direct version of the non-uniform Fourier transform. We'll allow non-uniform inputs <span class="math">\(x_j\)</span>, but compute the output on a grid of <span class="math">\(M\)</span> evenly-spaced frequencies in the range <span class="math">\(-M/2 \le f/\delta f &lt; M/2\)</span>. This is what the NUFFT group calls the <em>Type-1 NUFFT</em>.</p>
<p>First we'll implement <code>nufftfreqs()</code>, which returns the frequency grid for a given <span class="math">\(M\)</span>, and <code>nudft()</code> which computes the non-uniform discrete Fourier transform using a slow direct method. The arguments for the latter include <code>iflag</code>, which is a positive or negative number indicating the desired sign of the exponent:</p>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<p class="prompt input_prompt">
InÂ [1]:
</p>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">nufftfreqs</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">"""Compute the frequency range used in nufft for M frequency bins"""</span>
    <span class="k">return</span> <span class="n">df</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">M</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span> <span class="n">M</span> <span class="o">-</span> <span class="p">(</span><span class="n">M</span> <span class="o">//</span> <span class="mi">2</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">nudft</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">iflag</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">"""Non-Uniform Direct Fourier Transform"""</span>
    <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">iflag</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sign</span> <span class="o">*</span> <span class="mi">1j</span> <span class="o">*</span> <span class="n">nufftfreqs</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]))</span>
</pre></div>

</div>
</div>

</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>Again, I can't emphasize this enough: when writing fast code, start with a slow-and-simple version of the code which you <em>know</em> gives the correct result, and then optimize from there.</p>
</div>
<p class="text_cell_render border-box-sizing rendered_html">
<h2 id="comparing-to-the-fortran-nufft">Comparing to the Fortran NUFFT</h2>
</p>
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can double-check that this is producing the desired result by comparing to the Fortran NUFFT implementation, using Python wrappers written by Dan Foreman-Mackey, available at <a href="http://github.com/dfm/python-nufft/">http://github.com/dfm/python-nufft/</a>:</p>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<p class="prompt input_prompt">
InÂ [2]:
</p>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="c"># Install nufft from http://github.com/dfm/python-nufft/</span>
<span class="kn">from</span> <span class="nn">nufft</span> <span class="kn">import</span> <span class="n">nufft1</span> <span class="k">as</span> <span class="n">nufft_fortran</span>

<span class="n">x</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">Y1</span> <span class="o">=</span> <span class="n">nudft</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">Y2</span> <span class="o">=</span> <span class="n">nufft_fortran</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">Y1</span><span class="p">,</span> <span class="n">Y2</span><span class="p">)</span>
</pre></div>

</div>
</div>



</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>The results match! A quick check shows that, as we might expect, the Fortran algorithm is orders of magnitude faster:</p>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<p class="prompt input_prompt">
InÂ [3]:
</p>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="o">%</span><span class="k">timeit</span> <span class="n">nudft</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="o">%</span><span class="k">timeit</span> <span class="n">nufft_fortran</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
</pre></div>

</div>
</div>

<div class="vbox output_wrapper">
<div class="output vbox">


<div class="hbox output_area"><p class="prompt"/>
<div class="box-flex1 output_subarea output_stream output_stdout">
<pre>
10 loops, best of 3: 47.9 ms per loop
1000 loops, best of 3: 265 Âµs per loop

</pre>
</div>
</div>

</div>
</div>

</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>On top of this, for <span class="math">\(N\)</span> points and <span class="math">\(N\)</span> frequencies, the Fortran NUFFT will scale as <span class="math">\(O[N\log N]\)</span>, while our simple implementation will scale as <span class="math">\(O[N^2]\)</span>, making the difference even greater as <span class="math">\(N\)</span> increases! Let's see if we can do better.</p>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="nufft-with-python">NUFFT with Python</h2>
<p>Here we'll attempt a pure-Python version of the fast, FFT-based NUFFT. We'll follow the basics of the algorithm presented on the NUFFT page, using NumPy broadcasting tricks to push loops into the compiled layer of NumPy. For later convenience, we'll start by defining a utility to compute the grid parameters as detailed in the NUFFT paper.</p>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<p class="prompt input_prompt">
InÂ [4]:
</p>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="k">def</span> <span class="nf">_compute_grid_params</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">eps</span><span class="p">):</span>
    <span class="c"># Choose Msp &amp; tau from eps following Dutt &amp; Rokhlin (1993)</span>
    <span class="k">if</span> <span class="n">eps</span> <span class="o">&lt;=</span> <span class="mf">1E-33</span> <span class="ow">or</span> <span class="n">eps</span> <span class="o">&gt;=</span> <span class="mf">1E-1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">"eps = {0:.0e}; must satisfy "</span>
                         <span class="s">"1e-33 &lt; eps &lt; 1e-1."</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eps</span><span class="p">))</span>
    <span class="n">ratio</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">eps</span> <span class="o">&gt;</span> <span class="mf">1E-11</span> <span class="k">else</span> <span class="mi">3</span>
    <span class="n">Msp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">eps</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">Mr</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ratio</span> <span class="o">*</span> <span class="n">M</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">Msp</span><span class="p">)</span>
    <span class="n">lambda_</span> <span class="o">=</span> <span class="n">Msp</span> <span class="o">/</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">*</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">))</span>
    <span class="n">tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">lambda_</span> <span class="o">/</span> <span class="n">M</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">Msp</span><span class="p">,</span> <span class="n">Mr</span><span class="p">,</span> <span class="n">tau</span>


<span class="k">def</span> <span class="nf">nufft_python</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1E-15</span><span class="p">,</span> <span class="n">iflag</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">"""Fast Non-Uniform Fourier Transform with Python"""</span>
    <span class="n">Msp</span><span class="p">,</span> <span class="n">Mr</span><span class="p">,</span> <span class="n">tau</span> <span class="o">=</span> <span class="n">_compute_grid_params</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">eps</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="c"># Construct the convolved grid</span>
    <span class="n">ftau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Mr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">Mr</span> <span class="o">=</span> <span class="n">ftau</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">hx</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">Mr</span>
    <span class="n">mm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">Msp</span><span class="p">,</span> <span class="n">Msp</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">xi</span> <span class="o">//</span> <span class="n">hx</span><span class="p">)</span>
        <span class="n">spread</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span><span class="n">xi</span> <span class="o">-</span> <span class="n">hx</span> <span class="o">*</span> <span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="n">mm</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">tau</span><span class="p">)</span>
        <span class="n">ftau</span><span class="p">[(</span><span class="n">m</span> <span class="o">+</span> <span class="n">mm</span><span class="p">)</span> <span class="o">%</span> <span class="n">Mr</span><span class="p">]</span> <span class="o">+=</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">spread</span>

    <span class="c"># Compute the FFT on the convolved grid</span>
    <span class="k">if</span> <span class="n">iflag</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">Ftau</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">Mr</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">ftau</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Ftau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">ftau</span><span class="p">)</span>
    <span class="n">Ftau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">Ftau</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="n">M</span><span class="o">//</span><span class="mi">2</span><span class="p">):],</span> <span class="n">Ftau</span><span class="p">[:</span><span class="n">M</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="n">M</span> <span class="o">%</span> <span class="mi">2</span><span class="p">]])</span>

    <span class="c"># Deconvolve the grid using convolution theorem</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">nufftfreqs</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">tau</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">tau</span> <span class="o">*</span> <span class="n">k</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">Ftau</span>
</pre></div>

</div>
</div>

</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's compare this to the previous results. For convenience, we'll define a single routine which validates the results and times the execution:</p>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<p class="prompt input_prompt">
InÂ [5]:
</p>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>

<span class="k">def</span> <span class="nf">test_nufft</span><span class="p">(</span><span class="n">nufft_func</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">Mtime</span><span class="o">=</span><span class="mi">100000</span><span class="p">):</span>
    <span class="c"># Test vs the direct method</span>
    <span class="k">print</span><span class="p">(</span><span class="mi">30</span> <span class="o">*</span> <span class="s">'-'</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="p">{</span><span class="s">'nufft1'</span><span class="p">:</span><span class="s">'nufft_fortran'</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nufft_func</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
                                          <span class="n">nufft_func</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"testing {0}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">M</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">iflag</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">F1</span> <span class="o">=</span> <span class="n">nudft</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">iflag</span><span class="o">=</span><span class="n">iflag</span><span class="p">)</span>
            <span class="n">F2</span> <span class="o">=</span> <span class="n">nufft_func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">iflag</span><span class="o">=</span><span class="n">iflag</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">F1</span><span class="p">,</span> <span class="n">F2</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"- Results match the DFT"</span><span class="p">)</span>
    
    <span class="c"># Time the nufft function</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">Mtime</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">times</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">nufft_func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">Mtime</span><span class="p">)</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"- Execution time (M={0}): {1:.2g} sec"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Mtime</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">times</span><span class="p">)))</span>
</pre></div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<p class="prompt input_prompt">
InÂ [6]:
</p>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="n">test_nufft</span><span class="p">(</span><span class="n">nufft_python</span><span class="p">)</span>
<span class="n">test_nufft</span><span class="p">(</span><span class="n">nufft_fortran</span><span class="p">)</span>
</pre></div>

</div>
</div>

<div class="vbox output_wrapper">
<div class="output vbox">


<div class="hbox output_area"><p class="prompt"/>
<div class="box-flex1 output_subarea output_stream output_stdout">
<pre>
------------------------------
testing nufft_python
- Results match the DFT
- Execution time (M=100000): 1.6 sec
------------------------------
testing nufft_fortran
- Results match the DFT
- Execution time (M=100000): 0.043 sec

</pre>
</div>
</div>

</div>
</div>

</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>The good news is that our Python implementation works; the bad news is that it remains several orders of magnitude slower than the Fortran result!</p>
<p>Let's make it faster.</p>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="making-code-faster-line-profiling">Making Code Faster: Line Profiling</h3>
<p>We know that our Python function is slow, but we'd like to determine <em>where</em> this speed bottleneck lies. One convenient way to do this is with the <code>line_profiler</code> utility, a Python/IPython addon which can be installed using <code>$ pip install line_profiler</code> Once it's installed, we can load the line profiler extension into the IPython notebook using the <code>%load_ext</code> magic function:</p>
</div>

<div class="text_cell_render border-box-sizing rendered_html">
<p>With the line profiler loaded, the <code>%lprun</code> magic function is now available, which we can use to profile our function line-by-line. In order to display these results here, we'll save them to file and then use <code>%cat</code> to view the file. The lines wrap in the notebook, making it difficult to read, so you may wish to <a href="http://jakevdp.github.io/downloads/notebooks/NUFFT_lpr.txt">view the raw file</a> instead.</p>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<p class="prompt input_prompt">
InÂ [8]:
</p>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="o">%</span><span class="k">lprun</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="n">f</span> <span class="n">nufft_python</span> <span class="o">-</span><span class="n">T</span> <span class="n">lp_results</span><span class="o">.</span><span class="n">txt</span> <span class="n">nufft_python</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="o">%</span><span class="k">cat</span> <span class="n">lp_results</span><span class="o">.</span><span class="n">txt</span>
</pre></div>

</div>
</div>

<div class="vbox output_wrapper">
<div class="output vbox">


<div class="hbox output_area"><p class="prompt"/>
<div class="box-flex1 output_subarea output_stream output_stdout">
<pre>

*** Profile printout saved to text file 'lp_results.txt'. 
Timer unit: 1e-06 s

Total time: 0.040097 s
File: &lt;ipython-input-4-02aa33b61f03&gt;
Function: nufft_python at line 14

Line #      Hits         Time  Per Hit   % Time  Line Contents
==============================================================
    14                                           def nufft_python(x, c, M, df=1.0, eps=1E-15, iflag=1):
    15                                               """Fast Non-Uniform Fourier Transform with Python"""
    16         1           41     41.0      0.1      Msp, Mr, tau = _compute_grid_params(M, eps)
    17         1            3      3.0      0.0      N = len(x)
    18                                           
    19                                               # Construct the convolved grid
    20         1           19     19.0      0.0      ftau = np.zeros(Mr, dtype=c.dtype)
    21         1            2      2.0      0.0      Mr = ftau.shape[0]
    22         1            3      3.0      0.0      hx = 2 * np.pi / Mr
    23         1           11     11.0      0.0      mm = np.arange(-Msp, Msp)
    24      1001         1493      1.5      3.7      for i in range(N):
    25      1000         2801      2.8      7.0          xi = (x[i] * df) % (2 * np.pi)
    26      1000         3024      3.0      7.5          m = 1 + int(xi // hx)
    27      1000        21048     21.0     52.5          spread = np.exp(-0.25 * (xi - hx * (m + mm)) ** 2 / tau)
    28      1000        11406     11.4     28.4          ftau[(m + mm) % Mr] += c[i] * spread
    29                                           
    30                                               # Compute the FFT on the convolved grid
    31         1            2      2.0      0.0      if iflag &lt; 0:
    32                                                   Ftau = (1 / Mr) * np.fft.fft(ftau)
    33                                               else:
    34         1          183    183.0      0.5          Ftau = np.fft.ifft(ftau)
    35         1           15     15.0      0.0      Ftau = np.concatenate([Ftau[-(M//2):], Ftau[:M//2 + M % 2]])
    36                                           
    37                                               # Deconvolve the grid using convolution theorem
    38         1           14     14.0      0.0      k = nufftfreqs(M)
    39         1           32     32.0      0.1      return (1 / N) * np.sqrt(np.pi / tau) * np.exp(tau * k ** 2) * Ftau
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>The output shows us where, line-by-line, the algorithm is spending the most time. We see that nearly 99% of the execution time is being spent in the single <code>for</code> loop at the center of our code. The loop is so expensive that even the FFT computation is just a trivial piece of the cost! This is actually pretty typical: due to dynamic typing, loops are generally very slow in Python.</p>
<p>One of the surest strategies for speeding-up your code is to use broadcasting tricks in NumPy to remove these kinds of large loops: you can read one of my course lectures on the subject <a href="http://nbviewer.ipython.org/url/www.astro.washington.edu/users/vanderplas/Astr599_2014/notebooks/11_EfficientNumpy.ipynb">here</a>. We'll do this next.</p>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="nufft-with-numpy-broadcasting">NUFFT with NumPy Broadcasting</h2>
<p>Let's rewrite the above implementation and use broadcasting tricks to elliminate the loops. Because of the structure of this problem, the approach is a bit complicated here, but it turns out that we can take advantage here of the little-known <code>at()</code> method of NumPy's ufunc (available since NumPy 1.8). Briefly,</p>
<pre><code>&gt;&gt;&gt; np.add.at(x, i, y)</code></pre>
<p>is similar to</p>
<pre><code>&gt;&gt;&gt; x[i] += y</code></pre>
<p>but works as desired even if the incides <code>i</code> have duplicate entries.</p>
<p>Using this, we can adjust our implementation as follows:</p>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<p class="prompt input_prompt">
InÂ [9]:
</p>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="k">def</span> <span class="nf">nufft_numpy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">iflag</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1E-15</span><span class="p">):</span>
    <span class="sd">"""Fast Non-Uniform Fourier Transform"""</span>
    <span class="n">Msp</span><span class="p">,</span> <span class="n">Mr</span><span class="p">,</span> <span class="n">tau</span> <span class="o">=</span> <span class="n">_compute_grid_params</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">eps</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="c"># Construct the convolved grid ftau:</span>
    <span class="c"># this replaces the loop used above</span>
    <span class="n">ftau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Mr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">hx</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">Mr</span>
    <span class="n">xmod</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">df</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">xmod</span> <span class="o">//</span> <span class="n">hx</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">mm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">Msp</span><span class="p">,</span> <span class="n">Msp</span><span class="p">)</span>
    <span class="n">mpmm</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="n">mm</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">spread</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span><span class="n">xmod</span> <span class="o">-</span> <span class="n">hx</span> <span class="o">*</span> <span class="n">mpmm</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">tau</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">ftau</span><span class="p">,</span> <span class="n">mpmm</span> <span class="o">%</span> <span class="n">Mr</span><span class="p">,</span> <span class="n">spread</span><span class="p">)</span>

    <span class="c"># Compute the FFT on the convolved grid</span>
    <span class="k">if</span> <span class="n">iflag</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">Ftau</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">Mr</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">ftau</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Ftau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">ftau</span><span class="p">)</span>
    <span class="n">Ftau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">Ftau</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="n">M</span><span class="o">//</span><span class="mi">2</span><span class="p">):],</span> <span class="n">Ftau</span><span class="p">[:</span><span class="n">M</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="n">M</span> <span class="o">%</span> <span class="mi">2</span><span class="p">]])</span>

    <span class="c"># Deconvolve the grid using convolution theorem</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">nufftfreqs</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">tau</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">tau</span> <span class="o">*</span> <span class="n">k</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">Ftau</span>
</pre></div>

</div>
</div>

</div>

<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<p class="prompt input_prompt">
InÂ [10]:
</p>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="n">test_nufft</span><span class="p">(</span><span class="n">nufft_numpy</span><span class="p">)</span>
<span class="n">test_nufft</span><span class="p">(</span><span class="n">nufft_python</span><span class="p">)</span>
<span class="n">test_nufft</span><span class="p">(</span><span class="n">nufft_fortran</span><span class="p">)</span>
</pre></div>

</div>
</div>

<div class="vbox output_wrapper">
<div class="output vbox">


<div class="hbox output_area"><p class="prompt"/>
<div class="box-flex1 output_subarea output_stream output_stdout">
<pre>
------------------------------
testing nufft_numpy
- Results match the DFT
- Execution time (M=100000): 0.45 sec
------------------------------
testing nufft_python
- Results match the DFT
- Execution time (M=100000): 1.6 sec
------------------------------
testing nufft_fortran
- Results match the DFT
- Execution time (M=100000): 0.044 sec

</pre>
</div>
</div>

</div>
</div>

</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>It worked! We gained around a factor of 4 speedup in replacing the Python loop with the <code>np.add.at()</code> call. Still, though, we're sitting at about a factor of 10 slower than the Fortran version. The problem is that the <code>np.add.at()</code> call here requires construction of some very large and costly temporary arrays. If we want a faster execution time, we need to further optimize that main loop, and we can't do this with NumPy alone.</p>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="optimization-with-numba">Optimization with Numba</h2>
<p>When NumPy broadcasting tricks aren't enough, there are a few options: you can write Fortran or C code directly, you can use <a href="http://cython.org">Cython</a>, <a href="http://docs.scipy.org/doc/scipy/reference/tutorial/weave.html">Weave</a>, or other tools as a bridge to include compiled snippets in your script, or you can use a tool like <a href="http://cython.org">Numba</a> to speed-up your loops without ever leaving Python.</p>
<p>Numba is a slick tool which runs Python functions through an LLVM just-in-time (JIT) compiler, leading to orders-of-magnitude faster code for certain operations. In this case, we need to optimize what amounts to a nested for-loop, so Numba fits the bill perfectly. For clarity, we'll pull-out the grid construction code that we want to optimize, and write it as follows:</p>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<p class="prompt input_prompt">
InÂ [11]:
</p>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="kn">import</span> <span class="nn">numba</span>

<span class="c"># nopython=True means an error will be raised</span>
<span class="c"># if fast compilation is not possible.</span>
<span class="nd">@numba.jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">build_grid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">Msp</span><span class="p">,</span> <span class="n">ftau</span><span class="p">):</span>
    <span class="n">Mr</span> <span class="o">=</span> <span class="n">ftau</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">hx</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">Mr</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">xi</span> <span class="o">//</span> <span class="n">hx</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">Msp</span><span class="p">,</span> <span class="n">Msp</span><span class="p">):</span>
            <span class="n">ftau</span><span class="p">[(</span><span class="n">m</span> <span class="o">+</span> <span class="n">mm</span><span class="p">)</span> <span class="o">%</span> <span class="n">Mr</span><span class="p">]</span> <span class="o">+=</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span><span class="n">xi</span> <span class="o">-</span> <span class="n">hx</span> <span class="o">*</span> <span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="n">mm</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">tau</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ftau</span>


<span class="k">def</span> <span class="nf">nufft_numba</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1E-15</span><span class="p">,</span> <span class="n">iflag</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">"""Fast Non-Uniform Fourier Transform with Numba"""</span>
    <span class="n">Msp</span><span class="p">,</span> <span class="n">Mr</span><span class="p">,</span> <span class="n">tau</span> <span class="o">=</span> <span class="n">_compute_grid_params</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">eps</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="c"># Construct the convolved grid</span>
    <span class="n">ftau</span> <span class="o">=</span> <span class="n">build_grid</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">df</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">Msp</span><span class="p">,</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Mr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>

    <span class="c"># Compute the FFT on the convolved grid</span>
    <span class="k">if</span> <span class="n">iflag</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">Ftau</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">Mr</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">ftau</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Ftau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">ftau</span><span class="p">)</span>
    <span class="n">Ftau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">Ftau</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="n">M</span><span class="o">//</span><span class="mi">2</span><span class="p">):],</span> <span class="n">Ftau</span><span class="p">[:</span><span class="n">M</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="n">M</span> <span class="o">%</span> <span class="mi">2</span><span class="p">]])</span>

    <span class="c"># Deconvolve the grid using convolution theorem</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">nufftfreqs</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">tau</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">tau</span> <span class="o">*</span> <span class="n">k</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">Ftau</span>
</pre></div>

</div>
</div>

</div>

<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<p class="prompt input_prompt">
InÂ [12]:
</p>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="n">test_nufft</span><span class="p">(</span><span class="n">nufft_numba</span><span class="p">)</span>
<span class="n">test_nufft</span><span class="p">(</span><span class="n">nufft_fortran</span><span class="p">)</span>
</pre></div>

</div>
</div>

<div class="vbox output_wrapper">
<div class="output vbox">


<div class="hbox output_area"><p class="prompt"/>
<div class="box-flex1 output_subarea output_stream output_stdout">
<pre>
------------------------------
testing nufft_numba
- Results match the DFT
- Execution time (M=100000): 0.1 sec
------------------------------
testing nufft_fortran
- Results match the DFT
- Execution time (M=100000): 0.046 sec

</pre>
</div>
</div>

</div>
</div>

</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>Much better! We're now within about a factor of 3 of the Fortran speed, and we're still writing pure Python!</p>
<p>Having plucked all the low-hanging fruit, any further optimization will now be very low-level: that is, thinking about things like reduction of the number of <code>exp()</code> evaluations through application of mathematical identities. This type of careful logic is one reason the Fortran implementation is so fast, and many of these low-level strategies are discussed in the NUFFT paper linked above.</p>
<p>To gain some more speed, we can follow their advice and optimize the expressions at this level by precomputing expensive expressions and recombining these expressions later: This obfuscates the logic of the algorithm a bit, but it does lead to some faster execution. Here is an example of this:</p>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<p class="prompt input_prompt">
InÂ [13]:
</p>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="kn">import</span> <span class="nn">numba</span>

<span class="nd">@numba.jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">build_grid_fast</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">Msp</span><span class="p">,</span> <span class="n">ftau</span><span class="p">,</span> <span class="n">E3</span><span class="p">):</span>
    <span class="n">Mr</span> <span class="o">=</span> <span class="n">ftau</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">hx</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">Mr</span>
    
    <span class="c"># precompute some exponents</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Msp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">E3</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">j</span> <span class="o">/</span> <span class="n">Mr</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">tau</span><span class="p">)</span>
        
    <span class="c"># spread values onto ftau</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">xi</span> <span class="o">//</span> <span class="n">hx</span><span class="p">)</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="p">(</span><span class="n">xi</span> <span class="o">-</span> <span class="n">hx</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span>
        <span class="n">E1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.25</span> <span class="o">*</span> <span class="n">xi</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">tau</span><span class="p">)</span>
        <span class="n">E2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">xi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Mr</span> <span class="o">*</span> <span class="n">tau</span><span class="p">))</span>
        <span class="n">E2mm</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Msp</span><span class="p">):</span>
            <span class="n">ftau</span><span class="p">[(</span><span class="n">m</span> <span class="o">+</span> <span class="n">mm</span><span class="p">)</span> <span class="o">%</span> <span class="n">Mr</span><span class="p">]</span> <span class="o">+=</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">E1</span> <span class="o">*</span> <span class="n">E2mm</span> <span class="o">*</span> <span class="n">E3</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span>
            <span class="n">E2mm</span> <span class="o">*=</span> <span class="n">E2</span>
            <span class="n">ftau</span><span class="p">[(</span><span class="n">m</span> <span class="o">-</span> <span class="n">mm</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">Mr</span><span class="p">]</span> <span class="o">+=</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">E1</span> <span class="o">/</span> <span class="n">E2mm</span> <span class="o">*</span> <span class="n">E3</span><span class="p">[</span><span class="n">mm</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">ftau</span>


<span class="k">def</span> <span class="nf">nufft_numba_fast</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1E-15</span><span class="p">,</span> <span class="n">iflag</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">"""Fast Non-Uniform Fourier Transform with Numba"""</span>
    <span class="n">Msp</span><span class="p">,</span> <span class="n">Mr</span><span class="p">,</span> <span class="n">tau</span> <span class="o">=</span> <span class="n">_compute_grid_params</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">eps</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="c"># Construct the convolved grid</span>
    <span class="n">ftau</span> <span class="o">=</span> <span class="n">build_grid_fast</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">df</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">Msp</span><span class="p">,</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Mr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Msp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>

    <span class="c"># Compute the FFT on the convolved grid</span>
    <span class="k">if</span> <span class="n">iflag</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">Ftau</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">Mr</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">ftau</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Ftau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">ftau</span><span class="p">)</span>
    <span class="n">Ftau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">Ftau</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="n">M</span><span class="o">//</span><span class="mi">2</span><span class="p">):],</span> <span class="n">Ftau</span><span class="p">[:</span><span class="n">M</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="n">M</span> <span class="o">%</span> <span class="mi">2</span><span class="p">]])</span>

    <span class="c"># Deconvolve the grid using convolution theorem</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">nufftfreqs</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">tau</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">tau</span> <span class="o">*</span> <span class="n">k</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">Ftau</span>
</pre></div>

</div>
</div>

</div>

<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<p class="prompt input_prompt">
InÂ [14]:
</p>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="n">test_nufft</span><span class="p">(</span><span class="n">nufft_numba_fast</span><span class="p">)</span>
<span class="n">test_nufft</span><span class="p">(</span><span class="n">nufft_fortran</span><span class="p">)</span>
</pre></div>

</div>
</div>

<div class="vbox output_wrapper">
<div class="output vbox">


<div class="hbox output_area"><p class="prompt"/>
<div class="box-flex1 output_subarea output_stream output_stdout">
<pre>
------------------------------
testing nufft_numba_fast
- Results match the DFT
- Execution time (M=100000): 0.06 sec
------------------------------
testing nufft_fortran
- Results match the DFT
- Execution time (M=100000): 0.047 sec

</pre>
</div>
</div>

</div>
</div>

</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>This is looking good! With a bit of effort we are now within about 25% of the Fortran speed, and we retain all the advantages of having pure Python code!</p>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="final-timing-comparison">Final Timing Comparison</h2>
<p>For good measure, let's take a look at the scaling with <span class="math">\(M\)</span> for all the fast algorithms we created. We'll compute the times for a range of input sizes for each algorithm. Be aware that the following code will take several minutes to run!</p>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<p class="prompt input_prompt">
InÂ [15]:
</p>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="o">%</span><span class="k">matplotlib</span> <span class="n">inline</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="c"># use seaborn for nice default plot settings</span>
<span class="kn">import</span> <span class="nn">seaborn</span><span class="p">;</span> <span class="n">seaborn</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
</pre></div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<p class="prompt input_prompt">
InÂ [16]:
</p>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="n">Mrange</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">18</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">t_python</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">t_numpy</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">t_numba</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">t_numba_fast</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">t_fortran</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">M</span> <span class="ow">in</span> <span class="n">Mrange</span><span class="p">:</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    
    <span class="n">t1</span> <span class="o">=</span> <span class="o">%</span><span class="k">timeit</span> <span class="o">-</span><span class="n">oq</span> <span class="n">nufft_python</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="o">%</span><span class="k">timeit</span> <span class="o">-</span><span class="n">oq</span> <span class="n">nufft_numpy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
    <span class="n">t3</span> <span class="o">=</span> <span class="o">%</span><span class="k">timeit</span> <span class="o">-</span><span class="n">oq</span> <span class="n">nufft_numba</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
    <span class="n">t4</span> <span class="o">=</span> <span class="o">%</span><span class="k">timeit</span> <span class="o">-</span><span class="n">oq</span> <span class="n">nufft_numba_fast</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
    <span class="n">t5</span> <span class="o">=</span> <span class="o">%</span><span class="k">timeit</span> <span class="o">-</span><span class="n">oq</span> <span class="n">nufft_fortran</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
    
    <span class="n">t_python</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">best</span><span class="p">)</span>
    <span class="n">t_numpy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t2</span><span class="o">.</span><span class="n">best</span><span class="p">)</span>
    <span class="n">t_numba</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t3</span><span class="o">.</span><span class="n">best</span><span class="p">)</span>
    <span class="n">t_numba_fast</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t4</span><span class="o">.</span><span class="n">best</span><span class="p">)</span>
    <span class="n">t_fortran</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t5</span><span class="o">.</span><span class="n">best</span><span class="p">)</span>
</pre></div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<p class="prompt input_prompt">
InÂ [17]:
</p>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">Mrange</span><span class="p">,</span> <span class="n">t_python</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'python'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">Mrange</span><span class="p">,</span> <span class="n">t_numpy</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'numpy'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">Mrange</span><span class="p">,</span> <span class="n">t_numba</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'numba #1'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">Mrange</span><span class="p">,</span> <span class="n">t_numba_fast</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'numba #2'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">Mrange</span><span class="p">,</span> <span class="n">t_fortran</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'fortran'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">'upper left'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Number of Elements'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'Execution Time (s)'</span><span class="p">);</span>
</pre></div>

</div>
</div>



</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>As we see, all the algorithms scale as <span class="math">\(\sim O[N\log N]\)</span> in the large <span class="math">\(N\)</span> limit, albeit with very different constants of proportionality. Our final optimized Numba implementation nearly matches the Fortran version as <span class="math">\(N\)</span> grows large, and because it is written in pure Python, it retains all the advantages of pure Python code listed above. For that benefit, I think the cost of a ~25% slow-down is well worth it!</p>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="conclusion">Conclusion</h2>
<p>I hope you've enjoyed this exploration of how to write fast numerical code in pure Python. As you think about writing efficient implementations of useful algorithms, I invite you to consider the points I listed above: in particular, how difficult will it be for your users to install, read, modify, and contribute to your code? In the long run, this may be much more important than shaving a few milliseconds off the execution time. Writing a fast implementation of a useful algorithm is an excellent and useful pursuit, but we should be careful to not forget the costs that come along with such optimization.</p>
<p>If you're interested in using the pure-Python NUFFT implementation, I've adapted much of the above code in a repository at <a href="http://github.com/jakevdp/nufftpy/">http://github.com/jakevdp/nufftpy/</a>. It contains a packaged and unit-tested version of some of the above code, as well as a (hopefully) growing compendium of related routines.</p>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p><small> This post was written entirely in the IPython notebook. You can <a href="http://jakevdp.github.io/downloads/notebooks/NUFFT.ipynb">download</a> this notebook, or see a static view <a href="http://nbviewer.ipython.org/url/jakevdp.github.io/downloads/notebooks/NUFFT.ipynb">here</a>. </small></p>
</div></div>
    </div></body></html>