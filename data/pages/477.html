<html><body><div><div class="post-819 post type-post status-publish format-standard hentry category-tips-tutorials tag-cryptography tag-django tag-email tag-newsletter tag-python tag-unsubscribe">													
			
			
			
				

													
			<p>Sometimes it is handy to allow users to change part of their profile without having to log in, as long as  we can be reasonably sure of their identity. The most common use case is to unsubscribe from email newsletters, where it is annoying to have to login first.<span id="more-819"/></p>
<p>The workflow we want to handle looks like this:<br/>
1. User clicks an unsubscribe link.<br/>
2. We verify the security token on the unsubscribe link.<br/>
3. The user gets a message saying they have been unsubscribed.</p>
<p>This workflow is pretty easy to set up using Django’s signing functions. </p>
<h2>Creating the signed url</h2>
<p>Let’s use Djanogo’s built in signing functions to create an unsubscribe link with a security token, and then create a way to verify the token. You can tuck the following code into the user profile.</p>
<pre><code class="language-python">from django.core.signing import TimestampSigner, BadSignature, SignatureExpired

    def create_unsubscribe_link(self):
        username, token = self.make_token().split(":", 1)
        return reverse('user_signups.views.unsubscribe',
                       kwargs={'username': username, 'token': token,})

    def make_token(self):
        return TimestampSigner().sign(self.user.username)

    def check_token(self, token):
        try:
            key = '%s:%s' % (self.user.username, token)
            TimestampSigner().unsign(key, max_age=60 * 60 * 48) # Valid for 2 days
        except (BadSignature, SignatureExpired):
            return False
        return True</code></pre>
<p>As long as the <code>SECRET_KEY</code> from <code>django.conf.settings</code> is kept private, it isn’t feasible for someone malicious to craft signed links. </p>
<p>While verifying the token in the unsubscribe link, we want to strike a good balance with user friendliness and security. In the common case, a user shouldn’t have to login to unsubscribe. But we also want to prevent users from being accidentally unsubscribed by others if they forward the email or otherwise make it public. Adding an expiry date to the token somewhat mitigates this risk. Above we use a 2 day expiry date.</p>
<h2>The  url pattern</h2>
<p>Now hooking up the url pattern which accepts the special characters that may appear in the token:</p>
<pre><code class="language-python">url(r'^unsubscribe/(?P&lt;username&gt;[\w.@+-]+)/(?P&lt;token&gt;[\w.:\-_=]+)/$',
     'user_signups.views.unsubscribe'),</code></pre>
<h2>The view</h2>
<pre><code class="language-python">def unsubscribe(request, username, token):
    """ 
    User is immediately unsubscribed if they are logged in as username, or
    if they came from an unexpired unsubscribe link. Otherwise, they are
    redirected to the login page and unsubscribed as soon as they log in.
    """

    user = get_object_or_404(User, username=username, is_active=True)

    if ( (request.user.is_authenticated() and request.user == user) or
         user.get_profile().check_token(token)):
       # unsubscribe them
       profile = user.get_profile()
       profile.newsletter = False
       profile.save()

       return render(request, 'registration/unsubscribe.html')
    
    # Otherwise redirect to login page
    next_url = reverse('user_signups.views.unsubscribe', 
                       kwargs={'username': username, 'token': token,})
    return HttpResponseRedirect('%s?next=%s' % (reverse('login'), next_url))</code></pre>
<h2>The templates</h2>
<p>In the email templates, use the unsubscribe link <code>{{user.get_profile.create_unsubscribe_link}}</code>.</p>
<p>Then in <code>registration/unsubscribe.html</code> add a message confirming that the user has been unsubscribed.</p>
<h2>Other notes</h2>
<p>This type of signed link could also be used to improve the customer’s flow when upgrading SaaS plans, participating in a survey, or performing some other action that updates their profile when they click on a link in an email. Depending on what they are doing, you can add an additional security layer by checking that the ip address is one they have previously used while logging in.</p>
<div class="flare-horizontal flare-position-bottom-left flare-backgroundcolor-none enablecounters" data-humbleflarecount="5">
    <span class="loading"><span/></span>
    <span class="flare-total first"><strong>8</strong> Flares</span>
    
                    <span data-type="twitter" class="flare-button button-type-twitter flare-iconstyle-round-bevel first">
            <span class="flare-button-wrap">
                <span class="flare-button-icon">Twitter</span>
            </span>
        </span>
        <span class="flare-button-count">4</span>
            
        <span class="flare-flyout flare-flyout-twitter first">
            <span class="flare-flyout-inner">
                <span class="flare-arrow"/>
            </span>
            <span class="flare-iframe-wrapper" data-code-snippet="&lt;a href=&quot;https://twitter.com/share&quot; class=&quot;twitter-share-button&quot;  data-via=&quot;grokcode&quot; &gt;Tweet&lt;/a&gt;&#10;&lt;script&gt;!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=&quot;//platform.twitter.com/widgets.js&quot;;fjs.parentNode.insertBefore(js,fjs);}}(document,&quot;script&quot;,&quot;twitter-wjs&quot;);&lt;/script&gt;"/>
        </span>
        
                    <span data-type="googleplus" class="flare-button button-type-googleplus flare-iconstyle-round-bevel">
            <span class="flare-button-wrap">
                <span class="flare-button-icon">Google+</span>
            </span>
        </span>
        <span class="flare-button-count">4</span>
            
        <span class="flare-flyout flare-flyout-googleplus">
            <span class="flare-flyout-inner">
                <span class="flare-arrow"/>
            </span>
            <span class="flare-iframe-wrapper" data-code-snippet="&lt;g:plusone&gt;&lt;/g:plusone&gt;&#10;&lt;script type=&quot;text/javascript&quot;&gt;&#10;  (function() {&#10;    var po = document.createElement(&quot;script&quot;); po.type = &quot;text/javascript&quot;; po.async = true;&#10;    po.src = &quot;https://apis.google.com/js/plusone.js&quot;;&#10;    var s = document.getElementsByTagName(&quot;script&quot;)[0]; s.parentNode.insertBefore(po, s);&#10;  })();&#10;&lt;/script&gt;"/>
        </span>
        
                    <span data-type="facebook" class="flare-button button-type-facebook flare-iconstyle-round-bevel last">
            <span class="flare-button-wrap">
                <span class="flare-button-icon">Facebook</span>
            </span>
        </span>
        <span class="flare-button-count">0</span>
            
        <span class="flare-flyout flare-flyout-facebook">
            <span class="flare-flyout-inner">
                <span class="flare-arrow"/>
            </span>
            <span class="flare-iframe-wrapper" data-code-snippet="&lt;iframe src=&quot;//www.facebook.com/plugins/like.php?href=http%3A%2F%2Fgrokcode.com%2F819%2Fone-click-unsubscribes-for-django-apps%2F&amp;send=false&amp;layout=button_count&amp;width=120&amp;show_faces=false&amp;action=like&amp;colorscheme=light&amp;font&amp;height=21&quot; scrolling=&quot;no&quot; frameborder=&quot;0&quot; overflow:hidden; width:120px; height:21px;&quot; allowTransparency=&quot;true&quot;&gt;&lt;/iframe&gt;"/>
        </span>
        
        
        
    <span class="flare-total last"><strong>8</strong> Flares</span>

    <span class="close">
        <a href="#close">×</a>
    </span>
</div>
			

			                        		</div>				
		
			
							    	
	</div></body></html>