<html><body><div><article class="post-content">
      <p class="ig_inline_container ig_the_content ig_before"/><p><strong>Introduction</strong></p>
<p>CAPTCHA has been implemented for decades to prevent automated scripts (Bots) from jamming registration or login pages. Even though tons of tools and research have exposed its weakness with the ability to reverse the image into plain text, plenty of insecure images are still out there being used on sensitive login pages such as online banking!</p>
<p>Believe it or not, today we will discuss a real world example on how to crack a login page for one of the biggest leading banks in the Middle East!<strong> </strong></p>
<p/>
<p><strong>Optical Character Recognition (OCR)</strong></p>
<p>In short, OCR is a technology that allows you to convert scanned images of text into plain text. This enables your script to read the text and submit it into a login form just like a human action.</p>
<p>OCR engine has been developed into many kinds of object oriented OCR applications, such as invoice OCR and legal billing document OCR. However here it will be used in defeating CAPTCHA anti-bot systems.</p>
<p>Under Linux, Tesseract is the most accurate OCR, even though it lacks graphical interface (GUI) – Only CLI is needed to accomplish our purpose. Installing Tesseract is very straight forward, under Ubuntu distribution, issue:</p>
<pre class="brush: python; title: ; notranslate" title="">
hkhrais@Hkhrais:~$ sudo apt-get install tesseract-ocr
</pre>
<p><strong>Preparing images for Tesseract</strong></p>
<p>Tesseract is not very flexible about the format of its input images. It will only accept TIFF images. According to user reports, compressed TIFF images are quite problematic, and the same goes for grey-scale and color images. So you’re better off with single-bit uncompressed TIFF images.</p>
<p>The process to prepare them with GIMP is very simple:</p>
<ol>
<li>Go to the Image→Mode menu and make sure the image is in RGB or Grayscale mode.</li>
<li>Select from the menu Tools→Color Tools→Threshold and choose an adequate threshold value.</li>
<li>Select from the menu Image→Mode→Indexed and from the options choose 1-bit and no dithering.</li>
<li>Save the image in TIFF format with a .tif extension.</li>
</ol>
<p>Note: Version 3.x includes layout analysis, and if compiled with Leptonica, supports all image formats Leptonica supports. However, to increase results efficiency, we will replicate the above steps automatically using Python script to clean the image noise, concentrate colors, and eventually submit the output image into Tesseract.</p>
<p><span><strong>Parsing CAPTCHA image</strong></span></p>
<p><strong>**Disclaimer: Below are an exact samples taken from the login page of X bank without any modification**</strong></p>
<p><img src="http://2we26u4fam7n16rz3a44uhbe1bq2.wpengine.netdna-cdn.com/wp-content/uploads/091514_1415_CaseStudyCr1.jpg" alt=""/> <img src="http://2we26u4fam7n16rz3a44uhbe1bq2.wpengine.netdna-cdn.com/wp-content/uploads/091514_1415_CaseStudyCr2.jpg" alt=""/> <img src="http://2we26u4fam7n16rz3a44uhbe1bq2.wpengine.netdna-cdn.com/wp-content/uploads/091514_1415_CaseStudyCr3.jpg" alt=""/></p>
<p><img src="http://2we26u4fam7n16rz3a44uhbe1bq2.wpengine.netdna-cdn.com/wp-content/uploads/091514_1415_CaseStudyCr4.jpg" alt=""/><img src="http://2we26u4fam7n16rz3a44uhbe1bq2.wpengine.netdna-cdn.com/wp-content/uploads/091514_1415_CaseStudyCr5.jpg" alt=""/></p>
<p>We can see the following are common factors in each image:</p>
<p>-All images contain only 4 numbers [Written in English]</p>
<p>-Number color is black</p>
<p>-There are no alphabet letters</p>
<p>-There is no rotation for the numbers [One angle only]</p>
<p>-All the numbers are in a single line</p>
<p>-The noise ‘which is the line that crossing the numbers’ can be removed with some image processing techniques.</p>
<p>Almost every image editor, such as Gimp, can clean these images from noise and concentrate the numbers to be ready for OCR. With quick threshold tuning for colors concentrating in Gimp, we got the following cleaned image:</p>
<p><img src="http://2we26u4fam7n16rz3a44uhbe1bq2.wpengine.netdna-cdn.com/wp-content/uploads/091514_1415_CaseStudyCr6.png" alt=""/></p>
<p>Now the above output is ready to be used in OCR to print out the numbers. Obviously this step needs to be done automatically by our script.</p>
<p><strong>Automating the process</strong></p>
<p>Assuming our script will navigate to X bank login page, download the CAPTCHA image to a directory <span>‘/home/hkhrais/Desktop/Downloaded_CAPTCHA/’</span>. The image preparation process would be:</p>
<pre class="brush: python; title: ; notranslate" title="">
from PIL import Image
import os
import time

def main():

    getlist = os.listdir("/home/hkhrais/Desktop//Downloaded_CAPTCHA/")
    number = int (len(getlist))
    for cap in range(1,number+1):
        crack(str(cap))
</pre>
<p>The script starts with getting a list of downloaded CAPTCHA images saved in <span>“/home/hkhrais/Desktop//Downloaded_CAPTCHA/” </span>and passing the image name to a function called <span>crack</span>.</p>
<p><img src="http://2we26u4fam7n16rz3a44uhbe1bq2.wpengine.netdna-cdn.com/wp-content/uploads/091514_1415_CaseStudyCr7.png" alt=""/></p>
<pre class="brush: python; title: ; notranslate" title="">
def crack(cap_name):

    img = Image.open('/home/hkhrais/Desktop/Downloaded_CAPTCHA/'+cap_name+'.JPEG')
    img = img.convert("RGB")
    pixdata = img.load()

    for y in xrange(img.size[1]):
        for x in xrange(img.size[0]):
            if pixdata[x, y][0] &lt; 90:
                pixdata[x, y] = (0, 0, 0, 255)
    for y in xrange(img.size[1]):
        for x in xrange(img.size[0]):
            if pixdata[x, y][1] &lt; 136:                 pixdata[x, y] = (0, 0, 0, 255)     for y in xrange(img.size[1]):         for x in xrange(img.size[0]):             if pixdata[x, y][2] &gt; 0:
                pixdata[x, y] = (255, 255, 255, 255)
    ext = ".tif"
    img.save("/home/hkhrais/Desktop/Cleaned_CAPTCHA/"+cap_name + ext)
</pre>
<p>First, the crack function will load the image into <span>img </span>object, then convert it into RGB mode (remember the process to prepare an image for Tesseract?). The three For iterators are purely an image processing, which will make the numbers much bolder and clean the background noise to white. The cleaned .<span>tif </span>images are saved in<span> /home/hkhrais/Desktop/Cleaned_CAPTCHA/</span>. The output would be:</p>
<p><img src="http://2we26u4fam7n16rz3a44uhbe1bq2.wpengine.netdna-cdn.com/wp-content/uploads/091514_1415_CaseStudyCr8.png" alt=""/></p>
<pre class="brush: python; title: ; notranslate" title="">
    command = "tesseract -psm 7 /home/hkhrais/Desktop/Cleaned_CAPTCHA/"+cap_name +".tif "+"/home/hkhrais/Desktop/text"
    os.system(command)
    time.sleep(1)

    Text  = open ("/home/hkhrais/Desktop/text.txt","r")
    decoded = Text.readline().strip('\n')
    if decoded.isdigit():
        print '[+}CAPTCHA number are ' + decoded
    else:
        print '[-] Error : Not able to decode'
</pre>
<p>One of the weak points mentioned earlier was all the numbers are in single line; Tesseract has a plenty of options for specifying the page/image segmentation mode. In our case here we need to specify segmentation mode number 7 which will treat the image as a single text line.</p>
<p>pagesegmode values are:</p>
<p>0 = Orientation and script detection (OSD) only.<br/>
1 = Automatic page segmentation with OSD.<br/>
2 = Automatic page segmentation, but no OSD, or OCR<br/>
3 = Fully automatic page segmentation, but no OSD. (Default)<br/>
4 = Assume a single column of text of variable sizes.<br/>
5 = Assume a single uniform block of vertically aligned text.<br/>
6 = Assume a single uniform block of text.<br/>
<span>7 = Treat the image as a single text line.<br/>
</span>8 = Treat the image as a single word.<br/>
9 = Treat the image as a single word in a circle.<br/>
10 = Treat the image as a single character.</p>
<p>The command line for Tesseract is simple:</p>
<pre class="brush: python; title: ; notranslate" title="">
#tesseract  [-psm # ]   &lt;input type="text" /&gt;   &lt;output for=""&gt;
</pre>
<p>The second part of the secript is to increase the efficiency of our script. As we saw, all the images contain only numbers, so if Tesseract’s output was a special character or alphabetic letter, then definitely it’s an error! And before submitting the wrong value to the login page, we technically can discard it and submit the next image. <span>Isdigit<span>() </span>function will take care of this portion.</span></p>
<pre class="brush: python; title: ; notranslate" title="">
hkhrais@Hkhrais:~$ sudo python /home/hkhrais/Desktop/decoder.py
[sudo] password for hkhrais:

[+}CAPTCHA number are 5905

[-] Error : Not able to decode

[+}CAPTCHA number are 7588

[+}CAPTCHA number are 6864

[+}CAPTCHA number are 2939

[+}CAPTCHA number are 9536
</pre>
<p><strong>Countermeasures</strong></p>
<p>-Use a complex CAPTCHA, below are good examples, salting with alphabet letters with some rotations are always good.</p>
<p>-Don’t count on CAPTCHA only, step-2 authentication (token) is a perfect option to add as well.</p>


<p><strong>References</strong></p>
<p>• Optical character recognition</p>
<p><a href="http://en.wikipedia.org/wiki/Optical_character_recognition"><span>http://en.wikipedia.org/wiki/Optical_character_recognition</span></a></p>
<p>• Tesseract-OCR</p>
<p><a href="http://code.google.com/p/tesseract-ocr/"><span>http://code.google.com/p/tesseract-ocr/</span></a></p>
<p>• Tesseract usage</p>
<p><a href="https://help.ubuntu.com/community/OCR"><span>https://help.ubuntu.com/community/OCR#Tesseract</span></a></p>
<p>• Python OCR</p>
<p><a href="http://blog.c22.cc/2010/10/12/python-ocr-or-how-to-break-captchas/">http://blog.c22.cc/2010/10/12/python-ocr-or-how-to-break-captchas/</a></p>
<p class="ig_inline_container ig_the_content ig_after"/>
          </article>
    </div></body></html>