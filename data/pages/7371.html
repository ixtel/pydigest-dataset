<html><body><div><div class="post-text" itemprop="text">
<p>I think you are trying to attack the problem the wrong way. </p>

<p>First yes, it is possible to get the adjacent markdown cell in really hackish way that would not work in headless notebook execution.</p>

<p>What you want to do is use IPython cell magics, that allow arbitrary syntax as long as the cell start with 2 percent sign + and identifier.</p>

<p>Typically you want SQL cells. </p>

<p>You can refer to the documentation about <a href="http://ipython.readthedocs.org/en/stable/config/custommagics.html">cells magics</a>
or I can show you how to build that :</p>

<pre><code>from IPython.core.magic import  (
    Magics, magics_class, cell_magic, line_magic
)

@magics_class
class StoreSQL(Magics):


    def __init__(self, shell=None,  **kwargs):
        super().__init__(shell=shell, **kwargs)
        self._store = []
        # inject our store in user availlable namespace under __mystore
        # name
        shell.user_ns['__mystore'] = self._store

    @cell_magic
    def sql(self, line, cell):
        """store the cell in the store"""
        self._store.append(cell)

    @line_magic
    def showsql(self, line):
        """show all recorded statements"""
        print(self._store)

    ## use ipython load_ext mechanisme here if distributed
    get_ipython().register_magics(StoreSQL)
</code></pre>

<p>Now you can use SQL syntax in your python cells: </p>

<pre><code>%%sql 
select * from foo Where QUX Bar
</code></pre>

<p>a second cell:</p>

<pre><code>%%sql
Insert Cheezburger into Can_I_HAZ
</code></pre>

<p>check what we executed (the 3 dashes show the input /output delimitation, you do not have to type them):</p>

<pre><code>%showsql
---
['select * from foo Where QUX Bar', 'Insert Cheezburger into Can_I_HAZ']
</code></pre>

<p>And what you asked at the beginning in your question:</p>

<pre><code> mysql.query(__mystore[-1])
</code></pre>

<p>This of course does require that you execute the previous cells in the right order, nothing prevent you from using the <code>%%sql</code> syntax to name your cells, e.g if <code>_store</code> is a <code>dict</code>, or better a class where you overwrite <code>__getattr__</code>, to act like <code>__getitem__</code> to access fields with dot syntax . This is left as an exercise to the reader, or end see of the response:</p>

<pre><code>@cell_magic
def sql(self, line, cell):
    """store the cell in the store"""
    self._store[line.strip()] = cell
</code></pre>

<p>you can then use sql cell like </p>

<pre><code>%%sql A1
set foo TO Bar where ID=9
</code></pre>

<p>And then in your Python cells</p>

<pre><code>mysql.execute(__mystore.A1)
</code></pre>

<p>I would also strongly suggest looking at Catherine Develin SqlMagic for <a href="https://github.com/catherinedevlin/ipython-sql">IPython</a>, and this <a href="https://gist.github.com/Carreau/02e754e4948efdccf048">Notebook gist</a> on GitHub that show this all thing live.</p>

<p>In the comment you seem to say you want to add <code>pig</code>, nothing prevent you from having a <code>%%pig</code> magic neither. It is also possible to inject Javascript to enable correct Syntax Highlighting of SQL and PIG, but that's beyond the scope of this question. </p>
    </div>
    </div></body></html>