<html><body><div><div class="content html_format">
      <img src="https://habrastorage.org/files/2a3/d81/137/2a3d81137cca4753b89ca341f034a7a2.png" align="left"/><p> СУБД Neo4j — это NoSQL база данных, ориентированная на хранение графов. Изюминкой продукта является декларативный язык запросов Cypher.
</p><p>
Cypher позаимствовал ключевые слова типа WHERE, ORDER BY из SQL; синтаксис из таких разных языков как Python, Haskell, SPARQL; и в результате появился язык, позволяющий делать запросы к графам в визуальной форме наподобие </p><a href="https://en.wikipedia.org/wiki/ASCII_art">ASCII art</a><p>. Например, заголовок данной статьи я бы представил в виде графа </p><b>(Neo4j) — [изучаем] -&gt; (Wordnet)</b><p>. И это почти готовый запрос к базе данных!

</p>
<a name="habracut"/><p>
Для изучения граф-ориентированной базы данных нужен какой-нибудь граф. Это может быть социальная сеть, дамп википедии или схема железных дорог. Мы пойдём простым путём и воспользуемся огромным общедоступным графом лексической базы </p><a href="http://wordnet.princeton.edu/">Wordnet</a><p>. Лингвисты из Принстона проделали гигантскую работу по систематизации словарного запаса английского языка, а энтузиасты перевели базу данных на многие языки, включая русский. Например, в этой базе свыше 80 тысяч существительных, связанных между собой лексическими отношениями, такими как «синоним», «часть большего», «материал для» и т. п. Эта база является естественным графом, и мы её импортируем в Neo4j.

</p><h2>Установка Neo4j</h2><p>
Процесс установки для разных ОС описан на </p><a href="http://neo4j.com/docs/stable/server-installation.html">сайте</a><p>. Всё описываемое здесь ПО платформенно-независимое, но для определенности все инструкции будут для Debian/Ubuntu.

</p><h3>1. Добавить репозиторий</h3>
<pre><code class="bash">wget -O - https://debian.neo4j.org/neotechnology.gpg.key | sudo apt-key add -
echo 'deb http://debian.neo4j.org/repo stable/' &gt;/tmp/neo4j.list
sudo mv /tmp/neo4j.list /etc/apt/sources.list.d
sudo apt-get update
</code></pre>
<h3>2. Установить Neo4j (community edition)</h3>
<pre><code class="bash">sudo apt-get install neo4j
</code></pre><p>
Эта команда установит ПО в вашу домашнюю директорию и запустит сервис, который будет работать от имени пользователя neo4j.

</p><h3>3. Разрешить удалённый доступ</h3><p>
Если вы установили Neo4j на свой компьютер, этот шаг пропустите. Если же требуется доступ к серверу с других компьютеров в локальной сети, отредактируйте файл /var/lib/neo4j/conf/neo4j-server.properties
</p><p>
Для доступа с любого компьютера локальной сети установите параметры:

</p><pre><code>org.neo4j.server.webserver.address=0.0.0.0
dbms.security.auth_enabled=false
</code></pre><p>
По умолчанию используется порт 7474, изменить порт можно, добавив строку в тот же файл:

</p><pre><code>org.neo4j.server.webserver.port=7474
</code></pre><p>
Обратите внимание, что мы не настроили безопасность СУБД! Более подробно читайте </p><a href="http://neo4j.com/docs/stable/server-configuration.html">инструкцию</a><p>.
</p><p>
Проверить установку можно, набрав в браузере адрес и порт сервера. Neo4j реализует роскошную графическую консоль через браузер. Через этот же порт идут REST-запросы к базе от клиентского программного обеспечения, которое мы установим на следующем шаге.

</p><h2>Установка клиента (Python)</h2><p>
Для того, чтобы импортировать базу Wordnet в Neo4j, воспользуемся скриптом на Питоне. 

</p><h3>1. Сначала нужно установить библиотеку <a href="http://py2neo.org/2.0/">py2neo</a></h3>
<pre><code>pip install py2neo
</code></pre>
<h3>2. Скачайте с гитхаба мой <a href="https://github.com/sergey-zarealye-com/wordnet2neo4j">скрипт</a></h3>
<pre><code class="bash">mkdir habrawordnet2neo4j
cd habrawordnet2neo4j
git clone https://github.com/sergey-zarealye-com/wordnet2neo4j.git
</code></pre><p>
Скрипт вряд-ли претендует на промышленное качество кода, но если вы захотите поэкспериментировать с Neo4j из Питона, то просмотрите код, это поможет вам быстрее начать программировать.

</p><h2>Получение лексической базы данных Wordnet</h2><p>
На странице </p><a href="http://wordnet.princeton.edu/wordnet/download/">Download</a><p> проекта Wordnet предлагается скачать базу вместе с программным обеспечением для её просмотра. Но мы-то хотим использовать для просмотра Neo4j! Поэтому достаточно скачать только файлы с данными:

</p><p>
Разархивируйте файлы в доступное место.

</p><h2>Импорт данных в Neo4j</h2><p>
Лексические данные в Wordnet лежат в файлах по частям речи. Например, существительные находятся в файле data.noun; глаголы — в data.verb; а с другими частями речи я и не пробовал.

</p><h3>1. Импорт существительных</h3><p>
Для импорта существительных перейдите в директорию, куда поместили мои скрипты (мы ее назвали просто habrawordnet2neo4j) и выполните команду в консоли:

</p><pre><code class="bash">python wordnet2neo4j.py -i rwn3/data.noun --neo4j http://127.0.0.1:7474 --nodelabel Ruswordnet --reltype Pointer --encoding cp1251 --limit 1000
</code></pre><p>
Давайте разберём параметры поподробнее.

</p><pre>
-i		путь к файлу данных Wordnet
--neo4j		URL сервера базы данных Neo4j
--nodelabel	Метка узлов, соответствующих словам Wordnet 
		в создаваемом графе (в Neo4j узлы графа снабжают 
		текстовыми метками; это просто идентификатор)
--reltype	Тип ребер графа, соответствующих указателям Wordnet 
		(в Neo4j ребра графа могут иметь тип; это просто 
		идентификатор)
--encoding	Кодировка файла данных; русскоязычная база записана 
		в кодировке cp1251; для англоязычных файлов этот 
		параметр не нужно указывать
--limit		Максимальное количество обрабатываемых строк файла; 
		дело в том, что мой скрипт работает довольно медленно, 
		и чтобы попробовать можно ограничить объем импортируемых 
		данных, например первыми 1000 строками файла; для импорта 
		полного файла этот параметр не нужно указывать, 
		и приготовьтесь подождать час-полтора.
</pre>

<h3>2. Импорт глаголов</h3><p>
Для импорта глаголов выполните команду в консоли:

</p><pre><code class="bash">python wordnet2neo4j.py -i rwn3/data.verb --neo4j http://127.0.0.1:7474 --nodelabel Ruswordnet --reltype Pointer --encoding cp1251 --limit 1000
</code></pre><p>
Импортировать глаголы необязательно, хотя некоторые из них связаны с существительными, и это интересно поизучать.

</p><h3>3. Убедитесь, что данные импортированы</h3><p>
Для этого откройте в браузере консоль Neo4j (введите адрес и порт сервера СУБД) и введите следующий запрос:

</p><pre><code>MATCH (node)-[relation]-() RETURN node, relation LIMIT 100
</code></pre><p>
Если получили в экране изображение графа, то все прошло успешно.

</p><h2>Выполняем простые запросы</h2><p>
Все дальнейшие действия будем выполнять в браузере, в консоли Neo4j. Я буду считать, что в качестве меток узлов вы использовали Ruswordnet, а в качестве типа рёбер Pointer (как указано в предыдущем разделе). И что вы импортировали именно русскую базу Wordnet </p><b><i>целиком</i></b><p>.

</p><h3>1. Hello World</h3><p>
Как указано на сайте русской базы </p><a href="http://wordnet.ru/">Wordnet</a><p>, переведены около половины смысловых единиц, содержащих самые общеупотребимые слова. Поэтому попробуем найти в базе первое, что пришло в голову:

</p><pre><code>MATCH (n:Ruswordnet {name: "выкапывание_трупа"}) RETURN n
</code></pre><p>
Выполните запрос, убедитесь, что это понятие найдено, значит, по мнению российских лингвистов, оно входит в число самых общеупотребимых. Давайте разберём этот простой запрос.
</p><p>
Ключевое слово </p><b>MATCH</b><p> означает примерно то же самое, что SELECT в SQL. Грубо говоря, «найти подходящие к шаблону элементы графа».
</p><p>
Круглыми скобками обозначаются узлы графа. Шаблон </p><b>(n:Ruswordnet)</b><p> обозначал бы, что мы хотим найти все узлы с меткой «Ruswordnet». Здесь </p><b>n</b><p> — идентификатор, можно сказать «переменная».  
</p><p>
Узлы графа (и рёбра тоже) можно снабжать произвольными атрибутами. Чтобы найти конкретный узел, мы задали в запросе условие на атрибуты в формате, похожем на JSON: </p><b>{name: «выкапывание_трупа»}</b><p>. Таким образом, фраза 

</p><pre><code>MATCH (n:Ruswordnet {name: "выкапывание_трупа"})
</code></pre><p>
означает, что из всего графа будут выбраны все узлы с меткой Ruswordnet и атрибутом name равным указанному там понятию.
</p><p>
Ключевое слово </p><b>RETURN</b><p> говорит нам, какие переменные нас интересуют. В данном случае мы хотели просто увидеть узел (узлы), соответствующие заданным условиям, поэтому пишем </p><b>RETURN n</b><p>. Важно понимать, что </p><b>n</b><p> — это коллекция узлов, удовлетворяющих запросу. Чтобы убедиться в этом, просто замените понятие в запросе:

</p><pre><code>MATCH (n:Ruswordnet {name: "лев"}) RETURN n
</code></pre><p>
Если вы импортировали базу Wordnet целиком, вы увидите шесть узлов понятий «лев». Давайте разберёмся, почему.

</p><h3>2. Переменные = коллекции</h3><p>
Выполним такой запрос:

</p><pre><code>match (n:Ruswordnet {name: "лев"})--(m) return n,m
</code></pre><p>
Здесь мы задали уже более сложный шаблон для поиска. Мы хотим найти все узлы</p><b> (n)</b><p>, соответствующие понятию «лев», а также все узлы </p><b>(m)</b><p>, связанные с львами. Связь, т. е. ребро графа обозначается двумя дефисами. Можно в явном виде указывать интересующее нас направление символом --&gt; (это я и называл ASCII art).

</p><img src="https://habrastorage.org/files/c10/5f6/d27/c105f6d271c64151af1adc59cf859f10.png"/>
<p>
Если у вас не отображаются имена смысловых единиц, нажмите на кнопку Ruswordnet(23) в левом верхнем углу графа, и в строке состояния внизу консоли выберите «name» в поле Caption. Так будет нагляднее.
</p><p>
Теперь мы поняли, что лев это, оказывается не только болгарская валюта (bulgarian_money), копейкой для которой является стотинка, но и большая кошка, и созвездие, астрологический знак, и что-то, связанное с гордостью.

</p><h3>3. Подключаем рёбра</h3> <p>
В базе Wordnet ребра называются указателями (Pointer), и используется большое количество лингвистических типов указателей. Они обозначаются символами, некоторые из которых я привожу в таблице:
</p><table>
<tr>
<th>Символ</th>
<th>Английское наименование лингвистического отношения</th>
<th>Лингвистическое отношение</th>
</tr>
<tr>
<td>!</td>
<td>Antonym</td>
<td>Антоним</td>
</tr>
<tr>
<td>@</td>
<td>Hypernym</td>
<td>Обобщение</td>
</tr>
<tr>
<td>@i</td>
<td>Instance Hypernym</td>
<td>Экземпляр обобщения</td>
</tr>
<tr>
<td> ~</td>
<td>Hyponym</td>
<td>Уточнение</td>
</tr>
<tr>
<td> ~i</td>
<td>Instance Hyponym</td>
<td>Экземпляр уточнения</td>
</tr>
<tr>
<td>#m</td>
<td>Member holonym</td>
<td>Понятие, включающее в себя данное понятие</td>
</tr>
<tr>
<td>#s</td>
<td>Substance holonym</td>
<td>Вещество, из которого состоит предмет</td>
</tr>
<tr>
<td>#p</td>
<td>Part holonym</td>
<td>Предмет, включающий в себя как часть данный предмет</td>
</tr>
<tr>
<td>%m</td>
<td>Member meronym</td>
<td>Часть более общего понятия</td>
</tr>
<tr>
<td>%s</td>
<td>Substance meronym</td>
<td>Из какого вещества состоит предмет</td>
</tr>
<tr>
<td>%p</td>
<td>Part meronym</td>
<td>Часть предмета</td>
</tr>
<tr>
<td>=</td>
<td>Attribute</td>
<td>Атрибут</td>
</tr>
<tr>
<td>+</td>
<td>Derivationally related form</td>
<td>Производная форма</td>
</tr>
</table><p>
В процессе импорта мы присвоили рёбрам графа атрибут pointer_symbol, и теперь можем делать запросы с учётом атрибутов рёбер. Давайте разберемся, что такое обобщение (hypernum):

</p><pre><code>MATCH (n:Ruswordnet {name: "лев"})-[p:Pointer {pointer_symbol: "@"}]-&gt;(m) 
RETURN n,m
</code></pre><p>
Квадратными скобками обозначаются спецификации рёбер. В этом запросе мы хотим найти рёбра типа Pointer, атрибут которых pointer_symbol равен «@» т. е. символу обобщения. Кстати, противоположный обобщению символ уточнения «~».

</p><img src="https://habrastorage.org/files/76b/b3b/879/76bb3b879fce400fbb8eca34cf5ad670.png"/>
<p>
Теперь понятно, что обобщение для льва это кот, а также человек. Конечно, речь идет о разных смысловых единицах: лев (кот) это один узел графа, а лев (человек) — другой узел, соответствующий знаку зодиака. Лев (известность) — это результат плохого перевода на русский; имеется в виду лев (celebrity), т. е. знаменитость, светский лев.
</p><p>
Давайте разберемся, что такое part holonym:

</p><pre><code>MATCH (n:Ruswordnet {name: "лев"})-[p:Pointer {pointer_symbol: "#p"}]-&gt;(m) 
RETURN n,m
</code></pre><p>
А, теперь понятно: лев входит в зодиак в качестве составной части, значит зодиак является part holonym для льва.
</p><p>
Из таблицы видно, что Wordnet содержит много интересных отношений, например, из каких веществ что сделано. К сожалению, нет информации, что лев сделан из мяса, поэтому поставим вопрос по другому: найти такие узлы графа, которые связаны отношением «из какого вещества сделано».

</p><pre><code>MATCH (n)-[p:Pointer {pointer_symbol: "#s"}]-&gt;(m) 
RETURN n,m LIMIT 10
</code></pre><p>
В этом запросе мы не накладываем никаких условий на узлы </p><b>(n)</b><p> и </p><b>(m)</b><p>. Мы только хотим, чтобы их связывали рёбра с атрибутом «#s». Обратите внимание, появилось ключевое слово </p><b>LIMIT</b><p>, знакомое нам из SQL. Если бы его здесь не было, сервер вернул бы нам очень много результатов, и плохо было бы нашему браузеру.
</p><p>
В результате запроса мы узнали, что сигареты состоят из марихуаны, а суп из воловьих хвостов — из воловьих хвостов.

</p><h3>4. Цепочки произвольной длины</h3><p>
В детстве все играли в такую игру: превратить муху в слона. Для этого нужно было менять по одной букве в слове, пока слово МУХА не превратилось в слово СЛОН. Давайте узнаем в лексическом графе, связаны ли между собой ЛЕВ и ОВЦА.
</p><pre><code>MATCH (n:Ruswordnet {name: "лев"})-[p:Pointer*1..3]-(m:Ruswordnet {name: "овца"}) 
RETURN n,m,p
</code></pre><p>
Конструкция </p><b>[p:Pointer*1..3]</b><p> говорит, что требуется найти цепочку рёбер типа Pointer длиной от одного до трех, связывающую узел «лев» с узлом «овца».

</p><img src="https://habrastorage.org/files/eaf/4e5/bc9/eaf4e5bc956646e59915ab82978225b1.png"/>
<p>
Это отличается от классической детской игры, но тоже интересно: ОВЦА — ПРОСТАК — ЧЕЛОВЕК — ЛЕВ… это звучит гордо. Кстати, можно попытаться найти связь и между мухой и слоном, только немного увеличить предельную длину цепочки. Я использовал значение 6. Кстати, не пытайтесь сразу поставить 100 — процесс поиска скорее всего сорвется т. к. число вариантов для перебора путей в графе будет слишком велико. Итак, вот как связаны слон и муха лексически:

</p><img src="https://habrastorage.org/files/fad/4e9/0ca/fad4e90ca6c84d328c59f386eb8b0cf0.png"/>
<p>
Думаю, на этом этапе вы многое поняли о базе данных Neo4j, и способны самостоятельно открыть много интересного в базе данных Wordnet, а может применить Neo4j в своих проектах. Мы применяем связку Neo4j c Wordnet в системе поиска по киноархивам. Если вы хотите заниматься исследованиями в области машинного обучения, приглашаю на стажировку или на постоянную работу в НИКФИ — научно-исследовательский кинофотоинститут.

      
      </p><p class="clear"/>
    </div>

    
  </div></body></html>