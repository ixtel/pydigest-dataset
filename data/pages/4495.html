<html><body><div><div>
<p>
Итак, нам потребуется: </p><b>$10 в месяц</b><p> на оплату собственного VPS (на нем же можно хостить MVP вашего стартапа, и еще много всякого - например VPN-шлюз для маскировки под американскую компанию), 2 опсосных проекта и некоторое количество свободного времени.
</p><p>
<br/></p>
<div>
<a href="https://about.gitlab.com/" target="_blank">Gitlab</a><p> - это такой открытый Github у вас на сервере. Можно конечно обойтись </p><a href="https://bitbucket.org/" target="_blank">Bitbucket'ом</a><p> с </p><a href="https://confluence.atlassian.com/display/BITBUCKET/Bitbucket+Teams" target="_blank">закрытой группой</a><p> (team), но это во первых не круто =), а во-вторых, стартап должен параноидально охранять свою супер новую уникальную социальную сеть "Водноклассников Мир".</p></div>
<p>
<br/></p>
<div>
<a href="https://jenkins-ci.org/" target="_blank">Jenkins</a><p> - инструмент непрерывной интеграции, написанный на Java. Есть много разных альтернатив, но вот что нужно запомнить про них про все (субъективно):</p></div>
<div>
<ul>
<li>если инструмент имеет продвинутый функционал - он написан на java</li>
<li>если инструмент написан не на java, скорее всего из коробки он умеет очень мало, а настройка всего дополнительного - боль</li>
<li>настройка любых метрик в любой CI - это тоже боль</li>
<li>каждая команда имеет свой совершенно уникальный процесс разработки, нет двух одинаковых CI-процессов</li>
<li>каждая команда стремится создать свой уникальный deploy-процесс, но автоматизировать нужно только то, в чем админы реально не принимают никакого участия (читай: и не несут никакой ответственности). Выкладка новой версии внутренней python-библиотеки в закрытый репозиторий компании - хороший пример такой работы</li>
<li>и самое главное: невозможно один раз настроить CI и никогда больше к нему не возвращаться. Поддержание работоспособности CI - это отдельная настоящая работа, которой тоже нужно заниматься. Постоянно. Правда, всё потраченное время и силы вернутся сторицей.</li>
</ul>
<div>
<a href="https://www.digitalocean.com/?refcode=e16041a7fe90" target="_blank">Digital Ocean</a><p> (DO) - очень модный продавец VPS'ок, который держит нос исключительно "по ветру". Цены у них может быть и не самые низкие, но: API, хранение и дистрибуция слепков, куча дата-центров по всему миру, и настройка в один клик - безусловно доставляют.</p></div>
<p>
<br/></p>
<p>
Теперь о том, как все это соединить без напрягов.</p>
</div>
<p>
<br/></p>
<p>
<b>1. Создаем сервер с GitLab на борту при помощи one-click-install</b></p>
<div><p>
Не вижу никакого смысла повторять или переводить туториал написанный DO: </p><a href="https://www.digitalocean.com/community/tutorials/how-to-use-the-gitlab-one-click-install-image-to-manage-git-repositories" target="_blank">How To Use the GitLab One-Click Install Image to Manage Git Repositories</a><p>.</p><p>
DO не рекомендует устанавливать Gitlab на дроплет за 5 долларов - слишком уж мало там памяти. $10 - будет вполне достаточно. Но если очень хочется сэкономить, можно просто увеличить </p><a href="https://www.digitalocean.com/community/tutorials/how-to-add-swap-on-ubuntu-14-04" target="_blank">swap</a><p> - для машинки с такими утилитарными задачами LA не критичен, как по мне. При заходе на one-click install с регистрации вам не дадут использовать $5 дроплет для gitlab, но если зарегистрироваться и уже из кабинета начать создавать дроплет (точно так, как описано в tutorial выше), то такого ограничения нет.</p></div>
<p>
<br/></p>
<p>
<b>2. Устанавливаем Jenkins.</b></p>

<p>
По умолчанию Jenkins попытается использовать порт 8080, который уже занял gitlab. Нужно в файле /etc/default/jenkins заменить этот порт на какой-нибудь другой. Например, 9090.</p>
<p>
<br/></p>
<p>
Далее, наверняка захочется настроить для jenkins какое-нибудь приятное доменное имя, например ci.v-odnoklassnikov-moi-mir.ru. Для этого нам вполне хватит nginx, который установился вместе с gitlab. Его настройки лежат в каталоге /var/opt/gitlab/nginx/conf/.</p>
<div><p>
Создадим файл /var/opt/gitlab/nginx/conf/jenkins.conf с содержимым из туториала jenkins: </p><a href="https://wiki.jenkins-ci.org/display/JENKINS/Jenkins+behind+an+NGinX+reverse+proxy">Jenkins behind an NGinX reverse proxy</a><p>. Обратите внимание, что в нашем случае proxy_pass смотрит на "http://localhost:9090/;".</p></div>
<div><p>
Только что написанный конфиг нужно "подцепить" в nginx GitLab'а. Данный процесс описан </p><a href="https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/doc/settings/nginx.md#inserting-custom-settings-into-the-nginx-config">тут</a><p>. Суть статьи по ссылке: нужно в файле /etc/gitlab/gitlab.rb, добавить строку:
</p><div class="hlcode">
<div class="syntax">
<pre>nginx<span class="o">[</span><span class="s1">'custom_nginx_config'</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"include /var/opt/gitlab/nginx/conf/jenkins.conf;"</span></pre>
</div>
</div><p>
Не уверен, что файл  /var/opt/gitlab/nginx/conf/jenkins.conf не похерится во время обновления gitlab. Будем посмотреть...</p></div>
<p>
<br/></p>
<p>
Вот и все. В этом посте осознанно не останавливаюсь на настройках проектов в Jenkins, чтобы не ограничиваться целями конкретного проекта / платформы. Я использую дженкинс для авто-тестов python-проектов, но в нем есть все для тестирования мобильных приложений и еще много-много всякого.</p>
<p>
Думаю, полезно было бы рассказать как при запросах на мердж jenkins умеет создавать отдельные проекты и тесты, как здорово использовать хуки gitlab'а, чтобы всегда иметь актуальную картину тестов, но все этом потом.</p>
<p>
<br/></p>
<p>
P. S. В комментах к посту помимо "&lt;все не так&gt;" и "&lt;я тоже умный&gt;" прошу написать: <b>что еще по теме поста интересно лично тебе, мой дорогой подписчик?</b></p>
<p>
<br/></p>
</div>
</div></body></html>