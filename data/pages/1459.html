<html><body><div><div class="section" id="py2xml-experimental">
<h2>py2xml (<em>Experimental</em>)<a class="headerlink" href="#py2xml-experimental" title="Permalink to this headline">¶</a></h2>
<p><cite>py2xml</cite> convert python code to XML.</p>
<p>All source-code text, including white-space and comments, are preserved.
The XML can be converted back to python creating the exact same source.</p>
<p>The design was inspired by <a class="reference external" href="http://www.srcml.org/">srcML</a>.
In order to get the original source code you just need to remove
all XML tags.</p>
<p>The goal is to use the XML for querying / analysis of the code.
And to perform code transformation/refactoring, and then
convert it back to python.</p>
<p>Why use XML instead of AST? AST does not preserve comments and
source code formatting. There are many available tools to manipulate
XML. XML is nice format for query and transformation - just do not use XSLT ;)</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">As of release 0.2, <cite>py2xml</cite> creates a XML preserving all formating.
But not much tough was given in creating a XML for easy querying and
transformation (it mostly follows the AST nodes).
So, expect the XML format to completely change in future releases.</p>
</div>
<div class="section" id="example">
<h3>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h3>
<p>A simple python module...</p>
<div class="highlight-python"><div class="highlight"><pre><span class="sd">"""Example module to test pyRegurgitator"""</span>

<span class="n">__version__</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">hi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Hi, this is Foo'</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">add_4</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">num</span>


<span class="k">class</span> <span class="nc">Bar</span><span class="p">(</span><span class="n">Foo</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'foobar'</span><span class="p">)</span>
</pre></div>
</div>
<p>Converting to XML:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> py2xml sample.py &gt; sample.py.xml
</pre></div>
</div>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;Module&gt;&lt;Expr&gt;&lt;Str&gt;&lt;s&gt;</span>"""Example module to test pyRegurgitator"""<span class="nt">&lt;/s&gt;&lt;/Str&gt;&lt;/Expr&gt;</span>

<span class="nt">&lt;Assign&gt;&lt;targets&gt;&lt;Name</span> <span class="na">ctx=</span><span class="s">"Store"</span> <span class="na">name=</span><span class="s">"__version__"</span><span class="nt">&gt;</span>__version__<span class="nt">&lt;/Name&gt;</span> = <span class="nt">&lt;/targets&gt;</span>(<span class="nt">&lt;Tuple</span> <span class="na">ctx=</span><span class="s">"Load"</span><span class="nt">&gt;&lt;Num&gt;</span>0<span class="nt">&lt;/Num&gt;</span>, <span class="nt">&lt;Num&gt;</span>1<span class="nt">&lt;/Num&gt;</span>, <span class="nt">&lt;Num&gt;</span>0<span class="nt">&lt;/Num&gt;&lt;/Tuple&gt;</span>)<span class="nt">&lt;/Assign&gt;</span>


<span class="nt">&lt;ClassDef</span> <span class="na">name=</span><span class="s">"Foo"</span><span class="nt">&gt;</span>class Foo:<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;FunctionDef</span> <span class="na">name=</span><span class="s">"hi"</span><span class="nt">&gt;</span>def hi<span class="nt">&lt;arguments&gt;</span>(<span class="nt">&lt;arg</span> <span class="na">name=</span><span class="s">"self"</span><span class="nt">&gt;</span>self<span class="nt">&lt;/arg&gt;</span>):<span class="nt">&lt;/arguments&gt;&lt;body&gt;</span>
        <span class="nt">&lt;Expr&gt;&lt;Call&gt;&lt;func&gt;&lt;Name</span> <span class="na">ctx=</span><span class="s">"Load"</span> <span class="na">name=</span><span class="s">"print"</span><span class="nt">&gt;</span>print<span class="nt">&lt;/Name&gt;&lt;/func&gt;</span>(<span class="nt">&lt;args&gt;&lt;Str&gt;&lt;s&gt;</span>'Hi, this is Foo'<span class="nt">&lt;/s&gt;&lt;/Str&gt;&lt;/args&gt;</span>)<span class="nt">&lt;/Call&gt;&lt;/Expr&gt;&lt;/body&gt;&lt;/FunctionDef&gt;</span>

    <span class="nt">&lt;FunctionDef</span> <span class="na">name=</span><span class="s">"add_4"</span><span class="nt">&gt;&lt;decorator&gt;</span>@<span class="nt">&lt;Name</span> <span class="na">ctx=</span><span class="s">"Load"</span> <span class="na">name=</span><span class="s">"staticmethod"</span><span class="nt">&gt;</span>staticmethod<span class="nt">&lt;/Name&gt;&lt;/decorator&gt;</span>
    def add_4<span class="nt">&lt;arguments&gt;</span>(<span class="nt">&lt;arg</span> <span class="na">name=</span><span class="s">"num"</span><span class="nt">&gt;</span>num<span class="nt">&lt;/arg&gt;</span>):<span class="nt">&lt;/arguments&gt;&lt;body&gt;</span>
        <span class="nt">&lt;Return&gt;</span>return <span class="nt">&lt;BinOp&gt;&lt;Num&gt;</span>4<span class="nt">&lt;/Num&gt;&lt;Add&gt;</span> + <span class="nt">&lt;/Add&gt;&lt;Name</span> <span class="na">ctx=</span><span class="s">"Load"</span> <span class="na">name=</span><span class="s">"num"</span><span class="nt">&gt;</span>num<span class="nt">&lt;/Name&gt;&lt;/BinOp&gt;&lt;/Return&gt;&lt;/body&gt;&lt;/FunctionDef&gt;&lt;/body&gt;&lt;/ClassDef&gt;</span>


<span class="nt">&lt;ClassDef</span> <span class="na">name=</span><span class="s">"Bar"</span><span class="nt">&gt;</span>class Bar<span class="nt">&lt;arguments&gt;</span>(<span class="nt">&lt;base&gt;&lt;Name</span> <span class="na">ctx=</span><span class="s">"Load"</span> <span class="na">name=</span><span class="s">"Foo"</span><span class="nt">&gt;</span>Foo<span class="nt">&lt;/Name&gt;&lt;/base&gt;</span>)<span class="nt">&lt;/arguments&gt;</span>:<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;FunctionDef</span> <span class="na">name=</span><span class="s">"bar"</span><span class="nt">&gt;</span>def bar<span class="nt">&lt;arguments&gt;</span>(<span class="nt">&lt;arg</span> <span class="na">name=</span><span class="s">"self"</span><span class="nt">&gt;</span>self<span class="nt">&lt;/arg&gt;</span>):<span class="nt">&lt;/arguments&gt;&lt;body&gt;</span>
        <span class="nt">&lt;Expr&gt;&lt;Call&gt;&lt;func&gt;&lt;Name</span> <span class="na">ctx=</span><span class="s">"Load"</span> <span class="na">name=</span><span class="s">"print"</span><span class="nt">&gt;</span>print<span class="nt">&lt;/Name&gt;&lt;/func&gt;</span>(<span class="nt">&lt;args&gt;&lt;Str&gt;&lt;s&gt;</span>'foobar'<span class="nt">&lt;/s&gt;&lt;/Str&gt;&lt;/args&gt;</span>)<span class="nt">&lt;/Call&gt;&lt;/Expr&gt;&lt;/body&gt;&lt;/FunctionDef&gt;&lt;/body&gt;&lt;/ClassDef&gt;</span>
<span class="nt">&lt;/Module&gt;</span>
</pre></div>
</div>
<p>The XML can be converted back to source using the command line:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> py2xml --reverse sample.py.xml &gt; new_sample.py
</pre></div>
</div>
</div>
<div class="section" id="example-query">
<h3>Example - query<a class="headerlink" href="#example-query" title="Permalink to this headline">¶</a></h3>
<p>Example to print out all classes and their method names.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># print all module class and its method names</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="kn">as</span> <span class="nn">ET</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s">'_sample/sample.py.xml'</span><span class="p">)</span>

<span class="c"># get all classes from module</span>
<span class="k">for</span> <span class="n">classdef</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">'/ClassDef'</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'class '</span><span class="p">,</span> <span class="n">classdef</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'name'</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">funcdef</span> <span class="ow">in</span> <span class="n">classdef</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">'./body/FunctionDef'</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'  '</span><span class="p">,</span> <span class="n">funcdef</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'name'</span><span class="p">))</span>
</pre></div>
</div>
<p>Results in:</p>
<div class="highlight-python"><div class="highlight"><pre>class  Foo
   hi
   add_4
class  Bar
   bar
</pre></div>
</div>
</div>
<div class="section" id="example-transform">
<h3>Example - transform<a class="headerlink" href="#example-transform" title="Permalink to this headline">¶</a></h3>
<p>In this example the variable <cite>__version__</cite> is programmatically
set to a new value.
Then the modified code is written back to plain python code.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="sd">"""change the value assigned to a variable `__version__`"""</span>

<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="kn">as</span> <span class="nn">ET</span>


<span class="c"># parse XML document</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s">'_sample/sample.py.xml'</span><span class="p">)</span>

<span class="c"># get node for assignment</span>
<span class="n">assign</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">"/Assign/targets/Name[@name='__version__']/../.."</span><span class="p">)</span>
<span class="c"># in an assignment the value is on the second node</span>
<span class="n">assign</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">assign</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">new_val</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s">'value'</span><span class="p">)</span>
<span class="n">new_val</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">'0, 2, 0'</span>
<span class="n">new_val</span><span class="o">.</span><span class="n">tail</span> <span class="o">=</span> <span class="s">')'</span>
<span class="n">assign</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span>

<span class="c"># save the contents in a new file</span>
<span class="n">source</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">getroot</span><span class="p">(),</span> <span class="n">encoding</span><span class="o">=</span><span class="s">'unicode'</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">'text'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</pre></div>
</div>
<p>Results in:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="sd">"""Example module to test pyRegurgitator"""</span>

<span class="n">__version__</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">hi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Hi, this is Foo'</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">add_4</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">num</span>


<span class="k">class</span> <span class="nc">Bar</span><span class="p">(</span><span class="n">Foo</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'foobar'</span><span class="p">)</span>
</pre></div>
</div>
<p>Note how we just set the text of new content without creating XML nodes
for a <cite>tuple</cite> structure. Since the conversion from XML to python is done
just by removing the XML tags, and we won’t do any other transformation
we can just insert the new python code text!</p>
</div>
<div class="section" id="implementation-and-known-limitations">
<h3>Implementation and known limitations<a class="headerlink" href="#implementation-and-known-limitations" title="Permalink to this headline">¶</a></h3>
<p>The implementation uses a combination of the python modules <cite>ast</cite> and <cite>tokenize</cite>.
Together they give all information necessary, code structure and formatting.</p>
<p>The current implementation fails to convert the python code to XML
in the following situations:</p>
<blockquote>
<div><ul class="simple">
<li>if the source code uses an encoding different than ascii or unicode</li>
<li>source contains page-breaks (tokenize module does not handle
page-break)</li>
<li>expressions wrapped in 2 or more parenthesis. This is tricky to handle
correctly, specially because of bugs in the AST column offset information.
2 parenthesis is useless and seldom used in practice, so we just advise users
to remove the extra parenthesis.</li>
</ul>
</div></blockquote>
<p>From the command line you can check if <cite>py2xml</cite> is capable of a lose-less
round-trip (python -&gt; XML -&gt; python) using the <cite>–check</cite> option.
No output means it is OK, otherwise you get an error or a diff.</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> py2xml --check my_module.py
</pre></div>
</div>
</div>
</div>
</div></body></html>