<html><body><div><article>
        <h1>Associating Django users with their sessions</h1>

        <p>When writing a Django application that authenticates users using sessions, you’ll often want to have some way of finding all of the active sessions for a particular user.
An example use case might be finding all existing user sessions and deleting them after a password change, ensuring there isn’t anyone still able to access your site via an old login session.</p>

<p>Ultimately, you’d want to be able to do something like this:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">delete_user_sessions</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="n">user</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</code></pre></div>
<p>This is a bit difficult with out-of-the-box Django, as session data is stored as a serialised hash, with no direct association with a particular user.</p>

<figure>
    <img src="/img/posts/django-sessions-table.bd9b.png" alt="Screenshot showing the Django sessions table." title="Example data from the default django_session table."/>
    <figcaption>Example data from the default `django_session` table.</figcaption>
</figure>

<p>One solution is to iterate through every single stored session, deserialise the data it contains, and search the user ID from the extracted data against the ID of the user we’re concerned with.
This method is obviously quite inefficient and on a system with many concurrent sessions, things can get pretty slow - we’re doing a full table scan every time.</p>

<h2>Possible solutions</h2>

<p>A couple of alternate solutions were proposed in <a href="http://stackoverflow.com/questions/235950/how-to-lookup-django-session-for-a-particular-user">this Stack Overflow thread</a>:</p>

<ol>
<li>Use the user’s <code>last_login_date</code> to restrict the scope of the full table scan when searching for matching sessions; or</li>
<li>Add a <code>user_id</code> parameter to the <code>django_session</code> table (through forking the <code>django.contrib.session</code> code).</li>
</ol>

<p>The first solution doesn’t really solve the performance issue of iterating and deserialising.
It also feels like we could run in to trouble if we make a mistake calculating the date range to search across, or if we decided to change the expiration length for our sessions.</p>

<p>The second solution is better, but it’s a bit of a code smell as we’re duplicating core Django code.
Not only is the duplication itself poor coding practice, we’re going to be overriding any future updates to <code>django.contrib.session</code> that are shipping with newer versions of Django.</p>

<h2>Proposed solution</h2>

<p>My solution for this works on the assumption that you’re only concerned with logged-in user sessions (ie, you’re not worried about anonymous user sessions), which should be the most common case.</p>

<p>It’s also assumes that you’re using either <code>django.contrib.sessions.backends.db</code> or <code>django.contrib.sessions.backends.cached_db</code> as your <code>SESSION_ENGINE</code>.
<code>django.contrib.sessions.backends.db</code> is the default with Django, so if you haven’t changed anything on this front, you’re all set.</p>

<p>First, we create a database model to link a <code>User</code> to a <code>Session</code>: </p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>

<span class="kn">from</span> <span class="nn">django.contrib.sessions.models</span> <span class="kn">import</span> <span class="n">Session</span>


<span class="k">class</span> <span class="nc">UserSession</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">AUTH_USER_MODEL</span><span class="p">)</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Session</span><span class="p">)</span>    
</code></pre></div>
<p>Then, we simply save an instance of this mapping model every time a user logs in, through the use of Django’s <code>user_logged_in</code> signal.</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">django.contrib.auth.signals</span> <span class="kn">import</span> <span class="n">user_logged_in</span>


<span class="k">def</span> <span class="nf">user_logged_in_handler</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">UserSession</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">user</span><span class="p">,</span>
        <span class="n">session_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">session_key</span>
    <span class="p">)</span>


<span class="n">user_logged_in</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">user_logged_in_handler</span><span class="p">)</span>
</code></pre></div>
<p>That’s really all we need to do to keep the user associated with their sessions.
Now, we can implement <code>delete_user_sessions()</code> like this:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">UserSession</span>

<span class="k">def</span> <span class="nf">delete_user_sessions</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="n">user_sessions</span> <span class="o">=</span> <span class="n">UserSession</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">user_session</span> <span class="ow">in</span> <span class="n">user_sessions</span><span class="p">:</span>
        <span class="n">user_session</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</code></pre></div>
<p>Because of the way Django’s <code>ForeignKey</code> relations work on deletion, calling <code>user_session.session.delete()</code> will also remove the associated <code>UserSession</code> object.
This will also be the case if you’re cleaning up expired sessions through a cron job or similar.</p>


        <aside id="sharer">
            <h3>Share this</h3>
            
        </aside>

        <p class="byline byline-bottom">
            Published <time pubdate="" datetime="2014-09-28 00:00:00 +0200">28 Sep 2014</time>
        </p>
    </article>

</div></body></html>