<html><body><div><tr>
<td class="gutter">







</td>
<td>

  <div id="description">
  <p>This implements nonlocal in Python 2...albeit in a slightly ugly way. Tested with CPython 2.7 and PyPy.</p>

  </div>
  
  <div id="blocks">
  
    <div id="block-0" class="block">
    
      
      <div class="codeblock">
      <table class="highlighttable"><tr><td class="linenos"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115</pre></td><td class="code"><div class="highlight"><pre><span class="k">import</span> <span class="nn">inspect</span><span class="o">,</span> <span class="nn">types</span><span class="o">,</span> <span class="nn">dis</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">'export_nonlocals'</span><span class="p">,</span> <span class="s">'nonlocals'</span><span class="p">]</span>

<span class="c"># http://www.jonathon-vogel.com/posts/patching_function_bytecode_with_python/</span>
<span class="k">def</span> <span class="nf">find_code</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mf">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">f</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">i</span>
        <span class="k">elif</span> <span class="n">code</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">dis</span><span class="o">.</span><span class="n">HAVE_ARGUMENT</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mf">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mf">3</span>

<span class="c"># http://nedbatchelder.com/blog/201301/byterun_and_making_cells.html</span>
<span class="k">def</span> <span class="nf">make_cell</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">x</span><span class="p">)(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">func_closure</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>

<span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dis</span><span class="o">.</span><span class="n">opmap</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">export_nonlocals</span><span class="p">(</span><span class="o">*</span><span class="nb">vars</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="n">code</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">ord</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_code</span><span class="p">)</span>
        <span class="n">varnames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">)</span>
        <span class="n">names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_names</span><span class="p">)</span>
        <span class="n">cf</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">,</span><span class="n">i</span><span class="p">:</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="n">LOAD_FAST</span><span class="p">,</span><span class="n">STORE_FAST</span><span class="p">)</span> <span class="ow">and</span> <span class="n">varnames</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mf">1</span><span class="p">]]</span> <span class="ow">in</span> <span class="nb">vars</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">find_code</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">cf</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">code</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">LOAD_NAME</span> <span class="k">if</span> <span class="n">code</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">LOAD_FAST</span> <span class="k">else</span> <span class="n">STORE_NAME</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">varnames</span><span class="p">[</span><span class="n">code</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mf">1</span><span class="p">]]</span>
            <span class="n">code</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mf">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">code</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mf">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">varnames</span><span class="o">.</span><span class="n">__contains__</span><span class="p">,</span> <span class="n">names</span><span class="p">)):</span>
            <span class="n">varnames</span><span class="p">[</span><span class="n">varnames</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">var</span><span class="p">)]</span> <span class="o">=</span> <span class="s">'__anon_var_</span><span class="si">%d</span><span class="s">'</span> <span class="o">%</span> <span class="n">i</span>
        <span class="n">rescode</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">CodeType</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_argcount</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_nlocals</span><span class="p">,</span>
                                 <span class="n">f</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_stacksize</span><span class="p">,</span>
                                 <span class="n">f</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_flags</span><span class="o">^</span><span class="mf">0</span><span class="n">x01</span><span class="p">,</span>
                                 <span class="s">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">chr</span><span class="p">,</span> <span class="n">code</span><span class="p">)),</span> <span class="n">f</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_consts</span><span class="p">,</span>
                                 <span class="nb">tuple</span><span class="p">(</span><span class="n">names</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">varnames</span><span class="p">),</span>
                                 <span class="n">f</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_filename</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span>
                                 <span class="n">f</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_firstlineno</span><span class="p">,</span>
                                 <span class="n">f</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_lnotab</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_freevars</span><span class="p">,</span>
                                 <span class="n">f</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_cellvars</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">(</span><span class="n">rescode</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">func_globals</span><span class="p">,</span> <span class="n">__ns</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
                                  <span class="n">f</span><span class="o">.</span><span class="n">func_name</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">func_defaults</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">func_closure</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">func</span>

<span class="k">def</span> <span class="nf">nonlocals</span><span class="p">(</span><span class="o">*</span><span class="nb">vars</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="n">caller</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mf">1</span><span class="p">][</span><span class="mf">0</span><span class="p">]</span>
        <span class="n">caller_vars</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">f_globals</span>
        <span class="n">caller_vars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">caller</span><span class="o">.</span><span class="n">f_locals</span><span class="p">)</span>
        <span class="n">code</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">ord</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_code</span><span class="p">)</span>
        <span class="n">varmap</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">freevars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_freevars</span><span class="p">)</span>
        <span class="n">freec</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">freevars</span><span class="p">)</span>
        <span class="n">freeoffs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_cellvars</span><span class="p">)</span>
        <span class="n">varnames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">)</span>
        <span class="n">closure</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">func_closure</span> <span class="ow">or</span> <span class="p">[])</span>
        <span class="n">names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_names</span><span class="p">)</span>
        <span class="n">consts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_consts</span><span class="p">)</span>
        <span class="n">fglobals</span> <span class="o">=</span> <span class="p">{</span><span class="s">'__nonlocal_plocals'</span><span class="p">:</span> <span class="n">caller</span><span class="o">.</span><span class="n">f_locals</span><span class="p">}</span>
        <span class="n">names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">fglobals</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">plocals_pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span><span class="o">-</span><span class="mf">1</span>
        <span class="n">offs</span> <span class="o">=</span> <span class="mf">0</span>
        <span class="k">def</span> <span class="nf">cf</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="n">LOAD_FAST</span><span class="p">,</span> <span class="n">STORE_FAST</span><span class="p">)</span> <span class="ow">and</span> <span class="n">varnames</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mf">1</span><span class="p">]]</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">dis</span><span class="o">.</span><span class="n">hasjabs</span><span class="p">:</span>
                <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mf">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">offs</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">find_code</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">cf</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">code</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">LOAD_DEREF</span> <span class="k">if</span> <span class="n">code</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">LOAD_FAST</span> <span class="k">else</span> <span class="n">STORE_DEREF</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">varnames</span><span class="p">[</span><span class="n">code</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mf">1</span><span class="p">]]</span>
            <span class="n">code</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mf">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">freevars</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">code</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mf">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">freevars</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">freevars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
            <span class="n">code</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mf">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">freeoffs</span>
            <span class="k">if</span> <span class="n">code</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">STORE_DEREF</span> <span class="ow">and</span> <span class="n">caller_vars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'__ns'</span><span class="p">)</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">const_id</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">consts</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">const_id</span> <span class="o">=</span> <span class="n">consts</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">consts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
                <span class="n">code</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">DUP_TOP</span><span class="p">)</span>
                <span class="n">code</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mf">4</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="mf">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">LOAD_GLOBAL</span><span class="p">,</span> <span class="n">plocals_pos</span><span class="p">,</span> <span class="mf">0</span><span class="p">,</span>
                    <span class="n">LOAD_CONST</span><span class="p">,</span> <span class="n">const_id</span><span class="p">,</span> <span class="mf">0</span><span class="p">,</span>
                    <span class="n">STORE_SUBSCR</span>
                <span class="p">]</span>
                <span class="n">offs</span> <span class="o">+=</span> <span class="mf">4</span>
        <span class="n">nlocals</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">freevars</span><span class="p">)</span><span class="o">-</span><span class="n">freec</span><span class="o">+</span><span class="n">f</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_nlocals</span>
        <span class="n">closure</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">make_cell</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="n">caller_vars</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">,</span>
                                       <span class="n">freevars</span><span class="p">[</span><span class="n">freec</span><span class="p">:])))</span>
        <span class="n">rescode</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">CodeType</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_argcount</span><span class="p">,</span> <span class="n">nlocals</span><span class="p">,</span>
                                 <span class="n">f</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_stacksize</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_flags</span><span class="p">,</span>
                                 <span class="s">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">chr</span><span class="p">,</span> <span class="n">code</span><span class="p">)),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">consts</span><span class="p">),</span>
                                 <span class="nb">tuple</span><span class="p">(</span><span class="n">names</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">varnames</span><span class="p">),</span>
                                 <span class="n">f</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_filename</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span>
                                 <span class="n">f</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_firstlineno</span><span class="p">,</span>
                                 <span class="n">f</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_lnotab</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">freevars</span><span class="p">),</span>
                                 <span class="n">f</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_cellvars</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">(</span><span class="n">rescode</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">func_globals</span><span class="p">,</span> <span class="o">**</span><span class="n">fglobals</span><span class="p">),</span>
                                  <span class="n">f</span><span class="o">.</span><span class="n">func_name</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">func_defaults</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">closure</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">func</span>
</pre></div>
</td></tr></table>
      </div>
    
    </div>
  
    <div id="block-1" class="block">
    
      <div class="proseblock">
      <p>This module is a nonlocal patch for Python 2.7 and PyPy. Save it as nonlocals.py. Here's a first example:</p>

<pre class="prettyprint"><code>from nonlocals import *

def outer():
    var = 0
    @nonlocals('var')
    def inner():
        print var
        var = 1
        print var
    inner()
outer()
</code></pre>

<p>That prints:</p>

<pre class="prettyprint"><code>0
1
</code></pre>

<p>Without nonlocals, this prints:</p>

<pre class="prettyprint"><code>Traceback (most recent call last):
  File "ex1.py", line 11, in &lt;module&gt;
    outer()
  File "ex1.py", line 10, in outer
    inner()
  File "ex1.py", line 7, in inner
    print var
UnboundLocalError: local variable 'var' referenced before assignment
</code></pre>

<p>However, right now, changes to <code>var</code> made in <code>inner</code> don't propagate to <code>outer</code>. Example:</p>

<pre class="prettyprint"><code>from nonlocals import *

def outer():
    var = 0
    @nonlocals('var')
    def inner():
        print var
        var = 1
        print var
    inner()
    print var
outer()
</code></pre>

<p>That prints:</p>

<pre class="prettyprint"><code>0
1
0
</code></pre>

<p>This is largely because of the way Python does certain things. In order to get around it, use <code>export_nonlocals</code>:</p>

<pre class="prettyprint"><code>from nonlocals import *

@export_nonlocals('var')
def outer():
    var = 0
    @nonlocals('var')
    def inner():
        print var
        var = 1
        print var
    inner()
    print var
outer()
</code></pre>

<p><code>export_nonlocals</code> sets up variables so they can be modified from <code>inner</code>. Now, it prints:</p>

<pre class="prettyprint"><code>0
1
1
</code></pre>

<p>How it works:</p>

<p><code>export_nonlocals</code> changes all local variable references in a way so that they modified by other scopes by replacing LOAD_FAST and STORE_FAST codes that modify the given variables to LOAD_NAME and STORE_NAME, moving the variable reference to external names, and using bitwise NOT to change the compile flags. <code>nonlocals</code> works by changing LOAD_FAST and STORE_FAST codes that modify the given variables with LOAD_DEREF and STORE_DEREF and modifying <code>outer</code>'s locals if <code>export_nonlocals</code> was used.</p>

<p>This is very hackish and plays with CPython internal implementation stuff that PyPy just happens to be compatible with. YOU WERE WARNED!!!</p>

      </div>
    
    </div>
  
  </div>
  
  
  
  
  

</td></tr></div></body></html>