<html><body><div><div id="article_text">
    <p>The whole playbook from this blog post can be seen in this <a class="reference external" href="https://gist.github.com/marklit/3a562cd7b53f54abdaf5">gist</a>.</p>
<p><a class="reference external" href="http://www.ansible.com/home">Ansible</a> is a Python-based tool for automating application deployment and infrastructure setups. It's often compared with Capistrano, chef, puppet and fabric. These comparisons don't always compare apples to apples as each tool has their own distinctive capabilities and philosophy as to how best automate deployments and system setups. Flexibility and conciseness of describing tasks varies widely between tools as well.</p>
<p>I've had to use every tool mentioned above at one time or another for various clients. What I like most about Ansible is that it keeps playbooks concise while not abstracting anything away. Some tools try to hide the differences between <cite>apt-get install</cite> and <cite>yum install</cite> but I found these abstractions made for a steeper learning curve and made out-of-the-ordinary changes take longer to get working.</p>
<p>Ansible can be installed via <cite>pip</cite> and just needs an inventory file to begin being useful.</p>
<p>For this post I try to keep Ansible's files to a minimum. You can organise playbooks into <a class="reference external" href="https://github.com/packetbeat/packetbeat-deploy">separate files</a>, setup <a class="reference external" href="https://galaxy.ansible.com/list#/roles/2068">Travis CI to test your playbooks</a> and so on but for the sake of simplicity I stick to the task of getting a load-balanced, two-node Django cluster setup with as few lines of code as I could.</p>
<div class="section" id="a-cluster-of-machines">
<h2>A cluster of machines</h2>
<p>I launched three Ubuntu 14.04 virtual machines on my workstation, configured them with the user <cite>mark</cite>, identical passwords and sudo access. I then added the three virtual machine IP addresses to my hosts file:</p>
<div class="highlight"><pre><span class="nv">$ </span>grep <span class="m">192</span> /etc/hosts
192.168.223.131 web1
192.168.223.132 web2
192.168.223.133 lb
</pre></div>
<p>I copied my SSH public key to the <cite>~/.ssh/authorized_keys</cite> file on each VM:</p>
<div class="highlight"><pre><span class="nv">$ </span>ssh-copy-id web1
<span class="nv">$ </span>ssh-copy-id web2
<span class="nv">$ </span>ssh-copy-id lb
</pre></div>
<p>I then made sure each host's ECDSA key fingerprint was stored in my <cite>~/.ssh/known_hosts</cite> file by connecting to each host:</p>
<div class="highlight"><pre><span class="nv">$ </span>ssh lb uptime
<span class="nv">$ </span>ssh web1 uptime
<span class="nv">$ </span>ssh web1 uptime
</pre></div>
</div>
<div class="section" id="running-ansible-with-an-inventory">
<h2>Running Ansible with an inventory</h2>
<p>I installed Ansible:</p>
<div class="highlight"><pre><span class="nv">$ </span>pip install <span class="nv">ansible</span><span class="o">==</span>1.7.2
</pre></div>
<p>And created an inventory file:</p>
<div class="highlight"><pre><span class="nv">$ </span>cat inventory
<span class="o">[</span>load_balancers<span class="o">]</span>
lb <span class="nv">ansible_ssh_host</span><span class="o">=</span>lb

<span class="o">[</span>app_servers<span class="o">]</span>
web1 <span class="nv">ansible_ssh_host</span><span class="o">=</span>web1
web2 <span class="nv">ansible_ssh_host</span><span class="o">=</span>web2
</pre></div>
<p>The first token is the host alias used by Ansible, the second token is the connection instruction for Ansible. I had already created web1, web2 and lb in my <cite>/etc/hosts</cite> file so I simply referred to those hostnames.</p>
<p>With an inventory file in place it's possible to test that Ansible can connect and communicate with each node in the cluster:</p>
<div class="highlight"><pre><span class="nv">$ </span>ansible all -i inventory -a uptime
lb <span class="p">|</span> success <span class="p">|</span> <span class="nv">rc</span><span class="o">=</span><span class="m">0</span> &gt;&gt;
 09:07:18 up  7:18,  <span class="m">2</span> users,  load average: 0.05, 0.03, 0.05

web2 <span class="p">|</span> success <span class="p">|</span> <span class="nv">rc</span><span class="o">=</span><span class="m">0</span> &gt;&gt;
 09:07:18 up  7:19,  <span class="m">2</span> users,  load average: 0.01, 0.02, 0.05

web1 <span class="p">|</span> success <span class="p">|</span> <span class="nv">rc</span><span class="o">=</span><span class="m">0</span> &gt;&gt;
 09:07:19 up  7:23,  <span class="m">2</span> users,  load average: 0.00, 0.01, 0.05
</pre></div>
</div>
<div class="section" id="a-cluster-of-configuration-files">
<h2>A cluster of configuration files</h2>
<p>Ansible will need to deploy configuration files, keys and certificates to our cluster. Below is the file and folder layout of this project:</p>
<div class="highlight"><pre><span class="nv">$ </span>tree
.
├── files
│   ├── nginx-app.conf
│   ├── nginx-load-balancer.conf
│   ├── nginx.crt
│   ├── nginx.key
│   ├── ntp.conf
│   ├── supervisord.conf
│   └── venv_activate.sh
├── inventory
└── playbook.yml
</pre></div>
</div>
<div class="section" id="ssl-terminating-load-balancer">
<h2>SSL-terminating load balancer</h2>
<p>To create <cite>files/nginx.crt</cite> and <cite>files/nginx.key</cite> I generated a self-signed SSL certificate using <cite>openssl</cite>. The certificate won't be of much use to https clients that verify certificates against trusted authorities but it's useful for demonstrating ssl termination by the load balancer in a local environment.</p>
<div class="highlight"><pre><span class="nv">$ </span>openssl req -x509 -nodes -days <span class="m">365</span> <span class="se">\</span>
  -newkey rsa:2048 <span class="se">\</span>
  -keyout files/nginx.key <span class="se">\</span>
  -out files/nginx.crt
...
Common Name <span class="o">(</span>e.g. server FQDN or YOUR name<span class="o">)</span> <span class="o">[]</span>:localhost
...
</pre></div>
<p>There are two distinctive nginx configurations in this setup: the first is for the load balancer and the second is for the app servers.</p>
<p>I chose nginx for the load balancer as it supports SSL, caching and handles <a class="reference external" href="https://www.youtube.com/watch?v=yQvcHy_tPjI">app servers restarting</a> more gracefully than haproxy.</p>
<div class="highlight"><pre><span class="nv">$ </span>cat files/nginx-load-balancer.conf
upstream app_servers  <span class="o">{</span>
  <span class="o">{</span>% <span class="k">for</span> host in groups<span class="o">[</span><span class="s1">'app_servers'</span><span class="o">]</span> %<span class="o">}</span>
      server <span class="o">{{</span> hostvars<span class="o">[</span>host<span class="o">][</span><span class="s1">'ansible_eth0'</span><span class="o">][</span><span class="s1">'ipv4'</span><span class="o">][</span><span class="s1">'address'</span><span class="o">]</span> <span class="o">}}</span> <span class="nv">fail_timeout</span><span class="o">=</span>5s<span class="p">;</span>
  <span class="o">{</span>% endfor %<span class="o">}</span>
<span class="o">}</span>

server <span class="o">{</span>
  listen         80<span class="p">;</span>
  server_name    localhost<span class="p">;</span>
  <span class="k">return</span>         <span class="m">301</span> https://<span class="nv">$server_name$request_uri</span><span class="p">;</span>
<span class="o">}</span>

server <span class="o">{</span>
  listen 443<span class="p">;</span>
  server_name localhost<span class="p">;</span>

  ssl on<span class="p">;</span>
  ssl_certificate /etc/nginx/ssl/nginx.crt<span class="p">;</span>
  ssl_certificate_key /etc/nginx/ssl/nginx.key<span class="p">;</span>

  location / <span class="o">{</span>
    proxy_pass  http://app_servers<span class="p">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>The nginx config for the app servers simply proxies requests to gunicorn:</p>
<div class="highlight"><pre><span class="nv">$ </span>cat files/nginx-app.conf
server <span class="o">{</span>
  listen 80<span class="p">;</span>
  server_name localhost<span class="p">;</span>

  location / <span class="o">{</span>
    proxy_pass  http://127.0.0.1:8000<span class="p">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="section" id="keeping-clocks-in-sync">
<h2>Keeping clocks in sync</h2>
<p>I wanted to keep the clocks on each node in the cluster in sync so I created an NTP configuration file. I choose the European pool but there are pools all around the world listed the <a class="reference external" href="http://www.pool.ntp.org/en/">NTP pool project</a> site.</p>
<div class="highlight"><pre><span class="nv">$ </span>cat files/ntp.conf
server 0.europe.pool.ntp.org
server 1.europe.pool.ntp.org
server 2.europe.pool.ntp.org
server 3.europe.pool.ntp.org
</pre></div>
<p>If you wanted to use the North American pool you could replace the contents with the following:</p>
<div class="highlight"><pre>server 0.north-america.pool.ntp.org
server 1.north-america.pool.ntp.org
server 2.north-america.pool.ntp.org
server 3.north-america.pool.ntp.org
</pre></div>
</div>
<div class="section" id="managing-gunicorn-and-celeryd">
<h2>Managing gunicorn and celeryd</h2>
<p>I'll use supervisor to run the Django app server and celery task queue. The files below have a number of variables in them, Ansible will transform them when it deploys them.</p>
<div class="highlight"><pre><span class="nv">$ </span>cat files/supervisord.conf
<span class="o">[</span>program:web_app<span class="o">]</span>
<span class="nv">autorestart</span><span class="o">=</span><span class="nb">true</span>
<span class="nv">autostart</span><span class="o">=</span><span class="nb">true</span>
<span class="nb">command</span><span class="o">={{</span> home_folder <span class="o">}}</span>/.virtualenvs/<span class="o">{{</span> venv <span class="o">}}</span>/exec gunicorn faulty.wsgi:application -b 127.0.0.1:8000
<span class="nv">directory</span><span class="o">={{</span> home_folder <span class="o">}}</span>/faulty
<span class="nv">redirect_stderr</span><span class="o">=</span>True
<span class="nv">stdout_logfile</span><span class="o">={{</span> home_folder <span class="o">}}</span>/faulty/supervisor.log
<span class="nv">user</span><span class="o">=</span>mark

<span class="o">[</span>program:celeryd<span class="o">]</span>
<span class="nv">autorestart</span><span class="o">=</span><span class="nb">true</span>
<span class="nv">autostart</span><span class="o">=</span><span class="nb">true</span>
<span class="nb">command</span><span class="o">={{</span> home_folder <span class="o">}}</span>/.virtualenvs/<span class="o">{{</span> venv <span class="o">}}</span>/exec python manage.py celeryd
<span class="nv">directory</span><span class="o">={{</span> home_folder <span class="o">}}</span>/faulty
<span class="nv">redirect_stderr</span><span class="o">=</span>True
<span class="nv">stdout_logfile</span><span class="o">={{</span> home_folder <span class="o">}}</span>/faulty/supervisor.log
<span class="nv">user</span><span class="o">=</span>mark
</pre></div>
<p>I also need a bash file that will activate the virtualenv used by Django:</p>
<div class="highlight"><pre><span class="nv">$ </span>cat files/venv_activate.sh
<span class="c">#!/bin/bash</span>
<span class="nb">source</span> <span class="o">{{</span> home_folder <span class="o">}}</span>/.virtualenvs/<span class="o">{{</span> venv <span class="o">}}</span>/bin/activate
<span class="nv">$@</span>
</pre></div>
<p>When <cite>venv_activate.sh</cite> is uploaded to each web server it'll sit in <cite>/home/mark/.virtualenvs/faulty/exec</cite>.</p>
</div>
<div class="section" id="writing-the-playbook">
<h2>Writing the playbook</h2>
<p>I wanted to keep the number of files Ansible I was working with as low as I thought sensible for this blog post. Ansible is very flexible in terms of file organisation so a more broken up and organised approach is possible but for this example I'll just use one playbook.</p>
<p>There's much more hardening that could have been done with these instances. For the sake of conciseness I kept the number of tasks down.</p>
<p>I've broken playbook.yml into sections and will walk through each explaining what actions are taking place and reasoning behind each.</p>
<p>Too see the whole <a class="reference external" href="https://gist.github.com/marklit/3a562cd7b53f54abdaf5">playbook.yml</a> file please see this <a class="reference external" href="https://gist.github.com/marklit/3a562cd7b53f54abdaf5">gist</a>.</p>
</div>
<div class="section" id="ssh-tightening">
<h2>SSH tightening</h2>
<p>The first tasks are to disable root's ssh account and remove support for password-based authentication. I already stored my public ssh key in each server's <cite>authorized_keys</cite> file so there is no need to login with password authentication. Once these configuration changes are made the ssh server will be restarted:</p>
<div class="highlight"><pre><span class="nn">---</span>

<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">SSH tightening</span>
  <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">all</span>
  <span class="l-Scalar-Plain">sudo</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">True</span>
  <span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Disable root's ssh account</span>
      <span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="p-Indicator">&gt;</span>
        <span class="no">lineinfile</span>
        <span class="no">dest=/etc/ssh/sshd_config</span>
        <span class="no">regexp="^PermitRootLogin"</span>
        <span class="no">line="PermitRootLogin no"</span>
        <span class="no">state=present</span>
      <span class="l-Scalar-Plain">notify</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Restart ssh</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Disable password authentication</span>
      <span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="p-Indicator">&gt;</span>
        <span class="no">lineinfile</span>
        <span class="no">dest=/etc/ssh/sshd_config</span>
        <span class="no">regexp="^PasswordAuthentication"</span>
        <span class="no">line="PasswordAuthentication no"</span>
        <span class="no">state=present</span>
      <span class="l-Scalar-Plain">notify</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Restart ssh</span>

  <span class="l-Scalar-Plain">handlers</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Restart ssh</span>
    <span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">service name=ssh state=restarted</span>
</pre></div>
<p>There are three dashes at the top of this file as it's a YAML convention.</p>
</div>
<div class="section" id="package-cache">
<h2>Package cache</h2>
<p>Every system needs APT's cache updated. You can append <cite>update_cache=yes</cite> to specific package installations but I found it was required for every package installation so I perform the update once per machine rather than per package.</p>
<div class="highlight"><pre><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Update APT package cache</span>
  <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">all</span>
  <span class="l-Scalar-Plain">gather_facts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">False</span>
  <span class="l-Scalar-Plain">sudo</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">True</span>
  <span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Update APT package cache</span>
      <span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">apt update_cache=yes</span>
</pre></div>
</div>
<div class="section" id="syncing-to-utc">
<h2>Syncing to UTC</h2>
<p>I then set the time zone on each machine to UTC and setup NTP to synchronise their clocks with the European NTP pool. Note when dealing with <cite>dpkg-reconfigure</cite> make sure you pass <cite>--frontend noninteractive</cite>, otherwise Ansible will freeze while waiting for <cite>dpkg-reconfigure</cite> to accept input that Ansible isn't configured to capture interactively.</p>
<div class="highlight"><pre><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Set timezone to UTC</span>
  <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">all</span>
  <span class="l-Scalar-Plain">gather_facts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">False</span>
  <span class="l-Scalar-Plain">sudo</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">True</span>
  <span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Set timezone variables</span>
      <span class="l-Scalar-Plain">copy</span><span class="p-Indicator">:</span> <span class="p-Indicator">&gt;</span>
        <span class="no">content='Etc/UTC'</span>
        <span class="no">dest=/etc/timezone</span>
        <span class="no">owner=root</span>
        <span class="no">group=root</span>
        <span class="no">mode=0644</span>
        <span class="no">backup=yes</span>
      <span class="l-Scalar-Plain">notify</span><span class="p-Indicator">:</span>
        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Update timezone</span>
  <span class="l-Scalar-Plain">handlers</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Update timezone</span>
      <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="p-Indicator">&gt;</span>
        <span class="no">dpkg-reconfigure</span>
        <span class="no">--frontend noninteractive</span>
        <span class="no">tzdata</span>

<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Syncronise clocks</span>
  <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">all</span>
  <span class="l-Scalar-Plain">sudo</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">True</span>
  <span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">install ntp</span>
      <span class="l-Scalar-Plain">apt</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=ntp</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">copy ntp config</span>
      <span class="l-Scalar-Plain">copy</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">src=files/ntp.conf dest=/etc/ntp.conf</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">restart ntp</span>
      <span class="l-Scalar-Plain">service</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=ntp state=restarted</span>
</pre></div>
<p>I also made sure each machine has unattended upgrades installed.</p>
<div class="highlight"><pre><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Setup unattended upgrades</span>
  <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">all</span>
  <span class="l-Scalar-Plain">gather_facts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">False</span>
  <span class="l-Scalar-Plain">sudo</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">True</span>
  <span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Install unattended upgrades package</span>
      <span class="l-Scalar-Plain">apt</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=unattended-upgrades</span>
      <span class="l-Scalar-Plain">notify</span><span class="p-Indicator">:</span>
        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">dpkg reconfigure</span>

  <span class="l-Scalar-Plain">handlers</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">dpkg reconfigure</span>
      <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="p-Indicator">&gt;</span>
        <span class="no">dpkg-reconfigure</span>
        <span class="no">--frontend noninteractive</span>
        <span class="no">-plow unattended-upgrades</span>
</pre></div>
</div>
<div class="section" id="setup-the-django-app-server">
<h2>Setup the Django app server</h2>
<p>The Django app servers have the largest number of tasks. Here is a summarised list of what's being performed:</p>
<blockquote>
<ul class="simple">
<li>Setup uncomplicated firewall to block all incoming traffic except for tcp port 22 and 80; HTTP traffic should only come from the load balancer; ssh logins are rate-limited to slow down brute force attacks.</li>
<li>Install Python's virtualenv and development libraries.</li>
<li>Install git and checkout a public repo of a Django project hosted on Bitbucket.</li>
<li>Copy over the virtual environment activation script which is used by every Django command.</li>
<li>Install a virtual environment and the Django project's requirements.</li>
<li>Setup and migrate Django's database. The database doesn't need to be shared between web servers for this application so it's just a local SQLite3 file on each individual server.</li>
<li>Install supervisor and have it run the gunicorn app server and celery task runner.</li>
<li>Launch an nginx reverse proxy which acts as a buffer between gunicorn and the load balancer.</li>
</ul>
</blockquote>
<div class="highlight"><pre><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Setup App Server(s)</span>
  <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">app_servers</span>
  <span class="l-Scalar-Plain">sudo</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">True</span>
  <span class="l-Scalar-Plain">vars</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">home_folder</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/home/mark</span>
    <span class="l-Scalar-Plain">venv</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">faulty</span>
  <span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ufw</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">state=enabled logging=on</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ufw</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">direction=incoming policy=deny</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ufw</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rule=limit port=ssh proto=tcp</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ufw</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rule=allow port=22 proto=tcp</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ufw</span><span class="p-Indicator">:</span> <span class="p-Indicator">&gt;</span>
        <span class="no">rule=allow</span>
        <span class="no">port=80</span>
        <span class="no">proto=tcp</span>
        <span class="no">from_ip={{ hostvars['lb']['ansible_default_ipv4']['address'] }}</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Install python virtualenv</span>
      <span class="l-Scalar-Plain">apt</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=python-virtualenv</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Install python dev</span>
      <span class="l-Scalar-Plain">apt</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=python-dev</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Install git</span>
      <span class="l-Scalar-Plain">apt</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=git</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Checkout Django code</span>
      <span class="l-Scalar-Plain">git</span><span class="p-Indicator">:</span> <span class="p-Indicator">&gt;</span>
        <span class="no">repo=https://bitbucket.org/marklit/faulty.git</span>
        <span class="no">dest={{ home_folder }}/faulty</span>
        <span class="no">update=no</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">file</span><span class="p-Indicator">:</span> <span class="p-Indicator">&gt;</span>
        <span class="no">path={{ home_folder }}/faulty</span>
        <span class="no">owner=mark</span>
        <span class="no">group=mark</span>
        <span class="no">mode=755</span>
        <span class="no">state=directory</span>
        <span class="no">recurse=yes</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Install Python requirements</span>
      <span class="l-Scalar-Plain">pip</span><span class="p-Indicator">:</span> <span class="p-Indicator">&gt;</span>
        <span class="no">requirements={{ home_folder }}/faulty/requirements.txt</span>
        <span class="no">virtualenv={{ home_folder }}/.virtualenvs/{{ venv }}</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">template</span><span class="p-Indicator">:</span> <span class="p-Indicator">&gt;</span>
        <span class="no">src=files/venv_activate.sh</span>
        <span class="no">dest={{ home_folder }}/.virtualenvs/{{ venv }}/exec</span>
        <span class="no">mode=755</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="p-Indicator">&gt;</span>
        <span class="no">{{ home_folder }}/.virtualenvs/{{ venv }}/exec</span>
        <span class="no">python manage.py syncdb --noinput</span>
      <span class="l-Scalar-Plain">args</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">chdir</span><span class="p-Indicator">:</span> <span class="s">'{{</span><span class="nv"> </span><span class="s">home_folder</span><span class="nv"> </span><span class="s">}}/faulty'</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="p-Indicator">&gt;</span>
        <span class="no">{{ home_folder }}/.virtualenvs/{{ venv }}/exec</span>
        <span class="no">python manage.py migrate</span>
      <span class="l-Scalar-Plain">args</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">chdir</span><span class="p-Indicator">:</span> <span class="s">'{{</span><span class="nv"> </span><span class="s">home_folder</span><span class="nv"> </span><span class="s">}}/faulty'</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Install supervisor</span>
      <span class="l-Scalar-Plain">apt</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=supervisor</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">template</span><span class="p-Indicator">:</span> <span class="p-Indicator">&gt;</span>
        <span class="no">src=files/supervisord.conf</span>
        <span class="no">dest=/etc/supervisor/conf.d/django_app.conf</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/usr/bin/supervisorctl reload</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">supervisorctl</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=web_app state=restarted</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">supervisorctl</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=celeryd state=restarted</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Install nginx</span>
      <span class="l-Scalar-Plain">apt</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=nginx</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">copy nginx config file</span>
      <span class="l-Scalar-Plain">template</span><span class="p-Indicator">:</span> <span class="p-Indicator">&gt;</span>
        <span class="no">src=files/nginx-app.conf</span>
        <span class="no">dest=/etc/nginx/sites-available/default</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">enable configuration</span>
      <span class="l-Scalar-Plain">file</span><span class="p-Indicator">:</span> <span class="p-Indicator">&gt;</span>
        <span class="no">dest=/etc/nginx/sites-enabled/default</span>
        <span class="no">src=/etc/nginx/sites-available/default</span>
        <span class="no">state=link</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">service</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=nginx state=restarted</span>
</pre></div>
</div>
<div class="section" id="the-load-balancer">
<h2>The load balancer</h2>
<p>The load balancer has a simpler task list:</p>
<blockquote>
<ul class="simple">
<li>Block all incoming traffic except for tcp 22, 80, 443; rate limit ssh.</li>
<li>Install Nginx and copy in the self-signed certificates.</li>
<li>Copy in the load balancer configuration and launch nginx.</li>
</ul>
</blockquote>
<div class="highlight"><pre><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Setup Load balancer(s)</span>
  <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">load_balancers</span>
  <span class="l-Scalar-Plain">sudo</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">True</span>
  <span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ufw</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">state=enabled logging=on</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ufw</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">direction=incoming policy=deny</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ufw</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rule=limit port=ssh proto=tcp</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ufw</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rule=allow port=22 proto=tcp</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ufw</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rule=allow port=80 proto=tcp</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ufw</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rule=allow port=443 proto=tcp</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">apt</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=nginx</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">copy nginx config file</span>
      <span class="l-Scalar-Plain">template</span><span class="p-Indicator">:</span> <span class="p-Indicator">&gt;</span>
        <span class="no">src=files/nginx-load-balancer.conf</span>
        <span class="no">dest=/etc/nginx/sites-available/default</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">copy</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">src=files/nginx.key dest=/etc/nginx/ssl/</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">copy</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">src=files/nginx.crt dest=/etc/nginx/ssl/</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">enable configuration</span>
      <span class="l-Scalar-Plain">file</span><span class="p-Indicator">:</span> <span class="p-Indicator">&gt;</span>
        <span class="no">dest=/etc/nginx/sites-enabled/default</span>
        <span class="no">src=/etc/nginx/sites-available/default</span>
        <span class="no">state=link</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">service</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=nginx state=restarted</span>
</pre></div>
</div>
<div class="section" id="running-the-playbook">
<h2>Running the playbook</h2>
<p>I used the following command to run the playbook and setup the cluster:</p>
<div class="highlight"><pre><span class="nv">$ </span>ansible-playbook -i inventory --ask-sudo-pass playbook.yml
</pre></div>
<p>I then tested that I could communicate via the load balancer. If <cite>--insecure</cite> is not passed as a flag to <cite>curl</cite> you'll not be able to complete the request as curl is setup to not trust self-signed ssl certificates by default:</p>
<div class="highlight"><pre>$ curl --insecure https://lb
k2b71#v!l0_sf7y$0)x(=cw2u_^q05etbf9ediptp(#0m+&amp;=^0
81jy$7n=!3ay%p3o%$e!iv8hknbuyl64*o-sue1xcgygp^owlb
fne-$j$^qyv*^me3r5kx=p^#*+y!t)gq!^a)9_dhs4afcx2x!2
7s5@po!&amp;)zo#ca=16-o0gmv!440%1$q2xgne+uerpp7@*bt*l8
m!y*$2o)8r(tmf!b(*72$knb$&amp;(gt1jspn&amp;h4tu^s#9-3(+x&amp;b
s#(vta0x68#4ihpw1sds06=fjcj9!am8c4c32zy95_0=%==$s(
-j(3pnb^4x)##(^@n)&amp;)fe3#zl2mb&amp;(s1qj5#)9%+ng6%sj%7n
c02$ahq#t$t)1s12-nj!yolz+v687zpefug_o7!+w7055gt5g$
7j8v%$)o50ch(-^#q3^7(dtgl3lvg2orirk$e54l&amp;k89jxj#-1
g@^_eanx#*@4&amp;8kg!xi(va^_@@4xyjz7h497$iw*1=^sb797il
88hmb=+c9+^#2r3x$e7nl)nlf8rb^
</pre></div>
</div>

  </div>

   <div id="support_text"><p>
    Thank you for taking the time to read this post. If you're considering using </p><a href="https://www.digitalocean.com/?refcode=074ce6598105">Digital Ocean</a><p>, the hosting provider this blog is hosted on, please consider using </p><a href="https://www.digitalocean.com/?refcode=074ce6598105">this link to sign up</a><p>.
  </p></div>


  
</div></body></html>