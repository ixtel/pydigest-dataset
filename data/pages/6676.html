<html><body><div><ol class="highlight code">
	<li class="" id="line-0"><p><span class="c">#!/usr/bin/env python</span></p></li>
<li id="line-1"><p>
</p></li>	<li class="" id="line-2"><p><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">code</span><span class="o">,</span> <span class="nn">ctypes</span><span class="o">,</span> <span class="nn">readline</span><span class="o">,</span> <span class="nn">signal</span><span class="o">,</span> <span class="nn">threading</span><span class="o">,</span> <span class="nn">subprocess</span>   <span class="c"># Core stuff</span></p></li>
	<li class="" id="line-3"><p><span class="kn">import</span> <span class="nn">pygments</span><span class="o">,</span> <span class="nn">pygments.formatters</span><span class="o">,</span> <span class="nn">pygments.lexers</span><span class="o">,</span> <span class="nn">blessings</span>        <span class="c"># Drawing stuff</span></p></li>
<li id="line-4"><p>
</p></li>	<li class="" id="line-5"><p><span class="k">def</span> <span class="nf">slight_delay</span><span class="p">():</span></p></li>
	<li class="" id="line-6"><p>    <span class="n">threading</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">draw</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></p></li>
	<li class="" id="line-7"><p>    <span class="k">return</span> <span class="mi">0</span></p></li>
<li id="line-8"><p>
</p></li>	<li class="" id="line-9"><p><span class="k">def</span> <span class="nf">draw</span><span class="p">():</span></p></li>
	<li class="" id="line-10"><p>    <span class="k">with</span> <span class="n">lock</span><span class="p">:</span></p></li>
	<li class="" id="line-11"><p>        <span class="n">lines</span> <span class="o">=</span> <span class="n">console</span><span class="o">.</span><span class="n">buffer</span> <span class="o">+</span> <span class="p">[</span><span class="n">readline</span><span class="o">.</span><span class="n">get_line_buffer</span><span class="p">()]</span></p></li>
	<li class="" id="line-12"><p>        <span class="n">prompts</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">ps1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">ps2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span></p></li>
	<li class="" id="line-13"><p>        <span class="n">highlighted</span> <span class="o">=</span> <span class="n">pygments</span><span class="o">.</span><span class="n">highlight</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="n">lexer</span><span class="p">,</span> <span class="n">formatter</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></p></li>
	<li class="" id="line-14"><p>        <span class="n">highlighted</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="o">+</span> <span class="n">l</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">prompts</span><span class="p">,</span> <span class="n">highlighted</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">))]</span></p></li>
	<li class="" id="line-15"><p>        <span class="k">with</span> <span class="n">terminal</span><span class="o">.</span><span class="n">location</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span></p></li>
	<li class="" id="line-16"><p>            <span class="k">print</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">terminal</span><span class="o">.</span><span class="n">move_up</span> <span class="o">+</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">highlighted</span><span class="p">),</span></p></li>
	<li class="" id="line-17"><p>        <span class="n">readline</span><span class="o">.</span><span class="n">redisplay</span><span class="p">()</span></p></li>
	<li class="" id="line-18"><p>    <span class="k">return</span> <span class="mi">0</span></p></li>
	<li class="" id="line-19"><p>  </p></li>
	<li class="" id="line-20"><p><span class="k">def</span> <span class="nf">my_interrupt</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span></p></li>
	<li class="" id="line-21"><p>    <span class="n">set_hooks</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span></p></li>
	<li class="" id="line-22"><p>    <span class="n">threading</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s">'kill'</span><span class="p">,</span> <span class="s">'-2'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())]))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></p></li>
<li id="line-23"><p>
</p></li>	<li class="" id="line-24"><p><span class="k">def</span> <span class="nf">set_hooks</span><span class="p">(</span><span class="n">to_defaults</span><span class="p">):</span></p></li>
	<li class="" id="line-25"><p>    <span class="k">global</span> <span class="n">default_interrupt</span><span class="p">,</span> <span class="n">callback</span></p></li>
	<li class="" id="line-26"><p>    <span class="n">hook_ptr</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="o">.</span><span class="n">in_dll</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">pythonapi</span><span class="p">,</span><span class="s">"PyOS_InputHook"</span><span class="p">)</span></p></li>
	<li class="" id="line-27"><p>    <span class="k">if</span> <span class="n">to_defaults</span><span class="p">:</span></p></li>
	<li class="" id="line-28"><p>        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">default_interrupt</span><span class="p">)</span></p></li>
	<li class="" id="line-29"><p>        <span class="n">hook_ptr</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span><span class="n">value</span></p></li>
	<li class="" id="line-30"><p>    <span class="k">else</span><span class="p">:</span></p></li>
	<li class="" id="line-31"><p>        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">my_interrupt</span><span class="p">)</span></p></li>
	<li class="" id="line-32"><p>        <span class="n">hook_ptr</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">)</span><span class="o">.</span><span class="n">value</span></p></li>
<li id="line-33"><p>
</p></li>	<li class="" id="line-34"><p><span class="n">default_interrupt</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">getsignal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">)</span></p></li>
	<li class="" id="line-35"><p><span class="n">callback</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">PYFUNCTYPE</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">)(</span><span class="n">slight_delay</span><span class="p">)</span></p></li>
	<li class="" id="line-36"><p><span class="n">terminal</span> <span class="o">=</span> <span class="n">blessings</span><span class="o">.</span><span class="n">Terminal</span><span class="p">()</span></p></li>
	<li class="" id="line-37"><p><span class="n">lexer</span> <span class="o">=</span> <span class="n">pygments</span><span class="o">.</span><span class="n">lexers</span><span class="o">.</span><span class="n">PythonLexer</span><span class="p">()</span></p></li>
	<li class="" id="line-38"><p><span class="n">formatter</span> <span class="o">=</span> <span class="n">pygments</span><span class="o">.</span><span class="n">formatters</span><span class="o">.</span><span class="n">TerminalFormatter</span><span class="p">()</span></p></li>
	<li class="" id="line-39"><p><span class="n">console</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">InteractiveConsole</span><span class="p">()</span></p></li>
	<li class="" id="line-40"><p><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span></p></li>
	<li class="" id="line-41"><p><span class="n">set_hooks</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span></p></li>
<li id="line-42"><p>
</p></li>	<li class="" id="line-43"><p><span class="n">sys</span><span class="o">.</span><span class="n">ps1</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">ps1</span> <span class="k">if</span> <span class="s">'ps1'</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">sys</span><span class="p">)</span> <span class="k">else</span> <span class="s">'&gt;&gt;&gt; '</span></p></li>
	<li class="" id="line-44"><p><span class="n">sys</span><span class="o">.</span><span class="n">ps2</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">ps2</span> <span class="k">if</span> <span class="s">'ps2'</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">sys</span><span class="p">)</span> <span class="k">else</span> <span class="s">'... '</span></p></li>
	<li class="" id="line-45"><p><span class="n">more</span> <span class="o">=</span> <span class="bp">False</span></p></li>
	<li class="" id="line-46"><p><span class="k">while</span> <span class="bp">True</span><span class="p">:</span></p></li>
	<li class="" id="line-47"><p>    <span class="k">try</span><span class="p">:</span></p></li>
	<li class="" id="line-48"><p>        <span class="k">try</span><span class="p">:</span></p></li>
	<li class="" id="line-49"><p>            <span class="n">line</span> <span class="o">=</span> <span class="n">console</span><span class="o">.</span><span class="n">raw_input</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">ps2</span> <span class="k">if</span> <span class="n">more</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">ps1</span><span class="p">)</span></p></li>
	<li class="" id="line-50"><p>            <span class="n">encoding</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="s">"encoding"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span></p></li>
	<li class="" id="line-51"><p>            <span class="k">if</span> <span class="n">encoding</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span></p></li>
	<li class="" id="line-52"><p>                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span></p></li>
	<li class="" id="line-53"><p>        <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span></p></li>
	<li class="" id="line-54"><p>            <span class="n">console</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span></p></li>
	<li class="" id="line-55"><p>            <span class="k">break</span></p></li>
	<li class="" id="line-56"><p>        <span class="k">else</span><span class="p">:</span></p></li>
	<li class="" id="line-57"><p>            <span class="n">more</span> <span class="o">=</span> <span class="n">console</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></p></li>
	<li class="" id="line-58"><p>    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span></p></li>
	<li class="" id="line-59"><p>        <span class="n">console</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">KeyboardInterrupt</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span></p></li>
	<li class="" id="line-60"><p>        <span class="n">console</span><span class="o">.</span><span class="n">resetbuffer</span><span class="p">()</span></p></li>
	<li class="" id="line-61"><p>        <span class="n">more</span> <span class="o">=</span> <span class="bp">False</span></p></li>
	<li class="" id="line-62"><p>        <span class="n">set_hooks</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span></p></li>
<li id="line-63"><p>
</p></li></ol>
</div></body></html>