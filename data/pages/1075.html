<html><body><div><div>
<p>This blogpost is a write-up of a talk I gave at Europython 2014. This is my
initial draft of the talk that was turned into slides for presentation.</p>
<p>The video is already on Youtube, so if you prefer you can watch:</p>
<blockquote>
<a class="reference external" href="https://www.youtube.com/watch?v=0wpYQr-_kqg">gevent: Asynchronous I/O made easy</a> (44 minutes)</blockquote>
<p>You can see the slides used for the presentation <a class="reference external" href="http://mauveweb.co.uk/presentations/gevent-talk/">here</a>.</p>

<div class="section" id="introduction">
<h2>Introduction</h2>
<p><a class="reference external" href="http://www.gevent.org/">gevent</a> is a framework for scalable asynchronous I/O with a fully synchronous
programming model.</p>
<p>Let's look at some examples of where we are going. Here's an echo server:</p>
<pre class="code python"><a name="rest_code_bb12cbe31e484ed2b494bafb93b6faaf-1"/><span class="kn">from</span> <span class="nn">gevent.server</span> <span class="kn">import</span> <span class="n">StreamServer</span>
<a name="rest_code_bb12cbe31e484ed2b494bafb93b6faaf-2"/>
<a name="rest_code_bb12cbe31e484ed2b494bafb93b6faaf-3"/>
<a name="rest_code_bb12cbe31e484ed2b494bafb93b6faaf-4"/><span class="k">def</span> <span class="nf">connection_handler</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
<a name="rest_code_bb12cbe31e484ed2b494bafb93b6faaf-5"/>    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">socket</span><span class="o">.</span><span class="n">makefile</span><span class="p">(</span><span class="s">'r'</span><span class="p">):</span>
<a name="rest_code_bb12cbe31e484ed2b494bafb93b6faaf-6"/>        <span class="n">socket</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
<a name="rest_code_bb12cbe31e484ed2b494bafb93b6faaf-7"/>
<a name="rest_code_bb12cbe31e484ed2b494bafb93b6faaf-8"/>
<a name="rest_code_bb12cbe31e484ed2b494bafb93b6faaf-9"/><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
<a name="rest_code_bb12cbe31e484ed2b494bafb93b6faaf-10"/>    <span class="n">server</span> <span class="o">=</span> <span class="n">StreamServer</span><span class="p">((</span><span class="s">'0.0.0.0'</span><span class="p">,</span> <span class="mi">8000</span><span class="p">),</span> <span class="n">connection_handler</span><span class="p">)</span>
<a name="rest_code_bb12cbe31e484ed2b494bafb93b6faaf-11"/>    <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</pre>
<p>In this example we make 100 web requests in parallel:</p>
<pre class="code python"><a name="rest_code_b3f0d3fb79da448badfcbf53476687c6-1"/><span class="kn">from</span> <span class="nn">gevent</span> <span class="kn">import</span> <span class="n">monkey</span>
<a name="rest_code_b3f0d3fb79da448badfcbf53476687c6-2"/><span class="n">monkey</span><span class="o">.</span><span class="n">patch_all</span><span class="p">()</span>
<a name="rest_code_b3f0d3fb79da448badfcbf53476687c6-3"/>
<a name="rest_code_b3f0d3fb79da448badfcbf53476687c6-4"/><span class="kn">import</span> <span class="nn">urllib2</span>
<a name="rest_code_b3f0d3fb79da448badfcbf53476687c6-5"/><span class="kn">from</span> <span class="nn">gevent.pool</span> <span class="kn">import</span> <span class="n">Pool</span>
<a name="rest_code_b3f0d3fb79da448badfcbf53476687c6-6"/>
<a name="rest_code_b3f0d3fb79da448badfcbf53476687c6-7"/>
<a name="rest_code_b3f0d3fb79da448badfcbf53476687c6-8"/><span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
<a name="rest_code_b3f0d3fb79da448badfcbf53476687c6-9"/>    <span class="k">return</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<a name="rest_code_b3f0d3fb79da448badfcbf53476687c6-10"/>
<a name="rest_code_b3f0d3fb79da448badfcbf53476687c6-11"/>
<a name="rest_code_b3f0d3fb79da448badfcbf53476687c6-12"/><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
<a name="rest_code_b3f0d3fb79da448badfcbf53476687c6-13"/>    <span class="n">urls</span> <span class="o">=</span> <span class="p">[</span><span class="s">'http://httpbin.org/get'</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>
<a name="rest_code_b3f0d3fb79da448badfcbf53476687c6-14"/>    <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<a name="rest_code_b3f0d3fb79da448badfcbf53476687c6-15"/>    <span class="k">print</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">download</span><span class="p">,</span> <span class="n">urls</span><span class="p">)</span>
</pre>
<p>What is the strange <tt class="docutils literal">monkey.patch_all()</tt> call? Not to worry, this isn't like
your every day monkey patching. This is just a distribution of Python that
happens to be shipped as a set of monkey patches.</p>
<p id="chat-server">This final example is a chat server:</p>
<pre class="code python"><a name="rest_code_389bfa502aff4acca25608d9dafc31e8-1"/><span class="kn">import</span> <span class="nn">gevent</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-2"/><span class="kn">from</span> <span class="nn">gevent.queue</span> <span class="kn">import</span> <span class="n">Queue</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-3"/><span class="kn">from</span> <span class="nn">gevent.server</span> <span class="kn">import</span> <span class="n">StreamServer</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-4"/>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-5"/><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c"># mapping of username -&gt; Queue</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-6"/>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-7"/>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-8"/><span class="k">def</span> <span class="nf">broadcast</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-9"/>    <span class="n">msg</span> <span class="o">+=</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-10"/>    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">users</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-11"/>        <span class="n">v</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-12"/>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-13"/>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-14"/><span class="k">def</span> <span class="nf">reader</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-15"/>    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-16"/>        <span class="n">msg</span> <span class="o">=</span> <span class="s">'</span><span class="si">%s</span><span class="s">&gt; </span><span class="si">%s</span><span class="s">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-17"/>        <span class="n">broadcast</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-18"/>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-19"/>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-20"/><span class="k">def</span> <span class="nf">writer</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-21"/>    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-22"/>        <span class="n">msg</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-23"/>        <span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-24"/>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-25"/>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-26"/><span class="k">def</span> <span class="nf">read_name</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-27"/>    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-28"/>        <span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="s">'Please enter your name: '</span><span class="p">)</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-29"/>        <span class="n">name</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-30"/>        <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-31"/>            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-32"/>                <span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="s">'That username is already taken.</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-33"/>            <span class="k">else</span><span class="p">:</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-34"/>                <span class="k">return</span> <span class="n">name</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-35"/>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-36"/>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-37"/><span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">client_addr</span><span class="p">):</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-38"/>    <span class="n">f</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">makefile</span><span class="p">()</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-39"/>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-40"/>    <span class="n">name</span> <span class="o">=</span> <span class="n">read_name</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">sock</span><span class="p">)</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-41"/>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-42"/>    <span class="n">broadcast</span><span class="p">(</span><span class="s">'## </span><span class="si">%s</span><span class="s"> joined from </span><span class="si">%s</span><span class="s">.'</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">client_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-43"/>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-44"/>    <span class="n">q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-45"/>    <span class="n">users</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-46"/>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-47"/>    <span class="k">try</span><span class="p">:</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-48"/>        <span class="n">r</span> <span class="o">=</span> <span class="n">gevent</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-49"/>        <span class="n">w</span> <span class="o">=</span> <span class="n">gevent</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">sock</span><span class="p">)</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-50"/>        <span class="n">gevent</span><span class="o">.</span><span class="n">joinall</span><span class="p">([</span><span class="n">r</span><span class="p">,</span> <span class="n">w</span><span class="p">])</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-51"/>    <span class="k">finally</span><span class="p">:</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-52"/>        <span class="k">del</span><span class="p">(</span><span class="n">users</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-53"/>        <span class="n">broadcast</span><span class="p">(</span><span class="s">'## </span><span class="si">%s</span><span class="s"> left the chat.'</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-54"/>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-55"/>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-56"/><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-57"/>    <span class="kn">import</span> <span class="nn">sys</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-58"/>    <span class="k">try</span><span class="p">:</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-59"/>        <span class="n">myip</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-60"/>    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-61"/>        <span class="n">myip</span> <span class="o">=</span> <span class="s">'0.0.0.0'</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-62"/>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-63"/>    <span class="k">print</span> <span class="s">'To join, telnet </span><span class="si">%s</span><span class="s"> 8001'</span> <span class="o">%</span> <span class="n">myip</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-64"/>    <span class="n">s</span> <span class="o">=</span> <span class="n">StreamServer</span><span class="p">((</span><span class="n">myip</span><span class="p">,</span> <span class="mi">8001</span><span class="p">),</span> <span class="n">handle</span><span class="p">)</span>
<a name="rest_code_389bfa502aff4acca25608d9dafc31e8-65"/>    <span class="n">s</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</pre>
<p>Simple enough? Let's look at why this gevent stuff is written like this.</p>
</div>
<div class="section" id="synchronous-i-o">
<h2>Synchronous I/O</h2>
<p>Synchronous I/O means that each I/O operation is allowed to block until it is
complete.</p>
<p>To scale this to more than one user at a time, we need threads and processes.
Each thread or process is allowed to individually block waiting on I/O. Because
we have full concurrency, this blocking doesn't affect other operations; from
the point of view of each thread/process the world stops until the operation is
complete. The OS will resume the thread/process when the results are ready.</p>
<object class="align-center" data="http://mauveweb.co.uk/presentations/gevent-talk/_static/blocking-io.svg" type="image/svg+xml">
/presentations/gevent-talk/_static/blocking-io.svg</object>
<p>Drawbacks of threads: terrible performance. See <cite>Dave Beazley's notes on the
GIL</cite>. Also high memory use. Threads in Linux allocate stack memory (see ulimit
-s). This is not useful for Python - it will just cause you to run out of
memory with relatively few threads.</p>
<p>Drawbacks of processes: No shared memory space. High memory use, both because
of the stack allocation and copy-on-write. Threads in Linux are like a special
kind of process; the kernel structures are more or less the same.</p>
</div>
<div class="section" id="asyncronous-i-o">
<h2>Asyncronous I/O</h2>
<p>All asynchronous I/O falls back to the same pattern. It's not really about how
the code executes but where the waiting is done. Multiple I/O activities need
to unify their efforts to wait so that the waiting happens in a single place in
the code. When an event occurs, the asynchronous system needs to resume the
section of the code that was waiting for that event.</p>
<p>The problem then, is not how to do the waiting in a single place, but how to
resume the one piece of code expecting to receive that event.</p>
<p>There are several different approaches to how to organise a single-threaded
program so that all of the waiting can be done in a single place in code, ie.
there are several different ideas about what <tt class="docutils literal">resume()</tt> and <tt class="docutils literal">waiter</tt> might
be in the following <strong>event loop</strong> code:</p>
<pre class="code python"><a name="rest_code_be3095865f77460e83ee4cf92131e268-1"/><span class="n">read_waiters</span> <span class="o">=</span> <span class="p">{}</span>
<a name="rest_code_be3095865f77460e83ee4cf92131e268-2"/><span class="n">write_waiters</span> <span class="o">=</span> <span class="p">{}</span>
<a name="rest_code_be3095865f77460e83ee4cf92131e268-3"/><span class="n">timeout_waiters</span> <span class="o">=</span> <span class="p">[]</span>
<a name="rest_code_be3095865f77460e83ee4cf92131e268-4"/>
<a name="rest_code_be3095865f77460e83ee4cf92131e268-5"/><span class="k">def</span> <span class="nf">wait_for_read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">waiter</span><span class="p">):</span>
<a name="rest_code_be3095865f77460e83ee4cf92131e268-6"/>    <span class="n">read_waiters</span><span class="p">[</span><span class="n">fd</span><span class="p">]</span> <span class="o">=</span> <span class="n">waiter</span>
<a name="rest_code_be3095865f77460e83ee4cf92131e268-7"/>
<a name="rest_code_be3095865f77460e83ee4cf92131e268-8"/><span class="n">wait_for_write</span> <span class="o">=</span> <span class="n">write_waiters</span><span class="o">.</span><span class="n">___setitem__</span>
<a name="rest_code_be3095865f77460e83ee4cf92131e268-9"/>
<a name="rest_code_be3095865f77460e83ee4cf92131e268-10"/><span class="k">def</span> <span class="nf">event_loop</span><span class="p">():</span>
<a name="rest_code_be3095865f77460e83ee4cf92131e268-11"/>    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
<a name="rest_code_be3095865f77460e83ee4cf92131e268-12"/>        <span class="n">readfds</span> <span class="o">=</span> <span class="n">read_waiters</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<a name="rest_code_be3095865f77460e83ee4cf92131e268-13"/>        <span class="n">writefds</span> <span class="o">=</span> <span class="n">write_waiters</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<a name="rest_code_be3095865f77460e83ee4cf92131e268-14"/>
<a name="rest_code_be3095865f77460e83ee4cf92131e268-15"/>        <span class="n">read</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
<a name="rest_code_be3095865f77460e83ee4cf92131e268-16"/>            <span class="n">readfds</span><span class="p">,</span>  <span class="c"># waiting for read</span>
<a name="rest_code_be3095865f77460e83ee4cf92131e268-17"/>            <span class="n">writefds</span><span class="p">,</span>  <span class="c"># waiting for write</span>
<a name="rest_code_be3095865f77460e83ee4cf92131e268-18"/>            <span class="n">readfds</span> <span class="o">+</span> <span class="n">writefds</span><span class="p">,</span>  <span class="c"># waiting for errors</span>
<a name="rest_code_be3095865f77460e83ee4cf92131e268-19"/>        <span class="p">)</span>
<a name="rest_code_be3095865f77460e83ee4cf92131e268-20"/>
<a name="rest_code_be3095865f77460e83ee4cf92131e268-21"/>        <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="n">read</span><span class="p">:</span>
<a name="rest_code_be3095865f77460e83ee4cf92131e268-22"/>            <span class="n">resume</span><span class="p">(</span><span class="n">read_waiters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">fd</span><span class="p">))</span>
<a name="rest_code_be3095865f77460e83ee4cf92131e268-23"/>
<a name="rest_code_be3095865f77460e83ee4cf92131e268-24"/>        <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="n">write</span><span class="p">:</span>
<a name="rest_code_be3095865f77460e83ee4cf92131e268-25"/>            <span class="n">resume</span><span class="p">(</span><span class="n">write_waiters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">fd</span><span class="p">))</span>
<a name="rest_code_be3095865f77460e83ee4cf92131e268-26"/>
<a name="rest_code_be3095865f77460e83ee4cf92131e268-27"/>        <span class="c"># something about errors</span>
</pre>
<p>We may want to add timeouts to the above code, in which case we might write
something also include something like the following:</p>
<pre class="code python"><a name="rest_code_d6ce50e725df48698129457fbb48e152-1"/><span class="n">timeout_waiters</span> <span class="o">=</span> <span class="p">[]</span>
<a name="rest_code_d6ce50e725df48698129457fbb48e152-2"/>
<a name="rest_code_d6ce50e725df48698129457fbb48e152-3"/><span class="k">def</span> <span class="nf">wait_for_timeout</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="n">waiter</span><span class="p">):</span>
<a name="rest_code_d6ce50e725df48698129457fbb48e152-4"/>    <span class="n">when</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">delay</span>
<a name="rest_code_d6ce50e725df48698129457fbb48e152-5"/>    <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="n">timeout_waiters</span><span class="p">,</span> <span class="p">(</span><span class="n">when</span><span class="p">,</span> <span class="n">waiter</span><span class="p">))</span>
<a name="rest_code_d6ce50e725df48698129457fbb48e152-6"/>
<a name="rest_code_d6ce50e725df48698129457fbb48e152-7"/><span class="k">def</span> <span class="nf">event_loop</span><span class="p">():</span>
<a name="rest_code_d6ce50e725df48698129457fbb48e152-8"/>    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
<a name="rest_code_d6ce50e725df48698129457fbb48e152-9"/>        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a name="rest_code_d6ce50e725df48698129457fbb48e152-10"/>        <span class="n">read</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
<a name="rest_code_d6ce50e725df48698129457fbb48e152-11"/>            <span class="n">rfds</span><span class="p">,</span> <span class="n">wfds</span><span class="p">,</span> <span class="n">efds</span><span class="p">,</span>
<a name="rest_code_d6ce50e725df48698129457fbb48e152-12"/>            <span class="n">timeout_waiters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a name="rest_code_d6ce50e725df48698129457fbb48e152-13"/>        <span class="p">)</span>
<a name="rest_code_d6ce50e725df48698129457fbb48e152-14"/>        <span class="k">while</span> <span class="n">timeout_waiters</span><span class="p">:</span>
<a name="rest_code_d6ce50e725df48698129457fbb48e152-15"/>            <span class="k">if</span> <span class="n">timeout_waiters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">now</span><span class="p">:</span>
<a name="rest_code_d6ce50e725df48698129457fbb48e152-16"/>                 <span class="n">_</span><span class="p">,</span> <span class="n">waiter</span> <span class="o">=</span> <span class="n">heapq</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="n">timeout_waiters</span><span class="p">)</span>
<a name="rest_code_d6ce50e725df48698129457fbb48e152-17"/>                 <span class="n">resume</span><span class="p">(</span><span class="n">waiter</span><span class="p">)</span>
</pre>
<p>All asynchronous I/O frameworks are built on the same kind of model; they just
take different approaches to how to structure your code so that it can be
suspended when an I/O operation is requested and resumed when that operation is
completed.</p>
</div>
<div class="section" id="callbacks">
<h2>Callbacks</h2>
<p>Examples:</p>
<ul class="simple">
<li>Javascript/Node</li>
<li>Tornado IOStream</li>
<li>Twisted Deferred</li>
<li>asyncio, under the hood</li>
</ul>
<p>One approach is to just call a callable whenever data is available to read.
Typically we want to act on a higher level than chunks of data, so have a
callback read and parse individual chunks of binary data and call an
application callback when the parsed content is complete (such as a HTTP
request or response).</p>
<p>What the user code looks like:</p>
<pre class="code python"><a name="rest_code_1d023b9215f0444092d8a805c36640d1-1"/><span class="k">def</span> <span class="nf">start_beer_request</span><span class="p">():</span>
<a name="rest_code_1d023b9215f0444092d8a805c36640d1-2"/>    <span class="n">http</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'/api/beer'</span><span class="p">,</span> <span class="n">handle_response</span><span class="p">)</span>
<a name="rest_code_1d023b9215f0444092d8a805c36640d1-3"/>
<a name="rest_code_1d023b9215f0444092d8a805c36640d1-4"/><span class="k">def</span> <span class="nf">handle_response</span><span class="p">(</span><span class="n">resp</span><span class="p">):</span>
<a name="rest_code_1d023b9215f0444092d8a805c36640d1-5"/>    <span class="n">beer</span> <span class="o">=</span> <span class="n">load_beer</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">)</span>
<a name="rest_code_1d023b9215f0444092d8a805c36640d1-6"/>    <span class="n">do_something</span><span class="p">(</span><span class="n">beer</span><span class="p">)</span>
</pre>
<p>How can we tie the response back to a specific request? One answer is closures:</p>
<pre class="code python"><a name="rest_code_2f7284590c12471a94853e08c4f2a33d-1"/><span class="k">def</span> <span class="nf">get_fruit</span><span class="p">(</span><span class="n">beer_id</span><span class="p">,</span> <span class="n">callback</span><span class="p">):</span>
<a name="rest_code_2f7284590c12471a94853e08c4f2a33d-2"/>    <span class="k">def</span> <span class="nf">handle_response</span><span class="p">(</span><span class="n">resp</span><span class="p">):</span>
<a name="rest_code_2f7284590c12471a94853e08c4f2a33d-3"/>        <span class="n">beer</span> <span class="o">=</span> <span class="n">load_beer</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">)</span>
<a name="rest_code_2f7284590c12471a94853e08c4f2a33d-4"/>        <span class="n">callback</span><span class="p">(</span><span class="n">beer</span><span class="p">)</span>
<a name="rest_code_2f7284590c12471a94853e08c4f2a33d-5"/>
<a name="rest_code_2f7284590c12471a94853e08c4f2a33d-6"/>    <span class="n">http</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'/api/beer/</span><span class="si">%d</span><span class="s">'</span> <span class="o">%</span> <span class="n">beer_id</span><span class="p">,</span> <span class="n">handle_response</span><span class="p">)</span>
</pre>
<p>Either way is ugly, especially if we wanted to chain more I/O calls (anyone
fancy this nesting any deeper?). There's no escape from the nesting and
programming in pieces. As it has been said, "Callbacks are the new Goto".</p>
<p>The call stack looks like this:</p>
<object class="align-center" data="http://mauveweb.co.uk/presentations/gevent-talk/_static/callbacks.svg" type="image/svg+xml">
/presentations/gevent-talk/_static/callbacks.svg</object>
<p>Note how the return values never go anywhere useful; indeed the only way to
pass results around is to write additional callbacks.</p>
</div>
<div class="section" id="method-based-callbacks">
<h2>Method-based callbacks</h2>
<p>Examples:</p>
<ul class="simple">
<li>Twisted Protocols</li>
<li>Tornado RequestHandler</li>
<li>asyncio Transports/Protocols</li>
</ul>
<p>Callbacks are a mess! So we might organise them into interfaces where the
methods are automatically registered as callbacks, so that users can subclass
the interfaces to implement them. For example, this is asyncio example code:</p>
<pre class="code python"><a name="rest_code_3d3c39d2f08549bd8ed391b23a16d15f-1"/><span class="kn">import</span> <span class="nn">asyncio</span>
<a name="rest_code_3d3c39d2f08549bd8ed391b23a16d15f-2"/>
<a name="rest_code_3d3c39d2f08549bd8ed391b23a16d15f-3"/><span class="k">class</span> <span class="nc">EchoClient</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Protocol</span><span class="p">):</span>
<a name="rest_code_3d3c39d2f08549bd8ed391b23a16d15f-4"/>    <span class="n">message</span> <span class="o">=</span> <span class="s">'This is the message. It will be echoed.'</span>
<a name="rest_code_3d3c39d2f08549bd8ed391b23a16d15f-5"/>
<a name="rest_code_3d3c39d2f08549bd8ed391b23a16d15f-6"/>    <span class="k">def</span> <span class="nf">connection_made</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transport</span><span class="p">):</span>
<a name="rest_code_3d3c39d2f08549bd8ed391b23a16d15f-7"/>        <span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
<a name="rest_code_3d3c39d2f08549bd8ed391b23a16d15f-8"/>        <span class="k">print</span><span class="p">(</span><span class="s">'data sent: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">))</span>
<a name="rest_code_3d3c39d2f08549bd8ed391b23a16d15f-9"/>
<a name="rest_code_3d3c39d2f08549bd8ed391b23a16d15f-10"/>    <span class="k">def</span> <span class="nf">data_received</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<a name="rest_code_3d3c39d2f08549bd8ed391b23a16d15f-11"/>        <span class="k">print</span><span class="p">(</span><span class="s">'data received: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">()))</span>
<a name="rest_code_3d3c39d2f08549bd8ed391b23a16d15f-12"/>
<a name="rest_code_3d3c39d2f08549bd8ed391b23a16d15f-13"/>    <span class="k">def</span> <span class="nf">connection_lost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">):</span>
<a name="rest_code_3d3c39d2f08549bd8ed391b23a16d15f-14"/>        <span class="k">print</span><span class="p">(</span><span class="s">'server closed the connection'</span><span class="p">)</span>
<a name="rest_code_3d3c39d2f08549bd8ed391b23a16d15f-15"/>        <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</pre>
<p>This solution doesn't completely solve the problem of eliminating callbacks, it
just gives you a neater framework that avoids callbacks being dotted all over
the code. It places constraints on what callbacks can be called and where they
can be defined.  Suppose you want to link two protocols together - for example,
you need to make an HTTP request to a backend REST service in the middle of
handling a request from a user. You still get the problem of logic being
fragmented over multiple callbacks, and you still can't use the return values
from any asynchronous function.</p>
</div>
<div class="section" id="error-handling-in-callbacks">
<h2>Error handling in callbacks</h2>
<p>When using a callback-based programming model, you have to register additional
error handler callbacks.</p>
<p>Sadly not all frameworks enforce this. One reason is that it makes every single
program twice as hard to read if you do enforce it. So it's optional, and
consequently programmers don't always (even often) do it.</p>
<p>This violates <a class="reference external" href="http://legacy.python.org/dev/peps/pep-0020/">PEP20</a>:</p>
<blockquote>
<div class="line-block">
<p class="line">Errors should never pass silently.</p>
<p class="line">Unless explicitly silenced.</p>
</div>
</blockquote>
<p>One of the bigger risks of not properly handling errors is that your internal
state may get out of sync, deadlock waiting for an event that will never
arrive, or holding resources indefinitely for a connection that has already
disconnected.</p>
</div>
<div class="section" id="generator-based-coroutine">
<h2>Generator-based Coroutine</h2>
<p>Examples:</p>
<ul class="simple">
<li>tornado.gen</li>
<li>asyncio/Tulip</li>
</ul>
<p>Generators have been used to implement coroutine-like functionality. This
allows us to defer to some event loop system which will resume the
after-the-callback section of our code after the I/O operation has completed:</p>
<pre class="code python"><a name="rest_code_f1081cf008f54cb9aa54c4023477bebe-1"/><span class="kn">import</span> <span class="nn">asyncio</span>
<a name="rest_code_f1081cf008f54cb9aa54c4023477bebe-2"/>
<a name="rest_code_f1081cf008f54cb9aa54c4023477bebe-3"/><span class="nd">@asyncio.coroutine</span>
<a name="rest_code_f1081cf008f54cb9aa54c4023477bebe-4"/><span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<a name="rest_code_f1081cf008f54cb9aa54c4023477bebe-5"/>    <span class="k">print</span><span class="p">(</span><span class="s">"Compute </span><span class="si">%s</span><span class="s"> + </span><span class="si">%s</span><span class="s"> ..."</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
<a name="rest_code_f1081cf008f54cb9aa54c4023477bebe-6"/>    <span class="k">yield from</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
<a name="rest_code_f1081cf008f54cb9aa54c4023477bebe-7"/>    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
<a name="rest_code_f1081cf008f54cb9aa54c4023477bebe-8"/>
<a name="rest_code_f1081cf008f54cb9aa54c4023477bebe-9"/><span class="nd">@asyncio.coroutine</span>
<a name="rest_code_f1081cf008f54cb9aa54c4023477bebe-10"/><span class="k">def</span> <span class="nf">print_sum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<a name="rest_code_f1081cf008f54cb9aa54c4023477bebe-11"/>    <span class="n">result</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">compute</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<a name="rest_code_f1081cf008f54cb9aa54c4023477bebe-12"/>    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="si">%s</span><span class="s"> + </span><span class="si">%s</span><span class="s"> = </span><span class="si">%s</span><span class="s">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>
<a name="rest_code_f1081cf008f54cb9aa54c4023477bebe-13"/>
<a name="rest_code_f1081cf008f54cb9aa54c4023477bebe-14"/><span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<a name="rest_code_f1081cf008f54cb9aa54c4023477bebe-15"/><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">print_sum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<a name="rest_code_f1081cf008f54cb9aa54c4023477bebe-16"/><span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre>
<p>(In this example we should note that we will want to spawn other async
activities to get any scalability benefit out of this approach).</p>
<p>When generators were introduced with PEP255 they were described as providing
coroutine-like functionality. PEP342 and PEP380 extended this with the ability
to send exceptions to a generator and to <tt class="docutils literal">yield from</tt> a subgenerator
respectively.</p>
<p>The term "coroutine" denotes a system where you have more than one routine -
effectively, call stack - active at a time. Because each call stack is
preserved, a routine can suspend its state and yield to a different, named
coroutine. In some languages, there is a <tt class="docutils literal">yield</tt> keyword of some form that
invokes this behaviour (so different to the <tt class="docutils literal">yield</tt> keyword in Python).</p>
<p>Why would you want to do this? This provides a primitive form of multitasking
-- cooperative multitasking. Unlike threads, they are not <strong>preemptive</strong>, which
means that they aren't interrupted (preempted) until they explicitly yield.</p>
<p>Generators are a subset of this behaviour, right down to the 'yield'
terminology. Wikipedia calls them <a class="reference external" href="http://en.wikipedia.org/wiki/Coroutine#cite_ref-Ralston2000_4-0">semicoroutines</a>. However there are two
significant differences between generators and coroutines:</p>
<ol class="arabic simple">
<li>Generators can only yield to the calling frame.</li>
<li>Every frame in the stack needs to collaborate in yielding to the calling
frame - so the top frame might <tt class="docutils literal">yield</tt>, and all other calls in the stack
need to be made with <tt class="docutils literal">yield from</tt>.</li>
</ol>
<p>The call stack will look as below:</p>
<object class="align-center" data="http://mauveweb.co.uk/presentations/gevent-talk/_static/generators.svg" type="image/svg+xml">
/presentations/gevent-talk/_static/generators.svg</object>
<p>Note that this use of <tt class="docutils literal">yield</tt> means that you can't also use <tt class="docutils literal">yield</tt> to
write asynchronous generators. You have to return lists instead.</p>
</div>
<div class="section" id="greenlets-green-threads">
<h2>Greenlets/green threads</h2>
<p>A greenlet is a full coroutine.</p>
<p>Examples:</p>
<ul class="simple">
<li>gevent</li>
<li>greenlet</li>
<li>Stackless Python</li>
</ul>
<p>Let's rewrite that <tt class="docutils literal">asyncio</tt> example with gevent:</p>
<pre class="code python"><a name="rest_code_1a9d2431dcb245e5b88f7c669830661d-1"/><span class="kn">import</span> <span class="nn">gevent</span>
<a name="rest_code_1a9d2431dcb245e5b88f7c669830661d-2"/>
<a name="rest_code_1a9d2431dcb245e5b88f7c669830661d-3"/><span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<a name="rest_code_1a9d2431dcb245e5b88f7c669830661d-4"/>    <span class="k">print</span> <span class="s">"Compute </span><span class="si">%s</span><span class="s"> + </span><span class="si">%s</span><span class="s"> ..."</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<a name="rest_code_1a9d2431dcb245e5b88f7c669830661d-5"/>    <span class="n">gevent</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
<a name="rest_code_1a9d2431dcb245e5b88f7c669830661d-6"/>    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
<a name="rest_code_1a9d2431dcb245e5b88f7c669830661d-7"/>
<a name="rest_code_1a9d2431dcb245e5b88f7c669830661d-8"/><span class="k">def</span> <span class="nf">print_sum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<a name="rest_code_1a9d2431dcb245e5b88f7c669830661d-9"/>    <span class="n">result</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<a name="rest_code_1a9d2431dcb245e5b88f7c669830661d-10"/>    <span class="k">print</span> <span class="s">"</span><span class="si">%s</span><span class="s"> + </span><span class="si">%s</span><span class="s"> = </span><span class="si">%s</span><span class="s">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
<a name="rest_code_1a9d2431dcb245e5b88f7c669830661d-11"/>
<a name="rest_code_1a9d2431dcb245e5b88f7c669830661d-12"/><span class="n">print_sum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre>
<p>(Again, we'll want to start other greenlets to get any scalability benefit out
of this approach).</p>
<p>That's much simpler! We can simply omit all the generator cruft because
<tt class="docutils literal">gevent.sleep()</tt> can yield to the event loop (called the <tt class="docutils literal">hub</tt> in gevent)
without the involvement of the calling frames. Also, because we have first
class co-routines, the hub can be instantiated on demand; it doesn't need to be
created as the explicit parent of the stack.</p>
<p>Coroutines give us a magic jump right from our current stack to the event
loop - and back when ready:</p>
<object class="align-center" data="http://mauveweb.co.uk/presentations/gevent-talk/_static/coroutines.svg" type="image/svg+xml">
/presentations/gevent-talk/_static/coroutines.svg</object>
<p>The single piece of C-level magic allows us to write code that appears
synchronous, but actually has all the benefits of asynchronous I/O.</p>
</div>
<div class="section" id="gevent-greenlets-plus-monkey-patching">
<h2>Gevent: greenlets plus monkey-patching</h2>
<p>Suppose though the sleep wasn't in our code? We can use gevent's
monkey-patching to ensure that no code changes are necessary:</p>
<pre class="code python"><a name="rest_code_585b90383130438eb5bfae9515893ae2-1"/><span class="c"># These two lines have to be the first thing in your program, before</span>
<a name="rest_code_585b90383130438eb5bfae9515893ae2-2"/><span class="c"># anything else is imported</span>
<a name="rest_code_585b90383130438eb5bfae9515893ae2-3"/><span class="kn">from</span> <span class="nn">gevent.monkey</span> <span class="kn">import</span> <span class="n">patch_all</span>
<a name="rest_code_585b90383130438eb5bfae9515893ae2-4"/><span class="n">patch_all</span><span class="p">()</span>
<a name="rest_code_585b90383130438eb5bfae9515893ae2-5"/>
<a name="rest_code_585b90383130438eb5bfae9515893ae2-6"/><span class="kn">import</span> <span class="nn">time</span>
<a name="rest_code_585b90383130438eb5bfae9515893ae2-7"/>
<a name="rest_code_585b90383130438eb5bfae9515893ae2-8"/><span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<a name="rest_code_585b90383130438eb5bfae9515893ae2-9"/>    <span class="k">print</span> <span class="s">"Compute </span><span class="si">%s</span><span class="s"> + </span><span class="si">%s</span><span class="s"> ..."</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<a name="rest_code_585b90383130438eb5bfae9515893ae2-10"/>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
<a name="rest_code_585b90383130438eb5bfae9515893ae2-11"/>    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
<a name="rest_code_585b90383130438eb5bfae9515893ae2-12"/>
<a name="rest_code_585b90383130438eb5bfae9515893ae2-13"/><span class="k">def</span> <span class="nf">print_sum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<a name="rest_code_585b90383130438eb5bfae9515893ae2-14"/>    <span class="n">result</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<a name="rest_code_585b90383130438eb5bfae9515893ae2-15"/>    <span class="k">print</span> <span class="s">"</span><span class="si">%s</span><span class="s"> + </span><span class="si">%s</span><span class="s"> = </span><span class="si">%s</span><span class="s">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
<a name="rest_code_585b90383130438eb5bfae9515893ae2-16"/>
<a name="rest_code_585b90383130438eb5bfae9515893ae2-17"/><span class="n">print_sum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre>
<p>The bulk of blocking calls in the standard library are patched so that they
yield to the hub rather than blocking. Likewise the threading system is patched
so that greenlets are spawned instead of threads.</p>
</div>
<div class="section" id="isn-t-monkey-patching-bad">
<h2>Isn't monkey-patching bad?</h2>
<p>In this case it's better to think of gevent as a distribution of Python that
happens to use green threads, and includes different implementations of
standard library code.</p>
<p>This is part of the reason it has to come right at the top of the module that
contains the entry point of the program: it's a statement that before anything
else happens, we want to use the gevent's distribution of the stdlib.</p>
<p>While the monkey patching is elegant in that it allows pure Python applications
and libraries to become asynchronous with no modifications, it is an optional
component of gevent, and you can write asynchronous programs without it.</p>
<ul class="simple">
<li>Works with any existing synchronous, pure Python code.</li>
<li>Generally works with async code too - only <tt class="docutils literal">select()</tt> is emulated, but most
async frameworks have a <tt class="docutils literal">select()</tt>-based implementation. No reason
<tt class="docutils literal">epoll()</tt> etc couldn't be implemented.</li>
</ul>
</div>
<div class="section" id="examples-of-gevent-threading-primitives">
<h2>Examples of gevent threading primitives</h2>
<p>Because gevent is based on lightweight "threads" the gevent library contains a
wealth of concurrency tools that help you spawn greenlets, implement critical
sections (locks/mutexes), and pass messages between greenlets.</p>
<p>Because it's a networking library it also has some higher-level network server
modules, such as a TCP server and WSGI server.</p>
<div class="section" id="spawning-and-killing-greenlets">
<h3>Spawning and killing greenlets</h3>
<ul class="simple">
<li>
<tt class="docutils literal">gevent.spawn(function, *args, **kwargs)</tt>  - spawn a greenlet</li>
<li>
<tt class="docutils literal">gevent.kill(greenlet, exception=GreenletExit)</tt> - 'kill' a greenlet by
raising an exception in that greenlet.</li>
</ul>
<p>There are also higher-level primitives like <tt class="docutils literal">gevent.pool</tt>, a greenlet-based
equivalent to <tt class="docutils literal">multiprocessing.pool</tt>.</p>
</div>
<div class="section" id="synchronisation-primitives">
<h3>Synchronisation primitives</h3>
<ul class="simple">
<li><tt class="docutils literal">gevent.lock.Sempahore</tt></li>
<li><tt class="docutils literal">gevent.lock.RLock</tt></li>
<li><tt class="docutils literal">gevent.event.Event</tt></li>
</ul>
</div>
<div class="section" id="message-passing">
<h3>Message Passing</h3>
<ul class="simple">
<li><tt class="docutils literal">gevent.queue.Queue</tt></li>
<li>
<tt class="docutils literal">gevent.event.AsyncResult</tt> - block waiting for a single result. Also
allows an exception to be raised instead.</li>
</ul>
</div>
<div class="section" id="timeouts">
<h3>Timeouts</h3>
<p>There's a useful wrapper to kill a greenlet if it doesn't succeed within a
certain period of time. This can be used to wrap timeouts around pretty much
any sequence of operations:</p>
<pre class="code python"><a name="rest_code_481d3000eeb24f0b85050dd15ccc5a30-1"/><span class="kn">from</span> <span class="nn">gevent</span> <span class="kn">import</span> <span class="n">Timeout</span>
<a name="rest_code_481d3000eeb24f0b85050dd15ccc5a30-2"/>
<a name="rest_code_481d3000eeb24f0b85050dd15ccc5a30-3"/><span class="k">with</span> <span class="n">Timeout</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
<a name="rest_code_481d3000eeb24f0b85050dd15ccc5a30-4"/>    <span class="n">data</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</pre>
</div>
<div class="section" id="higher-level-server-kit">
<h3>Higher level server kit</h3>
<ul class="simple">
<li>
<tt class="docutils literal">gevent.server.StreamServer</tt> - TCP server. Also supports SSL.</li>
<li>
<tt class="docutils literal">gevent.server.DatagramServer</tt> - UDP server.</li>
<li>
<tt class="docutils literal">gevent.pywsgi.WSGIServer</tt> - WSGI server that supports streaming,
keepalives, SSL etc.</li>
</ul>
</div>
</div>
<div class="section" id="gevent-i-o-patterns">
<h2>Gevent I/O patterns</h2>
<p>The recommended way of using gevent (and avoiding <tt class="docutils literal">select()</tt>) is to spawn one
greenlet for each direction of communication - read or write. The code for each
greenlet is a simple loop that "blocks" whenever necessary. See the <a class="reference external" href="http://mauveweb.co.uk/posts/2014/07/gevent-asynchronous-io-made-easy.html#chat-server">chat
server</a> code earlier for an example.</p>
</div>
<div class="section" id="why-do-we-want-a-synchronous-programming-model">
<h2>Why do we want a synchronous programming model?</h2>
<p>First of all, it makes the code easier to read and understand. It's the same
kind of programming you do when single-threaded. The code isn't dotted with
<tt class="docutils literal">yield from</tt> statements.</p>
<p>More significantly, of the methods described above, only gevent requires no
changes to the calling conventions of other code. The importance of this should
not be understated: it means that your business logic can happily call into
blocking code.</p>
<p>As a very simple example, say we want to do a streaming API. Our pre-existing
business logic (<tt class="docutils literal">process_orders()</tt>) expects an iterable. With gevent, we can
stream this iterable asynchronously from a remote server with no code changes!</p>
<pre class="code python"><a name="rest_code_effc2d2f49d544be8bc9211dc8c4a4ea-1"/><span class="kn">from</span> <span class="nn">gevent.socket</span> <span class="kn">import</span> <span class="n">create_connection</span>
<a name="rest_code_effc2d2f49d544be8bc9211dc8c4a4ea-2"/>
<a name="rest_code_effc2d2f49d544be8bc9211dc8c4a4ea-3"/><span class="k">def</span> <span class="nf">process_orders</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
<a name="rest_code_effc2d2f49d544be8bc9211dc8c4a4ea-4"/>    <span class="sd">"""Do something important with an iterable of lines."""</span>
<a name="rest_code_effc2d2f49d544be8bc9211dc8c4a4ea-5"/>    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
<a name="rest_code_effc2d2f49d544be8bc9211dc8c4a4ea-6"/>        <span class="o">...</span>
<a name="rest_code_effc2d2f49d544be8bc9211dc8c4a4ea-7"/>
<a name="rest_code_effc2d2f49d544be8bc9211dc8c4a4ea-8"/>
<a name="rest_code_effc2d2f49d544be8bc9211dc8c4a4ea-9"/><span class="c"># Create an asynchronous file-like object with gevent</span>
<a name="rest_code_effc2d2f49d544be8bc9211dc8c4a4ea-10"/><span class="n">socket</span> <span class="o">=</span> <span class="n">create_connection</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
<a name="rest_code_effc2d2f49d544be8bc9211dc8c4a4ea-11"/><span class="n">f</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">makefile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s">'r'</span><span class="p">)</span>
<a name="rest_code_effc2d2f49d544be8bc9211dc8c4a4ea-12"/><span class="n">process_orders</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre>
<p>Another advantage is that exceptions can always be raised, in a sensible place.</p>
<p>Unlike real threads, greenlets are never suspended at arbitrary times, so you
can get away with many fewer locks and mutexes - you only need a mutex if
there's a risk you might "block" between atomic operations.</p>
<p>Also unlike real threads, a greenlet can "kill" another greenlet - causing an
exception to be raised in that greenlet when it next resumes.</p>
</div>
<div class="section" id="disdvantages">
<h2>Disdvantages</h2>
<p>Bad news: the Python 3 branch of gevent isn't finished. I have not investigated
whether it is at all usable.</p>
<p>One solution is to allow different implementation languages in different parts
of your stack. gevent is great at dealing with scalable I/O, Python 3 is good
at Unicode and user-facing applications. It may be possible to arrange to use
the right tool for each job.</p>
</div>
<div class="section" id="pitfalls-of-asynchronous-i-o">
<h2>Pitfalls of asynchronous I/O</h2>
<p>Gevent shares several pitfalls with many asynchronous I/O frameworks:</p>
<ul class="simple">
<li>Blocking (real blocking, at the kernel level) somewhere in your program halts
<em>everything</em>. This is most likely in C code where monkey patches don't take
effect. You need to take careful steps to make your C library "green".</li>
<li>Keeping the CPU busy. greenlets are not preempted, so this will cause
other greenlets never to be scheduled.</li>
<li>There exists the possibility of deadlock between greenlets.</li>
</ul>
<p>In summary gevent has very few pitfalls that are not present in other async I/O
frameworks (sure, you probably can't deadlock callbacks but only because the
event loop probably doesn't provide the synchronisation primitives to do so, so
you also can't implement critical sections).</p>
<p>One pitfall gevent sidesteps is that you are less likely to hit
an async-unaware Python library that will block your app, because pure Python
libraries will use the monkey patched stdlib.</p>
</div>
<div class="section" id="n-to-m-concurrency">
<h2>n to m concurrency</h2>
<p>An approach for even better scalability is to run n greenlets on m physical
threads. In Python we need to do this with processes. This gives very good
performance on multiprocessor systems, as well as adding resilience.</p>
<p>This is the model that is used by Rust and Java among others.</p>
</div>
<div class="section" id="experiences-with-gevent">
<h2>Experiences with gevent</h2>
<p>I evaluated gevent as well as the other systems mentioned in 2011. Gevent was
the clear winner. There was little to choose from in terms of performance, but
gevent's significantly simpler programming model was a major selling point.
Not all developers are at the level where they are comfortable with
generators, closures and callbacks, and gevent doesn't require them: you can
use whatever techniques make your code most legible.</p>
<p>The ability to use gevent with existing code, or business logic that is
agnostic about IO, was very valuable too: you probably want to re-use certain
business logic libraries in both high-performance network apps and offline
batch processes.</p>
<p>Over the following 18 months we wrote a variety of network applications.
One byproduct was a web service framework called <a class="reference external" href="http://nucleon.readthedocs.org/en/latest/">nucleon</a>, which aimed to
connect RESTful JSON, PostgreSQL and AMQP, all with 'green' driver code for
high scalability.</p>
<p>Though we had to make code changes to use PostgreSQL without blocking, gevent's
monkey patching meant that the pure-Python drivers for other data stores just
worked - so Redis, ElasticSearch and CouchDB could all be used transparently.</p>
<p>The AMQP library was originally a fork of Puka (not Pika), an AMQP library that
didn't try to force its own brand of async on you (like Pika). I eventually
completely rewrote this and split it into a separate project called
<a class="reference external" href="http://pythonhosted.org/nucleon.amqp/">nucleon.amqp</a>. <tt class="docutils literal">nucleon.amqp</tt> allows interaction with an AMQP server with a
fully synchronous programming model - remote queues on the AMQP broker can be
exposed locally with the Queue API.</p>
<p>It wasn't without head-scratching moments, as with any concurrent programming
project. However as a team we adapted to gevent and found ourselves developing
a language of diagrams to explain to each other and understand how the flow of
control moves between greenlets, how they block and how they signal each other.</p>
<p>The project was successful - we were able to keep our code simple and
maintainable while ensuring our services were fast and scalable (a claim
backed up by load testing).</p>
</div>
</div>
    </div></body></html>