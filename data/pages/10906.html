<html><body><div><div class="main-content-wrap">
            <p>Lately I’ve been using Jupyter (formerly, IPython) notebooks frequently for reproducible research, and I’ve been wondering how it all works underneath the hood. Furthermore, I’ve needed some custom functionality that IPython doesn’t include by default. Instead of extending IPython, I decided I would take a stab at building my own simple IPython kernel that runs on a remote server where my GPU farm lives. I won’t be worrying about security or concurrency, since I will be the only person with access to the server. The exercise should give you an idea about how server-based coding environments work in Python.</p>
<p>Since this is not a production server, Flask is perfect for our needs. Let’s start with a simple Flask server that does nothing. I’ll include some imports we will need later.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br/><span class="line"><span class="keyword">import</span> traceback</span><br/><span class="line"><span class="keyword">from</span> cStringIO <span class="keyword">import</span> StringIO</span><br/><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, jsonify, request</span><br/><span class="line"/><br/><span class="line">app = Flask(__name__)</span><br/><span class="line"/><br/><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br/><span class="line">    app.run()</span><br/></pre></td></tr></table></figure>
<h2 id="Executing-Code"><a href="#Executing-Code" class="headerlink" title="Executing Code"/>Executing Code</h2><p>There is really only one magical piece to cover here: how does Python take a string of code, execute it, then return the output? Let’s start with the novel approach.</p>
<p>You can execute any Python statement using the <code>exec()</code> command. I’m going to create a Flask endpoint that takes a POST parameter named ‘code’, splits the command by newlines, and runs each command in sequence. Here is what the code looks like.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br/><span class="line"><span class="keyword">import</span> traceback</span><br/><span class="line"><span class="keyword">from</span> cStringIO <span class="keyword">import</span> StringIO</span><br/><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, jsonify, request</span><br/><span class="line"/><br/><span class="line">app = Flask(__name__)</span><br/><span class="line"/><br/><span class="line"><span class="decorator">@app.route("/", methods=['POST'])</span></span><br/><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">kernel</span><span class="params">()</span>:</span></span><br/><span class="line">    code_lns = request.form[<span class="string">'code'</span>].split(<span class="string">'\\n'</span>)</span><br/><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> code_lns: exec(line)</span><br/><span class="line">    <span class="keyword">return</span> <span class="string">'Success'</span></span><br/><span class="line"/><br/><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br/><span class="line">    app.run()</span><br/></pre></td></tr></table></figure>
<p>Easy enough! You already have a minimal, Python-executing server in 15 lines of code (including unused imports and correct spacing). To test this, I use the <a href="https://chrome.google.com/webstore/detail/postman/fhbjgbiflinjbdggehcddcbncdddomop" target="_blank" rel="external">POSTMAN client</a> to hit my local server with POST requests.</p>
<p>Send a POST request to <code>http:localhost:5000/</code> with the POST parameter ‘code’ set to <code>print('hello world')</code> like the picture below and hit ‘Send’. As expected, the server reads, the code, prints out ‘Hello world’, then exits.</p>
<img src="/2016/02/18/Creating-your-own-IPython-like-server/output1.png" alt="output1.png" title=""/>
<h2 id="Redirecting-Output"><a href="#Redirecting-Output" class="headerlink" title="Redirecting Output"/>Redirecting Output</h2><p>This isn’t very useful to us yet — although the server successfully receives and executes the code, the client only receives a “Success” message. Ideally, we would want to redirect the output from the program executing back to the client. To achieve this, we must capture what is being written to standard out buffer into a string buffer and return this string to the client. After some research, I determined this could be done by temporarily redirecting standard out to a StringIO buffer, like so:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/></pre></td><td class="code"><pre><span class="line"><span class="decorator">@app.route("/", methods=['POST'])</span></span><br/><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">kernel</span><span class="params">()</span>:</span></span><br/><span class="line">    code_lns = request.form[<span class="string">'code'</span>].split(<span class="string">'\\n'</span>)</span><br/><span class="line"/><br/><span class="line">    <span class="comment"># Store old stdout location</span></span><br/><span class="line">    old_stdout = sys.stdout</span><br/><span class="line"/><br/><span class="line">    <span class="comment"># Redirect stdout to our string buffer</span></span><br/><span class="line">    sys.stdout = strstdout = StringIO()</span><br/><span class="line"/><br/><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> code_lns:</span><br/><span class="line">        exec(line)</span><br/><span class="line"/><br/><span class="line">    <span class="comment"># Reset stdout to its origin location</span></span><br/><span class="line">    sys.stdout = old_stdout</span><br/><span class="line"/><br/><span class="line">    <span class="comment"># Get the value stored in the string buffer</span></span><br/><span class="line">    <span class="keyword">return</span> strstdout.getvalue()</span><br/></pre></td></tr></table></figure>
<p>Looking at the output from the Postman Client, we can see that the server is now relaying back the stdout to the client as expected.</p>
<center><br/><img src="/2016/02/18/Creating-your-own-IPython-like-server/output2.png" alt="output2.png" title=""/><br/></center>

<p><strong>Note</strong>: Redirecting standard out in this way will redirect the output for all clients connecting. Thus, if you have multiple people running code at the exact same time, the outputs will overlap. Don’t do this. That’s why I noted this was not a production ready server.</p>
<h2 id="Different-Environments"><a href="#Different-Environments" class="headerlink" title="Different Environments"/>Different Environments</h2><p>There is another major problem in our implementation — everything is executed in the same environment. One of the nice things about IPython is that you can work in several different notebooks at the same time, and none of the variables or functionality overlap. This concept does not exist in our design: if I’m working on two different ideas at the same time, all of the variables between the two scripts would be shared.</p>
<p>The problem lies in the <code>exec()</code> command, which I mentioned was the novel approach earlier. Remember that in Python, everything in the environment (technically a namespace in Python) is just stored as a dict in the <code>__dict__</code> field (see <a href="https://docs.python.org/2/reference/datamodel.html" target="_blank" rel="external">this post</a> for more information). We can execute code in different environments by doing something like this:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line">env = {}</span><br/><span class="line">code = compile(<span class="string">'j = 1'</span>, <span class="string">'&lt;string&gt;'</span>, <span class="string">'exec'</span>)</span><br/><span class="line"><span class="keyword">exec</span> code <span class="keyword">in</span> env</span><br/></pre></td></tr></table></figure>
<p>After these code snippet has executed, <code>env['j']</code> would have a value of <code>1</code> stored. Furthermore, any variable in <code>env</code> is able to be used in our code. We can take advantage of this technique to run code in multiple different environments.</p>
<p>First, let’s introduce some boilerplate functionality for creating, deleting, and getting information about a new <code>environments</code> variable (a dict of dicts containing all of the environments for a given environment id).</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/></pre></td><td class="code"><pre><span class="line">environments = {}</span><br/><span class="line"/><br/><span class="line"><span class="decorator">@app.route('/env/create', methods=['POST'])</span></span><br/><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">()</span>:</span></span><br/><span class="line">    env_id = request.form[<span class="string">'id'</span>]</span><br/><span class="line">    <span class="keyword">if</span> env_id <span class="keyword">not</span> <span class="keyword">in</span> environments:</span><br/><span class="line">        environments[env_id] = {}</span><br/><span class="line">    <span class="keyword">return</span> jsonify(envs=environments.keys())</span><br/><span class="line"/><br/><span class="line"><span class="decorator">@app.route('/env/delete', methods=['POST'])</span></span><br/><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">()</span>:</span></span><br/><span class="line">    env_id = request.form[<span class="string">'id'</span>]</span><br/><span class="line">    <span class="keyword">if</span> env_id <span class="keyword">in</span> environments:</span><br/><span class="line">        <span class="keyword">del</span> environments[env_id]</span><br/><span class="line">    <span class="keyword">return</span> jsonify(envs=environments.keys())</span><br/><span class="line"/><br/><span class="line"><span class="decorator">@app.route('/env/get', methods=['POST'])</span></span><br/><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getenv</span><span class="params">()</span>:</span></span><br/><span class="line">    env_id = request.form[<span class="string">'id'</span>]</span><br/><span class="line">    <span class="keyword">if</span> env_id <span class="keyword">in</span> environments:</span><br/><span class="line">        <span class="keyword">return</span> jsonify(env=environments[env_id].keys())</span><br/><span class="line">    <span class="keyword">else</span>:</span><br/><span class="line">        <span class="keyword">return</span> jsonify(error=<span class="string">'Environment does not exist!'</span>)</span><br/></pre></td></tr></table></figure>
<p>Now, if I send a POST request to <code>http://localhost:5000/env/create</code> with the POST parameters set to <code>{id: 1}</code>, the server creates a blank dictionary for the environment id and sends me back all environments that have been created. Similarly, I could delete environments or get all available information in the environment.</p>
<p>Hooking this up with our code execution is pretty simple as well.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/></pre></td><td class="code"><pre><span class="line"><span class="decorator">@app.route("/", methods=['POST'])</span></span><br/><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">kernel</span><span class="params">()</span>:</span></span><br/><span class="line">    env_id = request.form[<span class="string">'id'</span>]</span><br/><span class="line">    <span class="keyword">if</span> env_id <span class="keyword">not</span> <span class="keyword">in</span> environments:</span><br/><span class="line">        <span class="keyword">return</span> jsonify(error=<span class="string">'Kernel does not exist!'</span>)</span><br/><span class="line">    code_lns = request.form[<span class="string">'code'</span>].split(<span class="string">'\\n'</span>)</span><br/><span class="line">    old_stdout = sys.stdout</span><br/><span class="line">    sys.stdout = strstdout = StringIO()</span><br/><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> code_lns:</span><br/><span class="line">        code = compile(line, <span class="string">'&lt;string&gt;'</span>, <span class="string">'exec'</span>)</span><br/><span class="line">        <span class="keyword">exec</span> code <span class="keyword">in</span> environments[env_id]</span><br/><span class="line">    sys.stdout = old_stdout</span><br/><span class="line">    <span class="keyword">return</span> jsonify(message=strstdout.getvalue())</span><br/></pre></td></tr></table></figure>
<p>Note that now, I have taken care to execute each code statement in the environment id provided.</p>
<h2 id="Error-Handling"><a href="#Error-Handling" class="headerlink" title="Error Handling"/>Error Handling</h2><p>There is one last, glaringly obvious bug in our code: our design fails miserably when an error occurs. If you had mistyped anything so far in the tutorial, such as sending <code>prnt('hi')</code> to the server, you would have received a solemn 500 error with no extra information from our server. Ideally, we would much rather receive the stack trace on the client side than a response that is so opaque!</p>
<p>Adding error handling to our server is as simple as catching errors and printing the stack trace to standard out. We can get the stacktrace by calling <code>traceback.format_exc()</code>. Since I like to make it blatantly obvious that an error has occurred, I watch for an error to occur, then send back the stacktrace under the ‘error’ key.</p>
<p>We can modify our kernel method slightly to get the functionality we require.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/></pre></td><td class="code"><pre><span class="line"><span class="decorator">@app.route("/", methods=['POST'])</span></span><br/><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">kernel</span><span class="params">()</span>:</span></span><br/><span class="line">    error = <span class="keyword">False</span></span><br/><span class="line">    env_id = request.form[<span class="string">'id'</span>]</span><br/><span class="line">    <span class="keyword">if</span> env_id <span class="keyword">not</span> <span class="keyword">in</span> environments:</span><br/><span class="line">        <span class="keyword">return</span> jsonify(error=<span class="string">'Kernel does not exist!'</span>)</span><br/><span class="line">    code_lns = request.form[<span class="string">'code'</span>].split(<span class="string">'\\n'</span>)</span><br/><span class="line">    old_stdout = sys.stdout</span><br/><span class="line">    sys.stdout = strstdout = StringIO()</span><br/><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> code_lns:</span><br/><span class="line">        <span class="keyword">try</span>:</span><br/><span class="line">            code = compile(line, <span class="string">'&lt;string&gt;'</span>, <span class="string">'exec'</span>)</span><br/><span class="line">            <span class="keyword">exec</span> code <span class="keyword">in</span> environments[env_id]</span><br/><span class="line">        <span class="keyword">except</span>:</span><br/><span class="line">            print(traceback.format_exc())</span><br/><span class="line">            error = <span class="keyword">True</span></span><br/><span class="line">    sys.stdout = old_stdout</span><br/><span class="line">    <span class="keyword">if</span> error: <span class="keyword">return</span> jsonify(error=strstdout.getvalue())</span><br/><span class="line">    <span class="keyword">else</span>: <span class="keyword">return</span> jsonify(message=strstdout.getvalue())</span><br/></pre></td></tr></table></figure>
<h2 id="Final-Thoughts"><a href="#Final-Thoughts" class="headerlink" title="Final Thoughts"/>Final Thoughts</h2><p>All in all, this code gets us a long way towards creating our own IPython-like server. Writing up a simple frontend to interact back and forth with the JSON-based server is outside the scope of what I was trying to do here, but it certainly isn’t hard.</p>
<p>As for the issues with concurrency and security, many of these could be resolved by the use of <a href="https://www.docker.com/" target="_blank" rel="external">Docker containers</a>, which allow sandboxing and could be spun up or broken down as clients connect. This sandboxing would also fix the standard out redirection issue.</p>
<p>Below is the final code. 52 lines of code for a fully functioning, elegant, session-based Python kernel is not too shabby if I do say so myself. Please let me know if you have any other ideas on how to simplify/improve the code. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/><span class="line">30</span><br/><span class="line">31</span><br/><span class="line">32</span><br/><span class="line">33</span><br/><span class="line">34</span><br/><span class="line">35</span><br/><span class="line">36</span><br/><span class="line">37</span><br/><span class="line">38</span><br/><span class="line">39</span><br/><span class="line">40</span><br/><span class="line">41</span><br/><span class="line">42</span><br/><span class="line">43</span><br/><span class="line">44</span><br/><span class="line">45</span><br/><span class="line">46</span><br/><span class="line">47</span><br/><span class="line">48</span><br/><span class="line">49</span><br/><span class="line">50</span><br/><span class="line">51</span><br/><span class="line">52</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br/><span class="line"><span class="keyword">import</span> traceback</span><br/><span class="line"><span class="keyword">from</span> cStringIO <span class="keyword">import</span> StringIO</span><br/><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, jsonify, request</span><br/><span class="line"/><br/><span class="line">app = Flask(__name__)</span><br/><span class="line">environments = {}</span><br/><span class="line"/><br/><span class="line"><span class="decorator">@app.route('/env/create', methods=['POST'])</span></span><br/><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">()</span>:</span></span><br/><span class="line">    kernel_id = request.form[<span class="string">'id'</span>]</span><br/><span class="line">    <span class="keyword">if</span> kernel_id <span class="keyword">not</span> <span class="keyword">in</span> environments:</span><br/><span class="line">        environments[kernel_id] = {}</span><br/><span class="line">    <span class="keyword">return</span> jsonify(envs=environments.keys())</span><br/><span class="line"/><br/><span class="line"><span class="decorator">@app.route('/env/delete', methods=['POST'])</span></span><br/><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">()</span>:</span></span><br/><span class="line">    kernel_id = request.form[<span class="string">'id'</span>]</span><br/><span class="line">    <span class="keyword">if</span> kernel_id <span class="keyword">in</span> environments:</span><br/><span class="line">        <span class="keyword">del</span> environments[kernel_id]</span><br/><span class="line">    <span class="keyword">return</span> jsonify(envs=environments.keys())</span><br/><span class="line"/><br/><span class="line"><span class="decorator">@app.route('/env/get', methods=['POST'])</span></span><br/><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getenv</span><span class="params">()</span>:</span></span><br/><span class="line">    kernel_id = request.form[<span class="string">'id'</span>]</span><br/><span class="line">    <span class="keyword">if</span> kernel_id <span class="keyword">in</span> environments:</span><br/><span class="line">        <span class="keyword">return</span> jsonify(env=environments[kernel_id].keys())</span><br/><span class="line">    <span class="keyword">else</span>:</span><br/><span class="line">        <span class="keyword">return</span> jsonify(error=<span class="string">'Environment does not exist!'</span>)</span><br/><span class="line"/><br/><span class="line"><span class="decorator">@app.route("/", methods=['POST'])</span></span><br/><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">kernel</span><span class="params">()</span>:</span></span><br/><span class="line">    error = <span class="keyword">False</span></span><br/><span class="line">    kernel_id = request.form[<span class="string">'id'</span>]</span><br/><span class="line">    <span class="keyword">if</span> kernel_id <span class="keyword">not</span> <span class="keyword">in</span> environments:</span><br/><span class="line">        <span class="keyword">return</span> jsonify(error=<span class="string">'Kernel does not exist!'</span>)</span><br/><span class="line">    code_lns = request.form[<span class="string">'code'</span>].split(<span class="string">'\\n'</span>)</span><br/><span class="line">    old_stdout = sys.stdout</span><br/><span class="line">    sys.stdout = strstdout = StringIO()</span><br/><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> code_lns:</span><br/><span class="line">        <span class="keyword">try</span>:</span><br/><span class="line">            code = compile(line, <span class="string">'&lt;string&gt;'</span>, <span class="string">'exec'</span>)</span><br/><span class="line">            <span class="keyword">exec</span> code <span class="keyword">in</span> environments[kernel_id]</span><br/><span class="line">        <span class="keyword">except</span>:</span><br/><span class="line">            print(traceback.format_exc())</span><br/><span class="line">            error = <span class="keyword">True</span></span><br/><span class="line">    sys.stdout = old_stdout</span><br/><span class="line">    <span class="keyword">if</span> error: <span class="keyword">return</span> jsonify(error=strstdout.getvalue())</span><br/><span class="line">    <span class="keyword">else</span>: <span class="keyword">return</span> jsonify(message=strstdout.getvalue())</span><br/><span class="line"/><br/><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br/><span class="line">    app.run()</span><br/></pre></td></tr></table></figure>

            
                

            
        </div>
    </div></body></html>