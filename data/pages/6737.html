<html><body><div><div class="content html_format"><p>
      Появилась задача обезопасить админскую часть на сайте. Причём это надо было сделать без внесения изменений в код самого сайта. Лучшее, что смог я найти — </p><a href="https://github.com/bitly/oauth2_proxy">oauth2_proxy</a><p> и </p><a href="https://github.com/agoragames/nginx-google-oauth">nginx-google-oauth</a><p>, но они требовали обработку коллбэков. Эти решения мне не понравились и я их отверг.
</p><p>
Пришлось обратиться к одному из </p><a href="http://nginx.org/ru/docs/http/ngx_http_auth_request_module.html">модулей</a><p> nginx и </p><a href="http://flask.pocoo.org/">комплектующим</a><p> для </p><a href="https://www.python.org/download/releases/2.7/">велосипеда</a><p>.
</p><a name="habracut"/><p>
Т.к. я не являюсь программистом, то с радостью приму замечания по моему маргарин-коду. И так. Я набросал простое </p><a href="https://github.com/loukash/otp-auth">приложение</a><p>.

</p><i>Пример установки будет на основе Debian/Ubuntu.</i>
<p>
Установка:

</p><pre><code class="bash"># установим nginx  с поддержкой модуля ngx_http_auth_request_module 
nginx -V 2&gt;&amp;1 | grep -qF -- --with-http_auth_request_module &amp;&amp; echo "OK" || sudo aptitude update &amp;&amp; sudo aptitude install nginx-extras
# клонируем репозитарий
git clone git@github.com:loukash/otp-auth.git  # или git clone git@bitbucket.org:loukash/otp-auth.git
# установим все зависимости
cd otp-auth
pip install -r requirements.txt
</code></pre><p>
Настройка приложения:

</p><pre><code class="bash"># создадим базу пользователей
python manage.py initdb
#  добавим пользователя
python manage.py useradd -l test
</code></pre><p>
Последняя команда выдаст что-то подобное:
</p><i>Scan QR: <a href="http://2qr.ru/otpauth://totp/OTPAuth:test1?secret=LOS5VMN5WI3FUTE4&amp;issuer=OTPAuth">http://2qr.ru/otpauth://totp/OTPAuth:test1?secret=LOS5VMN5WI3FUTE4&amp;issuer=OTPAuth</a></i>
<i>Or add manually SECRET KEY: LOS5VMN5WI3FUTE4</i>
<i>Emergency codes: 39816948,88908661,07327337,95159743,24616032</i>
<p>
Добавляем это в ваш OTP-генератор. Я думаю, что у вас уже установлен Google Authentificator или подобное. Если же нет, тогда придётся установить. </p><a href="https://support.google.com/accounts/answer/1066447?hl=ru">Тут</a><p> помощь от Гугла. При добавлении пользователей генерируются ещё и резервные коды, на случай, если вы потеряете свой телефон.
</p><p>
Переходим к настройке nginx. Для выбранного location надо добавить:

</p><pre><code class="bash">location /private {
  ...
  auth_request /auth;
  error_page 401 /login;
  ...
}
</code></pre><p>
А эти location делают авторизацию:

</p><pre><code class="bash">location = /auth {
  internal;
  proxy_pass_request_body off;
  proxy_set_header Content-Length "";
  proxy_pass http://127.0.0.1:5000;
}

location = /login {
  proxy_pass http://127.0.0.1:5000;
}
</code></pre><p>
Запускаем наше приложение и рестартуем nginx:

</p><pre><code class="bash">sudo service nginx reload
python manage.py runserver
</code></pre><p>
Теперь при открытии </p><a href="http://site.name/private">site.name/private</a><p> вы увидите страницу ввода одноразового пароля:

</p><img src="https://habrastorage.org/files/bca/edd/a6d/bcaedda6d5924d52b7b1450e104c697c.png" alt="image"/>
<p>
Что реализовано:

</p><ul>
<li> Проверка одноразового пароля</li>
<li> Управление пользователями</li>
<li> Резервные коды</li>
</ul><p>
Что в планах:

</p><ul>
<li> Сделать приложение настраиваемым</li>
<li> Демонизация</li>
<li> Логгирование</li>
</ul>
      <p class="clear"/>
    </div>

    
  </div></body></html>