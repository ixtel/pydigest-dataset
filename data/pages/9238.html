<html><body><div><div class="entry-content">
		<p/><center><img src="http://www.kpkaiser.com/wp-content/uploads/2016/01/out.gif"/><img src="http://www.kpkaiser.com/wp-content/uploads/2016/01/out.gif"/><img src="http://www.kpkaiser.com/wp-content/uploads/2016/01/out.gif"/></center>

<p/><center><strong>Teaching Machines Nonsense</strong></center>
<p>Last Wednesday, while joking at the end of the workday, the idea came up to make an neural network that generates Amazon reviews. </p>
<p>Above you can see the results for images, reviews, prices, and product names generated by neural networks trained on Amazon’s data.</p>
<p>All of this was possible thanks to the dataset provided by Julian McAuley, used in the <a href="http://cseweb.ucsd.edu/~jmcauley/pdfs/sigir15.pdf">SIGIR</a> and <a href="http://cseweb.ucsd.edu/~jmcauley/pdfs/kdd15.pdf">KDD</a> papers, along with the torch-gan and char-rnn sources. We’ll walk through adapting this dataset and adapting it to train these neural networks in this writeup.</p>
<p>We’ll step through the thought process behind adapting and extending a dataset, and we’ll document the road blocks as we run into them along the way. I hope leaving these in will help beginners see that very often, programming requires running into wall after wall until you finally reach the other side.</p>
<p>We’ll cover how to load the dataset, how to generate fake product images, reviews, prices, and product names, and then export them for presentation. I hope you’ll enjoy the ride, even if you’re not necessarily into programming. I just want to give you an idea for how writing and extending an AI bot works when working from a given data set.</p>
<p>The finished neural networks and code with instructions are at <a href="">Github</a>. </p>
<p>So, let’s begin.</p>
<p/>
<p/><center><strong>Meeting Your Data</strong></center>
<p>The very first thing I did once I received the data set was to take a look at it, to get an idea for its formatting. It was originally compressed with gzip, and so I needed to uncompress it on my external drive.</p>
<p>Uncompressed, it was 68 gigabytes. When you’re working with large files, it can get tricky to figure out what you’ve got, and to make the most basic of assumptions. So the first thing to do is take a look at what you’re working with, and how messy your data might be.</p>
<p>In my case, I just used the ‘less’ command, to take a look at the first few lines in my terminal. This is easy enough to do in the command line:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash">$ <span>less</span> user_dedup.json
<span>{</span><span>"reviewerID"</span>: <span>"A00000262KYZUE4J55XGL"</span>, <span>"asin"</span>: <span>"B003UYU16G"</span>, <span>"reviewerName"</span>: <span>"Steven N Elich"</span>, <span>"helpful"</span>: <span>[</span><span>0</span>, <span>0</span><span>]</span>, <span>"reviewText"</span>: <span>"It is and does exactly what the description said it would be and would do. Couldn't be happier with it."</span>, <span>"overall"</span>: <span>5.0</span>, <span>"summary"</span>: <span>"Does what it's supposed to do"</span>, <span>"unixReviewTime"</span>: <span>1353456000</span>, <span>"reviewTime"</span>: <span>"11 21, 2012"</span><span>}</span>
<span>{</span><span>"reviewerID"</span>: <span>"A000008615DZQRRI946FO"</span>, <span>"asin"</span>: <span>"B005FYPK9C"</span>, <span>"reviewerName"</span>: <span>"mj waldon"</span>, <span>"helpful"</span>: <span>[</span><span>0</span>, <span>0</span><span>]</span>, <span>"reviewText"</span>: <span>"I was sketchy at first about these but once you wear them for a couple hours they break in they fit good on my board an have little wear from skating in them. They are a little heavy but won't get eaten up as bad by your grip tape like poser dc shoes."</span>, <span>"overall"</span>: <span>5.0</span>, <span>"summary"</span>: <span>"great buy"</span>, <span>"unixReviewTime"</span>: <span>1357603200</span>, <span>"reviewTime"</span>: <span>"01 8, 2013"</span><span>}</span>
<span>{</span><span>"reviewerID"</span>: <span>"A00000922W28P2OCH6JSE"</span>, <span>"asin"</span>: <span>"B000VEBG9Y"</span>, <span>"reviewerName"</span>: <span>"Gabriel Merrill"</span>, <span>"helpful"</span>: <span>[</span><span>0</span>, <span>0</span><span>]</span>, <span>"reviewText"</span>: <span>"Very mobile product. Efficient. Easy to use; however product needs a varmint guard. Critters are able to gorge themselves without a guard."</span>, <span>"overall"</span>: <span>3.0</span>, <span>"summary"</span>: <span>"Great product but needs a varmint guard."</span>, <span>"unixReviewTime"</span>: <span>1395619200</span>, <span>"reviewTime"</span>: <span>"03 24, 2014"</span><span>}</span>
<span>{</span><span>"reviewerID"</span>: <span>"A00000922W28P2OCH6JSE"</span>, <span>"asin"</span>: <span>"B001EJMS6K"</span>, <span>"reviewerName"</span>: <span>"Gabriel Merrill"</span>, <span>"helpful"</span>: <span>[</span><span>0</span>, <span>0</span><span>]</span>, <span>"reviewText"</span>: <span>"Easy to use a mobile. If you're taller than 4ft, be ready to tuck your legs behind you as you hang and pull."</span>, <span>"overall"</span>: <span>4.0</span>, <span>"summary"</span>: <span>"Great inexpensive product. Mounts easily and transfers to the ground for multiple push up positions."</span>, <span>"unixReviewTime"</span>: <span>1395619200</span>, <span>"reviewTime"</span>: <span>"03 24, 2014"</span><span>}</span></pre></td></tr></table></div>

<p>We can immediately see that our JSON file isn’t really in JSON, but it’s in a kind of Python dictionary object. And indeed, when I look at the web url that I got this info from, it says specifically that each line can just be ‘eval’d in Python in order to generate one object at a time.</p>
<p>This makes it easier to deal with this large of a file, because it means we don’t need to read the entire list into memory just to create our object. (Which could take minutes to hours to do.) Instead, we can go line by line in our file, and each review individually into memory.</p>
<p><span id="more-1098"/></p>
<p/><center><strong>Extracting a 1 Star Review Dataset</strong></center>
<p><br/>
Now, what are we interested in here? For me, the funniest thing was generating 1 star products and product reviews. So, I wrote a quick script to print out all the 1 star reviews, in the same format Amazon has on their site:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python"><span>def</span> generateReviews<span>(</span><span>)</span>:
    daFile <span>=</span> <span>open</span><span>(</span><span>'user_dedup.json'</span><span>,</span> <span>'r'</span><span>)</span>
    <span>for</span> line <span>in</span> daFile:
        <span>yield</span> <span>eval</span><span>(</span>line<span>)</span>
 
<span>with</span> <span>open</span><span>(</span><span>'onestarReviews.txt'</span><span>,</span> <span>'w'</span><span>)</span> <span>as</span> outty:
    <span>for</span> line <span>in</span> generateReviews<span>(</span><span>)</span>:
        <span>if</span> line<span>[</span><span>'overall'</span><span>]</span> <span>==</span> <span>1.0</span>:
            <span>try</span>:
                theOutput <span>=</span> line<span>[</span><span>'summary'</span><span>]</span> + <span>'<span>\n</span>'</span>
                theOutput +<span>=</span> <span>'By '</span> + line<span>[</span><span>'reviewerName'</span><span>]</span> + <span>'<span>\n</span>'</span>
                theOutput +<span>=</span> line<span>[</span><span>'reviewText'</span><span>]</span> + <span>'<span>\n</span><span>\n</span>'</span> 
                outty.<span>write</span><span>(</span>theOutput<span>)</span>
            <span>except</span>:
                <span>continue</span></pre></td></tr></table></div>

<p>Okay, so when we run this program, we’ll generate a new file, and in that file we’ll have a list of Amazon reviews, each separated out by who has reviewed it, and what they think about out it. It makes for a pretty interesting file, if we take a look at the first few lines. This time, we can use the ‘head’ command to see the very first lines of a file:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash">$ <span>head</span> <span>-n</span> <span>50</span> onestarReviews.txt
Go wireless
By Pen Name
Good sound. Too many wires. Gets a lil confusing to <span>set</span> up and they get <span>in</span> the way. Spend the extra $ and get a wireless <span>set</span>
 
Ghost is junk,waste of my money n time...
By josh
Had some <span>nice</span> cool stuff u can <span>do</span> <span>in</span> the game like never b <span>4</span> but the game itself is junk<span>!!!!</span> So very disappointed with this game... I play my black ops <span>2</span> <span>more</span> than this game still<span>!</span> They could have <span>done</span> a way way better job on this game.. Black ops <span>2</span> is way way better than ghost<span>!</span>
...</pre></td></tr></table></div>

<p>Now that we’ve got a feel for our review structure, we’ll use Andrej Karparthy’s <a href="https://github.com/karpathy/char-rnn">char-rnn</a> to create automatically generated Amazon 1 star reviews.</p>
<p>So, to start with, I’ll assume you’ve already installed <a href="http://torch.ch/">Torch7</a>, along with the rest of char-rnn’s dependencies. If you haven’t, you can look at the Torch site, and follow the instructions there.</p>
<p>Now, let’s take a look at Andrej’s data set that he’s included with his original version, by again, doing a ‘head’ on his data. If we’ve cloned his repo, we should be able to go into his data directory, and then into ‘tinyshakespeare’.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash">$ <span>head</span> <span>-n</span> <span>100</span> input.txt
First Citizen:
Before we proceed any further, hear me speak.
 
All:
Speak, speak.
 
First Citizen:
You are all resolved rather to die than to famish?
 
All:
Resolved. resolved.
 
First Citizen:
First, you know Caius Marcius is chief enemy to the people.
 
All:
We know<span>'t, we know'</span>t.
 
First Citizen:
Let us <span>kill</span> him, and we<span>'ll have corn at our own price.
Is'</span>t a verdict?
 
All:
No <span>more</span> talking on<span>'t; let it be done: away, away!
 
Second Citizen:
One word, good citizens.</span></pre></td></tr></table></div>

<p/><center><strong>Exporting Your Data for an LSTM Neural Network</strong></center>
<p>Alright! So the data expected by char-rnn is actually very similar to what we’ve already made. So all that’s left is to create a new directory, and then to only take the first 700MB of our file, or whatever will fit into memory for us. </p>
<p>In my case, I used head again, this time to specify how big of a file to create:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash"><span>$ </span><span>head</span> <span>-c</span> 700M onestarReviews.txt <span>&gt;</span> input.txt</pre></td></tr></table></div>

<p>Great! So after a while, we should end up with a new input.txt file that’s 700megs. We can now set<br/>
this up to be trained using char-rnn:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash">$ th train.lua -data_dir data<span>/</span>amazononestar -rnn_size <span>700</span> -num_layers <span>3</span> <span>-dropout</span> <span>0.3</span>
using CUDA on GPU <span>0</span>...	
loading data files...	
cutting off end of data so that the batches<span>/</span>sequences divide evenly	
reshaping tensor...	
data load done. Number of data batches <span>in</span> train: <span>278920</span>, val: <span>14681</span>, test: <span>0</span>	
vocab size: <span>99</span>	
creating an lstm with <span>3</span> layers	
setting forget gate biases to <span>1</span> <span>in</span> LSTM layer <span>1</span>	
setting forget gate biases to <span>1</span> <span>in</span> LSTM layer <span>2</span>	
setting forget gate biases to <span>1</span> <span>in</span> LSTM layer <span>3</span>	
number of parameters <span>in</span> the model: <span>10163399</span>	
cloning rnn	
cloning criterion	
<span>1</span><span>/</span><span>13946000</span> <span>(</span>epoch <span>0.000</span><span>)</span>, train_loss = <span>4.59903159</span>, grad<span>/</span>param norm = 1.1494e+00, time<span>/</span>batch = 0.3800s</pre></td></tr></table></div>

<p>Now, I’ve got an NVIDIA GeForce GTX 980Ti, and I’ve got a lot of video memory. I can push a largeish network, and not run out of memory. You may need to tweak your ‘rnn_size’ and ‘num_layers’ parameters to something smaller in order to get it to work on your system. If you get lost, refer to the <a href="https://github.com/karpathy/char-rnn">Github repo</a>, it’s got excellent documentation.</p>
<p>Once we’ve got that running, it will start generating a neural network for us. This process can take a long time, and indeed, in my case, leaving it running for a day or two might be necessary. Luckily, the code above generates snapshots, and we can see how the training is going as it’s working…</p>
<p/><center><strong>Sampling from Your Network as You Train </strong></center>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash">$ th sample.lua cv<span>/</span>lm_lstm_epoch0.30_1.1600.t7 <span>-seed</span> <span>332</span> <span>-primetext</span> <span>'not good'</span> <span>-temperature</span> .9
using CUDA on GPU <span>0</span>...	
Make sure that your saved checkpoint was also trained with GPU. If it was trained with CPU use <span>-gpuid</span> <span>-1</span> <span>for</span> sampling <span>as</span> well	
creating an lstm...	
seeding with not good	
<span>--------------------------</span>	
not good. The the supplier was <span>"Done"</span> I will try to think I would be paying money and so <span>if</span> you say this is not misleading much like serious previews and I will crash it, it didn<span>'t staff correctly. What a disappointment!
 
Three times
By Keith answer
Nice facility and seems to be protected so I love problems. I ordered the other blue the two area - that'</span>s why I was <span>in</span> the first page of Women <span>'more of the investment. Awful, all open the trainplay. Thought there wasn'</span>t <span>as</span> a prime string and pretty much fine with a few hours later, on one of the products that two didn<span>'t help saw the bolt... Gonna make it well burned out.....for exchange.
 
If you read a total piece of junk.
By Anny Effanan
When I ordered the top of the disc return then the gun
 
Wont be able to find the beat country.
By Liferai Barri
In the first and 3 months we could not carry in the driver so there are nice energy, the top program seemed to be not used at all. Now, the ends in use, especially in this sim cord in the first little cheap price is way too much. I immediately downloaded the screen protector, and I believe it is in size samples and frewn between the unit and some of these cables warn us but is very lame. The chair also wasn'</span>t <span>in</span> the way this situation. I have <span>done</span> something <span>else</span> <span>for</span> their kids. It doesn<span>'t stand with it filled with DVD.I don'</span>t know what they are at all......<span>'Ofogismer?,,  it'</span>s dark dead.</pre></td></tr></table></div>

<p>Great! Let’s leave this running for a bit, come back to it later. For now, let’s build our web scraper, and get a feel for what all the 1* products might look like averaged out.</p>
<p/><center><strong>Creating Artificial Images Using a GAN</strong></center>
<p>(Sidenote here. The original dataset includes this image data. For the purposes of this tutorial though, we’ll pretend we didn’t have that great gift handed to us, so we can see how we’d do it if we were out on our own.)</p>
<p>Now, if we go back to our original dataset, it’s obvious that we don’t have all of the Amazon images for our products. Instead, what we’ve got is an ASIN, or an Amazon Store Identification Number. </p>
<p>Let’s write a new Python script, to go through each of our products, and to save out all ASINs of all 1 star reviews:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python"><span>def</span> generateReviews<span>(</span><span>)</span>:
    daFile <span>=</span> <span>open</span><span>(</span><span>'user_dedup.json'</span><span>,</span> <span>'r'</span><span>)</span>
    <span>for</span> line <span>in</span> daFile:
        <span>yield</span> <span>eval</span><span>(</span>line<span>)</span>
 
<span>with</span> <span>open</span><span>(</span><span>'onestarASINs.txt'</span><span>,</span> <span>'w'</span><span>)</span> <span>as</span> outty:
    <span>for</span> line <span>in</span> generateReviews<span>(</span><span>)</span>:
        <span>if</span> line<span>[</span><span>'overall'</span><span>]</span> <span>==</span> <span>1.0</span>:
            <span>try</span>:
                theOutput <span>=</span> line<span>[</span><span>'asin'</span><span>]</span> + <span>'<span>\n</span>'</span>
                outty.<span>write</span><span>(</span>theOutput<span>)</span>
            <span>except</span>:
                <span>continue</span></pre></td></tr></table></div>

<p>Again, this code is very straightforward. We’re just writing out an ASIN for each 1 star review. </p>
<p>But, thinking about this, surely almost every Amazon product gets at least a single 1 star review. How do we separate out the ones that really suck?</p>
<p/><center><strong>Gathering Products with More than 10 1 Star Reviews</strong></center><p>
In my case, I decided to keep it simple, and just separate out the products that have more than 10 1 star reviews. We can do this in a single line of bash if we close our eyes and think for a bit:

</p><div class="wp_syntax"><table><tr><td class="code"><pre class="bash"><span>$ </span><span>sort</span> onestarASINs.txt <span>|</span> <span>uniq</span> <span>-cd</span> <span>|</span> <span>sort</span> <span>-nr</span> <span>|</span> <span>awk</span> <span>'$1&gt;10'</span> <span>&gt;</span> greatherThanTen.txt</pre></td></tr></table></div>

<p>Alright, now do a head on this file output, and what do we see?</p>
<p>We’ve got a count of our 1* reviews on the left, and on the right, our matching ASIN. We can use this ASIN to scrape the Amazon website, and generate a database of all of our matching product images with more than 10 1 star reviews.</p>
<p/><center><strong>Inspecting Torch-Gan’s Example Dataset</strong></center><p>
Before we get started with scraping though, we should have an idea for what we want our end data to look like. In my case, I want to use the excellent </p><a href="https://github.com/skaae/torch-gan">torch-gan</a><p> to generate my fake products, based upon all the images. And I want to do the bare minimum amount of futzing in order to make my dataset work with their existing input. 
</p><p>So let’s take a look by downloading their dataset, and then seeing what sort of data they expect:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash">$ <span>git clone</span> <span>git</span><span>@</span>github.com:skaae<span>/</span>torch-gan.git
$ <span>cd</span> torch-gan
$ <span>cd</span> datasets
$ python create_datasets.py
$ <span>cd</span> lfw_imgs<span>/</span>lfw_deepfunneled<span>/</span>lfw_deepfunneled
$ <span>ls</span>
...
$ <span>cd</span> Josheph_Safra
$ <span>ls</span>
Joseph_Safra_0001.jpg
$ identify Joseph_Safra_0001.jpg 
Joseph_Safra_0001.jpg JPEG 250x250 250x250+<span>0</span>+<span>0</span> <span>8</span>-bit sRGB 9.24KB 0.000u <span>0</span>:<span>00.000</span></pre></td></tr></table></div>

<p>Okay. So it looks like the torch-gan repository is using the Labeled Faces in the Wild dataset, and that’s being unzipped and then converted in that directory. Each of our images has a specific name, for whatever celebrity they are, and then each image is 250×250 pixels.</p>
<p>So, when we download our product images, we’ll need to save them into a directory with their product names, and we’ll then need to resize every image to fit 250×250, and we’ll have to follow the same naming technique, so we can just substitute our directory for the one that already exists.</p>
<p/><center><strong>Scraping Amazon for Our Images</strong></center><p>
Now is a good time, before we start scraping, to ask ourselves if there’s anything else we’d like to get out of these scrapes. In general, if we’ve got the space, it makes the most sense to just copy as much as possible. So, if we’re downloading every ASIN, we might as well save the entire page for later, so we can, for example, extract a product description from the page later, if we decide we want a neural network to generate that too.
</p><p>First, before we start our scrape, let’s try just downloading one of our ASIN products. Let’s take the lowest reviewed product, and go from there:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash">$ <span>wget</span> http:<span>//</span>www.amazon.com<span>/</span>gp<span>/</span>product<span>/</span>B00EOE0WKQ
$ <span>less</span> B00EOE0WKQ</pre></td></tr></table></div>

<p>Wow! Did not expect that! Amazon’s HTML is a mess! But hopefully they’re still using the same layout for each of their products, so let’s see if we can find an image in all of that. In our case, we’ll open up a web browser, right click, and inspect the element where we’d want to grab our images:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="html">&lt;img alt="Amazon Fire Phone, 32GB (AT&amp;amp;T)" src="http://ecx.images-amazon.com/images/I/61PO4UcPdIL._SY679_.jpg"
data-old-hires="http://ecx.images-amazon.com/images/I/61PO4UcPdIL._SL1000_.jpg" class="a-dynamic-image  a-stretch-vertical" id="landingImage" 
data-a-dynamic-image="{&amp;quot;http://ecx.images-amazon.com/images/I/61PO4UcPdIL._SY679_.jpg&amp;quot;:[325,679],&amp;quot;http://ecx.images-amazon.com/images/I/61PO4UcPdIL._SY450_.jpg&amp;quot;:[216,450],&amp;quot;http://ecx.images-amazon.com/images/I/61PO4UcPdIL._SY550_.jpg&amp;quot;:[263,550],&amp;quot;http://ecx.images-amazon.com/images/I/61PO4UcPdIL._SY355_.jpg&amp;quot;:[170,355],&amp;quot;http://ecx.images-amazon.com/images/I/61PO4UcPdIL._SY606_.jpg&amp;quot;:[290,606]}"
 style="max-height: 627px; max-width: 325px;"&gt;</pre></td></tr></table></div>

<p>Okay. We’ve got at least one image, when we select our main image, that seems like it might be consistent across our pages. So let’s just go with that.</p>
<p>Now, another thing that would be great to grab would be the description of each of these products. Let’s see if we can grab that too…</p>
<p>In looking at it on my screen (again, by right-clicking, inspecting element, I can see that Amazon has a center-*-*_feature_div for each of the featured info graphics. This looks like it might be a mess to break apart. So let’s just skip that for now, but we’ll grab the dataset regardless.</p>
<p>In my case, I’m going to just download the full HTML page of everything for now. Let’s do a bit of math to figure out how long that might take, based upon some back of the envelope.</p>
<p/><center><strong>Do We have A Large Enough Dataset?</strong></center><p>
If we do a line count on our existing 1 star products file, we can see exactly how many pages we need to scrape:

</p><div class="wp_syntax"><table><tr><td class="code"><pre class="bash">$ <span>wc</span> <span>-l</span> greatherThanTen.txt 
<span>93660</span> greatherThanTen.txt</pre></td></tr></table></div>

<p>Okay, so we’re looking at around 94,000 pages. If we assume that we wait 1 second in between grabbing pages, how long will this end up taking us?</p>
<p>A quick web search for ‘94000 seconds to hours’ lets us know, we’re looking at around 26.111 hours. So, we can add that 1 second pause to a Python script, and we should have all of our reviews within a little over a day. So let’s write that script now, so we can get started.</p>
<p/><center><strong>Checking Our Code in iPython Before We Scrape</strong></center><p>
In this case, we’ve got to check what we’re doing before we set and run the program for a day or so, so let’s be really sure about what we’re doing. In cases like this, it helps to open up an iPython shell, and make sure you’re not missing anything, and can deal with a few edge cases:

</p><div class="wp_syntax"><table><tr><td class="code"><pre class="bash">$ ipython
In <span>[</span><span>1</span><span>]</span>: import subprocess
In <span>[</span><span>2</span><span>]</span>: a = <span>"  40854 B00EOE0WKQ"</span>
In <span>[</span><span>3</span><span>]</span>: a.split<span>(</span><span>' '</span><span>)</span>
Out<span>[</span><span>3</span><span>]</span>: <span>[</span><span>''</span>, <span>''</span>, <span>'40854'</span>, <span>'B00EOE0WKQ'</span><span>]</span>
In <span>[</span><span>4</span><span>]</span>: theURL = <span>'http://www.amazon.com/gp/product/'</span> + a.split<span>(</span><span>' '</span><span>)</span><span>[</span><span>3</span><span>]</span>
In <span>[</span><span>5</span><span>]</span>: theURL
Out<span>[</span><span>5</span><span>]</span>: <span>'http://www.amazon.com/gp/product/B00EOE0WKQ'</span>
subprocess.call<span>(</span><span>[</span><span>'wget'</span>, theURL<span>]</span><span>)</span>
<span>--2015-12-31</span> <span>22</span>:09:00--  http:<span>//</span>www.amazon.com<span>/</span>gp<span>/</span>product<span>/</span>B00EOE0WKQ
Resolving www.amazon.com <span>(</span>www.amazon.com<span>)</span>... 54.239.25.192
Connecting to www.amazon.com <span>(</span>www.amazon.com<span>)</span><span>|</span>54.239.25.192<span>|</span>:<span>80</span>... connected.
HTTP request sent, awaiting response... <span>301</span> MovedPermanently
Location: http:<span>//</span>www.amazon.com<span>/</span>Fire_Phone_13MP-Camera_32GB<span>/</span>dp<span>/</span>B00EOE0WKQ <span>[</span>following<span>]</span>
<span>--2015-12-31</span> <span>22</span>:09:00--  http:<span>//</span>www.amazon.com<span>/</span>Fire_Phone_13MP-Camera_32GB<span>/</span>dp<span>/</span>B00EOE0WKQ
Reusing existing connection to www.amazon.com:<span>80</span>.
HTTP request sent, awaiting response... <span>200</span> OK
Length: unspecified <span>[</span>text<span>/</span>html<span>]</span>
Saving to: ‘B00EOE0WKQ’
 
B00EOE0WKQ                         <span>[</span>   <span>&lt;</span>=<span>&gt;</span>                                                      <span>]</span> 454.04K   651KB<span>/</span>s   <span>in</span> 0.7s   
 
<span>2015</span>-<span>12</span>-<span>31</span> <span>22</span>:09:01 <span>(</span><span>651</span> KB<span>/</span>s<span>)</span> - ‘B00EOE0WKQ’ saved <span>[</span><span>464933</span><span>]</span>
In <span>[</span><span>6</span><span>]</span>: <span>exit</span><span>(</span><span>)</span></pre></td></tr></table></div>

<p>Okay, so there’s just one thing we’ll need to watch out for, and that’s wrapping our URL in a ‘try’ statement, just in case there’s something wonky in our lines. So let’s write that script now, and get it started.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python"><span>import</span> <span>time</span>
<span>import</span> <span>subprocess</span>
 
<span>with</span> <span>open</span><span>(</span><span>'greaterThanTen.txt'</span><span>,</span> <span>'r'</span><span>)</span> <span>as</span> daFile:
    <span>for</span> number<span>,</span> line <span>in</span> <span>enumerate</span><span>(</span>daFile<span>)</span>:
        <span>try</span>:
            theURL <span>=</span> <span>'http://www.amazon.com/gp/product/'</span> + line.<span>split</span><span>(</span><span>' '</span><span>)</span><span>[</span><span>3</span><span>]</span>
            <span>print</span><span>(</span><span>"Grabbing number "</span> + <span>str</span><span>(</span>number<span>)</span> + <span>", ASIN: "</span> + line.<span>split</span><span>(</span><span>' '</span><span>)</span><span>[</span><span>3</span><span>]</span><span>)</span>
        <span>except</span>:
            <span>continue</span>
        <span>subprocess</span>.<span>call</span><span>(</span><span>[</span><span>'wget'</span><span>,</span> theURL<span>]</span><span>)</span>
        <span>time</span>.<span>sleep</span><span>(</span><span>1</span><span>)</span></pre></td></tr></table></div>

<p>Now, let’s run it and see if all looks okay:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash">$ python downloadURLs.py 
Grabbing number <span>0</span>, ASIN: B00EOE0WKQ
 
<span>--2015-12-31</span> <span>22</span>:<span>34</span>:<span>10</span>--  http:<span>//</span>www.amazon.com<span>/</span>gp<span>/</span>product<span>/</span>B00EOE0WKQ<span>%</span>0A
Resolving www.amazon.com <span>(</span>www.amazon.com<span>)</span>... 54.239.25.208
Connecting to www.amazon.com <span>(</span>www.amazon.com<span>)</span><span>|</span>54.239.25.208<span>|</span>:<span>80</span>... connected.
HTTP request sent, awaiting response... <span>301</span> MovedPermanently
Location: http:<span>//</span>www.amazon.com<span>/</span>Fire_Phone_13MP-Camera_32GB<span>/</span>dp<span>/</span>B00EOE0WKQ <span>[</span>following<span>]</span>
<span>--2015-12-31</span> <span>22</span>:<span>34</span>:<span>10</span>--  http:<span>//</span>www.amazon.com<span>/</span>Fire_Phone_13MP-Camera_32GB<span>/</span>dp<span>/</span>B00EOE0WKQ
Reusing existing connection to www.amazon.com:<span>80</span>.
HTTP request sent, awaiting response... <span>200</span> OK
Length: unspecified <span>[</span>text<span>/</span>html<span>]</span>
Saving to: ‘B00EOE0WKQ<span>%</span>0A’
 
B00EOE0WKQ<span>%</span>0A                        <span>[</span>     <span>&lt;</span>=<span>&gt;</span>                                                    <span>]</span> 454.00K   116KB<span>/</span>s   <span>in</span> 3.9s   
 
<span>2015</span>-<span>12</span>-<span>31</span> <span>22</span>:<span>34</span>:<span>14</span> <span>(</span><span>116</span> KB<span>/</span>s<span>)</span> - ‘B00EOE0WKQ<span>%</span>0A’ saved <span>[</span><span>464894</span><span>]</span>
 
Grabbing number <span>1</span>, ASIN: <span>5775</span>
<span>--2015-12-31</span> <span>22</span>:<span>34</span>:<span>15</span>--  http:<span>//</span>www.amazon.com<span>/</span>gp<span>/</span>product<span>/</span><span>5775</span>
Resolving www.amazon.com <span>(</span>www.amazon.com<span>)</span>... 54.239.17.6
Connecting to www.amazon.com <span>(</span>www.amazon.com<span>)</span><span>|</span>54.239.17.6<span>|</span>:<span>80</span>... connected.
HTTP request sent, awaiting response... <span>404</span> NotFound
<span>2015</span>-<span>12</span>-<span>31</span> <span>22</span>:<span>34</span>:<span>15</span> ERROR <span>404</span>: NotFound.
 
Grabbing number <span>2</span>, ASIN: <span>3166</span>
<span>--2015-12-31</span> <span>22</span>:<span>34</span>:<span>16</span>--  http:<span>//</span>www.amazon.com<span>/</span>gp<span>/</span>product<span>/</span><span>3166</span>
Resolving www.amazon.com <span>(</span>www.amazon.com<span>)</span>... 54.239.25.200
Connecting to www.amazon.com <span>(</span>www.amazon.com<span>)</span><span>|</span>54.239.25.200<span>|</span>:<span>80</span>... connected.
HTTP request sent, awaiting response... <span>503</span> Service Unavailable
<span>2015</span>-<span>12</span>-<span>31</span> <span>22</span>:<span>34</span>:<span>16</span> ERROR <span>503</span>: Service Unavailable.
...</pre></td></tr></table></div>

<p>Oh no! It looks like Amazon really doesn’t like you scraping! For me, I only got as far as three pages before all of my requests started getting 503, service unavailable. </p>
<p/><center><strong>Getting Amazon Data the Right Way</strong></center><p>
Indeed, looking at Amazon’s site, it looks like you’ve got to be signed up as an Affiliate, and have an AWS account too, with a private key. Oh no!
</p><p>But fret not, I’ve got an Associates account, and I’ve got an AWS account too. I’m going to use the great <a href="https://github.com/yoavaviram/python-amazon-simple-product-api">Amazon Simple Product API</a> by yoavaviram, and hopefully we’ll be able to get only what we need from this API. </p>
<p>So, after I’ve installed the above library, I wrote a script to start downloading all of my product images, and to create files in the same pattern as before, with  our Labeled Faces dataset. So:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python"><span>from</span> amazon.<span>api</span> <span>import</span> AmazonAPI
<span>import</span> <span>shutil</span>
<span>import</span> requests
 
<span>import</span> <span>time</span>
<span>import</span> <span>subprocess</span>
<span>import</span> slugify
 
amazon <span>=</span> AmazonAPI<span>(</span><span>'REPLACE-WITH-AWSID'</span><span>,</span> <span>'REPLACE-WITH-AWSSECRET'</span><span>,</span> <span>'REPLACE-WITH-ASSOCIATE-ID'</span><span>)</span>
 
 
<span>with</span> <span>open</span><span>(</span><span>'greaterThanTen.txt'</span><span>,</span> <span>'r'</span><span>)</span> <span>as</span> daFile:
    <span>for</span> number<span>,</span> line <span>in</span> <span>enumerate</span><span>(</span>daFile<span>)</span>:
        <span>time</span>.<span>sleep</span><span>(</span><span>.5</span><span>)</span>
 
        <span>try</span>:
            theNum <span>=</span> line.<span>strip</span><span>(</span><span>)</span>.<span>split</span><span>(</span><span>' '</span><span>)</span><span>[</span><span>1</span><span>]</span>
            <span>print</span><span>(</span><span>"In loop"</span> + theNum<span>)</span>
 
            product <span>=</span> amazon.<span>lookup</span><span>(</span>ItemId<span>=</span>theNum<span>)</span>
            <span>print</span><span>(</span><span>"Grabbing number "</span> + <span>str</span><span>(</span>number<span>)</span> + <span>", Product: "</span> + product.<span>title</span><span>)</span>
            with_underscores <span>=</span> slugify.<span>slugify</span><span>(</span>product.<span>title</span><span>)</span>
 
            <span>subprocess</span>.<span>call</span><span>(</span><span>[</span><span>'mkdir'</span><span>,</span> with_underscores<span>]</span><span>)</span>
            response <span>=</span> requests.<span>get</span><span>(</span>product.<span>large_image_url</span><span>,</span> stream<span>=</span><span>True</span><span>)</span>
            <span>with</span> <span>open</span><span>(</span>with_underscores + <span>'/'</span> + with_underscores + <span>'_0001.jpg'</span><span>,</span> <span>'wb'</span><span>)</span> <span>as</span> out_file:
                <span>shutil</span>.<span>copyfileobj</span><span>(</span>response.<span>raw</span><span>,</span> out_file<span>)</span>
 
        <span>except</span>:
            <span>continue</span></pre></td></tr></table></div>

<p>Great! Now, before we run this, let’s do a quick sanity check, and see how many images we had with that Labeled Faces dataset:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash">$ <span>cd</span> lfw-deepfunneled
$ <span>find</span> . <span>-type</span> f <span>|</span> <span>wc</span> <span>-l</span>
<span>13233</span></pre></td></tr></table></div>

<p>Okay. So we’re looking at around 13,250 images, in order to get a half decent result. That should be doable, considering we’ve got over 93,000 urls to choose from. Even if a lot of these urls no longer exist, we should be able to get at least 14k images for our dataset. Of course, while we’ve got our script running, we can do the same command as above to get an image count, and we can stop our scraper from running once we’ve gotten the 14,000 lowest reviewed products.</p>
<p>Now, run our script, and let’s save out a couple thousand products. In my case, I stopped after around 18,000 products.</p>
<p/><center><strong>Resizing and Cleaning Image Data</strong></center><p>
Next, we’ve got to resize and format our images to be the right size. We could have done this before, but that would mean we’d need to rescrape our data if we decided later we needed a slightly bigger image. So, let’s write a quickly script to recursively go through all of these directories and write out our new images, at the new, right size, 250×250:

</p><div class="wp_syntax"><table><tr><td class="code"><pre class="python"><span>import</span> <span>glob</span>
<span>import</span> <span>subprocess</span>
 
<span>from</span> PIL <span>import</span> Image<span>,</span> ImageOps
 
size <span>=</span> <span>(</span><span>250</span><span>,</span> <span>250</span><span>)</span>
 
<span>for</span> filename <span>in</span> <span>glob</span>.<span>glob</span><span>(</span><span>'*/*.jpg'</span><span>)</span>:
    <span>try</span>:
        image <span>=</span> Image.<span>open</span><span>(</span>filename<span>)</span>.<span>convert</span><span>(</span><span>'RGB'</span><span>)</span>
    <span>except</span>:
        <span>continue</span>
    thumb <span>=</span> ImageOps.<span>fit</span><span>(</span>image<span>,</span> size<span>,</span> Image.<span>ANTIALIAS</span><span>)</span>
    <span>subprocess</span>.<span>call</span><span>(</span><span>[</span><span>'mkdir'</span><span>,</span> <span>'smaller/'</span> + filename.<span>split</span><span>(</span><span>'/'</span><span>)</span><span>[</span><span>0</span><span>]</span><span>]</span><span>)</span>
    thumb.<span>save</span><span>(</span><span>'smaller/'</span> + filename<span>)</span></pre></td></tr></table></div>

<p>Now, first make sure we create a directory called ‘smaller’, and then run the above script. After it runs for a while, we should end up with our 18,000 images, all in JPG, and all ready to be loaded into our neural network for training. Yes!</p>
<p/><center><strong>Adapting the GAN code to Our Dataset</strong></center><p>
Let’s get back to the generative adverserial network, and let’s think through how we’re going to get this data all loaded up and ready for it, as that hdf5 file we saw before.
</p><p>We can get this process started by opening the data directory, and reading through the code, to see exactly how everything is supposed to be loaded. In my case, I noticed that the lfw.py file tries to download the image set, and then run through it, resizing everything to 64×64 pixels. So whoops, we really should have resized to that originally, but let’s fix the install function, and copy over all of our generated thumbnail images to that directory so it can run. Inside of lfw.py:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python">   <span>def</span> _install<span>(</span><span>self</span><span>)</span>:
        log.<span>info</span><span>(</span><span>'Converting images to NumPy arrays'</span><span>)</span>
        name_dict <span>=</span> <span>{</span><span>}</span>
        imgs <span>=</span> <span>[</span><span>]</span>
        img_idx <span>=</span> <span>0</span>
        <span>for</span> root<span>,</span> dirs<span>,</span> files <span>in</span> <span>os</span>.<span>walk</span><span>(</span><span>self</span>.<span>data_dir</span><span>)</span>:
            <span>for</span> filename <span>in</span> files:
                _<span>,</span> ext <span>=</span> <span>os</span>.<span>path</span>.<span>splitext</span><span>(</span>filename<span>)</span>
                <span>if</span> ext.<span>lower</span><span>(</span><span>)</span> <span>!=</span> <span>'.jpg'</span>:
                    <span>continue</span>
                filepath <span>=</span> <span>os</span>.<span>path</span>.<span>join</span><span>(</span>root<span>,</span> filename<span>)</span>
                imgs.<span>append</span><span>(</span>np.<span>array</span><span>(</span>Image.<span>open</span><span>(</span>filepath<span>)</span><span>)</span><span>)</span>
                _<span>,</span> name <span>=</span> <span>os</span>.<span>path</span>.<span>split</span><span>(</span>root<span>)</span>
                <span>if</span> name <span>not</span> <span>in</span> name_dict:
                    name_dict<span>[</span>name<span>]</span> <span>=</span> <span>[</span><span>]</span>
                    name_dict<span>[</span>name<span>]</span>.<span>append</span><span>(</span>img_idx<span>)</span>
                    img_idx +<span>=</span> <span>1</span>
                <span>if</span> img_idx % <span>100</span> <span>==</span> <span>0</span>:
                    <span>print</span> img_idx
        imgs <span>=</span> np.<span>array</span><span>(</span>imgs<span>)</span>
        names <span>=</span> <span>sorted</span><span>(</span>name_dict.<span>keys</span><span>(</span><span>)</span><span>)</span>
        names_idx <span>=</span> np.<span>empty</span><span>(</span><span>len</span><span>(</span>imgs<span>)</span><span>)</span>
        <span>for</span> name_idx<span>,</span> name <span>in</span> <span>enumerate</span><span>(</span>names<span>)</span>:
            <span>for</span> img_idx <span>in</span> name_dict<span>[</span>name<span>]</span>:
                names_idx<span>[</span>img_idx<span>]</span> <span>=</span> name_idx
        <span>with</span> <span>open</span><span>(</span><span>self</span>._npz_path<span>,</span> <span>'wb'</span><span>)</span> <span>as</span> f:
            np.<span>savez</span><span>(</span>f<span>,</span> imgs<span>=</span>imgs<span>,</span> names_idx<span>=</span>names_idx<span>,</span> names<span>=</span>names<span>)</span></pre></td></tr></table></div>

<p>Great! Now run this by running create_datasets.py, and at the end of all of it, we’ll have our brand new lfw.hdf5 afterwards. We can then start training on all the images we loaded before.</p>
<p>Finally, I’ve got my file, and now we can look into the gan Torch code, and get our network up and training:</p>



<p>As this gets trained, it might take a few days, just as it took a few days to train our previous neural network to generate one star Amazon reviews. So, in the meantime, let’s take a look at what our code is doing, by reading the <a href="http://torch.ch/blog/2015/11/13/gan.html">great writeup</a> by Anders Boesen Lindbo Larsen and Søren Kaae Sønderby at the Torch blog.</p>
<p>If we read through the docs about their Generative Adverserial Network, we can see that we’re actually training two neural networks here. The first is a generator, and the second is a discriminator.</p>
<p>As this runs, it ends up generating a 10×10 layout of 64×64 images. We can see all of them getting generated, and watch as the two networks learn from one another.</p>
<p>While we train, let’s use our existing one star images directories to create a 1 star product name generator.</p>
<p/><center><strong>Crosslinking Our Names to ASINs</strong></center><p>
Before, we saved out all of our images into unique directories, but we replaced their names with dashes. Let’s dump all the directory names we created before, and then write a quick script to replace all the dashes and slashes with proper spaces:

</p><div class="wp_syntax"><table><tr><td class="code"><pre class="bash"><span>$ </span><span>ls</span> <span>-d</span> <span>*/</span> <span>|</span> <span>sed</span> <span>-e</span> <span>'s/-/ /g'</span> <span>-e</span> <span>'s/\///g'</span> <span>&gt;</span> names.txt</pre></td></tr></table></div>

<p>Now, this one liner will do the following:</p>
<p>‘ls -d */’ will show us a list of all the directories in our current directory. ‘sed -e ‘s/-/ /g’ will replace each dash with a space, and then ‘-e ‘s/\///g’ will delete all of our end slashes. Finally, we’ll write this stream out to a text file called ‘names.txt’.</p>
<p>Sometimes, it can be easier to write a one liner in bash script than it can be to write code. But there is a tradeoff, in that we don’t really have a trail of this code, and we don’t really have a way to modify or improve it later. But for now, let’s just use it.</p>
<p/><center><strong>Generating Poorly Rated Product Names</strong></center><p>
Armed with our list of the lowest rated product names, we can now generate another LSTM network to start making our fake product names. Let’s create a new directory in char-rnn/data, call it AmazonNames, and then drop in our directory names as input.txt.

</p><div class="wp_syntax"><table><tr><td class="code"><pre class="bash"><span>$ </span>th train.lua -data_dir data<span>/</span>amazonNames<span>/</span> -rnn_size <span>700</span> -num_layers <span>3</span> <span>-dropout</span> <span>0.5</span></pre></td></tr></table></div>

<p>Running this list through the sample.lua again, and we see we’ve got some very interesting 1* Amazon names for our products.</p>
<p>The only thing left to do now is add in a fake price for our fake products. Let’s join the metadata from the dataset along with our list of 1* review products in order to create the last product creator:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python">allASINs <span>=</span> <span>[</span><span>]</span>
<span>with</span> <span>open</span><span>(</span><span>'greaterThanTen.txt'</span><span>,</span> <span>'r'</span><span>)</span> <span>as</span> theASINs:
    <span>for</span> line <span>in</span> theASINs:
        allASINs.<span>append</span><span>(</span>line.<span>strip</span><span>(</span><span>)</span>.<span>split</span><span>(</span><span>' '</span><span>)</span><span>[</span><span>1</span><span>]</span><span>)</span> <span># create a list of all our clean ASINs</span>
 
 
<span>with</span> <span>open</span><span>(</span><span>'metadata.json'</span><span>,</span> <span>'r'</span><span>)</span> <span>as</span> theMeta:  <span># open up the metadata dataset</span>
    <span>with</span> <span>open</span><span>(</span><span>'prices.txt'</span><span>,</span> <span>'w'</span><span>)</span> <span>as</span> thePrices: <span># and open a file to save our a list of our prices</span>
        <span>for</span> line <span>in</span> theMeta:  <span># two for loops in a row, this is slow, but at this point, whatevs.</span>
            <span>for</span> ASIN <span>in</span> allASINs:
                <span>if</span> ASIN <span>in</span> line:  <span># if we have a matching ASIN in our line</span>
                    <span>try</span>:
                        metadata <span>=</span> <span>eval</span><span>(</span>line<span>)</span>
                        thePrices.<span>write</span><span>(</span><span>'$'</span> + <span>str</span><span>(</span>metadata<span>[</span><span>'price'</span><span>]</span><span>)</span> + <span>'<span>\n</span>'</span><span>)</span>
                    <span>except</span>:
                        <span>continue</span></pre></td></tr></table></div>

<p><strong>But don’t run this code!</strong> It’s naive, and it’s a great first thought, but you could be waiting days for it to finish. Can you see why?</p>
<p>We’ve got the double for loop, and we’ll be running it over and over again, in exponential time. The question is, how can we get the above code working better?</p>
<p>Now, we can get rid of that second loop entirely, because Python will already look through our list of ASINs. So let’s take that loop out, and then let’s keep thinking of how we can make this loop faster.</p>
<p>Once we’ve added an ASIN’s price, do we need it anymore? The answer is no. So let’s get rid of each ASIN as we go:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python">allASINs <span>=</span> <span>[</span><span>]</span>
<span>with</span> <span>open</span><span>(</span><span>'greaterThanTen.txt'</span><span>,</span> <span>'r'</span><span>)</span> <span>as</span> theASINs:
    <span>for</span> line <span>in</span> theASINs:
        allASINs.<span>append</span><span>(</span>line.<span>strip</span><span>(</span><span>)</span>.<span>split</span><span>(</span><span>' '</span><span>)</span><span>[</span><span>1</span><span>]</span><span>)</span> <span># create a list of all our clean ASINs</span>
 
<span>with</span> <span>open</span><span>(</span><span>'metadata.json'</span><span>,</span> <span>'r'</span><span>)</span> <span>as</span> theMeta:
    <span>with</span> <span>open</span><span>(</span><span>'prices.txt'</span><span>,</span> <span>'w'</span><span>)</span> <span>as</span> thePrices:
        <span>for</span> line <span>in</span> theMeta:
            metadata <span>=</span> <span>eval</span><span>(</span>line<span>)</span>
            <span>if</span> metadata<span>[</span><span>'asin'</span><span>]</span> <span>in</span> allASINs:
                <span>print</span><span>(</span><span>"Adding another asin price"</span><span>)</span>
                <span>try</span>:
                    place <span>=</span> allASINs.<span>index</span><span>(</span>metadata<span>[</span><span>'asin'</span><span>]</span><span>)</span>
                    <span>del</span> allASINs<span>[</span>place<span>]</span> <span># make the list smaller as we go on</span>
                    thePrices.<span>write</span><span>(</span><span>'$'</span> + <span>str</span><span>(</span>metadata<span>[</span><span>'price'</span><span>]</span><span>)</span> + <span>'<span>\n</span>'</span><span>)</span>
                <span>except</span>:
                    <span>continue</span></pre></td></tr></table></div>

<p>Great! Now this should be much faster, because as we get towards the end of our list, we’ll have less and less strings to look for a match on. And indeed, we’re much faster than our initial guess, but it still might take an hour or so to finish.</p>
<p/><center><strong>Upscaling Our Generated Images</strong></center>
<p>When that’s done though, we’ve got our final little bit to train our neural network on. Once we’ve trained a char-rnn on our prices, we’ve got everything we need to generate our fake Amazon products. Reviews and all. So let’s now write the code to generate all of our entire end product, starting from the bottom, our product images.</p>
<p>While we were training, we generated a neural network that generates a 10×10 grid of 64×64 fake images. Let’s use Python and OpenCV to rescale and export these generated images to jpgs, so we can place them in our own container:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python"><span>import</span> cv2
<span>import</span> <span>glob</span>
 
<span>for</span> filename <span>in</span> <span>glob</span>.<span>glob</span><span>(</span><span>'lfw_example_v1_1*.png'</span><span>)</span>:
    a <span>=</span> cv2.<span>imread</span><span>(</span>filename<span>)</span>
    <span>for</span> i <span>in</span> <span>range</span><span>(</span><span>0</span><span>,</span><span>10</span><span>)</span>:
        <span>for</span> j <span>in</span> <span>range</span><span>(</span><span>0</span><span>,</span><span>10</span><span>)</span>:
            b <span>=</span> a<span>[</span>i*<span>64</span>:<span>(</span>i+<span>1</span><span>)</span>*<span>64</span><span>,</span> j*<span>64</span>:<span>(</span>j+<span>1</span><span>)</span>*<span>64</span><span>]</span>
            res <span>=</span> cv2.<span>resize</span><span>(</span>b<span>,</span> <span>(</span><span>256</span><span>,</span> <span>256</span><span>)</span><span>)</span>
            cv2.<span>imwrite</span><span>(</span><span>'spirits'</span>/ + <span>str</span><span>(</span>i<span>)</span> + <span>'_'</span> + <span>str</span><span>(</span>j<span>)</span> + <span>'.jpg'</span><span>,</span> res<span>)</span></pre></td></tr></table></div>

<p/><center><strong>Exporting Products as a JSON File</strong></center>
<p>Alright, so now we’ve got an entire directory filled with images, and they’re all of a more reasonable size. We’re basically done, the only thing we’ve got left to do is maybe fill up a range of files with that, and then add in our text generation, and we’ll have something we can look at proudly.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python"><span>import</span> <span>random</span>
<span>import</span> <span>subprocess</span>
<span>import</span> <span>sys</span>
 
<span>import</span> json
 
<span>import</span> <span>time</span>
 
allDivinations <span>=</span> <span>[</span><span>]</span>
 
i <span>=</span> <span>0</span>
<span>while</span> i <span>&lt;</span> <span>int</span><span>(</span><span>sys</span>.<span>argv</span><span>[</span><span>1</span><span>]</span><span>)</span>:
    p <span>=</span> <span>subprocess</span>.<span>Popen</span><span>(</span><span>[</span><span>'th sample.lua productNames/lm_lstm_epoch50.00_1.3150.t7 -seed '</span> + <span>str</span><span>(</span><span>random</span>.<span>randint</span><span>(</span><span>100</span><span>,</span><span>1000</span><span>)</span><span>)</span> + <span>' &gt; names_tmp.txt'</span><span>]</span><span>,</span> shell<span>=</span><span>True</span><span>)</span>
    status <span>=</span> p.<span>wait</span><span>(</span><span>)</span>
    <span>print</span><span>(</span>status<span>)</span>
 
    p <span>=</span> <span>subprocess</span>.<span>Popen</span><span>(</span><span>[</span><span>'th sample.lua prices/lm_lstm_epoch50.00_1.2193.t7 -seed '</span> + <span>str</span><span>(</span><span>random</span>.<span>randint</span><span>(</span><span>100</span><span>,</span><span>1000</span><span>)</span><span>)</span> + <span>' &gt; prices_tmp.txt'</span><span>]</span><span>,</span> shell<span>=</span><span>True</span><span>)</span>
    status <span>=</span> p.<span>wait</span><span>(</span><span>)</span>
    <span>print</span><span>(</span>status<span>)</span>
 
    <span>subprocess</span>.<span>Popen</span><span>(</span><span>[</span><span>'th sample.lua reviews/lm_lstm_epoch2.28_1.1002.t7 -seed '</span> + <span>str</span><span>(</span><span>random</span>.<span>randint</span><span>(</span><span>1</span><span>,</span><span>1000</span><span>)</span><span>)</span> +  <span>' &gt; reviews_tmp.txt'</span><span>]</span><span>,</span> shell<span>=</span><span>True</span><span>)</span>
    status <span>=</span> p.<span>wait</span><span>(</span><span>)</span>
    <span>print</span><span>(</span>status<span>)</span>
    <span>time</span>.<span>sleep</span><span>(</span><span>10</span><span>)</span>
    chosenImage <span>=</span> <span>(</span><span>random</span>.<span>randint</span><span>(</span><span>0</span><span>,</span><span>41</span><span>)</span><span>,</span> <span>random</span>.<span>randint</span><span>(</span><span>0</span><span>,</span><span>9</span><span>)</span><span>,</span> <span>random</span>.<span>randint</span><span>(</span><span>0</span><span>,</span><span>9</span><span>)</span><span>)</span>
 
    chosenNames <span>=</span> <span>[</span><span>]</span>
    chosenPrices <span>=</span> <span>[</span><span>]</span>
    chosenReviews <span>=</span> <span>[</span><span>]</span>
 
 
 
 
    <span>with</span> <span>open</span><span>(</span><span>'names_tmp.txt'</span><span>,</span> <span>'r'</span><span>)</span> <span>as</span> names:
        <span>for</span> count<span>,</span> line <span>in</span> <span>enumerate</span><span>(</span>names<span>)</span>:
            chosenNames.<span>append</span><span>(</span>line<span>)</span>
 
    <span>with</span> <span>open</span><span>(</span><span>'prices_tmp.txt'</span><span>,</span> <span>'r'</span><span>)</span> <span>as</span> prices:
        <span>for</span> count<span>,</span> line <span>in</span> <span>enumerate</span><span>(</span>prices<span>)</span>:
            <span>if</span> count <span>&gt;</span> <span>5</span>:
                chosenPrices.<span>append</span><span>(</span>line<span>)</span>
 
    <span>with</span> <span>open</span><span>(</span><span>'reviews_tmp.txt'</span><span>,</span> <span>'r'</span><span>)</span> <span>as</span> reviews:
        lastLine <span>=</span> <span>'bb'</span>
        startedReview <span>=</span> <span>False</span>
        currentReview <span>=</span> <span>''</span>
        <span>for</span> line <span>in</span> reviews:
            <span>if</span> line <span>==</span> <span>'<span>\n</span>'</span> <span>and</span> startedReview:
                currentReview +<span>=</span> line
                chosenReviews.<span>append</span><span>(</span>currentReview<span>)</span>
                currentReview <span>=</span> <span>''</span>
                startedReview <span>=</span> <span>False</span>
            <span>if</span> lastLine <span>==</span> <span>'<span>\n</span>'</span>:
                startedReview <span>=</span> <span>True</span>
                currentReview +<span>=</span> <span>'&lt;h2&gt;'</span> + line + <span>'&lt;/h2&gt;&lt;br /&gt;'</span>
                lastLine <span>=</span> line
            <span>elif</span> startedReview:
                <span>if</span> <span>'By'</span> <span>in</span> line:
                    currentReview +<span>=</span> <span>'&lt;br /&gt;&lt;b&gt;'</span> + line + <span>'&lt;/b&gt;&lt;br /&gt;'</span>
                    lastLine <span>=</span> line
                <span>else</span>:
                    currentReview +<span>=</span> line
                    lastLine <span>=</span> line
            <span>else</span>:
                lastLine <span>=</span> line
    <span>if</span> <span>len</span><span>(</span>chosenReviews<span>)</span> <span>==</span> <span>0</span>:
        <span>print</span><span>(</span><span>"no review! skipping!"</span><span>)</span>
        <span>continue</span>
    finalName <span>=</span> chosenNames<span>[</span><span>random</span>.<span>randint</span><span>(</span><span>0</span><span>,</span><span>len</span><span>(</span>chosenNames<span>)</span>-<span>1</span><span>)</span><span>]</span>.<span>strip</span><span>(</span><span>)</span>
    finalPrice <span>=</span> chosenPrices<span>[</span><span>random</span>.<span>randint</span><span>(</span><span>0</span><span>,</span><span>len</span><span>(</span>chosenPrices<span>)</span>-<span>1</span><span>)</span><span>]</span>
    <span>if</span> <span>len</span><span>(</span>chosenReviews<span>)</span> <span>&lt;</span> <span>2</span>:
    	finalReview <span>=</span> chosenReviews<span>[</span><span>0</span><span>]</span>
    <span>else</span>:
    	finalReview <span>=</span> chosenReviews<span>[</span><span>random</span>.<span>randint</span><span>(</span><span>0</span><span>,</span><span>len</span><span>(</span>chosenReviews<span>)</span>-<span>1</span><span>)</span><span>]</span>
    finalImage <span>=</span> <span>(</span><span>"/images/spirits/%i_%i_%i.jpg"</span> % chosenImage<span>)</span>
 
    divination <span>=</span> <span>{</span><span>'productName'</span>: finalName<span>,</span> <span>'price'</span>: finalPrice<span>,</span>
                  <span>'finalReview'</span>: finalReview<span>,</span> <span>'finalImage'</span>: finalImage<span>}</span>
    allDivinations.<span>append</span><span>(</span>divination<span>)</span>
    i +<span>=</span> <span>1</span>
 
<span>with</span> <span>open</span><span>(</span><span>'divinations.json'</span><span>,</span> <span>'w'</span><span>)</span> <span>as</span> final:
    json.<span>dump</span><span>(</span>allDivinations<span>,</span> final<span>)</span></pre></td></tr></table></div>

<p>Alright, if you look at the above code, you’ll notice a few things, the most obvious of which is that time.sleep. Yes, I’m being lazy here, and I’m just guessing at how long that Popen will need to run to generate all those texts, and all those files. Even though this number worked for me, it probably won’t work for you. You will probably want to tweak that number, or wait for your generating processes to finish sequentially.</p>
<p>Afterwards, we start to do a bit of formatting on the exports, adding just a bit of hacky html styling to our JSON object. This is gross, and there is a lot wrong with this, but it’s fine for a weekend hack. If we wanted to really do things properly, we’d separate out our review json object into a review_title, review_author, and a review_text variable in our JSON object. </p>
<p>Other than that, we want to make sure we get a full review, and that’s why we have added the chosenReview selector. We’re trying to make sure we only do reviews that have every bit generated with them otherwise we throw it all out.</p>
<p>After letting this run, we should have a finished JSON object with 50 divinations or so at the end of this:</p>



<p/><center><strong>Building the Final Presentation</strong></center><p>
Now, I just wrote a bit of Javascript, and embedded it into this blog post. A jQuery .getJSON() call loads up the JSON file we exported before. It then loads chooses a random number, and uses that number to pick one of our created objects.

</p><div class="wp_syntax"><table><tr><td class="code"><pre class="javascript"><span>var</span> productData <span>=</span> <span>[</span><span>]</span><span>;</span>
jQuery<span>(</span>document<span>)</span>.<span>ready</span><span>(</span><span>function</span><span>(</span>$<span>)</span> <span>{</span>
url <span>=</span> <span>'/uploads/divinations.json'</span><span>;</span>
$.<span>getJSON</span><span>(</span> url<span>,</span> <span>function</span><span>(</span> data <span>)</span> <span>{</span>
  <span>var</span> items <span>=</span> <span>[</span><span>]</span><span>;</span>
  productData <span>=</span> data<span>;</span>
  chosenOne <span>=</span> <span>Math</span>.<span>floor</span><span>(</span><span>(</span><span>Math</span>.<span>random</span><span>(</span><span>)</span> <span>*</span> productData.<span>length</span><span>)</span> <span>+</span> <span>1</span><span>)</span><span>;</span>
  productCamel <span>=</span> productData<span>[</span>chosenOne<span>]</span>.<span>productName</span>.<span>replace</span><span>(</span>
  <span>/(^|\s+)(\S)(\S*)/g</span><span>,</span>
  <span>function</span><span>(</span>match<span>,</span> whitespace<span>,</span> firstLetter<span>,</span> rest<span>)</span> <span>{</span>
    <span>return</span> whitespace <span>+</span> firstLetter.<span>toUpperCase</span><span>(</span><span>)</span> <span>+</span> rest.<span>toLowerCase</span><span>(</span><span>)</span><span>;</span>
  <span>}</span>
<span>)</span><span>;</span>
  $<span>(</span><span>'#productName'</span><span>)</span>.<span>html</span><span>(</span><span>'&lt;strong style="font-size: 150%;"&gt;'</span> <span>+</span> productCamel  <span>+</span> <span>'&lt;/strong&gt;'</span><span>)</span><span>;</span>
  $<span>(</span><span>'#price'</span><span>)</span>.<span>text</span><span>(</span>productData<span>[</span>chosenOne<span>]</span>.<span>price</span><span>)</span><span>;</span>
  $<span>(</span><span>'#review'</span><span>)</span>.<span>html</span><span>(</span>productData<span>[</span>chosenOne<span>]</span>.<span>finalReview</span><span>)</span><span>;</span>
  $<span>(</span><span>'#review h2'</span><span>)</span>.<span>prepend</span><span>(</span><span>'&lt;img src="/images/onestar.png" /&gt;'</span><span>)</span><span>;</span>
  $<span>(</span><span>'#productImage'</span><span>)</span>.<span>html</span><span>(</span><span>'&lt;img src="'</span> <span>+</span> productData<span>[</span>chosenOne<span>]</span>.<span>finalImage</span> <span>+</span> <span>'" width="128" height="128" /&gt;'</span><span>)</span><span>;</span>
<span>}</span><span>)</span><span>;</span>
$<span>(</span><span>'#nextProd'</span><span>)</span>.<span>click</span><span>(</span><span>function</span><span>(</span><span>)</span> <span>{</span>
  chosenOne <span>=</span> <span>Math</span>.<span>floor</span><span>(</span><span>(</span><span>Math</span>.<span>random</span><span>(</span><span>)</span> <span>*</span> productData.<span>length</span><span>)</span> <span>+</span> <span>1</span><span>)</span><span>;</span>
  productCamel <span>=</span> productData<span>[</span>chosenOne<span>]</span>.<span>productName</span>.<span>replace</span><span>(</span>
  <span>/(^|\s+)(\S)(\S*)/g</span><span>,</span>
  <span>function</span><span>(</span>match<span>,</span> whitespace<span>,</span> firstLetter<span>,</span> rest<span>)</span> <span>{</span>
    <span>return</span> whitespace <span>+</span> firstLetter.<span>toUpperCase</span><span>(</span><span>)</span> <span>+</span> rest.<span>toLowerCase</span><span>(</span><span>)</span><span>;</span>
  <span>}</span>
<span>)</span><span>;</span>
  $<span>(</span><span>'#productName'</span><span>)</span>.<span>html</span><span>(</span><span>'&lt;strong style="font-size: 150%;"&gt;'</span> <span>+</span> productCamel <span>+</span> <span>'&lt;/strong&gt;'</span><span>)</span><span>;</span>
  $<span>(</span><span>'#price'</span><span>)</span>.<span>text</span><span>(</span>productData<span>[</span>chosenOne<span>]</span>.<span>price</span><span>)</span><span>;</span>
  $<span>(</span><span>'#review'</span><span>)</span>.<span>html</span><span>(</span>productData<span>[</span>chosenOne<span>]</span>.<span>finalReview</span><span>)</span><span>;</span>
  $<span>(</span><span>'#review h2'</span><span>)</span>.<span>prepend</span><span>(</span><span>'&lt;img src="/images/onestar.png" /&gt;'</span><span>)</span><span>;</span>
  $<span>(</span><span>'#productImage'</span><span>)</span>.<span>html</span><span>(</span><span>'&lt;img src="'</span> <span>+</span> productData<span>[</span>chosenOne<span>]</span>.<span>finalImage</span> <span>+</span> <span>'" width="128" height="128" /&gt;'</span><span>)</span><span>;</span>
<span>}</span><span>)</span><span>;</span>
<span>}</span><span>)</span><span>;</span></pre></td></tr></table></div>

<p>Pretty hacky, and pretty embarassing, but it gets the job done for now, by dumping our JSON objects directly into our divs.</p>
<p/><center><strong>Next Steps</strong></center>
<p>That was a lot!</p>
<p>But what could we do to improve the outputs we’ve got? For now, tuning our neural nets is more of a trial and error process. I ended up getting much better results using a smaller neural net, and having it train three days on my Amazon reviews, than my first pass, with as large of a network as I could hold in memory on my video card.</p>
<p>I think the most disappointing part of the results was the images. I think we could make them a bit better, if we had some sort of cohesiveness to their generation. So maybe we could have a neural network at the beginning of data import, that tries to identify the product, and then tries to recreate a mishmash of things that it knows. IE, we could see an image of soap, and we could end up getting a differently colorized / shaped soap.</p>
<p>We could also have all of our product reviews / product names be dependent on what’s being generated in our photos. For now, the two have no awareness of one another, and that means we have a much more nonsensical result when we look at each individual product. Maybe if we had a contextual awareness between networks, we’d be able to generate something that makes a bit more sense.</p>
<p>And speaking of sense, there are a lot of reviews that don’t make any sense. That being said, there are a lot of input reviews from our dataset that don’t make sense too. We could run our output through a sentence parser, and make sure they form logical sentences, and that would improve things further.</p>
<p/><center><strong>Thanks for all the Fish</strong></center>
<p>One of the greatest things about the machine learning community is how much everyone gives back. I can’t thank Julian and everyone else involved in the papers and datasets enough. Without them, I would have never had the courage / idiocy to take on this project. Also, thanks to the devs behind torch-gan and char-rnn for sharing their code.</p>
<p>I hope this guide fosters more open dataset creation for people outside of academia and industry. I’d love to swap data sets with anyone else, or create a place to share more info on building them. I encourage you to send me any zany machine learning ideas you might have at my Twitter handle, @burningion. </p>
<p>Finally, shout out to Sammy for coming up with the idea!</p>
<p>Code, as always, is available on <a href="https://github.com/burningion/crappy-product-generator">Github</a>.</p>
<p><strong>Citations for Amazon Dataset:</strong></p>
<p>Image-based recommendations on styles and substitutes<br/>
J. McAuley, C. Targett, J. Shi, A. van den Hengel<br/>
SIGIR, 2015</p>
<p>Inferring networks of substitutable and complementary products<br/>
J. McAuley, R. Pandey, J. Leskovec<br/>
Knowledge Discovery and Data Mining, 2015</p>

			</div>

	</div></body></html>