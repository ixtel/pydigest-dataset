<html><body><div><section class="entry">
<p class="fsb-clear"/><p><iframe src="http://www.youtube.com/embed/zrgB9Nvhz58?feature=oembed" frameborder="0" allowfullscreen="">VIDEO</iframe></p>
<p>Let’s face it. <strong>Trying to search for images based on text and tags sucks.</strong></p>
<p>Whether you are tagging and categorizing your personal images, searching for stock photos for your company website, or simply trying to find the right image for your next epic blog post, trying to use <em>text and keywords</em> to describe something that is <em>inherently visual</em> is a real pain.</p>
<p>I faced this pain myself last Tuesday as I was going through some old family photo albums there were scanned and digitized nine years ago.</p>
<p>You see, I was looking for a bunch of photos that were taken along the beaches of Hawaii with my family. I opened up iPhoto, and slowly made my way through the photographs. It was a painstaking process. The meta-information for each JPEG contained incorrect dates. The photos were not organized in folders like I remembered — I simply couldn’t find the beach photos that I was desperately searching for.</p>
<p>Perhaps by luck, I stumbled across one of the beach photographs. It was a beautiful, almost surreal beach shot. Puffy white clouds in the sky. Crystal clear ocean water, lapping at the golden sands. You could literally feel the breeze on your skin and smell the ocean air.</p>
<p><strong><em>After seeing this photo, I stopped my manual search and opened up a code editor.</em></strong></p>
<p>While applications such as iPhoto let you organize your photos into collections and even detect and recognize faces, we can certainly do more.</p>
<p>No, I’m not talking about manually tagging your images. I’m talking about something more powerful. What if you could actually <em>search</em> your collection of images <em>using an another image?</em></p>
<p>Wouldn’t that be cool? It would allow you to apply visual search to your own images, in just a single click.</p>
<p>And that’s exactly what I did. I spent the next half-hour coding and when I was done I had created a visual search engine for my family vacation photos.</p>
<p>I then took the sole beach image that I found and then submitted it to my image search engine. Within seconds I had found all of the other beach photos, <strong><em>all without labeling or tagging a single image.</em></strong></p>
<p>Sound interesting? Read on.</p>
<p>In the rest of this blog post I’ll show you how to build an image search engine of your own.</p>

<p><strong>OpenCV and Python versions:</strong><br/>
This example will run on<strong> Python 2.7</strong> and <strong>OpenCV 2.4.X</strong>.</p>
<h1>What’s an Image Search Engine?</h1>
<p>So you’re probably wondering, what actually is an image search engine?</p>
<p>I mean, we’re all familiar with text based search engines such as Google, Bing, and DuckGoGo — you simply enter a few keywords related to the content you want to find (i.e., your “query”), and then your results are returned to you. But for image search engines, things work a little differently — you’re not using <em>text</em> as your query, you are instead using an <em>image</em>.</p>
<p>Sounds pretty hard to do, right? I mean, how do you quantify the contents of an image to make it search-able?</p>
<p>We’ll cover the answer to that question in a bit. But to start, let’s learn a little more about image search engines.</p>
<p>In general, there tend to be three types of image search engines: <strong>search by meta-data</strong>, <strong>search by example</strong>, and a <strong>hybrid approach</strong> of the two.</p>
<h2>Search by Meta-Data</h2>
<div id="attachment_1554" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2014/11/flickr_example.jpg"><img class="wp-image-1554" src="http://www.pyimagesearch.com/wp-content/uploads/2014/11/flickr_example.jpg" alt="Figure 1: Example of a search by meta-deta image search engine. Notice how keywords and tags are manually attributed to the image." srcset="http://www.pyimagesearch.com/wp-content/uploads/2014/11/flickr_example-300x176.jpg 300w, http://www.pyimagesearch.com/wp-content/uploads/2014/11/flickr_example.jpg 1000w" sizes="(max-width: 600px) 100vw, 600px"/></a><p class="wp-caption-text"><strong>Figure 1:</strong> Example of a search by meta-deta image search engine. Notice how keywords and tags are manually attributed to the image.</p></div>
<p>Searching by meta-data is only marginally different than your standard keyword-based search engines mentioned above. Search by meta-data systems rarely examine the contents of the image itself. Instead, they rely on textual clues such as (1) manual annotations and tagging performed by humans along with (2) automated contextual hints, such as the text that appears near the image on a webpage.</p>
<p>When a user performs a search on a search by meta-data system they provide a query, just like in a traditional text search engine, and then images that have similar tags or annotations are returned.</p>
<p>Again, when utilizing a search by meta-data system the actual image itself is rarely examined.</p>
<p>A great example of a Search by Meta-Data image search engine is <a href="http://www.flickr.com" target="_blank">Flickr</a>. After uploading an image to Flickr you are presented with a text field to enter tags describing the contents of images you have uploaded. Flickr then takes these keywords, indexes them, and utilizes them to find and recommend other relevant images.</p>
<h2>Search by Example</h2>
<div id="attachment_1555" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2014/11/tineye_example.jpg"><img class="wp-image-1555" src="http://www.pyimagesearch.com/wp-content/uploads/2014/11/tineye_example.jpg" alt="Figure 2: TinEye is an example of a &quot;search by example&quot; image search engine. The contents of the image itself are used to perform the search rather than text." srcset="http://www.pyimagesearch.com/wp-content/uploads/2014/11/tineye_example-300x176.jpg 300w, http://www.pyimagesearch.com/wp-content/uploads/2014/11/tineye_example.jpg 1000w" sizes="(max-width: 600px) 100vw, 600px"/></a><p class="wp-caption-text"><strong>Figure 2:</strong> TinEye is an example of a “search by example” image search engine. The contents of the image itself are used to perform the search rather than text.</p></div>
<p>Search by example systems, on the other hand, rely solely on the contents of the image — no keywords are assumed to be provided. The image is analyzed, quantified, and stored so that similar images are returned by the system during a search.</p>
<p>Image search engines that quantify the contents of an image are called <strong>Content-Based Image Retrieval</strong> (CBIR) systems. The term CBIR is commonly used in the academic literature, but in reality, it’s simply a fancier way of saying “image search engine”, with the added poignancy that the search engine is relying <em>strictly</em> on the contents of the image and not any textual annotations associated with the image.</p>
<p>A great example of a Search by Example system is <a href="https://www.tineye.com/" target="_blank">TinEye</a>. TinEye is actually a reverse image search engine where you provide a query image, and then TinEye returns near-identical matches of the same image, along with the webpage that the original image appeared on.</p>
<p>Take a look at the example image at the top of this section. Here I have uploaded an image of the Google logo. TinEye has examined the contents of the image and returned to me the 13,000+ webpages that the Google logo appears on after searching through an index of over 6 billion images.</p>
<p>So consider this: <em>Are you going to manually label each of these 6 billion images in TinEye?</em> <strong>Of course not.</strong> That would take an army of employees and would be extremely costly.</p>
<p>Instead, you utilize some sort of algorithm to extract “features” (i.e., a list of numbers to quantify and abstractly represent the image) from the image itself. Then, when a user submits a query image, you extract features from the query image and compare them to your database of features and try to find similar images.</p>
<p>Again, it’s important to reinforce the point that Search by Example systems rely <em>strictly</em> on the contents of the image. These types of systems tend to be extremely hard to build and scale, but allow for a fully automated algorithm to govern the search — no human intervention is required.</p>
<h2>Hybrid Approach</h2>
<div id="attachment_1556" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2014/11/twitter_example.jpg"><img class="wp-image-1556" src="http://www.pyimagesearch.com/wp-content/uploads/2014/11/twitter_example.jpg" alt="Figure 3: A hybrid image search engine can take into account both text and images." srcset="http://www.pyimagesearch.com/wp-content/uploads/2014/11/twitter_example-300x176.jpg 300w, http://www.pyimagesearch.com/wp-content/uploads/2014/11/twitter_example.jpg 1000w" sizes="(max-width: 600px) 100vw, 600px"/></a><p class="wp-caption-text"><strong>Figure 3:</strong> A hybrid image search engine can take into account both <em>text</em> and <em>images</em>.</p></div>
<p>Of course, there is a middle ground between the two – consider Twitter, for instance.</p>
<p>On Twitter you can upload photos to accompany your tweets. A hybrid approach would be to correlate the features extracted from the image with the text of the tweet. Using this approach you could build an image search engine that could take both contextual hints along with a Search by Example strategy.</p>
<p><em>Note: Interested in reading more about the different types of image search engines? I have an entire blog post dedicated to comparing and contrasting them, <a title="The 3 Types of Image Search Engines: Search by Meta-data, Search by Example, and Hybrid" href="http://www.pyimagesearch.com/2014/01/15/the-3-types-of-image-search-engines-search-by-meta-data-search-by-example-and-hybrid/" target="_blank">available here</a>.</em></p>
<p>Let’s move on to defining some important terms that we’ll use regularly when describing and building image search engines.</p>
<h1>Some Important Terms</h1>
<p>Before we get too in-depth, let’s take a little bit of time to define a few important terms.</p>
<p>When building an image search engine we will first have to <strong><em>index our dataset</em></strong>. Indexing a dataset is the process of quantifying our dataset by utilizing an <strong><em>image descriptor</em></strong> to extract <strong><em>features</em></strong> from each image.</p>
<p>An <strong><em>image descriptor</em></strong> defines the algorithm that we are utilizing to describe our image.</p>
<p>For example:</p>
<ul>
<li>The mean and standard deviation of each Red, Green, and Blue channel, respectively,</li>
<li>The statistical moments of the image to characterize shape.</li>
<li>The gradient magnitude and orientation to describe both shape and texture.</li>
</ul>
<p>The important takeaway here is that the <strong><em>image descriptor</em></strong> governs <strong><em>how</em></strong> the image is quantified.</p>
<p><strong><em>Features</em></strong>, on the other hand, are the output of an <strong><em>image descriptor</em></strong>. When you put an image into an image descriptor, you will get <strong><em>features</em></strong> out the other end.</p>
<p>In the most basic terms, <strong><em>features</em></strong> (or <strong><em>feature vectors</em></strong>) are just a list of numbers used to abstractly represent and quantify images.</p>
<p>Take a look at the example figure below:</p>
<div id="attachment_1557" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2014/11/describing_images.jpg"><img class="wp-image-1557" src="http://www.pyimagesearch.com/wp-content/uploads/2014/11/describing_images.jpg" alt="Figure 4: The pipeline of an image descriptor. An input image is presented to the descriptor, the image descriptor is applied, and a feature vector (i.e a list of numbers) is returned, used to quantify the contents of the image." srcset="http://www.pyimagesearch.com/wp-content/uploads/2014/11/describing_images-300x75.jpg 300w, http://www.pyimagesearch.com/wp-content/uploads/2014/11/describing_images.jpg 800w" sizes="(max-width: 600px) 100vw, 600px"/></a><p class="wp-caption-text"><strong>Figure 4:</strong> The pipeline of an image descriptor. An input image is presented to the descriptor, the image descriptor is applied, and a feature vector (i.e a list of numbers) is returned, used to quantify the contents of the image.</p></div>
<p>Here we are presented with an input image, we apply our image descriptor, and then our output is a list of features used to quantify the image.</p>
<p>Feature vectors can then be compared for similarity by using a <strong><em>distance metric</em></strong> or <strong><em>similarity function</em></strong>. Distance metrics and similarity functions take two feature vectors as inputs and then output a number that represents how “similar” the two feature vectors are.</p>
<p>The figure below visualizes the process of comparing two images:</p>
<div id="attachment_1558" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2014/11/comparing_images.jpg"><img class="wp-image-1558" src="http://www.pyimagesearch.com/wp-content/uploads/2014/11/comparing_images.jpg" alt="Figure 5: To compare two images, we input the respective feature vectors into a distance metric/similarity function. The output is a value used to represent and quantify how &quot;similar&quot; the two images are to each other.."/></a><p class="wp-caption-text"><strong>Figure 5:</strong> To compare two images, we input the respective feature vectors into a distance metric/similarity function. The output is a value used to represent and quantify how “similar” the two images are to each other..</p></div>
<p>Given two feature vectors, a distance function is used to determine how similar the two feature vectors are. The output of the distance function is a single floating point value used to represent the similarity between the two images.</p>
<h1>The 4 Steps of Any CBIR System</h1>
<p>No matter what Content-Based Image Retrieval System you are building, they all can be boiled down into 4 distinct steps:</p>
<ol>
<li><strong>Defining your image descriptor:</strong> At this phase you need to decide what aspect of the image you want to describe. Are you interested in the color of the image? The shape of an object in the image? Or do you want to characterize texture?</li>
<li><strong>Indexing your dataset:</strong> Now that you have your image descriptor defined, your job is to apply this image descriptor to each image in your dataset, extract features from these images, and write the features to storage (ex. CSV file, RDBMS, Redis, etc.) so that they can be later compared for similarity.</li>
<li><strong>Defining your similarity metric:</strong> Cool, now you have a bunch of feature vectors. But how are you going to compare them? Popular choices include the Euclidean distance, Cosine distance, and chi-squared distance, but the actual choice is highly dependent on (1) your dataset and (2) the types of features you extracted.</li>
<li><strong>Searching:</strong> The final step is to perform an actual search. A user will submit a query image to your system (from an upload form or via a mobile app, for instance) and your job will be to (1) extract features from this query image and then (2) apply your similarity function to compare the query features to the features already indexed. From there, you simply return the most relevant results according to your similarity function.</li>
</ol>
<p>Again, these are the most basic 4 steps of any CBIR system. As they become more complex and utilize different feature representations, the number of steps grow and you’ll add a substantial number of sub-steps to each step mentioned above. But for the time being, let’s keep things simple and utilize just these 4 steps.</p>
<p>Let’s take a look at a few graphics to make these high-level steps a little more concrete. The figure below details Steps 1 and 2:</p>
<div id="attachment_1559" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2014/11/preprocessing_and_indexing.jpg"><img class="wp-image-1559" src="http://www.pyimagesearch.com/wp-content/uploads/2014/11/preprocessing_and_indexing.jpg" alt="Figure 6: A flowchart representing the process of extracting features from each image in the dataset." srcset="http://www.pyimagesearch.com/wp-content/uploads/2014/11/preprocessing_and_indexing-300x83.jpg 300w, http://www.pyimagesearch.com/wp-content/uploads/2014/11/preprocessing_and_indexing.jpg 720w" sizes="(max-width: 600px) 100vw, 600px"/></a><p class="wp-caption-text"><strong>Figure 6:</strong> A flowchart representing the process of extracting features from each image in the dataset.</p></div>
<p>We start by taking our dataset of images, extracting features from each image, and then storing these features in a database.</p>
<p>We can then move on to performing a search (Steps 3 and 4):</p>
<div id="attachment_1560" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2014/11/searching.jpg"><img class="wp-image-1560" src="http://www.pyimagesearch.com/wp-content/uploads/2014/11/searching.jpg" alt="Figure 7: Performing a search on a CBIR system. A user submits a query, the query image is described, the query features are compared to existing features in the database, results are sorted by relevancy and then presented to the user."/></a><p class="wp-caption-text"><strong>Figure 7:</strong> Performing a search on a CBIR system. A user submits a query, the query image is described, the query features are compared to existing features in the database, results are sorted by relevancy and then presented to the user.</p></div>
<p>First, a user must submit a query image to our image search engine. We then take the query image and extract features from it. These “query features” are then compared to the features of the images we already indexed in our dataset. Finally, the results are then sorted by relevancy and presented to the user.</p>
<h1>Our Dataset of Vacation Photos</h1>
<p>We’ll be utilizing the <a href="http://lear.inrialpes.fr/people/jegou/data.php" target="_blank">INRIA Holidays Dataset</a> for our dataset of images.</p>
<p>This dataset consists of various vacation trips from all over the world, including photos of the Egyptian pyramids, underwater diving with sea-life, forests in the mountains, wine bottles and plates of food at dinner, boating excursions, and sunsets across the ocean.</p>
<p>Here are a few samples from the dataset:</p>
<div id="attachment_1561" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2014/11/dataset_sample.jpg"><img class="wp-image-1561" src="http://www.pyimagesearch.com/wp-content/uploads/2014/11/dataset_sample.jpg" alt="Figure 8: Example images from the INRIA Holidays Dataset. We'll be using this dataset to build our image search engine." srcset="http://www.pyimagesearch.com/wp-content/uploads/2014/11/dataset_sample-300x135.jpg 300w, http://www.pyimagesearch.com/wp-content/uploads/2014/11/dataset_sample.jpg 1000w" sizes="(max-width: 600px) 100vw, 600px"/></a><p class="wp-caption-text"><strong>Figure 8:</strong> Example images from the INRIA Holidays Dataset. We’ll be using this dataset to build our image search engine.</p></div>
<p>In general, this dataset does an extremely good job at modeling what we would expect a tourist to photograph on a scenic trip.</p>
<h1>The Goal</h1>
<p>Our goal here is to build a personal image search engine. Given our dataset of vacation photos, we want to make this dataset “search-able” by creating a “more like this” functionality — this will be a “search by example” image search engine. For instance, if I submit a photo of sail boats gliding across a river, our image search engine should be able to find and retrieve our vacation photos of when we toured the marina and docks.</p>
<p>Take a look at the example below where I have submitted an photo of the boats on the water and have found relevant images in our vacation photo collection:</p>
<div id="attachment_1562" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2014/11/results_boats.jpg"><img class="wp-image-1562" src="http://www.pyimagesearch.com/wp-content/uploads/2014/11/results_boats.jpg" alt="Figure 9: An example of our image search engine. We submit a query image containing boats and the sea. The results returned to us are relevant since they too contain both boats and the sea." srcset="http://www.pyimagesearch.com/wp-content/uploads/2014/11/results_boats-125x300.jpg 125w, http://www.pyimagesearch.com/wp-content/uploads/2014/11/results_boats.jpg 800w" sizes="(max-width: 600px) 100vw, 600px"/></a><p class="wp-caption-text"><strong>Figure 9:</strong> An example of our image search engine. We submit a query image containing boats on the sea. The results returned to us are relevant since they too contain both boats and the sea.</p></div>
<p>In order to build this system, we’ll be using a simple, yet effective image descriptor: <strong>the color histogram</strong>.</p>
<p>By utilizing a color histogram as our image descriptor, we’ll be we’ll be relying on the <em>color distribution</em> of the image. Because of this, we have to make an important assumption regarding our image search engine:</p>
<p><strong>Assumption:</strong> Images that have similar color distributions will be considered relevant to each other. Even if images have dramatically different contents, they will still be considered “similar” provided that their color distributions are similar as well.</p>
<p><strong><em>This is a really important assumption</em></strong>, but is normally a fair and reasonable assumption to make when using color histograms as image descriptors.</p>
<h1>Step 1: Defining our Image Descriptor</h1>
<p>Instead of using a standard color histogram, we are going to apply a few tricks and make it a little more robust and powerful.</p>
<p>Our image descriptor will be a 3D color histogram in the HSV color space (Hue, Saturation, Value). Typically, images are represented as a 3-tuple of Red, Green, and Blue (RGB). We often think of the RGB color space as “cube”, as shown below:</p>
<div id="attachment_1564" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2014/11/rgb_color_cube.jpg"><img class="wp-image-1564" src="http://www.pyimagesearch.com/wp-content/uploads/2014/11/rgb_color_cube.jpg" alt="Figure 10: Example of the RGB cube." srcset="http://www.pyimagesearch.com/wp-content/uploads/2014/11/rgb_color_cube-300x264.jpg 300w, http://www.pyimagesearch.com/wp-content/uploads/2014/11/rgb_color_cube.jpg 800w" sizes="(max-width: 600px) 100vw, 600px"/></a><p class="wp-caption-text"><strong>Figure 10:</strong> Example of the RGB cube.</p></div>
<p>However, while RGB values are simple to understand, the RGB color space fails to mimic how humans perceive color. Instead, we are going to use the HSV color space which maps pixel intensities into a cylinder:</p>
<div id="attachment_1565" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2014/11/hsv_color_cylinder.jpg"><img class="size-full wp-image-1565" src="http://www.pyimagesearch.com/wp-content/uploads/2014/11/hsv_color_cylinder.jpg" alt="Figure 11: Example of the HSV cylinder." srcset="http://www.pyimagesearch.com/wp-content/uploads/2014/11/hsv_color_cylinder-300x230.jpg 300w, http://www.pyimagesearch.com/wp-content/uploads/2014/11/hsv_color_cylinder.jpg 500w" sizes="(max-width: 500px) 100vw, 500px"/></a><p class="wp-caption-text"><strong>Figure 11:</strong> Example of the HSV cylinder.</p></div>
<p>There are other color spaces that do an even better job at mimicking how humans perceive color, such as the CIE L*a*b* and CIE XYZ spaces, but let’s keep our color model relatively simple for our first image search engine implementation.</p>
<p>So now that we have selected a color space, we now need to define the number of <strong>bins</strong> for our histogram. Histograms are used to give a (rough) sense of the density of pixel intensities in an image. Essentially, our histogram will estimate the probability density of the underlying function, or in this case, the probability <em>P</em> of a pixel color <em>C</em> occurring in our image <em>I</em>.</p>
<p>It’s important to note that there is a trade-off with the number of bins you select for your histogram. If you select <em>too few bins</em>, then your histogram will have less components and unable to disambiguate between images with substantially different color distributions. Likewise, if you use <em>too many bins</em> your histogram will have many components and images with very similar contents may be regarded and “not similar” when in reality they are.</p>
<p>Here’s an example of a histogram with only a few bins:</p>
<div id="attachment_1570" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2014/11/histogram_few_bins.jpg"><img class="wp-image-1570" src="http://www.pyimagesearch.com/wp-content/uploads/2014/11/histogram_few_bins.jpg" alt="Figure 12: An example of a 9-bin histogram. Notice how there are very few bins for a given pixel to be placed in." srcset="http://www.pyimagesearch.com/wp-content/uploads/2014/11/histogram_few_bins-300x225.jpg 300w, http://www.pyimagesearch.com/wp-content/uploads/2014/11/histogram_few_bins.jpg 800w" sizes="(max-width: 600px) 100vw, 600px"/></a><p class="wp-caption-text"><strong>Figure 12:</strong> An example of a 9-bin histogram. Notice how there are very few bins for a given pixel to be placed in.</p></div>
<p>Notice how there are very few bins that a pixel can be placed into.</p>
<p>And here’s an example of a histogram with lots of bins:</p>
<div id="attachment_1571" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2014/11/histogram_many_bins.jpg"><img class="wp-image-1571" src="http://www.pyimagesearch.com/wp-content/uploads/2014/11/histogram_many_bins.jpg" alt="Figure 13: An example of a 128-bin histogram. Notice how there are many bins that a given pixel can be placed in." srcset="http://www.pyimagesearch.com/wp-content/uploads/2014/11/histogram_many_bins-300x225.jpg 300w, http://www.pyimagesearch.com/wp-content/uploads/2014/11/histogram_many_bins.jpg 800w" sizes="(max-width: 600px) 100vw, 600px"/></a><p class="wp-caption-text"><strong>Figure 13:</strong> An example of a 128-bin histogram. Notice how there are many bins that a given pixel can be placed in.</p></div>
<p>In the above example you can see that many bins are utilized, but with the larger number of bins, you lose your ability to “generalize” between images with similar perceptual content since all of the peaks and valleys of the histogram will have to match in order for two images to be considered “similar”.</p>
<p>Personally, I like an iterative, experimental approach to tuning the number of bins. This iterative approach is normally based on the size of my dataset. The more smaller that my dataset is, the less bins I use. And if my dataset is large, I use more bins, making my histograms larger and more discriminative.</p>
<p>In general, you’ll want to experiment with the number of bins for your color histogram descriptor as it is dependent on (1) the size of your dataset and (2) how similar the color distributions in your dataset are to each other.</p>
<p>For our vacation photo image search engine, we’ll be utilizing a 3D color histogram in the HSV color space with 8 bins for the Hue channel, 12 bins for the saturation channel, and 3 bins for the value channel, yielding a total feature vector of dimension <em>8 x 12 x 3 = 288</em>.</p>
<p>This means that for every image in our dataset, no matter if the image is <em>36 x 36</em> pixels or <em>2000 x 1800</em> pixels, all images will be abstractly represented and quantified using only a list of 288 floating point numbers.</p>
<p>I think the best way to explain a 3D histogram is to use the conjunctive <strong>AND</strong>. A 3D HSV color descriptor will ask a given image how many pixels have a Hue value that fall into bin #1 AND how many pixels have a Saturation value that fall into bin #1 <strong>AND</strong> how many pixels have a Value intensity that fall into bin #1. The number of pixels that meet these requirements are then tabulated. This process is repeated for each combination of bins; however, we are able to do it in an extremely computationally efficient manner.</p>
<p>Pretty cool, right?</p>
<p>Anyway, enough talk. Let’s get into some code.</p>
<p>Open up a new file in your favorite code editor, name it 
			<span id="crayon-56d59c3230c3d874700636" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">colordescriptor</span><span class="crayon-sy">.</span><span class="crayon-v">py</span></span></span>  and let’s get started:</p>

		<div id="crayon-56d59c3230c67441775328" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-56d59c3230c67441775328-1">1</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230c67441775328-2">2</p><p class="crayon-num" data-line="crayon-56d59c3230c67441775328-3">3</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230c67441775328-4">4</p><p class="crayon-num" data-line="crayon-56d59c3230c67441775328-5">5</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230c67441775328-6">6</p><p class="crayon-num" data-line="crayon-56d59c3230c67441775328-7">7</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230c67441775328-8">8</p><p class="crayon-num" data-line="crayon-56d59c3230c67441775328-9">9</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230c67441775328-10">10</p><p class="crayon-num" data-line="crayon-56d59c3230c67441775328-11">11</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230c67441775328-12">12</p><p class="crayon-num" data-line="crayon-56d59c3230c67441775328-13">13</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230c67441775328-14">14</p><p class="crayon-num" data-line="crayon-56d59c3230c67441775328-15">15</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230c67441775328-16">16</p><p class="crayon-num" data-line="crayon-56d59c3230c67441775328-17">17</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230c67441775328-18">18</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d59c3230c67441775328-1"><span class="crayon-c"># import the necessary packages</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230c67441775328-2"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">numpy </span><span class="crayon-st">as</span><span class="crayon-h"> </span><span class="crayon-e">np</span></p><p class="crayon-line" id="crayon-56d59c3230c67441775328-3"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">cv2</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230c67441775328-4"> </p><p class="crayon-line" id="crayon-56d59c3230c67441775328-5"><span class="crayon-t">class</span><span class="crayon-h"> </span><span class="crayon-v">ColorDescriptor</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230c67441775328-6"><span class="crayon-h">	</span><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">__init__</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">bins</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d59c3230c67441775328-7"><span class="crayon-h">		</span><span class="crayon-c"># store the number of bins for the 3D histogram</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230c67441775328-8"><span class="crayon-h">		</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">bins</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">bins</span></p><p class="crayon-line" id="crayon-56d59c3230c67441775328-9"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230c67441775328-10"><span class="crayon-e">	</span><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">describe</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d59c3230c67441775328-11"><span class="crayon-h">		</span><span class="crayon-c"># convert the image to the HSV color space and initialize</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230c67441775328-12"><span class="crayon-h">		</span><span class="crayon-c"># the features used to quantify the image</span></p><p class="crayon-line" id="crayon-56d59c3230c67441775328-13"><span class="crayon-h">		</span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">cvtColor</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">COLOR_BGR2HSV</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230c67441775328-14"><span class="crayon-h">		</span><span class="crayon-v">features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">]</span></p><p class="crayon-line" id="crayon-56d59c3230c67441775328-15"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230c67441775328-16"><span class="crayon-h">		</span><span class="crayon-c"># grab the dimensions and compute the center of the image</span></p><p class="crayon-line" id="crayon-56d59c3230c67441775328-17"><span class="crayon-h">		</span><span class="crayon-sy">(</span><span class="crayon-v">h</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-k ">w</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230c67441775328-18"><span class="crayon-h">		</span><span class="crayon-sy">(</span><span class="crayon-v">cX</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">cY</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-k ">int</span><span class="crayon-sy">(</span><span class="crayon-k ">w</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-cn">0.5</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-k ">int</span><span class="crayon-sy">(</span><span class="crayon-v">h</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-cn">0.5</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>We’ll start by importing the Python packages we’ll need. We’ll use NumPy for numerical processing and 
			<span id="crayon-56d59c3230c6d545793688" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">cv2</span></span></span>  for our OpenCV bindings.</p>
<p>We then define our 
			<span id="crayon-56d59c3230c71163283469" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">ColorDescriptor</span></span></span>  class on <strong>Line 5</strong>. This class will encapsulate all the necessary logic to extract our 3D HSV color histogram from our images.</p>
<p>The 
			<span id="crayon-56d59c3230c75580411270" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">__init__</span></span></span>  method of the 
			<span id="crayon-56d59c3230c79951644660" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">ColorDescriptor</span></span></span>  takes only a single argument, 
			<span id="crayon-56d59c3230c7c928032059" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">bins</span></span></span> , which is the number of bins for our color histogram.</p>
<p>We can then define our 
			<span id="crayon-56d59c3230c84764552244" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">describe</span></span></span>  method on <strong>Line 10</strong>. This method requires an 
			<span id="crayon-56d59c3230c88950837312" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">image</span></span></span> , which is the image we want to describe.</p>
<p>Inside of our 
			<span id="crayon-56d59c3230c8c806124806" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">describe</span></span></span>  method we’ll convert from the RGB color space (or rather, the BGR color space; OpenCV represents RGB images as NumPy arrays, but in reverse order) to the HSV color space, followed by initializing our list of 
			<span id="crayon-56d59c3230c8f081685111" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">features</span></span></span>  to quantify and represent our 
			<span id="crayon-56d59c3230c93829702906" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">image</span></span></span> .</p>
<p><strong>Lines 17 and 18</strong> simply grab the dimensions of the image and compute the center <em>(x, y)</em> coordinates.</p>
<p>So now the hard work starts.</p>
<p>Instead of computing a 3D HSV color histogram for the <strong><em>entire</em></strong> image, let’s instead compute a 3D HSV color histogram for different <strong><em>regions</em></strong> of the image.</p>
<p>Using <strong><em>regions</em></strong>-based histograms rather than <strong><em>global</em></strong>-histograms allows us to simulate locality in a color distribution. For example, take a look at this image below:</p>
<div id="attachment_1572" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2014/11/query_beach.png"><img class="size-full wp-image-1572" src="http://www.pyimagesearch.com/wp-content/uploads/2014/11/query_beach.png" alt="Figure 14: Our example query image." srcset="http://www.pyimagesearch.com/wp-content/uploads/2014/11/query_beach-300x225.png 300w, http://www.pyimagesearch.com/wp-content/uploads/2014/11/query_beach.png 400w" sizes="(max-width: 400px) 100vw, 400px"/></a><p class="wp-caption-text"><strong>Figure 14:</strong> Our example query image.</p></div>
<p>In this photo we can clearly see a blue sky at the top of the image and a sandy beach at the bottom. Using a global histogram we would be unable to determine <em>where</em> in the image the “blue” occurs and where the “brown” sand occurs. Instead, we would just know that there exists some percentage of blue and some percentage of brown.</p>
<p>To remedy this problem, we can compute color histograms in regions of the image:</p>
<div id="attachment_1573" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2014/11/image_segments.jpg"><img class="size-full wp-image-1573" src="http://www.pyimagesearch.com/wp-content/uploads/2014/11/image_segments.jpg" alt="Figure 15: Example of dividing our image into 5 different segments." srcset="http://www.pyimagesearch.com/wp-content/uploads/2014/11/image_segments-300x225.jpg 300w, http://www.pyimagesearch.com/wp-content/uploads/2014/11/image_segments.jpg 400w" sizes="(max-width: 400px) 100vw, 400px"/></a><p class="wp-caption-text"><strong>Figure 15:</strong> Example of dividing our image into 5 different segments.</p></div>
<p>For our image descriptor, we are going to divide our image into five different regions: (1) the top-left corner, (2) the top-right corner, (3) the bottom-right corner, (4) the bottom-left corner, and finally (5) the center of the image.</p>
<p>By utilizing these regions we’ll be able to mimic a crude form of localization, being able to represent our above beach image as having shades of blue sky in the top-left and top-right corners, brown sand in the bottom-left and bottom-right corners, and then a combination of blue sky and brown sand in the center region.</p>
<p>That all said, here is the code create our region-based color descriptor:</p>

		<div id="crayon-56d59c3230c98757387544" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230c98757387544-20">20</p><p class="crayon-num" data-line="crayon-56d59c3230c98757387544-21">21</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230c98757387544-22">22</p><p class="crayon-num" data-line="crayon-56d59c3230c98757387544-23">23</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230c98757387544-24">24</p><p class="crayon-num" data-line="crayon-56d59c3230c98757387544-25">25</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230c98757387544-26">26</p><p class="crayon-num" data-line="crayon-56d59c3230c98757387544-27">27</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230c98757387544-28">28</p><p class="crayon-num" data-line="crayon-56d59c3230c98757387544-29">29</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230c98757387544-30">30</p><p class="crayon-num" data-line="crayon-56d59c3230c98757387544-31">31</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230c98757387544-32">32</p><p class="crayon-num" data-line="crayon-56d59c3230c98757387544-33">33</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230c98757387544-34">34</p><p class="crayon-num" data-line="crayon-56d59c3230c98757387544-35">35</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230c98757387544-36">36</p><p class="crayon-num" data-line="crayon-56d59c3230c98757387544-37">37</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230c98757387544-38">38</p><p class="crayon-num" data-line="crayon-56d59c3230c98757387544-39">39</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230c98757387544-40">40</p><p class="crayon-num" data-line="crayon-56d59c3230c98757387544-41">41</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230c98757387544-42">42</p><p class="crayon-num" data-line="crayon-56d59c3230c98757387544-43">43</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230c98757387544-44">44</p><p class="crayon-num" data-line="crayon-56d59c3230c98757387544-45">45</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230c98757387544-46">46</p><p class="crayon-num" data-line="crayon-56d59c3230c98757387544-47">47</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230c98757387544-48">48</p><p class="crayon-num" data-line="crayon-56d59c3230c98757387544-49">49</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230c98757387544-50">50</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230c98757387544-20"><span class="crayon-h">		</span><span class="crayon-c"># divide the image into four rectangles/segments (top-left,</span></p><p class="crayon-line" id="crayon-56d59c3230c98757387544-21"><span class="crayon-h">		</span><span class="crayon-c"># top-right, bottom-right, bottom-left)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230c98757387544-22"><span class="crayon-h">		</span><span class="crayon-v">segments</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">(</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">cX</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">cY</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">cX</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-k ">w</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">cY</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">cX</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-k ">w</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">cY</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">h</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d59c3230c98757387544-23"><span class="crayon-h">			</span><span class="crayon-sy">(</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">cX</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">cY</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">h</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230c98757387544-24"> </p><p class="crayon-line" id="crayon-56d59c3230c98757387544-25"><span class="crayon-h">		</span><span class="crayon-c"># construct an elliptical mask representing the center of the</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230c98757387544-26"><span class="crayon-h">		</span><span class="crayon-c"># image</span></p><p class="crayon-line" id="crayon-56d59c3230c98757387544-27"><span class="crayon-h">		</span><span class="crayon-sy">(</span><span class="crayon-v">axesX</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">axesY</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-k ">int</span><span class="crayon-sy">(</span><span class="crayon-k ">w</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-cn">0.75</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-k ">int</span><span class="crayon-sy">(</span><span class="crayon-v">h</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-cn">0.75</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230c98757387544-28"><span class="crayon-h">		</span><span class="crayon-v">ellipMask</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">np</span><span class="crayon-sy">.</span><span class="crayon-e">zeros</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dtype</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"uint8"</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59c3230c98757387544-29"><span class="crayon-h">		</span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">ellipse</span><span class="crayon-sy">(</span><span class="crayon-v">ellipMask</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">cX</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">cY</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">axesX</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">axesY</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">360</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">255</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230c98757387544-30"> </p><p class="crayon-line" id="crayon-56d59c3230c98757387544-31"><span class="crayon-h">		</span><span class="crayon-c"># loop over the segments</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230c98757387544-32"><span class="crayon-h">		</span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">startX</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">endX</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">startY</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">endY</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">segments</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d59c3230c98757387544-33"><span class="crayon-h">			</span><span class="crayon-c"># construct a mask for each corner of the image, subtracting</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230c98757387544-34"><span class="crayon-h">			</span><span class="crayon-c"># the elliptical center from it</span></p><p class="crayon-line" id="crayon-56d59c3230c98757387544-35"><span class="crayon-h">			</span><span class="crayon-v">cornerMask</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">np</span><span class="crayon-sy">.</span><span class="crayon-e">zeros</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dtype</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"uint8"</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230c98757387544-36"><span class="crayon-h">			</span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">rectangle</span><span class="crayon-sy">(</span><span class="crayon-v">cornerMask</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">startX</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">startY</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">endX</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">endY</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">255</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59c3230c98757387544-37"><span class="crayon-h">			</span><span class="crayon-v">cornerMask</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">subtract</span><span class="crayon-sy">(</span><span class="crayon-v">cornerMask</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ellipMask</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230c98757387544-38"> </p><p class="crayon-line" id="crayon-56d59c3230c98757387544-39"><span class="crayon-h">			</span><span class="crayon-c"># extract a color histogram from the image, then update the</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230c98757387544-40"><span class="crayon-h">			</span><span class="crayon-c"># feature vector</span></p><p class="crayon-line" id="crayon-56d59c3230c98757387544-41"><span class="crayon-h">			</span><span class="crayon-v">hist</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">histogram</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">cornerMask</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230c98757387544-42"><span class="crayon-h">			</span><span class="crayon-v">features</span><span class="crayon-sy">.</span><span class="crayon-e">extend</span><span class="crayon-sy">(</span><span class="crayon-v">hist</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59c3230c98757387544-43"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230c98757387544-44"><span class="crayon-h">		</span><span class="crayon-c"># extract a color histogram from the elliptical region and</span></p><p class="crayon-line" id="crayon-56d59c3230c98757387544-45"><span class="crayon-h">		</span><span class="crayon-c"># update the feature vector</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230c98757387544-46"><span class="crayon-h">		</span><span class="crayon-v">hist</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">histogram</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ellipMask</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59c3230c98757387544-47"><span class="crayon-h">		</span><span class="crayon-v">features</span><span class="crayon-sy">.</span><span class="crayon-e">extend</span><span class="crayon-sy">(</span><span class="crayon-v">hist</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230c98757387544-48"> </p><p class="crayon-line" id="crayon-56d59c3230c98757387544-49"><span class="crayon-h">		</span><span class="crayon-c"># return the feature vector</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230c98757387544-50"><span class="crayon-h">		</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">features</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p><strong>Lines 22 and 23</strong> start by defining the indexes of our top-left, top-right, bottom-right, and bottom-left regions, respectively.</p>
<p>From there, we’ll need to construct an ellipse to represent the center region of the image. We’ll do this by defining an ellipse radius that is 75% of the width and height of the image on <strong>Line 27</strong>.</p>
<p>We then initialize a blank image (filled with zeros to represent a black background) with the same dimensions of the image we want to describe on <strong>Line 28</strong>.</p>
<p>Finally, let’s draw the actual ellipse on <strong>Line 29</strong> using the 
			<span id="crayon-56d59c3230c9e919874984" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">ellipse</span></span></span>  function. This function requires eight different parameters:</p>
<ol>
<li><strong>ellipMask:</strong> The image we want to draw the ellipse on. We’ll be using a concept of “masks” which I’ll discuss shortly.</li>
<li><strong>(cX, cY):</strong> A 2-tuple representing the center <em>(x, y)</em> coordinates of the image.</li>
<li><strong>(axesX, axesY):</strong> A 2-tuple representing the length of the axes of the ellipse. In this case, the ellipse will stretch to be 75% of the width and height of the 
			<span id="crayon-56d59c3230ca6081343250" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">image</span></span></span>  that we are describing.</li>
<li><strong>0:</strong> The rotation of the ellipse. In this case, no rotation is required so we supply a value of 0 degrees.</li>
<li><strong>0:</strong> The starting angle of the ellipse.</li>
<li><strong>360:</strong> The ending angle of the ellipse. Looking at the previous parameter, this indicates that we’ll be drawing an ellipse from 0 to 360 degrees (a full “circle”).</li>
<li><strong>255:</strong> The color of the ellipse. The value of 255 indicates “white”, meaning that our ellipse will be drawn white on a black background.</li>
<li><strong>-1:</strong> The border size of the ellipse. Supplying a positive integer <em>r</em> will draw a border of size <em>r</em> pixels. Supplying a negative value for <em>r</em> will make the ellipse “filled in”.</li>
</ol>
<p>We then allocate memory for each corner mask on <strong>Line 35</strong>, draw a white rectangle representing the corner of the image on <strong>Line 36</strong>, and then subtract the center ellipse from the rectangle on <strong>Line 37</strong>.</p>
<p>If we were to animate this process of looping over the corner segments it would look something like this:</p>
<div id="attachment_1574" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2014/11/mask_segments.gif"><img class="wp-image-1574" src="http://www.pyimagesearch.com/wp-content/uploads/2014/11/mask_segments.gif" alt="Figure 16: Constructing masks for each region of the image we want to extract features from."/></a><p class="wp-caption-text"><strong>Figure 16:</strong> Constructing masks for each region of the image we want to extract features from.</p></div>
<p>As this animation shows, we examining each of the corner segments individually, removing the center of the ellipse from the rectangle at each iteration.</p>
<p>So you may be wondering, <em>“Aren’t we supposed to be extracting color histograms from our image? Why are doing all this ‘masking’ business?”</em></p>
<p>Great question.</p>
<p>The reason is because we need the mask to instruct the OpenCV histogram function where to extract the color histogram from.</p>
<p>Remember, our goal is to describe each of these segments <em>individually</em>. The most efficient way of representing each of these segments is to use a <em>mask</em>. Only <em>(x, y)</em> coordinates in the image that has a corresponding <em>(x, y)</em> location in the mask with a white (255) pixel value will be included in the histogram calculation. If the pixel value for an <em>(x, y)</em> coordinate in the mask has a value of black (0), it will be ignored.</p>
<p>To reiterate this concept of only including pixels in the histogram with a corresponding mask value of white, take a look at the following animation:</p>
<div id="attachment_1575" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2014/11/applied_mask_segments.gif"><img class="wp-image-1575" src="http://www.pyimagesearch.com/wp-content/uploads/2014/11/applied_mask_segments.gif" alt="Figure 17: Applying the masked regions to the image. Notice how only the pixels in the left image are shown if they have a corresponding white mask value on the right."/></a><p class="wp-caption-text"><strong>Figure 17:</strong> Applying the masked regions to the image. Notice how only the pixels in the <em>left</em> image are shown if they have a corresponding white mask value in the image on the <em>right</em>.</p></div>
<p>As you can see, only pixels in the masked region of the image will be included in the histogram calculation.</p>
<p>Makes sense now, right?</p>
<p>So now for each of our segments we make a call to the 
			<span id="crayon-56d59c3230cac493858326" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">histogram</span></span></span>  method on <strong>Line 41</strong>, extract the color histogram by using the 
			<span id="crayon-56d59c3230cb4087795253" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">image</span></span></span>  we want to extract features from as the first argument and the 
			<span id="crayon-56d59c3230cb8846575707" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">mask</span></span></span>  representing the region we want to describe as the second argument.</p>
<p>The 
			<span id="crayon-56d59c3230cbb253612230" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">histogram</span></span></span>  method then returns a color histogram representing the current region, which we append to our 
			<span id="crayon-56d59c3230cbf667956663" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">features</span></span></span>  list.</p>
<p><strong>Lines 46 and 47</strong> extract a color histogram for the center (ellipse) region and updates the 
			<span id="crayon-56d59c3230cc2633399255" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">features</span></span></span>  list a well.</p>
<p>Finally, <strong>Line 50</strong> returns our feature vector to the calling function.</p>
<p>Now, let’s quickly look at our actual 
			<span id="crayon-56d59c3230cc6341514315" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">histogram</span></span></span>  method:</p>

		<div id="crayon-56d59c3230cc9618015996" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230cc9618015996-52"><span class="crayon-e">	</span><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">histogram</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">mask</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d59c3230cc9618015996-53"><span class="crayon-h">		</span><span class="crayon-c"># extract a 3D color histogram from the masked region of the</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230cc9618015996-54"><span class="crayon-h">		</span><span class="crayon-c"># image, using the supplied number of bins per channel; then</span></p><p class="crayon-line" id="crayon-56d59c3230cc9618015996-55"><span class="crayon-h">		</span><span class="crayon-c"># normalize the histogram</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230cc9618015996-56"><span class="crayon-h">		</span><span class="crayon-v">hist</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">calcHist</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">image</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">mask</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">bins</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-56d59c3230cc9618015996-57"><span class="crayon-h">			</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">180</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">256</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">256</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230cc9618015996-58"><span class="crayon-h">		</span><span class="crayon-v">hist</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">normalize</span><span class="crayon-sy">(</span><span class="crayon-v">hist</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">flatten</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59c3230cc9618015996-59"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230cc9618015996-60"><span class="crayon-h">		</span><span class="crayon-c"># return the histogram</span></p><p class="crayon-line" id="crayon-56d59c3230cc9618015996-61"><span class="crayon-h">		</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">hist</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>Our 
			<span id="crayon-56d59c3230ccf997395547" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">histogram</span></span></span>  method requires two arguments: the first is the 
			<span id="crayon-56d59c3230cd6490484447" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">image</span></span></span>  that we want to describe and the second is the 
			<span id="crayon-56d59c3230cda665360104" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">mask</span></span></span>  that represents the <strong><em>region</em></strong> of the image we want to describe.</p>
<p>Calculating the histogram of the masked region of the image is handled on <strong>Lines 56 and 57</strong> by making a call to 
			<span id="crayon-56d59c3230cde733140214" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-v">calcHist</span></span></span>  using the supplied number of 
			<span id="crayon-56d59c3230ce1355833462" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">bins</span></span></span>  from our constructor.</p>
<p>Our color histogram is normalized on <strong>Line 58</strong> to obtain scale invariance. This means that if we computed a color histogram for two identical images, except that one was 50% larger than the other, our color histograms would be (nearly) identical. It is <strong><em>very important</em></strong> that you normalize your color histograms so each histogram is represented by the relative <strong>percentage</strong> counts for a particular bin and not the <strong>integer</strong> counts for each bin. Again, performing this normalization will ensure that images with similar content but dramatically different dimensions will still be “similar” once we apply our similarity function.</p>
<p>Finally, the normalized, 3D HSV color histogram is returned to the calling function on <strong>Line 61</strong>.</p>
<h1>Step 2: Extracting Features from Our Dataset</h1>
<p>Now that we have our image descriptor defined, we can move on to Step 2, and extract  features (i.e. color histograms) from each image in our dataset. The process of extracting features and storing them on persistent storage is commonly called “indexing”.</p>
<p>Let’s go ahead and dive into some code to index our vacation photo dataset. Open up a new file, name it 
			<span id="crayon-56d59c3230ce5462747636" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">index</span><span class="crayon-sy">.</span><span class="crayon-v">py</span></span></span>  and let’s get indexing:</p>

		<div id="crayon-56d59c3230ce9080955709" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d59c3230ce9080955709-1"><span class="crayon-c"># import the necessary packages</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230ce9080955709-2"><span class="crayon-st">from</span><span class="crayon-h"> </span><span class="crayon-v">pyimagesearch</span><span class="crayon-sy">.</span><span class="crayon-e">colordescriptor </span><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">ColorDescriptor</span></p><p class="crayon-line" id="crayon-56d59c3230ce9080955709-3"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-k ">argparse</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230ce9080955709-4"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-k ">glob</span></p><p class="crayon-line" id="crayon-56d59c3230ce9080955709-5"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230ce9080955709-6"> </p><p class="crayon-line" id="crayon-56d59c3230ce9080955709-7"><span class="crayon-c"># construct the argument parser and parse the arguments</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230ce9080955709-8"><span class="crayon-v">ap</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">argparse</span><span class="crayon-sy">.</span><span class="crayon-e">ArgumentParser</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59c3230ce9080955709-9"><span class="crayon-v">ap</span><span class="crayon-sy">.</span><span class="crayon-e">add_argument</span><span class="crayon-sy">(</span><span class="crayon-s">"-d"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"--dataset"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">required</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">True</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230ce9080955709-10"><span class="crayon-h">	</span><span class="crayon-k ">help</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"Path to the directory that contains the images to be indexed"</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59c3230ce9080955709-11"><span class="crayon-v">ap</span><span class="crayon-sy">.</span><span class="crayon-e">add_argument</span><span class="crayon-sy">(</span><span class="crayon-s">"-i"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"--index"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">required</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">True</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230ce9080955709-12"><span class="crayon-h">	</span><span class="crayon-k ">help</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"Path to where the computed index will be stored"</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59c3230ce9080955709-13"><span class="crayon-v">args</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">vars</span><span class="crayon-sy">(</span><span class="crayon-v">ap</span><span class="crayon-sy">.</span><span class="crayon-e">parse_args</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230ce9080955709-14"> </p><p class="crayon-line" id="crayon-56d59c3230ce9080955709-15"><span class="crayon-c"># initialize the color descriptor</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230ce9080955709-16"><span class="crayon-k ">cd</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">ColorDescriptor</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">8</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">12</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">3</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>We’ll start by importing the packages we’ll need. You’ll remember the 
			<span id="crayon-56d59c3230ced755563527" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">ColorDescriptor</span></span></span>  class from Step 1 — I decided to place it in the 
			<span id="crayon-56d59c3230cf4529298965" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">pyimagesearch</span></span></span>  module for organizational purposes.</p>
<p>We’ll also need 
			<span id="crayon-56d59c3230cf8321735323" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">argparse</span></span></span>  for parsing command line arguments, 
			<span id="crayon-56d59c3230cfc936406318" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">glob</span></span></span>  from grabbing the file paths to our images, and 
			<span id="crayon-56d59c3230cff701534499" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">cv2</span></span></span>  for OpenCV bindings.</p>
<p>Parsing our command line arguments is handled on <strong>Lines 7-13</strong>. We’ll need two switches, 
			<span id="crayon-56d59c3230d02497112998" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-o">--</span><span class="crayon-v">dataset</span></span></span> , which is the path to our vacation photos directory, and 
			<span id="crayon-56d59c3230d06145630133" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-o">--</span><span class="crayon-v">index</span></span></span>  which is the output CSV file containing the image filename and the features associated with each image.</p>
<p>Finally, we initialize our 
			<span id="crayon-56d59c3230d0a656608376" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">ColorDescriptor</span></span></span>  on <strong>Line 16</strong> using 8 Hue bins, 12 Saturation bins, and 3 Value bins.</p>
<p>Now that everything is initialized, we can extract features from our dataset:</p>

		<div id="crayon-56d59c3230d0d286881286" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230d0d286881286-18">18</p><p class="crayon-num" data-line="crayon-56d59c3230d0d286881286-19">19</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230d0d286881286-20">20</p><p class="crayon-num" data-line="crayon-56d59c3230d0d286881286-21">21</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230d0d286881286-22">22</p><p class="crayon-num" data-line="crayon-56d59c3230d0d286881286-23">23</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230d0d286881286-24">24</p><p class="crayon-num" data-line="crayon-56d59c3230d0d286881286-25">25</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230d0d286881286-26">26</p><p class="crayon-num" data-line="crayon-56d59c3230d0d286881286-27">27</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230d0d286881286-28">28</p><p class="crayon-num" data-line="crayon-56d59c3230d0d286881286-29">29</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230d0d286881286-30">30</p><p class="crayon-num" data-line="crayon-56d59c3230d0d286881286-31">31</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230d0d286881286-32">32</p><p class="crayon-num" data-line="crayon-56d59c3230d0d286881286-33">33</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230d0d286881286-34">34</p><p class="crayon-num" data-line="crayon-56d59c3230d0d286881286-35">35</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230d0d286881286-36">36</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d0d286881286-18"><span class="crayon-c"># open the output index file for writing</span></p><p class="crayon-line" id="crayon-56d59c3230d0d286881286-19"><span class="crayon-v">output</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">open</span><span class="crayon-sy">(</span><span class="crayon-v">args</span><span class="crayon-sy">[</span><span class="crayon-s">"index"</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"w"</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d0d286881286-20"> </p><p class="crayon-line" id="crayon-56d59c3230d0d286881286-21"><span class="crayon-c"># use glob to grab the image paths and loop over them</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d0d286881286-22"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">imagePath </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-k ">glob</span><span class="crayon-sy">.</span><span class="crayon-k ">glob</span><span class="crayon-sy">(</span><span class="crayon-v">args</span><span class="crayon-sy">[</span><span class="crayon-s">"dataset"</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">"/*.png"</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d59c3230d0d286881286-23"><span class="crayon-h">	</span><span class="crayon-c"># extract the image ID (i.e. the unique filename) from the image</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d0d286881286-24"><span class="crayon-h">	</span><span class="crayon-c"># path and load the image itself</span></p><p class="crayon-line" id="crayon-56d59c3230d0d286881286-25"><span class="crayon-h">	</span><span class="crayon-v">imageID</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">imagePath</span><span class="crayon-sy">[</span><span class="crayon-v">imagePath</span><span class="crayon-sy">.</span><span class="crayon-e">rfind</span><span class="crayon-sy">(</span><span class="crayon-s">"/"</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d0d286881286-26"><span class="crayon-h">	</span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">imread</span><span class="crayon-sy">(</span><span class="crayon-v">imagePath</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59c3230d0d286881286-27"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d0d286881286-28"><span class="crayon-h">	</span><span class="crayon-c"># describe the image</span></p><p class="crayon-line" id="crayon-56d59c3230d0d286881286-29"><span class="crayon-h">	</span><span class="crayon-v">features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">cd</span><span class="crayon-sy">.</span><span class="crayon-e">describe</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d0d286881286-30"> </p><p class="crayon-line" id="crayon-56d59c3230d0d286881286-31"><span class="crayon-h">	</span><span class="crayon-c"># write the features to file</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d0d286881286-32"><span class="crayon-h">	</span><span class="crayon-v">features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-k ">str</span><span class="crayon-sy">(</span><span class="crayon-v">f</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">f</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">features</span><span class="crayon-sy">]</span></p><p class="crayon-line" id="crayon-56d59c3230d0d286881286-33"><span class="crayon-h">	</span><span class="crayon-v">output</span><span class="crayon-sy">.</span><span class="crayon-e">write</span><span class="crayon-sy">(</span><span class="crayon-s">"%s,%s\n"</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">imageID</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">","</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d0d286881286-34"> </p><p class="crayon-line" id="crayon-56d59c3230d0d286881286-35"><span class="crayon-c"># close the index file</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d0d286881286-36"><span class="crayon-v">output</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>Let’s open our output file for writing on <strong>Line 19</strong>, then loop over all the images in our dataset on <strong>Line 22</strong>.</p>
<p>For each of the images we’ll extract an 
			<span id="crayon-56d59c3230d12576283087" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">imageID</span></span></span> , which is simply the filename of the image. For this example search engine, we’ll assume that all filenames are unique, but we could just as easily generate a UUID for each image. We’ll then load the image off disk on <strong>Line 26</strong>.</p>
<p>Now that the image is loaded, let’s go ahead and apply our image descriptor and extract features from the image on <strong>Line 29</strong>. The 
			<span id="crayon-56d59c3230d15316265547" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">describe</span></span></span>  method of our 
			<span id="crayon-56d59c3230d19268699089" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">ColorDescriptor</span></span></span>  returns a list of floating point values used to represent and quantify our image.</p>
<p>This list of numbers, or <em>feature vector</em> contains representations for each of the 5 image regions we described in Step 1. Each section is represented by a histogram with <em>8 x 12 x 3 = 288</em> entries. Given 5 entries, our overall feature vector is <em>5 x 288 = 1440</em> dimensionality. Thus each image is quantified and represented using 1,440 numbers.</p>
<p><strong>Lines 32 and 33</strong> simply write the filename of the image and its associated feature vector to file.</p>
<p>To index our vacation photo dataset, open up a shell and issue the following command:</p>

		<div id="crayon-56d59c3230d1d729664808" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d59c3230d1d729664808-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">python </span><span class="crayon-v">index</span><span class="crayon-e">.py</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">dataset </span><span class="crayon-v">dataset</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">index </span><span class="crayon-v">index</span><span class="crayon-e">.csv</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>This script shouldn’t take longer than a few seconds to run. After it is finished you will have a new file, 
			<span id="crayon-56d59c3230d25366532438" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">index</span><span class="crayon-sy">.</span><span class="crayon-v">csv</span></span></span> .</p>
<p>Open this file using your favorite text editor and take a look inside.</p>
<p>You’ll see that for each row in the .csv file, the first entry is the filename, followed by a list of numbers. These numbers are your feature vectors and are used to represent and quantify the image.</p>
<p>Running a 
			<span id="crayon-56d59c3230d29454256474" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">wc</span></span></span>  on the index, we can see that we have successfully indexed our dataset of 805 images:</p>

		<div id="crayon-56d59c3230d2c946989026" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d59c3230d2c946989026-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-r">wc</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">l</span><span class="crayon-h"> </span><span class="crayon-v">index</span><span class="crayon-e">.csv</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d2c946989026-2"><span class="crayon-h">     </span><span class="crayon-cn">805</span><span class="crayon-h"> </span><span class="crayon-v">index</span><span class="crayon-e">.csv</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p/>
<h1> Step 3: The Searcher</h1>
<p>Now that we’ve extracted features from our dataset, we need a method to <em>compare</em> these features for similarity. That’s where Step 3 comes in — we are now ready to create a class that will define the actual similarity metric between two images.</p>
<p>Create a new file, name it 
			<span id="crayon-56d59c3230d30621842340" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">searcher</span><span class="crayon-sy">.</span><span class="crayon-v">py</span></span></span>  and let’s make some magic happen:</p>

		<div id="crayon-56d59c3230d33297398258" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d59c3230d33297398258-1"><span class="crayon-c"># import the necessary packages</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d33297398258-2"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">numpy </span><span class="crayon-st">as</span><span class="crayon-h"> </span><span class="crayon-e">np</span></p><p class="crayon-line" id="crayon-56d59c3230d33297398258-3"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-k ">csv</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d33297398258-4"> </p><p class="crayon-line" id="crayon-56d59c3230d33297398258-5"><span class="crayon-t">class</span><span class="crayon-h"> </span><span class="crayon-v">Searcher</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d33297398258-6"><span class="crayon-h">	</span><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">__init__</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">indexPath</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d59c3230d33297398258-7"><span class="crayon-h">		</span><span class="crayon-c"># store our index path</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d33297398258-8"><span class="crayon-h">		</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">indexPath</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">indexPath</span></p><p class="crayon-line" id="crayon-56d59c3230d33297398258-9"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d33297398258-10"><span class="crayon-e">	</span><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">search</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">queryFeatures</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">limit</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d59c3230d33297398258-11"><span class="crayon-h">		</span><span class="crayon-c"># initialize our dictionary of results</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d33297398258-12"><span class="crayon-h">		</span><span class="crayon-v">results</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-sy">}</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>We’ll go ahead and import NumPy for numerical processing and 
			<span id="crayon-56d59c3230d37740084162" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">csv</span></span></span>  for convenience to make parsing our 
			<span id="crayon-56d59c3230d3b941564845" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">index</span><span class="crayon-sy">.</span><span class="crayon-v">csv</span></span></span>  file easier.</p>
<p>From there let’s define our 
			<span id="crayon-56d59c3230d3e562717512" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">Searcher</span></span></span>  class on <strong>Line 5</strong>. The constructor for our 
			<span id="crayon-56d59c3230d42287067362" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">Searcher</span></span></span>  will only require a single argument, 
			<span id="crayon-56d59c3230d45672354046" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">indexPath</span></span></span>  which is the path to where our 
			<span id="crayon-56d59c3230d48544233195" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">index</span><span class="crayon-sy">.</span><span class="crayon-v">csv</span></span></span>  file resides on disk.</p>
<p>To actually perform a search, we’ll be making a call to the 
			<span id="crayon-56d59c3230d4c660604859" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">search</span></span></span>  method on <strong>Line 10</strong>. This method will take two parameters, the 
			<span id="crayon-56d59c3230d4f084803254" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">queryFeatures</span></span></span>  extracted from the query image (i.e. the image we’ll be submitting to our CBIR system and asking for similar images to), and 
			<span id="crayon-56d59c3230d53244259028" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">limit</span></span></span>  which is the maximum number of results to return.</p>
<p>Finally, we initialize our 
			<span id="crayon-56d59c3230d56085469121" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">results</span></span></span>  dictionary on <strong>Line 12</strong>. A dictionary is a good data-type in this situation as it will allow us to use the (unique) 
			<span id="crayon-56d59c3230d5e318438934" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">imageID</span></span></span>  for a given image as the key and the similarity to the query as the value.</p>
<p>Okay, so pay attention here. This is where the magic happens:</p>

		<div id="crayon-56d59c3230d62805470782" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230d62805470782-14">14</p><p class="crayon-num" data-line="crayon-56d59c3230d62805470782-15">15</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230d62805470782-16">16</p><p class="crayon-num" data-line="crayon-56d59c3230d62805470782-17">17</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230d62805470782-18">18</p><p class="crayon-num" data-line="crayon-56d59c3230d62805470782-19">19</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230d62805470782-20">20</p><p class="crayon-num" data-line="crayon-56d59c3230d62805470782-21">21</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230d62805470782-22">22</p><p class="crayon-num" data-line="crayon-56d59c3230d62805470782-23">23</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230d62805470782-24">24</p><p class="crayon-num" data-line="crayon-56d59c3230d62805470782-25">25</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230d62805470782-26">26</p><p class="crayon-num" data-line="crayon-56d59c3230d62805470782-27">27</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230d62805470782-28">28</p><p class="crayon-num" data-line="crayon-56d59c3230d62805470782-29">29</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230d62805470782-30">30</p><p class="crayon-num" data-line="crayon-56d59c3230d62805470782-31">31</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230d62805470782-32">32</p><p class="crayon-num" data-line="crayon-56d59c3230d62805470782-33">33</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230d62805470782-34">34</p><p class="crayon-num" data-line="crayon-56d59c3230d62805470782-35">35</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230d62805470782-36">36</p><p class="crayon-num" data-line="crayon-56d59c3230d62805470782-37">37</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230d62805470782-38">38</p><p class="crayon-num" data-line="crayon-56d59c3230d62805470782-39">39</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230d62805470782-40">40</p><p class="crayon-num" data-line="crayon-56d59c3230d62805470782-41">41</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230d62805470782-42">42</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d62805470782-14"><span class="crayon-h">		</span><span class="crayon-c"># open the index file for reading</span></p><p class="crayon-line" id="crayon-56d59c3230d62805470782-15"><span class="crayon-h">		</span><span class="crayon-st">with</span><span class="crayon-h"> </span><span class="crayon-k ">open</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">indexPath</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">as</span><span class="crayon-h"> </span><span class="crayon-v">f</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d62805470782-16"><span class="crayon-h">			</span><span class="crayon-c"># initialize the CSV reader</span></p><p class="crayon-line" id="crayon-56d59c3230d62805470782-17"><span class="crayon-h">			</span><span class="crayon-v">reader</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">csv</span><span class="crayon-sy">.</span><span class="crayon-e">reader</span><span class="crayon-sy">(</span><span class="crayon-v">f</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d62805470782-18"> </p><p class="crayon-line" id="crayon-56d59c3230d62805470782-19"><span class="crayon-h">			</span><span class="crayon-c"># loop over the rows in the index</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d62805470782-20"><span class="crayon-h">			</span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">row </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">reader</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d59c3230d62805470782-21"><span class="crayon-h">				</span><span class="crayon-c"># parse out the image ID and features, then compute the</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d62805470782-22"><span class="crayon-h">				</span><span class="crayon-c"># chi-squared distance between the features in our index</span></p><p class="crayon-line" id="crayon-56d59c3230d62805470782-23"><span class="crayon-h">				</span><span class="crayon-c"># and our query features</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d62805470782-24"><span class="crayon-h">				</span><span class="crayon-v">features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-k ">float</span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">x</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">row</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span></p><p class="crayon-line" id="crayon-56d59c3230d62805470782-25"><span class="crayon-h">				</span><span class="crayon-v">d</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">chi2_distance</span><span class="crayon-sy">(</span><span class="crayon-v">features</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">queryFeatures</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d62805470782-26"> </p><p class="crayon-line" id="crayon-56d59c3230d62805470782-27"><span class="crayon-h">				</span><span class="crayon-c"># now that we have the distance between the two feature</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d62805470782-28"><span class="crayon-h">				</span><span class="crayon-c"># vectors, we can udpate the results dictionary -- the</span></p><p class="crayon-line" id="crayon-56d59c3230d62805470782-29"><span class="crayon-h">				</span><span class="crayon-c"># key is the current image ID in the index and the</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d62805470782-30"><span class="crayon-h">				</span><span class="crayon-c"># value is the distance we just computed, representing</span></p><p class="crayon-line" id="crayon-56d59c3230d62805470782-31"><span class="crayon-h">				</span><span class="crayon-c"># how 'similar' the image in the index is to our query</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d62805470782-32"><span class="crayon-h">				</span><span class="crayon-v">results</span><span class="crayon-sy">[</span><span class="crayon-v">row</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">d</span></p><p class="crayon-line" id="crayon-56d59c3230d62805470782-33"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d62805470782-34"><span class="crayon-h">			</span><span class="crayon-c"># close the reader</span></p><p class="crayon-line" id="crayon-56d59c3230d62805470782-35"><span class="crayon-h">			</span><span class="crayon-v">f</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d62805470782-36"> </p><p class="crayon-line" id="crayon-56d59c3230d62805470782-37"><span class="crayon-h">		</span><span class="crayon-c"># sort our results, so that the smaller distances (i.e. the</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d62805470782-38"><span class="crayon-h">		</span><span class="crayon-c"># more relevant images are at the front of the list)</span></p><p class="crayon-line" id="crayon-56d59c3230d62805470782-39"><span class="crayon-h">		</span><span class="crayon-v">results</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">sorted</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-sy">(</span><span class="crayon-v">v</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">k</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">k</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">v</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">results</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d62805470782-40"> </p><p class="crayon-line" id="crayon-56d59c3230d62805470782-41"><span class="crayon-h">		</span><span class="crayon-c"># return our (limited) results</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d62805470782-42"><span class="crayon-h">		</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">results</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-v">limit</span><span class="crayon-sy">]</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>We open up our 
			<span id="crayon-56d59c3230d67430047664" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">index</span><span class="crayon-sy">.</span><span class="crayon-v">csv</span></span></span>  file on <strong>Line 15</strong>, grab a handle to our CSV reader on <strong>Line 17</strong>, and then start looping over each row of the 
			<span id="crayon-56d59c3230d6a430323206" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">index</span><span class="crayon-sy">.</span><span class="crayon-v">csv</span></span></span>  file on <strong>Line 20</strong>.</p>
<p>For each row, we extract the color histograms associated with the indexed image and then compare it to the query image features using the 
			<span id="crayon-56d59c3230d6e481874248" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">chi2_distance</span></span></span>  (<strong>Line 25</strong>), which I’ll define in a second.</p>
<p>Our 
			<span id="crayon-56d59c3230d71727151107" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">results</span></span></span>  dictionary is updated on <strong>Line 32</strong> using the unique image filename as the key and the similarity of the query image to the indexed image as the value.</p>
<p>Lastly, all we have to do is sort the results dictionary according to the similarity value in ascending order.</p>
<p>Images that have a chi-squared similarity of 0 will be deemed to be <strong><em>identical</em></strong> to each other. As the chi-squared similarity value increases, the images are considered to be <strong><em>less similar</em></strong> to each other.</p>
<p>Speaking of chi-squared similarity, let’s go ahead and define that function:</p>

		<div id="crayon-56d59c3230d75445186840" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d75445186840-44"><span class="crayon-h">	</span><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">chi2_distance</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">histA</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">histB</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">eps</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">1e</span><span class="crayon-o">-</span><span class="crayon-cn">10</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d59c3230d75445186840-45"><span class="crayon-h">		</span><span class="crayon-c"># compute the chi-squared distance</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d75445186840-46"><span class="crayon-h">		</span><span class="crayon-v">d</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0.5</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">np</span><span class="crayon-sy">.</span><span class="crayon-k ">sum</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">a</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">b</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">a</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">b</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">eps</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59c3230d75445186840-47"><span class="crayon-h">			</span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">a</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">b</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-k ">zip</span><span class="crayon-sy">(</span><span class="crayon-v">histA</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">histB</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d75445186840-48"> </p><p class="crayon-line" id="crayon-56d59c3230d75445186840-49"><span class="crayon-h">		</span><span class="crayon-c"># return the chi-squared distance</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d75445186840-50"><span class="crayon-h">		</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">d</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>Our 
			<span id="crayon-56d59c3230d7a072836875" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">chi2_distance</span></span></span>  function requires two arguments, which are the two histograms we want to compare for similarity. An optional 
			<span id="crayon-56d59c3230d82932251173" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">eps</span></span></span>  value is used to prevent division-by-zero errors.</p>
<p>The function gets its name from the Pearson’s chi-squared test statistic which is used to compare discrete probability distributions.</p>
<p>Since we are comparing color histograms, which are by definition probability distributions, the chi-squared function is an excellent choice.</p>
<p>In general, the difference between large bins vs. small bins is less important and should be weighted as such — and this is exactly what the chi-squared distance function does.</p>
<p>Are you still with us? We’re getting there, I promise. The last step is actually the easiest and is simply a driver that glues all the pieces together.</p>
<h1>Step 4: Performing a Search</h1>
<p>Would you believe it if I told you that performing the actual search is the easiest part? In reality, it’s just a driver that imports all of the packages that we have defined earlier and uses them in conjunction with each other to build a full-fledged Content-Based Image Retrieval System.</p>
<p>So open up <em>one last file</em>, name it 
			<span id="crayon-56d59c3230d86882236199" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">search</span><span class="crayon-sy">.</span><span class="crayon-v">py</span></span></span> , and we’ll bring this example home:</p>

		<div id="crayon-56d59c3230d8a730298597" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-56d59c3230d8a730298597-1">1</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230d8a730298597-2">2</p><p class="crayon-num" data-line="crayon-56d59c3230d8a730298597-3">3</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230d8a730298597-4">4</p><p class="crayon-num" data-line="crayon-56d59c3230d8a730298597-5">5</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230d8a730298597-6">6</p><p class="crayon-num" data-line="crayon-56d59c3230d8a730298597-7">7</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230d8a730298597-8">8</p><p class="crayon-num" data-line="crayon-56d59c3230d8a730298597-9">9</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230d8a730298597-10">10</p><p class="crayon-num" data-line="crayon-56d59c3230d8a730298597-11">11</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230d8a730298597-12">12</p><p class="crayon-num" data-line="crayon-56d59c3230d8a730298597-13">13</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230d8a730298597-14">14</p><p class="crayon-num" data-line="crayon-56d59c3230d8a730298597-15">15</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230d8a730298597-16">16</p><p class="crayon-num" data-line="crayon-56d59c3230d8a730298597-17">17</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230d8a730298597-18">18</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d59c3230d8a730298597-1"><span class="crayon-c"># import the necessary packages</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d8a730298597-2"><span class="crayon-st">from</span><span class="crayon-h"> </span><span class="crayon-v">pyimagesearch</span><span class="crayon-sy">.</span><span class="crayon-e">colordescriptor </span><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">ColorDescriptor</span></p><p class="crayon-line" id="crayon-56d59c3230d8a730298597-3"><span class="crayon-st">from</span><span class="crayon-h"> </span><span class="crayon-v">pyimagesearch</span><span class="crayon-sy">.</span><span class="crayon-e">searcher </span><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">Searcher</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d8a730298597-4"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-k ">argparse</span></p><p class="crayon-line" id="crayon-56d59c3230d8a730298597-5"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d8a730298597-6"> </p><p class="crayon-line" id="crayon-56d59c3230d8a730298597-7"><span class="crayon-c"># construct the argument parser and parse the arguments</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d8a730298597-8"><span class="crayon-v">ap</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">argparse</span><span class="crayon-sy">.</span><span class="crayon-e">ArgumentParser</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59c3230d8a730298597-9"><span class="crayon-v">ap</span><span class="crayon-sy">.</span><span class="crayon-e">add_argument</span><span class="crayon-sy">(</span><span class="crayon-s">"-i"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"--index"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">required</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">True</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d8a730298597-10"><span class="crayon-h">	</span><span class="crayon-k ">help</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"Path to where the computed index will be stored"</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59c3230d8a730298597-11"><span class="crayon-v">ap</span><span class="crayon-sy">.</span><span class="crayon-e">add_argument</span><span class="crayon-sy">(</span><span class="crayon-s">"-q"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"--query"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">required</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">True</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d8a730298597-12"><span class="crayon-h">	</span><span class="crayon-k ">help</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"Path to the query image"</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59c3230d8a730298597-13"><span class="crayon-v">ap</span><span class="crayon-sy">.</span><span class="crayon-e">add_argument</span><span class="crayon-sy">(</span><span class="crayon-s">"-r"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"--result-path"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">required</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">True</span><span class="crayon-sy">,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d8a730298597-14"><span class="crayon-h">	</span><span class="crayon-k ">help</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"Path to the result path"</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59c3230d8a730298597-15"><span class="crayon-v">args</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">vars</span><span class="crayon-sy">(</span><span class="crayon-v">ap</span><span class="crayon-sy">.</span><span class="crayon-e">parse_args</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d8a730298597-16"> </p><p class="crayon-line" id="crayon-56d59c3230d8a730298597-17"><span class="crayon-c"># initialize the image descriptor</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230d8a730298597-18"><span class="crayon-k ">cd</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">ColorDescriptor</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">8</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">12</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">3</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>The first thing we’ll do is import our necessary packages. We’ll import our 
			<span id="crayon-56d59c3230d8e551288583" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">ColorDescriptor</span></span></span>  from Step 1 so that we can extract features from the query image. And we’ll also import our 
			<span id="crayon-56d59c3230d91407817077" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">Searcher</span></span></span>  that we defined in Step 3 so that we can perform the actual search.</p>
<p>The 
			<span id="crayon-56d59c3230d95048048483" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">argparse</span></span></span>  and 
			<span id="crayon-56d59c3230d98721534291" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">cv2</span></span></span>  packages round out our imports.</p>
<p>We then parse command line arguments on <strong>Lines 8-15</strong>. We’ll need an 
			<span id="crayon-56d59c3230d9c338849097" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-o">--</span><span class="crayon-v">index</span></span></span> , which is the path to where our 
			<span id="crayon-56d59c3230d9f543846699" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">index</span><span class="crayon-sy">.</span><span class="crayon-v">csv</span></span></span>  file resides.</p>
<p>We’ll also need a 
			<span id="crayon-56d59c3230da7870546208" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-o">--</span><span class="crayon-v">query</span></span></span> , which is the path to our query image. This image will be compared to each image in our index. The goal will be to find images in the index that are similar to our query image.</p>
<p>Think of it this way — when you go to Google and type in the term “Python OpenCV tutorials”, you would expect to find search results that contain information relevant to learning Python and OpenCV.</p>
<p>Similarly, if we are building an image search engine for our vacation photos and we submit an image of a sailboat on a blue ocean and white puffy clouds, we would expect to get similar ocean view images back from our image search engine.</p>
<p>We’ll then ask for a 
			<span id="crayon-56d59c3230dab926892649" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-o">--</span><span class="crayon-v">result</span><span class="crayon-o">-</span><span class="crayon-v">path</span></span></span> , which is the path to our vacation photos dataset. We require this switch because we’ll need to display the actual result images to the user.</p>
<p>Finally, we initialize our image descriptor on <strong>Line 18</strong> using the exact same parameters as we did in the indexing step. If our intention is to compare images for similarity (which it is), it wouldn’t make sense to change the number of bins in our color histograms from indexing to search.</p>
<p>Simply put: <strong><em>use the exact same number of bins for your color histogram during Step 4 as you did in Step 3.</em></strong></p>
<p>This will ensure that your images are described in a consistent manner and are thus comparable.</p>
<p>Okay, time to perform the actual search:</p>

		<div id="crayon-56d59c3230daf299108739" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230daf299108739-20">20</p><p class="crayon-num" data-line="crayon-56d59c3230daf299108739-21">21</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230daf299108739-22">22</p><p class="crayon-num" data-line="crayon-56d59c3230daf299108739-23">23</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230daf299108739-24">24</p><p class="crayon-num" data-line="crayon-56d59c3230daf299108739-25">25</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230daf299108739-26">26</p><p class="crayon-num" data-line="crayon-56d59c3230daf299108739-27">27</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230daf299108739-28">28</p><p class="crayon-num" data-line="crayon-56d59c3230daf299108739-29">29</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230daf299108739-30">30</p><p class="crayon-num" data-line="crayon-56d59c3230daf299108739-31">31</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230daf299108739-32">32</p><p class="crayon-num" data-line="crayon-56d59c3230daf299108739-33">33</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230daf299108739-34">34</p><p class="crayon-num" data-line="crayon-56d59c3230daf299108739-35">35</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d59c3230daf299108739-36">36</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230daf299108739-20"><span class="crayon-c"># load the query image and describe it</span></p><p class="crayon-line" id="crayon-56d59c3230daf299108739-21"><span class="crayon-v">query</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">imread</span><span class="crayon-sy">(</span><span class="crayon-v">args</span><span class="crayon-sy">[</span><span class="crayon-s">"query"</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230daf299108739-22"><span class="crayon-v">features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">cd</span><span class="crayon-sy">.</span><span class="crayon-e">describe</span><span class="crayon-sy">(</span><span class="crayon-v">query</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59c3230daf299108739-23"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230daf299108739-24"><span class="crayon-c"># perform the search</span></p><p class="crayon-line" id="crayon-56d59c3230daf299108739-25"><span class="crayon-v">searcher</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Searcher</span><span class="crayon-sy">(</span><span class="crayon-v">args</span><span class="crayon-sy">[</span><span class="crayon-s">"index"</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230daf299108739-26"><span class="crayon-v">results</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">searcher</span><span class="crayon-sy">.</span><span class="crayon-e">search</span><span class="crayon-sy">(</span><span class="crayon-v">features</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59c3230daf299108739-27"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230daf299108739-28"><span class="crayon-c"># display the query</span></p><p class="crayon-line" id="crayon-56d59c3230daf299108739-29"><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">imshow</span><span class="crayon-sy">(</span><span class="crayon-s">"Query"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">query</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230daf299108739-30"> </p><p class="crayon-line" id="crayon-56d59c3230daf299108739-31"><span class="crayon-c"># loop over the results</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230daf299108739-32"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">resultID</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">results</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d59c3230daf299108739-33"><span class="crayon-h">	</span><span class="crayon-c"># load the result image and display it</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230daf299108739-34"><span class="crayon-h">	</span><span class="crayon-v">result</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">imread</span><span class="crayon-sy">(</span><span class="crayon-v">args</span><span class="crayon-sy">[</span><span class="crayon-s">"result_path"</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">"/"</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">resultID</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d59c3230daf299108739-35"><span class="crayon-h">	</span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">imshow</span><span class="crayon-sy">(</span><span class="crayon-s">"Result"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">result</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d59c3230daf299108739-36"><span class="crayon-h">	</span><span class="crayon-v">cv2</span><span class="crayon-sy">.</span><span class="crayon-e">waitKey</span><span class="crayon-sy">(</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>We load our query image off disk on <strong>Line 21</strong> and extract features from it on <strong>Line 22</strong>.</p>
<p>The search is then performed on <strong>Lines 25 and 26</strong> using the features extracted from the query image, returning our list of ranked 
			<span id="crayon-56d59c3230db3738358854" class="crayon-syntax crayon-syntax-inline  crayon-theme-classic crayon-theme-classic-inline crayon-font-monaco"><span class="crayon-pre crayon-code"><span class="crayon-v">results</span></span></span> .</p>
<p>From here, all we need to do is display the results to the user.</p>
<p>We display the query image to the user on <strong>Line 29</strong>. And then we loop over our search results results on <strong>Lines 32-36</strong> and display them to the screen.</p>
<p>After all this work I’m sure you’re ready to see this system in action, aren’t you?</p>
<p>Well keep reading — this is where all our hard work pays off.</p>
<h1>Our CBIR System in Action</h1>
<p>Open up your terminal, navigate to the directory where your code lives, and issue the following command:</p>

		<div id="crayon-56d59c3230db7893161695" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d59c3230db7893161695-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">python </span><span class="crayon-v">search</span><span class="crayon-e">.py</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">index </span><span class="crayon-v">index</span><span class="crayon-e">.csv</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">query </span><span class="crayon-v">queries</span><span class="crayon-o">/</span><span class="crayon-cn">108100.png</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">result</span><span class="crayon-o">-</span><span class="crayon-e">path </span><span class="crayon-v">dataset</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p/><div id="attachment_1584" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2014/11/results_pyramids.jpg"><img class="wp-image-1584" src="http://www.pyimagesearch.com/wp-content/uploads/2014/11/results_pyramids.jpg" alt="Figure 18: Search our vacation image dataset for pictures of the pyramids and Egypt." srcset="http://www.pyimagesearch.com/wp-content/uploads/2014/11/results_pyramids-125x300.jpg 125w, http://www.pyimagesearch.com/wp-content/uploads/2014/11/results_pyramids.jpg 800w" sizes="(max-width: 600px) 100vw, 600px"/></a><p class="wp-caption-text"><strong>Figure 18:</strong> Search our vacation image dataset for pictures of the pyramids and Egypt.</p></div>
<p>The first image you’ll see is our query image of the Egyptian pyramids. Our goal is to find similar images in our dataset. As you can see, we have clearly found the other photos of the dataset from when we visited the pyramids.</p>
<p>We also spent some time visiting other areas of Egypt. Let’s try another query image:</p>

		<div id="crayon-56d59c3230dbb331375580" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d59c3230dbb331375580-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">python </span><span class="crayon-v">search</span><span class="crayon-e">.py</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">index </span><span class="crayon-v">index</span><span class="crayon-e">.csv</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">query </span><span class="crayon-v">queries</span><span class="crayon-o">/</span><span class="crayon-cn">115100.png</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">result</span><span class="crayon-o">-</span><span class="crayon-e">path </span><span class="crayon-v">dataset</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p/><div id="attachment_1585" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2014/11/results_egypt.jpg"><img class="wp-image-1585" src="http://www.pyimagesearch.com/wp-content/uploads/2014/11/results_egypt.jpg" alt="Figure 18: The results of our image search engine for other areas of Egypt. Notice how the blue sky consistently appears in the search results."/></a><p class="wp-caption-text"><strong>Figure 19:</strong> The results of our image search engine for other areas of Egypt. Notice how the blue sky consistently appears in the search results.</p></div>
<p>Be sure to pay close attention to our query image image. Notice how the sky is a brilliant shade of blue in the upper regions of the image. And notice how we have brown and tan desert and buildings at the bottom and center of the image.</p>
<p>And sure enough, in our results the images returned to us have blue sky in the upper regions and tan/brown desert and structures at the bottom.</p>
<p>The reason for this is because of our region-based color histogram descriptor that we detailed earlier in this post. By utilizing this image descriptor we have been able to perform a crude form of localization, providing our color histogram with hints as to “where” the pixel intensities occurred in the image.</p>
<p>Next up on our vacation we stopped at the beach. Execute the following command to search for beach photos:</p>

		<div id="crayon-56d59c3230dc4069263140" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d59c3230dc4069263140-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">python </span><span class="crayon-v">search</span><span class="crayon-e">.py</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">index </span><span class="crayon-v">index</span><span class="crayon-e">.csv</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">query </span><span class="crayon-v">queries</span><span class="crayon-o">/</span><span class="crayon-cn">103300.png</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">result</span><span class="crayon-o">-</span><span class="crayon-e">path </span><span class="crayon-v">dataset</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p/><div id="attachment_1586" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2014/11/results_beach.jpg"><img class="wp-image-1586" src="http://www.pyimagesearch.com/wp-content/uploads/2014/11/results_beach.jpg" alt="Figure 20: Using our Content-Based Image Retrieval System built using OpenCV to find images of the beach in our dataset."/></a><p class="wp-caption-text"><strong>Figure 20:</strong> Using our Content-Based Image Retrieval System built using OpenCV to find images of the beach in our dataset.</p></div>
<p>Notice how the first three results are from the exact same location on the trip to the beach. And the rest of the result images contain shades of blue.</p>
<p>Of course, no trip to the beach is complete without scubadiving:</p>

		<div id="crayon-56d59c3230dc9551346723" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d59c3230dc9551346723-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">python </span><span class="crayon-v">search</span><span class="crayon-sy">.</span><span class="crayon-v">py</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">index </span><span class="crayon-v">index</span><span class="crayon-sy">.</span><span class="crayon-k ">csv</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">query </span><span class="crayon-v">queries</span><span class="crayon-o">/</span><span class="crayon-cn">103100.png</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">result</span><span class="crayon-o">-</span><span class="crayon-e">path </span><span class="crayon-v">dataset</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p/><div id="attachment_1587" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2014/11/results_underwater.jpg"><img class="wp-image-1587" src="http://www.pyimagesearch.com/wp-content/uploads/2014/11/results_underwater.jpg" alt="Figure 21: Once again, our image search engine is able to return relevant results. Thus time, of an underwater adventure." srcset="http://www.pyimagesearch.com/wp-content/uploads/2014/11/results_underwater-125x300.jpg 125w, http://www.pyimagesearch.com/wp-content/uploads/2014/11/results_underwater.jpg 800w" sizes="(max-width: 600px) 100vw, 600px"/></a><p class="wp-caption-text"><strong>Figure 21:</strong> Once again, our image search engine is able to return relevant results. Thus time, of an underwater adventure.</p></div>
<p>The results from this search are particularly impressive. The top 5 results are of the same fish — and all but one of the top 10 results are from the underwater excursion.</p>
<p>Finally, after a long day, it’s time to watch the sunset:</p>

		<div id="crayon-56d59c3230dcd519971458" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d59c3230dcd519971458-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">python </span><span class="crayon-v">search</span><span class="crayon-e">.py</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">index </span><span class="crayon-v">index</span><span class="crayon-e">.csv</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">query </span><span class="crayon-v">queries</span><span class="crayon-o">/</span><span class="crayon-cn">127502.png</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">result</span><span class="crayon-o">-</span><span class="crayon-e">path </span><span class="crayon-v">dataset</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p/><div id="attachment_1588" class="wp-caption aligncenter"><a href="http://www.pyimagesearch.com/wp-content/uploads/2014/11/results_sunset.jpg"><img class="wp-image-1588" src="http://www.pyimagesearch.com/wp-content/uploads/2014/11/results_sunset.jpg" alt="Figure 22: Our OpenCV image search engine is able to find the images of the sunset in our vacation photo dataset." srcset="http://www.pyimagesearch.com/wp-content/uploads/2014/11/results_sunset-125x300.jpg 125w, http://www.pyimagesearch.com/wp-content/uploads/2014/11/results_sunset.jpg 800w" sizes="(max-width: 600px) 100vw, 600px"/></a><p class="wp-caption-text"><strong>Figure 22:</strong> Our OpenCV image search engine is able to find the images of the sunset in our vacation photo dataset.</p></div>
<p>These search results are also quite good — all of the images returned are of the sunset at dusk.</p>
<p>So there you have it! Your first image search engine.</p>
<h1>Summary</h1>
<p>In this blog post we explored how to build an image search engine to make our vacation photos search-able.</p>
<p>We utilized a color histogram to characterize the color distribution of our photos. Then, we indexed our dataset using our color descriptor, extracting color histograms from each of the images in the dataset.</p>
<p>To compare images we utilized the chi-squared distance, a popular choice when comparing discrete probability distributions.</p>
<p>From there, we implemented the necessary logic to accept a query image and then return relevant results.</p>
<h1>Next Steps</h1>
<p>So what are the next steps?</p>
<p>Well as you can see, the only way to interact with our image search engine is via the command line — that’s not very attractive.</p>
<p>In the next post we’ll explore how to wrap our image search engine in a Python web-framework to make it easier and sexier to use.</p>
<h1 id="post_downloads">Downloads:</h1>

	</section>
	</div></body></html>