<html><body><div><div class="entry-content">
		<h1>Introduction</h1>
<p>This series follows on from our previous series of coding dojos in which we looked at TDD with Python 3: <a href="https://blog.deltaforce.io/wordpress/running-a-coding-dojo-to-improve-python-tdd-skills/">Part 1</a>, <a href="https://blog.deltaforce.io/wordpress/running-a-coding-dojo-to-improve-python-tdd-skills-part-2/">Part 2</a>, and <a href="https://blog.deltaforce.io/wordpress/running-a-coding-dojo-to-improve-python-tdd-skills-part-3/">Part 3</a>.</p>
<p>We learned much about running dojo sessions from those first three sessions and will refer to back to them in these next three posts. It is therefore recommended that you quickly scan them before reading on.</p>
<p>Our product is composed of ~15 different services which in turn talk to many other services external to our team. Unit testing is not the only method we use to to catch problems in our product, but it is the cheapest because the unit tests run first and they run relatively quickly.</p>
<p>Sometimes we’ve noticed that certain parts of the code are not tested on the unit level, not because this is impossible, but because it is very difficult and or messy without mocking.</p>
<p>For this reason we chose mocking as the topic of our next 3 part dojo series.</p>
<h1>Feeling the pain</h1>
<p>From the first dojo series we’d learned the following:</p>
<ul>
<li>Make sure that everyone understands <i>why</i> the dojo would be useful for them. A good way to achieve this is to find a way to let them <i>feel the pain</i> that the subject of the dojo will remedy</li>
<li>Keep the scope small and clear</li>
<li>Pair participants as soon as possible and give them as much teacher attention as possible to help them move through small issues and concentrate on the goal of the exercise</li>
</ul>
<p>Based on these realisations, we chose to begin the session with a couple of slides (get the full presentation <a href="https://docs.google.com/presentation/d/1zQFPV08GIVEtTiJWhTYw5n4yBR_iIhCtHqFzrG83dHU/edit?usp=sharing">here</a>) where we first looked at where mocking can be useful. Immediately after that we asked them to start coding. You can find a vagrant environment for this exercise <a href="https://github.com/deltaforge/python-mocking-week-1">here</a>.</p>
<p><strong><strong><a href="https://blog.deltaforce.io/wordpress/wp-content/uploads/2014/11/Screen-Shot-2014-11-20-at-16.02.27.png"><img class="aligncenter size-large wp-image-62" src="https://blog.deltaforce.io/wordpress/wp-content/uploads/2014/11/Screen-Shot-2014-11-20-at-16.02.27-1024x640.png" alt="Testing Challenge" srcset="https://blog.deltaforce.io/wordpress/wp-content/uploads/2014/11/Screen-Shot-2014-11-20-at-16.02.27-300x187.png 300w, https://blog.deltaforce.io/wordpress/wp-content/uploads/2014/11/Screen-Shot-2014-11-20-at-16.02.27-1024x640.png 1024w, https://blog.deltaforce.io/wordpress/wp-content/uploads/2014/11/Screen-Shot-2014-11-20-at-16.02.27.png 1440w" sizes="(max-width: 474px) 100vw, 474px"/></a></strong></strong></p>
<p>After 20 minutes most people were finished and we randomly chose one person’s code to project on the whiteboard for review. The solution we chose is below, but most were similar.<strong><strong> </strong></strong></p>
<blockquote><p>1.<b>import</b> os<br/>
2.<b>import</b> unittest<br/>
3.<b>import</b> file_stuff<br/>
4.<br/>
5.<br/>
6.<b>class</b> <b>FileStuffTestCase</b>(unittest.TestCase):<br/>
7.<br/>
8.    <b>def</b> <b>test_delete</b>(self):<br/>
9.        name = ‘foo’<br/>
10.        test_file_handle = open(name, ‘w’)<br/>
11.        test_file_handle.close()<br/>
12.        self.assertTrue(os.path.exists(name))<br/>
13.        file_stuff.delete(name)<br/>
14.        self.assertFalse(os.path.exists(name))<br/>
15.<br/>
16.    <b>def</b> <b>test_create_creates_file_with_content</b>(self):<br/>
17.        name = ‘foo’<br/>
18.        contents = ‘bar’<br/>
19.        file_stuff.create(name, contents)<br/>
20.        self.assertTrue(os.path.exists(name))<br/>
21.        result = open(name).read()<br/>
22.        self.assertEqual(contents, result)<br/>
23.        os.remove(name)<br/>
24.<br/>
25.<b>if</b> __name__ == ‘__main__’:<br/>
26.    unittest.main()</p></blockquote>
<p>We went through the code with the team and identified the following:</p>
<ul>
<li><strong>In the function test_delete() – </strong>Lines 10, 11 and arguably 12 are irrelevant to what we’re trying to test</li>
<li><strong>In the function test_create_class_with_content() – </strong>Lines 21, 22, 24, and 25 are irrelevant to what we’re trying to test</li>
<li><strong>In general – </strong>Some people had the urge to use the create function to test the delete function and vice-versa and intuitively felt this was wrong.</li>
</ul>
<p>Through a simple 20 minute exercise, we had shown that without mocks we either 1) have to know too much about the class we are testing or 2) are tempted couple our class functions in our testing. We  had also written a lot of useless code.</p>
<p>Satisfied that testing certain class dependencies without mocking was painful, we revealed the cure. <strong><strong> </strong></strong></p>
<h1>Applying the balm</h1>
<p>We first introduced the general concept of mocking with a few example slides, two of which you can see below. Full presentation available <a href="https://docs.google.com/presentation/d/1zQFPV08GIVEtTiJWhTYw5n4yBR_iIhCtHqFzrG83dHU/edit?usp=sharing">here</a>. In the spirit of keeping the scope of the dojo small, we only introduced patch() decorators.</p>
<p><a href="https://blog.deltaforce.io/wordpress/wp-content/uploads/2014/11/Screen-Shot-2014-11-20-at-16.09.01.png"><img class="aligncenter size-large wp-image-65" src="https://blog.deltaforce.io/wordpress/wp-content/uploads/2014/11/Screen-Shot-2014-11-20-at-16.09.01-1024x640.png" alt="Generic mocking example" srcset="https://blog.deltaforce.io/wordpress/wp-content/uploads/2014/11/Screen-Shot-2014-11-20-at-16.09.01-300x187.png 300w, https://blog.deltaforce.io/wordpress/wp-content/uploads/2014/11/Screen-Shot-2014-11-20-at-16.09.01-1024x640.png 1024w, https://blog.deltaforce.io/wordpress/wp-content/uploads/2014/11/Screen-Shot-2014-11-20-at-16.09.01.png 1440w" sizes="(max-width: 474px) 100vw, 474px"/></a></p>
<p><a href="https://blog.deltaforce.io/wordpress/wp-content/uploads/2014/11/Screen-Shot-2014-11-20-at-16.09.03.png"><img class="aligncenter size-large wp-image-66" src="https://blog.deltaforce.io/wordpress/wp-content/uploads/2014/11/Screen-Shot-2014-11-20-at-16.09.03-1024x640.png" alt="Generic mocking example - code" srcset="https://blog.deltaforce.io/wordpress/wp-content/uploads/2014/11/Screen-Shot-2014-11-20-at-16.09.03-300x187.png 300w, https://blog.deltaforce.io/wordpress/wp-content/uploads/2014/11/Screen-Shot-2014-11-20-at-16.09.03-1024x640.png 1024w, https://blog.deltaforce.io/wordpress/wp-content/uploads/2014/11/Screen-Shot-2014-11-20-at-16.09.03.png 1440w" sizes="(max-width: 474px) 100vw, 474px"/></a></p>
<p>We then zoomed in on the patch() decorator itself to explain how all the parts interacted.</p>
<p><a href="https://blog.deltaforce.io/wordpress/wp-content/uploads/2014/11/Screen-Shot-2014-11-20-at-16.09.05.png"><img class="aligncenter size-large wp-image-67" src="https://blog.deltaforce.io/wordpress/wp-content/uploads/2014/11/Screen-Shot-2014-11-20-at-16.09.05-1024x640.png" alt="Patch decorators up close" srcset="https://blog.deltaforce.io/wordpress/wp-content/uploads/2014/11/Screen-Shot-2014-11-20-at-16.09.05-300x187.png 300w, https://blog.deltaforce.io/wordpress/wp-content/uploads/2014/11/Screen-Shot-2014-11-20-at-16.09.05-1024x640.png 1024w, https://blog.deltaforce.io/wordpress/wp-content/uploads/2014/11/Screen-Shot-2014-11-20-at-16.09.05.png 1440w" sizes="(max-width: 474px) 100vw, 474px"/></a></p>
<p>We then asked the team to split into pairs and to test the same code they’d be given before, but this time using mocking.</p>
<p><a href="https://blog.deltaforce.io/wordpress/wp-content/uploads/2014/11/Screen-Shot-2014-11-20-at-16.09.08.png"><img class="aligncenter size-large wp-image-68" src="https://blog.deltaforce.io/wordpress/wp-content/uploads/2014/11/Screen-Shot-2014-11-20-at-16.09.08-1024x640.png" alt="Screen Shot 2014-11-20 at 16.09.08" srcset="https://blog.deltaforce.io/wordpress/wp-content/uploads/2014/11/Screen-Shot-2014-11-20-at-16.09.08-300x187.png 300w, https://blog.deltaforce.io/wordpress/wp-content/uploads/2014/11/Screen-Shot-2014-11-20-at-16.09.08-1024x640.png 1024w, https://blog.deltaforce.io/wordpress/wp-content/uploads/2014/11/Screen-Shot-2014-11-20-at-16.09.08.png 1440w" sizes="(max-width: 474px) 100vw, 474px"/></a></p>
<h1>Conclusion</h1>
<p>Everyone finished testing the code with mocks in the time available, and seemed to be much more positive about the exercise than they had in the first part of the TDD dojo sessions. Keeping the scope small, giving more direct instructions up front, and pairing as early as possible had, in my opinion, worked as intended.</p>
<p>The team now have experience mocking dependencies to create cleaner test code. In the next dojo we will look at a more complex mocking example.</p>
	</div>
	
	</div></body></html>