<html><body><div><section class="post-content"><h4>Overview</h4>

<p>The following steps will get you up and running with GPU-enabled
<a href="https://www.tensorflow.org/">TensorFlow</a>
on an Ubuntu 14.04 <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using_cluster_computing.html">Linux GPU EC2 instance</a>.
It’ll also walk through installing
<a href="https://www.continuum.io/">Anaconda Python 3.4</a>, so that all of the important data packages
(numpy, sklearn, jupyter, etc) are at your disposal.</p>

<p><em>From start to finish, installation should take <code>~75 minutes</code>.</em></p>

<h4>What this guide covers</h4>

<ul>
<li>Provisioning the <strong>GPU EC2</strong> instance</li>
<li>Installing and configuring <strong>CUDA</strong> and <strong>cuDNN</strong></li>
<li>Installing <strong>Anaconda</strong> and <strong>Python 3.4</strong></li>
<li>Building <strong>TensorFlow</strong> from source</li>
<li>Configuring <strong>Jupyter Notebook</strong></li>
</ul>

<h4>Credits</h4>

<p>These steps are taken almost verbatim from <a href="https://gist.github.com/erikbern">Erik Bern’s</a>
awesome <a href="https://gist.github.com/erikbern/78ba519b97b440e10640">tensorflow installation gist</a>.
(His <a href="http://erikbern.com/">blog</a> is a must read btw.) Many thanks go to the commenters on the gist for clarifications as well.</p>

<p>According to Erik’s gist, most/all of the CUDA steps were taken from
Traun Leyden’s great post on getting
<a href="http://tleyden.github.io/blog/2014/10/25/cuda-6-dot-5-on-aws-gpu-instance-running-ubuntu-14-dot-04/">CUDA 6.5 up and running on AWS</a>.</p>

<p>Finally, credit for the Jupyter EC2 configuration goes to
<a href="http://yangjie.me/2015/08/26/Run-Jupyter-Notebook-Server-on-Amazon-EC2/">another excellent blog post</a>
by Jie Yang.</p>

<hr/>

<h2>Provision Instance</h2>

<p>First things first - let’s provision a Linux GPU EC2 Instance.</p>

<h4>AMI and Instance Type</h4>

<p>We’ll use Amazon’s Ubuntu 14.04 (HVM) public ami, <strong>ami-06116566</strong>,
and the <strong>g2.2xlarge</strong> instance type.</p>

<h4>Disk Size</h4>

<p><a href="http://tleyden.github.io/blog/2014/10/25/cuda-6-dot-5-on-aws-gpu-instance-running-ubuntu-14-dot-04/">Traun</a>
recommends provisioning a <strong>20GB+</strong> volume. We used 30GB when recreating the steps below and had no troubles.</p>

<h4>Security Group</h4>

<p>Make sure you open up <strong>port 22</strong> for ssh and <strong>ports 443</strong> and <strong>8888</strong> for accessing Jupyter notebooks.
You can choose to allow from any IPs (shown below) or limit to custom addresses if you’d prefer.</p>

<table><thead>
<tr>
<th>Type</th>
<th>Protocol</th>
<th>Port Range</th>
<th>Source</th>
</tr>
</thead><tbody>
<tr>
<td>SSH</td>
<td>TCP</td>
<td>22</td>
<td>0.0.0.0/0</td>
</tr>
<tr>
<td>HTTPS</td>
<td>TCP</td>
<td>443</td>
<td>0.0.0.0/0</td>
</tr>
<tr>
<td>Custom TCP Rule</td>
<td>TCP</td>
<td>8888</td>
<td>0.0.0.0/0</td>
</tr>
</tbody></table>

<hr/>

<h2>Install Dependencies</h2>

<p>Let’s create a screen session and jump into the newly provisioned server to install the basic dependencies.</p>

<h4>Log in</h4>
<pre class="highlight shell"><code><span class="c"># local</span>
<span class="nv">ip</span><span class="o">=</span>53.32.222.185 <span class="c"># The ip address of your ec2 instance</span>
<span class="nv">user</span><span class="o">=</span>ubuntu
ssh -t <span class="nv">$user</span>@<span class="nv">$ip</span> <span class="s2">"screen -dR setup"</span>
</code></pre>

<h4>Update Packages</h4>

<p>Next, we’ll update Apt-Get, upgrade installed packages and add a few more that we’ll need for compiling later.</p>
<pre class="highlight shell"><code><span class="c"># ec2</span>
sudo apt-get update
sudo apt-get upgrade -y
sudo apt-get install -y build-essential git swig default-jdk zip zlib1g-dev
</code></pre>

<hr/>

<h2>Setup CUDA</h2>

<p>After we take care of some prerequisites, we’ll install CUDA 7.0 and CUDNN 6.5 and be on our way.</p>

<h4>Prerequisites</h4>

<p>First, we need to blacklist Nouveau which has a conflict with the nvidia driver.</p>
<pre class="highlight shell"><code><span class="c"># ec2</span>
<span class="nb">echo</span> -e <span class="s2">"blacklist nouveau</span><span class="se">\n</span><span class="s2">blacklist lbm-nouveau</span><span class="se">\n</span><span class="s2">options nouveau modeset=0</span><span class="se">\n</span><span class="s2">alias nouveau off</span><span class="se">\n</span><span class="s2">alias lbm-nouveau off</span><span class="se">\n</span><span class="s2">"</span> | sudo tee /etc/modprobe.d/blacklist-nouveau.conf
<span class="nb">echo </span>options nouveau <span class="nv">modeset</span><span class="o">=</span>0 | sudo tee -a /etc/modprobe.d/nouveau-kms.conf
sudo update-initramfs -u
sudo reboot
</code></pre>

<p>Once the server comes back up, let’s log back in to install another package per Traun and reboot.</p>
<pre class="highlight shell"><code><span class="c"># local</span>
ssh -t <span class="nv">$user</span>@<span class="nv">$ip</span> <span class="s2">"screen -dR setup"</span>
</code></pre>
<pre class="highlight shell"><code><span class="c"># ec2</span>
sudo apt-get install -y linux-image-extra-virtual
sudo reboot
</code></pre>

<p>One more time:</p>
<pre class="highlight shell"><code><span class="c"># local</span>
ssh -t <span class="nv">$user</span>@<span class="nv">$ip</span> <span class="s2">"screen -dR setup"</span>
</code></pre>
<pre class="highlight shell"><code><span class="c"># ec2</span>
sudo apt-get install -y linux-source linux-headers-<span class="sb">`</span>uname -r<span class="sb">`</span>
</code></pre>

<h4>Install CUDA 7.0</h4>

<p>First, download the install script and verify the checksum.</p>
<pre class="highlight shell"><code>wget http://developer.download.nvidia.com/compute/cuda/7_0/Prod/local_installers/cuda_7.0.28_linux.run
<span class="nv">cs</span><span class="o">=</span><span class="k">$(</span>md5sum cuda_7.0.28_linux.run | cut -d<span class="s1">' '</span> -f1<span class="k">)</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$cs</span><span class="s2">"</span> !<span class="o">=</span> <span class="s2">"312aede1c3d1d3425c8caa67bbb7a55e"</span> <span class="o">]</span>; <span class="k">then </span><span class="nb">echo</span> <span class="s2">"WARNING: Unverified MD5 hash"</span>; <span class="k">fi</span>
</code></pre>

<p>Next, we need to run the NVIDIA installation scripts.</p>
<pre class="highlight shell"><code>chmod +x cuda_7.0.28_linux.run
./cuda_7.0.28_linux.run -extract<span class="o">=</span><span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>/nvidia_installers
<span class="nb">pushd </span>nvidia_installers
sudo ./NVIDIA-Linux-x86_64-346.46.run
<span class="c"># When prompted you'll need to:</span>
<span class="c"># * Agree to the license terms</span>
<span class="c"># * Accept the X Library path and X module path</span>
<span class="c"># * Accept that 32-bit compatibility files will not be installed</span>
<span class="c"># * Review and accept the libvdpau and libvdpau_trace libraries notice</span>
<span class="c"># * Choose `Yes` when asked about automatically updating your X configuration file</span>
<span class="c"># * Verify successful installation by choosing `OK`</span>
sudo modprobe nvidia
</code></pre>

<p>Now we can run the CUDA installation script.</p>
<pre class="highlight shell"><code>sudo ./cuda-linux64-rel-7.0.28-19326674.run
<span class="c"># When prompted, you'll need to:</span>
<span class="c"># * Accept the license terms (long scroll, page down with `f`)</span>
<span class="c"># * Use the default installation path</span>
<span class="c"># * Answer `n` to desktop shortcuts</span>
<span class="c"># * Answer `y` to create a symbolic link</span>
</code></pre>

<h4>Install cuDNN 6.5</h4>

<p><strong>Note</strong>: You’ll need to register to get accepted into the
<a href="https://developer.nvidia.com/accelerated-computing-developer">NVIDIA Accelerated Computing Developer Program</a>
and download the <a href="https://developer.nvidia.com/rdp/cudnn-archive">cuDNN v2 Library for Linux</a>
to your local workstation. (We were accepted within one business day.)</p>

<p>Let’s log out, scp the file up to the server, then log back in.</p>
<pre class="highlight shell"><code><span class="c"># ec2</span>
<span class="nb">exit</span>
</code></pre>
<pre class="highlight shell"><code><span class="c"># local</span>
scp ~/Downloads/cudnn-6.5-linux-x64-v2.tgz <span class="nv">$user</span>@<span class="nv">$ip</span>:~/
ssh -t <span class="nv">$user</span>@<span class="nv">$ip</span> <span class="s2">"screen -dR setup"</span>
</code></pre>

<p>Then installation is as simple as copying a few files.</p>
<pre class="highlight shell"><code><span class="c"># ec2</span>
tar -xzf cudnn-6.5-linux-x64-v2.tgz
sudo cp cudnn-6.5-linux-x64-v2/libcudnn<span class="k">*</span> /usr/local/cuda/lib64
sudo cp cudnn-6.5-linux-x64-v2/cudnn.h /usr/local/cuda/include/
</code></pre>

<hr/>

<h2>Install Python 3.4 and Tensorflow</h2>

<p>Erik mentions that he had some trouble with disk space while building Tensorflow, so we’ll follow his
advice in pointing <code>/tmp</code> to <code>/mnt/tmp</code> before we get started with the installation.</p>
<pre class="highlight shell"><code>sudo mkdir /mnt/tmp
sudo chmod 777 /mnt/tmp
sudo rm -rf /tmp
sudo ln -s /mnt/tmp /tmp
</code></pre>

<h4>Install Anaconda with Python 3.4</h4>

<p>Anaconda comes with many, many packages and is a breeze to install.
Version 2.4.1 comes with Python 3.5.1 - we’ll need to configure it to use Python 3.4
as Tensorflow doesn’t currently support 3.5.</p>

<p>First, we can download the install script and verify the checksum.</p>
<pre class="highlight shell"><code>wget https://3230d63b5fc54e62148e-c95ac804525aac4b6dba79b00b39d1d3.ssl.cf1.rackcdn.com/Anaconda3-2.4.1-Linux-x86_64.sh
<span class="nv">cs</span><span class="o">=</span><span class="k">$(</span>md5sum Anaconda3-2.4.1-Linux-x86_64.sh | cut -d<span class="s1">' '</span> -f1<span class="k">)</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$cs</span><span class="s2">"</span> !<span class="o">=</span> <span class="s2">"45249376f914fdc9fd920ff419a62263"</span> <span class="o">]</span>; <span class="k">then </span><span class="nb">echo</span> <span class="s2">"WARNING: Unverified MD5 hash"</span>; <span class="k">fi</span>
</code></pre>

<p>Next, run the install script.</p>
<pre class="highlight shell"><code>bash Anaconda3-2.4.1-Linux-x86_64.sh
<span class="c"># When promted you'll need to:</span>
<span class="c"># * Accept the license terms</span>
<span class="c"># * Choose the default installation location `/home/ubuntu/anaconda3`</span>
<span class="c"># * Allow the installer to add the Anaconda installation path to your `/home/ubuntu/.bashrc`</span>
<span class="nb">source</span> ~/.bashrc
</code></pre>

<p>Finally, we install Python 3.4 and Pip.</p>
<pre class="highlight shell"><code>conda install anaconda <span class="nv">python</span><span class="o">=</span>3.4 -y
conda install pip -y
</code></pre>

<h4>Install JDK 8</h4>

<p>Recent versions of Bazel require JDK 8, so let’s install it.</p>
<pre class="highlight shell"><code>sudo add-apt-repository ppa:openjdk-r/ppa
<span class="c"># When prompted you'll need to press ENTER to continue</span>
sudo apt-get update
sudo apt-get install -y openjdk-8-jdk
</code></pre>

<p>We’ll then need to configure the system default to Java 8.
When prompted, choose the number corresponding to Java 8. (it should be #2 in both cases)</p>
<pre class="highlight shell"><code>sudo update-alternatives --config java
sudo update-alternatives --config javac
</code></pre>

<h3>Build Bazel</h3>

<p>Here, we clone the repo, compile the <code>0.1.4</code> release and copy the binaries to <code>/usr/bin</code>.</p>
<pre class="highlight shell"><code><span class="nb">cd</span> /mnt/tmp
git clone https://github.com/bazelbuild/bazel.git
<span class="nb">cd </span>bazel
git checkout tags/0.1.4
./compile.sh
sudo cp output/bazel /usr/bin
</code></pre>

<h3>Build Tensorflow</h3>

<p>I recommend that you add these two exports to <code>~/.bashrc</code>: they need to be around
when building as well as in the future when you use TensorFlow in your python scripts.</p>
<pre class="highlight shell"><code><span class="nb">export </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span><span class="s2">"</span><span class="nv">$LD_LIBRARY_PATH</span><span class="s2">:/usr/local/cuda/lib64"</span>
<span class="nb">export </span><span class="nv">CUDA_HOME</span><span class="o">=</span>/usr/local/cuda
</code></pre>

<p>With our environment setup, we can clone the tensorflow repo.
(The commit hash shown below was the latest commit on <code>master</code> at time of writing.)</p>
<pre class="highlight shell"><code><span class="nb">cd</span> /mnt/tmp
git clone --recurse-submodules https://github.com/tensorflow/tensorflow
<span class="nb">cd </span>tensorflow
git checkout 437646b1495266cd4e5058f96bb06098785f4d4e
</code></pre>

<p>And now on to configuring the build.</p>
<pre class="highlight shell"><code><span class="nv">TF_UNOFFICIAL_SETTING</span><span class="o">=</span>1 ./configure
<span class="c"># When prompted, you'll need to:</span>
<span class="c"># * Accept the default `anaconda3` python location</span>
<span class="c"># * Build with GPU support</span>
<span class="c"># * Accept the defaults for Cuda SDK and Cudnn versions and locations.</span>
<span class="c"># * Specify Cuda compute device capability of `3.0`</span>
<span class="c">#     **Don't accept the default of `3.5,5.2`**</span>
</code></pre>

<p>And finally building TensorFlow with Bazel.</p>
<pre class="highlight shell"><code>bazel build -c opt --config<span class="o">=</span>cuda //tensorflow/cc:tutorials_example_trainer
</code></pre>

<p>With TensorFlow built, we can now create and install the Pip package.</p>
<pre class="highlight shell"><code>bazel build -c opt --config<span class="o">=</span>cuda //tensorflow/tools/pip_package:build_pip_package
bazel-bin/tensorflow/tools/pip_package/build_pip_package /tmp/tensorflow_pkg
pip install /tmp/tensorflow_pkg/tensorflow-0.6.0-py3-none-any.whl
</code></pre>

<h4>Test it out!</h4>
<pre class="highlight shell"><code><span class="nb">cd</span> /mnt/tmp/tensorflow/tensorflow/models/image/cifar10/
python cifar10_multi_gpu_train.py
</code></pre>

<p>If everything has been configured correctly,
you should see references to TensorFlow using device <code>/gpu:0</code> when running the script above.</p>

<hr/>

<h2>Jupyter Notebook Setup</h2>

<p>Let’s login to the server from local again to create a new screen session to run Jupyter in.</p>
<pre class="highlight shell"><code><span class="c"># local</span>
ssh -t <span class="nv">$user</span>@<span class="nv">$ip</span> <span class="s2">"screen -dR notebook"</span>
</code></pre>

<h4>Configure Jupyter</h4>

<p>First, generate the initial config and generate the password you’ll use to
log in to Jupyter in the browser.</p>
<pre class="highlight shell"><code><span class="c"># ec2</span>
jupyter notebook --generate-config

<span class="nv">key</span><span class="o">=</span><span class="k">$(</span>python -c <span class="s2">"from notebook.auth import passwd; print(passwd())"</span><span class="k">)</span>
<span class="c"># When prompted you'll need to specify a password</span>
</code></pre>

<p>Next, we’ll create the certificate.</p>
<pre class="highlight shell"><code><span class="nb">cd</span> ~
mkdir certs
<span class="nb">cd </span>certs
<span class="nv">certdir</span><span class="o">=</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>
openssl req -x509 -nodes -days 365 -newkey rsa:1024 -keyout mycert.key -out mycert.pem
<span class="c"># You'll be prompted to enter values for the cert,</span>
<span class="c"># but it doesn't much matter, you can just leave them all blank.</span>
</code></pre>

<p>And finally setup the Jupyter config with our cert, password and port.</p>
<pre class="highlight plaintext"><code>cd ~
sed -i "1 a\
c = get_config()\\
c.NotebookApp.certfile = u'$certdir/mycert.pem'\\
c.NotebookApp.ip = '*'\\
c.NotebookApp.open_browser = False\\
c.NotebookApp.password = u'$key'\\
c.NotebookApp.port = 8888" .jupyter/jupyter_notebook_config.py
</code></pre>

<h4>Start Jupyter</h4>

<p>Now let’s run Jupyter with the configuration we just created. After it starts running, you can
hit <code>ctrl-a</code> then <code>d</code> to disconnect from your screen session while leaving jupyter running.</p>

<p><strong>Be sure you’ve added <code>LD_LIBRARY_PATH</code> and <code>CUDA_HOME</code> to your environment.</strong></p>
<pre class="highlight shell"><code>mkdir -p ~/notebooks
<span class="nb">cd</span> ~/notebooks
jupyter notebook --certfile<span class="o">=</span>~/certs/mycert.pem --keyfile ~/certs/mycert.key
</code></pre>

<h4>Open up Jupyter in the browser</h4>
<pre class="highlight shell"><code><span class="c"># local</span>
open https://<span class="nv">$ip</span>:8888
</code></pre>

<p>You’ll get a security warning because your certificate you created above is not verified.
To get through, click the <code>Advanced</code> link and proceed. At that point, you can enter the password
you specified above.</p>

<h2>Fini!</h2>

<p>That was quite a lot, but we now have TensorFlow talking to our GPU, Python 3.4,
all the deep learning packages we could ever want and the amazing
Jupyter playground to play with everything in.</p>

<hr/>

<h2>Troubleshooting</h2>
<pre class="highlight plaintext"><code>ImportError: libcudart.so.7.0: cannot open shared object file: No such file or directory
</code></pre>

<p>If you receive the following error when trying to <code>import tensorflow</code>, make sure you’ve
correctly setup your environment with <code>LD_LIBRARY_PATH</code> and <code>CUDA_HOME</code>.</p>
</section>
</div></body></html>