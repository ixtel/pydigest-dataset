<html><body><div><div class="post-1482 post type-post status-publish format-standard has-post-thumbnail hentry category-flask-framework-tutorials-and-examples category-flask-sqlalchemy-examples-and-tutorials tag-flask-2 tag-flask-sqlalchemy tag-many-to-many-relationships-with-flask-sqlalchemy tag-sqlalchemy">
                <p>
                            <a href="" rel="nofollow"><img src="http://techarena51.com/wp-content/uploads/2015/04/flask-sqlalchemy-small.png" alt="Many to Many Relationships with Flask-SQLALchemy" align="left" class="affiliate-image"/></a>
                        </p><p>In my earlier <a title="One to Many Relationships with Flask-SQLAlchemy" href="http://techarena51.com/index.php/one-to-many-relationships-with-flask-sqlalchemy/" target="_blank">post</a> I described how to create  a One to Many relationship with Flask-SQLAlchemy . In this post I will describe how to create a <strong>Many to Many relationship with Flask-SQLAlcehmy </strong>.</p>
<p><strong>Defining a Many to Many relationship.</strong></p>
<p>A  Many to Many Relationship between two entities can be defined as one in which a parent entity can have many children and vice versa. Think of the parent entity as a Post and the child as Tags. If I were to define a Many to Many relationship between them then I can say that one Post can have many Tags and one Tag can have many Posts.</p>
<p>To create this relationship with Flask-SQLAlchemy between  two entities lets say a Posts table  and a Tags table you will need to add another table which will consists of  two Foreign keys, one Foreign key to the Posts  table and  one Foreign key to Tags table and then define the relationship on on either of two tables.</p>
<p><strong>Example code to define a Many to Many relationship.</strong></p>
<pre class="brush: python; title: ; notranslate" title="">
#https://github.com/Leo-g/flask-blog/blob/master/app/models.py
from flask import Flask
from flask.ext.sqlalchemy import SQLAlchemy

app = Flask(__name__)
SQLALCHEMY_DATABASE_URI='postgresql://username:password@localhost:5432/database'
db = SQLAlchemy(app)
relationship_table=db.Table('relationship_table',                            

                             db.Column('post_id', db.Integer,db.ForeignKey('posts.id'), nullable=False),
                             db.Column('tags_id',db.Integer,db.ForeignKey('tags.id'),nullable=False),
                             db.PrimaryKeyConstraint('post_id', 'tags_id') )

class Posts(db.Model):
  id = db.Column(db.Integer, primary_key=True)
  title = db.Column(db.String(255),nullable=False)
  content = db.Column(db.Text)
  tags=db.relationship('Tags', secondary=relationship_table, backref='posts' )  

class Tags(db.Model):
     id=db.Column(db.Integer, primary_key=True)
     name=db.Column(db.String, unique=True, nullable=False)
     description=db.Column(db.Text)   
</pre>
<p>In the above  example code I have defined a Many to Many relationship on the Posts table with  “tags=db.relationship(‘Tags’, secondary=relationship_table, backref=’posts’ )”.</p>
<p>Explanation of the arguments:</p>
<p><strong>Tags</strong>: Is the child table which I want to create the relationship with.</p>
<p><strong>secondary=relationship_table</strong>: You will need to use the <em>secondary</em> argument to specify the associative table(relationship_table).</p>
<p><strong>backref=’posts</strong>‘: The<em> backref</em> argument will create a posts attribute on the child table.</p>
<p>I have also defined a <strong>Composite Primary Key</strong> on the  associating table via “db.PrimaryKeyConstraint(‘post_id’, ‘tags_id’)”, I have done this as I want a combination of the two foreign keys to be unique.</p>

<p>


</p>

<p>You may have also noticed that I have created the associating table (<em>relationship_table)</em> with the Table class instead of the Model class. This is how Flask-SQLAlchemy recommends you create an associating table. However if you need to map the table to a class then you can use the mapper function described <a href="http://docs.sqlalchemy.org/en/improve_toc/orm/classical.htm" target="_blank">here</a>.</p>
<p><strong>Example code for adding or removing a  Many to Many relationship</strong>.</p>
<p>I can get a list of tags via post.tags and then add or delete tags via post.tags.append(tag) or post.tags.remove(tags).</p>
<pre class="brush: python; title: ; notranslate" title="">
#https://github.com/Leo-g/flask-blog/blob/master/app/controller.py
tag_ids = [3,4,5]
post_ids = [1,2]

for id in post_ids:
   post=Posts.query.get_or_404(id)
   for id in tag_ids:
      tag=Tags.query.get(id)
      if tag is not None:
        #Add an association
        post.tags.append(tag)
        #OR Delete an association
        post.tags.delete(tag)
      
db.session.commit()

</pre>
<p>Similarly, you can also use <em>tag.posts.append()</em> and <em>tag.posts.remove()</em> to add or delete associations.</p>
<p>Working Demo of the code with a Posts table and a Terms table that consists of Tags.</p>
<p><iframe src="https://www.youtube.com/embed/3cCoEly6GF4" frameborder="0" allowfullscreen="">VIDEO</iframe><br/>
The complete code is available on <a href="https://github.com/Leo-g/flask-blog" target="_blank">here,</a> let me know if you have any questions or suggestions.
</p>

<p/>
                         <div class="abh_box abh_box_down abh_box_business"><div class="abh_tab_content"><section class="vcard abh_about_tab abh_tab"><div class="abh_text"><p class="abh_job"/><p class="description note abh_description">Is a Technical project manager who through this blog shares his experience building Web Applications with Python, FlaskAngularjs and Linux.His Projects are opensource and available at https://github.com/Leo-g</p></div> </section><section class="abh_posts_tab abh_tab"><div class="abh_text"><h4>Latest posts by Leo G <span class="abh_allposts">(<a href="http://techarena51.com/index.php/author/leo/">see all</a>)</span></h4></div> </section></div> </div>        <p class="clear"/>
                
    </div>
    
    
        
</div></body></html>