<html><body><div><div itemprop="articleBody"><p>I've finally mannaged to pull off a set of wrappers for using the raw windows iocp api using ctypes, namely wrappers for GetQueuedCompletionStatus, WSARecv, WSASend, AcceptEx, ConnectEx, TransmitFile and the whatever structs and utility calls they need.</p><p>Writing the wrappers wasn't that hard - but if you aren't careful with ctypes you are in a world of gruesome crashes and at least 2 wasted evenings (read nights) debugging why the hell some random allocation fails. Well, for a fact, I still have no idea to why do I own those to wasted nights but thank god it doesn't crash on my unittests anymore - I think I could have figured out why <a class="reference external" href="http://code.google.com/p/cogen/source/diff?spec=svn517&amp;r=514&amp;format=side&amp;path=/trunk/cogen/core/proactors/ctypes_iocp_impl/__init__.py&amp;old_path=/trunk/cogen/core/proactors/ctypes_iocp_impl/__init__.py&amp;old=509#sc_svn514_292">some</a> missing object cleanup resulted in weird crashes if I knew some ctypes internals but eh, I don't :(</p><p>Take a look at the evil code <a class="reference external" href="http://code.google.com/p/cogen/source/browse/trunk/cogen/core/proactors/ctypes_iocp_impl/__init__.py">here</a> and <a class="reference external" href="http://code.google.com/p/cogen/source/browse/trunk/cogen/core/proactors/ctypes_iocp_impl/api_wrappers.py">here</a>, and punish me for doing such an evil thing with ctypes *malefic laugh* =]</p><p>Here's a gem:</p><div class="highlight"><pre><span/><span class="c1"># signature: BOOL = SOCKET hSocket, HANDLE hFile, DWORD nNumberOfBytesToWrite, DWORD nNumberOfBytesPerSend, LPOVERLAPPED lpOverlapped,LPTRANSMIT_FILE_BUFFERS lpTransmitBuffers, DWORD dwFlags</span>
<span class="n">TransmitFileType</span> <span class="o">=</span> <span class="n">WINFUNCTYPE</span><span class="p">(</span><span class="n">BOOL</span><span class="p">,</span> <span class="n">SOCKET</span><span class="p">,</span> <span class="n">HANDLE</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">,</span> <span class="n">POINTER</span><span class="p">(</span><span class="n">OVERLAPPED</span><span class="p">),</span> <span class="n">POINTER</span><span class="p">(</span><span class="n">TRANSMIT_FILE_BUFFERS</span><span class="p">),</span> <span class="n">DWORD</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_GetTransmitFilePtr</span><span class="p">(</span><span class="n">given_socket</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="n">socket</span>
    <span class="n">bogus_sock</span> <span class="o">=</span> <span class="n">given_socket</span> <span class="ow">or</span> <span class="n">socket</span><span class="p">()</span>
    <span class="n">bogus_bytes</span> <span class="o">=</span> <span class="n">DWORD</span><span class="p">()</span>
    <span class="n">TransmitFile</span> <span class="o">=</span> <span class="n">TransmitFileType</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">WSAIoctl</span><span class="p">(</span>
        <span class="n">bogus_sock</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">SIO_GET_EXTENSION_FUNCTION_POINTER</span><span class="p">,</span> <span class="n">byref</span><span class="p">(</span><span class="n">WSAID_TRANSMITFILE</span><span class="p">),</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">WSAID_TRANSMITFILE</span><span class="p">),</span>
        <span class="n">byref</span><span class="p">(</span><span class="n">TransmitFile</span><span class="p">),</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">TransmitFile</span><span class="p">),</span> <span class="n">byref</span><span class="p">(</span><span class="n">bogus_bytes</span><span class="p">),</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">TransmitFile</span>

<span class="n">TransmitFile</span> <span class="o">=</span> <span class="n">_GetTransmitFilePtr</span><span class="p">()</span>
</pre></div><p>So far the new proactor works pretty nice in cogen.</p></div></div></body></html>