<html><body><div><div class="content html_format">
      <img src="https://habrastorage.org/files/4d1/801/742/4d18017421ce403f876c9e979e88daca.jpg"/>
<p>
Другие статьи цикла:
</p><a href="https://geektimes.ru/post/253326/">Здравствуйте, я Meklon и я кофеин-зависимый</a>
<a href="https://geektimes.ru/post/271082/">Компот из кофейных сухофруктов. Знакомимся с каскарой — лучшим другом велосипедиста</a>
<p>
Продолжаю кофейную тематику, которую я начал еще на geektimes: </p><a href="http://geektimes.ru/post/253326/">Здравствуйте, я Meklon и я кофеин-зависимый</a><p>. Сегодня мы будем творить непотребства с софтом для биоинженерных задач — CellProfiler. Нормальные люди им считают клетки, плазмиды, экспрессию белка и прочие нужные вещи. Мы долбанутые, поэтому будем проводить гранулометрический анализ помола по микрофотографии, бить кофе статическим электричеством и думать, как прицепить к этому безобразию фен. Ну и конечно нам потребуется скотч для получения </p><s>графена</s><p> картины распределения частиц.
</p><p>
В целом, компьютерный анализ изображения — штука гибкая и может применяться в совершенно странных задачах. Заодно проверим, можно ли заменить турку колбой с магнитной мешалкой. В конце концов, главный принцип выживания в лаборатории — «Нет кофе — нет работы») Под катом очень много фотографий, но я постарался их ужать до приличных размеров.
</p><a name="habracut"/>
<h4>Графен и кофе</h4>
<img src="https://habrastorage.org/files/59e/a29/464/59ea294646be41b7bc664e500dd4011a.jpg"/>
<p>
Основная задача, которую я хотел решить — объективное сравнение качества помола разных кофемолок. По идее, качественный помол отличается идеальной равномерностью. Значит нам нужно посчитать количество частиц на заданной площади и отсортировать их по размерам. Чем больше будет дисперсия — тем хуже качество. Самый простой пример — роторная кофемолка, которая разбивает зерна быстро вращающимися лезвиями. В ее профиле помола одновременно присутствуют и крупные фракции и мелкая пыль. Хорошего эспрессо из такого кофе уже не получится. Проблема связана с неравномерностью пробивания «водяных каналов», через которые проливается кофейная таблетка. Мелкие частицы будут давать горечь из-за переэкстракции, а крупные создадут «обходные пути», что сделает кофе водянистым. В отличие от роторной, кофемолка жернового типа дает более или менее калиброванный вариант с одинаковыми частицами.</p><p>
Собственно, теперь задача состоит из двух основных пунктов:
</p><ol>
<li>Расположить в нормальном распределении частицы на прозрачной подложке, чтобы их можно было сфотографировать микроскопом</li>
<li>Посчитать размеры и количество частиц <s>вручную за пару лет</s> автоматизированным комплексом</li>
<li>Подвести итоги, сделать чашку хорошего эспрессо и тщательно себя похвалить за сообразительность</li>
</ol><p>
Когда мы подняли этот вопрос в прошлой </p><a href="http://geektimes.ru/post/253326/#comment_8713400">теме,</a>  <a href="https://habrahabr.ru/users/sptor/" class="user_link">sptor</a><p> и  </p><a href="https://habrahabr.ru/users/mwizard/" class="user_link">mwizard</a><p> предложили использовать вибрацию в различных вариантах. Но у этого метода, как и у многих других, есть очень важный недостаток — неравномерность воздействия вибрации на частицы разного размера. Нам надо получить слепок реального усредненного состава, а не создать сортировочный лоток золотодобытчика в миниатюре. Наиболее удачная идея пришла в голову  </p><a href="https://habrahabr.ru/users/eexo/" class="user_link">eexo</a><p> — использовать обычный скотч. Чем именно метод хорош? Дешево, сердито. Просто на первый взгляд. И самое главное — касаясь скотчем молотого кофе вы получаете полный набор частиц в реалистичном распределении. Естественно, что без граблей, электротравм и злодейского смеха во время эксперимента здесь не обошлось…

</p><img src="https://habrastorage.org/files/72b/726/02c/72b72602cf7a4037a57b940c64f99dcf.jpg"/>

<h4>Фен против электрофорной машины</h4>
<img src="https://habrastorage.org/getpro/habr/post_images/32d/002/93b/32d00293b23b9fecbb44a327b1b1659a.jpg" alt="image"/>
<p>
Одна из основных проблем, с которой я столкнулся — склонность мелких кофейных пылинок слипаться, что в итоге приводит к неверному определению границ и размеров объектов. Логика подсказала, что проблема может быть решена электризацией частиц кофе одноименным зарядом. Осталось только понять как это проще сделать. Генератора Ван де Граафа под рукой не было. Решил просто потрясти пакет с молотым кофе. Так как пакет оказался слегка дырявым, пришлось долго подметать и вытирать кофейную пудру по всей лаборатории. Да и электризации особо не получилось.
</p><p>
Альтернативный вариант мне представился на одной из вузовских выставок, куда свозят автобусами несчастных школьников и заставляют вдохновляться экспозициями учебных заведений. Я развлекался с симулятором эндоскопических операций, удаляя на скорость желчный пузырь, но после третьего круга это начинало надоедать. Посидеть спокойно в интернете мне не дали. Каждые 15-20 минут вся беспроводная связь наглухо падала. Когда я решил пройтись по соседним стендам — я увидел тех странных людей, которые из кучи рассыпухи, километров медной проволоки и чьей-то матери собрали катушку Тесла и пару сопутствующих приборов. Именно эта вундервафля гадила во всех частотах при включении и роняла всю связь.

</p><iframe src="https://www.youtube.com/embed/0dV1uaBaDdQ?feature=oembed" frameborder="0" allowfullscreen="">VIDEO</iframe>
<p>
Я пытался снять этого уставшего человека, который в очередной раз показывал детям светящиеся газораздрядные трубки, но телефон начинал дико сходить с ума рядом с установкой, выбрасывая аппаратную ошибку камеры, а потом наглухо зависая. Планшет вроде выдержал, но файл слегка побило. Tesla Coil, штука конечно крутая, но проблему мою не решает. Зато на том же столе у них обнаружилась электрофорная машина с лейденскими банками. Именно такой машиной я пользовался еще в школе, чтобы зарядившись как следует бить током одноклассников в коридоре. Учительница физики страшно ругалась и кричала, чтобы я немедленно заземлялся на батарею. В общем, погрузил я один из электродов в кофе и начал вращать рукоятку. Судя по тому, что волосы начали тихо потрескивать — потенциал был набран ощутимый. Но сволочной порошок упорно не желал распушаться. Тут я сделал большую ошибку, решив добавить еще статики. Лейденские банки, которые они использовали были какими-то особо злыми. И очень-очень емкими. Красивая вспышка между моими руками оказалась крайне болезненной. Видимо, народ тщательно доработал конструкцию.
</p><p>
В итоге, от электрофорной машины я тоже отказался и решил сделать снимки как есть. Уже после того, как я отфотграфировал образцы, мне пришла в голову альтернативная идея, но времени на ее реализацию уже не было. Будет настроение — попробуйте. Смысл в том, чтобы одновременно использовать очень горячий воздух, трение и конвекцию. То есть тупо фен и трубу. Насыпаем чайную ложку кофе в трубу, влючаем фен, дожидаемся электризации и опускаем скотч на жестком каркасе внутрь, чтобы он насобирал частичек. Схема ниже:

</p><img src="https://habrastorage.org/files/873/6f5/e8e/8736f5e8ed95419ba4f3a7c716784f05.png"/>

<h4>Микроскоп и CellProfiler</h4>
<img src="https://habrastorage.org/files/a8c/1bb/3ee/a8c1bb3ee6d74430b4485ace8e872cde.jpg"/>
<p>
Получив свою порцию задумчивых взглядов со стороны коллег, торжественно идем к микроскопу, размахивая кусками скотча. Как оказалось, частицы кофе имеют интересную полупрозрачную структуру на большом увеличении:

</p><img src="https://habrastorage.org/files/52e/26a/c41/52e26ac418fd4539a761d972e79822fd.jpg"/>
<p>
К сожалению, наш микроскоп не поддерживает </p><a href="https://en.wikipedia.org/wiki/Focus_stacking">z-stacking</a><p>, и в EXIF не пишет достаточно данных, чтобы это сделать в стороннем софте. Поэтому глубина резкости небольшая и собрать из серии четкую картинку не получится.
</p><p>
В принципе, для наших целей нам нет необходимости в идеальной четкости. Поэтому берем объектив 4х и фотографируем наш будущий эспрессо:

</p><img src="https://habrastorage.org/files/63c/281/42e/63c28142e84d4e19b1ab8a9d1bbc133d.jpg"/>
<i>Образец от обжарщика, смолотый Mahlkoenig EKK43</i>

<img src="https://habrastorage.org/files/05d/87e/e52/05d87ee5200c49af84e9b0b59fe379b6.jpg"/>
<i>Образец из моей домашней кофемолки, смолотый DeLonghi KG89</i>
<p>
К сожалению, у нас что-то отвалилось во встроенной в микроскоп фотокамере и она начала дико шуметь. Я предположил, что сдох элемент Пелетье на матрице, но нормально остудить ее хладагентом не получилось. Поэтому второй кадр выглядит весьма побито из-за постфильтрации.
</p><p>
Теперь отдаем изображения на вход специализированого свободного ПО </p><a href="http://www.cellprofiler.org/">CellProfiler</a><p>. Переписан на Python, когда-то был надстройкой над MatLAB. Разрабатывается небольшой командой The Broad Institute of MIT and Harvard. Интерфейс совершенно негуманоидный, но позволяет исследователям вроде меня выполнять сложные пакетные обработки и статистический анализ изображений, не имея глубоких знаний в программировании. Все организовано в виде конвейера, когда на вход подается исходное изображение, потом над ним производятся необходимые манипуляции, распознаются, подсчитываются и измеряются нужные объекты, после чего цикл повторяется снова на всем массиве файлов. В результате, тратится определенное время на написание pipeline, зато потом можно скармливать хоть 100 000 изображений и идти пить чай. Процесс распараллеливается соответственно количеству потоков процессора. 

</p><img src="https://habrastorage.org/files/f86/168/586/f861685861a148198f5118e5b9e1bf21.png"/>
<i>Интерфейс программы</i>
<p>
Коротко опишу этапы:
</p><ol>
<li>Преобразование трех каналов 8-битного sRGB в один, монохромный</li>
<li>Инверсия изображения. Это историческая особенность — программа заточена под распознавание светлых объектов на темном фоне</li>
<li>Пороговая фильтрация для отсечения фона. Использовался глобальный порог, выбранный вручную</li>
<li>Идентификация объектов и их границ. Для сепарации объектов от фона использовался алгоритм Otsu</li>
<li>Измерение параметров объектов — площадь, эксцентриситет, диаметр и прочее</li>
<li>Классификация объектов на 3 условные группы по параметру «площадь»</li>
<li>Сохранение выбранных результатов таблицу и сохранение отдельных промежуточных изображений</li>
</ol>

<img src="https://habrastorage.org/files/599/a7d/46c/599a7d46c0674d72bfdd02a02deb6041.png"/>
<p>
Вот как выглядит идентификация объектов. Распознавание в нашем варианте далеко от идеала, так как не получилось разделить слипшиеся частицы. Согласно настройкам, алгоритм после отделения фона пытается найти объекты округлой формы.

</p><div class="spoiler"><b class="spoiler_title">Распознанные объекты, крупно. Видны дефекты определения границ</b></div>
<p>
После сортировки на мелкие, средние и крупные частицы мы получили следующее распределение для профессиональной и домашней кофемолки, соответственно:

</p><img src="https://habrastorage.org/files/70f/db7/2b5/70fdb72b5de8458cab56bd2a0be96c6a.png"/>
<img src="https://habrastorage.org/files/e6f/800/4e8/e6f8004e861d47cc91878b49ed0e9274.png"/>
<p>
Интерпретировать результаты я не буду, так как изначально образцы не соответствовали требованиям к разделению частиц. Если кому-то интересно повторить, я выложил pipeline для Cellprofiler на </p><a href="https://www.dropbox.com/s/rysmv7ly0bpqpra/coffee.cpproj?dl=0">Dropbox</a><p>. Вы можете проверить его самостоятельно. Визуально, помол на профессиональной машине более равномерный, но точнее сказать сложно. Очень высокие требования к образцам для нормальной статистики.

</p><h4>Другие варианты применения</h4><p>
CellProfiler'у глубоко пофиг, что именно рассчитывать. Я вполне успешно пилил пайплайны для анализа каких-то нанокристаллов. Ради интереса даже попробовал посмотреть, как он справится с определением объектов в астрофотографиях. В примере ниже я просто скормил софту фото звездного неба в высоком разрешении и свел все каналы в один монохромный. Теоретически, играясь с фильтрами и порогами интенсивности, можно отделить звезды различных спектральных классов друг от друга. Особенно, если исходники не 8-битные. Программа нативно поддерживает работу с изображениями широкого динамического диапазона.
</p><p>
Исходник, немного пожатый Habrastorage:

</p><img src="https://habrastorage.org/files/5dd/e1b/2dc/5dde1b2dccaa42c8b8096e9e776d3411.jpg"/>
<p>
А вот честно определенные 34767 звезд с некоторой долей погрешности.

</p><img src="https://habrastorage.org/files/1aa/75f/f7f/1aa75ff7f4094c748473abf5545e92b8.png"/>
<p>
При дальнейшем анализе можно анализировать коэффициент соседства, использовать маски, сортировать по признакам площади, цвета или еще чего-то.

</p><h4>Как сварить кофе в лаборатории</h4><p>
Хорошо подумав с Дианой, мы решили, что пропадать нашему любимому сорту </p><a href="http://www.torrefacto.ru/catalog/roasted/guatemala-platanillo-egipto/">Гватемала Платанийо Ежипто</a><p> просто так не стоит. Я его дико люблю за насыщенность и полноту в эспрессо, с дразнящими нотами зрелого какао и легкой кислинкой. Один из самых ярких сортов средней степени обжарки, на мой взгляд. Тем более, когда он обжарен несколько дней назад. Но раз уж мы начали тестирование образцов, то решили попробовать альтернативный подход к приготовлению кофе. Будем варить его на прецизионном лабораторном нагревателе с магнитной мешалкой. Главное не получить потом по голове от руководителя лаборатории.
</p><p>
В этом мне поможет Диана  </p><a href="https://habrahabr.ru/users/in_green_shoes/" class="user_link">in_green_shoes</a><p>. Она вообще-то лингвист-переводчик, но иногда, когда ее никто не видит, она надевает халат и делает умный вид, играя в ученого. 

</p><img src="https://habrastorage.org/files/c8a/0f1/c37/c8a0f1c37add4f28b859dd6ea1715fc2.jpg"/>
<p>
Вначале набираем деионизированной воды из Milli-Q. По сопротивлению — глухой изолятор с сопротивлением 18.2 MΩ·cm Вода такой чистоты используется для аналитической химии, молекулярной биологии и теперь для варки кофе. 

</p><div class="spoiler"><b class="spoiler_title">Диана с умным видом разглядывает колбу с водой</b></div><p>
Теперь надо внимательно осмотреть образец. И подружиться с ним. Ведь это друг-кофейный порошок. Этот сорт ее особенно радует, да.

</p><img src="https://habrastorage.org/files/642/9b7/134/6429b71340c44978a5937cd76f5cde9e.jpg"/>
<img src="https://habrastorage.org/files/bd1/ca0/69b/bd1ca069bb9e4e86b0417d621e180e0d.jpg"/>
<p>
Точно взвешиваем нужное количество кофе. Точно взвешиваем. Четыре знака после запятой будет достаточно, я думаю. Мы же в лаборатории все-таки.

</p><img src="https://habrastorage.org/files/78a/2bd/412/78a2bd412eb6401faba1f7e03ffff236.jpg"/>
<p>
Высыпаем кофе в колбу и бросаем туда неодимовый магнит в керамической оболочке. В процессе варки он будет вращаться со скоростью около 1000 оборотов в минуту, обеспечивая максимальную экстракцию.

</p><img src="https://habrastorage.org/files/a67/2ad/588/a672ad58845840a9889af8280e1ec384.jpg"/>
<img src="https://habrastorage.org/files/382/7c2/7d1/3827c27d1b5147ab982ffa1cec5d0514.jpg"/>
<p>
А вот и сам нагреватель. По идее, надо еще и датчик обратной связи в кофе окунуть, но его до этого использовали с чем-то токсичным, а терпеливо ожидать, не отвалится ли чего не хочется. Поэтому решили обойтись вариантом попроще. Просто выставляем 320 градусов для первичного нагрева и снижаем температуру до 97 перед самым закипанием. Магнитная мешалка вращается как ненормальная, обеспечивая непрерывное перемешивание.

</p><img src="https://habrastorage.org/files/c0a/191/ab5/c0a191ab54f848f3838130cd99baf7aa.jpg"/>
<img src="https://habrastorage.org/files/cf4/cc6/370/cf4cc63709ad47469b889f0c674672eb.jpg"/>
<p>
Поднятие пены ловим точно так же, как и с классической туркой:

</p><img src="https://habrastorage.org/files/3da/a63/a1d/3daa63a1d6244dd18d3775041ea5a417.jpg"/>
<p>
В итоге получаем ожоги из-за того, что забыли о нагревании горла колбы от горячего пара. При следующей попытке используем толстые перчатки и аккуратно разливаем результат по чашкам. Кофе получился ароматным, но очень уж высокоэкстрагированным. Глаза резко открываются и начинаешь бегать как кофеиновая белка. Метод на самом деле из разряда just for fun, но почему бы и не попробовать? Ну и в качестве бонуса я добавлю еще фотографий из этого фотосета)
 
</p><div class="spoiler"><b class="spoiler_title">Мне кажется, кофе на нее как-то странно влияет</b></div>
<p>
P.S. Я все-таки сумел связаться с ребятами из Торрефакто, обещали выкроить время, чтобы ответить на вопросы. У них на самом деле много разной высокотехнологической фигни. Один только фотоколориметр для точного определения цвета зерна чего стоит. Это, например, важный момент при объективной оценке степени обжарки. Если будет интересно — я попробую найти время для того, чтобы рассказать об этих вещах.

      
      </p><p class="clear"/>
    </div>

    
  </div></body></html>