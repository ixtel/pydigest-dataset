<html><body><div><div class="post_content entry-content">
  					<h2>Too Long; Did Not Read</h2>
<p>
Skip to code samples below to see how to use Amazon’s Mechanical Turk in order to crowdsource small tasks for very cheap.  You can automate as much as possible and outsource the remaining human tasks to a large crowd.
</p>
<p>
Source code is below.  Also, a ridiculous sample is shown.
</p>
<h2>True Story Follows</h2>
<p>
So, as has been the case with my last few blog posts, I’m on the grind with <a href="http://exercise-library.com">Exercise Library</a>.  There’s a whole back story to it and a number of things where I’ve been using code to automate some of the tasks that need to be done.
</p>
<p>
Long story short, I re-filmed several hundred exercises, each from two different angles.  I need to edit each “scene” which is composed of two shots, and each shot needs to be trimmed of dead space in the beginning and end.  Moreover, not every video is framed very well, so I need to crop each video.
</p>
<p>
However, this is extremely tedious.  Aside from the tasks above, I still need to manually load and render each set of videos.  The rate at which I was editing was only about 10 videos per hour.  For the 700 total exercises I needed to get done, this was going to take me 70 hours, or basically a week straight of just editing videos, assuming I had enough free time to begin with.
</p>
<p>
I looked online at sites like Fiverr to find people that might be willing to edit videos for really really cheap, but, alas, they basically don’t exist.  However, I suddenly had an idea while my mind was wandering and walking my two dogs, Bonethug and Snuggles.
</p>
<p>
I bet there was a site that allowed me to crowdsource really small tasks (Ah, this does exist. Amazon Mechanical Turk, among others).  For each video, I can divide up all of the actions I need to take on the video into its own task: frame the video properly, find the actual start point, find the actual end point.  I could pay a few cents to each action, then write a script that will actually execute all of those instructions on all of my videos using OpenCV.
</p>
<h2>But Scott, You’re Not Crazy Enough</h2>
<p>
I am crazy enough.
</p>
<h2>What is Mechanical Turk?</h2>
<p>
<a href="https://www.mturk.com/mturk/welcome" target="_blank">Mechanical Turk</a> is a crowdsourcing market place hosted by Amazon.  You can use it to have people take surveys, maybe describe a picture…basically anything that isn’t morally questionable.  And by morally questionable, I mean driving traffic to your site or something.  Labeling pornographic images is fine.  Machine Learning.  Read about it.
</p>
<p>
Without looking at other forums, the site would lead you to believe that you primarily use Amazon’s user interface to create tasks, but if you’re reading this blog, then you, like me, are far more interested in their API and doing as much as possible with programming.
</p>
<h2>What the Docs Don’t Tell You</h2>
<p>
Before going onto wild tangents while I explain code, and to help anyone that possibly stumbled here in the troubleshooting process, Amazon’s documentation is not very thorough, and it took some trial and error to get things working.  Some helpful things to know if you’re using an external website to perform tasks:</p>
<ul>
<li>When POSTing back to Amazon to complete a Human Intelligence Task (HIT), you MUST make it from straight from the client.  Server side POSTs will be rejected.</li>
<li>Amazon’s documentation tells you that you just need to post the “assignmentId”.  This is false, you need the “hitId” and the “workerId” as well</li>
<li>Limiting a user to only one task is not a built in feature.  You need to add your own logic to enforce that rule.</li>
<li>I believe that when you have a group of HIT’s, all HIT’s in that group will be locked as long as one person is viewing them.  I could be wrong, but if true, that might slow down task execution.</li>
</ul>
<h2>Sample Walk-Through</h2>
<p>
I could break this out into code and a demo separately, but you sort of lose context, so let’s do all at once.
</p>
<p>
Suppose I want to farm out some arbitrary task.  It turns out that this task can be pretty much anything, but if you want that sort of power and flexibility, the way to do is to create an “external question,” which basically means that an iFrame will load your separate website, and your website will POST back to Amazon.
</p>
<p>
So let’s set up a really simple demo.  There’s a development sandbox where you have an infinite budget, and then you can easily switch over to a production environment.  I tested everything initially, but I’ll walk through the example in production.
</p>
<p><a href="http://scottlobdell.me/wp-content/uploads/2015/03/Screen-Shot-2015-03-09-at-11.59.49-PM.png"><img src="http://scottlobdell.me/wp-content/uploads/2015/03/Screen-Shot-2015-03-09-at-11.59.49-PM-300x260.png" alt="Screen Shot 2015-03-09 at 11.59.49 PM" class="alignnone size-medium wp-image-1214"/></a></p>
<p>
Sign up on Mechanical Turk as a requestor.  There’s tons of resources on the internets about making money online and signing up as a worker.  But we’re the producers, the big ballers that drop mad nickels on the economy and make things happen, paying out $2 in just a few minutes distributed across dozens of people.  So we’ll talk about that angle.  You pretty much just authenticate with Amazon, ensure you have an Amazon Developer Console, and add some funds to your account.  The same can be done in the Sandbox.
</p>
<p>
To paint a picture of what I’m doing, I basically crowdsourced an arbitrary task.  In this case, I took some awkward and ridiculous pictures of my roommate from back at the Academy, and asked workers to describe the man.  See below:<br/>
<a href="http://scottlobdell.me/wp-content/uploads/2015/03/Screen-Shot-2015-03-09-at-9.30.06-PM.png"><img src="http://scottlobdell.me/wp-content/uploads/2015/03/Screen-Shot-2015-03-09-at-9.30.06-PM.png" alt="Screen Shot 2015-03-09 at 9.30.06 PM" class="alignnone size-medium wp-image-1216"/></a>
</p>
<p>
Let’s go ahead and get additional context by scrolling down further:
</p>
<p><a href="http://scottlobdell.me/wp-content/uploads/2015/03/Screen-Shot-2015-03-10-at-12.09.18-AM.png"><img src="http://scottlobdell.me/wp-content/uploads/2015/03/Screen-Shot-2015-03-10-at-12.09.18-AM.png" alt="Screen Shot 2015-03-10 at 12.09.18 AM" class="alignnone size-medium wp-image-1218"/></a></p>
<p>
For the code, there’s really two parts to this.  In this case, for the simple aspect of demonstration, below is a quick script that will generate some tasks.  This is only usable because I’ve already written the server side code (bear with me).
</p>
<p>
</p><div>
<pre><span>import</span> <span>os</span>
<span>from</span> <span>boto.mturk.connection</span> <span>import</span> <span>MTurkConnection</span>
<span>from</span> <span>boto.mturk.question</span> <span>import</span> <span>ExternalQuestion</span>
<span>from</span> <span>boto.mturk.price</span> <span>import</span> <span>Price</span>

<span>AWS_ACCESS_KEY_ID</span> <span>=</span> <span>os.environ[</span><span>'AWS_ACCESS_KEY_ID'</span><span>]</span>
<span>AWS_SECRET_ACCESS_KEY</span> <span>=</span> <span>os.environ[</span><span>'AWS_SECRET_ACCESS_KEY'</span><span>]</span>

<span>if</span> <span>os.environ.get(</span><span>"I_AM_IN_DEV_ENV"</span><span>):</span>
    <span>HOST</span> <span>=</span> <span>'mechanicalturk.sandbox.amazonaws.com'</span>
<span>else</span><span>:</span>
    <span>HOST</span> <span>=</span> <span>'mechanicalturk.amazonaws.com'</span>

<span>connection</span> <span>=</span> <span>MTurkConnection(aws_access_key_id=AWS_ACCESS_KEY_ID,</span>
                             <span>aws_secret_access_key=AWS_SECRET_ACCESS_KEY,</span>
                             <span>host=HOST)</span>

<span>url</span> <span>=</span> <span>"https://mturk-demonstration.herokuapp.com/"</span>
<span>title</span> <span>=</span> <span>"Describe a picture in your own words (COMPLETE THIS TASK ONLY ONCE!)"</span>
<span>description</span> <span>=</span> <span>"COMPLETE THIS TASK ONLY ONCE! All submissions after the first will be rejected"</span>
<span>keywords</span> <span>=</span> <span>[</span><span>"easy"</span><span>]</span>
<span>frame_height</span> <span>=</span> <span>800</span>
<span>amount</span> <span>=</span> <span>0.05</span>

<span>questionform</span> <span>=</span> <span>ExternalQuestion(url,</span> <span>frame_height)</span>


<span>for</span> <span>_</span> <span>in</span> <span>xrange</span><span>(</span><span>60</span><span>):</span>
    <span>create_hit_result</span> <span>=</span> <span>connection.create_hit(</span>
        <span>title=title,</span>
        <span>description=description,</span>
        <span>keywords=keywords,</span>
        <span>max_assignments=</span><span>1</span><span>,</span>
        <span>question=questionform,</span>
        <span>reward=Price(amount=amount),</span>
        <span>response_groups=(</span><span>'Minimal'</span><span>,</span> <span>'HITDetail'</span><span>),</span>  <span># I don't know what response groups are</span>
    <span>)</span>
</pre>
</div>
<p>
Credits to <a href="http://kaflurbaleen.blogspot.com/2014/06/in-which-i-battle-mturk-external-hits.html">this blog</a> for the code sample that got me started.
</p>
<p>
All that’s happening here is that we’re creating Human Intelligence Tasks that simply redirect to my website: <a href="https://mturk-demonstration.herokuapp.com/" rel="nofollow">https://mturk-demonstration.herokuapp.com/</a>.  Also, there’s no guarantee that the link I just posted will live forever, I just threw together a quick Heroku App.
</p>
<h2>Server Side Code</h2>
<p>
Here’s my server side (Django) code:
</p>
<p>
</p><div>
<pre><span>if</span> <span>os.environ.get(</span><span>"I_AM_IN_DEV_ENV"</span><span>):</span>
    <span>AMAZON_HOST</span> <span>=</span> <span>"https://workersandbox.mturk.com/mturk/externalSubmit"</span>
<span>else</span><span>:</span>
    <span>AMAZON_HOST</span> <span>=</span> <span>"https://www.mturk.com/mturk/externalSubmit"</span>


<span>def</span> <span>home</span><span>(request):</span>
    <span>if</span> <span>request.GET.get(</span><span>"assignmentId"</span><span>)</span> <span>==</span> <span>"ASSIGNMENT_ID_NOT_AVAILABLE"</span><span>:</span>
        <span># worker hasn't accepted the HIT (task) yet</span>
        <span>pass</span>
    <span>else</span><span>:</span>
        <span># worked accepted the task</span>
        <span>pass</span>

    <span>worker_id</span> <span>=</span> <span>request.GET.get(</span><span>"workerId"</span><span>,</span> <span>""</span><span>)</span>
    <span>if</span> <span>worker_id</span> <span>in</span> <span>get_worker_ids_past_tasks():</span>
        <span># you might want to guard against this case somehow</span>
        <span>pass</span>

    <span>render_data</span> <span>=</span> <span>{</span>
        <span>"worker_id"</span><span>:</span> <span>request.GET.get(</span><span>"workerId"</span><span>,</span> <span>""</span><span>),</span>
        <span>"assignment_id"</span><span>:</span> <span>request.GET.get(</span><span>"assignmentId"</span><span>,</span> <span>""</span><span>),</span>
        <span>"amazon_host"</span><span>:</span> <span>AMAZON_HOST,</span>
        <span>"hit_id"</span><span>:</span> <span>request.GET.get(</span><span>"hitId"</span><span>,</span> <span>""</span><span>),</span>
    <span>}</span>

    <span>response</span> <span>=</span> <span>render_to_response(</span><span>"base.html"</span><span>,</span> <span>render_data)</span>
    <span># without this header, your iFrame will not render in Amazon</span>
    <span>response[</span><span>'x-frame-options'</span><span>]</span> <span>=</span> <span>'this_can_be_anything'</span>
    <span>return</span> <span>response</span>
</pre>
</div>
<p>
A few things to note that I have commented:</p>
<ul>
<li>Host endpoints vary based on production/sandbox</li>
<li>You’ll need assignment ID, worker ID, and hit ID in order to POST back to Amazon (despite what docs say)</li>
<li>Assignment ID will have the value “ASSIGNMENT_ID_NOT_AVAILABLE” if the worker is just viewing the task (it would be a good idea to hide the submit button or something so they don’t do unnecessary work and get frustrated)</li>
<li>Your page won’t render unless you modify the “x-frame-options” header.  Any value I used gave Javascript errors, but the errors caused it to ignore the header, which is pretty much what I wanted instead of “DENY”</li>
<li>If your task happens to be like the one I described where it’s the same for everyone, you’ll want to guard against the same worker executing the same task repeatedly.</li>
</ul>
<h2>Client Side Code</h2>
<p>
Initially, I built out a more extensive template with some Javascript and AJAX that posted to my server to collect some data, which then posted to Amazon.  The reason was that even though this example is simple, I was going to do some far more extensive stuff down the line.  However, I found through some forums and verified from trial and error that Amazon will only accept requests directly from the client.  So your best bet is to just write a simple template.  Here’s mine:
</p>
<p>
</p><div>
<pre><span>&lt;html&gt;</span>
    <span>&lt;head&gt;</span>
        <span>{%</span> <span>include</span> <span>"_js_scripts.html"</span> <span>%}</span>
    <span>&lt;/head&gt;</span>
    <span>&lt;body&gt;</span>
    <span>&lt;h3&gt;Using</span> <span>your</span> <span>own</span> <span>words,</span> <span>describe</span> <span>this</span> <span>man</span> <span>however</span> <span>you</span> <span>want.&lt;/h3&gt;</span>
        <span>&lt;form</span> <span>action=</span><span>"{{ amazon_host }}"</span> <span>method=</span><span>"POST"</span><span>&gt;</span>
            <span>&lt;textarea</span> <span>rows=</span><span>"4"</span> <span>cols=</span><span>"50"</span> <span>name=</span><span>"user-input"</span><span>&gt;</span>
            <span>&lt;/textarea&gt;</span>
            <span>&lt;</span><span>input</span> <span>type</span><span>=</span><span>"hidden"</span> <span>id</span><span>=</span><span>"assignmentId"</span> <span>value=</span><span>"{{ assignment_id }}"</span> <span>name=</span><span>"assignmentId"</span><span>/&gt;</span>
            <span>&lt;br/&gt;</span>
            <span>&lt;</span><span>input</span> <span>type</span><span>=</span><span>"hidden"</span> <span>id</span><span>=</span><span>"workerId"</span> <span>value=</span><span>"{{ worker_id }}"</span> <span>name=</span><span>"workerId"</span><span>/&gt;</span>
            <span>&lt;</span><span>input</span> <span>type</span><span>=</span><span>"hidden"</span> <span>id</span><span>=</span><span>"hitId"</span> <span>value=</span><span>"{{ hit_id }}"</span> <span>name=</span><span>"hitId"</span><span>/&gt;</span>
            <span>&lt;</span><span>input</span> <span>type</span><span>=</span><span>"submit"</span><span>&gt;</span>
        <span>&lt;/form&gt;</span>
        <span>&lt;div&gt;</span>
            <span>&lt;img</span> <span>src=</span><span>"https://s3.amazonaws.com/lobbdawg/mturk/broome1.jpg"</span> <span>style=</span><span>"width: 30%;"</span><span>&gt;</span>
            <span>&lt;img</span> <span>src=</span><span>"https://s3.amazonaws.com/lobbdawg/mturk/broome2.jpg"</span> <span>style=</span><span>"width: 30%;"</span><span>&gt;</span>
            <span>&lt;img</span> <span>src=</span><span>"https://s3.amazonaws.com/lobbdawg/mturk/broome3.jpg"</span> <span>style=</span><span>"width: 30%;"</span><span>&gt;</span>
            <span>&lt;img</span> <span>src=</span><span>"https://s3.amazonaws.com/lobbdawg/mturk/broome4.jpg"</span> <span>style=</span><span>"width: 30%;"</span><span>&gt;</span>
            <span>&lt;img</span> <span>src=</span><span>"https://s3.amazonaws.com/lobbdawg/mturk/broome5.jpg"</span> <span>style=</span><span>"width: 30%;"</span><span>&gt;</span>
            <span>&lt;img</span> <span>src=</span><span>"https://s3.amazonaws.com/lobbdawg/mturk/broome6.jpg"</span> <span>style=</span><span>"width: 30%;"</span><span>&gt;</span>
        <span>&lt;/div&gt;</span>
    <span>&lt;/body&gt;</span>
<span>&lt;/html&gt;</span>
</pre>
</div>
<h2>Putting It All Together</h2>
<p>
When I post a task as a requestor, I can see it has been created:
</p>
<p><a href="http://scottlobdell.me/wp-content/uploads/2015/03/Screen-Shot-2015-03-09-at-9.30.20-PM.png"><img src="http://scottlobdell.me/wp-content/uploads/2015/03/Screen-Shot-2015-03-09-at-9.30.20-PM.png" alt="Screen Shot 2015-03-09 at 9.30.20 PM" class="alignnone size-medium wp-image-1232"/></a></p>
<p>
From Amazon, I can use their frustrating interface to see all of my batches which are counter-intuitively at 0, and then click the not so obvious “Mange HITs Individually” to get some actual data:
</p>
<p><a href="http://scottlobdell.me/wp-content/uploads/2015/03/Screen-Shot-2015-03-09-at-9.17.44-PM.png"><img src="http://scottlobdell.me/wp-content/uploads/2015/03/Screen-Shot-2015-03-09-at-9.17.44-PM.png" alt="Screen Shot 2015-03-09 at 9.17.44 PM" class="alignnone size-medium wp-image-1230"/></a></p>
<p>
Then for whatever reason, I can only review tasks individually, which kind of defeats the purpose of crowdsourcing:
</p>
<p><a href="http://scottlobdell.me/wp-content/uploads/2015/03/Screen-Shot-2015-03-09-at-9.18.23-PM.png"><img src="http://scottlobdell.me/wp-content/uploads/2015/03/Screen-Shot-2015-03-09-at-9.18.23-PM.png" alt="Screen Shot 2015-03-09 at 9.18.23 PM" class="alignnone size-medium wp-image-1231"/></a></p>
<p>
So we need some more code.  One more sample for how to manipulate HITs with Python:
</p>
<p>
</p><div>
<pre><span>all_hits</span> <span>=</span> <span>[hit</span> <span>for</span> <span>hit</span> <span>in</span> <span>connection.get_all_hits()]</span>

<span>for</span> <span>hit</span> <span>in</span> <span>all_hits:</span>
    <span>assignments</span> <span>=</span> <span>connection.get_assignments(hit.HITId)</span>
    <span>for</span> <span>assignment</span> <span>in</span> <span>assignments:</span>
        <span># don't ask me why this is a 2D list</span>
        <span>question_form_answers</span> <span>=</span> <span>assignment.answers[</span><span>0</span><span>]</span>
        <span>for</span> <span>question_form_answer</span> <span>in</span> <span>question_form_answers:</span>
            <span># "user-input" is the field I created and the only one I care about</span>
            <span>if</span> <span>question_form_answer.qid</span> <span>==</span> <span>"user-input"</span><span>:</span>
                <span>user_response</span> <span>=</span> <span>question_form_answer.fields[</span><span>0</span><span>]</span>
                <span>print</span> <span>user_response</span>
                <span>print</span> <span>"\n"</span>
        <span># connection.approve_assignment(assignment.AssignmentId)</span>
</pre>
</div>
<h2>Results</h2>
<p>
This post of course, would not be complete without the results of the crowdsourcing.  All in all, I spent $3.  If that.  I’m not sure if all the tasks got completed.  But here are the responses that I got from all the workers for the above task:
</p>
<ul>
<li>Eclectic. Mustachioed. Interesting. ‘Murican.</li>
<li>The man in the picture is of average height and weight but muscular build from working out. He has dark hair and sometimes facial hair but not always.  He has lived a life of adventure.  He is not afraid to take risks and can be the life of the party but tires at the end of the day just like the rest of us.  He interacts well with different people including children.  He has many varied interests from cars to vacationing.  He is confident and proud.</li>
<li>Diverse. Looks like he knows how to have fun but also how to be serious. Soldier. Silly. Strong. </li>
<li>amazing</li>
<li>Sociable, outgoing, and always busy/occupied</li>
<li>This man is jolly type and hard worker. he enjoys the nature everthing.Children like him somuch because always like as freind to children.</li>
<li>Outgoing and fun.</li>
<li>1. Suburb Perv<br/>
2. Phelps Wannabe<br/>
3. Cool Vet and Prince look-a-like<br/>
4. Career Day Vet<br/>
5. Leprechaun Pimp<br/>
6. 4 hrs 3 minutes and 30 seconds clean Guy</li>
<li>This man knows how to live life. He is at one with himself and knows what it means to be a real man and a hero. </li>
<li>A fun guy that enjoys having a good time.</li>
<li>It’s like if the “Most Interesting Man in the World” became a hipster that tries too hard</li>
<li>This man is looking handsome. He is brave and honest. He looks like an army soldier.</li>
<li>wove</li>
<li>nice</li>
<li>Active and sense of humor. </li>
<li>Looks like he wants to promote bikini, so he approaches a manufacturer to give him a chance to promote their bikini but he refuses and instead offer him to promote his company in school and mall with different type of costumes.End of the day he is exhausted and taking a nap on the table.</li>
<li>nice</li>
<li>Good handsome guy serving his nation with pride.
</li>
<li>Hardworking solider who enjoys his free time.</li>
<li>The man is athletic, outgoing, a patroit, and enjoys vintage automobiles.</li>
<li>outgoing, a soldier, doesn’t take himself to seriously, good sense of humor</li>
<li>Goofy, oddball, patriot, soldier, friendly, off beat, unique, strange, funny.</li>
<li>good look
</li>
<li>freeness</li>
</ul>
<p><a href="http://scottlobdell.me/wp-content/uploads/2015/03/broome_0.jpg"><img src="http://scottlobdell.me/wp-content/uploads/2015/03/broome_0.jpg" alt="broome_0" class="alignnone size-medium wp-image-1240"/></a></p>
<ul>
<li>Adventurous extrovert with well rounded social life.</li>
<li>This person appears to be someone who likes to have fun and doesn’t take himself too seriously. However, he also seems to have a serious side that is dedicated to the causes in which he believes.</li>
<li>he is a man of many disguises, seems to have a sense of humor and likes to stand out in a crowd.</li>
<li>Sleepy. Furry. Half-naked. Touching a sweet car.</li>
<li>he seems to be a military man who wears what he wants to wear regardless of what people will think of him</li>
<li>goodreads</li>
<li>An active, social, healthy and handsome man</li>
<li>Soldier. Silly. Strong. Knows how to be serious but how to have fun. </li>
<li>super style
</li>
<li>CRAZY, JOKESTER WHO ENJOYS MAKING OTHERS LAUGH, WHILE STILL HAVING A SERIOUS SIDE AND SERVING OUR COUNTRY</li>
<li>Soldier from the south in some interesting getup.</li>
<li>Adventurous, funny, caring, selfless </li>
<li>Outgoing</li>
<li>extrovert, social, funny, helpful, service oriented, stylish, hard working</li>
<li>He is a sexy and versatile man!</li>
<li>He is the all american type of guy. </li>
<li>This dude is a soldier who makes time to talk to kids but definitely knows how to enjoy his down time to the fullest. Also, he gets sleepy sometimes.</li>
<li>Very outgoing. Not afraid about what others might think of him.</li>
<li>This man is part of the military. He is in good physical shape. These photos are not of the same man. The man in the green fuzzy suit is not the same man on the beach.</li>
<li>He is a veteran of the armed forces. When he’s not serving our country he likes to have fun by restoring vintage cars, hanging out at the beach and going to parties. He is a charitable man who likes to help out with children at their school and help out at fundraisers. Sometimes he pushes himself too hard and gets tired.</li>
<li>adventurous, fun</li>
<li>Party animal, fun-loving, good person. Bumpkin, hard worker, fun.</li>
<li>Outgoing</li>
<li>He seems like a ridiculous man. He does silly things and wears weird clothes.</li>
<li>He seems fun,with a great personality and a humanitarian.</li>
<li>funny, energetic, fun, happy, exciting, positive, partier</li>
<li>This is Tim. He’s not afraid to take risks and enjoy life by posing in bizarre pictures. He stays out late and hits up the nightlife and is known for wearing odd clothes on occasion. Tim has an above-average respect for the armed forces. His active social life allows him to be in constant contact with the public.</li>
<li>This man is responsible yet outgoing.  He loves to have fun but he knows how to control himself.</li>
</ul>
  					<p class="clear"/>
 			 </div>	
			 
					   					</div></body></html>