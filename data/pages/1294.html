<html><body><div><div class="post-content mb2 blue-links">
            
            <p>At <a href="http://monetate.com">Monetate</a>, we serve a lot of content. To handle it all, our pipeline for processing requests has to be fast and therefore it is difficult to introduce any time-consuming processing directly into the response-handling path. Some lengthy processes can be triggered offline (for example, long-running reports), or can be cached in various ways (via <a href="https://developer.akamai.com/stuff/Caching/Content_Caching.html">Akamai Edge caching</a> or local <a href="http://nginx.com/resources/admin-guide/caching/">nginx content caching</a>). This deals with the bulk of the problem.</p>
<p>But some content is dynamic. For example, <a href="http://www.monetate.com/products/email/">Monetate personalized email campaigns</a> can generate targeted images for users. Handling requests for this sort of content can take advantage of some of the traditional caching methods mentioned above but there are situations in which contentgeneration might take far too long — 2 seconds, or even longer — to be able to handle inline with normal request processing. The extra time could be spent inside lengthy image-processing routines or spent bottlenecked by the response times of other third-party servers. To keep the user experience uniform and speedy we need a better way of handling these sorts of delays.</p>
<h2 id="cache-control-extensions">Cache Control Extensions</h2>
<p><a href="http://tools.ietf.org/html/rfc5861">RFC 5861</a> describes two HTTP cache-control extensions for stale content. We are most interested in <code>stale-while-revalidate</code> which allows us to quickly continue serving (slightly) stale content while simultaneously triggering a background refresh on the server. In exchange for tolerating slightly out of date content on a small percentage of requests we get incredibly fast response times on all requests. Subsequent requests for the same content will begin responding with fresher data once background processing completes. Clients implementing this extension can help “hide” any requests that occur during the “stale” time period (and still show the older content) but enable the server the chance to kick off any backend processing that might be necessary to generate fresher content.</p>
<h2 id="server-side-swr">Server-Side <code>Stale-While-Revalidate</code></h2>
<p>We can’t rely on robust client support though. Especially not in the email world. A similar strategy can be implemented on the server regardless of the client’s caching behavior in order to get the same benefit. Monetate uses <a href="http://cherrypy.org/">CherryPy</a> extensively for serving various types of content and we can implement this pattern quite readily with some straightforward Python. Let’s start with a simple server that responds to requests with an image file. In our example let’s assume the processing time required to generate the image is a big bottleneck which taked several seconds:</p>
<p/>

		<div id="crayon-56d5c6c95163e108406127" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-56d5c6c95163e108406127-1">1</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c95163e108406127-2">2</p><p class="crayon-num" data-line="crayon-56d5c6c95163e108406127-3">3</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c95163e108406127-4">4</p><p class="crayon-num" data-line="crayon-56d5c6c95163e108406127-5">5</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c95163e108406127-6">6</p><p class="crayon-num" data-line="crayon-56d5c6c95163e108406127-7">7</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c95163e108406127-8">8</p><p class="crayon-num" data-line="crayon-56d5c6c95163e108406127-9">9</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c95163e108406127-10">10</p><p class="crayon-num" data-line="crayon-56d5c6c95163e108406127-11">11</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c95163e108406127-12">12</p><p class="crayon-num" data-line="crayon-56d5c6c95163e108406127-13">13</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c95163e108406127-14">14</p><p class="crayon-num" data-line="crayon-56d5c6c95163e108406127-15">15</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c95163e108406127-16">16</p><p class="crayon-num" data-line="crayon-56d5c6c95163e108406127-17">17</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c95163e108406127-18">18</p><p class="crayon-num" data-line="crayon-56d5c6c95163e108406127-19">19</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c95163e108406127-20">20</p><p class="crayon-num" data-line="crayon-56d5c6c95163e108406127-21">21</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c95163e108406127-22">22</p><p class="crayon-num" data-line="crayon-56d5c6c95163e108406127-23">23</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5c6c95163e108406127-1"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-k ">time</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c95163e108406127-2"> </p><p class="crayon-line" id="crayon-56d5c6c95163e108406127-3"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">cherrypy</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c95163e108406127-4"> </p><p class="crayon-line" id="crayon-56d5c6c95163e108406127-5"><span class="crayon-v">GIF</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-s">'GIF89a'</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c95163e108406127-6"><span class="crayon-h">    </span><span class="crayon-s">'\x01\x00\x01\x00\x80\xff\x00\xff\xff\xff\x00\x00\x00\x2c\x00\x00'</span></p><p class="crayon-line" id="crayon-56d5c6c95163e108406127-7"><span class="crayon-h">    </span><span class="crayon-s">'\x00\x00\x01\x00\x01\x00\x00\x02\x02\x44\x01\x00\x3b\x00'</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c95163e108406127-8"> </p><p class="crayon-line" id="crayon-56d5c6c95163e108406127-9"><span class="crayon-t">class</span><span class="crayon-h"> </span><span class="crayon-e">Server</span><span class="crayon-sy">(</span><span class="crayon-k ">object</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c95163e108406127-10"><span class="crayon-h">    </span><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">generate_image_file</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5c6c95163e108406127-11"><span class="crayon-h">        </span><span class="crayon-c"># simulate bottleneck</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c95163e108406127-12"><span class="crayon-h">        </span><span class="crayon-k ">time</span><span class="crayon-sy">.</span><span class="crayon-e">sleep</span><span class="crayon-sy">(</span><span class="crayon-cn">3</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c6c95163e108406127-13"><span class="crayon-h">        </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">GIF</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c95163e108406127-14"><span class="crayon-e">    </span><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">index</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5c6c95163e108406127-15"><span class="crayon-h">        </span><span class="crayon-v">thing</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">generate_image_file</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c95163e108406127-16"><span class="crayon-h">        </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">thing</span></p><p class="crayon-line" id="crayon-56d5c6c95163e108406127-17"><span class="crayon-e">    </span><span class="crayon-v">index</span><span class="crayon-sy">.</span><span class="crayon-v">exposed</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">True</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c95163e108406127-18"> </p><p class="crayon-line" id="crayon-56d5c6c95163e108406127-19"><span class="crayon-v">cherrypy</span><span class="crayon-sy">.</span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-e">update</span><span class="crayon-sy">(</span><span class="crayon-sy">{</span><span class="crayon-s">'server.max_queue_size'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c95163e108406127-20"><span class="crayon-v">cherrypy</span><span class="crayon-sy">.</span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-e">update</span><span class="crayon-sy">(</span><span class="crayon-sy">{</span><span class="crayon-s">'server.thread_pool'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c6c95163e108406127-21"><span class="crayon-v">cherrypy</span><span class="crayon-sy">.</span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-e">update</span><span class="crayon-sy">(</span><span class="crayon-sy">{</span><span class="crayon-s">'server.socket_port'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">8010</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c95163e108406127-22"><span class="crayon-v">cherrypy</span><span class="crayon-sy">.</span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-e">update</span><span class="crayon-sy">(</span><span class="crayon-sy">{</span><span class="crayon-s">'server.socket_host'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">'0.0.0.0'</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c6c95163e108406127-23"><span class="crayon-v">cherrypy</span><span class="crayon-sy">.</span><span class="crayon-e">quickstart</span><span class="crayon-sy">(</span><span class="crayon-e">Server</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p/>
<p>All requests to <a href="http://localhost:8010">http://localhost:8010</a> will hang for three seconds due to the simulated bottleneck. In order to serve stale content from the cache we simply need to expand the request handling to return cache headers and only deal with the expensive processing bottleneck when the TTL for the image has expired. Some synchronization must be added (a semaphore from the Python threading module) in order to make sure only one request handler is responsible for refreshing the cache when it becomes stale. This avoids a potential stampede of requests when the TTL expires.</p>
<p/>

		<div id="crayon-56d5c6c951650406189969" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-56d5c6c951650406189969-1">1</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951650406189969-2">2</p><p class="crayon-num" data-line="crayon-56d5c6c951650406189969-3">3</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951650406189969-4">4</p><p class="crayon-num" data-line="crayon-56d5c6c951650406189969-5">5</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951650406189969-6">6</p><p class="crayon-num" data-line="crayon-56d5c6c951650406189969-7">7</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951650406189969-8">8</p><p class="crayon-num" data-line="crayon-56d5c6c951650406189969-9">9</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951650406189969-10">10</p><p class="crayon-num" data-line="crayon-56d5c6c951650406189969-11">11</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951650406189969-12">12</p><p class="crayon-num" data-line="crayon-56d5c6c951650406189969-13">13</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951650406189969-14">14</p><p class="crayon-num" data-line="crayon-56d5c6c951650406189969-15">15</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951650406189969-16">16</p><p class="crayon-num" data-line="crayon-56d5c6c951650406189969-17">17</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951650406189969-18">18</p><p class="crayon-num" data-line="crayon-56d5c6c951650406189969-19">19</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951650406189969-20">20</p><p class="crayon-num" data-line="crayon-56d5c6c951650406189969-21">21</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951650406189969-22">22</p><p class="crayon-num" data-line="crayon-56d5c6c951650406189969-23">23</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951650406189969-24">24</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5c6c951650406189969-1"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-k ">os</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951650406189969-2"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-k ">threading</span></p><p class="crayon-line" id="crayon-56d5c6c951650406189969-3"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-k ">time</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951650406189969-4"> </p><p class="crayon-line" id="crayon-56d5c6c951650406189969-5"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">cherrypy </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951650406189969-6"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">pylibmc</span></p><p class="crayon-line" id="crayon-56d5c6c951650406189969-7"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951650406189969-8"><span class="crayon-v">KEY</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'important_thing'</span></p><p class="crayon-line" id="crayon-56d5c6c951650406189969-9"><span class="crayon-v">STALE_KEY</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'%s_stale'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">KEY</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951650406189969-10"> </p><p class="crayon-line" id="crayon-56d5c6c951650406189969-11"><span class="crayon-v">TIMEOUT</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">15</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951650406189969-12"><span class="crayon-v">STALE_WHILE_REVALIDATE_TIMEOUT</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">TIMEOUT</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">10</span></p><p class="crayon-line" id="crayon-56d5c6c951650406189969-13"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951650406189969-14"><span class="crayon-v">MC</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">pylibmc</span><span class="crayon-sy">.</span><span class="crayon-e">Client</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-s">'127.0.0.1:11211'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c6c951650406189969-15"><span class="crayon-v">SEMA</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">threading</span><span class="crayon-sy">.</span><span class="crayon-e">BoundedSemaphore</span><span class="crayon-sy">(</span><span class="crayon-v">value</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951650406189969-16"> </p><p class="crayon-line" id="crayon-56d5c6c951650406189969-17"><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">expires</span><span class="crayon-sy">(</span><span class="crayon-v">secs</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951650406189969-18"><span class="crayon-h">      </span><span class="crayon-s">"""                                                                                                                                                                            </span></p><p class="crayon-line" id="crayon-56d5c6c951650406189969-19"><span class="crayon-s">      Convenience function to add expiration headers                                                                                                                                 </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951650406189969-20"><span class="crayon-s">      """</span></p><p class="crayon-line" id="crayon-56d5c6c951650406189969-21"><span class="crayon-h">      </span><span class="crayon-v">r</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cherrypy</span><span class="crayon-sy">.</span><span class="crayon-e">response</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951650406189969-22"><span class="crayon-e">      </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">secs</span><span class="crayon-h"> </span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5c6c951650406189969-23"><span class="crayon-h">          </span><span class="crayon-v">r</span><span class="crayon-sy">.</span><span class="crayon-v">headers</span><span class="crayon-sy">[</span><span class="crayon-s">'Expires'</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cherrypy</span><span class="crayon-sy">.</span><span class="crayon-v">lib</span><span class="crayon-sy">.</span><span class="crayon-v">http</span><span class="crayon-sy">.</span><span class="crayon-e">HTTPDate</span><span class="crayon-sy">(</span><span class="crayon-v">cherrypy</span><span class="crayon-sy">.</span><span class="crayon-v">response</span><span class="crayon-sy">.</span><span class="crayon-k ">time</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-k ">float</span><span class="crayon-sy">(</span><span class="crayon-v">secs</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951650406189969-24"><span class="crayon-h">          </span><span class="crayon-v">r</span><span class="crayon-sy">.</span><span class="crayon-v">headers</span><span class="crayon-sy">[</span><span class="crayon-s">'Cache-Control'</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"max-age=%d"</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">secs</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p/>
<p>A few module-level variables are defined above, including <code>TIMEOUT</code> and <code>STALE_WHILE_REVALIDATE_TIMEOUT</code>. After <code>TIMEOUT</code> and before <code>STALE_WHILE_REVALIDATE_TIMEOUT</code> is the period during which requests will still be served from the cache but will also trigger background processing to refresh the cache. Clients will see slightly stale content during this timeframe. Once background processing completes, fresher content will begin being served.</p>
<p/>

		<div id="crayon-56d5c6c95165a018049670" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5c6c95165a018049670-1"><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">image_processor</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c95165a018049670-2"><span class="crayon-h">    </span><span class="crayon-s">"""                                                                                                                                                                              </span></p><p class="crayon-line" id="crayon-56d5c6c95165a018049670-3"><span class="crayon-s">    Handles the lengthy process of generating an image.                                                                                                                              </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c95165a018049670-4"><span class="crayon-s">    """</span></p><p class="crayon-line" id="crayon-56d5c6c95165a018049670-5"><span class="crayon-h">    </span><span class="crayon-c"># simulate bottleneck                                                                                                                                                            </span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c95165a018049670-6"><span class="crayon-h">    </span><span class="crayon-k ">time</span><span class="crayon-sy">.</span><span class="crayon-e">sleep</span><span class="crayon-sy">(</span><span class="crayon-cn">3</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c6c95165a018049670-7"><span class="crayon-h">    </span><span class="crayon-v">THING</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-s">'GIF89a'</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c95165a018049670-8"><span class="crayon-h">    </span><span class="crayon-s">'\x01\x00\x01\x00\x80\xff\x00\xff\xff\xff\x00\x00\x00\x2c\x00\x00'</span></p><p class="crayon-line" id="crayon-56d5c6c95165a018049670-9"><span class="crayon-h">    </span><span class="crayon-s">'\x00\x00\x01\x00\x01\x00\x00\x02\x02\x44\x01\x00\x3b\x00'</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c95165a018049670-10"><span class="crayon-h">    </span><span class="crayon-v">MC</span><span class="crayon-sy">.</span><span class="crayon-k ">set</span><span class="crayon-sy">(</span><span class="crayon-v">KEY</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">THING</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">TIMEOUT</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c6c95165a018049670-11"><span class="crayon-h">    </span><span class="crayon-v">MC</span><span class="crayon-sy">.</span><span class="crayon-k ">set</span><span class="crayon-sy">(</span><span class="crayon-v">STALE_KEY</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">THING</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">STALE_WHILE_REVALIDATE_TIMEOUT</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c95165a018049670-12"><span class="crayon-h">    </span><span class="crayon-v">SEMA</span><span class="crayon-sy">.</span><span class="crayon-e">release</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p/>
<p>The <code>image_processor</code> function handles the background processing. Again we’re using an artificial bottleneck <code>time.sleep(3)</code>. In real application code, this function could invoke other services, handle complex database processing, or do other lengthy tasks. Before this function is invoked <code>SEMA</code> must first be aquired to ensure only one thread is performing the work. Other threads will continue to serve stale content in the meantime. Once the work has been completed, two memcache keys are set with the appropriate timeouts. These keys are used by the server to handle requests:</p>
<p/>

		<div id="crayon-56d5c6c951664475121173" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-56d5c6c951664475121173-1">1</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951664475121173-2">2</p><p class="crayon-num" data-line="crayon-56d5c6c951664475121173-3">3</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951664475121173-4">4</p><p class="crayon-num" data-line="crayon-56d5c6c951664475121173-5">5</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951664475121173-6">6</p><p class="crayon-num" data-line="crayon-56d5c6c951664475121173-7">7</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951664475121173-8">8</p><p class="crayon-num" data-line="crayon-56d5c6c951664475121173-9">9</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951664475121173-10">10</p><p class="crayon-num" data-line="crayon-56d5c6c951664475121173-11">11</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951664475121173-12">12</p><p class="crayon-num" data-line="crayon-56d5c6c951664475121173-13">13</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951664475121173-14">14</p><p class="crayon-num" data-line="crayon-56d5c6c951664475121173-15">15</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951664475121173-16">16</p><p class="crayon-num" data-line="crayon-56d5c6c951664475121173-17">17</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951664475121173-18">18</p><p class="crayon-num" data-line="crayon-56d5c6c951664475121173-19">19</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951664475121173-20">20</p><p class="crayon-num" data-line="crayon-56d5c6c951664475121173-21">21</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951664475121173-22">22</p><p class="crayon-num" data-line="crayon-56d5c6c951664475121173-23">23</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951664475121173-24">24</p><p class="crayon-num" data-line="crayon-56d5c6c951664475121173-25">25</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951664475121173-26">26</p><p class="crayon-num" data-line="crayon-56d5c6c951664475121173-27">27</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951664475121173-28">28</p><p class="crayon-num" data-line="crayon-56d5c6c951664475121173-29">29</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951664475121173-30">30</p><p class="crayon-num" data-line="crayon-56d5c6c951664475121173-31">31</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5c6c951664475121173-1"><span class="crayon-t">class</span><span class="crayon-h"> </span><span class="crayon-e">Server</span><span class="crayon-sy">(</span><span class="crayon-k ">object</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951664475121173-2"><span class="crayon-h">    </span><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">index</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5c6c951664475121173-3"><span class="crayon-h">        </span><span class="crayon-v">rval</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">None</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951664475121173-4"><span class="crayon-h">        </span><span class="crayon-v">cached_file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">MC</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-v">KEY</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c6c951664475121173-5"><span class="crayon-h">        </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">cached_file</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951664475121173-6"><span class="crayon-h">              </span><span class="crayon-v">cherrypy</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-s">"Serving from cache"</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c6c951664475121173-7"><span class="crayon-h">              </span><span class="crayon-v">rval</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">cached_file</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951664475121173-8"><span class="crayon-e">        </span><span class="crayon-st">else</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5c6c951664475121173-9"><span class="crayon-h">              </span><span class="crayon-v">stale_file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">MC</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-v">STALE_KEY</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951664475121173-10"><span class="crayon-h">              </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">stale_file</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5c6c951664475121173-11"><span class="crayon-h">                   </span><span class="crayon-v">rval</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">stale_file</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951664475121173-12"><span class="crayon-e">                   </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">SEMA</span><span class="crayon-sy">.</span><span class="crayon-e">acquire</span><span class="crayon-sy">(</span><span class="crayon-v">blocking</span><span class="crayon-o">=</span><span class="crayon-t">False</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5c6c951664475121173-13"><span class="crayon-h">                        </span><span class="crayon-v">cherrypy</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-s">"Serving from stale cache and revalidating"</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951664475121173-14"><span class="crayon-h">                        </span><span class="crayon-v">cherrypy</span><span class="crayon-sy">.</span><span class="crayon-v">request</span><span class="crayon-sy">.</span><span class="crayon-v">hooks</span><span class="crayon-sy">.</span><span class="crayon-e">attach</span><span class="crayon-sy">(</span><span class="crayon-s">'on_end_request'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image_processor</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c6c951664475121173-15"><span class="crayon-h">                   </span><span class="crayon-st">else</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951664475121173-16"><span class="crayon-h">                        </span><span class="crayon-v">cherrypy</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-s">"Another thread is handling cache refresh, skipping"</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c6c951664475121173-17"><span class="crayon-h">              </span><span class="crayon-st">else</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951664475121173-18"><span class="crayon-h">                </span><span class="crayon-v">cherrypy</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-s">"No cache, performing work"</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c6c951664475121173-19"><span class="crayon-h">                </span><span class="crayon-v">SEMA</span><span class="crayon-sy">.</span><span class="crayon-e">acquire</span><span class="crayon-sy">(</span><span class="crayon-v">blocking</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951664475121173-20"><span class="crayon-h">                </span><span class="crayon-e">image_processor</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c6c951664475121173-21"><span class="crayon-h">                </span><span class="crayon-v">rval</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">MC</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-v">KEY</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951664475121173-22"><span class="crayon-h">        </span><span class="crayon-e">expires</span><span class="crayon-sy">(</span><span class="crayon-cn">60</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c6c951664475121173-23"><span class="crayon-h">        </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">rval</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951664475121173-24"><span class="crayon-e">    </span><span class="crayon-v">index</span><span class="crayon-sy">.</span><span class="crayon-v">exposed</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">True</span></p><p class="crayon-line" id="crayon-56d5c6c951664475121173-25"> </p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951664475121173-26"><span class="crayon-v">cherrypy</span><span class="crayon-sy">.</span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-e">update</span><span class="crayon-sy">(</span><span class="crayon-sy">{</span><span class="crayon-s">'server.max_queue_size'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c6c951664475121173-27"><span class="crayon-v">cherrypy</span><span class="crayon-sy">.</span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-e">update</span><span class="crayon-sy">(</span><span class="crayon-sy">{</span><span class="crayon-s">'server.thread_pool'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951664475121173-28"><span class="crayon-v">cherrypy</span><span class="crayon-sy">.</span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-e">update</span><span class="crayon-sy">(</span><span class="crayon-sy">{</span><span class="crayon-s">'server.socket_port'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">8010</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c6c951664475121173-29"><span class="crayon-v">cherrypy</span><span class="crayon-sy">.</span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-e">update</span><span class="crayon-sy">(</span><span class="crayon-sy">{</span><span class="crayon-s">'server.socket_host'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">'0.0.0.0'</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951664475121173-30"><span class="crayon-v">cherrypy</span><span class="crayon-sy">.</span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-e">update</span><span class="crayon-sy">(</span><span class="crayon-sy">{</span><span class="crayon-s">'log.screen'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-t">True</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c6c951664475121173-31"><span class="crayon-v">cherrypy</span><span class="crayon-sy">.</span><span class="crayon-e">quickstart</span><span class="crayon-sy">(</span><span class="crayon-e">Server</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p/>
<p>This CherryPy server implements <code>stale-while-revalidate</code>. On the very first request both the primary cache and the secondary (stale) cache are empty so the server is forced to invoke the time-consuming code to create the resource. Subsequent requests will return the cached value immediately. Once the primary cache has expired the server continues to return the stale image while at the same time launching the time-consuming routine to refresh the cache in the background. Since a semaphore is used only one of the CherryPy threads will be busy doing this work while the other threads continue serving stale content as quickly as possible. When the time-consuming routine completes the cache will be refreshed and more up-to-date content will begin to be served.</p>
<h2 id="shortcut-with-202-accepted">Shortcut, with <code>202 Accepted</code></h2>
<p>In the example above only the very first request suffers a long wait time while every other response is immediately served from the cache. To prevent any client requests from having to wait (even the first one) there is another possible approach. When the cache is empty we can quickly return a different HTTP status while the work is performed in the background by the server. For example:</p>
<p/>

		<div id="crayon-56d5c6c951670496576366" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover">
		
			
			<p class="crayon-info"/>
			<p class="crayon-plain-wrap"/>
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-56d5c6c951670496576366-1">1</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951670496576366-2">2</p><p class="crayon-num" data-line="crayon-56d5c6c951670496576366-3">3</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951670496576366-4">4</p><p class="crayon-num" data-line="crayon-56d5c6c951670496576366-5">5</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951670496576366-6">6</p><p class="crayon-num" data-line="crayon-56d5c6c951670496576366-7">7</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951670496576366-8">8</p><p class="crayon-num" data-line="crayon-56d5c6c951670496576366-9">9</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951670496576366-10">10</p><p class="crayon-num" data-line="crayon-56d5c6c951670496576366-11">11</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951670496576366-12">12</p><p class="crayon-num" data-line="crayon-56d5c6c951670496576366-13">13</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951670496576366-14">14</p><p class="crayon-num" data-line="crayon-56d5c6c951670496576366-15">15</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951670496576366-16">16</p><p class="crayon-num" data-line="crayon-56d5c6c951670496576366-17">17</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951670496576366-18">18</p><p class="crayon-num" data-line="crayon-56d5c6c951670496576366-19">19</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951670496576366-20">20</p><p class="crayon-num" data-line="crayon-56d5c6c951670496576366-21">21</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951670496576366-22">22</p><p class="crayon-num" data-line="crayon-56d5c6c951670496576366-23">23</p><p class="crayon-num crayon-striped-num" data-line="crayon-56d5c6c951670496576366-24">24</p><p class="crayon-num" data-line="crayon-56d5c6c951670496576366-25">25</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56d5c6c951670496576366-1"><span class="crayon-t">class</span><span class="crayon-h"> </span><span class="crayon-e">Server</span><span class="crayon-sy">(</span><span class="crayon-k ">object</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951670496576366-2"><span class="crayon-h">    </span><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">index</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5c6c951670496576366-3"><span class="crayon-h">        </span><span class="crayon-v">rval</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">None</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951670496576366-4"><span class="crayon-h">        </span><span class="crayon-v">cached_file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">MC</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-v">KEY</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c6c951670496576366-5"><span class="crayon-h">        </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">cached_file</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951670496576366-6"><span class="crayon-h">              </span><span class="crayon-v">cherrypy</span><span class="crayon-sy">.</span><span class="crayon-v">request</span><span class="crayon-sy">.</span><span class="crayon-v">app</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-s">"Serving from cache"</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c6c951670496576366-7"><span class="crayon-h">              </span><span class="crayon-v">rval</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">cached_file</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951670496576366-8"><span class="crayon-e">        </span><span class="crayon-st">else</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5c6c951670496576366-9"><span class="crayon-h">              </span><span class="crayon-v">stale_file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">MC</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-v">STALE_KEY</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951670496576366-10"><span class="crayon-h">              </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">stale_file</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5c6c951670496576366-11"><span class="crayon-h">                   </span><span class="crayon-v">rval</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">stale_file</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951670496576366-12"><span class="crayon-e">                   </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">SEMA</span><span class="crayon-sy">.</span><span class="crayon-e">acquire</span><span class="crayon-sy">(</span><span class="crayon-v">blocking</span><span class="crayon-o">=</span><span class="crayon-t">False</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></p><p class="crayon-line" id="crayon-56d5c6c951670496576366-13"><span class="crayon-h">                        </span><span class="crayon-v">cherrypy</span><span class="crayon-sy">.</span><span class="crayon-v">request</span><span class="crayon-sy">.</span><span class="crayon-v">app</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-s">"Serving from stale cache and revalidating"</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951670496576366-14"><span class="crayon-h">                        </span><span class="crayon-v">cherrypy</span><span class="crayon-sy">.</span><span class="crayon-v">request</span><span class="crayon-sy">.</span><span class="crayon-v">hooks</span><span class="crayon-sy">.</span><span class="crayon-e">attach</span><span class="crayon-sy">(</span><span class="crayon-s">'on_end_request'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image_processor</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c6c951670496576366-15"><span class="crayon-h">                   </span><span class="crayon-st">else</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951670496576366-16"><span class="crayon-h">                        </span><span class="crayon-v">cherrypy</span><span class="crayon-sy">.</span><span class="crayon-v">request</span><span class="crayon-sy">.</span><span class="crayon-v">app</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-s">"Another thread is handling cache refresh, skipping"</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c6c951670496576366-17"><span class="crayon-h">              </span><span class="crayon-st">else</span><span class="crayon-o">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951670496576366-18"><span class="crayon-h">                </span><span class="crayon-v">cherrypy</span><span class="crayon-sy">.</span><span class="crayon-v">request</span><span class="crayon-sy">.</span><span class="crayon-v">app</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-s">"Accepting request, performing work"</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56d5c6c951670496576366-19"><span class="crayon-h">                </span><span class="crayon-v">cherrypy</span><span class="crayon-sy">.</span><span class="crayon-v">response</span><span class="crayon-sy">.</span><span class="crayon-v">status</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">202</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951670496576366-20"><span class="crayon-h">                </span><span class="crayon-c"># optional:</span></p><p class="crayon-line" id="crayon-56d5c6c951670496576366-21"><span class="crayon-h">                </span><span class="crayon-c">#cherrypy.response.headers['Location'] = 'http://.../monitor-progress.html'</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951670496576366-22"><span class="crayon-h">                </span><span class="crayon-v">rval</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span></p><p class="crayon-line" id="crayon-56d5c6c951670496576366-23"><span class="crayon-h">        </span><span class="crayon-e">expires</span><span class="crayon-sy">(</span><span class="crayon-cn">60</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56d5c6c951670496576366-24"><span class="crayon-h">        </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">rval</span></p><p class="crayon-line" id="crayon-56d5c6c951670496576366-25"><span class="crayon-e">    </span><span class="crayon-v">index</span><span class="crayon-sy">.</span><span class="crayon-v">exposed</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">True</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p/>
<p>The only important difference here is that no client ever waits for a response. The very first request (when the cache is empty) is handled using <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.3">202 Accepted</a> to indicate processing has yet to be completed. It is often useful to include a ‘Location’ header field indicating where the image can be found later or where clients can monitor the progress of the background task. Using <code>202 Accepted</code> may not make much sense to an end-user in their browser. However if this is an internal service this would be a well-formed and fast way to warm the cache.</p>
<h2 id="when-speed-is-paramount">When Speed Is Paramount</h2>
<p>If the priority is to keep response times low and it is also acceptable to serve slightly stale content a small percentage of the time then implementing <code>stale-while-revalidate</code> on the server is a great method for reducing latency for clients while still handling large and time-consuming backend processes.</p>
          </div>

            
                        </div></body></html>