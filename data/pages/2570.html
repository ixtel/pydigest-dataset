<html><body><div><p>I've used MySQL for a while now, and there were lots of surprising things I needed to cater for. This is from a <a class="reference external" href="https://www.djangoproject.com/">Django</a> and MySQL 5.5 perspective <a class="footnote-reference" href="#id14" id="id1">[*]</a>. Later on you'll see the horrible things I did to work around. It was a terrible experience, as I've also used PostgreSQL ...</p><p>Feel free to add your own experiences in the comments section.</p><div class="section" id="the-defaults"><h2>The defaults<a class="headerlink" href="#the-defaults" title="Permalink to this headline"> *</a></h2><p>MySQL supports a large part of the <a class="reference external" href="http://en.wikipedia.org/wiki/SQL:1999">ANSI SQL 99</a> standard, however the default settings are nowhere close to that.</p><p>If you used any other database then it's going to be a very perplexing experience.</p><div class="section" id="sql-mode"><h3>SQL mode<a class="headerlink" href="#sql-mode" title="Permalink to this headline"> *</a></h3><p>With the default settings MySQL truncates and does other unspeakable things to data for the sake of not giving errors. Where is this a correct choice, hard to say.</p><p>What the defaults allow:</p><ul class="simple"><li>Storing invalid dates like <tt class="docutils literal"><span class="pre">'0000-00-00'</span></tt> or <tt class="docutils literal"><span class="pre">'2010-01-00'</span></tt> <a class="footnote-reference" href="#id15" id="id2">[1]</a>.</li><li>Silently treating errors like:<ul><li>Specifying an unavailable storage engine. It will use the default engine, silently <a class="footnote-reference" href="#id16" id="id3">[2]</a>.</li><li>Inserting invalid data. Larger strings get truncated to the maximum length. Larger integers get truncated to the maximum. Other things get converted to NULL if the column allows that. All silently <a class="footnote-reference" href="#id17" id="id4">[3]</a>.</li></ul></li></ul><p>And no, ORMs won't save you from this pain by default. For Django you need to have something like this in the settings:</p><div class="highlight"><pre><span/><span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'default'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">'ENGINE'</span><span class="p">:</span> <span class="s1">'django.db.backends.mysql'</span><span class="p">,</span>
        <span class="s1">'NAME'</span><span class="p">:</span> <span class="s1">'whatever'</span><span class="p">,</span>
        <span class="s1">'OPTIONS'</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">'sql_mode'</span><span class="p">:</span> <span class="s1">'TRADITIONAL'</span><span class="p">,</span>
        <span class="p">}</span>  <span class="c1"># Note that later we find out that this is not enough. Read on.</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div><p>There's an open Django <a class="reference external" href="https://code.djangoproject.com/ticket/15940">ticket to set this the default</a>.</p><p>And yes, you can set this in the MySQL settings but you don't really want that. Your app will misbehave and corrupt data if you ever happen to forget to change the <tt class="docutils literal">/etc/mysql/my.cnf</tt> before deployment. And if you ever forget to do that, your data is already going to be corrupted by the time you notice something is not quite right.</p></div><div class="section" id="collations-and-encodings"><h3>Collations and encodings<a class="headerlink" href="#collations-and-encodings" title="Permalink to this headline"> *</a></h3><p>So far I've used <tt class="docutils literal">utf8</tt> as the connection charset. Cause you never know what the default one is (<a class="reference external" href="http://dev.mysql.com/doc/refman/5.5/en/server-options.html#option_mysqld_character-set-server">probably latin1</a>). However, note that the charset affects the maximum index size for VARCHAR columns. Ever wonder why you often see this:</p><div class="highlight"><pre><span/><span class="n">myfield</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">db_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div><p>Yes, the index on <tt class="docutils literal">utf8</tt> columns is limited to 255 characters <a class="footnote-reference" href="#id18" id="id5">[4]</a>. If you need to store emoticons like an angry face <span class="bigger">ðŸ˜ </span>- and most probably you'd want to, given the predicament - then you're out of luck, you need a different charset, <tt class="docutils literal">utf8mb4</tt> <a class="footnote-reference" href="#id19" id="id6">[5]</a>. But that means smaller index, only 191 characters <a class="footnote-reference" href="#id27" id="id7">[11]</a>.</p><p>But that's not that bad, you should get some errors if you fail to set the correct encoding. Collations however, are more trippy. A collation is a set of rules for comparing characters in a character set <a class="footnote-reference" href="#id20" id="id8">[6]</a>.</p><p>Notice a pattern here? Note the <tt class="docutils literal">_ci</tt> suffix:</p><pre class="literal-block">
mysql&gt; SHOW CHARACTER SET;
+----------+-----------------------------+---------------------+--------+
| Charset  | Description                 | Default collation   | Maxlen |
+----------+-----------------------------+---------------------+--------+
| latin1   | cp1252 West European        | latin1_swedish_ci   |      1 |
| ascii    | US ASCII                    | ascii_general_ci    |      1 |
| utf8     | UTF-8 Unicode               | utf8_general_ci     |      3 |
| utf8mb4  | UTF-8 Unicode               | utf8mb4_general_ci  |      4 |
| utf32    | UTF-32 Unicode              | utf32_general_ci    |      4 |
+----------+-----------------------------+---------------------+--------+
</pre><p>All the default collations are case insensitive. This means your queries and indexes are also going to be case insensitive <a class="footnote-reference" href="#id20" id="id9">[6]</a>. I'd say they are just <cite>insensitive</cite>. To your pain.</p><p>If you have a case insensitive collation all sorts of queries that aren't a text search will behave strangely <a class="footnote-reference" href="#id21" id="id10">[7]</a>. You'll notice that <a class="reference external" href="https://docs.djangoproject.com/en/1.7/ref/models/querysets/#get-or-create">get_or_create</a> doesn't work as expected when you have accents or a different case.</p><p>The solution is to use <tt class="docutils literal">utf_bin</tt> collation and specify a different one only when you need special accent handling and case folding. The settings now look like this:</p><div class="highlight"><pre><span/><span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'default'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">'ENGINE'</span><span class="p">:</span> <span class="s1">'django.db.backends.mysql'</span><span class="p">,</span>
        <span class="s1">'NAME'</span><span class="p">:</span> <span class="s1">'mydatabase'</span><span class="p">,</span>
        <span class="s1">'OPTIONS'</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">'sql_mode'</span><span class="p">:</span> <span class="s1">'TRADITIONAL'</span><span class="p">,</span>
            <span class="s1">'charset'</span><span class="p">:</span> <span class="s1">'utf8'</span><span class="p">,</span>
            <span class="s1">'init_command'</span><span class="p">:</span> <span class="s1">'SET '</span>
                <span class="s1">'storage_engine=INNODB,'</span>
                <span class="s1">'character_set_connection=utf8,'</span>
                <span class="s1">'collation_connection=utf8_bin'</span>
        <span class="p">}</span>  <span class="c1"># Note that later we find out that this is still not enough. Read on.</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div><p>Unfortunately I didn't know this from the start. So I had to fix the existing data and installation scripts. When you create a database, make sure that you specify the encoding and collation:</p><div class="highlight"><pre><span/><span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">mydatabase</span> <span class="k">CHARACTER</span> <span class="kt">SET</span> <span class="n">utf8</span> <span class="k">COLLATE</span> <span class="n">utf8_bin</span><span class="p">;</span>
</pre></div><p>To fix the existing data, a <a class="reference external" href="http://south.aeracode.org/">south</a> migration would look like:</p><div class="highlight"><pre><span/><span class="kn">from</span> <span class="nn">south.db</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">south.v2</span> <span class="kn">import</span> <span class="n">DataMigration</span>

<span class="k">class</span> <span class="nc">Migration</span><span class="p">(</span><span class="n">DataMigration</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">forwards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orm</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'    Altering database ...'</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"ALTER DATABASE CHARACTER SET utf8 COLLATE utf8_bin;"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">table</span><span class="p">,</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">'SHOW TABLES'</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">'    Altering table </span><span class="si">%s</span><span class="s1"> ...'</span> <span class="o">%</span> <span class="n">table</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="s2">"ALTER TABLE </span><span class="si">%s</span><span class="s2"> CONVERT TO CHARACTER SET utf8 COLLATE utf8_bin"</span> <span class="o">%</span> <span class="n">table</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">backwards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orm</span><span class="p">):</span>
        <span class="c1"># Altering the tables takes lots of time and</span>
        <span class="c1"># locks the tables, since it copies all the data.</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">"This migration probably took 2 hours, you don't really want to rollback ..."</span>
        <span class="p">)</span>
</pre></div><p>With the new migrations in Django 1.7:</p><div class="highlight"><pre><span/><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">migrations</span>

<span class="k">def</span> <span class="nf">forwards</span><span class="p">(</span><span class="n">apps</span><span class="p">,</span> <span class="n">schema_editor</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">schema_editor</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'    Altering database ...'</span><span class="p">)</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"ALTER DATABASE CHARACTER SET utf8 COLLATE utf8_bin;"</span><span class="p">)</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"SHOW TABLES;"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">table</span><span class="p">,</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">'    Altering table </span><span class="si">%s</span><span class="s1"> ...'</span> <span class="o">%</span> <span class="n">table</span><span class="p">)</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="s2">"ALTER TABLE </span><span class="si">%s</span><span class="s2"> CONVERT TO CHARACTER SET utf8 COLLATE utf8_bin"</span> <span class="o">%</span> <span class="n">table</span>
            <span class="p">)</span>

<span class="k">def</span> <span class="nf">backwards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orm</span><span class="p">):</span>
    <span class="c1"># Altering the tables takes lots of time and</span>
    <span class="c1"># locks the tables, since it copies all the data.</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
        <span class="s2">"This migration probably took 2 hours, you don't really want to rollback ..."</span>
    <span class="p">)</span>

<span class="k">class</span> <span class="nc">Migration</span><span class="p">(</span><span class="n">migrations</span><span class="o">.</span><span class="n">Migration</span><span class="p">):</span>
    <span class="n">dependencies</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1"># Needs to be filled, to figure it out run:</span>
        <span class="c1">#   django-admin makemigrations myapp --empty</span>
    <span class="p">]</span>
    <span class="n">operations</span> <span class="o">=</span> <span class="p">[</span><span class="n">migrations</span><span class="o">.</span><span class="n">RunPython</span><span class="p">(</span><span class="n">forwards</span><span class="p">,</span> <span class="n">backwards</span><span class="p">)]</span>
</pre></div><p>Note that this will take long time to run (MySQL seems to copy all the tables for some reason) and it will change the encoding and collation for all the columns <a class="footnote-reference" href="#id22" id="id11">[8]</a>.</p></div><div class="section" id="the-transaction-isolation-level"><h3>The transaction isolation level<a class="headerlink" href="#the-transaction-isolation-level" title="Permalink to this headline"> *</a></h3><p>Unfortunately getting the collation and encodings right won't make <a class="reference external" href="https://docs.djangoproject.com/en/1.7/ref/models/querysets/#get-or-create">get_or_create</a> work flawlessly <a class="footnote-reference" href="#id23" id="id12">[9]</a>. The default transaction level for MySQL is <a class="reference external" href="http://dev.mysql.com/doc/refman/5.5/en/set-transaction.html#isolevel_repeatable-read">REPEATABLE READ</a>, that means reads are consistent in the same transaction - they will return the same result, even if outside the transaction the data has changed. In other words, <a class="reference external" href="http://dev.mysql.com/doc/refman/5.5/en/set-transaction.html#isolevel_repeatable-read">REPEATABLE READ</a> will break <a class="reference external" href="https://docs.djangoproject.com/en/1.7/ref/models/querysets/#get-or-create">get_or_create</a> in a transaction - it's possible that code in a transaction won't "see" the object created outside the transaction (like in another process).</p><p>Unfortunately the defaults are hard to change without breaking existing apps <a class="footnote-reference" href="#id24" id="id13">[10]</a>, so you have to work this out in your connection settings. Now the settings are:</p><div class="highlight"><pre><span/><span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'default'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">'ENGINE'</span><span class="p">:</span> <span class="s1">'django.db.backends.mysql'</span><span class="p">,</span>
        <span class="s1">'NAME'</span><span class="p">:</span> <span class="s1">'mydatabase'</span><span class="p">,</span>
        <span class="s1">'OPTIONS'</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">'sql_mode'</span><span class="p">:</span> <span class="s1">'TRADITIONAL'</span><span class="p">,</span>
            <span class="s1">'charset'</span><span class="p">:</span> <span class="s1">'utf8'</span><span class="p">,</span>
            <span class="s1">'init_command'</span><span class="p">:</span> <span class="s1">'SET '</span>
                <span class="s1">'storage_engine=INNODB,'</span>
                <span class="s1">'character_set_connection=utf8,'</span>
                <span class="s1">'collation_connection=utf8_bin,'</span>
                <span class="s1">'SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED'</span><span class="p">,</span>
        <span class="p">}</span>  <span class="c1"># Now we have a mild degree of confidence :-)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div><div class="section" id="ddl-statements"><h3>DDL statements<a class="headerlink" href="#ddl-statements" title="Permalink to this headline"> *</a></h3><p><a class="reference external" href="http://en.wikipedia.org/wiki/Data_definition_language#SQL">DDL</a> statements in MySQL, not only they are slow and lock tables (that means downtime), they will ignore transactions. The almighty InnoDB can't save your sanity when an <tt class="docutils literal">ALTER</tt> is used in a transaction. Thus, migrations in MySQL must be approached with great care (test them well) and to avoid downtime you need to use specific external tools.</p><p>Annoying, even for development:</p><pre class="literal-block">
! Error found during real run of migration! Aborting.

! Since you have a database that does not support running
! schema-altering statements in transactions, we have had
! to leave it in an interim state between migrations.

! The South developers regret this has happened, and would
! like to gently persuade you to consider a slightly
! easier-to-deal-with DBMS.
</pre><p>If this is the same with the migration system in 1.7 (seems it it, but you only get a plain traceback) then it's ideal to have migrations small in scope if you have <a class="reference external" href="https://docs.djangoproject.com/en/1.7/ref/migration-operations/#django.db.migrations.operations.RunSQL">custom sql</a> that can easily fail, and <a class="reference external" href="https://docs.djangoproject.com/en/1.7/topics/migrations/#squashing-migrations">squash them</a> later, after you have successfully ran them.</p></div></div><div class="section" id="the-inflexibility"><h2>The inflexibility<a class="headerlink" href="#the-inflexibility" title="Permalink to this headline"> *</a></h2><p>There's something wrong with the query optimizer, it tends to use temporary tables for most queries that have a handful of joins and a <tt class="docutils literal">GROUP BY</tt>. This quite common with Django but the <cite>why and how</cite> is a too large topic to tackle here. Maybe later ...</p><p>For now, a story of grief.</p><p>I have a model like this:</p><div class="highlight"><pre><span/><span class="k">class</span> <span class="nc">Item</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">unique_together</span> <span class="o">=</span> <span class="s2">"type"</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">,</span> <span class="s2">"parent"</span>

    <span class="nb">type</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">db_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">db_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="s2">"self"</span><span class="p">,</span>
        <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>  <span class="c1"># Notice anything peculiar?</span>
        <span class="n">blank</span><span class="o">=</span><span class="bp">True</span>
    <span class="p">)</span>
</pre></div><p>For reasons unknown I went ahead with this model. Why was it designed like that and why it remained like that needs not be questioned. But what is wrong with it?</p><p>You see, creating unique index on <tt class="docutils literal">NULL</tt> columns is a bad idea as <tt class="docutils literal">NULL</tt> values aren't included in the index. The database will disallow inserting <tt class="docutils literal">"foobar"</tt> two times but will allow inserting a boundless number of <tt class="docutils literal">NULL</tt> values. For example, this would be allowed:</p><div class="highlight"><pre><span/><span class="gp">&gt;&gt;&gt; </span><span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"stuff"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">"foobar"</span><span class="p">)</span><span class="o">.</span><span class="n">pk</span>
<span class="go">1L</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"stuff"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">"foobar"</span><span class="p">)</span><span class="o">.</span><span class="n">pk</span>
<span class="go">2L</span>
</pre></div><p>Given unfavorable conditions (parallelism), <a class="reference external" href="https://docs.djangoproject.com/en/1.7/ref/models/querysets/#get-or-create">get_or_create</a> would create duplicate objects - because the database lets it.</p><p>This is something normal in SQL and ideally you'd redesign the model and MySQL is not to be blamed, right? But, alas, no. You see, I was using an ORM and I really liked the convenience of the <a class="reference external" href="https://docs.djangoproject.com/en/1.7/ref/models/fields/#foreignkey">ForeignKey field</a>. Pity me for my weakness for I was like a thirsty fool in the desert.</p><p>The options I didn't have:</p><ul class="simple"><li>Keep the constraint but replace the <tt class="docutils literal">parent</tt> in the index with a computed column. But MySQL doesn't have computed columns!</li><li>Use a conditional index. Nope, MySQL doesn't allow conditional indexes.</li><li>Create a view. Make the index on the view. No, MySQL doesn't allow creating indexes on views.</li></ul><p>To add insult to the injury, PostgreSQL had all these.</p><p>Creating some workaround on the client side was no option. The application was highly parallelism - this had to be handled in the database. But I fought on and found a solution: :uppercase:TRIGGERS.</p><p>In my mad quest to solve this quickly I brought this into existence:</p><div class="highlight"><pre><span/><span class="k">CREATE</span> <span class="k">TRIGGER</span> <span class="n">check_unique_on_item</span>
<span class="k">BEFORE</span> <span class="k">INSERT</span> <span class="k">ON</span> <span class="n">myapp_item</span>
<span class="k">FOR</span> <span class="k">EACH</span> <span class="n">ROW</span> <span class="n">BEGIN</span>
    <span class="k">IF</span> <span class="n">NEW</span><span class="p">.</span><span class="n">parent_id</span> <span class="k">IS</span> <span class="no">NULL</span>
    <span class="k">THEN</span>
        <span class="k">IF</span> <span class="p">(</span>
            <span class="k">SELECT</span> <span class="nf">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
            <span class="k">FROM</span> <span class="n">myapp_item</span> <span class="n">item</span>
            <span class="k">WHERE</span> <span class="n">item</span><span class="p">.</span><span class="n">parent_id</span> <span class="k">IS</span> <span class="no">NULL</span> <span class="k">AND</span>
                  <span class="n">item</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">NEW</span><span class="p">.</span><span class="n">name</span> <span class="k">AND</span>
                  <span class="n">item</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NEW</span><span class="p">.</span><span class="n">type</span>
        <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">THEN</span>
            <span class="kt">SET</span> <span class="n">NEW</span> <span class="o">=</span> <span class="s1">'Error: Cannot insert this item. There is already an existing entry.'</span><span class="p">;</span>
        <span class="n">END</span> <span class="k">IF</span><span class="p">;</span>
    <span class="n">END</span> <span class="k">IF</span><span class="p">;</span>
<span class="n">END</span><span class="p">;</span>
</pre></div><p>Because I was doing something invalid, just to stop the insert, <a class="reference external" href="https://docs.djangoproject.com/en/1.7/ref/models/querysets/#get-or-create">get_or_create</a> had to deal with a new type of error: <tt class="docutils literal">DatabaseError</tt>. Thus the <tt class="docutils literal">Item</tt> model needed a custom manager:</p><div class="highlight"><pre><span/><span class="kn">from</span> <span class="nn">django.db.utils</span> <span class="kn">import</span> <span class="n">DatabaseError</span>

<span class="k">class</span> <span class="nc">ItemManager</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Manager</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">lookups</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ItemManager</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="o">**</span><span class="n">lookups</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">DatabaseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">**</span><span class="n">lookups</span><span class="p">),</span> <span class="bp">False</span>
            <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
</pre></div><p>Now if you look closely at the trigger you'll notice that it's not really a real constraint, thus, not atomic. I have realized that it doesn't really work during load-tests ...</p><p>So I went back to the drawing board and came up with a new idea: create a shadow table that has all the constraints, and triggers to update that table before the real one gets changed.</p><p>So I removed the <tt class="docutils literal">unique_together</tt> from the <tt class="docutils literal">Item</tt> model and created this:</p><div class="highlight"><pre><span/><span class="k">class</span> <span class="nc">ItemUniqueFixup</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">unique_together</span> <span class="o">=</span> <span class="s2">"type"</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">,</span> <span class="s2">"parent"</span>

    <span class="nb">type</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">()</span>
</pre></div><p>And created the triggers and filled the shadow table:</p><div class="highlight"><pre><span/><span class="k">DROP</span> <span class="k">TRIGGER</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="n">check_unique_on_item</span><span class="p">;</span>

<span class="n">TRUNCATE</span> <span class="k">TABLE</span> <span class="n">myapp_itemuniquefixup</span><span class="p">;</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="nf">myapp_itemuniquefixup</span> <span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">old</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">id</span><span class="p">,</span> <span class="n">old</span><span class="p">.</span><span class="n">type</span> <span class="k">AS</span> <span class="n">type</span><span class="p">,</span> <span class="n">old</span><span class="p">.</span><span class="n">name</span> <span class="k">AS</span> <span class="n">name</span><span class="p">,</span>
       <span class="k">IF</span><span class="p">(</span><span class="n">old</span><span class="p">.</span><span class="n">parent_id</span> <span class="k">IS</span> <span class="no">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">old</span><span class="p">.</span><span class="n">parent_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">parent</span>
<span class="k">FROM</span> <span class="n">myapp_item</span> <span class="n">old</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="k">TRIGGER</span> <span class="n">check_unique_on_item_insert</span>
<span class="k">BEFORE</span> <span class="k">INSERT</span> <span class="k">ON</span> <span class="n">myapp_item</span>
<span class="k">FOR</span> <span class="k">EACH</span> <span class="n">ROW</span> <span class="n">BEGIN</span>
    <span class="k">INSERT</span> <span class="k">INTO</span> <span class="nf">myapp_itemuniquefixup</span> <span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
    <span class="k">VALUES</span> <span class="p">(</span>
        <span class="n">NEW</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">NEW</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">NEW</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="k">IF</span><span class="p">(</span><span class="n">NEW</span><span class="p">.</span><span class="n">parent_id</span> <span class="k">IS</span> <span class="no">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NEW</span><span class="p">.</span><span class="n">parent_id</span><span class="p">)</span>
    <span class="p">);</span>
<span class="n">END</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="k">TRIGGER</span> <span class="n">check_unique_on_item_update</span>
<span class="k">BEFORE</span> <span class="k">UPDATE</span> <span class="k">ON</span> <span class="n">myapp_item</span>
<span class="k">FOR</span> <span class="k">EACH</span> <span class="n">ROW</span> <span class="n">BEGIN</span>
    <span class="k">UPDATE</span> <span class="n">myapp_itemuniquefixup</span> <span class="n">fix</span>
    <span class="kt">SET</span> <span class="n">fix</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NEW</span><span class="p">.</span><span class="n">type</span><span class="p">,</span>
        <span class="n">fix</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">NEW</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">fix</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="k">IF</span><span class="p">(</span><span class="n">NEW</span><span class="p">.</span><span class="n">parent_id</span> <span class="k">IS</span> <span class="no">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NEW</span><span class="p">.</span><span class="n">parent_id</span><span class="p">)</span>
    <span class="k">WHERE</span> <span class="n">NEW</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
<span class="n">END</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="k">TRIGGER</span> <span class="n">check_unique_on_item_delete</span>
<span class="k">BEFORE</span> <span class="k">DELETE</span> <span class="k">ON</span> <span class="n">myapp_item</span>
<span class="k">FOR</span> <span class="k">EACH</span> <span class="n">ROW</span> <span class="n">BEGIN</span>
    <span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">myapp_itemuniquefixup</span> <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="n">OLD</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
<span class="n">END</span><span class="p">;</span>
</pre></div><p>Now you see, this was very tricky to get right. With conditional indexes in PostgreSQL this would had been as easy as:</p><div class="highlight"><pre><span/><span class="k">CREATE</span> <span class="k">UNIQUE</span> <span class="k">INDEX</span> <span class="n">myapp_item_noparent</span> <span class="k">ON</span> <span class="n">myapp_item</span><span class="p">(</span><span class="k">type</span><span class="p">,</span> <span class="k">name</span><span class="p">)</span>
       <span class="k">WHERE</span> <span class="n">parent</span> <span class="k">IS</span> <span class="k">NULL</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">UNIQUE</span> <span class="k">INDEX</span> <span class="n">myapp_item_withparent</span> <span class="k">ON</span> <span class="n">myapp_item</span><span class="p">(</span><span class="k">type</span><span class="p">,</span> <span class="k">name</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
       <span class="k">WHERE</span> <span class="n">parent</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">;</span>
</pre></div></div></div></body></html>