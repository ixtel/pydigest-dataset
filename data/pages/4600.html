<html><body><div><div class=" highlight hl-ipython2"><pre><span class="o">%%</span>R

ggsurv <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>s<span class="p">,</span> CI <span class="o">=</span> <span class="s">'def'</span><span class="p">,</span> plot.cens <span class="o">=</span> <span class="bp">T</span><span class="p">,</span> surv.col <span class="o">=</span> <span class="s">'gg.def'</span><span class="p">,</span>
                   cens.col <span class="o">=</span> <span class="s">'red'</span><span class="p">,</span> lty.est <span class="o">=</span> <span class="m">1</span><span class="p">,</span> lty.ci <span class="o">=</span> <span class="m">2</span><span class="p">,</span>
                   cens.shape <span class="o">=</span> <span class="m">3</span><span class="p">,</span> back.white <span class="o">=</span> <span class="bp">F</span><span class="p">,</span> xlab <span class="o">=</span> <span class="s">'Time'</span><span class="p">,</span>
                   ylab <span class="o">=</span> <span class="s">'Survival'</span><span class="p">,</span> main <span class="o">=</span> <span class="s">''</span><span class="p">){</span>
 
  <span class="kn">library</span><span class="p">(</span>ggplot2<span class="p">)</span>
  strata <span class="o">&lt;-</span> <span class="kp">ifelse</span><span class="p">(</span><span class="kp">is.null</span><span class="p">(</span>s<span class="o">$</span>strata<span class="p">)</span> <span class="o">==</span><span class="bp">T</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="kp">length</span><span class="p">(</span>s<span class="o">$</span>strata<span class="p">))</span>
  <span class="kp">stopifnot</span><span class="p">(</span><span class="kp">length</span><span class="p">(</span>surv.col<span class="p">)</span> <span class="o">==</span> <span class="m">1</span> <span class="o">|</span> <span class="kp">length</span><span class="p">(</span>surv.col<span class="p">)</span> <span class="o">==</span> strata<span class="p">)</span>
  <span class="kp">stopifnot</span><span class="p">(</span><span class="kp">length</span><span class="p">(</span>lty.est<span class="p">)</span> <span class="o">==</span> <span class="m">1</span> <span class="o">|</span> <span class="kp">length</span><span class="p">(</span>lty.est<span class="p">)</span> <span class="o">==</span> strata<span class="p">)</span>
 
  ggsurv.s <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>s<span class="p">,</span> CI <span class="o">=</span> <span class="s">'def'</span><span class="p">,</span> plot.cens <span class="o">=</span> <span class="bp">T</span><span class="p">,</span> surv.col <span class="o">=</span> <span class="s">'gg.def'</span><span class="p">,</span>
                       cens.col <span class="o">=</span> <span class="s">'red'</span><span class="p">,</span> lty.est <span class="o">=</span> <span class="m">1</span><span class="p">,</span> lty.ci <span class="o">=</span> <span class="m">2</span><span class="p">,</span>
                       cens.shape <span class="o">=</span> <span class="m">3</span><span class="p">,</span> back.white <span class="o">=</span> <span class="bp">F</span><span class="p">,</span> xlab <span class="o">=</span> <span class="s">'Time'</span><span class="p">,</span>
                       ylab <span class="o">=</span> <span class="s">'Survival'</span><span class="p">,</span> main <span class="o">=</span> <span class="s">''</span><span class="p">){</span>
 
    dat <span class="o">&lt;-</span> <span class="kt">data.frame</span><span class="p">(</span>time <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> s<span class="o">$</span>time<span class="p">),</span>
                      surv <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> s<span class="o">$</span>surv<span class="p">),</span>
                      up <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> s<span class="o">$</span>upper<span class="p">),</span>
                      low <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> s<span class="o">$</span>lower<span class="p">),</span>
                      cens <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> s<span class="o">$</span>n.censor<span class="p">))</span>
    dat.cens <span class="o">&lt;-</span> <span class="kp">subset</span><span class="p">(</span>dat<span class="p">,</span> cens <span class="o">!=</span> <span class="m">0</span><span class="p">)</span>
 
    col <span class="o">&lt;-</span> <span class="kp">ifelse</span><span class="p">(</span>surv.col <span class="o">==</span> <span class="s">'gg.def'</span><span class="p">,</span> <span class="s">'black'</span><span class="p">,</span> surv.col<span class="p">)</span>
 
    pl <span class="o">&lt;-</span> ggplot<span class="p">(</span>dat<span class="p">,</span> aes<span class="p">(</span>x <span class="o">=</span> time<span class="p">,</span> y <span class="o">=</span> surv<span class="p">))</span> <span class="o">+</span>
      xlab<span class="p">(</span>xlab<span class="p">)</span> <span class="o">+</span> ylab<span class="p">(</span>ylab<span class="p">)</span> <span class="o">+</span> ggtitle<span class="p">(</span>main<span class="p">)</span> <span class="o">+</span>
      geom_step<span class="p">(</span>col <span class="o">=</span> <span class="kp">col</span><span class="p">,</span> lty <span class="o">=</span> lty.est<span class="p">)</span>
 
    pl <span class="o">&lt;-</span> <span class="kr">if</span><span class="p">(</span>CI <span class="o">==</span> <span class="bp">T</span> <span class="o">|</span> CI <span class="o">==</span> <span class="s">'def'</span><span class="p">)</span> <span class="p">{</span>
      pl <span class="o">+</span> geom_step<span class="p">(</span>aes<span class="p">(</span>y <span class="o">=</span> up<span class="p">),</span> color <span class="o">=</span> <span class="kp">col</span><span class="p">,</span> lty <span class="o">=</span> lty.ci<span class="p">)</span> <span class="o">+</span>
        geom_step<span class="p">(</span>aes<span class="p">(</span>y <span class="o">=</span> low<span class="p">),</span> color <span class="o">=</span> <span class="kp">col</span><span class="p">,</span> lty <span class="o">=</span> lty.ci<span class="p">)</span>
    <span class="p">}</span> <span class="kr">else</span> <span class="p">(</span>pl<span class="p">)</span>
 
    pl <span class="o">&lt;-</span> <span class="kr">if</span><span class="p">(</span>plot.cens <span class="o">==</span> <span class="bp">T</span> <span class="o">&amp;</span> <span class="kp">length</span><span class="p">(</span>dat.cens<span class="p">)</span> <span class="o">&gt;</span> <span class="m">0</span><span class="p">){</span>
      pl <span class="o">+</span> geom_point<span class="p">(</span>data <span class="o">=</span> dat.cens<span class="p">,</span> aes<span class="p">(</span>y <span class="o">=</span> surv<span class="p">),</span> shape <span class="o">=</span> cens.shape<span class="p">,</span>
                       col <span class="o">=</span> cens.col<span class="p">)</span>
    <span class="p">}</span> <span class="kr">else</span> <span class="kr">if</span> <span class="p">(</span>plot.cens <span class="o">==</span> <span class="bp">T</span> <span class="o">&amp;</span> <span class="kp">length</span><span class="p">(</span>dat.cens<span class="p">)</span> <span class="o">==</span> <span class="m">0</span><span class="p">){</span>
      stop <span class="p">(</span><span class="s">'There are no censored observations'</span><span class="p">)</span>
    <span class="p">}</span> <span class="kp">else</span><span class="p">(</span>pl<span class="p">)</span>
 
    pl <span class="o">&lt;-</span> <span class="kr">if</span><span class="p">(</span>back.white <span class="o">==</span> <span class="bp">T</span><span class="p">)</span> <span class="p">{</span>pl <span class="o">+</span> theme_bw<span class="p">()</span>
    <span class="p">}</span> <span class="kr">else</span> <span class="p">(</span>pl<span class="p">)</span>
    pl
  <span class="p">}</span>
 
  ggsurv.m <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>s<span class="p">,</span> CI <span class="o">=</span> <span class="s">'def'</span><span class="p">,</span> plot.cens <span class="o">=</span> <span class="bp">T</span><span class="p">,</span> surv.col <span class="o">=</span> <span class="s">'gg.def'</span><span class="p">,</span>
                       cens.col <span class="o">=</span> <span class="s">'red'</span><span class="p">,</span> lty.est <span class="o">=</span> <span class="m">1</span><span class="p">,</span> lty.ci <span class="o">=</span> <span class="m">2</span><span class="p">,</span>
                       cens.shape <span class="o">=</span> <span class="m">3</span><span class="p">,</span> back.white <span class="o">=</span> <span class="bp">F</span><span class="p">,</span> xlab <span class="o">=</span> <span class="s">'Time'</span><span class="p">,</span>
                       ylab <span class="o">=</span> <span class="s">'Survival'</span><span class="p">,</span> main <span class="o">=</span> <span class="s">''</span><span class="p">)</span> <span class="p">{</span>
    n <span class="o">&lt;-</span> s<span class="o">$</span>strata
 
    groups <span class="o">&lt;-</span> <span class="kp">factor</span><span class="p">(</span><span class="kp">unlist</span><span class="p">(</span><span class="kp">strsplit</span><span class="p">(</span><span class="kp">names</span>
                                     <span class="p">(</span>s<span class="o">$</span>strata<span class="p">),</span> <span class="s">'='</span><span class="p">))[</span><span class="kp">seq</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="m">2</span><span class="o">*</span>strata<span class="p">,</span> by <span class="o">=</span> <span class="m">2</span><span class="p">)])</span>
    gr.name <span class="o">&lt;-</span>  <span class="kp">unlist</span><span class="p">(</span><span class="kp">strsplit</span><span class="p">(</span><span class="kp">names</span><span class="p">(</span>s<span class="o">$</span>strata<span class="p">),</span> <span class="s">'='</span><span class="p">))[</span><span class="m">1</span><span class="p">]</span>
    gr.df <span class="o">&lt;-</span> <span class="kt">vector</span><span class="p">(</span><span class="s">'list'</span><span class="p">,</span> strata<span class="p">)</span>
    ind <span class="o">&lt;-</span> <span class="kt">vector</span><span class="p">(</span><span class="s">'list'</span><span class="p">,</span> strata<span class="p">)</span>
    n.ind <span class="o">&lt;-</span> <span class="kt">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span>n<span class="p">);</span> n.ind <span class="o">&lt;-</span> <span class="kp">cumsum</span><span class="p">(</span>n.ind<span class="p">)</span>
    <span class="kr">for</span><span class="p">(</span>i <span class="kr">in</span> <span class="m">1</span><span class="o">:</span>strata<span class="p">)</span> ind<span class="p">[[</span>i<span class="p">]]</span> <span class="o">&lt;-</span> <span class="p">(</span>n.ind<span class="p">[</span>i<span class="p">]</span><span class="m">+1</span><span class="p">)</span><span class="o">:</span>n.ind<span class="p">[</span>i<span class="m">+1</span><span class="p">]</span>
 
    <span class="kr">for</span><span class="p">(</span>i <span class="kr">in</span> <span class="m">1</span><span class="o">:</span>strata<span class="p">){</span>
      gr.df<span class="p">[[</span>i<span class="p">]]</span> <span class="o">&lt;-</span> <span class="kt">data.frame</span><span class="p">(</span>
        time <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> s<span class="o">$</span>time<span class="p">[</span> ind<span class="p">[[</span>i<span class="p">]]</span> <span class="p">]),</span>
        surv <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> s<span class="o">$</span>surv<span class="p">[</span> ind<span class="p">[[</span>i<span class="p">]]</span> <span class="p">]),</span>
        up <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> s<span class="o">$</span>upper<span class="p">[</span> ind<span class="p">[[</span>i<span class="p">]]</span> <span class="p">]),</span>
        low <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> s<span class="o">$</span>lower<span class="p">[</span> ind<span class="p">[[</span>i<span class="p">]]</span> <span class="p">]),</span>
        cens <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> s<span class="o">$</span>n.censor<span class="p">[</span> ind<span class="p">[[</span>i<span class="p">]]</span> <span class="p">]),</span>
        group <span class="o">=</span> <span class="kp">rep</span><span class="p">(</span>groups<span class="p">[</span>i<span class="p">],</span> n<span class="p">[</span>i<span class="p">]</span> <span class="o">+</span> <span class="m">1</span><span class="p">))</span>
    <span class="p">}</span>
 
    dat <span class="o">&lt;-</span> <span class="kp">do.call</span><span class="p">(</span><span class="kp">rbind</span><span class="p">,</span> gr.df<span class="p">)</span>
    dat.cens <span class="o">&lt;-</span> <span class="kp">subset</span><span class="p">(</span>dat<span class="p">,</span> cens <span class="o">!=</span> <span class="m">0</span><span class="p">)</span>
 
    pl <span class="o">&lt;-</span> ggplot<span class="p">(</span>dat<span class="p">,</span> aes<span class="p">(</span>x <span class="o">=</span> time<span class="p">,</span> y <span class="o">=</span> surv<span class="p">,</span> group <span class="o">=</span> group<span class="p">))</span> <span class="o">+</span>
      xlab<span class="p">(</span>xlab<span class="p">)</span> <span class="o">+</span> ylab<span class="p">(</span>ylab<span class="p">)</span> <span class="o">+</span> ggtitle<span class="p">(</span>main<span class="p">)</span> <span class="o">+</span>
      geom_step<span class="p">(</span>aes<span class="p">(</span>col <span class="o">=</span> group<span class="p">,</span> lty <span class="o">=</span> group<span class="p">))</span>
 
    col <span class="o">&lt;-</span> <span class="kr">if</span><span class="p">(</span><span class="kp">length</span><span class="p">(</span>surv.col <span class="o">==</span> <span class="m">1</span><span class="p">)){</span>
      scale_colour_manual<span class="p">(</span>name <span class="o">=</span> gr.name<span class="p">,</span> values <span class="o">=</span> <span class="kp">rep</span><span class="p">(</span>surv.col<span class="p">,</span> strata<span class="p">))</span>
    <span class="p">}</span> <span class="kp">else</span><span class="p">{</span>
      scale_colour_manual<span class="p">(</span>name <span class="o">=</span> gr.name<span class="p">,</span> values <span class="o">=</span> surv.col<span class="p">)</span>
    <span class="p">}</span>
 
    pl <span class="o">&lt;-</span> <span class="kr">if</span><span class="p">(</span>surv.col<span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s">'gg.def'</span><span class="p">){</span>
      pl <span class="o">+</span> <span class="kp">col</span>
    <span class="p">}</span> <span class="kr">else</span> <span class="p">{</span>pl <span class="o">+</span> scale_colour_discrete<span class="p">(</span>name <span class="o">=</span> gr.name<span class="p">)}</span>
 
    line <span class="o">&lt;-</span> <span class="kr">if</span><span class="p">(</span><span class="kp">length</span><span class="p">(</span>lty.est<span class="p">)</span> <span class="o">==</span> <span class="m">1</span><span class="p">){</span>
      scale_linetype_manual<span class="p">(</span>name <span class="o">=</span> gr.name<span class="p">,</span> values <span class="o">=</span> <span class="kp">rep</span><span class="p">(</span>lty.est<span class="p">,</span> strata<span class="p">))</span>
    <span class="p">}</span> <span class="kr">else</span> <span class="p">{</span>scale_linetype_manual<span class="p">(</span>name <span class="o">=</span> gr.name<span class="p">,</span> values <span class="o">=</span> lty.est<span class="p">)}</span>
 
    pl <span class="o">&lt;-</span> pl <span class="o">+</span> line
 
    pl <span class="o">&lt;-</span> <span class="kr">if</span><span class="p">(</span>CI <span class="o">==</span> <span class="bp">T</span><span class="p">)</span> <span class="p">{</span>
      <span class="kr">if</span><span class="p">(</span><span class="kp">length</span><span class="p">(</span>surv.col<span class="p">)</span> <span class="o">&gt;</span> <span class="m">1</span> <span class="o">&amp;&amp;</span> <span class="kp">length</span><span class="p">(</span>lty.est<span class="p">)</span> <span class="o">&gt;</span> <span class="m">1</span><span class="p">){</span>
        <span class="kp">stop</span><span class="p">(</span><span class="s">'Either surv.col or lty.est should be of length 1 in order</span>
<span class="s">             to plot 95% CI with multiple strata'</span><span class="p">)</span>
      <span class="p">}</span><span class="kr">else</span> <span class="kr">if</span><span class="p">((</span><span class="kp">length</span><span class="p">(</span>surv.col<span class="p">)</span> <span class="o">&gt;</span> <span class="m">1</span> <span class="o">|</span> surv.col <span class="o">==</span> <span class="s">'gg.def'</span><span class="p">)[</span><span class="m">1</span><span class="p">]){</span>
        pl <span class="o">+</span> geom_step<span class="p">(</span>aes<span class="p">(</span>y <span class="o">=</span> up<span class="p">,</span> color <span class="o">=</span> group<span class="p">),</span> lty <span class="o">=</span> lty.ci<span class="p">)</span> <span class="o">+</span>
          geom_step<span class="p">(</span>aes<span class="p">(</span>y <span class="o">=</span> low<span class="p">,</span> color <span class="o">=</span> group<span class="p">),</span> lty <span class="o">=</span> lty.ci<span class="p">)</span>
      <span class="p">}</span> <span class="kp">else</span><span class="p">{</span>pl <span class="o">+</span>  geom_step<span class="p">(</span>aes<span class="p">(</span>y <span class="o">=</span> up<span class="p">,</span> lty <span class="o">=</span> group<span class="p">),</span> col <span class="o">=</span> surv.col<span class="p">)</span> <span class="o">+</span>
               geom_step<span class="p">(</span>aes<span class="p">(</span>y <span class="o">=</span> low<span class="p">,</span>lty <span class="o">=</span> group<span class="p">),</span> col <span class="o">=</span> surv.col<span class="p">)}</span>
    <span class="p">}</span> <span class="kr">else</span> <span class="p">{</span>pl<span class="p">}</span>
 
 
    pl <span class="o">&lt;-</span> <span class="kr">if</span><span class="p">(</span>plot.cens <span class="o">==</span> <span class="bp">T</span> <span class="o">&amp;</span> <span class="kp">length</span><span class="p">(</span>dat.cens<span class="p">)</span> <span class="o">&gt;</span> <span class="m">0</span><span class="p">){</span>
      pl <span class="o">+</span> geom_point<span class="p">(</span>data <span class="o">=</span> dat.cens<span class="p">,</span> aes<span class="p">(</span>y <span class="o">=</span> surv<span class="p">),</span> shape <span class="o">=</span> cens.shape<span class="p">,</span>
                      col <span class="o">=</span> cens.col<span class="p">)</span>
    <span class="p">}</span> <span class="kr">else</span> <span class="kr">if</span> <span class="p">(</span>plot.cens <span class="o">==</span> <span class="bp">T</span> <span class="o">&amp;</span> <span class="kp">length</span><span class="p">(</span>dat.cens<span class="p">)</span> <span class="o">==</span> <span class="m">0</span><span class="p">){</span>
      stop <span class="p">(</span><span class="s">'There are no censored observations'</span><span class="p">)</span>
    <span class="p">}</span> <span class="kp">else</span><span class="p">(</span>pl<span class="p">)</span>
 
    pl <span class="o">&lt;-</span> <span class="kr">if</span><span class="p">(</span>back.white <span class="o">==</span> <span class="bp">T</span><span class="p">)</span> <span class="p">{</span>pl <span class="o">+</span> theme_bw<span class="p">()</span>
    <span class="p">}</span> <span class="kr">else</span> <span class="p">(</span>pl<span class="p">)</span>
    pl
  <span class="p">}</span>
  pl <span class="o">&lt;-</span> <span class="kr">if</span><span class="p">(</span>strata <span class="o">==</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span>ggsurv.s<span class="p">(</span>s<span class="p">,</span> CI <span class="p">,</span> plot.cens<span class="p">,</span> surv.col <span class="p">,</span>
                                  cens.col<span class="p">,</span> lty.est<span class="p">,</span> lty.ci<span class="p">,</span>
                                  cens.shape<span class="p">,</span> back.white<span class="p">,</span> xlab<span class="p">,</span>
                                  ylab<span class="p">,</span> main<span class="p">)</span>
  <span class="p">}</span> <span class="kr">else</span> <span class="p">{</span>ggsurv.m<span class="p">(</span>s<span class="p">,</span> CI<span class="p">,</span> plot.cens<span class="p">,</span> surv.col <span class="p">,</span>
                   cens.col<span class="p">,</span> lty.est<span class="p">,</span> lty.ci<span class="p">,</span>
                   cens.shape<span class="p">,</span> back.white<span class="p">,</span> xlab<span class="p">,</span>
                   ylab<span class="p">,</span> main<span class="p">)}</span>
  pl
<span class="p">}</span>
</pre></div>

</div></body></html>