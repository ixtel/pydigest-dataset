<html><body><div><div class="entry-content"><blockquote><p>Is it ironic that the documentation for descriptors is not very descriptive</p></blockquote>

<p>Descriptors are one of my favorite Python features — but it took me too long to discover them.  The documentation and tutorials that I found were too complex for me.  So I would like to offer a different approach, a <em>code first</em> approach</p>

<h3>Agenda</h3>

<ul>
<li>Definition</li>
<li>A Problem that Descriptors Can Solve</li>
<li>CODE!!  Solution to the Problem</li>
<li>Reflection on the Code, and explanation on how we used Descriptors</li>
</ul>


<h3>Definition</h3>

<blockquote><p>In general, a descriptor is an object attribute with “binding behavior”, one whose attribute access has been overridden by methods in the descriptor protocol. Those methods are __get__(), __set__(), and __delete__(). If any of those methods are defined for an object, it is said to be a descriptor.</p></blockquote>

<p>Read that and stash it in your brain for a few minutes.  By the end of this article you’ll grok this</p>

<h3>A Problem that Descriptors Can Solve</h3>

<p>Imagine that you need to consume a 3rd party API that returns json documents.  Often solutions to this problem look like this …</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">USER_API_URI</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">111</span><span class="p">)</span>
</span><span class="line"><span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">to_json</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="s">'results'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">'name'</span><span class="p">])</span>
</span><span class="line"><span class="k">print</span><span class="p">(</span><span class="s">'barf'</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>I dislike this solution, Its concise, but it breaks <a href="http://en.wikipedia.org/wiki/Separation_of_concerns">separation-of-concerns</a>.  The code consuming the API should not be concerned about the exact path and location of the data element in the json document.</p>

<h4>Proposed Solution with Descriptors:</h4>

<p>Our goal is to write code like this:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">user</span> <span class="o">=</span> <span class="n">UserAPI</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
</span><span class="line"><span class="k">print</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span class="line"><span class="k">print</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">street_address</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>CODE!!  Solution to the Problem</h3>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c"># Hey guys this is a descriptor -- Woot!!        </span>
</span><span class="line"><span class="k">class</span> <span class="nc">Extractor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>
</span><span class="line">        <span class="k">return</span> <span class="n">_extract</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">json_blob</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">_extract</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">):</span>
</span><span class="line">        <span class="sd">"""</span>
</span><span class="line"><span class="sd">        digs into an dict or lists, if anything along the way is None, then simply return None</span>
</span><span class="line"><span class="sd">        """</span>
</span><span class="line">        <span class="n">end_of_chain</span> <span class="o">=</span> <span class="n">your_dict</span>
</span><span class="line">        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
</span><span class="line">            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end_of_chain</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">end_of_chain</span><span class="p">:</span>
</span><span class="line">                <span class="n">end_of_chain</span> <span class="o">=</span> <span class="n">end_of_chain</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span class="line">            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end_of_chain</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
</span><span class="line">                <span class="n">end_of_chain</span> <span class="o">=</span> <span class="n">end_of_chain</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span class="line">            <span class="k">else</span><span class="p">:</span>
</span><span class="line">                <span class="k">return</span> <span class="bp">None</span>
</span><span class="line">
</span><span class="line">        <span class="k">return</span> <span class="n">end_of_chain</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now look how elegant our code can look</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">class</span> <span class="nc">JSONResponse</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_blob</span><span class="p">):</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">json_blob</span> <span class="o">=</span> <span class="n">json_blob</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">JSONRepsonse</span><span class="p">):</span>
</span><span class="line">
</span><span class="line">    <span class="n">name</span> <span class="o">=</span> <span class="n">Extractor</span><span class="p">(</span><span class="s">'result'</span><span class="p">,</span><span class="s">'username'</span><span class="p">)</span>
</span><span class="line">    <span class="n">street_address</span> <span class="o">=</span> <span class="n">Extractor</span><span class="p">(</span><span class="s">'result'</span><span class="p">,</span><span class="s">'address'</span><span class="p">,</span> <span class="s">'street'</span><span class="p">)</span>
</span><span class="line">    <span class="n">status</span> <span class="o">=</span> <span class="n">Extractor</span><span class="p">(</span><span class="s">'result'</span><span class="p">,</span><span class="s">'status'</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">UserAPI</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="nd">@class_method</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">get_by_id</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
</span><span class="line">        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">USER_GET_ENDPOINT</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
</span><span class="line">        <span class="k">return</span> <span class="n">User</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
</span></code></pre></td></tr></table></div></figure>


<p>And now are code is warm and fuzzy:</p>

<figure class="code"><figcaption><span/></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">user</span> <span class="o">=</span> <span class="n">UserAPI</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
</span><span class="line"><span class="k">print</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span class="line"><span class="k">print</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">street_address</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Reflection on the Code</h3>

<p>The real magic of descriptors happens with the signatures of __get__(), __set__(), and __delete__():</p>

<ul>
<li><code>object.__get__(self, instance, owner)</code></li>
<li><code>object.__set__(self, instance, value)</code></li>
<li><code>object.__delete__(self, instance)</code></li>
</ul>


<p>Each of these signatures contains a reference to <code>instance</code>, which is the instance of the <em>owner</em>’s class.  So in our example:</p>

<p><em>instance</em> will be an instance of the User class
<em>owner</em> will be the User class
<em>self</em> is the instance of the Descriptor, which in our case holds the <code>path</code> attribute.</p>

<p>Let’s take a look at our example where we made a descriptor <em>Extractor</em>.
– <code>user = UserAPI.get_by_id(111)</code></p>

<p>Here we get an instance of a User object, which has the json_blob stored on it from the GET request</p>




<p>Now we call <code>name</code> on that object, which we defined: <code>name = Extractor('result','username')</code>.  At this point when we call <code>name</code> it is going to use the Extractor descriptor to extract the value from the json_blob.</p>

<p>The concern of extracting data from a json blob is nicely contained in our Descriptor  I think this is one of many great ways to use descriptors to DRY up your code.</p>

<p>Hope this is helpful!</p>

<h3>Additional Resources</h3>



</div>


  </div></body></html>