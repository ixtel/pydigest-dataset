<html><body><div><div id="getting-started">
<h2>Getting Started</h2>
<p>Let us go through a simple example.</p>
<p>Import everything we need:</p>
<pre><span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">from</span> <span class="nn">pycouchbase</span> <span class="kn">import</span> <span class="n">Connection</span>
<span class="kn">from</span> <span class="nn">pycouchbase</span> <span class="kn">import</span> <span class="n">Document</span><span class="p">,</span> <span class="n">register_view</span>
<span class="kn">from</span> <span class="nn">pycouchbase.fields</span> <span class="kn">import</span> <span class="n">EmailField</span><span class="p">,</span> <span class="n">ChoiceField</span>
</pre>
<p>Declare the Document class:</p>
<pre><span class="c1"># You can define your own field/data type</span>

<span class="k">class</span> <span class="nc">Gender</span><span class="p">(</span><span class="n">ChoiceField</span><span class="p">):</span>
    <span class="n">CHOICES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'M'</span><span class="p">:</span> <span class="s1">'Male'</span><span class="p">,</span>
        <span class="s1">'F'</span><span class="p">:</span> <span class="s1">'Female'</span><span class="p">,</span>
    <span class="p">}</span>

<span class="nd">@register_view</span><span class="p">(</span><span class="s1">'dev_authors'</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Author</span><span class="p">(</span><span class="n">Document</span><span class="p">):</span>
    <span class="n">__bucket_name__</span> <span class="o">=</span> <span class="s1">'couchbasekit_samples'</span>
    <span class="n">__key_field__</span> <span class="o">=</span> <span class="s1">'slug'</span>  <span class="c1"># optional</span>
    <span class="n">doc_type</span> <span class="o">=</span> <span class="s1">'author'</span>
    <span class="n">structure</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'slug'</span><span class="p">:</span> <span class="nb">unicode</span><span class="p">,</span>
        <span class="s1">'first_name'</span><span class="p">:</span> <span class="nb">unicode</span><span class="p">,</span>
        <span class="s1">'last_name'</span><span class="p">:</span> <span class="nb">unicode</span><span class="p">,</span>
        <span class="s1">'gender'</span><span class="p">:</span> <span class="n">Gender</span><span class="p">,</span>
        <span class="s1">'email'</span><span class="p">:</span> <span class="n">EmailField</span><span class="p">,</span>
        <span class="s1">'has_book'</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="s1">'age'</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="s1">'birthday'</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
        <span class="s1">'created_at'</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">default_values</span> <span class="o">=</span> <span class="p">{</span>  <span class="c1"># optional</span>
        <span class="s1">'has_book'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="c1"># don't worry about the timezone info!</span>
        <span class="c1"># it's auto assigned as to UTC, so all you have to do is:</span>
        <span class="s1">'created_at'</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">required_fields</span> <span class="o">=</span> <span class="p">(</span>  <span class="c1"># optional</span>
        <span class="s1">'slug'</span><span class="p">,</span>
        <span class="s1">'first_name'</span><span class="p">,</span>
        <span class="s1">'last_name'</span><span class="p">,</span>
        <span class="s1">'email'</span><span class="p">,</span>
    <span class="p">)</span>
</pre>
<p>Validate and save your document:</p>
<pre><span class="n">local_connection</span> <span class="o">=</span> <span class="n">Connection</span><span class="o">.</span><span class="n">auth</span><span class="p">(</span><span class="n">server</span><span class="o">=</span><span class="s1">'localhost'</span><span class="p">)</span>
<span class="n">author</span> <span class="o">=</span> <span class="n">Author</span><span class="p">()</span>
<span class="n">bucket</span> <span class="o">=</span> <span class="n">author</span><span class="o">.</span><span class="n">get_bucket</span><span class="p">(</span><span class="n">local_connection</span><span class="p">)</span>

<span class="n">author</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
    <span class="s1">'slug'</span><span class="p">:</span> <span class="s1">u'douglas_adams'</span><span class="p">,</span>
    <span class="s1">'first_name'</span><span class="p">:</span> <span class="s1">u'Douglas'</span><span class="p">,</span>
    <span class="s1">'last_name'</span><span class="p">:</span> <span class="s1">u'Adams'</span><span class="p">,</span>
    <span class="s1">'gender'</span><span class="p">:</span> <span class="n">Gender</span><span class="p">(</span><span class="s1">'M'</span><span class="p">),</span>
    <span class="s1">'email'</span><span class="p">:</span> <span class="n">EmailField</span><span class="p">(</span><span class="s1">'dna@example.com'</span><span class="p">),</span>
<span class="p">})</span>

<span class="c1"># Try to validate before saving</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">author</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">rvs</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">author</span><span class="o">.</span><span class="n">slug</span><span class="p">,</span> <span class="n">author</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="k">except</span> <span class="n">KeyExistsError</span> <span class="k">as</span> <span class="n">why</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">why</span><span class="p">)</span>
<span class="k">except</span> <span class="n">Author</span><span class="o">.</span><span class="n">StructureError</span> <span class="k">as</span> <span class="n">why</span><span class="p">:</span>
    <span class="c1"># when the data structure is invalid</span>
    <span class="k">print</span><span class="p">(</span><span class="n">why</span><span class="p">)</span>
</pre>
<p>Save multiple documents:</p>
<pre><span class="n">local_connection</span> <span class="o">=</span> <span class="n">Connection</span><span class="o">.</span><span class="n">auth</span><span class="p">(</span><span class="n">server</span><span class="o">=</span><span class="s1">'localhost'</span><span class="p">)</span>
<span class="n">author</span> <span class="o">=</span> <span class="n">Author</span><span class="p">()</span>

<span class="n">list_data</span> <span class="o">=</span> <span class="p">[{</span>
    <span class="s1">'slug'</span><span class="p">:</span> <span class="s1">u'douglas_adams'</span><span class="p">,</span>
    <span class="s1">'first_name'</span><span class="p">:</span> <span class="s1">u'Douglas'</span><span class="p">,</span>
    <span class="s1">'last_name'</span><span class="p">:</span> <span class="s1">u'Adams'</span><span class="p">,</span>
    <span class="s1">'gender'</span><span class="p">:</span> <span class="n">Gender</span><span class="p">(</span><span class="s1">'M'</span><span class="p">),</span>
    <span class="s1">'email'</span><span class="p">:</span> <span class="n">EmailField</span><span class="p">(</span><span class="s1">'dna@example.com'</span><span class="p">),</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="s1">'slug'</span><span class="p">:</span> <span class="s1">u'isaac_asimov'</span><span class="p">,</span>
    <span class="s1">'first_name'</span><span class="p">:</span> <span class="s1">u'Isaac'</span><span class="p">,</span>
    <span class="s1">'last_name'</span><span class="p">:</span> <span class="s1">u'Asimov'</span><span class="p">,</span>
    <span class="s1">'gender'</span><span class="p">:</span> <span class="n">Gender</span><span class="p">(</span><span class="s1">'M'</span><span class="p">),</span>
    <span class="s1">'email'</span><span class="p">:</span> <span class="n">EmailField</span><span class="p">(</span><span class="s1">'dna@example.com'</span><span class="p">),</span>
<span class="p">}]</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="n">author</span><span class="o">.</span><span class="n">get_bucket</span><span class="p">(</span><span class="n">local_connection</span><span class="p">)</span>
    <span class="n">updated_authors</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">list_data</span><span class="p">:</span>
        <span class="n">author</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># validate!</span>
            <span class="n">author</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
            <span class="n">updated_authors</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">'slug'</span><span class="p">]:</span> <span class="n">author</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
            <span class="p">})</span>
        <span class="k">except</span> <span class="n">author</span><span class="o">.</span><span class="n">StructureError</span> <span class="k">as</span> <span class="n">why</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">why</span><span class="p">)</span>

    <span class="c1"># save multiple data</span>
    <span class="n">rvs</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">upsert_multi</span><span class="p">(</span><span class="n">updated_authors</span><span class="p">)</span>
<span class="k">except</span> <span class="n">CouchbaseNetworkError</span> <span class="k">as</span> <span class="n">why</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">why</span><span class="p">)</span>
</pre>
<p>Manage multiple connections:</p>
<pre><span class="n">connection_1</span> <span class="o">=</span> <span class="n">Connection</span><span class="o">.</span><span class="n">auth</span><span class="p">(</span><span class="n">server</span><span class="o">=</span><span class="s1">'server_1'</span><span class="p">)</span>
<span class="n">connection_2</span> <span class="o">=</span> <span class="n">Connection</span><span class="o">.</span><span class="n">auth</span><span class="p">(</span><span class="n">server</span><span class="o">=</span><span class="s1">'server_2'</span><span class="p">)</span>

<span class="c1"># where doc_1 and doc_2 are document objects</span>
<span class="n">bucket_1</span> <span class="o">=</span> <span class="n">doc_1</span><span class="o">.</span><span class="n">get_bucket</span><span class="p">(</span><span class="n">connection_1</span><span class="p">)</span>
<span class="n">bucket_2</span> <span class="o">=</span> <span class="n">doc_2</span><span class="o">.</span><span class="n">get_bucket</span><span class="p">(</span><span class="n">connection_2</span><span class="p">)</span>
</pre>
<p>Bucket objects can support any <a href="http://docs.couchbase.com/developer/python-2.0/introduction.html" rel="nofollow">Couchbase Python SDK 2.0</a> operations:</p>
<pre><span class="n">bucket_1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'key_or_id'</span><span class="p">)</span>
<span class="n">bucket_1</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="s1">'key_or_id'</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</pre>
<p>More about Couchbase SDKâ€™s supported operations here: <a href="http://docs.couchbase.com/developer/python-2.0/introduction.html" rel="nofollow">http://docs.couchbase.com/developer/python-2.0/introduction.html</a></p>
</div>
</div></body></html>